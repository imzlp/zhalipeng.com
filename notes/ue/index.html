<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":true,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Unreal Engine is the best 3D Game Engine!">
<meta property="og:type" content="website">
<meta property="og:title" content="Unreal Engine">
<meta property="og:url" content="https://imzlp.com/notes/ue/index.html">
<meta property="og:site_name" content="Z&#39;s Blog">
<meta property="og:description" content="Unreal Engine is the best 3D Game Engine!">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210311110606.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210226145229.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210226145538.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210224143321.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210224143807.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210224100616.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210220105308.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210202194343.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210127152358.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210121220607.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210115214317.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210112154624.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20210112171826.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201217202145.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/16082078824716.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201211125932.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201211125525.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201211130200.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/auto-mount-shaderpatch-crash.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201208145952.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201204213024.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201204212642.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201203212055.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201116215421.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201110213023.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201110213249.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201117095535.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201026200135.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201016112348.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201014165139.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201014171310.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201014141219.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201009210924.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201009202629.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20201009202816.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20200927204452.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/2020/20200925185142.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-project-settings-ios-gen-dSYM.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/IOS/diff-source-and-launch-engine-dSYM.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/IOS/diff-source-and-launch-engine-disabledebugfile-dSYM.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-project-settings-android-maximum-support-aspect-ratio.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-uprarm-bitmask.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-description-use-boardless-window.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/IOS/import-ios-cer-in-windows-certmgr.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/IOS/ue4-import-cer-for-ios.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-viveport-ligthing-need-rebuilt.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-viveport-stat-fps.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-http-encode-url.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-project-settings-cooker-astc-compression.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ModuleLoadFaild/ue4-game-module-could-not-be-loaded.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-set-node-value-in-editor.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-reflex/ue4-uclass-register-all-compiled.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-reflex/ue4-call-ufunction-receive-ret-value.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-static-class-and-getclass-difference.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-call-FObjectInitializer-ctor.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-translation-bp-to-cpp.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/uobject-data-serialize-callstack.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Shader/ue-launch-game-CompileGlobalShaderMap-callstack.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-run-commandlet.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/UnLua/analysis-overridden/ue4-notifyUObjectCreated-call-stack.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-trybindlua-call-stack.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-get-lua-func-and-get-ue-ufuncion.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-replace-ufunction-native-function-pointer.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/UnLua/analysis-overridden/unlua-process-event-call-stack.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-fpath-relative-engine-binary.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Package/ue4-package-bUsesSlate-diff.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-editor-copy-selected-actor-impl-call-stack.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-editor-paste-selected-actor-impl-call-stack.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/utf8-character-of-array-to-tchar.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/ue4-virtual-production-flowchart.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Level/ue4-save-level-call-stack.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Level/ue4-load-level-call-stack.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/unreal-front-end-device-log.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/IOS/texture-not-power-of-two.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/IOS/texture-set-as-power-of-two-mode.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/IOS/texture-set-compression-as-userinterface.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-download-proxy-plugin-ui.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/use-http-request-download-file-server-info.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-FPlatformMisc-typedef.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-android-add-extra-permissions.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/search-ue-source-in-github.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/project-settings-add-non-asset-to-package.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/obb-file-hash-diff.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-scanf-asset-ref-redirector.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-fix-up-redirectors-in-folder.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/PreviewRenderingLevel.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/dispatcher-bind-error-not-match-signature.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Editor-SlowTask-progress.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Paks/package-outside-file-to-pak.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Paks/load-extern-file-form-pak-in-runtime.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Paks/visitor-pak-not-asset-file-in-package-game.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Paks/visitor-projectdir.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/UE4_SaveFile_Notifications.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/git-diff-in-ue4-no-runtime.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-get-asset-dependencies-in-bp.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-get-asset-dependencies-in-bp-print.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-android-screen-rotate.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Patch/unreal-load-patch-asset.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Patch/ue4-dynamic-load-asset.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-game-shadowtrackerextra-pak.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/Show_CustomK2Node.gif">
<meta property="og:image" content="https://imzlp.com/posts/20203/recast-premake-generate-vs-solution.webp">
<meta property="og:image" content="https://imzlp.com/posts/20203/build-recastnavigation.webp">
<meta property="og:image" content="https://imzlp.com/posts/20203/recast-navigation-RecastDemo.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Plugins/export-nav-data/ue4-export-nav-data-usage-0.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Plugins/export-nav-data/ue4-export-nav-data-usage-1.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/Plugins/export-nav-data/Recast-Demo-bin.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/protobuf-protoc-toolbar.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/use-different-return-type.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-package-android-error-assdebug.webp">
<meta property="og:image" content="https://imzlp.com/posts/16643/UE-codeoptimize-default.webp">
<meta property="og:image" content="https://imzlp.com/posts/16643/UE-codeoptimize-never.webp">
<meta property="og:image" content="https://imzlp.com/posts/16643/vs-disable-optimization.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-bp-pure-node-binary-operator.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/optimize-dynamic-shadow-use-phy-asset.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/optimize-dynamic-shadow-use-capsule-direct-shadow.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue-addtional-console-command.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-add-code-macro-in-build-cs.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/DLL-Compile-Error-Link1561-ConfigurationType.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/DLL-Compile-Error-Link1561-Linker-System.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/UE4-Change-Project-Package-Icon.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/dotNetFrameWorkVersionNumberInRegister.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/ue4-spawn-emitter-isnt-visibility-in-camera.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/spawn-sound-at-location-call-stack.webp">
<meta property="og:image" content="https://imzlp.com/notes/ue/index/UE4/UE4-Engine-Garbage-Collection-GlobalSetting.webp">
<meta property="article:published_time" content="2017-01-08T05:50:33.000Z">
<meta property="article:modified_time" content="2021-03-16T02:53:42.517Z">
<meta property="article:author" content="查利鹏">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://imzlp.com/notes/ue/index/2020/20210311110606.webp">

<link rel="canonical" href="https://imzlp.com/notes/ue/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Unreal Engine | Z's Blog
</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66450323-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-66450323-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Z's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">循迹研究室</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>笔记</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>随笔</a>

  </li>


      
        <li class="menu-item menu-item-feeds">

    <a href="/feeds/" rel="section"><i class="fas fa-rss fa-fw"></i>资讯</a>

  </li>
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>资源</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>友链</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>


      
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fas fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>站点日志</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>站内搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

  <div id="google_translate_element"></div>
  <script type="text/javascript">
    function googleTranslateElementInit()
    {
      var google_translate_element = document.getElementById('google_translate_element');
      var timer = setInterval(function() 
      {
        google_translate_element = document.getElementById('google_translate_element');
        if (google_translate_element) 
        {
          clearInterval(timer);
          new google.translate.TranslateElement(
          {
            pageLanguage: 'zh-CN',
            
              includedLanguages: 'en,zh-CN,ru,ja',
            
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE, autoDisplay: true
          },
          'google_translate_element');

          
            // 清除图片的请求
            img = [].slice.call(document.querySelectorAll('#goog-gt-tt img,#google_translate_element img'));
            img.forEach(function(v, i) {v.src = '';});
          
          var google_language_selector = document.getElementById(':0.targetLanguage');
          google_language_selector.style.backgroundColor = "#ffffffb5";
          google_language_selector.style.border = "0px solid #ffffffb5";
        }
      }, 300);
    }
  </script>
  <script type="text/javascript" src="//translate.google.cn/translate_a/element.js?cb=googleTranslateElementInit"></script>



</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
  

      

        
        <ul id="sub-menu" class="sub-menu menu">
          
            
          
          
              
  <li class="menu-item menu-item-ue">

    <a href="/notes/ue/" rel="section"><i class="fa fa fa-cube fa-fw"></i>Unreal Engine</a>

  </li>


          
          
              
  <li class="menu-item menu-item-ue5">

    <a href="/notes/ue5/" rel="section"><i class="fas fa-cubes fa-fw"></i>UE5</a>

  </li>


          
          
              
  <li class="menu-item menu-item-gamedev">

    <a href="/notes/gamedev/" rel="section"><i class="fab fa-steam-square fa-fw"></i>Game Development</a>

  </li>


          
          
              
  <li class="menu-item menu-item-cpp">

    <a href="/notes/cpp/" rel="section"><i class="fas fa-keyboard fa-fw"></i>C++</a>

  </li>


          
          
              
  <li class="menu-item menu-item-computerscience">

    <a href="/notes/computerscience/" rel="section"><i class="fas fa-satellite fa-fw"></i>Computer Science</a>

  </li>


          
          
              
  <li class="menu-item menu-item-graphics">

    <a href="/notes/graphics/" rel="section"><i class="fas fa-magic fa-fw"></i>Graphics</a>

  </li>


          
          
              
  <li class="menu-item menu-item-vr">

    <a href="/notes/vr/" rel="section"><i class="fas fa-vr-cardboard fa-fw"></i>Virtual Reality</a>

  </li>


          
          
              
  <li class="menu-item menu-item-tips">

    <a href="/notes/tips/" rel="section"><i class="fa fa-rocket fa-fw"></i>Tips</a>

  </li>


          
        </ul>
        

        

                
                
        
      

      
      

      
      

      
      
  

          <div class="content page posts-expand">
            

    
    
    
    <div class="post-block" lang="zh-CN">
      <header class="post-header">
	<h1 class="post-title" itemprop="name headline">Unreal Engine
	</h1>
	<div class="post-meta">
	    <div class="post-description">Unreal Engine is the best 3D Game Engine!</div>
	  
  <ul class="breadcrumb">
          
            <li><a href="/notes/">NOTES</a></li>
          <li>UE</li>
        
  </ul>

	</div>


</header>

      
      
      
      <div class="post-body">
          <ul>
<li><a href="https://imzlp.com/posts/25331/">UE4开发的问题笔记和资料辑录</a></li>
<li><a href="https://imzlp.com/posts/12143/">UE4工具链配置与开发技巧</a></li>
</ul>
<hr>
<h2 id="GIST-NOTES"><a href="#GIST-NOTES" class="headerlink" title="GIST NOTES"></a>GIST NOTES</h2><p><strong>注意</strong>：使用GIST管理的笔记，在国内网络可能会无法显示。</p>
<script src="https://gist.github.com/imzlp/3f172a797c31c66453f733e15e687959.js"></script>

<hr>
<h2 id="Windows-h造成的名字冲突"><a href="#Windows-h造成的名字冲突" class="headerlink" title="Windows.h造成的名字冲突"></a>Windows.h造成的名字冲突</h2><p>有时候需要包含一些平台相关的代码，如<code>windows.h</code>里面包含了很多头文件，其中一些定义了很多宏，如：</p>
<figure class="highlight cpp"><figcaption><span>fileapi.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> UNICODE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DeleteFile  DeleteFileW</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DeleteFile  DeleteFileA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !UNICODE</span></span></span><br></pre></td></tr></table></figure>
<p>如果我们同时在代码中包含了<code>windows.h</code>和使用了<code>IPlatformFile</code>的接口来调用它的<code>DeleteFile</code>函数，因为<code>DeleteFile</code>被定义成了宏，所以在预处理阶段就会被替换，导致编译时访问<code>IPlatformFile</code>的<code>DeleteFileW</code>成员，但实际上它是不存在的，就产生了以下编译错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error C2039: &#x27;DeleteFileW&#x27;: is not a member of &#x27;IPlatformFile&#x27;</span><br></pre></td></tr></table></figure>
<p>解决办法就是不直接包含<code>windows.h</code>而是使用以下封装：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows/AllowWindowsPlatformTypes.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows/HideWindowsPlatformTypes.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>这样可以避免污染UE的符号名字。</p>
<p>UE的文档中也有介绍：<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/zh-CN/ProductionPipelines/BuildTools/UnrealBuildTool/ThirdPartyLibraries/index.html">第三方库#故障排除</a></p>
<h2 id="Core-Redirects"><a href="#Core-Redirects" class="headerlink" title="Core Redirects"></a>Core Redirects</h2><p>有时候Class/Enums/functions/packages/property/struct被改了名字，导致所有引用到它们的资源都要手动修改一遍，非常麻烦。</p>
<p>为了解决这个问题，UE提供了重定向功能，可以在不变动大量资源的情况下进行重定向到新的资源。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/ProgrammingAndScripting/ProgrammingWithCPP/Assets/CoreRedirects/index.html">Core Redirects</a></li>
</ul>
<h2 id="打包时Shader的编译"><a href="#打包时Shader的编译" class="headerlink" title="打包时Shader的编译"></a>打包时Shader的编译</h2><p>UE打包项目时并不是所有的shader都会被编译到ushaderbytecode中的，只有打包进去的才会编译进去。<br>进行了一个测试：</p>
<ol>
<li>把<code>/Game</code>添加到了<code>Directories to Never Cook</code></li>
<li>打包工程到Android</li>
</ol>
<p>最终编译出来的ushaderbytecode的大小为：</p>
<p><img data-src="index/2020/20210311110606.webp"></p>
<p>在UE打包时会拉起Cook进行执行资源的Cook和Shader的编译，应该是在当前的Cook进程中编译的Shader最终会写入到ushaderbytecode文件中，没有被执行Cook的资源不会被编译Shader，从而实现了不会把没有用到的Shader打包的行为。</p>
<p>不过以上只是猜测，有时间具体分析下Cook和Shader编译相关的代码。</p>
<h2 id="DDC共享"><a href="#DDC共享" class="headerlink" title="DDC共享"></a>DDC共享</h2><p>共享DDC的作用是：当同一网络内共享DDC的人只要有一个人编译了DDC，其他人就无需重新编译，节省Shader的编译时间，提高效率。</p>
<p>所以，一般情况下只需要在局域网内部署一个高IO吞吐的机器，每个人都把该机器的共享目录挂载到本地，就可以实现DDC的共享，因为DDC的目录是相对于网络路径的，所以每个人的修改都会影响到其他人，从而实现一个编译多人共享的效果。</p>
<p>UE的文档里介绍了三种设置的方法：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/ProductionPipelines/DerivedDataCache/index.html">Derived Data Cache</a></li>
</ul>
<ol>
<li>修改<code>DefaultEngine.ini</code>添加<code>DerivedDataBackendGraph</code>项；</li>
<li>系统中添加<code>UE-SharedDataCachePath</code>环境变量；</li>
<li>在UE的<code>Editor Preferences</code>-<code>Global</code>-<code>Shared Derived Data Cache</code>设置共享的DDC目录；</li>
</ol>
<p>UE推荐的是使用第一种方法，但是具体实践和文档中介绍的略有不同。</p>
<p>对于源码版引擎，使用DDC文档中介绍的第一种方法，在项目的<code>DefaultEngine.ini</code>中添加以下项：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DerivedDataBackendGraph]</span></span><br><span class="line"><span class="attr">Shared</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">10</span>, FoldersToClean=<span class="number">10</span>, MaxFileChecksPerSec=<span class="number">1</span>, ConsiderSlowAt=<span class="number">70</span>, PromptIfMissing=<span class="literal">false</span>, Path=\\YourDDCServer\DDC, EnvPathOverride=UE-SharedDataCachePath, EditorOverrideSetting=SharedDerivedDataCache)</span><br></pre></td></tr></table></figure>
<p>但是对于安装版引擎（Installed），要把<code>DerivedDataBackendGraph</code>改成<code>InstalledDerivedDataBackendGraph</code>：</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[InstalledDerivedDataBackendGraph]</span></span><br><span class="line"><span class="attr">Shared</span>=(Type=FileSystem, ReadOnly=<span class="literal">false</span>, Clean=<span class="literal">false</span>, Flush=<span class="literal">false</span>, DeleteUnused=<span class="literal">true</span>, UnusedFileAge=<span class="number">10</span>, FoldersToClean=<span class="number">10</span>, MaxFileChecksPerSec=<span class="number">1</span>, ConsiderSlowAt=<span class="number">70</span>, PromptIfMissing=<span class="literal">false</span>, Path=\\YourDDCServer\FMGame\DDC, EnvPathOverride=UE-SharedDataCachePath, EditorOverrideSetting=SharedDerivedDataCache)</span><br></pre></td></tr></table></figure>
<p>这是因为引擎在<code>Developer/DerivedDataCache/Private/DerivedDataBackends.cpp</code>中对安装版和源码版做了区分：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FDerivedDataBackendGraph()</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span>( !RootCache )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Use default graph</span></span><br><span class="line">    GraphName = FApp::IsEngineInstalled() ? TEXT(<span class="string">&quot;InstalledDerivedDataBackendGraph&quot;</span>) : TEXT(<span class="string">&quot;DerivedDataBackendGraph&quot;</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在设置完之后就可以通过Commandlet来执行DDC的生成了：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Binaries\Win64\UE4Editor.exe Client\Client.uproject -run=DerivedDataCache -fill</span><br></pre></td></tr></table></figure>
<p>该Commandlet定义在<code>Editor/UnrealEd/Classes/Commandlets/DerivedDataCacheCommandlet.h</code>。</p>
<h2 id="target文件"><a href="#target文件" class="headerlink" title=".target文件"></a>.target文件</h2><p>UE编译项目（Game/Program等）的时候会生成该项目的target文件，记录了该项目的文件依赖，以UHT为例</p>
<figure class="highlight json"><figcaption><span>UnrealHeaderTool.target</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;TargetName&quot;</span>: <span class="string">&quot;UnrealHeaderTool&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Platform&quot;</span>: <span class="string">&quot;Win64&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Configuration&quot;</span>: <span class="string">&quot;Development&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;TargetType&quot;</span>: <span class="string">&quot;Program&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Architecture&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Launch&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool.exe&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Version&quot;</span>: </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;MajorVersion&quot;</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">&quot;MinorVersion&quot;</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">&quot;PatchVersion&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;Changelist&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;CompatibleChangelist&quot;</span>: <span class="number">13144385</span>,</span><br><span class="line">    <span class="attr">&quot;IsLicenseeVersion&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;IsPromotedBuild&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;BranchName&quot;</span>: <span class="string">&quot;++UE4+Release-4.25&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;BuildId&quot;</span>: <span class="string">&quot;b5ff8f70-3501-456c-bde4-438215a9b5c5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;BuildVersion&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;BuildProducts&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool.exe&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;Executable&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-BuildSettings.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-BuildSettings.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-TraceLog.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-TraceLog.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Core.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Core.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Json.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Json.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Projects.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-Projects.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-CoreUObject.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;DynamicLibrary&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool-CoreUObject.pdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;SymbolFile&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool.version&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;RequiredResource&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/Win64/UnrealHeaderTool.modules&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;RequiredResource&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;RuntimeDependencies&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Path&quot;</span>: <span class="string">&quot;$(EngineDir)/Binaries/ThirdParty/DbgHelp/dbghelp.dll&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;NonUFS&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;AdditionalProperties&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Name&quot;</span>: <span class="string">&quot;SDK&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Value&quot;</span>: <span class="string">&quot;Not Applicable&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基于这个文件列表，可以实现自动提取程序依赖的功能，在想要提取UE的Program类型的程序时很有用。</p>
<h2 id="IOS-Crash分析文档"><a href="#IOS-Crash分析文档" class="headerlink" title="IOS Crash分析文档"></a>IOS Crash分析文档</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs">Diagnosing Issues Using Crash Reports and Device Logs</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/diagnosing_issues_using_crash_reports_and_device_logs/examining_the_fields_in_a_crash_report">Examining the Fields in a Crash Report</a></li>
</ul>
<h2 id="控制AssetRegistry的序列化"><a href="#控制AssetRegistry的序列化" class="headerlink" title="控制AssetRegistry的序列化"></a>控制AssetRegistry的序列化</h2><p>AssetRegistry其实主要是在Editor下用来方便进行资源的查找和过滤操作，它的主要使用者是ContentBrowser，这一点在UE的文档中也有描述：<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/ProgrammingAndScripting/ProgrammingWithCPP/Assets/Registry/index.html">Asset Registry</a>。</p>
<p>对于项目而言在Runtime可能没有需求来使用它，但是在<code>AssetRegistry</code>模块一启动就会把<code>AssetRegistry.bin</code>加载到内存中，如果对它没有需求其实这部分内存是浪费的。</p>
<p>好在UE提供了不序列化或者部分序列化AssetRegistry数据的方法，在<code>UAssetRegistryImpl</code>的构造函数中会调用<code>InitializeSerializationOptionsFromIni</code>函数来读取<code>DefaultEngine.ini</code>中的配置，并会构造出一个<code>FAssetRegistrySerializationOptions</code>结构来存储，它会在后续的<code>Serialize</code>函数中使用，用来控制把哪部分的数据序列化到<code>AssetRegistry</code>中。</p>
<figure class="highlight cpp"><figcaption><span>Runtime/AssetRegistry/Private/AssetRegistry.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAssetRegistryImpl::InitializeSerializationOptionsFromIni</span><span class="params">(FAssetRegistrySerializationOptions&amp; Options, <span class="keyword">const</span> FString&amp; PlatformIniName)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FConfigFile* EngineIni = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">  <span class="comment">// Use passed in platform, or current platform if empty</span></span><br><span class="line">  FConfigFile PlatformEngineIni;</span><br><span class="line">  FConfigCacheIni::LoadLocalIniFile(PlatformEngineIni, TEXT(<span class="string">&quot;Engine&quot;</span>), <span class="literal">true</span>, (!PlatformIniName.IsEmpty() ? *PlatformIniName : ANSI_TO_TCHAR(FPlatformProperties::IniPlatformName())));</span><br><span class="line">  EngineIni = &amp;PlatformEngineIni;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="comment">// In cooked builds, always use the normal engine INI</span></span><br><span class="line">  EngineIni = GConfig-&gt;FindConfigFile(GEngineIni);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bSerializeAssetRegistry&quot;</span>), Options.bSerializeAssetRegistry);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bSerializeDependencies&quot;</span>), Options.bSerializeDependencies);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bSerializeNameDependencies&quot;</span>), Options.bSerializeSearchableNameDependencies);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bSerializeManageDependencies&quot;</span>), Options.bSerializeManageDependencies);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bSerializePackageData&quot;</span>), Options.bSerializePackageData);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bUseAssetRegistryTagsWhitelistInsteadOfBlacklist&quot;</span>), Options.bUseAssetRegistryTagsWhitelistInsteadOfBlacklist);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bFilterAssetDataWithNoTags&quot;</span>), Options.bFilterAssetDataWithNoTags);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bFilterDependenciesWithNoTags&quot;</span>), Options.bFilterDependenciesWithNoTags);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bFilterSearchableNames&quot;</span>), Options.bFilterSearchableNames);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个控制方式可以在打包时控制是否生成AssetRegistry.bin，以及控制在运行时反序列化哪些AssetRegistry的数据（但是不会对DevelopmentAssetRegistry.bin造成影响，可以用它来进行资产审计）。</p>
<p>它的反序列化流程为：</p>
<ol>
<li>检测<code>bSerializeAssetRegistry</code>，如果为<code>true</code>则把AssetRegistry.bin以二进制形式加载到内存中</li>
<li>通过<code>Serialize</code>函数来把二进制数据反序列化</li>
<li>释放加载AssetRegistry.bin所占用的内存</li>
</ol>
<p>所以，AssetRegistry的内存占用是在序列化之后的数据，而<code>FAssetRegistrySerializationOptions</code>就是控制把哪些数据序列化的。</p>
<figure class="highlight cpp"><figcaption><span>Runtime/AssetRegistry/Public/AssetRegistryState.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Load/Save options used to modify how the cache is serialized. These are read out of the AssetRegistry section of Engine.ini and can be changed per platform. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FAssetRegistrySerializationOptions</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/** True rather to load/save registry at all */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeAssetRegistry;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True rather to load/save dependency info. If true this will handle hard and soft package references */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeDependencies;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True rather to load/save dependency info for Name references,  */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeSearchableNameDependencies;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True rather to load/save dependency info for Manage references,  */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializeManageDependencies;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** If true will read/write FAssetPackageData */</span></span><br><span class="line">  <span class="keyword">bool</span> bSerializePackageData;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True if CookFilterlistTagsByClass is a whitelist. False if it is a blacklist. */</span></span><br><span class="line">  <span class="keyword">bool</span> bUseAssetRegistryTagsWhitelistInsteadOfBlacklist;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True if we want to only write out asset data if it has valid tags. This saves memory by not saving data for things like textures */</span></span><br><span class="line">  <span class="keyword">bool</span> bFilterAssetDataWithNoTags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** True if we also want to filter out dependency data for assets that have no tags. Only filters if bFilterAssetDataWithNoTags is also true */</span></span><br><span class="line">  <span class="keyword">bool</span> bFilterDependenciesWithNoTags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Filter out searchable names from dependency data */</span></span><br><span class="line">  <span class="keyword">bool</span> bFilterSearchableNames;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** The map of classname to tag set of tags that are allowed in cooked builds. This is either a whitelist or blacklist depending on bUseAssetRegistryTagsWhitelistInsteadOfBlacklist */</span></span><br><span class="line">  TMap&lt;FName, TSet&lt;FName&gt;&gt; CookFilterlistTagsByClass;</span><br><span class="line"></span><br><span class="line">  FAssetRegistrySerializationOptions()</span><br><span class="line">    : bSerializeAssetRegistry(<span class="literal">false</span>)</span><br><span class="line">    , bSerializeDependencies(<span class="literal">false</span>)</span><br><span class="line">    , bSerializeSearchableNameDependencies(<span class="literal">false</span>)</span><br><span class="line">    , bSerializeManageDependencies(<span class="literal">false</span>)</span><br><span class="line">    , bSerializePackageData(<span class="literal">false</span>)</span><br><span class="line">    , bUseAssetRegistryTagsWhitelistInsteadOfBlacklist(<span class="literal">false</span>)</span><br><span class="line">    , bFilterAssetDataWithNoTags(<span class="literal">false</span>)</span><br><span class="line">    , bFilterDependenciesWithNoTags(<span class="literal">false</span>)</span><br><span class="line">    , bFilterSearchableNames(<span class="literal">false</span>)</span><br><span class="line">  &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Options used to read/write the DevelopmentAssetRegistry, which includes all data */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ModifyForDevelopment</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    bSerializeAssetRegistry = bSerializeDependencies = bSerializeSearchableNameDependencies = bSerializeManageDependencies = bSerializePackageData = <span class="literal">true</span>;</span><br><span class="line">    DisableFilters();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Disable all filters */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">DisableFilters</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    bFilterAssetDataWithNoTags = <span class="literal">false</span>;</span><br><span class="line">    bFilterDependenciesWithNoTags = <span class="literal">false</span>;</span><br><span class="line">    bFilterSearchableNames = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>配置的读取在以下代码中：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/AssetRegistry/Private/AssetRegistry.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UAssetRegistryImpl::InitializeSerializationOptionsFromIni</span><span class="params">(FAssetRegistrySerializationOptions&amp; Options, <span class="keyword">const</span> FString&amp; PlatformIniName)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FConfigFile* EngineIni = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">  <span class="comment">// Use passed in platform, or current platform if empty</span></span><br><span class="line">  FConfigFile PlatformEngineIni;</span><br><span class="line">  FConfigCacheIni::LoadLocalIniFile(PlatformEngineIni, TEXT(<span class="string">&quot;Engine&quot;</span>), <span class="literal">true</span>, (!PlatformIniName.IsEmpty() ? *PlatformIniName : ANSI_TO_TCHAR(FPlatformProperties::IniPlatformName())));</span><br><span class="line">  EngineIni = &amp;PlatformEngineIni;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="comment">// In cooked builds, always use the normal engine INI</span></span><br><span class="line">  EngineIni = GConfig-&gt;FindConfigFile(GEngineIni);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bSerializeAssetRegistry&quot;</span>), Options.bSerializeAssetRegistry);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bSerializeDependencies&quot;</span>), Options.bSerializeDependencies);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bSerializeNameDependencies&quot;</span>), Options.bSerializeSearchableNameDependencies);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bSerializeManageDependencies&quot;</span>), Options.bSerializeManageDependencies);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bSerializePackageData&quot;</span>), Options.bSerializePackageData);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bUseAssetRegistryTagsWhitelistInsteadOfBlacklist&quot;</span>), Options.bUseAssetRegistryTagsWhitelistInsteadOfBlacklist);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bFilterAssetDataWithNoTags&quot;</span>), Options.bFilterAssetDataWithNoTags);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bFilterDependenciesWithNoTags&quot;</span>), Options.bFilterDependenciesWithNoTags);</span><br><span class="line">  EngineIni-&gt;GetBool(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;bFilterSearchableNames&quot;</span>), Options.bFilterSearchableNames);</span><br><span class="line"></span><br><span class="line">  TArray&lt;FString&gt; FilterlistItems;</span><br><span class="line">  <span class="keyword">if</span> (Options.bUseAssetRegistryTagsWhitelistInsteadOfBlacklist)</span><br><span class="line">  &#123;</span><br><span class="line">    EngineIni-&gt;GetArray(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;CookedTagsWhitelist&quot;</span>), FilterlistItems);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    EngineIni-&gt;GetArray(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;CookedTagsBlacklist&quot;</span>), FilterlistItems);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// this only needs to be done once, and only on builds using USE_COMPACT_ASSET_REGISTRY</span></span><br><span class="line">    TArray&lt;FString&gt; AsFName;</span><br><span class="line">    EngineIni-&gt;GetArray(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;CookedTagsAsFName&quot;</span>), AsFName);</span><br><span class="line">    TArray&lt;FString&gt; AsPathName;</span><br><span class="line">    EngineIni-&gt;GetArray(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;CookedTagsAsPathName&quot;</span>), AsPathName);</span><br><span class="line">    TArray&lt;FString&gt; AsLocText;</span><br><span class="line">    EngineIni-&gt;GetArray(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>), TEXT(<span class="string">&quot;CookedTagsAsLocText&quot;</span>), AsLocText);</span><br><span class="line">    FAssetRegistryState::IngestIniSettingsForCompact(AsFName, AsPathName, AsLocText);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Config/DefaultEngine.ini</code>中创建<code>AssetRegistry</code>Section使用上面的名字就可以控制AssetRegistry的序列化，减少打包时的包体大小以及内存占用（AssetRegistry在引擎启动时会加载到内存中）</p>
<figure class="highlight ini"><figcaption><span>DefaultEngine.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[AssetRegistry]</span></span><br><span class="line"><span class="attr">bSerializeAssetRegistry</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializeDependencies</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializeNameDependencies</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializeManageDependencies</span>=<span class="literal">false</span></span><br><span class="line"><span class="attr">bSerializePackageData</span>=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>也可以对某个平台来单独指定，只需要修改平台相关的Ini文件：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Config/Windows/WindowsEngine.ini</span><br><span class="line">Config/Android/AndroidEngine.ini</span><br><span class="line">Config/IOS/IOSEngine.ini</span><br></pre></td></tr></table></figure>

<h2 id="材质Sampler超限制Crash"><a href="#材质Sampler超限制Crash" class="headerlink" title="材质Sampler超限制Crash"></a>材质Sampler超限制Crash</h2><p>打包Android运行时发现一个Crash问题：</p>
<p><img data-src="index/2020/20210226145229.webp"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[2021.02.26-06.24.25:291][593]LogRHI: Error: Failed to link program. Current total programs: 112 program binary bytes: 1786425</span><br><span class="line">  log:</span><br><span class="line">Error: Sampler Sampler location or component exceeds max allowed.</span><br><span class="line">Error: Linking failed.</span><br></pre></td></tr></table></figure>
<p>该错误执行在<code>Runtime/OpenGLDrv/Private/OpenGLShaders.cpp</code>中。</p>
<p>原因是某些材质的Sampler超了限制，导致错误。</p>
<p>排查方法为：打开材质，查看在平台中的Sampler的数量：</p>
<p><img data-src="index/2020/20210226145538.webp"></p>
<h2 id="DoesPackageExists分析"><a href="#DoesPackageExists分析" class="headerlink" title="DoesPackageExists分析"></a>DoesPackageExists分析</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">COREUOBJECT_API</span> <span class="title">FPackageName</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Checks if the package exists on disk.</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * @param LongPackageName Package name.</span></span><br><span class="line"><span class="comment">   * @param OutFilename Package filename on disk.</span></span><br><span class="line"><span class="comment">   * @param InAllowTextFormats Detect text format packages as well as binary (priority to text)</span></span><br><span class="line"><span class="comment">   * @return true if the specified package name points to an existing package, false otherwise.</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">DoesPackageExist</span><span class="params">(<span class="keyword">const</span> FString&amp; LongPackageName, <span class="keyword">const</span> FGuid* Guid = <span class="literal">NULL</span>, FString* OutFilename = <span class="literal">NULL</span>, <span class="keyword">bool</span> InAllowTextFormats = <span class="literal">true</span>)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>该函数用来检测Package是否<strong>在磁盘上存在</strong>。</p>
<p><strong>注意</strong>：在磁盘上存在在UE里有两个情况：</p>
<ol>
<li>Editor下存在uasset文件</li>
<li>打包模式下uasset是否在Mounted的Pak中存在</li>
</ol>
<p>事实上，UE也是这么做检测的：</p>
<ol>
<li>首先把要检测的LongPackageName根据规则转换为文件路径</li>
<li>通过FileManager来检测文件路径是否存在</li>
</ol>
<p>在Editor和打包模式下，FileManager通过<code>GetLowLevel()</code>拿到<code>IPlatformFile</code>，之后再进行FileExist的检测，UE针对各个平台封装了<code>IPlatformFile</code>，而且也具有PakPlatformFile的实现，可以实现从Pak中读取文件与在普通文件系统中访问一样的接口。</p>
<p><img data-src="index/2020/20210224143321.webp"><br>UE的跨平台写法，声明在通用接口里，定义在各个平台的单独文件中：<br><img data-src="index/2020/20210224143807.webp"></p>
<p>在引擎启动时会把这些<code>IPlatformFile</code>的对象创建：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Launch/Private/LaunchEngineLoop.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Look for any file overrides on the command line (i.e. network connection file handler)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">LaunchCheckForFileOverride</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine, <span class="keyword">bool</span>&amp; OutFileOverrideFound)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  OutFileOverrideFound = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the physical platform file.</span></span><br><span class="line">  IPlatformFile* CurrentPlatformFile = &amp;FPlatformFileManager::Get().GetPlatformFile();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try to create pak file wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = ConditionallyCreateFileWrapper(TEXT(<span class="string">&quot;PakFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::Get().SetPlatformFile(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">    PlatformFile = ConditionallyCreateFileWrapper(TEXT(<span class="string">&quot;CachedReadFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::Get().SetPlatformFile(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try to create sandbox wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = ConditionallyCreateFileWrapper(TEXT(<span class="string">&quot;SandboxFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::Get().SetPlatformFile(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING <span class="comment">// UFS clients are not available in shipping builds.</span></span></span><br><span class="line">  <span class="comment">// Streaming network wrapper (it has a priority over normal network wrapper)</span></span><br><span class="line">  <span class="keyword">bool</span> bNetworkFailedToInitialize = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">bool</span> bShouldUseStreamingFile = <span class="literal">false</span>;</span><br><span class="line">    IPlatformFile* NetworkPlatformFile = ConditionallyCreateFileWrapper(TEXT(<span class="string">&quot;StreamingFile&quot;</span>), CurrentPlatformFile, CmdLine, &amp;bNetworkFailedToInitialize, &amp;bShouldUseStreamingFile);</span><br><span class="line">    <span class="keyword">if</span> (NetworkPlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = NetworkPlatformFile;</span><br><span class="line">      FPlatformFileManager::Get().SetPlatformFile(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> bShouldUseCookedIterativeFile = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !bShouldUseStreamingFile &amp;&amp; !NetworkPlatformFile )</span><br><span class="line">    &#123;</span><br><span class="line">      NetworkPlatformFile = ConditionallyCreateFileWrapper(TEXT(<span class="string">&quot;CookedIterativeFile&quot;</span>), CurrentPlatformFile, CmdLine, &amp;bNetworkFailedToInitialize, &amp;bShouldUseCookedIterativeFile);</span><br><span class="line">      <span class="keyword">if</span> (NetworkPlatformFile)</span><br><span class="line">      &#123;</span><br><span class="line">        CurrentPlatformFile = NetworkPlatformFile;</span><br><span class="line">        FPlatformFileManager::Get().SetPlatformFile(*CurrentPlatformFile);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if streaming network platform file was tried this loop don&#x27;t try this one</span></span><br><span class="line">    <span class="comment">// Network file wrapper (only create if the streaming wrapper hasn&#x27;t been created)</span></span><br><span class="line">    <span class="keyword">if</span> ( !bShouldUseStreamingFile &amp;&amp; !bShouldUseCookedIterativeFile &amp;&amp; !NetworkPlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      NetworkPlatformFile = ConditionallyCreateFileWrapper(TEXT(<span class="string">&quot;NetworkFile&quot;</span>), CurrentPlatformFile, CmdLine, &amp;bNetworkFailedToInitialize);</span><br><span class="line">      <span class="keyword">if</span> (NetworkPlatformFile)</span><br><span class="line">      &#123;</span><br><span class="line">        CurrentPlatformFile = NetworkPlatformFile;</span><br><span class="line">        FPlatformFileManager::Get().SetPlatformFile(*CurrentPlatformFile);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bNetworkFailedToInitialize)</span><br><span class="line">    &#123;</span><br><span class="line">      FString HostIpString;</span><br><span class="line">      FParse::Value(CmdLine, TEXT(<span class="string">&quot;-FileHostIP=&quot;</span>), HostIpString);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_REQUIRES_FILESERVER</span></span><br><span class="line">      FPlatformMisc::LowLevelOutputDebugStringf(TEXT(<span class="string">&quot;Failed to connect to file server at %s. RETRYING in 5s.\n&quot;</span>), *HostIpString);</span><br><span class="line">      FPlatformProcess::Sleep(<span class="number">5.0f</span>);</span><br><span class="line">      uint32 Result = <span class="number">2</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">//PLATFORM_REQUIRES_FILESERVER</span></span></span><br><span class="line">      <span class="comment">// note that this can&#x27;t be localized because it happens before we connect to a filserver - localizing would cause ICU to try to load.... from over the file server connection!</span></span><br><span class="line">      FString Error = FString::Printf(TEXT(<span class="string">&quot;Failed to connect to any of the following file servers:\n\n    %s\n\nWould you like to try again? No will fallback to local disk files, Cancel will quit.&quot;</span>), *HostIpString.Replace( TEXT(<span class="string">&quot;+&quot;</span>), TEXT(<span class="string">&quot;\n    &quot;</span>)));</span><br><span class="line">      uint32 Result = FMessageDialog::Open( EAppMsgType::YesNoCancel, FText::FromString( Error ) );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">//PLATFORM_REQUIRES_FILESERVER</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Result == EAppReturnType::No)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (Result == EAppReturnType::Cancel)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Cancel - return a failure, and quit</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (bNetworkFailedToInitialize);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  <span class="comment">// Try to create file profiling wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = ConditionallyCreateFileWrapper(TEXT(<span class="string">&quot;ProfileFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::Get().SetPlatformFile(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = ConditionallyCreateFileWrapper(TEXT(<span class="string">&quot;SimpleProfileFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::Get().SetPlatformFile(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Try and create file timings stats wrapper</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = ConditionallyCreateFileWrapper(TEXT(<span class="string">&quot;FileReadStats&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::Get().SetPlatformFile(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Try and create file open log wrapper (lists the order files are first opened)</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = ConditionallyCreateFileWrapper(TEXT(<span class="string">&quot;FileOpenLog&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::Get().SetPlatformFile(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">//#if !UE_BUILD_SHIPPING</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wrap the above in a file logging singleton if requested</span></span><br><span class="line">  &#123;</span><br><span class="line">    IPlatformFile* PlatformFile = ConditionallyCreateFileWrapper(TEXT(<span class="string">&quot;LogFile&quot;</span>), CurrentPlatformFile, CmdLine);</span><br><span class="line">    <span class="keyword">if</span> (PlatformFile)</span><br><span class="line">    &#123;</span><br><span class="line">      CurrentPlatformFile = PlatformFile;</span><br><span class="line">      FPlatformFileManager::Get().SetPlatformFile(*CurrentPlatformFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If our platform file is different than it was when we started, then an override was used</span></span><br><span class="line">  OutFileOverrideFound = (CurrentPlatformFile != &amp;FPlatformFileManager::Get().GetPlatformFile());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="LoadObject加载磁盘文件栈"><a href="#LoadObject加载磁盘文件栈" class="headerlink" title="LoadObject加载磁盘文件栈"></a>LoadObject加载磁盘文件栈</h2><p><img data-src="index/2020/20210224100616.webp"></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">FFileManagerGeneric::CreateFileReaderInternal(const wchar_t *,unsigned int,unsigned int) FileManagerGeneric.cpp:47</span><br><span class="line">FLinkerLoad::CreateLoader(TFunction&lt;void __cdecl(void)&gt; &amp;&amp;) LinkerLoad.cpp:1037</span><br><span class="line">FLinkerLoad::Tick(float,bool,bool,TMap&lt;TTuple&lt;FName,FPackageIndex&gt;,FPackageIndex,FDefaultSetAllocator,TDefaultMapHashableKeyFuncs&lt;TTuple&lt;FName,FPackageIndex&gt;,FPackageIndex,0&gt; &gt; *) LinkerLoad.cpp:696</span><br><span class="line">FLinkerLoad::CreateLinker(FUObjectSerializeContext *,UPackage *,const wchar_t *,unsigned int,FArchive *) LinkerLoad.cpp:459</span><br><span class="line">GetPackageLinker(UPackage *,const wchar_t *,unsigned int,UPackageMap *,FGuid *,FArchive *,FUObjectSerializeContext **) Linker.cpp:745</span><br><span class="line">LoadPackageInternal(UPackage *,const wchar_t *,unsigned int,FLinkerLoad *,FArchive *,FUObjectSerializeContext *) UObjectGlobals.cpp:1208</span><br><span class="line">LoadPackage(UPackage *,const wchar_t *,unsigned int,FArchive *,FUObjectSerializeContext *) UObjectGlobals.cpp:1427</span><br><span class="line">ResolveName(UObject *&amp;,FString &amp;,bool,bool,unsigned int,FUObjectSerializeContext *) UObjectGlobals.cpp:767</span><br><span class="line">StaticLoadObjectInternal(UClass *,UObject *,const wchar_t *,const wchar_t *,unsigned int,UPackageMap *,bool,FUObjectSerializeContext *) UObjectGlobals.cpp:828</span><br><span class="line">StaticLoadObject(UClass *,UObject *,const wchar_t *,const wchar_t *,unsigned int,UPackageMap *,bool,FUObjectSerializeContext *) UObjectGlobals.cpp:904</span><br><span class="line">FSoftObjectPath::TryLoad(FUObjectSerializeContext *) SoftObjectPath.cpp:431</span><br><span class="line">FSoftObjectPtr::LoadSynchronous() SoftObjectPtr.h:54</span><br><span class="line">UPaperSprite::GetSourceTexture() PaperSprite.cpp:1474</span><br><span class="line">UPaperSprite::PostLoad() PaperSprite.cpp:1842</span><br><span class="line">UObject::ConditionalPostLoad() Obj.cpp:1067</span><br><span class="line">FAsyncPackage::PostLoadObjects() AsyncLoading.cpp:6356</span><br><span class="line">FAsyncPackage::TickAsyncPackage(bool,bool,float &amp;,FFlushTree *) AsyncLoading.cpp:5533</span><br><span class="line">FAsyncLoadingThread::ProcessAsyncLoading(int &amp;,bool,bool,float,FFlushTree *) AsyncLoading.cpp:4178</span><br><span class="line">FAsyncLoadingThread::TickAsyncThread(bool,bool,float,bool &amp;,FFlushTree *) AsyncLoading.cpp:4819</span><br><span class="line">FAsyncLoadingThread::TickAsyncLoading(bool,bool,float,FFlushTree *) AsyncLoading.cpp:4519</span><br><span class="line">FAsyncLoadingThread::ProcessLoading(bool,bool,float) AsyncLoading.cpp:7057</span><br><span class="line">StaticTick(float,bool,float) UObjectGlobals.cpp:464</span><br><span class="line">UEditorEngine::Tick(float,bool) EditorEngine.cpp:1355</span><br><span class="line">UUnrealEdEngine::Tick(float,bool) UnrealEdEngine.cpp:411</span><br><span class="line">FEngineLoop::Tick() LaunchEngineLoop.cpp:4844</span><br><span class="line">GuardedMain(const wchar_t *) Launch.cpp:171</span><br><span class="line">WinMain(HINSTANCE__ *,HINSTANCE__ *,char *,int) LaunchWindows.cpp:257</span><br><span class="line">__scrt_common_main_seh() 0x00007ff6ab4e140a</span><br><span class="line">BaseThreadInitThunk 0x00007ffabeff7c24</span><br><span class="line">RtlUserThreadStart 0x00007ffabfcad4d1</span><br></pre></td></tr></table></figure>

<h2 id="rebuild-metadata"><a href="#rebuild-metadata" class="headerlink" title="rebuild metadata"></a>rebuild metadata</h2><p>可以通过执行cook的Commandlet来重新生成AssetRegistry以及ushaderbytecode：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor-cmd.exe PROJECT_NAME.uproject -run=cook -targetplatform=WindowsNoEditor -Iterate -UnVersioned -Compressed</span><br></pre></td></tr></table></figure>
<p>执行完毕之后<code>Saved/Cooked</code>下的<code>AssetRegistry.bin</code>/<code>Metadate目录</code>/<code>Content/ShaderArchive-*.ushaderbytecode</code>以及<code>Ending/GlobalShaderCache*.bin</code>等文件都是生成之后最新的了，可以在之后通过HotPatcher来打包他们了。</p>
<h2 id="IPA包最大为4GB"><a href="#IPA包最大为4GB" class="headerlink" title="IPA包最大为4GB"></a>IPA包最大为4GB</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4753100/max-size-of-an-ios-application">Max size of an iOS application</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/support/app-store-connect/">App Store Connect</a></li>
</ul>
<h2 id="自动化Editor的Crash上报"><a href="#自动化Editor的Crash上报" class="headerlink" title="自动化Editor的Crash上报"></a>自动化Editor的Crash上报</h2><p>因为UE的Crash是拉起一个CrashReportClient程序来执行的，所以如果我们需要在程序出现Crash时上报log信息，可以在<code>CrashReportClientMainWindows</code>中做这部分逻辑。</p>
<p><img data-src="index/2020/20210220105308.webp"></p>
<h2 id="监听资源创建"><a href="#监听资源创建" class="headerlink" title="监听资源创建"></a>监听资源创建</h2><p>在Editor中创建资源，并没有直接保存到磁盘上，所以要监听<code>OnInMemoryAssetCreated</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FAssetRegistryModule&amp; AssetRegistryModule = FModuleManager::LoadModuleChecked&lt;FAssetRegistryModule&gt;(</span><br><span class="line">    TEXT(<span class="string">&quot;AssetRegistry&quot;</span>));</span><br><span class="line">  AssetRegistryModule.Get().OnInMemoryAssetCreated().AddRaw(<span class="keyword">this</span>, &amp;FTestEditorModule::OnInMemoryAssetCreated);</span><br></pre></td></tr></table></figure>
<p>回调过来的就是一个<code>UObject*</code>，实际上是一个<code>UBlueprint*</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FTestEditorModule::OnInMemoryAssetCreated</span><span class="params">(UObject* Object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Object) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  UBlueprint* Blueprint = Cast&lt;UBlueprint&gt;(Object);</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Blueprint) <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以实现监听uasset创建事件，对该uasset执行一些操作（如默认添加接口等）。</p>
<p>拿到<code>UBlueprint</code>后就可以通过<code>FBlueprintEditorUtils</code>等辅助类来实现对蓝图资源的操作了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FTestEditor::AddInterface</span><span class="params">(UBlueprint* Blueprint)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Blueprint) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  UClass* Class = Blueprint ? *Blueprint-&gt;GeneratedClass : Blueprint ? Blueprint-&gt;GetClass() : <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Class) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!Class-&gt;IsChildOf&lt;UUserWidget&gt;()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> UClass* InterfaceClass = UUnLuaInterface::StaticClass();</span><br><span class="line"></span><br><span class="line">  UFunction* Func = FBlueprintEditorUtils::GetInterfaceFunction(Blueprint, FName(<span class="string">&quot;GetModuleName&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Func)</span><br><span class="line">  &#123;</span><br><span class="line">    FBlueprintEditorUtils::ImplementNewInterface(Blueprint, InterfaceClass-&gt;GetFName());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Func = FBlueprintEditorUtils::GetInterfaceFunction(Blueprint, FName(<span class="string">&quot;GetModuleName&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Func) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> ImplementedInterfaces = Blueprint-&gt;ImplementedInterfaces;</span><br><span class="line">  <span class="keyword">if</span> (ImplementedInterfaces.Num() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> InterfacesDesc = ImplementedInterfaces[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Graphs = InterfacesDesc.Graphs;</span><br><span class="line">  <span class="keyword">if</span> (Graphs.Num() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Graph = Graphs[<span class="number">0</span>]; <span class="comment">//UEdGraph</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Graph) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Nodes = Graph-&gt;Nodes;</span><br><span class="line">  <span class="keyword">if</span> (Nodes.Num() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Node = Nodes[<span class="number">1</span>]; <span class="comment">//UEdGraphNode</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Node) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Pins = Node-&gt;Pins;</span><br><span class="line">  <span class="keyword">if</span> (Pins.Num() &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> Pin = Pins[<span class="number">1</span>]; <span class="comment">//UEdGraphPin</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> == Pin) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  FString moduleName;</span><br><span class="line">  UnLuaExtensionUtils::GetLuaModuleName(Class-&gt;GetName(), Class-&gt;GetPathName(), moduleName);</span><br><span class="line"></span><br><span class="line">  Pin-&gt;DefaultValue = moduleName;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Build-lighting-from-commandlet"><a href="#Build-lighting-from-commandlet" class="headerlink" title="Build lighting from commandlet"></a>Build lighting from commandlet</h2><p>在命令行构建光照，可以使用<code>ResavePackages</code>这个commandlet：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor-cmd.exe <span class="string">&quot;E:\UE4Project.uproject&quot;</span> -run=resavepackages -buildlighting -quality=Preview -allowcommandletrendering -map=MapName</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/commit/f89256dd0efb7d0b1427729a8f8a6007">Rebuild Lightmaps Commandlet</a></li>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/124936/build-lighting-from-command-line.html">Build lighting from command line</a></li>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/unreal-engine/feedback-for-epic/44406-build-static-lighting-from-command-line">Build static lighting from command line</a></li>
</ul>
<h2 id="AutomationTool的ErrorCode"><a href="#AutomationTool的ErrorCode" class="headerlink" title="AutomationTool的ErrorCode"></a>AutomationTool的ErrorCode</h2><p>打包时的错误，可以通过这些错误码的描述来排查原因，该enum定义在<code>Programs/AutomationTool/AutomationUtils/AutomationException.cs</code>。</p>
<figure class="highlight csharp"><figcaption><span>Programs/AutomationTool/AutomationUtils/AutomationException.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">AutomationTool</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> this needs to be kept in sync with EditorAnalytics.h and iPhonePackager.cs</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">enum</span> ExitCode</span><br><span class="line">    &#123;</span><br><span class="line">        Error_UATNotFound = <span class="number">-1</span>,</span><br><span class="line">        Success = <span class="number">0</span>,</span><br><span class="line">        Error_Unknown = <span class="number">1</span>,</span><br><span class="line">        Error_Arguments = <span class="number">2</span>,</span><br><span class="line">        Error_UnknownCommand = <span class="number">3</span>,</span><br><span class="line">        Error_SDKNotFound = <span class="number">10</span>,</span><br><span class="line">        Error_ProvisionNotFound = <span class="number">11</span>,</span><br><span class="line">        Error_CertificateNotFound = <span class="number">12</span>,</span><br><span class="line">        Error_ProvisionAndCertificateNotFound = <span class="number">13</span>,</span><br><span class="line">        Error_InfoPListNotFound = <span class="number">14</span>,</span><br><span class="line">        Error_KeyNotFoundInPList = <span class="number">15</span>,</span><br><span class="line">        Error_ProvisionExpired = <span class="number">16</span>,</span><br><span class="line">        Error_CertificateExpired = <span class="number">17</span>,</span><br><span class="line">        Error_CertificateProvisionMismatch = <span class="number">18</span>,</span><br><span class="line">        Error_CodeUnsupported = <span class="number">19</span>,</span><br><span class="line">        Error_PluginsUnsupported = <span class="number">20</span>,</span><br><span class="line">        Error_UnknownCookFailure = <span class="number">25</span>,</span><br><span class="line">        Error_UnknownDeployFailure = <span class="number">26</span>,</span><br><span class="line">        Error_UnknownBuildFailure = <span class="number">27</span>,</span><br><span class="line">        Error_UnknownPackageFailure = <span class="number">28</span>,</span><br><span class="line">        Error_UnknownLaunchFailure = <span class="number">29</span>,</span><br><span class="line">        Error_StageMissingFile = <span class="number">30</span>,</span><br><span class="line">        Error_FailedToCreateIPA = <span class="number">31</span>,</span><br><span class="line">        Error_FailedToCodeSign = <span class="number">32</span>,</span><br><span class="line">        Error_DeviceBackupFailed = <span class="number">33</span>,</span><br><span class="line">        Error_AppUninstallFailed = <span class="number">34</span>,</span><br><span class="line">        Error_AppInstallFailed = <span class="number">35</span>,</span><br><span class="line">        Error_AppNotFound = <span class="number">36</span>,</span><br><span class="line">        Error_StubNotSignedCorrectly = <span class="number">37</span>,</span><br><span class="line">        Error_IPAMissingInfoPList = <span class="number">38</span>,</span><br><span class="line">        Error_DeleteFile = <span class="number">39</span>,</span><br><span class="line">        Error_DeleteDirectory = <span class="number">40</span>,</span><br><span class="line">        Error_CreateDirectory = <span class="number">41</span>,</span><br><span class="line">        Error_CopyFile = <span class="number">42</span>,</span><br><span class="line">        Error_OnlyOneObbFileSupported = <span class="number">50</span>,</span><br><span class="line">        Error_FailureGettingPackageInfo = <span class="number">51</span>,</span><br><span class="line">        Error_OnlyOneTargetConfigurationSupported = <span class="number">52</span>,</span><br><span class="line">        Error_ObbNotFound = <span class="number">53</span>,</span><br><span class="line">        Error_AndroidBuildToolsPathNotFound = <span class="number">54</span>,</span><br><span class="line">        Error_NoApkSuitableForArchitecture = <span class="number">55</span>,</span><br><span class="line">        Error_FilesInstallFailed = <span class="number">56</span>,</span><br><span class="line">        Error_RemoteCertificatesNotFound = <span class="number">57</span>,</span><br><span class="line">        Error_LauncherFailed = <span class="number">100</span>,</span><br><span class="line">        Error_UATLaunchFailure = <span class="number">101</span>,</span><br><span class="line">        Error_FailedToDeleteStagingDirectory = <span class="number">102</span>,</span><br><span class="line">        Error_MissingExecutable = <span class="number">103</span>,</span><br><span class="line">        Error_DeviceNotSetupForDevelopment = <span class="number">150</span>,</span><br><span class="line">        Error_DeviceOSNewerThanSDK = <span class="number">151</span>,</span><br><span class="line">    Error_TestFailure = <span class="number">152</span>,</span><br><span class="line">    Error_SymbolizedSONotFound = <span class="number">153</span>,</span><br><span class="line">    Error_LicenseNotAccepted = <span class="number">154</span>,</span><br><span class="line">    Error_AndroidOBBError = <span class="number">155</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用AssetRegistry检测资源是否存在"><a href="#使用AssetRegistry检测资源是否存在" class="headerlink" title="使用AssetRegistry检测资源是否存在"></a>使用AssetRegistry检测资源是否存在</h2><p>在<code>Editor/UnrealEd/Private/FileHelpers.cpp</code>中提供了一个实现，优先通过<code>AssetRegistry</code>来查找，查找不到则退回到从磁盘查找：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> FileHelperPackageUtil</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * DoesPackageExist helper that rely on the AssetRegistry to validate if a package exists instead of hitting the FS</span></span><br><span class="line"><span class="comment">   * Fallback to the FS if the asset registry initial scan isn&#x27;t done or we aren&#x27;t in Editor</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">DoesPackageExist</span><span class="params">(UPackage* Package, FString* OutFilename = <span class="literal">nullptr</span>)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// Test using asset registry to figure out existence</span></span><br><span class="line">    IAssetRegistry&amp; AssetRegistry = FAssetRegistryModule::GetRegistry();</span><br><span class="line">    <span class="keyword">if</span> (!AssetRegistry.IsLoadingAssets() || !GIsEditor)</span><br><span class="line">    &#123;</span><br><span class="line">      TArray&lt;FAssetData&gt; Data;</span><br><span class="line">      FAssetRegistryModule::GetRegistry().GetAssetsByPackageName(Package-&gt;GetFName(), Data, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Data.Num() &gt; <span class="number">0</span> &amp;&amp; OutFilename)</span><br><span class="line">      &#123;</span><br><span class="line">        *OutFilename = FPackageName::LongPackageNameToFilename(Package-&gt;GetName(), Package-&gt;ContainsMap() ? FPackageName::GetMapPackageExtension() : FPackageName::GetAssetPackageExtension());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> Data.Num() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> FPackageName::DoesPackageExist(Package-&gt;GetName(), <span class="literal">nullptr</span>, OutFilename);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="分析打包的资源"><a href="#分析打包的资源" class="headerlink" title="分析打包的资源"></a>分析打包的资源</h2><p>工程中有很多的资源其实并没有打到包中去，当需要分析包体中资源大小时，可以通过<code>Asset Audit</code>工具来实现，通过<code>Window</code>-<code>Developer Tools</code>-<code>AssetAudit</code>打开。</p>
<p><img data-src="index/2020/20210202194343.webp"></p>
<p>可以看到资源路径、大小、位于哪些Chunk中等一系列的信息，便于排查资源大小和Chunk中的资源冗余。</p>
<p>首先，需要说明<code>Editor</code>里的资源大小和最终打到包内的大小是不一样的，在右上角会列出已经打包的平台（Saved/Cooked）下的平台。</p>
<p><code>Asset Audit</code>需要读取<code>DevelopmentAssetRegistry.bin</code>文件来得到某个平台的资源信息的，它在以下路径中：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client\Saved\Cooked\WindowsNoEditor\FGame\Metadata\DevelopmentAssetRegistry.bin</span><br></pre></td></tr></table></figure>
<p>这个文件记录着某个平台执行完Cook之后资源的大小信息，注意Cook之后的资源如Texture2D等设置的压缩均以执行，但是打包成pak也会执行压缩，这里列出来的大小是没有经过打包pak压缩的Cook资源之后的原始大小。</p>
<p>可以在打包时自动提取Cooked目录下的Metadata目录，在AssetAudit窗口的右上角选择Custom，选择DevelopmentAssetRegistry.bin文件即可。</p>
<h2 id="UE4中ES3-1的75根骨骼限制"><a href="#UE4中ES3-1的75根骨骼限制" class="headerlink" title="UE4中ES3.1的75根骨骼限制"></a>UE4中ES3.1的75根骨骼限制</h2><p>之前提到过在ES2.0上使用单个材质蒙皮的骨骼不能超过75根，在ES3之后就没有这个限制了，但是UE里目前还有这个限制。</p>
<blockquote>
<p>Warning: SkeletalMesh SK_m0146b0003, is not supported for current feature level (ES3_1) and will not be rendered. NumBones 78 (supported 75), NumBoneInfluences: 4</p>
</blockquote>
<figure class="highlight cpp"><figcaption><span>Runtime/RHI/Public/RHIDefinitions.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> int32 <span class="title">GetFeatureLevelMaxNumberOfBones</span><span class="params">(<span class="keyword">const</span> FStaticFeatureLevel FeatureLevel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (FeatureLevel)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> ERHIFeatureLevel::ES3_1:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">75</span>;  </span><br><span class="line">  <span class="keyword">case</span> ERHIFeatureLevel::SM5:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">65536</span>; <span class="comment">// supports uint16</span></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    checkf(<span class="number">0</span>, TEXT(<span class="string">&quot;Unknown FeatureLevel %d&quot;</span>), (int32)FeatureLevel);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看了下相关的代码，UE在下面这次提交中修改了ES3.1原本256到75，commit里提到的是修复了Mobile Preview的Crash:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/commit/c33160755b4c28b4277f4323c7e4c9c7bdfdb995">Fixed: Skeletal Mesh with more than 75 bones crashes Mobile Preview</a></li>
</ul>
<blockquote>
<p>Limit ES3.1 to 75 bones like ES2. All ES3.1 feature level platforms use UB for Bones. Project has to set Compat.MAX_GPUSKIN_BONES=75 to support SkelMeshes with more than 75 bones for ES3.1 and ES2.</p>
</blockquote>
<p>该代码在4.21 Preview 4中提交：<a target="_blank" rel="noopener" href="https://forums.unrealengine.com/unreal-engine/announcements-and-releases/1537691-unreal-engine-4-21-preview">Unreal Engine 4.21 Preview</a></p>
<p>在answers上也有一些相关的问题：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/919176/change-es3-1-bone-number-limit-to-256.html">Change ES3_1 bone number limit to 256</a></li>
</ul>
<h2 id="UE4热更注意事项"><a href="#UE4热更注意事项" class="headerlink" title="UE4热更注意事项"></a>UE4热更注意事项</h2><ol>
<li>不能引用基础包中不存在的插件中的资源</li>
<li>包含shaderbytecode（share material shaderbytecode）</li>
<li>包含AssetRegistry（新加/删除/修改资源引用）</li>
<li>避免一个目录既包含uasset又包含non-asset的情况</li>
</ol>
<h2 id="upluginmanifest"><a href="#upluginmanifest" class="headerlink" title="upluginmanifest"></a>upluginmanifest</h2><p>项目打包时会根据项目启用的插件生成一个<code>PROJECT_NAME.upluginmanifest</code>文件，其中记录了每个启用的插件的<code>uplugin</code>的路径和内容信息，该文件也会打包到pak中。</p>
<p>Mount Point为：<code>../../../PROJECT_NAME/Plugins/PROJECT_NAME.upluginmanifest</code></p>
<p>在Editor下运行时不会读取这个文件，通过扫描引擎和项目以及<code>Mods</code>目录下的Plugin目录来查找插件的，相关的逻辑在<code>Runtime/Projects/Private/PluginManager.cpp</code>的<code>ReadAllPlugins</code>函数中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !WITH_EDITOR</span></span><br><span class="line">  <span class="keyword">if</span> (Project != <span class="literal">nullptr</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    FindPluginManifestsInDirectory(*FPaths::ProjectPluginsDir(), ManifestFileNames);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !WITH_EDITOR</span></span></span><br></pre></td></tr></table></figure>
<p>在非Editor下通过加载upluginmanifest文件来确定当前工程中有哪些插件的（upluginmanifest文件可以有多个，只要放在<code>../../../PROJECT_NAME/Plugins</code>目录下即可），如果一个插件在基础包中不存在，但是热更时新建了一个Content Only插件打包资源，需要把该插件添加至upluginmanifest中并且也需要把该插件的uplugin打包至pak中。</p>
<h2 id="添加非Content路径的Non-Asset目录到基础包"><a href="#添加非Content路径的Non-Asset目录到基础包" class="headerlink" title="添加非Content路径的Non-Asset目录到基础包"></a>添加非Content路径的Non-Asset目录到基础包</h2><p>在<code>Project Settings</code>-<code>Packaging</code>-<code>Additional Non-Asset Directories to Package</code>可以添加相对路Content下的目录，但是不能够直接选Content之外的目录。<br><img data-src="index/2020/20210127152358.webp"></p>
<p>但是，其实这里是可以填相对路径的，如添加<code>[PROJECT_DIR]/Source/Script</code>目录：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/UnrealEd.ProjectPackagingSettings]</span></span><br><span class="line">+DirectoriesToAlwaysStageAsUFS=(Path=&quot;../Source/Script&quot;)</span><br></pre></td></tr></table></figure>
<p>在打包时能够正确地处理这个相对路径的，Mount Point也正常：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;D:\UnrealProjects\Client\Source\Script\UnLua.lua&quot; &quot;../../../FGame/Source/Script/UnLua.lua&quot;</span><br></pre></td></tr></table></figure>
<p>使用这种相对路径可以实现把位于项目Content之外的Non-Asset目录添加到基础包中。</p>
<p>实现分析：<br><code>[/Script/UnrealEd.ProjectPackagingSettings]</code>的<code>DirectoriesToAlwaysStageAsUFS</code>值是在<code>Programs/AutomationTool/Scripts/CopyBuildToStagingDirectory.Automation.cs</code>中被读取的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StageAdditionalDirectoriesFromConfig</span>(<span class="params">DeploymentContext SC, DirectoryReference ProjectContentRoot, StagedDirectoryReference StageContentRoot, ConfigHierarchy PlatformGameConfig, <span class="keyword">bool</span> bUFS, <span class="keyword">string</span> ConfigKeyName</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    List&lt;<span class="keyword">string</span>&gt; ExtraDirs;</span><br><span class="line">    <span class="keyword">if</span> (PlatformGameConfig.GetArray(<span class="string">&quot;/Script/UnrealEd.ProjectPackagingSettings&quot;</span>, ConfigKeyName, <span class="keyword">out</span> ExtraDirs))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Each string has the format &#x27;(Path=&quot;TheDirToStage&quot;)&#x27;</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> PathStr <span class="keyword">in</span> ExtraDirs)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span> RelativePath = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> PathParts = PathStr.Split(<span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (PathParts.Length == <span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                RelativePath = PathParts[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (PathParts.Length == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                RelativePath = PathParts[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (RelativePath != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                DirectoryReference InputDir = DirectoryReference.Combine(ProjectContentRoot, RelativePath);</span><br><span class="line">                StagedDirectoryReference OutputDir = StagedDirectoryReference.Combine(StageContentRoot, RelativePath);</span><br><span class="line">                <span class="keyword">if</span> (bUFS)</span><br><span class="line">                &#123;</span><br><span class="line">                    List&lt;FileReference&gt; Files = SC.FindFilesToStage(InputDir, StageFilesSearch.AllDirectories);</span><br><span class="line">                    Files.RemoveAll(x =&gt; x.HasExtension(<span class="string">&quot;.uasset&quot;</span>) || x.HasExtension(<span class="string">&quot;.umap&quot;</span>) || (SC.DedicatedServer &amp;&amp; x.HasExtension(<span class="string">&quot;.mp4&quot;</span>)));</span><br><span class="line">                    SC.StageFiles(StagedFileType.UFS, InputDir, Files, OutputDir);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    SC.StageFiles(StagedFileType.NonUFS, InputDir, StageFilesSearch.AllDirectories, OutputDir);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreateStagingManifest</span>(<span class="params">ProjectParams Params, DeploymentContext SC</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Stage any additional UFS and NonUFS paths specified in the project ini files; these dirs are relative to the game content directory</span></span><br><span class="line">    <span class="keyword">if</span> (PlatformGameConfig != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        StageAdditionalDirectoriesFromConfig(SC, ProjectContentRoot, StageContentRoot, PlatformGameConfig, <span class="literal">true</span>, <span class="string">&quot;DirectoriesToAlwaysStageAsUFS&quot;</span>);</span><br><span class="line">        <span class="comment">// NonUFS files are never in pak files and should always be remapped</span></span><br><span class="line">        StageAdditionalDirectoriesFromConfig(SC, ProjectContentRoot, StageContentRoot, PlatformGameConfig, <span class="literal">false</span>, <span class="string">&quot;DirectoriesToAlwaysStageAsNonUFS&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SC.DedicatedServer)</span><br><span class="line">        &#123;</span><br><span class="line">            StageAdditionalDirectoriesFromConfig(SC, ProjectContentRoot, StageContentRoot, PlatformGameConfig, <span class="literal">true</span>, <span class="string">&quot;DirectoriesToAlwaysStageAsUFSServer&quot;</span>);</span><br><span class="line">            <span class="comment">// NonUFS files are never in pak files and should always be remapped</span></span><br><span class="line">            StageAdditionalDirectoriesFromConfig(SC, ProjectContentRoot, StageContentRoot, PlatformGameConfig, <span class="literal">false</span>, <span class="string">&quot;DirectoriesToAlwaysStageAsNonUFSServer&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Directory.Combine</code>里正确地处理了我们所指定的相对于Content的<code>../Source/Script</code>路径。</p>
<h2 id="FDataTime-UtcNow"><a href="#FDataTime-UtcNow" class="headerlink" title="FDataTime::UtcNow"></a>FDataTime::UtcNow</h2><p>注意FDataTime::UtcNow在同一帧的不同时机获取的到是不一样的，因为它底层调用的是<code>GetSystemTime</code>(Windows)。</p>
<h2 id="uexp和ubulk的作用"><a href="#uexp和ubulk的作用" class="headerlink" title="uexp和ubulk的作用"></a>uexp和ubulk的作用</h2><blockquote>
<p>Rather than one large asset, these allow us to write an asset’s bulk data (.ubulk) and exports (uexp) out into separate files. This system improves perf in certain circumstances where file read contiguity is lost due to the large size of assets. This feature avoids this by enabling the reader to skip over an asset’s bulk data when seeking to the next file in a series without having to actually have serialized and seeked past that data (since it’s in separate file).</p>
</blockquote>
<p>为了优化性能把资源的信息和数据进行拆分，在进行资源信息的索引时不用访问真正的数据，提高了查找性能和内存消耗。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/587400/what-are-uexp-and-ubulk-files.html">what are uexp and ubulk files?</a></li>
</ul>
<h2 id="资源调试命令"><a href="#资源调试命令" class="headerlink" title="资源调试命令"></a>资源调试命令</h2><p>可以在Console中使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj list</span><br></pre></td></tr></table></figure>
<p>会列出当前的资源加载信息：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">                          Class    Count      NumKB      MaxKB   ResExcKB  ResExcDedSysKB  ResExcShrSysKB  ResExcDedVidKB  ResExcShrVidKB     ResExcUnkKB</span><br><span class="line">                          Class     4331   10240.85   12969.37       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                       FontFace        9    9498.02    9498.02    9495.54         9495.54            0.00            0.00            0.00            0.00</span><br><span class="line">                       MetaData      732    8441.93    8441.93       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                   ScriptStruct     2165    3923.20    5156.56       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                   SkeletalMesh        1    3988.86    3989.04    1974.06           30.55            0.00            0.00            0.00         1943.52</span><br><span class="line">                       Function     7928    2012.63    2457.73       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                        Package      732    1316.65    1453.87       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                           Enum     1275     312.38     760.76       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                  DeviceProfile       85     409.36     661.37       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                       Material      103     418.41     467.83    4722.42         4722.42            0.00            0.00            0.00            0.00</span><br><span class="line">                       ToolMenu       36     193.83     466.16       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">               DelegateFunction      652     165.51     185.93       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                      Texture2D      146     111.05     111.05   56192.00            0.00            0.00        56192.00            0.00            0.00</span><br><span class="line">     MaterialExpressionMultiply      194      66.84      98.67       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                     StaticMesh       29      77.02      98.41    2055.31           23.56            0.00            0.00            0.00         2031.75</span><br><span class="line">MaterialExpressionTextureSample       61      44.87      79.66       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">       MaterialExpressionCustom       68      59.53      70.68       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">        MaterialInstanceDynamic       32      53.74      65.76      16.45           16.45            0.00            0.00            0.00            0.00</span><br><span class="line">                 GameNetworkMgr        1      64.43      64.43       0.00            0.00            0.00            0.00            0.00            0.00</span><br><span class="line">                      BodySetup       41      42.91      62.30    1158.44         1158.44            0.00            0.00            0.00            0.00</span><br><span class="line">     MaterialExpressionConstant      153      36.16      61.26       0.00            0.00            0.00            0.00            0.00            0.00</span><br></pre></td></tr></table></figure>

<p>还有下列相关的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Mem FromReport</span><br><span class="line">obj list -alphasort</span><br><span class="line">rhi.DumpMemory</span><br><span class="line">LogOutStatLevels</span><br><span class="line">ListSpawnedActors</span><br><span class="line">DumpParticleMem</span><br><span class="line">ConfigMem</span><br><span class="line">r.DumpRenderTargetPoolMemory</span><br><span class="line">ListTextures -alphasort</span><br><span class="line">ListSounds -alphasort</span><br><span class="line">ListParticleSystems -alphasort</span><br><span class="line">obj list class=SoundWave -alphasort</span><br><span class="line">obj list class=SkeletalMesh -alphasort</span><br><span class="line">obj list class=StaticMesh -alphasort</span><br><span class="line">obj list class=Level -alphasort</span><br></pre></td></tr></table></figure>
<p>也可以使用<code>memreport</code>来进行详细的分析：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memreport -full</span><br></pre></td></tr></table></figure>
<p>会在<code>Saved/Profiling/MemReports</code>下创建<code>.memreport</code>文件。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.unrealengine.com/en-US/blog/debugging-and-optimizing-memory">Debugging and Optimizing Memory</a></li>
<li><a target="_blank" rel="noopener" href="https://pzurita.wordpress.com/2015/02/10/limitations-of-memory-tracking-features-in-unreal-engine-4/">Limitations of memory tracking features in Unreal Engine 4</a></li>
</ul>
<h2 id="IOS基础包拆分"><a href="#IOS基础包拆分" class="headerlink" title="IOS基础包拆分"></a>IOS基础包拆分</h2><p>在前面提到了UE为Android提供了打包到obb中的文件过滤规则：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Config/DefaultEngine.ini</span></span><br><span class="line"><span class="section">[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</span></span><br><span class="line">+ObbFilters=-pakchunk1-*</span><br></pre></td></tr></table></figure>
<p>但是UE并没有为IOS提供相应的操作，默认情况下会把IOS的所有的pak文件都打包至IPA中。</p>
<p>为了统一Android和IOS的基础包规则，我自己实现了IOS上类似Android那种指定过滤规则的功能，做个简单的介绍。</p>
<p>我使用的是Mac远程打包，流程是在Mac上编译代码生成IPA，拉回Win，在Win上进行Cook，生成Pak文件，最后把原始IPA解包，再添加Pak等文件组合成最终IPA。</p>
<p>我的需求是，自定义指定过滤规则，可以把某些文件忽略，不打包到IPA中。那么这一步的操作其实就位于把IPA解包再打包的流程里，经过翻阅UE的代码，发现这个操作是通过<code>iPhonePackager</code>这个独立程序来实现的，那么就需要对这个程序的代码进行改造了。</p>
<p>经过调试分析，发现真正实现重新打包IPA的操作是在以下函数中执行的：</p>
<figure class="highlight plain"><figcaption><span>Programs/IOS/iPhonePackager/CookTime.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** </span><br><span class="line">* Using the stub IPA previously compiled on the Mac, create a new IPA with assets</span><br><span class="line">*&#x2F;</span><br><span class="line">static public void RepackageIPAFromStub();</span><br></pre></td></tr></table></figure>
<p>该函数位于<code>iPhonePackager</code>-<code>CookTime</code>类中。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RepackageIPAFromStub</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">string</span> SourceDir = Path.GetFullPath(ZipSourceDir);</span><br><span class="line">  <span class="keyword">string</span>[] PayloadFiles = Directory.GetFiles(SourceDir, <span class="string">&quot;*.*&quot;</span>, Config.bIterate ? SearchOption.TopDirectoryOnly : SearchOption.AllDirectories);</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="keyword">string</span> Filename <span class="keyword">in</span> PayloadFiles)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="comment">// read file to memory,add to ZipFileSystem</span></span><br><span class="line">       <span class="comment">// generate stub and ipa</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要做的操作就是介入这个过程，把<code>PayloadFiles</code>中的文件列表通过我们自定义的规则来执行过滤。</p>
<p>从流程上分为以下几个步骤：</p>
<ol>
<li>从项目中读取Filter的配置</li>
<li>创建出真正的过滤器</li>
<li>在<code>RepackageIPAFromStub</code>遍历文件的流程里使用过滤器进行检测是否需要被打入ipa</li>
</ol>
<p>只需要几十行代码就可以实现，首先需要添加一个IniReader的类：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Tools.DotNETCommon;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> Ini;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Ini</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IniReader</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> path;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DllImport(<span class="meta-string">&quot;kernel32&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">GetPrivateProfileString</span>(<span class="params"><span class="keyword">string</span> section, <span class="keyword">string</span> key, <span class="keyword">string</span> def,</span></span></span><br><span class="line"><span class="function"><span class="params">      StringBuilder retVal, <span class="keyword">int</span> size, <span class="keyword">string</span> filePath</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IniReader</span>(<span class="params"><span class="keyword">string</span> INIPath</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      path = INIPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">ReadValue</span>(<span class="params"><span class="keyword">string</span> Section, <span class="keyword">string</span> Key</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">      StringBuilder ReaderBuffer = <span class="keyword">new</span> StringBuilder(<span class="number">255</span>);</span><br><span class="line">      <span class="keyword">int</span> ret = GetPrivateProfileString(Section, Key, <span class="string">&quot;&quot;</span>, ReaderBuffer, <span class="number">255</span>, <span class="keyword">this</span>.path);</span><br><span class="line">      <span class="keyword">return</span> ReaderBuffer.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在<code>RepackageIPAFromStub</code>函数中创建过滤器：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FileFilter IpaPakFileFilter = <span class="keyword">new</span> FileFilter(FileFilterType.Include);</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">string</span> ProjectDir = Directory.GetParent(Path.GetFullPath(Config.ProjectFile)).FullName;</span><br><span class="line">  <span class="comment">// Program.Log(&quot;ProjectDir path &#123;0&#125;&quot;, ProjectDir);</span></span><br><span class="line">  <span class="keyword">string</span> EngineIni = Path.Combine(ProjectDir,<span class="string">&quot;Config&quot;</span>,<span class="string">&quot;DefaultEngine.ini&quot;</span>);</span><br><span class="line">  <span class="comment">// Program.Log(&quot;EngineIni path &#123;0&#125;&quot;, EngineIni);</span></span><br><span class="line">  IniReader EngineIniReader = <span class="keyword">new</span> IniReader(EngineIni);</span><br><span class="line">  <span class="comment">// string RawPakFilterRules = EngineIniReader.ReadValue(&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;, &quot;IPAFilters&quot;);</span></span><br><span class="line">  Program.Log(<span class="string">&quot;RawPakFilterRules &#123;0&#125;&quot;</span>, RawPakFilterRules);</span><br><span class="line">  <span class="keyword">string</span>[] PakRules = RawPakFilterRules.Split(<span class="string">&#x27;,&#x27;</span>);   </span><br><span class="line">  <span class="comment">// foreach(string Rule in PakRules) &#123;Program.Log(&quot;PakRules &#123;0&#125;&quot;, Rule);&#125;</span></span><br><span class="line">  </span><br><span class="line">  List&lt;<span class="keyword">string</span>&gt; PakFilters = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;(PakRules);</span><br><span class="line">  <span class="keyword">if</span> (PakFilters != <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    IpaPakFileFilter.AddRules(PakFilters);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里从项目的<code>Config/DefaultEngine.ini</code>的[/Script/IOSRuntimeSettings.IOSRuntimeSettings]项读取<code>IPAFilters</code>的值，规则与Android相同，但是要把规则都写在一行，多个规则以逗号分隔。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/IOSRuntimeSettings.IOSRuntimeSettings]</span></span><br><span class="line"><span class="attr">IPAFilters</span>=-*.pak,pakchunk0-*</span><br></pre></td></tr></table></figure>

<p>最终，还需要在<code>RepackageIPAFromStub</code>遍历<code>Payload</code>文件的循环中进行检测是否匹配我们指定的过滤规则：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RepackageIPAFromStub</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">string</span> SourceDir = Path.GetFullPath(ZipSourceDir);</span><br><span class="line">  <span class="keyword">string</span>[] PayloadFiles = Directory.GetFiles(SourceDir, <span class="string">&quot;*.*&quot;</span>, Config.bIterate ? SearchOption.TopDirectoryOnly : SearchOption.AllDirectories);</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="keyword">string</span> Filename <span class="keyword">in</span> PayloadFiles)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!IpaPakFileFilter.Matches(Filename))</span><br><span class="line">    &#123;</span><br><span class="line">      Program.Log(<span class="string">&quot;IpaPakFileFilter not match file &#123;0&#125;&quot;</span>, Filename);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Program.Log(&quot;IpaPakFileFilter  match file &#123;0&#125;&quot;, Filename);</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样再执行打包IOS，就会按照指定的过滤规则来添加文件了，实现了与Android上一致的行为。</p>
<p>打包过程中的Log如下（上文代码已注释）：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Saving IPA ...</span><br><span class="line">ProjectDir path C:\BuildAgent\workspace\PackageWindows\Client</span><br><span class="line">EngineIni path C:\BuildAgent\workspace\PackageWindows\Client\Config\DefaultEngine.ini</span><br><span class="line">RawPakFilterRules -*.pak,pakchunk0-*</span><br><span class="line">PakRules -*.pak</span><br><span class="line">PakRules pakchunk0-*</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Assets.car</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Info.plist</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\LaunchScreenIOS.webp</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Manifest_DebugFiles_IOS.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Manifest_NonUFSFiles_IOS.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\mute.caf</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\ue4commandline.txt</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\movies\logo.mp4</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\movies\sparkmore.mp4</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk0-ios.pak</span><br><span class="line">IpaPakFileFilter not match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk1-ios.pak</span><br><span class="line">IpaPakFileFilter not match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\cookeddata\fgame\content\paks\pakchunk2-ios.pak</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\Engine\Content\SlateDebug\Fonts\LastResort.ttf</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GCloudVoice.bundle\files\config.json</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GCloudVoice.bundle\files\libwxvoiceembed.bin</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GCloudVoice.bundle\files\mute_detection.aiff</span><br><span class="line">IpaPakFileFilter match file C:\BuildAgent\workspace\PackageWindows\Client\Saved\StagedBuilds\IOS\GRobotResource.bundle\config.json</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到，过滤规则已经生效了。</p>
<h2 id="Android基础包拆分"><a href="#Android基础包拆分" class="headerlink" title="Android基础包拆分"></a>Android基础包拆分</h2><p>在打包时，不想要把所有的资源都打包到apk中，所以可以在打包时进行拆分，只把必要资源打包到apk中，首先需要把基础包中的资源进行pak拆分，可以把通过<code>Project Settings</code>-<code>Asset Manager</code>中进行设置或者通过创建<code>PrimaryAssetLable</code>资源进行标记。</p>
<p>目标是：</p>
<ol>
<li>把基础包的打包资源拆分到多个Pak中</li>
<li>只把必要的pak文件打包到apk里</li>
<li>其余的pak在运行时进行下载</li>
</ol>
<p>第一步都可以通过项目设置进行控制，第二部的条件就是要实现一个过滤规则，不过UE已经提供了这个机制，可以指定过滤掉哪些文件，只需要添加配置即可。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Config/DefaultEngine.ini</span></span><br><span class="line"><span class="section">[/Script/AndroidRuntimeSettings.AndroidRuntimeSettings]</span></span><br><span class="line">+ObbFilters=-pakchunk1-*</span><br><span class="line">+ObbFilters=-pakchunk2-*</span><br><span class="line">+ObbFilters=-pakchunk3-*</span><br></pre></td></tr></table></figure>
<p>ObbFilters的规则以<code>-</code>开头就是排除规则，会把基础包中的<code>chunk1-3</code>的pak给过滤掉，可以用于后续的下载流程。</p>
<p>也可以指定<code>Exclute</code>和<code>Include</code>规则组合来用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ObbFilters=-*.pak</span><br><span class="line">+ObbFilters=pakchunk0-*</span><br></pre></td></tr></table></figure>
<p>第一步忽略掉所有的pak文件，然后把<code>pakchunk0-*.pak</code>显式添加至obb中。</p>
<h2 id="UMG-OnTouchStarted不触发"><a href="#UMG-OnTouchStarted不触发" class="headerlink" title="UMG OnTouchStarted不触发"></a>UMG OnTouchStarted不触发</h2><p>注意不要使用UButton来作为触发控件来接收OnTouchStarted的事件，使用Board或者Image都可以，但是UButton不行，估计是UButton拦截了事件。</p>
<h2 id="监听资源操作事件"><a href="#监听资源操作事件" class="headerlink" title="监听资源操作事件"></a>监听资源操作事件</h2><p>可以通过<code>IAssetRegistry</code>获取到下列事件的delegate并监听：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DECLARE_DERIVED_EVENT( UAssetRegistryImpl, IAssetRegistry::FAssetAddedEvent, FAssetAddedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetAddedEvent&amp; <span class="title">OnAssetAdded</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetAddedEvent; &#125;</span><br><span class="line"></span><br><span class="line">DECLARE_DERIVED_EVENT( UAssetRegistryImpl, IAssetRegistry::FAssetRemovedEvent, FAssetRemovedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetRemovedEvent&amp; <span class="title">OnAssetRemoved</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetRemovedEvent; &#125;</span><br><span class="line"></span><br><span class="line">DECLARE_DERIVED_EVENT( UAssetRegistryImpl, IAssetRegistry::FAssetRenamedEvent, FAssetRenamedEvent);</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetRenamedEvent&amp; <span class="title">OnAssetRenamed</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetRenamedEvent; &#125;</span><br><span class="line"></span><br><span class="line">DECLARE_DERIVED_EVENT( UAssetRegistryImpl, IAssetRegistry::FAssetUpdatedEvent, FAssetUpdatedEvent );</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FAssetUpdatedEvent&amp; <span class="title">OnAssetUpdated</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> AssetUpdatedEvent; &#125;</span><br><span class="line"></span><br><span class="line">DECLARE_DERIVED_EVENT( UAssetRegistryImpl, IAssetRegistry::FInMemoryAssetCreatedEvent, FInMemoryAssetCreatedEvent );</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FInMemoryAssetCreatedEvent&amp; <span class="title">OnInMemoryAssetCreated</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> InMemoryAssetCreatedEvent; &#125;</span><br><span class="line"></span><br><span class="line">DECLARE_DERIVED_EVENT( UAssetRegistryImpl, IAssetRegistry::FInMemoryAssetDeletedEvent, FInMemoryAssetDeletedEvent );</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FInMemoryAssetDeletedEvent&amp; <span class="title">OnInMemoryAssetDeleted</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> InMemoryAssetDeletedEvent; &#125;</span><br><span class="line"></span><br><span class="line">DECLARE_DERIVED_EVENT( UAssetRegistryImpl, IAssetRegistry::FFilesLoadedEvent, FFilesLoadedEvent );</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FFilesLoadedEvent&amp; <span class="title">OnFilesLoaded</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> FileLoadedEvent; &#125;</span><br><span class="line"></span><br><span class="line">DECLARE_DERIVED_EVENT( UAssetRegistryImpl, IAssetRegistry::FFileLoadProgressUpdatedEvent, FFileLoadProgressUpdatedEvent );</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FFileLoadProgressUpdatedEvent&amp; <span class="title">OnFileLoadProgressUpdated</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> FileLoadProgressUpdatedEvent; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Android-not-found-uproject"><a href="#Android-not-found-uproject" class="headerlink" title="Android not found uproject"></a>Android not found uproject</h2><p>UE中有一个BUG，在4.25.1引擎版本中可以复现，步骤如下：</p>
<ol>
<li>安装apk，第一次启动游戏</li>
<li>打开UE的沙盒数据目录<code>UE4Game/PROJECTNAME</code>，在这个目录下创建<code>Content/Paks</code>目录</li>
<li>重新启动游戏</li>
</ol>
<p><img data-src="index/2020/20210121220607.webp"></p>
<p>Log中也有<code>Project file not found: ../../../FGame/FGame.uproject</code>提示。</p>
<p>在Android上自动挂载的Pak文件可以放到<code>Saved/Paks</code>下，有时间具体分析一下这个问题。</p>
<h2 id="提取chunk的paklist文件"><a href="#提取chunk的paklist文件" class="headerlink" title="提取chunk的paklist文件"></a>提取chunk的paklist文件</h2><p>在开启<code>Generate Chunks</code>之后，如果项目中有添加<code>PrimaryAssetLable</code>资源，会生成对应的Chunk文件。<br>生成的paklist文件所在目录为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 源码版</span><br><span class="line">Engine\Programs\AutomationTool\Saved\Logs</span><br><span class="line"># 安装版</span><br><span class="line">C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.26</span><br><span class="line"># 安装版 BuildCookRun</span><br><span class="line">C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.26\BuildCookRun</span><br></pre></td></tr></table></figure>
<p>paklist相关的文件列表如下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PakList_pakchunk0-WindowsNoEditor.txt</span><br><span class="line">PakList_pakchunk1-WindowsNoEditor.txt</span><br><span class="line">PakList_pakchunk2-WindowsNoEditor.txt</span><br><span class="line">PrePak_WindowsNoEditor_NonUFSFiles.txt</span><br><span class="line">PrePak_WindowsNoEditor_NonUFSFilesDebug.txt</span><br><span class="line">PrePak_WindowsNoEditor_UFSFiles.txt</span><br></pre></td></tr></table></figure>
<p>需要重点关注的是<code>PakList_pakchunk*.txt</code>和<code>PrePak*_UFSFiles.txt</code>这几个文件，<code>NonUFSFiles.txt</code>中的文件不会被打包到Pak中。<br><code>PakList_pakchunk*.txt</code>中是每一个chunk中包含的文件，并且是以<code>绝对路径 Mount路径</code>的方式来组织的，<code>PrePak*_UFSFiles.txt</code>是当前打包的版本中所有包含的文件，但其中的路径不是<code>绝对路径 Mount路径</code>。</p>
<p>在项目设置中添加的<code>NoUFS</code>文件夹都会默认打包到<code>chunk0</code>的pak中。</p>
<p>在Windows上可以使用以下命令来自动拷贝：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> f|xcopy /y/i/s/e <span class="string">&quot;%AppData%\Unreal Engine\AutomationTool\Logs\E+UnrealEngine+Launcher+UE_4.25\PakList_*.txt&quot;</span> <span class="string">&quot;E:\ClientVersion\0.0.1.0&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="IOS远程构建最大文件不能超过2G"><a href="#IOS远程构建最大文件不能超过2G" class="headerlink" title="IOS远程构建最大文件不能超过2G"></a>IOS远程构建最大文件不能超过2G</h2><p>Win上远程构建出IOS包的流程是代码和bundle都上传到Mac上编译，生成不包含资源的IPA，拉回本地执行资源Cook生成Pak后，把代码的IPA和资源的Pak合并成真正的IPA文件。<br>但是这样有个问题，UE里的实现是把所有要合并的文件读到内存中再合并打包的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RepackageIPAFromStub</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Add all of the payload files, replacing existing files in the stub IPA if necessary (should only occur for icons)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">string</span> SourceDir = Path.GetFullPath(ZipSourceDir);</span><br><span class="line">    <span class="keyword">string</span>[] PayloadFiles = Directory.GetFiles(SourceDir, <span class="string">&quot;*.*&quot;</span>, Config.bIterate ? SearchOption.TopDirectoryOnly : SearchOption.AllDirectories);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">string</span> Filename <span class="keyword">in</span> PayloadFiles)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Get the relative path to the file (this implementation only works because we know the files are all</span></span><br><span class="line">      <span class="comment">// deeper than the base dir, since they were generated from a search)</span></span><br><span class="line">      <span class="keyword">string</span> AbsoluteFilename = Path.GetFullPath(Filename);</span><br><span class="line">      <span class="keyword">string</span> RelativeFilename = AbsoluteFilename.Substring(SourceDir.Length + <span class="number">1</span>).Replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">string</span> ZipAbsolutePath = String.Format(<span class="string">&quot;Payload/&#123;0&#125;&#123;1&#125;.app/&#123;2&#125;&quot;</span>,</span><br><span class="line">        Config.GetTargetName(),</span><br><span class="line">        Program.Architecture,</span><br><span class="line">        RelativeFilename);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">byte</span>[] FileContents = File.ReadAllBytes(AbsoluteFilename);</span><br><span class="line">      <span class="keyword">if</span> (FileContents.Length == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Zero-length files added by Ionic cause installation/upgrade to fail on device with error 0xE8000050</span></span><br><span class="line">        <span class="comment">// We store a single byte in the files as a workaround for now</span></span><br><span class="line">        FileContents = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1</span>];</span><br><span class="line">        FileContents[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      FileSystem.WriteAllBytes(RelativeFilename, FileContents);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((FileContents.Length &gt;= <span class="number">1024</span> * <span class="number">1024</span>) || (Config.bVerbose))</span><br><span class="line">      &#123;</span><br><span class="line">        FilesBeingModifiedToPrintOut.Add(ZipAbsolutePath);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到是把Payload的每个文件读到<code>byte[]</code>里的，这就有了一个限制，在C#中，数组的长度最大是<code>int32.MaxValue</code>，意味着<code>byte[]</code>不能存储超过2G的文件，不然就会触发异常。<br>查询了MSDN的文档，发现设置<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/configure-apps/file-schema/runtime/gcallowverylargeobjects-element?redirectedfrom=MSDN">gcAllowVeryLargeObjects</a>也不会改变单个维度的数组的大小。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3944320/maximum-length-of-byte">Maximum length of byte[]?</a></li>
</ul>
<p>所以这个问题只能从其他方面入手了，让UE进行资源打包的时候把Pak的文件拆分，让每个文件都小于2GB即可，可以通过UE里的Chunk机制进行拆分。</p>
<h2 id="Android运行时请求权限"><a href="#Android运行时请求权限" class="headerlink" title="Android运行时请求权限"></a>Android运行时请求权限</h2><p>ActivityCompact 里面有个 requestPermission方法，可以用来处理这种情况。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/training/permissions/requesting#java">请求应用权限</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c1c03825d7a5">Android 运行时请求权限</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/permissions/overview">Android 中的权限</a></li>
</ul>
<h2 id="DS产生corefile"><a href="#DS产生corefile" class="headerlink" title="DS产生corefile"></a>DS产生corefile</h2><p>在Shipping的时候DS Crash可以通过启动参数<code>-core</code>来指定可以生成core文件。 </p>
<h2 id="指定SkeletalMesh的LOD级别"><a href="#指定SkeletalMesh的LOD级别" class="headerlink" title="指定SkeletalMesh的LOD级别"></a>指定SkeletalMesh的LOD级别</h2><p>可以直接对设置ForcedLodModel的值（LOD0需要设置1，实际的LOD级别就是N-1，值为0则是自动）： </p>
<p><img data-src="index/2020/20210115214317.webp">  </p>
<p>也可以对<code>USkinnedMeshComponent</code>实例调用<code>SetForcedLOD</code>函数：  </p>
<figure class="highlight cpp"><figcaption><span>Runtime/Engine/Classes/Components/SkinnedMeshComponent.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get ForcedLodModel of the mesh component. Note that the actual forced LOD level is the return value minus one and zero means no forced LOD </span></span><br><span class="line"><span class="function">int32 <span class="title">USkinnedMeshComponent::GetForcedLOD</span><span class="params">()</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function"><span class="comment">// Set new ForcedLODModel that forces to set the incoming LOD. Range from [1, Max Number of LOD]. This will affect in the next tick update. </span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USkinnedMeshComponent::SetForcedLOD</span><span class="params">(int32 InNewForcedLOD)</span>  </span></span><br></pre></td></tr></table></figure>

<p>可以用在背包中显示3D模型的场景，避免使用比较低的LOD级别。 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://qiita.com/7ukey/items/f0c4ef7c93ea28171174">SkeletalMeshのLODバイアスを強制する</a> </li>
</ul>
<h2 id="HotPatcher的自动化导出Release脚本"><a href="#HotPatcher的自动化导出Release脚本" class="headerlink" title="HotPatcher的自动化导出Release脚本"></a>HotPatcher的自动化导出Release脚本</h2><p>组合命令使用HotPatcher的Commandlet，实现Release信息的自动化导出：  </p>
<figure class="highlight python"><figcaption><span>HotRelease.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os </span><br><span class="line"><span class="keyword">import</span> sys  </span><br><span class="line"><span class="keyword">import</span> argparse </span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&quot;used for build engine or project&quot;</span>)  </span><br><span class="line">hot_release = parser.add_argument_group(<span class="string">&#x27;HotRelease&#x27;</span>) </span><br><span class="line"><span class="comment"># project </span></span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--enginebin&#x27;</span>,help=<span class="string">&#x27;UE4Editor-cmd.exe binary path&#x27;</span>)  </span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--projectdir&#x27;</span>,help=<span class="string">&#x27;project root directory&#x27;</span>)  </span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--projectname&#x27;</span>,help=<span class="string">&#x27;project name,match projectname.uproject&#x27;</span>)  </span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--versiondir&#x27;</span>,help=<span class="string">&#x27;client version file dir&#x27;</span>) </span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--versionid&#x27;</span>,help=<span class="string">&#x27;current release version id&#x27;</span>) </span><br><span class="line">hot_release.add_argument(<span class="string">&#x27;--outdir&#x27;</span>,help=<span class="string">&#x27;export release result save dir&#x27;</span>)  </span><br><span class="line">platform_list=[ </span><br><span class="line">    <span class="string">&quot;WindowsNoEditor&quot;</span>,  </span><br><span class="line">    <span class="string">&quot;Android_ASTC&quot;</span>, </span><br><span class="line">    <span class="string">&quot;IOS&quot;</span>,  </span><br><span class="line">] </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPlatformPakListName</span>(<span class="params">PlatformName,ProjectName</span>):</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;PakList_%s-%s.txt&quot;</span> % (ProjectName,PlatformName) </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getProjectFullPath</span>(<span class="params">ProjectDir,ProjectName</span>):</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;%s\\%s.uproject&quot;</span> % (ProjectDir,ProjectName) </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_platform_paklist</span>(<span class="params">clientversion_path,versionid,project_name</span>):</span>  </span><br><span class="line">    result_dict = &#123;&#125;  </span><br><span class="line">    <span class="keyword">if</span> os.path.exists(clientversion_path):  </span><br><span class="line">        version_paklist_path = os.path.normpath(os.path.abspath(os.path.join(clientversion_path, versionid))) </span><br><span class="line">        print(<span class="string">&quot;versionid: %s&quot;</span> % versionid)  </span><br><span class="line">        <span class="keyword">for</span> platform <span class="keyword">in</span> platform_list:  </span><br><span class="line">            platform_paklist_path = os.path.join(version_paklist_path, getPlatformPakListName(platform,project_name)) </span><br><span class="line">            <span class="keyword">if</span> os.path.exists(platform_paklist_path): </span><br><span class="line">                result_dict[platform] = platform_paklist_path </span><br><span class="line">                print(<span class="string">&quot;platform:%s paklist:%s&quot;</span> % (platform,result_dict[platform]))  </span><br><span class="line">    <span class="keyword">return</span> result_dict  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ExportRelease</span>(<span class="params">versionid,engine_bin_path,project_dir,project_name,platform_paklist_dict,savepath</span>):</span> </span><br><span class="line">    AddPlatformPakListCmd = <span class="string">&quot;-AddPlatformPakList=&quot;</span>  </span><br><span class="line">    <span class="keyword">for</span> key,value <span class="keyword">in</span> platform_paklist_dict.items(): </span><br><span class="line">        AddPlatformPakListCmd = <span class="string">&quot;%s%s+%s,&quot;</span> % (AddPlatformPakListCmd,key,value)  </span><br><span class="line">    print(AddPlatformPakListCmd)  </span><br><span class="line">    commands_tuple = [  </span><br><span class="line">        engine_bin_path,  </span><br><span class="line">        getProjectFullPath(project_dir,project_name), </span><br><span class="line">        <span class="string">&quot;-run=HotRelease&quot;</span>,  </span><br><span class="line">        <span class="string">&quot;-versionid=%s&quot;</span> % (versionid),  </span><br><span class="line">        <span class="string">&quot;-byPakList=true&quot;</span>,  </span><br><span class="line">        AddPlatformPakListCmd,  </span><br><span class="line">        <span class="string">&quot;-savepath.path=%s&quot;</span> % (savepath), </span><br><span class="line">        <span class="comment"># &quot;-wait&quot; </span></span><br><span class="line">    ] </span><br><span class="line">    final_cmd = <span class="string">&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">for</span> param <span class="keyword">in</span> commands_tuple:  </span><br><span class="line">        final_cmd = <span class="string">&quot;%s %s&quot;</span> % (final_cmd,param) </span><br><span class="line">    print(final_cmd)  </span><br><span class="line">    os.system(final_cmd)  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetArgByName</span>(<span class="params">ParserArgs,ArgName</span>):</span> </span><br><span class="line">    ArgsPairs = ParserArgs.__dict__ </span><br><span class="line">    <span class="keyword">for</span> key,value <span class="keyword">in</span> ArgsPairs.items(): </span><br><span class="line">        <span class="keyword">if</span> key == ArgName:  </span><br><span class="line">            <span class="keyword">return</span> value  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printSelectorHelp</span>():</span>  </span><br><span class="line">    print(<span class="string">&quot;Args is invalid!&quot;</span>) </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span> </span><br><span class="line">    ParserArgs = parser.parse_args()  </span><br><span class="line">    engine_bin_path = GetArgByName(ParserArgs,<span class="string">&quot;enginebin&quot;</span>)  </span><br><span class="line">    project_dir = GetArgByName(ParserArgs,<span class="string">&quot;projectdir&quot;</span>) </span><br><span class="line">    project_name = GetArgByName(ParserArgs,<span class="string">&quot;projectname&quot;</span>) </span><br><span class="line">    version_id = GetArgByName(ParserArgs,<span class="string">&quot;versionid&quot;</span>) </span><br><span class="line">    clientversion_path = GetArgByName(ParserArgs,<span class="string">&quot;versiondir&quot;</span>)  </span><br><span class="line">    outdir = GetArgByName(ParserArgs,<span class="string">&quot;outdir&quot;</span>)  </span><br><span class="line">    <span class="keyword">if</span> engine_bin_path <span class="keyword">and</span> project_dir <span class="keyword">and</span> project_name <span class="keyword">and</span> version_id <span class="keyword">and</span> clientversion_path <span class="keyword">and</span> outdir: </span><br><span class="line">        ExportRelease(  </span><br><span class="line">            version_id, </span><br><span class="line">            engine_bin_path,  </span><br><span class="line">            project_dir,  </span><br><span class="line">            project_name, </span><br><span class="line">            get_platform_paklist(clientversion_path,version_id,project_name), </span><br><span class="line">            outdir  </span><br><span class="line">            ) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        printSelectorHelp() </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:  </span><br><span class="line">   main() </span><br></pre></td></tr></table></figure>

<h2 id="Texture的压缩"><a href="#Texture的压缩" class="headerlink" title="Texture的压缩"></a>Texture的压缩</h2><p>之前的笔记中，提到过可以在<code>Project Settings</code>-<code>Cooker</code>-<code>Texture</code>-<code>ASTC Compression vs Size</code>可以设置默认的资源质量和大小的级别： </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0=12x12 </span><br><span class="line">1=10x10 </span><br><span class="line">2=8x8 </span><br><span class="line">3=6x6 </span><br><span class="line">4=4x4 </span><br></pre></td></tr></table></figure>
<p>在Texture的资源编辑中也可以针对某个Texture单独设置： </p>
<p><img data-src="index/2020/20210112154624.webp">  </p>
<p>Lowest-&gt;Hightest对应着<code>0-4</code>的值，使用Default则使用项目设置中的配置。  </p>
<p>并且，设置<code>Compression Settings</code>的类型也会对资源压缩的类型有差别，Default则是项目设置中的参数，如果设置成NormalMap的类型会是<code>ASTC_4x4</code>的。 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.nvidia.com/astc-texture-compression-for-game-assets#_Toc398571904">Using ASTC Texture Compression for Game Assets</a> </li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/RenderingAndGraphics/Textures/TextureCompressionSettings/index.html">Texture Compression Settings</a> </li>
</ul>
<h2 id="listtextures"><a href="#listtextures" class="headerlink" title="listtextures"></a>listtextures</h2><p>控制台命令<code>listtextures</code>可以列出已被加载过的Texture的信息。  </p>
<h2 id="Unreal-Insights实时分析Android"><a href="#Unreal-Insights实时分析Android" class="headerlink" title="Unreal Insights实时分析Android"></a>Unreal Insights实时分析Android</h2><p>上一节提到了使用<code>SessionFrontEnd</code>实时分析Android的方法，在实际的测试当中发现不太稳定，会造成游戏的Crash，UE在新的引擎版本中也提供了新的性能分析工具Unreal Insights，可以更方便和直观地进行Profile。  </p>
<p>同样也需要端口映射，需要把PC的1980端口映射到设备上： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb reverse tcp:1980 tcp:1980 </span><br></pre></td></tr></table></figure>
<p>然后需要给Android设备添加启动命令： </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../../FGame/FGame.uproject -Messaging -SessionOwner=&quot;lipengzha&quot; -SessionName=&quot;Launch On Android Device&quot; -iterative -tracehost=127.0.0.1 -Trace=CPU </span><br></pre></td></tr></table></figure>

<p>在PC上开启Unreal Insights，在手机上启动游戏，即可实时捕获：  </p>
<p><img data-src="index/2020/20210112171826.webp">  </p>
<p>Unreal Insights也可以实时捕获PIE的数据，需要在Editor启动时添加<code>-trace</code>参数：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor.exe PROJECT_NAME.uproject -trace=counters,cpu,frame,bookmark,gpu</span><br></pre></td></tr></table></figure>
<p>在启动游戏后在Unreal Insights里通过<code>New Connection</code>监听127.0.0.1即可。</p>
<h2 id="SessionFrontEnd实时Profile-Android"><a href="#SessionFrontEnd实时Profile-Android" class="headerlink" title="SessionFrontEnd实时Profile Android"></a>SessionFrontEnd实时Profile Android</h2><p>有几个条件：  </p>
<ol>
<li>需要USB连接PC和手机 </li>
<li>需要安装adb  </li>
</ol>
<p>首先需要映射端口，因为<code>SessionFrontEnd</code>是通过监听端口的方式来与游戏内通信的，手机和PC并不在同一个网段，所以需要以adb的形式把PC的监听端口转发给手机的端口。 </p>
<p>SessionFrontEnd的监听端口可以通过对<code>UE4Editor.exe</code>的端口分析获取：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lipengzha&gt;netstat -ano | findstr <span class="string">&quot;231096&quot;</span>  </span><br><span class="line">  TCP    0.0.0.0:1985           0.0.0.0:0              LISTENING       231096 </span><br><span class="line">  TCP    0.0.0.0:3961           0.0.0.0:0              LISTENING       231096 </span><br><span class="line">  TCP    0.0.0.0:3963           0.0.0.0:0              LISTENING       231096 </span><br><span class="line">  TCP    127.0.0.1:4014         127.0.0.1:12639        ESTABLISHED     231096 </span><br><span class="line">  TCP    127.0.0.1:4199         127.0.0.1:12639        ESTABLISHED     231096 </span><br><span class="line">  UDP    0.0.0.0:6666           *:*                                    231096 </span><br><span class="line">  UDP    0.0.0.0:24024          *:*                                    231096 </span><br><span class="line">  UDP    0.0.0.0:58101          *:*                                    231096 </span><br></pre></td></tr></table></figure>
<p>需要把PC的1985端口映射到Android的1985端口，这样手机上APP启动时，连接<code>0.0.0.0</code>的<code>1985</code>端口就可以连接到PC上的端口。 </p>
<p>通过adb命令来执行： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb reverse tcp:1985 tcp:1985 </span><br></pre></td></tr></table></figure>
<p>然后需要给手机上App指定启动参数：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../../FGame/FGame.uproject -Messaging -SessionOwner=<span class="string">&quot;lipengzha&quot;</span> -SessionName=<span class="string">&quot;Launch On Android Device&quot;</span>  </span><br></pre></td></tr></table></figure>
<p>把这些文本保存为<code>UE4Commandline.txt</code>文件，放到项目的数据目录下即可，具体路径为：  </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sdcard/UE4Game/PROJECT_NAME/ </span><br></pre></td></tr></table></figure>
<p>之后直接启动App，在PC上的<code>SessionFrontEnd</code>中就可以看到设备的数据了。 </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://medium.com/realities-io/oculus-quest-performance-tools-in-unreal-engine-2210f2581c8f">Oculus Quest Performance Tools in Unreal Engine</a> </li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/TestingAndOptimization/PerformanceAndProfiling/UnrealInsights/Overview/index.html">Unreal Insights Overview</a> </li>
</ul>
<h2 id="C-中获取引擎的版本信息"><a href="#C-中获取引擎的版本信息" class="headerlink" title="C++中获取引擎的版本信息"></a>C++中获取引擎的版本信息</h2><p>可以通过<code>FEngineVersion</code>来获取：  </p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Public/Misc/EngineVersion.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Gets the current engine version */</span>  </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> FEngineVersion&amp; <span class="title">Current</span><span class="params">()</span></span>; </span><br></pre></td></tr></table></figure>

<h2 id="判断对象是否有效的方式与区别"><a href="#判断对象是否有效的方式与区别" class="headerlink" title="判断对象是否有效的方式与区别"></a>判断对象是否有效的方式与区别</h2><p>在UE中的UObject对象实例传递和存储都是以<code>UObject*</code>的指针来存储的，因为指针只是一块内存的地址，而这块内存是否是有效的对象是不清楚的。所以需要有不同检测方式来检测，一般情况下有以下几种状态： </p>
<ol>
<li>指针为NULL/nullptr  </li>
<li>指针非NULL，对象被GC标记为PaddingKill  </li>
<li>一块无效的内存地址  </li>
</ol>
<p>如果指针地址是一个无效的内存地址，那么不能通过它来调用任何获取/修改到任何数据成员的函数的。如果对无效的内存地址调用IsPaddingKill的，会Crash，所以要从更底层的角度来检测。  </p>
<p>这三种状态可以通过以下几种检测方式来判断： </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测指针是否为Null，对象是否被注册(UClass是否存在)  </span></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* Checks to see if the object appears to be valid </span></span><br><span class="line"><span class="comment">* @return true if this appears to be a valid object </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsValidLowLevel</span><span class="params">()</span> <span class="keyword">const</span></span>; </span><br><span class="line"><span class="comment">// 从内存布局上检测对象是否有效，并会检测对象的CDO/UClass是否存在 </span></span><br><span class="line"><span class="comment">// 可以用于加载资源的检测  </span></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* Faster version of IsValidLowLevel.  </span></span><br><span class="line"><span class="comment">* Checks to see if the object appears to be valid by checking pointers and their alignment. </span></span><br><span class="line"><span class="comment">* Name and InternalIndex checks are less accurate than IsValidLowLevel. </span></span><br><span class="line"><span class="comment">* @param bRecursive true if the Class pointer should be checked with IsValidLowLevelFast  </span></span><br><span class="line"><span class="comment">* @return true if this appears to be a valid object </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsValidLowLevelFast</span><span class="params">(<span class="keyword">bool</span> bRecursive = <span class="literal">true</span>)</span> <span class="keyword">const</span></span>; </span><br><span class="line"><span class="comment">// 检测指针是否为null，以及是否被GC清理，如果指针是无效的内存地址会Crash </span></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* Test validity of object </span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* @param  Test      The object to test  </span></span><br><span class="line"><span class="comment">* @return Return true if the object is usable: non-null and not pending kill  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="function">FORCEINLINE <span class="keyword">bool</span> <span class="title">IsValid</span><span class="params">(<span class="keyword">const</span> UObject *Test)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="keyword">return</span> Test &amp;&amp; !Test-&gt;IsPendingKill();  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>


<h2 id="M1-Mac的UE4-26兼容性报告"><a href="#M1-Mac的UE4-26兼容性报告" class="headerlink" title="M1 Mac的UE4.26兼容性报告"></a>M1 Mac的UE4.26兼容性报告</h2><ul>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/development-discussion/ios-development/1844977-m1-mac-4-26-compatibility-report">M1 Mac 4.26 Compatibility Report</a> </li>
</ul>
<h2 id="UMG-CanvasPanel合批"><a href="#UMG-CanvasPanel合批" class="headerlink" title="UMG CanvasPanel合批"></a>UMG CanvasPanel合批</h2><p>在<code>Project Settings</code>-<code>Engine</code>-<code>Slate Settings</code>中开启<code>Explicit Canvas Child ZOrder</code>可以开启Canvas的合并。  </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://wangjie.rocks/2018/08/19/ue4-canvas-batch/">UE4 CanvasPanel 渲染批次合并分析优化</a>  </li>
</ul>
<h2 id="蓝图节点右上角标识的含义"><a href="#蓝图节点右上角标识的含义" class="headerlink" title="蓝图节点右上角标识的含义"></a>蓝图节点右上角标识的含义</h2><ul>
<li><a target="_blank" rel="noopener" href="https://microsoft.tistory.com/991">The Legend of the Blueprint Icons</a>  </li>
</ul>
<h2 id="OptimizeCode代码优化"><a href="#OptimizeCode代码优化" class="headerlink" title="OptimizeCode代码优化"></a>OptimizeCode代码优化</h2><blockquote>
<p>注意：如果<strong>关闭代码优化</strong>导致构造对象Crash（或者new走不到对象的构造函数），需要检查项目和插件的代码中是否有重名的类，会导致一些奇怪的问题。<br>在build.cs中可以通过<code>OptimizeCode</code>来控制是否执行代码优化：  </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OptimizeCode = CodeOptimization.InShippingBuildsOnly; </span><br></pre></td></tr></table></figure>
<p>有以下几个可选值： </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> CodeOptimization  </span><br><span class="line">&#123; </span><br><span class="line">  Never,  </span><br><span class="line">  InNonDebugBuilds, </span><br><span class="line">  InShippingBuildsOnly, </span><br><span class="line">  Always, </span><br><span class="line">  Default,  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>当开启优化时，对翻译单元的编译指令参数：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/Ox </span><br><span class="line">/Ot </span><br><span class="line">/GF </span><br><span class="line">/Zo </span><br></pre></td></tr></table></figure>
<p>并且会使用优化版本的<code>Engine/SharedPCH.Engine.h</code>。  </p>
<p>当关闭优化时的编译指令为： </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Od </span><br></pre></td></tr></table></figure>
<p>会使用非优化版本的<code>Engine/SharedPCH.Engine.NonOptimized.h</code>.  </p>
<h2 id="ASTC-Compression-Quality-By-Size"><a href="#ASTC-Compression-Quality-By-Size" class="headerlink" title="ASTC Compression Quality By Size"></a>ASTC Compression Quality By Size</h2><p>在项目的DefaultEngine.ini中的<code>[/Script/UnrealEd.CookerSettings]</code>中通过<code>DefaultASTCQualityBySize</code>设置（0-4）： </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/UnrealEd.CookerSettings]</span> </span><br><span class="line"><span class="attr">DefaultASTCQualityBySize</span>=<span class="number">2</span>  </span><br><span class="line"><span class="attr">DefaultASTCQualityBySpeed</span>=<span class="number">3</span> </span><br></pre></td></tr></table></figure>
<p>0-4分别对应以下压缩级别：  </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0=12x12 </span><br><span class="line">1=10x10 </span><br><span class="line">2=8x8 </span><br><span class="line">3=6x6 </span><br><span class="line">4=4x4 </span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/development-discussion/vr-ar-development/91476-custom-astc-compression-format">Custom ASTC compression format</a> </li>
<li><a target="_blank" rel="noopener" href="https://developer.nvidia.com/astc-texture-compression-for-game-assets">Using ASTC Texture Compression for Game Assets</a> </li>
</ul>
<h2 id="引擎修改语言的配置存储"><a href="#引擎修改语言的配置存储" class="headerlink" title="引擎修改语言的配置存储"></a>引擎修改语言的配置存储</h2><p>在UE引擎中的的<strong>编辑器偏好设置</strong>中修改<strong>区域和语言</strong>，会被存储在以下文件中： </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\lipengzha\AppData\Local\UnrealEngine\4.25\Saved\Config\Windows\EditorSettings.ini  </span><br></pre></td></tr></table></figure>
<p>其值如下： </p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Internationalization]</span>  </span><br><span class="line"><span class="attr">Language</span>=zh-Hans  </span><br><span class="line">Culture=  </span><br><span class="line"><span class="attr">Locale</span>=zh-Hans  </span><br></pre></td></tr></table></figure>
<p>如果是英文的，则是<code>en</code>.  </p>
<h2 id="中文赋值给FString"><a href="#中文赋值给FString" class="headerlink" title="中文赋值给FString"></a>中文赋值给FString</h2><p>首先，把文件编码修改为UTF8，然后使用以下方式： </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FString str = UTF8_TO_TCHAR(<span class="string">&quot;中文&quot;</span>);  </span><br></pre></td></tr></table></figure>
<p>注意对UTF8编码的中文不要使用TEXT，因为文件编码UTF8已经是把中文字符串编码成了UTF8的方式，所以可以直接使用<code>&quot;&quot;</code>来包裹中文字符，如果此时使用<code>TEXT</code>作为宽字符存储UTF8的编码，在<code>UTF8_TO_TCHAR</code>中会出现错误。  </p>
<h2 id="IOS相对到绝对路径转换"><a href="#IOS相对到绝对路径转换" class="headerlink" title="IOS相对到绝对路径转换"></a>IOS相对到绝对路径转换</h2><p>在接入的一些库中，需要传递文件的绝对路径，可以通过下面的方式进行转换： </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IFileManager::Get().ConvertToAbsolutePathForExternalAppForRead(*InRelatePath);; </span><br></pre></td></tr></table></figure>
<p>它是定义在<code>IFileManager</code>接口中的一个虚函数，应该在各个平台的PlatformFile中均有自己的实现，但是在Android中依然是相对路径的，不知道UE是不是忘了实现了。  </p>
<p>IOS：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/df84cb430f38ad08ad831f31267d8702b2fefc3e/Engine/Source/Runtime/Core/Public/IOS/IOSPlatformFile.h#L38">Runtime/Core/Public/IOS/IOSPlatformFile.h</a>  </p>
<p>Android上相对路径转换成绝对路径的方式在之前的笔记中有写。</p>
<h2 id="Android获取包名"><a href="#Android获取包名" class="headerlink" title="Android获取包名"></a>Android获取包名</h2><p>通过UPL在Java里添加以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">AndroidThunkJava_GetPackageName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Context context = getApplicationContext();</span><br><span class="line">  <span class="keyword">return</span> context.getPackageName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在C++里通过JNI调用即可：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FString <span class="title">UFlibAppHelper::GetAppPackageName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString result;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_ANDROID</span></span><br><span class="line">    <span class="keyword">if</span> (JNIEnv* Env = FAndroidApplication::GetJavaEnv())</span><br><span class="line">    &#123;</span><br><span class="line">        jmethodID GetInstalledPakPathMethodID = FJavaWrapper::FindMethod(Env, FJavaWrapper::GameActivityClassID, <span class="string">&quot;AndroidThunkJava_GetPackageName&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        result = FJavaHelper::FStringFromLocalRef(Env, (jstring)FJavaWrapper::CallObjectMethod(Env, FJavaWrapper::GameActivityThis,GetInstalledPakPathMethodID));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> result; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Android获取外部存储路径"><a href="#Android获取外部存储路径" class="headerlink" title="Android获取外部存储路径"></a>Android获取外部存储路径</h2><p>获取App的沙盒路径：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /storage/emulated/0/Android/data/com.xxxx.yyyy.zzzz/files</span></span><br><span class="line"><span class="function">FString <span class="title">FAndroidGCloudPlatformMisc::getExternalStorageDirectory</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString result;</span><br><span class="line">    <span class="keyword">if</span> (JNIEnv* Env = FAndroidApplication::GetJavaEnv())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// get context</span></span><br><span class="line">        jobject JniEnvContext;</span><br><span class="line">        &#123;</span><br><span class="line">            jclass activityThreadClass = Env-&gt;FindClass(<span class="string">&quot;android/app/ActivityThread&quot;</span>);</span><br><span class="line">            jmethodID currentActivityThread = FJavaWrapper::FindStaticMethod(Env, activityThreadClass, <span class="string">&quot;currentActivityThread&quot;</span>, <span class="string">&quot;()Landroid/app/ActivityThread;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            jobject at = Env-&gt;CallStaticObjectMethod(activityThreadClass, currentActivityThread);</span><br><span class="line">            jmethodID getApplication = FJavaWrapper::FindMethod(Env, activityThreadClass, <span class="string">&quot;getApplication&quot;</span>, <span class="string">&quot;()Landroid/app/Application;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            JniEnvContext = FJavaWrapper::CallObjectMethod(Env, at, getApplication);</span><br><span class="line">        &#125;</span><br><span class="line">        jmethodID getExternalFilesDir = Env-&gt;GetMethodID(Env-&gt;GetObjectClass(JniEnvContext), <span class="string">&quot;getExternalFilesDir&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)Ljava/io/File;&quot;</span>);</span><br><span class="line">        <span class="comment">// get File</span></span><br><span class="line">        jobject ExternalFileDir = Env-&gt;CallObjectMethod(JniEnvContext, getExternalFilesDir,<span class="literal">nullptr</span>);</span><br><span class="line">        <span class="comment">// getPath method in File class</span></span><br><span class="line">        jmethodID getFilePath = Env-&gt;GetMethodID(Env-&gt;FindClass(<span class="string">&quot;java/io/File&quot;</span>), <span class="string">&quot;getPath&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">        jstring pathString = (jstring)Env-&gt;CallObjectMethod(ExternalFileDir, getFilePath, <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *nativePathString = Env-&gt;GetStringUTFChars(pathString, <span class="number">0</span>);</span><br><span class="line">        result = ANSI_TO_TCHAR(nativePathString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Android相对路径转绝对路径"><a href="#Android相对路径转绝对路径" class="headerlink" title="Android相对路径转绝对路径"></a>Android相对路径转绝对路径</h2><p>有些需求需要把<code>FPaths::ProjectDir()</code>等路径转换为移动设备上的绝对路径，可以参考<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/2bf1a5b83a7076a0fd275887b373f8ec9e99d431/Engine/Source/Runtime/Core/Private/Android/AndroidPlatformFile.cpp#L126">Core/Private/Android/AndroidPlatformFile.cpp#L126</a>中的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Constructs the base path for any files which are not in OBB/pak data</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> FString &amp;<span class="title">GetFileBasePath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> FString BasePath = GFilePathBase + FString(FILEBASE_DIRECTORY) + FApp::GetProjectName() + FString(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> BasePath;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">AndroidRelativeToAbsolutePath</span><span class="params">(<span class="keyword">bool</span> bUseInternalBasePath, FString RelPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (RelPath.StartsWith(TEXT(<span class="string">&quot;../&quot;</span>), ESearchCase::CaseSensitive))</span><br><span class="line">  &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      RelPath.RightChopInline(<span class="number">3</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (RelPath.StartsWith(TEXT(<span class="string">&quot;../&quot;</span>), ESearchCase::CaseSensitive));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (bUseInternalBasePath ? GInternalFilePath : GetFileBasePath()) / RelPath;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> RelPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="删除AndroidManifest-xml中的项"><a href="#删除AndroidManifest-xml中的项" class="headerlink" title="删除AndroidManifest.xml中的项"></a>删除AndroidManifest.xml中的项</h2><p>因为UE默认会给<code>AndroidManifest.xml</code>添加项，如果其中的项我们想要手动控制，直接添加的话会产生错误，提示已经存在：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">UATHelper: Packaging (Android (ASTC)):   &gt; Task :app:processDebugManifest FAILED</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   </span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   Z:\app\src\main\AndroidManifest.xml:<span class="number">47</span>:<span class="number">5</span><span class="number">-106</span> Error:</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):     Element meta-data<span class="meta">#com.epicgames.ue4.GameActivity.bUseExternalFilesDir at AndroidManifest.xml:47:5-106 duplicated with element declared at AndroidManifest.xml:27:5-107</span></span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   Z:\app\src\main\AndroidManifest.xml Error:</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):     Validation failed, exiting</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   </span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   FAILURE: Build failed with an exception.</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   </span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   * What went wrong:</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   Execution failed for task &#x27;:app:processDebugManifest&#x27;.</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   &gt; Manifest merger failed with multiple errors, see logs</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   </span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   See http:<span class="comment">//g.co/androidstudio/manifest-merger for more information about the manifest merger.</span></span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   </span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   * Try:</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   Run with --stacktrace option to get the <span class="built_in">stack</span> trace. Run with --info <span class="keyword">or</span> --debug option to get more <span class="built_in">log</span> output. Run with --scan to get full insights.</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   </span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   * Get more help at https:<span class="comment">//help.gradle.org</span></span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   </span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   BUILD FAILED in <span class="number">10</span>s</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   <span class="number">189</span> actionable tasks: <span class="number">1</span> executed, <span class="number">188</span> up-to-date</span><br><span class="line">UATHelper: Packaging (Android (ASTC)):   ERROR: cmd.exe failed with args /c <span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\GCloudExample\Intermediate\Android\armv7\gradle\rungradle.bat&quot;</span> :app:assembleDebug</span><br><span class="line">PackagingResults: Error: cmd.exe failed with args /c <span class="string">&quot;C:\Users\lipengzha\Documents\Unreal Projects\GCloudExample\Intermediate\Android\armv7\gradle\rungradle.bat&quot;</span> :app:assembleDebug</span><br><span class="line">UATHelper: Packaging (Android (ASTC)): Took <span class="number">13.3060694</span>s to run UnrealBuildTool.exe, ExitCode=<span class="number">6</span></span><br><span class="line">UATHelper: Packaging (Android (ASTC)): UnrealBuildTool failed. See <span class="built_in">log</span> <span class="keyword">for</span> more details. (C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4<span class="number">.25</span>\UBT-.txt)</span><br><span class="line">UATHelper: Packaging (Android (ASTC)): AutomationTool exiting with ExitCode=<span class="number">6</span> (<span class="number">6</span>)</span><br><span class="line">UATHelper: Packaging (Android (ASTC)): BUILD FAILED</span><br><span class="line">PackagingResults: Error: Unknown Error</span><br></pre></td></tr></table></figure>

<p>如果想要修改或者删除UE默认生成的<code>AndroidManifest.xml</code>中的项，可以通过先删除再添加的方式。</p>
<p>以删除以下项为例:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta-data android:name=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span> android:value=<span class="string">&quot;false&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>在UPL的<code>androidManifestUpdates</code>中编写以下代码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">androidManifestUpdates</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">loopElements</span> <span class="attr">tag</span>=<span class="string">&quot;meta-data&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setStringFromAttribute</span> <span class="attr">result</span>=<span class="string">&quot;ApplicationSectionName&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span> <span class="attr">name</span>=<span class="string">&quot;android:name&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setBoolIsEqual</span> <span class="attr">result</span>=<span class="string">&quot;bUseExternalFilesDir&quot;</span> <span class="attr">arg1</span>=<span class="string">&quot;$S(ApplicationSectionName)&quot;</span> <span class="attr">arg2</span>=<span class="string">&quot;com.epicgames.ue4.GameActivity.bUseExternalFilesDir&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">condition</span>=<span class="string">&quot;bUseExternalFilesDir&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">true</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">removeElement</span> <span class="attr">tag</span>=<span class="string">&quot;$&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">true</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">loopElements</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidManifestUpdates</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>就是去遍历<code>AndroidManfest.xml</code>中已经存在<code>meta-data</code>中，<code>android:name</code>为<code>com.epicgames.ue4.GameActivity.bUseExternalFilesDir</code>的项给删除。</p>
<h2 id="强引用UClass"><a href="#强引用UClass" class="headerlink" title="强引用UClass"></a>强引用UClass</h2><p>如果在UPROPERTY中通过<code>TSubclassOf</code>引用了一个UClass，会导致该UClass的BP的CDO无法被释放：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">URPOPERTY()</span><br><span class="line">TSubclassOf&lt;<span class="class"><span class="keyword">class</span> <span class="title">UClassName</span>&gt; <span class="title">StrongClassRef</span>;</span></span><br></pre></td></tr></table></figure>
<p>可以使用软引用的方式来解决：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">URPOPERTY()</span><br><span class="line">TSoftClassPtr&lt;<span class="class"><span class="keyword">class</span> <span class="title">UClassName</span>&gt; <span class="title">StrongClassRef</span>;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>TSoftClassPtr is a templatized wrapper around FSoftObjectPtr that works like a TSubclassOf, it can be used in UProperties for blueprint subclasses</p>
</blockquote>
<h2 id="UE4编译代码的真正命令参数"><a href="#UE4编译代码的真正命令参数" class="headerlink" title="UE4编译代码的真正命令参数"></a>UE4编译代码的真正命令参数</h2><p>在之前的文章<a href="https://imzlp.com/posts/6362/">Build flow of the Unreal Engine4 project</a>中有提到，UE编译模块的时候会执行到<code>ExecuteActions</code>中。<br>那么UE真正编译每个翻译单元的编译器参数是什么呢？<br>在UBT调用ExecuteAction之前，会完成所有编译参数的拼接和预处理。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ExecuteAction</span><span class="params">(ManagedProcessGroup ProcessGroup, BuildAction Action, List CompletedActions, AutoResetEvent CompletedEvent)</span></span></span><br></pre></td></tr></table></figure>
<p>在Win上是通过调用<code>cl-filter.exe</code>来执行的，而如何把代码和编译参数喂给编译器呢？<br>UE是通过生成了一个<code>.cpp.obj.response</code>来记录当前编译单元的信息的，包含编译器参数和包含目录/输出等等。</p>
<p><img data-src="index/2020/20201217202145.webp"></p>
<p>该文件在生成位置在模块的Intermediate目录下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intermediate\Build\Win64\UE4Editor\Development\HotPatcherRuntime\FlibPakReader.cpp.obj.response</span><br></pre></td></tr></table></figure>
<p>文件内容太长，可以下载该文件查看：<a href="https://imzlp.com/notes/UE4/ubt/FlibPakReader.cpp.obj.response">FlibPakReader.cpp.obj.response</a></p>
<p>可以使用手动调用<code>cl.exe</code>的方式来执行测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cl.exe @CPP_OBJ_RESPONSE_PATH //showIncludes</span><br><span class="line">// <span class="string">&quot;C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional\VC\Tools\MSVC\14.27.29110\bin\HostX64\x64\cl.exe&quot;</span>  @<span class="string">&quot;C:\BuildAgent\workspace\PackageWindows\Client\Plugins\UnLua\Intermediate\Build\Win64\UE4\Development\LuaProtobuf\Module.LuaProtobuf.cpp.obj.response&quot;</span> /showIncludes</span><br></pre></td></tr></table></figure>
<p><img data-src="index/2020/16082078824716.webp"></p>
<h2 id="build-cs添加宏定义的值"><a href="#build-cs添加宏定义的值" class="headerlink" title="build.cs添加宏定义的值"></a>build.cs添加宏定义的值</h2><p>在UE中使用<code>build.cs</code>添加宏定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PrivateDefinitions.Add(<span class="string">&quot;TEST_MACRO_HAS_VALUE=1&quot;</span>);</span><br><span class="line">PublicDefinitions.Add(<span class="string">&quot;TEST_MACRO_NOT_VALUE&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>可以指定值，也可以不指定宏的值，但是UE生成时会给没有值的宏为<code>1</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEST_MACRO_NOT_VALUE 1</span></span><br></pre></td></tr></table></figure>
<p>可以在UE生成的<code>Deginitions.MODULENAME.h</code>中查看，位于以下位置：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intermediate\Build\PLATFIRM_NAME\UE4\Development\MODULE_NAME\Definitions.MODULE_NAME.h</span><br></pre></td></tr></table></figure>

<h2 id="编译引擎的命令"><a href="#编译引擎的命令" class="headerlink" title="编译引擎的命令"></a>编译引擎的命令</h2><p>与BuildGraph的方式不同，直接在VS中点UE4编译所使用的命令行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine/Build/BatchFiles/Build.bat -Target=<span class="string">&quot;UE4Editor Win64 Development&quot;</span> -Target=<span class="string">&quot;ShaderCompileWorker Win64 Development -Quiet&quot;</span> -WaitMutex -FromMsBuild</span><br></pre></td></tr></table></figure>

<h2 id="编辑器检测Actor移动"><a href="#编辑器检测Actor移动" class="headerlink" title="编辑器检测Actor移动"></a>编辑器检测Actor移动</h2><p>可以通过重写<code>Editor</code>中的<code>PostEditMove</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PostEditMove</span><span class="params">(<span class="keyword">bool</span> bFinished)</span> <span class="keyword">override</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/API/Runtime/Engine/GameFramework/AActor/PostEditMove/index.html">AActor::PostEditMove</a></li>
</ul>
<h2 id="Actor-Tick-in-Editor"><a href="#Actor-Tick-in-Editor" class="headerlink" title="Actor Tick in Editor"></a>Actor Tick in Editor</h2><p>在Actor的构造函数中开启Tick：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PrimaryActorTick.bCanEverTick = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>但是这个只能设置Runtime的Actor的Tick，当想要让Editor下的Actor也能执行Tick，则需要重写Actor的<code>ShouldTickIfViewportsOnly</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">ShouldTickIfViewportsOnly</span><span class="params">()</span><span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// .cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ARecastDetourTestingActor::ShouldTickIfViewportsOnly</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>AActor</code>的类中，默认返回false.</p>
<h2 id="UE4-ERROR-Missing-object-file"><a href="#UE4-ERROR-Missing-object-file" class="headerlink" title="UE4 ERROR: Missing object file"></a>UE4 ERROR: Missing object file</h2><p>在编译时遇到以下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Missing object file C:\BuildAgent\workspace\PackageWindows\InstalledEngine\Engine\Engine\Plugins\Runtime\Database\SQLiteCore\Intermediate\Build\Android\UE4\Developmen</span><br><span class="line">t\SQLiteCore\codec.ca7.o listed in C:\BuildAgent\workspace\PackageWindows\InstalledEngine\Engine\Engine\Plugins\Runtime\Database\SQLiteCore\Intermediate\Build\Android\UE4\Develo</span><br><span class="line">pment\SQLiteCore\SQLiteCore.precompiled</span><br></pre></td></tr></table></figure>
<p>在引擎中添加了代码，并且编译了Android的的平台支持（通过<code>Make Installed Win64</code>），但是在编译IOS时出现这样的报错。<br>经过排查发现，这个错误时找不到<code>codec.ca7.o</code>文件导致的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> List&lt;FileItem&gt; <span class="title">Compile</span>(<span class="params">ReadOnlyTargetRules Target, UEToolChain ToolChain, CppCompileEnvironment BinaryCompileEnvironment, FileReference SingleFileToCompile, ISourceFileWorkingSet WorkingSet, IActionGraphBuilder Graph</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//UEBuildPlatform BuildPlatform = UEBuildPlatform.GetBuildPlatform(BinaryCompileEnvironment.Platform);</span></span><br><span class="line"></span><br><span class="line">  List&lt;FileItem&gt; LinkInputFiles = <span class="keyword">base</span>.Compile(Target, ToolChain, BinaryCompileEnvironment, SingleFileToCompile, WorkingSet, Graph);</span><br><span class="line"></span><br><span class="line">  CppCompileEnvironment ModuleCompileEnvironment = CreateModuleCompileEnvironment(Target, BinaryCompileEnvironment);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the module is precompiled, read the object files from the manifest</span></span><br><span class="line">  <span class="keyword">if</span>(Rules.bUsePrecompiled &amp;&amp; Target.LinkType == TargetLinkType.Monolithic)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(!FileReference.Exists(PrecompiledManifestLocation))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Missing precompiled manifest for &#x27;&#123;0&#125;&#x27;. This module was most likely not flagged for being included in a precompiled build - set &#x27;PrecompileForTargets = PrecompileTargetsType.Any;&#x27; in &#123;0&#125;.build.cs to override.&quot;</span>, Name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PrecompiledManifest Manifest = PrecompiledManifest.Read(PrecompiledManifestLocation);</span><br><span class="line">    <span class="keyword">foreach</span>(FileReference OutputFile <span class="keyword">in</span> Manifest.OutputFiles)</span><br><span class="line">    &#123;</span><br><span class="line">      FileItem ObjectFile = FileItem.GetItemByFileReference(OutputFile);</span><br><span class="line">      <span class="keyword">if</span>(!ObjectFile.Exists)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Missing object file &#123;0&#125; listed in &#123;1&#125;&quot;</span>, OutputFile, PrecompiledManifestLocation);</span><br><span class="line">      &#125;</span><br><span class="line">      LinkInputFiles.Add(ObjectFile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> LinkInputFiles;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>去插件的<code>Intermediate</code>中查看了一下，确实没有这个文件，估计是拷贝造成的问题。</p>
<h2 id="分隔String为数组"><a href="#分隔String为数组" class="headerlink" title="分隔String为数组"></a>分隔String为数组</h2><p>可以使用FString的<code>ParserIntoArray</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TArray&lt;FString&gt; BreakedPoints;</span><br><span class="line">UFlibAppHelper::GetSourceVersion().ParseIntoArray(BreakedPoints,TEXT(<span class="string">&quot;.&quot;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="UE4-25中ShaderPatch问题"><a href="#UE4-25中ShaderPatch问题" class="headerlink" title="UE4.25中ShaderPatch问题"></a>UE4.25中ShaderPatch问题</h2><p>在4.25引擎版本中调用<code>FShaderCodeLibrary::CreatePatchLibrary</code>来创建ShaderCode Patch会触发check抛异常：<br><img data-src="index/2020/20201211125932.webp"></p>
<p>这是因为<code>FEditorShaderCodeArchive</code>的构造函数中调用了ShaderHashTable的Initialize，并给了默认值<code>0x1000</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FEditorShaderCodeArchive(FName InFormat)</span><br><span class="line">    : FormatName(InFormat)</span><br><span class="line">    , Format(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Format = GetTargetPlatformManagerRef().FindShaderFormat(InFormat);</span><br><span class="line">  check(Format);</span><br><span class="line"></span><br><span class="line">  SerializedShaders.ShaderHashTable.Initialize(<span class="number">0x10000</span>);</span><br><span class="line">  SerializedShaders.ShaderMapHashTable.Initialize(<span class="number">0x10000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="index/2020/20201211125525.webp"></p>
<p>导致在后续的流程中(<code>FSerializedShaderArchive::Serialize</code>)调用<code>Initialize</code>的时候check失败了(因为HaseSize已经有值了，并不是0，对其再调用Initialize就触发了check)：<br><img data-src="index/2020/20201211130200.webp"></p>
<p>查了下<code>FEditorShaderCodeArchive</code>构造函数中调用<code>Initialize</code>的代码是在4.25之后的引擎版本才有的，所以影响到的之后4.25+的版本。<br>代码对比：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.24.3-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L922">4.24.3-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L922</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.25.0-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L801">4.25.0-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L801</a></li>
</ul>
<p>解决方案：把<code>FSerializedShaderArchive::Serialize</code>中<code>ShaderMapHashTable</code>的<code>Initialize</code>和<code>ShaderHashTable</code>的<code>Initialize</code>在Editor下注释掉，因为<code>FEditorShaderCodeArchive</code>的代码只在Editor下有效，并且是只在生成ShaderPatch时有用。</p>
<p>这就造成了以下几个问题：</p>
<ol>
<li><code>FEditorShaderCodeArchive</code>的构造只有Eidotor并且ShaderPatch是才有用，也就意味着这里写的<code>ShaderMapHashTable</code>的<code>Initialize</code>和<code>ShaderHashTable</code>的<code>Initialize</code>只有在创建ShaderPatch时才会执行</li>
<li>在打基础包时执行Cook会编译shader，但是不会执行FEditorShaderCodeArchive的构造，<code>ShaderMapHashTable</code>的<code>Initialize</code>和<code>ShaderHashTable</code>的<code>Initialize</code>也就不会执行，就需要在使用的地方来调用它们的初始化</li>
</ol>
<p>这也是UE中没有管理好这两个状态的地方：在<code>FEditorShaderCodeArchive</code>和<code>FSerializedShaderArchive::Serialize</code>中都做了Initialize的操作，在打基础包时造成了<code>ShaderMapHashTable</code>和<code>ShaderHashTable</code>的<code>Initialize</code>已经被<code>FEditorShaderCodeArchive</code>初始化的情况下又被<code>FSerializedShaderArchive::Serialize</code>执行了一遍，导致Crash，但是我们又不能粗暴地把任何一处的初始化操作去掉，只能通过检测<code>ShaderMapHashTable</code>和<code>ShaderHashTable</code>的<code>Initialize</code>是否已经被执行，来选择性的跳过。</p>
<p>阅读代码可以知道<code>ShaderMapHashTable</code>和<code>ShaderHashTable</code>的<code>Initialize</code>只应该执行一次，并且初始化之后HashSize和IndexSize应该具有非0值：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Public/Containers/HashTable.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">FHashTable::Initialize</span><span class="params">(uint32 InHashSize, uint32 InIndexSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  check(HashSize == <span class="number">0u</span>);</span><br><span class="line">  check(IndexSize == <span class="number">0u</span>);</span><br><span class="line"></span><br><span class="line">  HashSize = InHashSize;</span><br><span class="line">  IndexSize = InIndexSize;</span><br><span class="line"></span><br><span class="line">  check(HashSize &lt;= <span class="number">0x10000</span>);</span><br><span class="line">  check(FMath::IsPowerOfTwo(HashSize));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (IndexSize)</span><br><span class="line">  &#123;</span><br><span class="line">    HashMask = (uint16)(HashSize - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    Hash = <span class="keyword">new</span> uint32[HashSize];</span><br><span class="line">    NextIndex = <span class="keyword">new</span> uint32[IndexSize];</span><br><span class="line"></span><br><span class="line">    FMemory::Memset(Hash, <span class="number">0xff</span>, HashSize * <span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Initialize</code>时会检测当前的<code>HashSize</code>和<code>IndexSize</code>是否为0，并在之后进行赋值。所以，我们只要获取<code>FHashTable</code>的<code>HashSize</code>和<code>IndexSize</code>检测它们是否为0即可判断当前的<code>HashTable</code>对象是否已经被<code>Initialize</code>过，但是，UE里的<code>FHashTable</code>里这两个成员都是<code>protected</code>的，只能修改引擎来实现了：</p>
<p>添加获取<code>FHashTable</code>的<code>HashSize</code>和<code>IndexSize</code>属性的成员函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FHashTable</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function">FORCEINLINE uint32 <span class="title">GetHashSize</span><span class="params">()</span><span class="keyword">const</span></span>&#123;<span class="keyword">return</span> HashSize;&#125;;</span><br><span class="line">  <span class="function">FORCEINLINE uint32 <span class="title">GetIndexSize</span><span class="params">()</span><span class="keyword">const</span></span>&#123;<span class="keyword">return</span> IndexSize;&#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后在<code>FSerializedShaderArchive::Serialize</code>进行检测，如果已被初始化则跳过<code>Initialize</code>逻辑：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RenderCore/Private/ShaderCodeArchive.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FSerializedShaderArchive::Serialize</span><span class="params">(FArchive&amp; Ar)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Ar &lt;&lt; ShaderMapHashes;</span><br><span class="line">  Ar &lt;&lt; ShaderHashes;</span><br><span class="line">  Ar &lt;&lt; ShaderMapEntries;</span><br><span class="line">  Ar &lt;&lt; ShaderEntries;</span><br><span class="line">  Ar &lt;&lt; PreloadEntries;</span><br><span class="line">  Ar &lt;&lt; ShaderIndices;</span><br><span class="line"></span><br><span class="line">  check(ShaderHashes.Num() == ShaderEntries.Num());</span><br><span class="line">  check(ShaderMapHashes.Num() == ShaderMapEntries.Num());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Ar.IsLoading())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">    <span class="keyword">auto</span> ShaderHashInitialized = [](<span class="keyword">const</span> FHashTable&amp; HashTable)-&gt;<span class="keyword">bool</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> HashTable.GetHashSize() || HashTable.GetIndexSize();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> uint32 HashSize = FMath::Min&lt;uint32&gt;(<span class="number">0x10000</span>, <span class="number">1u</span> &lt;&lt; FMath::CeilLogTwo(ShaderMapHashes.Num()));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      <span class="keyword">if</span>(!ShaderHashInitialized(ShaderMapHashTable))</span><br><span class="line">      &#123;</span><br><span class="line">        ShaderMapHashTable.Initialize(HashSize, ShaderMapHashes.Num());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; ShaderMapHashes.Num(); ++Index)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> uint32 Key = GetTypeHash(ShaderMapHashes[Index]);</span><br><span class="line">        ShaderMapHashTable.Add(Key, Index);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> uint32 HashSize = FMath::Min&lt;uint32&gt;(<span class="number">0x10000</span>, <span class="number">1u</span> &lt;&lt; FMath::CeilLogTwo(ShaderHashes.Num()));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      <span class="keyword">if</span>(!ShaderHashInitialized(ShaderHashTable))</span><br><span class="line">      &#123;</span><br><span class="line">        ShaderHashTable.Initialize(HashSize, ShaderHashes.Num());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; ShaderHashes.Num(); ++Index)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">const</span> uint32 Key = GetTypeHash(ShaderHashes[Index]);</span><br><span class="line">        ShaderHashTable.Add(Key, Index);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样可以统一ShaderPatch和Runtime的HashTable的Initialize流程。</p>
<p>而且，需要注意的是：生成出来的ShaderPatch的<code>ushaderbytecode</code>文件是与基础包内的文件名一致的，所以不能使用引擎启动时的默认挂载（会导致基础包内的ushaderbytecode文件无法被加载，从而crash）。</p>
<p><img data-src="index/UE4/auto-mount-shaderpatch-crash.webp"></p>
<p>应该在挂载之后自己处理ShaderPatch的ushaderbytecode文件的加载，使用以下函数加载：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UFlibPatchParserHelper::LoadShaderbytecode</span><span class="params">(<span class="keyword">const</span> FString&amp; LibraryName, <span class="keyword">const</span> FString&amp; LibraryDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> FShaderCodeLibrary::OpenLibrary(LibraryName, LibraryDir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：ShaderPatch的更新不直接支持Patch的迭代，如：1.0 Metadata + 1.1的ShaderPatch，并不能生成1.2的ShaderPatch，必须要基于1.1的完整Metadata才可以，即每次Patch必须要基于上一次完整的Metadate数据（Project和Global的ushaderbytecode文件），在工程管理上每次打包都需要把完整的Metadata收集起来。</p>
<h2 id="Android项目中所有的UPL"><a href="#Android项目中所有的UPL" class="headerlink" title="Android项目中所有的UPL"></a>Android项目中所有的UPL</h2><p>可以在项目路径下<code>Intermediate/Android/ActiveUPL.xml</code>，里面列出了当前项目中所有的UPL文件路径：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Plugins\Online\Android\OnlineSubsystemGooglePlay\Source\OnlineSubsystemGooglePlay_UPL.xml</span><br><span class="line">Plugins\Runtime\AndroidPermission\Source\AndroidPermission\AndroidPermission_APL.xml</span><br><span class="line">Plugins\Runtime\GoogleCloudMessaging\Source\GoogleCloudMessaging\GoogleCloudMessaging_UPL.xml</span><br><span class="line">Plugins\Runtime\GooglePAD\Source\GooglePAD\GooglePAD_APL.xml</span><br><span class="line">Plugins\Runtime\Oculus\OculusVR\Source\OculusHMD\OculusMobile_APL.xml</span><br><span class="line">Source\Runtime\Online\Voice\AndroidVoiceImpl_UPL.xml</span><br><span class="line">Source\ThirdParty\GoogleGameSDK\GoogleGameSDK_APL.xml</span><br></pre></td></tr></table></figure>

<h2 id="Win和Mac出IOS包的区别"><a href="#Win和Mac出IOS包的区别" class="headerlink" title="Win和Mac出IOS包的区别"></a>Win和Mac出IOS包的区别</h2><p>UE支持以远程构建的方式来出IOS包，Mac上只编译代码，Cook和编译shader等操作在Win上执行，生成的ios包使用ushaderbytecode，而在Mac上打包IOS则会使用Matellib。<br><img data-src="index/2020/20201208145952.webp"></p>
<p>有时间来分析一下IOS在使用matallib和ushaderbytecode时效率上有没有区别。</p>
<h2 id="UE4新地图的Package问题"><a href="#UE4新地图的Package问题" class="headerlink" title="UE4新地图的Package问题"></a>UE4新地图的Package问题</h2><p>发现UE中的一个问题：</p>
<ol>
<li>创建一个新的地图<br><img data-src="index/2020/20201204213024.webp"></li>
<li>获取这个新地图的<code>UPackage</code>，得到的是<code>Engine/Maps/Templates/Template_Default</code><br><img data-src="index/2020/20201204212642.webp"></li>
</ol>
<p>但是在第二次启动的时候就正常了，怀疑是新建资源的时候没有更新AssetRegistry，有时间具体分析一下原因。</p>
<h2 id="C-加载BP的Enum"><a href="#C-加载BP的Enum" class="headerlink" title="C++加载BP的Enum"></a>C++加载BP的Enum</h2><p>在蓝图中新建的枚举资源，在C++中访问：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FString <span class="title">UFlibAppHelper::GetEnumNameByValue</span><span class="params">(TSoftObjectPtr&lt;UUserDefinedEnum&gt; EnumPath, int32 value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString result;</span><br><span class="line">    UUserDefinedEnum* Enumer = LoadObject&lt;UUserDefinedEnum&gt;(<span class="literal">nullptr</span>, *EnumPath.ToString());</span><br><span class="line">    <span class="keyword">if</span> (Enumer)</span><br><span class="line">    &#123;</span><br><span class="line">        result = Enumer-&gt;GetDisplayNameTextByValue(value).ToString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果：<br><img data-src="index/2020/20201203212055.webp"></p>
<h2 id="DS设置超时时间"><a href="#DS设置超时时间" class="headerlink" title="DS设置超时时间"></a>DS设置超时时间</h2><p>修改DefaultEngine.ini：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/OnlineSubsystemUtils.IpNetDriver]</span></span><br><span class="line"><span class="attr">ConnectionTimeout</span>=<span class="number">10.0</span></span><br></pre></td></tr></table></figure>

<h2 id="DDC的资料"><a href="#DDC的资料" class="headerlink" title="DDC的资料"></a>DDC的资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/community/general-discussion/1749914-work-from-home-cloud-ddc-experimental">Work From Home: Cloud DDC (experimental)</a></li>
</ul>
<h2 id="路径过长导致远程构建失败"><a href="#路径过长导致远程构建失败" class="headerlink" title="路径过长导致远程构建失败"></a>路径过长导致远程构建失败</h2><p>当引擎的路径过长时，远程构建会出现以下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  ********** BUILD COMMAND STARTED **********</span><br><span class="line">  Running: C:\BuildAgent\workspace\PackageWindows\InstalledEngine\Engine\Engine\Binaries\DotNET\UnrealBuildTool.exe FGame IOS Development -Project&#x3D;C:\BuildAgent\workspace\PackageW</span><br><span class="line">indows\Client\FGame.uproject  C:\BuildAgent\workspace\PackageWindows\Client\FGame.uproject -NoUBTMakefiles  -remoteini&#x3D;&quot;C:\BuildAgent\workspace\PackageWindows\Client&quot; -skipdeploy </span><br><span class="line">-Manifest&#x3D;C:\BuildAgent\workspace\PackageWindows\Client\Intermediate\Build\Manifest.xml -NoHotReload -log&#x3D;&quot;C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+B</span><br><span class="line">uildAgent+workspace+PackageWindows+InstalledEngine+Engine\BuildCookRun\UBT-FGame-IOS-Development.txt&quot;</span><br><span class="line">    WARNING: Running from a path with a long directory name (&quot;C:\BuildAgent\workspace\PackageWindows\InstalledEngine\Engine&quot; &#x3D; 61 characters). Root paths shorter than 50 character</span><br><span class="line">s are recommended to avoid exceeding maximum path lengths on Windows.</span><br><span class="line">    [Remote] Using remote server &#39;xx.xx.xx.xx&#39; on port 2222 (user &#39;buildmachine&#39;)</span><br><span class="line">    [Remote] Using private key at C:\BuildAgent\workspace\PackageWindows\Client\Build\NotForLicensees\SSHKeys\xx.xx.xx.xx\buildmachine\RemoteToolChainPrivate.key</span><br><span class="line">    ERROR: Unable to determine home directory for remote user. SSH output:</span><br><span class="line">             Host key verification failed.</span><br><span class="line">  Took 0.8051806s to run UnrealBuildTool.exe, ExitCode&#x3D;6</span><br><span class="line">  UnrealBuildTool failed. See log for more details. (C:\Users\lipengzha\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+BuildAgent+workspace+PackageWindows+InstalledEngine+Eng</span><br><span class="line">ine\BuildCookRun\UBT-FGame-IOS-Development.txt)</span><br><span class="line">  AutomationTool exiting with ExitCode&#x3D;6 (6)</span><br><span class="line">Took 1.6488741s to run AutomationTool.exe, ExitCode&#x3D;6</span><br><span class="line">AutomationTool exiting with ExitCode&#x3D;1 (Error_Unknown)</span><br><span class="line">BUILD FAILED</span><br></pre></td></tr></table></figure>
<p>这里有一个<em>Running from a path with a long directory name</em>的警告，然后跟着一个SSH Key的验证错误。<br>造成这个错误的原因就是因为警告中的内容，而非SSHKey的问题，因为Win默认的路径长度不能长于260，所以当引擎根目录位于较深的目录中时，可能会导致引擎的路径超过限制，导致后续的失败。</p>
<p>解决方案自然就是两个办法：</p>
<ol>
<li>减少引擎的路径深度</li>
<li>修改系统的最长路径支持</li>
</ol>
<p>Win10现在支持了长路径支持，开启即可：<a href="https://imzlp.com/notes/tips#Win10_%E5%BC%80%E5%90%AF%E9%95%BF%E8%B7%AF%E5%BE%84%E6%94%AF%E6%8C%81">Win10 开启长路径支持</a></p>
<h2 id="Mount-Point的作用"><a href="#Mount-Point的作用" class="headerlink" title="Mount Point的作用"></a>Mount Point的作用</h2><p>在Mount Pak的时候，有一个参数可以指定MountPoint:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Mounts a pak file at the specified path.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param InPakFilename Pak filename.</span></span><br><span class="line"><span class="comment">* @param InPath Path to mount the pak at.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Mount</span><span class="params">(<span class="keyword">const</span> TCHAR* InPakFilename, uint32 PakOrder, <span class="keyword">const</span> TCHAR* InPath = <span class="literal">NULL</span>, <span class="keyword">bool</span> bLoadIndex = <span class="literal">true</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>那么它是干什么的呢？<br>首先从Mount函数开始：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (InPath != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Pak-&gt;SetMountPoint(InPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果在调用Mount时传递了<code>InPath</code>，则通过加载Pak的FPakFile实例调用<code>SetMountPoint</code>，把InPath设置给它。<br>其实在FPakFile中，MountPath是有默认值的（从Pak文件中读取），在FPakFile的构造函数中调用了<code>Initialize(Reader, bLoadIndex);</code>，Initialize中又调用了<code>LoadIndex</code>，在<code>LoadIndex</code>中从Pak中读取Pak的Mount Point的逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FPakFile::LoadIndex</span><span class="params">(FArchive* Reader)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (CachedTotalSize &lt; (Info.IndexOffset + Info.IndexSize))</span><br><span class="line">  &#123;</span><br><span class="line">    UE_LOG(LogPakFile, Fatal, TEXT(<span class="string">&quot;Corrupted index offset in pak file.&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (Info.Version &gt;= FPakInfo::PakFile_Version_FrozenIndex &amp;&amp; Info.bIndexIsFrozen)</span><br><span class="line">    &#123;</span><br><span class="line">      SCOPED_BOOT_TIMING(<span class="string">&quot;PakFile_LoadFrozen&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// read frozen data</span></span><br><span class="line">      Reader-&gt;Seek(Info.IndexOffset);</span><br><span class="line">      int32 FrozenSize = Info.IndexSize;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// read in the index, etc data in one lump</span></span><br><span class="line">      <span class="keyword">void</span>* DataMemory = FMemory::Malloc(FrozenSize);</span><br><span class="line">      Reader-&gt;Serialize(DataMemory, FrozenSize);</span><br><span class="line">      Data = TUniquePtr&lt;FPakFileData&gt;((FPakFileData*)DataMemory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// cache the number of entries</span></span><br><span class="line">      NumEntries = Data-&gt;Files.Num();</span><br><span class="line">      <span class="comment">// @todo loadtime: it is nice to serialize the mountpoint right into the Data so that IndexSize is right here</span></span><br><span class="line">      <span class="comment">// but it takes this to copy it out, because it&#x27;s too painful for the string manipulation when dealing with</span></span><br><span class="line">      <span class="comment">// MemoryImageString everywhere MountPoint is used</span></span><br><span class="line">      MountPoint = Data-&gt;MountPoint;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单的可以理解为：如果Mount时不传递Mount Point就会从Pak文件中读取，如果有传入就设置为传入的值（Pak文件中的MountPoint是Pak中所有文件的公共路径）。</p>
<p>那么，给Pak设置MountPoint的作用是什么呢？<br>真实目的是，检测要加载的文件是否存在于当前Pak中！因为Pak的Mount Point的默认含义是当前Pak中所有文件的公共路径，所以只需要检测要读取的文件是否以这个路径开头，就可以首先排除掉基础路径不对的文件（基础路径都不对，意味着这个文件在Pak中也不存在）。</p>
<p>具体逻辑可以看这个函数的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Public/IPlatformFilePak.h</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Finds a file in the specified pak files.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @param Paks Pak files to find the file in.</span></span><br><span class="line"><span class="comment">* @param Filename File to find in pak files.</span></span><br><span class="line"><span class="comment">* @param OutPakFile Optional pointer to a pak file where the filename was found.</span></span><br><span class="line"><span class="comment">* @return Pointer to pak entry if the file was found, NULL otherwise.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">FindFileInPakFiles</span><span class="params">(TArray&lt;FPakListEntry&gt;&amp; Paks,<span class="keyword">const</span> TCHAR* Filename,FPakFile** OutPakFile,FPakEntry* OutEntry = <span class="literal">nullptr</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">FString <span class="title">StandardFilename</span><span class="params">(Filename)</span></span>;</span><br><span class="line">    FPaths::MakeStandardFilename(StandardFilename);</span><br><span class="line"></span><br><span class="line">    int32 DeletedReadOrder = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (int32 PakIndex = <span class="number">0</span>; PakIndex &lt; Paks.Num(); PakIndex++)</span><br><span class="line">    &#123;</span><br><span class="line">        int32 PakReadOrder = Paks[PakIndex].ReadOrder;</span><br><span class="line">        <span class="keyword">if</span> (DeletedReadOrder != <span class="number">-1</span> &amp;&amp; DeletedReadOrder &gt; PakReadOrder)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//found a delete record in a higher priority patch level, but now we&#x27;re at a lower priority set - don&#x27;t search further back or we&#x27;ll find the original, old file.</span></span><br><span class="line">            UE_LOG( LogPakFile, Verbose, TEXT(<span class="string">&quot;Delete Record: Accepted a delete record for %s&quot;</span>), Filename );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FPakFile::EFindResult FindResult = Paks[PakIndex].PakFile-&gt;Find(*StandardFilename, OutEntry);</span><br><span class="line">        <span class="keyword">if</span> (FindResult == FPakFile::EFindResult::Found )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (OutPakFile != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                *OutPakFile = Paks[PakIndex].PakFile;</span><br><span class="line">            &#125;</span><br><span class="line">            UE_CLOG( DeletedReadOrder != <span class="number">-1</span>, LogPakFile, Verbose, TEXT(<span class="string">&quot;Delete Record: Ignored delete record for %s - found it in %s instead (asset was moved between chunks)&quot;</span>), Filename, *Paks[PakIndex].PakFile-&gt;GetFilename() );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (FindResult == FPakFile::EFindResult::FoundDeleted )</span><br><span class="line">        &#123;</span><br><span class="line">            DeletedReadOrder = PakReadOrder;</span><br><span class="line">            UE_LOG( LogPakFile, Verbose, TEXT(<span class="string">&quot;Delete Record: Found a delete record for %s in %s&quot;</span>), Filename, *Paks[PakIndex].PakFile-&gt;GetFilename() );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UE_CLOG( DeletedReadOrder != <span class="number">-1</span>, LogPakFile, Warning, TEXT(<span class="string">&quot;Delete Record: No lower priority pak files looking for %s. (maybe not downloaded?)&quot;</span>), Filename );</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们从Pak中读取文件时，通过对游戏中所有Mount的Pak调用<code>Find</code>函数，而<code>FPakFile::Find</code>的函数就实现了上述我说的逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function">FPakFile::EFindResult <span class="title">FPakFile::Find</span><span class="params">(<span class="keyword">const</span> FString&amp; Filename, FPakEntry* OutEntry)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  QUICK_SCOPE_CYCLE_COUNTER(PakFileFind);</span><br><span class="line">  <span class="keyword">if</span> (Filename.StartsWith(MountPoint))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">FString <span class="title">Path</span><span class="params">(FPaths::GetPath(Filename))</span></span>;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，MountPoint的作用就是在从Pak中查找文件时，首先判断文件的路径是否与Pak中所有文件的<strong>基础路径</strong>相匹配（StartWith），如果不存在也就不会进入后续的流程了。</p>
<h2 id="引擎的Splash过程"><a href="#引擎的Splash过程" class="headerlink" title="引擎的Splash过程"></a>引擎的Splash过程</h2><p><img data-src="index/2020/20201116215421.webp"></p>
<p>通过在这里断点可以比较直观地分析，引擎初始化到什么阶段做了什么事情。</p>
<h2 id="UE4-25-1的Assembly路径错误"><a href="#UE4-25-1的Assembly路径错误" class="headerlink" title="UE4.25.1的Assembly路径错误"></a>UE4.25.1的Assembly路径错误</h2><p>在UE4.25.1中，引擎生成的<code>Engine/Intermediate/Build/BuildRules/UE4Rules.dll</code>等文件具有路径错误。</p>
<p>具体的原因是在<code>UnrealBuildTool/System/RulesCompiler.cs</code>的<code>CreateEngineOrEnterpriseRulesAssembly</code>函数：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UE 4.25.1</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RulesAssembly <span class="title">CreateEngineOrEnterpriseRulesAssembly</span>(<span class="params">RulesScope Scope, List&lt;DirectoryReference&gt; RootDirectories, <span class="keyword">string</span> AssemblyPrefix, IReadOnlyList&lt;PluginInfo&gt; Plugins, <span class="keyword">bool</span> bReadOnly, <span class="keyword">bool</span> bSkipCompile, RulesAssembly Parent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Get the path to store any generated assemblies</span></span><br><span class="line">  DirectoryReference AssemblyDir = RootDirectories[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> (UnrealBuildTool.IsFileInstalled(FileReference.Combine(AssemblyDir, AssemblyPrefix)))</span><br><span class="line">  &#123;</span><br><span class="line">  DirectoryReference UserDir = Utils.GetUserSettingDirectory();</span><br><span class="line">      <span class="keyword">if</span> (UserDir != <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">      ReadOnlyBuildVersion Version = ReadOnlyBuildVersion.Current;</span><br><span class="line">      AssemblyDir = DirectoryReference.Combine(UserDir, <span class="string">&quot;UnrealEngine&quot;</span>, String.Format(<span class="string">&quot;&#123;0&#125;.&#123;1&#125;&quot;</span>, Version.MajorVersion, Version.MinorVersion));</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the assembly</span></span><br><span class="line">  FileReference EngineAssemblyFileName = FileReference.Combine(AssemblyDir, <span class="string">&quot;Intermediate&quot;</span>, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;BuildRules&quot;</span>, AssemblyPrefix + <span class="string">&quot;Rules&quot;</span> + FrameworkAssemblyExtension);</span><br><span class="line">  RulesAssembly EngineAssembly = <span class="keyword">new</span> RulesAssembly(Scope, RootDirectories, Plugins, ModuleFileToContext, <span class="keyword">new</span> List&lt;FileReference&gt;(), EngineAssemblyFileName, bContainsEngineModules: <span class="literal">true</span>, DefaultBuildSettings: BuildSettingsVersion.Latest, bReadOnly: bReadOnly, bSkipCompile: bSkipCompile, Parent: Parent);</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中<code>AssemblyDir</code>是引擎目录，<code>AssemblyPrefix</code>是<code>UE4</code>，拼接起来能够通过<code>UnrealBuildTool.IsFileInstalled</code>的检测。<br>但是，在if的代码块中，获取了用户目录，在IOS中就是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># win</span></span><br><span class="line">C:\Users\lipengzha\AppData\Local\UnrealEngine\4.25</span><br><span class="line"><span class="comment"># Mac</span></span><br><span class="line">/Users/buildmachine/Library/Application Support/Epic</span><br></pre></td></tr></table></figure>
<p>拼接起来就是上面这两个<code>USER_DIR</code>的<code>UnrealEngine/4.25/</code>，在下面读取<code>Assembly</code>的流程中就会使用这个路径。</p>
<p>在使用Win的时候，其实没有问题，因为就算把<code>UE4Rules.dll</code>写入到用户目录下，在Win上同样是可以访问到的。<strong>但是</strong>，在使用Win远程构建IOS的时候就会出现问题。<br>在远程构建时，会使用Rsync把引擎的文件同步到Mac上再执行编译，其中就包括<code>Engine/Intermediate/Build/BuildRuls/</code>下的所有文件，因为4.25.1中的代码会把<code>Build/BuildRuls/UE4Rules.dll</code>等生成到Win的用户目录下，所以远程构建，RSync就不能正确地把<code>BuildRuls</code>下的文件上传到Mac上，故而引起打包错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Precompiled rules assembly <span class="string">&#x27;/Users/buildmachine/Library/Application Support/Epic/UnrealEngine/4.25/Intermediate/Build/BuildRules/UE4Rules.dl</span></span><br><span class="line"><span class="string">l&#x27;</span> does not exist.</span><br></pre></td></tr></table></figure>
<p>可以看到，在Mac上也是从Mac的用户目录查找的，因为压根Mac上就没有这俩文件，所以就会产生这个错误。<br>解决这个问题的办法，就是修改<code>UnrealBuildTool/System/RulesCompiler.cs</code>的<code>CreateEngineOrEnterpriseRulesAssembly</code>函数，把<code>BuildRules</code>相关的文件写入到<code>Engine/Intermediate/Build/BuildRules</code>中，在UE4.25.2中已经修复了这个错误。<br>在<a target="_blank" rel="noopener" href="https://forums.unrealengine.com/unreal-engine/announcements-and-releases/1791750-4-25-2-hotfix-released">4.25.2 Hotfix released</a>中列出了<strong>Fixed! UE-94140 Fix assembly location for remote toolchain</strong>，其实就是直接修改了<code>CreateEngineOrEnterpriseRulesAssembly</code>函数:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UE 4.25.2</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RulesAssembly <span class="title">CreateEngineOrEnterpriseRulesAssembly</span>(<span class="params">RulesScope Scope, List&lt;DirectoryReference&gt; RootDirectories, <span class="keyword">string</span> AssemblyPrefix, IReadOnlyList&lt;PluginInfo&gt; Plugins, <span class="keyword">bool</span> bReadOnly, <span class="keyword">bool</span> bSkipCompile, RulesAssembly Parent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Create the assembly</span></span><br><span class="line">  FileReference EngineAssemblyFileName = FileReference.Combine(RootDirectories[<span class="number">0</span>], <span class="string">&quot;Intermediate&quot;</span>, <span class="string">&quot;Build&quot;</span>, <span class="string">&quot;BuildRules&quot;</span>, AssemblyPrefix + <span class="string">&quot;Rules&quot;</span> + FrameworkAssemblyExtension);</span><br><span class="line">  RulesAssembly EngineAssembly = <span class="keyword">new</span> RulesAssembly(Scope, RootDirectories[<span class="number">0</span>], Plugins, ModuleFileToContext, <span class="keyword">new</span> List&lt;FileReference&gt;(), EngineAssemblyFileName, bContainsEngineModules: <span class="literal">true</span>, DefaultBuildSettings: BuildSettingsVersion.Latest, bReadOnly: bReadOnly, bSkipCompile: bSkipCompile, Parent: Parent);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以直接在github中查看:<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.24.2-release/Engine/Source/Programs/UnrealBuildTool/System/RulesCompiler.cs#L442">UnrealBuildTool/System/RulesCompiler.cs#L442</a></p>
<h2 id="跨Level选择Actor"><a href="#跨Level选择Actor" class="headerlink" title="跨Level选择Actor"></a>跨Level选择Actor</h2><p>在场景中，美术和游戏逻辑是区分开的，所以有时候需要程序关卡去操控美术关卡的对象，但是UE的不同关卡其实是不同的资源，属于不同的Pacakge，是不能直接跨关卡来选择对象实例的。<br>选择时会有以下错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LogProperty: Warning: Illegal TEXT reference to a private object in external package (StaticMeshActor /Game/Test/Map/Level_Sub2.Level_Sub2:PersistentLevel.Cube_2) from referencer (BP_AActor_C /Game/Test/Map/Level_Sub1.Level_Sub1:PersistentLevel.BP_AActor_2).  Import failed...</span><br></pre></td></tr></table></figure>
<p>这是因为在<code>PropertyBaseObject.cpp</code>的<code>FObjectPropertyBase::ImportText_Internal</code>中对Object属性是否可以跨关卡做了检测：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UObject* <span class="title">FObjectPropertyBase::FindImportedObject</span><span class="params">( <span class="keyword">const</span> FProperty* Property, UObject* OwnerObject, UClass* ObjectClass, UClass* RequiredMetaClass, <span class="keyword">const</span> TCHAR* Text, uint32 PortFlags<span class="comment">/*=0*/</span>, FUObjectSerializeContext* InSerializeContext <span class="comment">/*= nullptr*/</span>, <span class="keyword">bool</span> bAllowAnyPackage <span class="comment">/*= true*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// if we found an object, and we have a parent, make sure we are in the same package if the found object is private, unless it&#x27;s a cross level property</span></span><br><span class="line">	<span class="keyword">if</span> (Result &amp;&amp; !Result-&gt;HasAnyFlags(RF_Public) &amp;&amp; OwnerObject &amp;&amp; Result-&gt;GetOutermost() != OwnerObject-&gt;GetOutermost())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">const</span> FObjectPropertyBase* ObjectProperty = CastField&lt;<span class="keyword">const</span> FObjectPropertyBase&gt;(Property);</span><br><span class="line">		<span class="keyword">if</span> ( !ObjectProperty || !ObjectProperty-&gt;AllowCrossLevel())</span><br><span class="line">		&#123;</span><br><span class="line">			UE_LOG(LogProperty, Warning, TEXT(<span class="string">&quot;Illegal TEXT reference to a private object in external package (%s) from referencer (%s).  Import failed...&quot;</span>), *Result-&gt;GetFullName(), *OwnerObject-&gt;GetFullName());</span><br><span class="line">			Result = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>AllowCrossLevel</code>有两个继承类有覆写：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/CoreUObject/Private/UObject/PropertyBaseObject.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FObjectPropertyBase::AllowCrossLevel</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Runtime/CoreUObject/Private/UObject/PropertyLazyObjectPtr.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FLazyObjectProperty::AllowCrossLevel</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Runtime/CoreUObject/Private/UObject/PropertySoftObjectPtr.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FSoftObjectProperty::AllowCrossLevel</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，不能够直接通过创建<code>FObjectPropertyBase</code>这种硬引用方式的属性从SubLevel1选择SubLevel2中的Actor。<br>那么如何解决这么问题呢？，上面已经列出了两个可以跨平台选择的属性，分别是<code>FLazyObjectProperty</code>和<code>FSoftObjectProperty</code>，那么以<code>FSoftObjectProperty</code>为例，可以通过<code>TSoftObjectPtr</code>来实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TSoftObjectPtr&lt;AActor&gt; Actor;</span><br></pre></td></tr></table></figure>
<p><img data-src="index/2020/20201110213023.webp"></p>
<p><code>TSoftObjectPtr</code>获取到的其实是SubLevel2中的资源的路径：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Game/Test/Map/Level_Sub2.Level_Sub2:PersistentLevel.Cube_2</span><br></pre></td></tr></table></figure>
<p>在运行时访问需要使用以下操作来获取：<br><img data-src="index/2020/20201110213249.webp"></p>
<p>上面蓝图中节点<code>Load Asset Blocking</code>是<code>UKismetSystemLibrary</code>中的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Engine/Private/KismetSystemLibrary.cpp</span></span><br><span class="line"><span class="function">UObject* <span class="title">UKismetSystemLibrary::LoadAsset_Blocking</span><span class="params">(TSoftObjectPtr&lt;UObject&gt; Asset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Asset.LoadSynchronous();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>看来UE加载资源时，并没有区分真正的物理资源和场景中的实例，统一使用资源的路径来加载，这一点做的非常爽，可以把另一个关卡中的Actor当作资源来读取，并且获取的还就是运行时的那个实例，非常Nice。</p>
</blockquote>
<h2 id="添加外部库的注意事项"><a href="#添加外部库的注意事项" class="headerlink" title="添加外部库的注意事项"></a>添加外部库的注意事项</h2><p>在添加外部的代码库时，需要关注以下几个问题：</p>
<ol>
<li>纯代码的库，要测试是否具有平台相关的写法，需要同时支持Win/Android/IOS/Mac四个平台</li>
<li>对于Android的so要同时支持arm64/armv7，打包时so文件的拷贝需要使用UPL执行</li>
<li>ios的<code>.a</code>要同时具有<code>bitcode</code>和非<code>bitcode</code>版本，不然在shipping时如果开启了bitcode，链接不支持bitcode的库会有链接错误的问题。</li>
</ol>
<p><img data-src="index/2020/20201117095535.webp"></p>
<p>检测当前构建是否支持bitcode的流程：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Target.IOSPlatform.bShipForBitcode)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// add support bitcode lib</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// add not-support bitcode lib</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Target.cs</code>中可以直接通过<code>IOSPlatform</code>获取当前构建是否支持bitcode，在其他的Module中，可以通过<code>target.cs</code>中的<code>Target.IOSPlatform</code>获取。</p>
<h2 id="Outer"><a href="#Outer" class="headerlink" title="Outer"></a>Outer</h2><ul>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/development-discussion/c-gameplay-programming/54894-what-is-meant-by-outer-object">What is meant by “Outer Object”?</a></li>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/292594/how-can-i-understand-the-data-member-outer-in-the.html">How can I understand the data member ‘Outer’ in the UObjectBase class</a></li>
</ul>
<h2 id="ShareMaterialShaderCode"><a href="#ShareMaterialShaderCode" class="headerlink" title="ShareMaterialShaderCode"></a>ShareMaterialShaderCode</h2><p>在打包时可以在<code>Project Settings</code>-<code>Packaging</code>中设置<code>Share Material Shader Code</code>和<code>Shadred Material Native Libraries</code>来减少包体的大小。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * By default shader code gets saved inline inside material assets, </span></span><br><span class="line"><span class="comment"> * enabling this option will store only shader code once as individual files</span></span><br><span class="line"><span class="comment"> * This will reduce overall package size but might increase loading time</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">UPROPERTY(config, EditAnywhere, Category=Packaging)</span><br><span class="line"><span class="keyword">bool</span> bShareMaterialShaderCode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * By default shader shader code gets saved into individual platform agnostic files,</span></span><br><span class="line"><span class="comment"> * enabling this option will use the platform-specific library format if and only if one is available</span></span><br><span class="line"><span class="comment"> * This will reduce overall package size but might increase loading time</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">UPROPERTY(config, EditAnywhere, Category=Packaging, meta = (EditCondition = <span class="string">&quot;bShareMaterialShaderCode&quot;</span>, ConfigRestartRequired = <span class="literal">true</span>))</span><br><span class="line"><span class="keyword">bool</span> bSharedMaterialNativeLibraries;</span><br></pre></td></tr></table></figure>
<p>开启了之后打出的包中会生成下列文件：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ShaderArchive-Blank425-PCD3D_SM5.ushaderbytecode</span><br><span class="line">ShaderCode-Global-PCD3D_SM5.ushaderbytecode</span><br></pre></td></tr></table></figure>
<p>但是，如果开启之后如果后续的Cook资源Shader发生了变动，而基础包内还是旧的ShaderBytecode信息，会导致材质丢失。<br><img data-src="https://imzlp.com/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp"></p>
<p>有两个办法：</p>
<ol>
<li>后续的打包时可以把Shaderbytecode文件打包在pak中，挂载时加载；</li>
<li>Cook热更资源时把Shaderbytecode打包在资源内；</li>
</ol>
<h2 id="获取ContentBrowser中选择的资源"><a href="#获取ContentBrowser中选择的资源" class="headerlink" title="获取ContentBrowser中选择的资源"></a>获取ContentBrowser中选择的资源</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IContentBrowserSingleton.h&quot;</span></span></span><br><span class="line"><span class="function">TArray&lt;FAssetData&gt; <span class="title">FHotPatcherEditorModule::GetSelectedAssetsInBrowserContent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FContentBrowserModule&amp; ContentBrowserModule = FModuleManager::Get().LoadModuleChecked&lt;FContentBrowserModule&gt;(TEXT(<span class="string">&quot;ContentBrowser&quot;</span>));</span><br><span class="line">	TArray&lt;FAssetData&gt; AssetsData;</span><br><span class="line">	ContentBrowserModule.Get().GetSelectedAssets(AssetsData);</span><br><span class="line">	<span class="keyword">return</span> AssetsData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="命令行太长无法适应调试记录"><a href="#命令行太长无法适应调试记录" class="headerlink" title="命令行太长无法适应调试记录"></a>命令行太长无法适应调试记录</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">无法执行“C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\VC\Tools\MSVC\14.16.27023\bin\HostX64\x64\c1xx.dll”: 命令行太长，无法适应调试记录</span><br></pre></td></tr></table></figure>
<p>在报错的模块的build.cs中添加下列属性即可：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bLegacyPublicIncludePaths = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<h2 id="添加资源右键菜单按钮"><a href="#添加资源右键菜单按钮" class="headerlink" title="添加资源右键菜单按钮"></a>添加资源右键菜单按钮</h2><p>在ContentBrowser选择资源时的右键菜单按钮。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FHotPatcherEditorModule::AddAssetContentMenu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!UToolMenus::IsToolMenuUIEnabled())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="function">FToolMenuOwnerScoped <span class="title">MenuOwner</span><span class="params">(<span class="string">&quot;CookUtilities&quot;</span>)</span></span>;</span><br><span class="line">	UToolMenu* Menu = UToolMenus::Get()-&gt;ExtendMenu(<span class="string">&quot;ContentBrowser.AssetContextMenu&quot;</span>);</span><br><span class="line">	FToolMenuSection&amp; Section = Menu-&gt;AddSection(<span class="string">&quot;AssetContextCookUtilities&quot;</span>, LOCTEXT(<span class="string">&quot;CookUtilitiesMenuHeading&quot;</span>, <span class="string">&quot;CookUtilities&quot;</span>));;</span><br><span class="line">	</span><br><span class="line">	Section.AddDynamicEntry(<span class="string">&quot;SoundWaveAsset&quot;</span>, FNewToolMenuSectionDelegate::CreateLambda([<span class="keyword">this</span>](FToolMenuSection&amp; InSection)</span><br><span class="line">	   &#123;</span><br><span class="line">	       <span class="keyword">const</span> TAttribute&lt;FText&gt; Label = LOCTEXT(<span class="string">&quot;CookUtilities_CookAsset&quot;</span>, <span class="string">&quot;Cook Assets&quot;</span>);</span><br><span class="line">	       <span class="keyword">const</span> TAttribute&lt;FText&gt; ToolTip = LOCTEXT(<span class="string">&quot;CookUtilities_CookAssetsTooltip&quot;</span>, <span class="string">&quot;Cook Assets&quot;</span>);</span><br><span class="line">	       <span class="keyword">const</span> FSlateIcon Icon = FSlateIcon(FEditorStyle::GetStyleSetName(), <span class="string">&quot;ClassIcon.SoundSimple&quot;</span>);</span><br><span class="line">	       <span class="keyword">const</span> FToolMenuExecuteAction UIAction = FToolMenuExecuteAction::CreateRaw(<span class="keyword">this</span>,&amp;FHotPatcherEditorModule::OnCookAssets);</span><br><span class="line">	</span><br><span class="line">	       InSection.AddMenuEntry(<span class="string">&quot;CookUtilities_CookAssets&quot;</span>, Label, ToolTip, Icon, UIAction);</span><br><span class="line">	   &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以在绑定的函数中对资源进行操作。</p>
<h2 id="GenerateProjectFiles指定VS版本"><a href="#GenerateProjectFiles指定VS版本" class="headerlink" title="GenerateProjectFiles指定VS版本"></a>GenerateProjectFiles指定VS版本</h2><p><code>GenerateProjectFiles.bat</code>最终也是调用到<code>UnrealBuildTool.exe</code>，可以通过<code>-2015</code>/<code>-2017</code>来指定VS2015和VS2017引擎版本。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealBuildSystem/ProjectFileGenerator/index.html">Automatic Project File Generation</a></li>
<li><a target="_blank" rel="noopener" href="https://dawnarc.com/2017/05/ue4generate-visual-studio%E5%B7%A5%E7%A8%8B%E6%97%B6%E5%A6%82%E4%BD%95%E6%8C%87%E5%AE%9Avs%E7%89%88%E6%9C%AC/">VS版本</a></li>
</ul>
<h2 id="Module的WhitelistPlatforms"><a href="#Module的WhitelistPlatforms" class="headerlink" title="Module的WhitelistPlatforms"></a>Module的WhitelistPlatforms</h2><p>有一些Module用到了平台相关的内容，在另一个平台会编译不过，所以需要在<code>uplugin</code>中给Module添加模块白名单，只有在其中的平台上才会进行编译。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;Modules&quot;: [</span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;Name&quot;</span>: <span class="string">&quot;OculusHMD&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;Runtime&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;LoadingPhase&quot;</span>: <span class="string">&quot;PostConfigInit&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;WhitelistPlatforms&quot;</span>: [</span><br><span class="line">		<span class="string">&quot;Win64&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Win32&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android&quot;</span></span><br><span class="line">	]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>也可以设置平台的黑名单，使用<code>BlacklistPlatforms</code>。</p>
<h2 id="IDetailCustomization"><a href="#IDetailCustomization" class="headerlink" title="IDetailCustomization"></a>IDetailCustomization</h2><p>使用<code>IDetailCustomization</code>的方式可以给UE的属性面板添加特殊的东西，比如按钮。</p>
<p>以给F的结构的Detail添加按钮的方法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReleaseSettingsDetails.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IDetailCustomization.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FReleaseSettingsDetails</span> :</span> <span class="keyword">public</span> IDetailCustomization</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/** Makes a new instance of this detail layout class for a specific detail view requesting it */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> TSharedRef&lt;IDetailCustomization&gt; <span class="title">MakeInstance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** IDetailCustomization interface */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CustomizeDetails</span><span class="params">(IDetailLayoutBuilder&amp; DetailBuilder)</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line">````</span><br><span class="line">.cpp:</span><br><span class="line"></span><br><span class="line">```cpp</span><br><span class="line"><span class="comment">// ReleaseSettingsDetails.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CreatePatch/ReleaseSettingsDetails.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CreatePatch/FExportReleaseSettings.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// engine header</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DetailLayoutBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DetailCategoryBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DetailWidgetRow.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Widgets/Input/SButton.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOCTEXT_NAMESPACE <span class="meta-string">&quot;ReleaseSettingsDetails&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">TSharedRef&lt;IDetailCustomization&gt; <span class="title">FReleaseSettingsDetails::MakeInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> MakeShareable(<span class="keyword">new</span> FReleaseSettingsDetails());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FReleaseSettingsDetails::CustomizeDetails</span><span class="params">(IDetailLayoutBuilder&amp; DetailBuilder)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TArray&lt; TSharedPtr&lt;FStructOnScope&gt; &gt; StructBeingCustomized;</span><br><span class="line">    DetailBuilder.GetStructsBeingCustomized(StructBeingCustomized);</span><br><span class="line">    check(StructBeingCustomized.Num() == <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    FExportReleaseSettings* ReleaseSettingsIns = (FExportReleaseSettings*)StructBeingCustomized[<span class="number">0</span>].Get()-&gt;GetStructMemory();</span><br><span class="line">    </span><br><span class="line">    IDetailCategoryBuilder&amp; VersionCategory = DetailBuilder.EditCategory(<span class="string">&quot;Version&quot;</span>,FText::GetEmpty(),ECategoryPriority::Default);</span><br><span class="line">    VersionCategory.SetShowAdvanced(<span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    VersionCategory.AddCustomRow(LOCTEXT(<span class="string">&quot;ImportPakLists&quot;</span>, <span class="string">&quot;Import Pak Lists&quot;</span>),<span class="literal">true</span>)</span><br><span class="line">        .ValueContent()</span><br><span class="line">        [</span><br><span class="line">            SNew(SHorizontalBox)</span><br><span class="line">            + SHorizontalBox::Slot()</span><br><span class="line">            .Padding(<span class="number">0</span>)</span><br><span class="line">            .AutoWidth()</span><br><span class="line">            [</span><br><span class="line">                SNew(SButton)</span><br><span class="line">                .Text(LOCTEXT(<span class="string">&quot;Import&quot;</span>, <span class="string">&quot;Import&quot;</span>))</span><br><span class="line">                .ToolTipText(LOCTEXT(<span class="string">&quot;ImportPakLists_Tooltip&quot;</span>, <span class="string">&quot;Import Pak Lists&quot;</span>))</span><br><span class="line">                .IsEnabled_Lambda([<span class="keyword">this</span>,ReleaseSettingsIns]()-&gt;<span class="keyword">bool</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> ReleaseSettingsIns-&gt;IsByPakList();</span><br><span class="line">                &#125;)</span><br><span class="line">                .OnClicked_Lambda([<span class="keyword">this</span>, ReleaseSettingsIns]()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ReleaseSettingsIns)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ReleaseSettingsIns-&gt;ImportPakLists();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>(FReply::Handled());</span><br><span class="line">                &#125;)</span><br><span class="line">            ]</span><br><span class="line">            + SHorizontalBox::Slot()</span><br><span class="line">            .Padding(<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">            .AutoWidth()</span><br><span class="line">            [</span><br><span class="line">                SNew(SButton)</span><br><span class="line">                .Text(LOCTEXT(<span class="string">&quot;Clear&quot;</span>, <span class="string">&quot;Clear&quot;</span>))</span><br><span class="line">                .ToolTipText(LOCTEXT(<span class="string">&quot;ClearPakLists_Tooltip&quot;</span>, <span class="string">&quot;Clear Pak Lists&quot;</span>))</span><br><span class="line">                .IsEnabled_Lambda([<span class="keyword">this</span>,ReleaseSettingsIns]()-&gt;<span class="keyword">bool</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> ReleaseSettingsIns-&gt;IsByPakList();</span><br><span class="line">                &#125;)</span><br><span class="line">                .OnClicked_Lambda([<span class="keyword">this</span>, ReleaseSettingsIns]()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ReleaseSettingsIns)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ReleaseSettingsIns-&gt;ClearImportedPakList();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>(FReply::Handled());</span><br><span class="line">                &#125;)</span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> LOCTEXT_NAMESPACE</span></span><br></pre></td></tr></table></figure>
<p>这里我们只是定义了一个<code>IDetailCustomization</code>的类，其中的<code>CustomizeDetails</code>是对<code>FExportReleaseSettings</code>添加的细节。</p>
<p>该类在创建<code>DetailView</code>时使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SHotPatcherExportRelease::CreateExportFilterListView</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Create a property view</span></span><br><span class="line">	FPropertyEditorModule&amp; EditModule = FModuleManager::Get().GetModuleChecked&lt;FPropertyEditorModule&gt;(<span class="string">&quot;PropertyEditor&quot;</span>);</span><br><span class="line"></span><br><span class="line">	FDetailsViewArgs DetailsViewArgs;</span><br><span class="line">	&#123;</span><br><span class="line">		DetailsViewArgs.bAllowSearch = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bHideSelectionTip = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bLockable = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.bSearchInitialKeyFocus = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bUpdatesFromSelection = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.NotifyHook = <span class="literal">nullptr</span>;</span><br><span class="line">		DetailsViewArgs.bShowOptions = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bShowModifiedPropertiesOption = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.bShowScrollBar = <span class="literal">false</span>;</span><br><span class="line">		DetailsViewArgs.bShowOptions = <span class="literal">true</span>;</span><br><span class="line">		DetailsViewArgs.bUpdatesFromSelection= <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FStructureDetailsViewArgs StructureViewArgs;</span><br><span class="line">	&#123;</span><br><span class="line">		StructureViewArgs.bShowObjects = <span class="literal">true</span>;</span><br><span class="line">		StructureViewArgs.bShowAssets = <span class="literal">true</span>;</span><br><span class="line">		StructureViewArgs.bShowClasses = <span class="literal">true</span>;</span><br><span class="line">		StructureViewArgs.bShowInterfaces = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	SettingsView = EditModule.CreateStructureDetailView(DetailsViewArgs, StructureViewArgs, <span class="literal">nullptr</span>);</span><br><span class="line">	FStructOnScope* Struct = <span class="keyword">new</span> FStructOnScope(FExportReleaseSettings::StaticStruct(), (uint8*)ExportReleaseSettings.Get());</span><br><span class="line">	SettingsView-&gt;GetOnFinishedChangingPropertiesDelegate().AddRaw(ExportReleaseSettings.Get(),&amp;FExportReleaseSettings::OnFinishedChangingProperties);</span><br><span class="line">	SettingsView-&gt;GetDetailsView()-&gt;RegisterInstancedCustomPropertyLayout(FExportReleaseSettings::StaticStruct(),FOnGetDetailCustomizationInstance::CreateStatic(&amp;FReleaseSettingsDetails::MakeInstance));</span><br><span class="line">	SettingsView-&gt;SetStructureData(MakeShareable(Struct));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>RegisterInstancedCustomPropertyLayout</code>把所写的<code>FReleaseSettingsDetails</code>实例注册到<code>DetailView</code>中。注意调用时机要在<code>SetStructureData</code>之前。<br>然后就可以看到添加的两个按钮了：<br><img data-src="index/2020/20201026200135.webp"></p>
<h2 id="提取PakList文件"><a href="#提取PakList文件" class="headerlink" title="提取PakList文件"></a>提取PakList文件</h2><p>打包时生成的PakList*.txt文件存放位置为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Programs\AutomationTool\Saved\Logs</span><br></pre></td></tr></table></figure>
<p>PakList的命名规则为<code>PakList_PROJECTNAME_PLATFORM.txt</code>，如：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PakList_Blank425-WindowsNoEditor.txt</span><br><span class="line">PakList_Blank425-Android_ASTC.txt</span><br><span class="line">PakList_blank425-ios.txt</span><br></pre></td></tr></table></figure>
<p>但是UE在打包下一次时会把上一次生成的<code>PakList*.txt</code>文件给清理掉。所以如果要提取某个平台的PakList需要在打包完当前平台之后立即提取，不然打包下个平台就把之前的删掉了。</p>
<h2 id="绑定DetailsView的属性变化事件"><a href="#绑定DetailsView的属性变化事件" class="headerlink" title="绑定DetailsView的属性变化事件"></a>绑定DetailsView的属性变化事件</h2><p>在编辑器中创建<code>DetailsView</code>时，如果使用继承自UObject的对象，可以重载<code>PostEditChangeProperty</code>来实现属性变化的监听，但是如果使用<code>F</code>的结构，则不能直接在类的函数中监听，需要通过绑定<code>IStructureDetailsView</code>的属性变动代理：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">TSharedPtr&lt;IStructureDetailsView&gt; SettingsView;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a property view</span></span><br><span class="line">FPropertyEditorModule&amp; EditModule = FModuleManager::Get().GetModuleChecked&lt;FPropertyEditorModule&gt;(<span class="string">&quot;PropertyEditor&quot;</span>);</span><br><span class="line"></span><br><span class="line">FDetailsViewArgs DetailsViewArgs;</span><br><span class="line">&#123;</span><br><span class="line">	DetailsViewArgs.bAllowSearch = <span class="literal">true</span>;</span><br><span class="line">	DetailsViewArgs.bHideSelectionTip = <span class="literal">true</span>;</span><br><span class="line">	DetailsViewArgs.bLockable = <span class="literal">false</span>;</span><br><span class="line">	DetailsViewArgs.bSearchInitialKeyFocus = <span class="literal">true</span>;</span><br><span class="line">	DetailsViewArgs.bUpdatesFromSelection = <span class="literal">false</span>;</span><br><span class="line">	DetailsViewArgs.NotifyHook = <span class="literal">nullptr</span>;</span><br><span class="line">	DetailsViewArgs.bShowOptions = <span class="literal">true</span>;</span><br><span class="line">	DetailsViewArgs.bShowModifiedPropertiesOption = <span class="literal">false</span>;</span><br><span class="line">	DetailsViewArgs.bShowScrollBar = <span class="literal">false</span>;</span><br><span class="line">	DetailsViewArgs.bShowOptions = <span class="literal">true</span>;</span><br><span class="line">	DetailsViewArgs.bUpdatesFromSelection= <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FStructureDetailsViewArgs StructureViewArgs;</span><br><span class="line">&#123;</span><br><span class="line">	StructureViewArgs.bShowObjects = <span class="literal">true</span>;</span><br><span class="line">	StructureViewArgs.bShowAssets = <span class="literal">true</span>;</span><br><span class="line">	StructureViewArgs.bShowClasses = <span class="literal">true</span>;</span><br><span class="line">	StructureViewArgs.bShowInterfaces = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SettingsView = EditModule.CreateStructureDetailView(DetailsViewArgs, StructureViewArgs, <span class="literal">nullptr</span>);</span><br><span class="line">FStructOnScope* Struct = <span class="keyword">new</span> FStructOnScope(FExportReleaseSettings::StaticStruct(), (uint8*)ExportReleaseSettings.Get());</span><br><span class="line">SettingsView-&gt;GetOnFinishedChangingPropertiesDelegate().AddRaw(ExportReleaseSettings.Get(),&amp;FExportReleaseSettings::OnFinishedChangingProperties);</span><br><span class="line">SettingsView-&gt;SetStructureData(MakeShareable(Struct));</span><br></pre></td></tr></table></figure>
<p>关键是这行代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SettingsView-&gt;GetOnFinishedChangingPropertiesDelegate().AddRaw(ExportReleaseSettings.Get(),&amp;FExportReleaseSettings::OnFinishedChangingProperties);</span><br></pre></td></tr></table></figure>
<p>把当前DetailsView的属性变动事件绑定到<code>OnFinishedChangingProperties</code>上。</p>
<h2 id="从指定Pak加载文件"><a href="#从指定Pak加载文件" class="headerlink" title="从指定Pak加载文件"></a>从指定Pak加载文件</h2><p>具体可以看<code>FPakPlatformFile::OpenRead</code>的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IFileHandle* <span class="title">FPakPlatformFile::OpenRead</span><span class="params">(<span class="keyword">const</span> TCHAR* Filename, <span class="keyword">bool</span> bAllowWrite)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IFileHandle* Result = <span class="literal">NULL</span>;</span><br><span class="line">	FPakFile* PakFile = <span class="literal">NULL</span>;</span><br><span class="line">	FPakEntry FileEntry;</span><br><span class="line">	<span class="keyword">if</span> (FindFileInPakFiles(Filename, &amp;PakFile, &amp;FileEntry))</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PAK_TRACKER</span></span><br><span class="line">		TrackPak(Filename, &amp;FileEntry);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		Result = CreatePakFileHandle(Filename, PakFile, &amp;FileEntry);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (Result)</span><br><span class="line">		&#123;</span><br><span class="line">			FCoreDelegates::OnFileOpenedForReadFromPakFile.Broadcast(*PakFile-&gt;GetFilename(), Filename);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (IsNonPakFilenameAllowed(Filename))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Default to wrapped file</span></span><br><span class="line">			Result = LowerLevel-&gt;OpenRead(Filename, bAllowWrite);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先通过文件名拿到传入文件在所有Mounted的pak中最大Order的Pak文件，然后使用<code>CreatePakFileHandle</code>从Pak文件中读取文件。<br><code>FPakFile</code>描述的是Pak文件，<code>FPakEntry</code>描述的是Pak中文件的信息，比如大小、偏移等。通过<code>FPakFile</code>和<code>FPakEntry</code>可以从指定的Pak中读取指定的文件。</p>
<h2 id="WITH-EDITOR包裹反射属性的问题"><a href="#WITH-EDITOR包裹反射属性的问题" class="headerlink" title="WITH_EDITOR包裹反射属性的问题"></a>WITH_EDITOR包裹反射属性的问题</h2><p>有时只想要一些属性在编辑器下存在，打包时不需要，按照常规的思路，需要对这些属性使用<code>WITH_EDITOR</code>包裹：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	UPROPERTY()</span><br><span class="line">      int32 ival;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这个代码在Editor的Configuration下没有问题，但是一旦编译非Editor就会产生如下错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Build/Win64/FGame/Inc/FGame/NetActor.gen.cpp(97): error C2039: &#x27;ival&#x27;: is not a member of &#x27;ANetActor&#x27;</span><br></pre></td></tr></table></figure>
<p>那么，既然我们明明已经用<code>WITH_EDITOR</code>包裹了<code>ival</code>的属性，为什么在编译非Editor的时候UHT还会为这个属性生成反射代码呢？<br>这个问题涉及到了以下几个概念：</p>
<ol>
<li>gen.cpp中是UHT为反射标记的类和属性生成的反射信息</li>
<li>UHT的生成流程在调用编译器之前</li>
</ol>
<p>UE构建系统的流程我之前做过分析：<a href="https://imzlp.com/posts/6362/">Build flow of the Unreal Engine4 project</a></p>
<p>因为C++的宏是在调用编译器后预处理阶段做的事情，在执行UHT时，压根不会检测宏条件，所以上面的代码，UHT依然会为<code>ival</code>生成反射信息到<code>gen.cpp</code>中，而UHT执行完毕之后进入编译阶段<code>WITH_EDITOR</code>会参与预处理，<code>ival</code>因此在类定义中不存在，但是UHT已经为它生成了反射代码，会通过获取成员函数指针的方式访问到它，进而产生了上述的编译错误。</p>
<p>所以这是UE反射代码生成先于预处理造成的问题，在写代码时是比较反直觉的。但是这个问题也并非不能解决，UE提供了<code>WITH_EDITORONLY_DATA</code>宏来专门处理这个问题，一个宏解决不了，就引入一个新的。</p>
<p>但是为什么<code>WITH_EDITOR</code>不可以，而<code>WITH_EDITORONLY_DATA</code>就可以呢？因为UHT在生成反射代码时为<code>WITH_EDITORONLY_DATA</code>做了特殊检测：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FNativeClassHeaderGenerator::ExportProperties</span><span class="params">(FOutputDevice&amp; Out, UStruct* Struct, int32 TextIndent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FProperty*	Previous			= <span class="literal">NULL</span>;</span><br><span class="line">	FProperty*	PreviousNonEditorOnly = <span class="literal">NULL</span>;</span><br><span class="line">	FProperty*	LastInSuper			= <span class="literal">NULL</span>;</span><br><span class="line">	UStruct*	InheritanceSuper	= Struct-&gt;GetInheritanceSuper();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Find last property in the lowest base class that has any properties</span></span><br><span class="line">	UStruct* CurrentSuper = InheritanceSuper;</span><br><span class="line">	<span class="keyword">while</span> (LastInSuper == <span class="literal">NULL</span> &amp;&amp; CurrentSuper)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>( TFieldIterator&lt;FProperty&gt; It(CurrentSuper,EFieldIteratorFlags::ExcludeSuper); It; ++It )</span><br><span class="line">		&#123;</span><br><span class="line">			FProperty* Current = *It;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Disregard properties with 0 size like functions.</span></span><br><span class="line">			<span class="keyword">if</span>( It.GetStruct() == CurrentSuper &amp;&amp; Current-&gt;ElementSize )</span><br><span class="line">			&#123;</span><br><span class="line">				LastInSuper = Current;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// go up a layer in the hierarchy</span></span><br><span class="line">		CurrentSuper = CurrentSuper-&gt;GetSuperStruct();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">FMacroBlockEmitter <span class="title">WithEditorOnlyData</span><span class="params">(Out, TEXT(<span class="string">&quot;WITH_EDITORONLY_DATA&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Iterate over all properties in this struct.</span></span><br><span class="line">	<span class="keyword">for</span>( TFieldIterator&lt;FProperty&gt; It(Struct, EFieldIteratorFlags::ExcludeSuper); It; ++It )</span><br><span class="line">	&#123;</span><br><span class="line">		FProperty* Current = *It;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Disregard properties with 0 size like functions.</span></span><br><span class="line">		<span class="keyword">if</span> (It.GetStruct() == Struct)</span><br><span class="line">		&#123;</span><br><span class="line">			WithEditorOnlyData(Current-&gt;IsEditorOnlyProperty());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Export property specifiers</span></span><br><span class="line">			<span class="comment">// Indent code and export CPP text.</span></span><br><span class="line">			&#123;</span><br><span class="line">				FUHTStringBuilder JustPropertyDecl;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">const</span> FString* Dim = GArrayDimensions.Find(Current);</span><br><span class="line">				Current-&gt;ExportCppDeclaration( JustPropertyDecl, EExportedDeclaration::Member, Dim ? **Dim : <span class="literal">NULL</span>);</span><br><span class="line">				ApplyAlternatePropertyExportText(*It, JustPropertyDecl, EExportingState::TypeEraseDelegates);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Finish up line.</span></span><br><span class="line">				Out.Logf(TEXT(<span class="string">&quot;%s%s;\r\n&quot;</span>), FCString::Tab(TextIndent + <span class="number">1</span>), *JustPropertyDecl);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			LastInSuper	= <span class="literal">NULL</span>;</span><br><span class="line">			Previous = Current;</span><br><span class="line">			<span class="keyword">if</span> (!Current-&gt;IsEditorOnlyProperty())</span><br><span class="line">			&#123;</span><br><span class="line">				PreviousNonEditorOnly = Current;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看下<code>FMacroBlockEmitter</code>的定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FMacroBlockEmitter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">FMacroBlockEmitter</span><span class="params">(FOutputDevice&amp; InOutput, <span class="keyword">const</span> TCHAR* InMacro)</span></span></span><br><span class="line"><span class="function">        : <span class="title">Output</span><span class="params">(InOutput)</span></span></span><br><span class="line">        , bEmittedIf(false)</span><br><span class="line">        , Macro(InMacro)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~FMacroBlockEmitter()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (bEmittedIf)</span><br><span class="line">		&#123;</span><br><span class="line">			Output.Logf(TEXT(<span class="string">&quot;#endif // %s\r\n&quot;</span>), Macro);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">bool</span> bInBlock)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!bEmittedIf &amp;&amp; bInBlock)</span><br><span class="line">		&#123;</span><br><span class="line">			Output.Logf(TEXT(<span class="string">&quot;#if %s\r\n&quot;</span>), Macro);</span><br><span class="line">			bEmittedIf = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (bEmittedIf &amp;&amp; !bInBlock)</span><br><span class="line">		&#123;</span><br><span class="line">			Output.Logf(TEXT(<span class="string">&quot;#endif // %s\r\n&quot;</span>), Macro);</span><br><span class="line">			bEmittedIf = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FMacroBlockEmitter(<span class="keyword">const</span> FMacroBlockEmitter&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">	FMacroBlockEmitter&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> FMacroBlockEmitter&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	FOutputDevice&amp; Output;</span><br><span class="line">	<span class="keyword">bool</span> bEmittedIf;</span><br><span class="line">	<span class="keyword">const</span> TCHAR* Macro;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当生成代码时会为使用<code>WITH_EDITORONLY_DATA</code>包裹的属性在<code>gen.cpp</code>中添加<code>WITH_EDITORONLY_DATA</code>宏（有点套娃的感觉），使<code>gen.cpp</code>在非EDITOR下编译时也不会把这部分反射代码参与真正的编译，从而解决了上面的问题。</p>
<h2 id="Android获取已安装App的Apk路径"><a href="#Android获取已安装App的Apk路径" class="headerlink" title="Android获取已安装App的Apk路径"></a>Android获取已安装App的Apk路径</h2><p>有个需求，需要在运行时获取到，App的Apk路径，查了一下UE里没有现成的接口，只能用JNI调用从Java那边想办法了。<br>通过在Android Developer上查找，发现<a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/pm/ApplicationInfo#sourceDir">ApplicationInfo</a>中具有<code>sourceDir</code>属性，记录着APK的路径。<br>而可以通过<code>PackageManager</code>调用<a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/content/pm/PackageManager#getApplicationInfo(java.lang.String,%20int)">getApplicationInfo</a>可以获取指定包名的ApplicationInfo。</p>
<p>那么就好说了，UPL里java代码走起：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">AndroidThunkJava_GetInstalledApkPath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Context context = getApplicationContext();</span><br><span class="line">    PackageManager packageManager = context.getPackageManager();</span><br><span class="line">    ApplicationInfo appInfo;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        appInfo = packageManager.getApplicationInfo(context.getPackageName(),PackageManager.GET_META_DATA);</span><br><span class="line">        <span class="keyword">return</span> appInfo.sourceDir;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (PackageManager.NameNotFoundException e)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;invalid&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在UE里使用JNI调用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (JNIEnv* Env = FAndroidApplication::GetJavaEnv())</span><br><span class="line">&#123;</span><br><span class="line">	jmethodID GetInstalledPakPathMethodID = FJavaWrapper::FindMethod(Env, FJavaWrapper::GameActivityClassID, <span class="string">&quot;AndroidThunkJava_GetInstalledApkPath&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">	FString ResultApkPath = FJavaHelperEx::FStringFromLocalRef(Env, (jstring)FJavaWrapper::CallObjectMethod(Env, FJavaWrapper::GameActivityThis,GetInstalledPakPathMethodID));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>FJavaHelperEx::FStringFromLocalRef</code>是我封装的从jstring到FString的转换函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> FJavaHelperEx</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">FString <span class="title">FStringFromParam</span><span class="params">(JNIEnv* Env, jstring JavaString)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!Env || !JavaString || Env-&gt;IsSameObject(JavaString, <span class="literal">NULL</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">auto</span> chars = Env-&gt;GetStringUTFChars(JavaString, <span class="number">0</span>);</span><br><span class="line">		<span class="function">FString <span class="title">ReturnString</span><span class="params">(UTF8_TO_TCHAR(chars))</span></span>;</span><br><span class="line">		Env-&gt;ReleaseStringUTFChars(JavaString, chars);</span><br><span class="line">		<span class="keyword">return</span> ReturnString;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">FString <span class="title">FStringFromLocalRef</span><span class="params">(JNIEnv* Env, jstring JavaString)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		FString ReturnString = FStringFromParam(Env, JavaString);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (Env &amp;&amp; JavaString)</span><br><span class="line">		&#123;</span><br><span class="line">			Env-&gt;DeleteLocalRef(JavaString);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> ReturnString;</span><br><span class="line">    </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取的结果：<br><img data-src="index/2020/20201016112348.webp"></p>
<h2 id="Cook资源"><a href="#Cook资源" class="headerlink" title="Cook资源"></a>Cook资源</h2><p>可以看CookOnTheFlyServer.cpp中的代码：</p>
<figure class="highlight cpp"><figcaption><span>Editor/UnrealEd/Private/CookOnTheFlyServer.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">UCookOnTheFlyServer::FullLoadAndSave</span><span class="params">(uint32&amp; CookedPackageCount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (bCookPackage)</span><br><span class="line">    &#123;</span><br><span class="line">        FString PlatFilename = Filename.Replace(TEXT(<span class="string">&quot;[Platform]&quot;</span>), *Target-&gt;PlatformName());</span><br><span class="line"></span><br><span class="line">        UE_CLOG(GCookProgressDisplay &amp; (int32)ECookProgressDisplayMode::PackageNames, LogCook, Display, TEXT(<span class="string">&quot;Cooking %s -&gt; %s&quot;</span>), *Package-&gt;GetName(), *PlatFilename);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">bool</span> bSwap = (!Target-&gt;IsLittleEndian()) ^ (!PLATFORM_LITTLE_ENDIAN);</span><br><span class="line">        <span class="keyword">if</span> (!Target-&gt;HasEditorOnlyData())</span><br><span class="line">        &#123;</span><br><span class="line">            Package-&gt;SetPackageFlags(PKG_FilterEditorOnly);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Package-&gt;ClearPackageFlags(PKG_FilterEditorOnly);</span><br><span class="line">        &#125;</span><br><span class="line">								</span><br><span class="line">        GIsCookerLoadingPackage = <span class="literal">true</span>;</span><br><span class="line">        FSavePackageResultStruct SaveResult = GEditor-&gt;Save(Package, World, FlagsToCook, *PlatFilename, GError, <span class="literal">NULL</span>, bSwap, <span class="literal">false</span>, SaveFlags, Target, FDateTime::MinValue(), <span class="literal">false</span>);</span><br><span class="line">        GIsCookerLoadingPackage = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SaveResult == ESavePackageResult::Success &amp;&amp; UAssetManager::IsValid())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!UAssetManager::Get().VerifyCanCookPackage(Package-&gt;GetFName()))</span><br><span class="line">            &#123;</span><br><span class="line">                SaveResult = ESavePackageResult::Error;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">bool</span> bSucceededSavePackage = (SaveResult == ESavePackageResult::Success || SaveResult == ESavePackageResult::GenerateStub || SaveResult == ESavePackageResult::ReplaceCompletely);</span><br><span class="line">        <span class="keyword">if</span> (bSucceededSavePackage)</span><br><span class="line">        &#123;</span><br><span class="line">            FAssetRegistryGenerator* Generator = PlatformManager-&gt;GetPlatformData(Target)-&gt;RegistryGenerator.Get();</span><br><span class="line">            UpdateAssetRegistryPackageData(Generator, Package-&gt;GetFName(), SaveResult);</span><br><span class="line"></span><br><span class="line">            FPlatformAtomics::InterlockedIncrement(&amp;ParallelSavedPackages);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SaveResult != ESavePackageResult::ReferencedOnlyByEditorOnlyData)</span><br><span class="line">        &#123;</span><br><span class="line">            SavePackageSuccessPerPlatform[PlatformIndex] = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            SavePackageSuccessPerPlatform[PlatformIndex] = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Compile对Instanced的替换调用栈"><a href="#Compile对Instanced的替换调用栈" class="headerlink" title="Compile对Instanced的替换调用栈"></a>Compile对Instanced的替换调用栈</h2><p>在这个函数中会收集到当前资源被修改后，依赖它的资源，存储在<code>Dependencies</code>数组中。<br><img data-src="index/2020/20201014165139.webp"></p>
<p>得到<code>Dependencies</code>之后，会在<code>FBlueprintCompileReinstancer::UpdateBytecodeReferences</code>中使用：<br><img data-src="index/2020/20201014171310.webp"></p>
<h2 id="对资源点击Compile的调用栈"><a href="#对资源点击Compile的调用栈" class="headerlink" title="对资源点击Compile的调用栈"></a>对资源点击Compile的调用栈</h2><p>会执行到<code>FKismetEditorUtilities::CompileBlueprint</code>：</p>
<figure class="highlight cpp"><figcaption><span>Editor/UnrealEd/Private/Kismet2/Kismet2.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FKismetEditorUtilities::CompileBlueprint</span><span class="params">(UBlueprint* BlueprintObj, EBlueprintCompileOptions CompileFlags, FCompilerResultsLog* pResults)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DECLARE_SCOPE_HIERARCHICAL_COUNTER_FUNC()</span><br><span class="line"></span><br><span class="line">	FBlueprintCompilationManager::CompileSynchronously(FBPCompileRequest(BlueprintObj, CompileFlags, pResults));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="index/2020/20201014141219.webp"></p>
<h2 id="UMG的子控件引用热更问题"><a href="#UMG的子控件引用热更问题" class="headerlink" title="UMG的子控件引用热更问题"></a>UMG的子控件引用热更问题</h2><p>UMG的UserWidget如果UI_A添加了另一个UserWidget UI_B，它们并不是先创建了UI_A，再去创建加载UI_B的资源并创建，UMG的子控件是以Instanced的方式创建的，相当于UI_A中存储的只是当时UI_B的一份示例，并不涉及资源的直接引用。这样会导致在热更时，如果我们只修改了UI_B，此时并没有造成UI_A资源变动，Cook和打包时如果只把UI_B打包，其实对UI_A是没有效果的，并不会有相应的变动。<br>这是UE Asset和Instanced没有区分的问题，资源并没有修改，但是实际上却对它造成了变化。解决的办法只能在修改了子控件后把使用Instanced方式引用的父控件一起Cook打包，才能有正确的效果。</p>
<h2 id="注意环形引用导致的宏未定义错误"><a href="#注意环形引用导致的宏未定义错误" class="headerlink" title="注意环形引用导致的宏未定义错误"></a>注意环形引用导致的宏未定义错误</h2><p>在UE中发现编译报错宏的未定义错误，但是发现头文件已经被包含了，照常是不会出现问题的，如果出现这个问题，检查下代码中是否有头文件的环形引用，解决之后即可。<br>猜测的原因是环形引用导致预处理爆栈没有包含到真正的宏定义头文件，从而产生了编译错误。</p>
<h2 id="监听Slate的输入事件"><a href="#监听Slate的输入事件" class="headerlink" title="监听Slate的输入事件"></a>监听Slate的输入事件</h2><p>UE提供了注册Listener的方法，通过<code>FSlateApplication::Get()</code>进行注册：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">InputProcessor = MakeShared&lt;FTranslationPickerInputProcessor&gt;(<span class="keyword">this</span>);</span><br><span class="line">FSlateApplication::Get().RegisterInputPreProcessor(InputProcessor, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p><code>RegisterInputPreProcessor</code>接收的第一个参数是<code>TSharedPtr&lt;class IInputProcessor&gt;</code>，它是一个接口类型，第二个参数是插入Listener的位置，默认是插入到尾部。</p>
<p><code>IInputProcessor</code>提供的接口：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Slate/Public/Framework/Application/IInputProcessor.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Interface for a Slate Input Handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SLATE_API</span> <span class="title">IInputProcessor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	IInputProcessor()&#123;&#125;;</span><br><span class="line">	<span class="keyword">virtual</span> ~IInputProcessor()&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Tick</span><span class="params">(<span class="keyword">const</span> <span class="keyword">float</span> DeltaTime, FSlateApplication&amp; SlateApp, TSharedRef&lt;ICursor&gt; Cursor)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Key down input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleKeyDownEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FKeyEvent&amp; InKeyEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Key up input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleKeyUpEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FKeyEvent&amp; InKeyEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Analog axis input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleAnalogInputEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FAnalogInputEvent&amp; InAnalogInputEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Mouse movement input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMouseMoveEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FPointerEvent&amp; MouseEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Mouse button press */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMouseButtonDownEvent</span><span class="params">( FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FPointerEvent&amp; MouseEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Mouse button release */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMouseButtonUpEvent</span><span class="params">( FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FPointerEvent&amp; MouseEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Mouse button double clicked. */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMouseButtonDoubleClickEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FPointerEvent&amp; MouseEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Mouse wheel input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMouseWheelOrGestureEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FPointerEvent&amp; InWheelEvent, <span class="keyword">const</span> FPointerEvent* InGestureEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Called when a motion-driven device has new input */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">HandleMotionDetectedEvent</span><span class="params">(FSlateApplication&amp; SlateApp, <span class="keyword">const</span> FMotionEvent&amp; MotionEvent)</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们可以通过继承它来实现自己的监听需求。</p>
<h2 id="修改LaunchScreen视频比例"><a href="#修改LaunchScreen视频比例" class="headerlink" title="修改LaunchScreen视频比例"></a>修改LaunchScreen视频比例</h2><p>当使用<code>Project Settings</code>-<code>Project</code>-<code>Movies</code>中来为游戏启动时播放视频时，默认情况下是锁定视频的长宽比的，在全面屏流行的现在，长宽比为2.x的比比皆是，锁定视频比例会导致两侧有黑边，所以希望视频能够拉伸来适应屏幕的大小。<br><img data-src="index/2020/20201009210924.webp"><br>需要修改引擎的代码：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/MoviePlayer/Private/DefaultGameMoviePlayer.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FVector2D <span class="title">FDefaultGameMoviePlayer::GetMovieSize</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> FVector2D ScreenSize = MainWindow.Pin()-&gt;GetClientSizeInScreen();</span><br><span class="line">	<span class="comment">// if (MovieStreamingIsPrepared() &amp;&amp; ActiveMovieStreamer.IsValid())</span></span><br><span class="line">	<span class="comment">// &#123;</span></span><br><span class="line">	<span class="comment">// 	const float MovieAspectRatio = ActiveMovieStreamer-&gt;GetAspectRatio();</span></span><br><span class="line">	<span class="comment">// 	const float ScreenAspectRatio = ScreenSize.X / ScreenSize.Y;</span></span><br><span class="line">	<span class="comment">// 	if (MovieAspectRatio &lt; ScreenAspectRatio)</span></span><br><span class="line">	<span class="comment">// 	&#123;</span></span><br><span class="line">	<span class="comment">// 		return FVector2D(ScreenSize.Y * MovieAspectRatio, ScreenSize.Y);</span></span><br><span class="line">	<span class="comment">// 	&#125;</span></span><br><span class="line">	<span class="comment">// 	else</span></span><br><span class="line">	<span class="comment">// 	&#123;</span></span><br><span class="line">	<span class="comment">// 		return FVector2D(ScreenSize.X, ScreenSize.X / MovieAspectRatio);</span></span><br><span class="line">	<span class="comment">// 	&#125;</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// No movie, so simply return the size of the window</span></span><br><span class="line">	<span class="keyword">return</span> ScreenSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把<code>FDefaultGameMoviePlayer::GetMovieSize()</code>修改为上面的代码，其实就是把从视频获取长宽的代码去掉，强制使用窗口的大小。</p>
<h2 id="Rider传递命令行参数"><a href="#Rider传递命令行参数" class="headerlink" title="Rider传递命令行参数"></a>Rider传递命令行参数</h2><p>在VS中有<code>UnrealVS</code>可以方便地给工程传递命令行参数，但是Rider中要复杂一点。<br>要选择<code>Run</code>-<code>Edit Configurations</code>，在弹出窗口的左侧选择要修改的工程，右侧的<code>Program Arguments</code>则是传递给程序的参数：<br><img data-src="index/2020/20201009202629.webp"></p>
<p>为了方便编辑，可以把<code>Edit Configurations</code>添加到Toolbar中，在Toolbar上点击右键，点击<code>Customize Menus and Toolbars</code>，在弹出的<code>Menus and Toolbars</code>窗口中，把<code>Edit Configurations</code>添加至<code>Toolbar Run Actions</code>中即可。<br><img data-src="index/2020/20201009202816.webp"></p>
<h2 id="IOS自动化导入Certificate和Provision"><a href="#IOS自动化导入Certificate和Provision" class="headerlink" title="IOS自动化导入Certificate和Provision"></a>IOS自动化导入Certificate和Provision</h2><p>传统的打包ios时，需要手动在<code>Project Settings</code>-<code>Platforms</code>-<code>IOS</code>中选择打包要使用的<code>Certificate</code>和<code>Provision</code>，当需要切换打包Configuration的时候就需要打开编辑器重新选择一遍（因为Development和Shipping用到的证书不同），很麻烦，我是一个非常讨厌做重复操作的人，所以研究了一下解决了这个问题。<br>也是得益于UE本身提供了代码中导入<code>Certificate</code>和<code>Provision</code>的方式（之前我还写了自动化把证书导入到系统中，其实不用了）。<br>在前面的笔记中提到过UE的Target也提供了平台相关的Target对象：<a href="https://imzlp.com/notes/ue/#%E5%B9%B3%E5%8F%B0%E7%9B%B8%E5%85%B3Target">平台相关Target</a>，要实现本文提到的需求就要通过控制<code>IOSPlatform</code>来实现。</p>
<p><code>IOSPlatform</code>提供了以下几个属性：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Platform/UEBuildIOS.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Manual override for the provision to use. Should be a full path.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-ImportProvision=&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">string</span> ImportProvision = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Imports the given certificate (inc private key) into a temporary keychain before signing.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-ImportCertificate=&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">string</span> ImportCertificate = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Password for the imported certificate</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-ImportCertificatePassword=&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">string</span> ImportCertificatePassword = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<p>通过操作它们的值来实现自动化导入证书和Provision，我写了一段使用代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FGameTarget</span> : <span class="title">TargetRules</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FGameTarget</span>(<span class="params"> TargetInfo Target</span>) : <span class="title">base</span>(<span class="params">Target</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    Type = TargetType.Game;</span><br><span class="line">    DefaultBuildSettings = BuildSettingsVersion.V1;</span><br><span class="line">    ExtraModuleNames.AddRange( <span class="keyword">new</span> <span class="keyword">string</span>[] &#123; <span class="string">&quot;FGame&quot;</span> &#125; );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for package dSYM</span></span><br><span class="line">    bDisableDebugInfo = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(Target.Platform == UnrealTargetPlatform.IOS)</span><br><span class="line">    &#123;</span><br><span class="line">      DirectoryReference ProjectDir = ProjectFile.Directory;</span><br><span class="line">      IOSPlatform.bGeneratedSYM = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">string</span> PackageConfiguration = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// import cer/provision</span></span><br><span class="line">      <span class="keyword">switch</span> (Target.Configuration)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Debug:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Development:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Test:</span><br><span class="line">        &#123;</span><br><span class="line">          PackageConfiguration = <span class="string">&quot;Development&quot;</span>;</span><br><span class="line">          IOSPlatform.bForDistribution = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Shipping:</span><br><span class="line">        &#123;</span><br><span class="line">          PackageConfiguration = <span class="string">&quot;Distibution&quot;</span>;</span><br><span class="line">          IOSPlatform.bForDistribution = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">string</span> cerPath = Path.Combine(ProjectDir.FullName, <span class="string">&quot;Source/ThirdParty/iOS/&quot;</span>,PackageConfiguration,<span class="string">&quot;XXXXXX_IOS.p12&quot;</span>);</span><br><span class="line">      <span class="keyword">string</span> proversionPath = Path.Combine(ProjectDir.FullName, <span class="string">&quot;Source/ThirdParty/iOS/&quot;</span>,PackageConfiguration,<span class="string">&quot;com.tencent.xxxx.xx_SignProvision.mobileprovision&quot;</span>);</span><br><span class="line">      <span class="keyword">string</span> cerPassword = <span class="string">&quot;password&quot;</span>;</span><br><span class="line">      </span><br><span class="line">      Console.WriteLine(<span class="string">&quot;Import Certificate:&quot;</span>+cerPath);</span><br><span class="line">      Console.WriteLine(<span class="string">&quot;Import Provision:&quot;</span>+proversionPath);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (File.Exists(cerPath) &amp;&amp; File.Exists(proversionPath))</span><br><span class="line">      &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Import Certificate &amp; Provision set to IOSPlatform&quot;</span>);</span><br><span class="line">        IOSPlatform.ImportCertificate = cerPath;</span><br><span class="line">        IOSPlatform.ImportProvision = proversionPath;</span><br><span class="line">        IOSPlatform.ImportCertificatePassword = cerPassword;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在打包IOS时就会自动使用所指定的证书了，并且会在Shipping时自动化启用<code>Distribution</code>，这样就可以避免要事先把证书和<code>provision</code>导入到系统中。</p>
<h2 id="Mac打包iOS的codesign错误"><a href="#Mac打包iOS的codesign错误" class="headerlink" title="Mac打包iOS的codesign错误"></a>Mac打包iOS的codesign错误</h2><p>在Mac上直接打包iOS时遇到以下错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">2020-09-27 19:23:48:778 :         /usr/bin/codesign --force --sign 2C74981D1576F95021XXXXXXXXXXA7ECBD8A81A0 --entitlements /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Intermediate/ProjectFilesIOS/build/FGame.build/Development-iphoneos/FGame.build/FGame.app.xcent --timestamp=none /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Binaries/IOS/Payload/FGame.app</span><br><span class="line">2020-09-27 19:23:59:896 :     /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Binaries/IOS/Payload/FGame.app: errSecInternalComponent</span><br><span class="line">2020-09-27 19:23:59:896 :     Command /usr/bin/codesign failed with <span class="built_in">exit</span> code 1</span><br><span class="line">2020-09-27 19:23:59:896 :   </span><br><span class="line">2020-09-27 19:23:59:899 :     ** BUILD FAILED **</span><br><span class="line">2020-09-27 19:23:59:899 : </span><br><span class="line">2020-09-27 19:23:59:899 :     The following build commands failed:</span><br><span class="line">2020-09-27 19:23:59:899 :     	CodeSign /Users/buildmachine/Documents/BuildWorkspace/workspace/PackageClient/Client/Binaries/IOS/Payload/FGame.app</span><br><span class="line">2020-09-27 19:23:59:900 :     (1 failure)</span><br><span class="line">2020-09-27 19:23:59:915 :   Took 15.181822s to run env, ExitCode=65</span><br><span class="line">2020-09-27 19:23:59:920 :   ERROR: CodeSign Failed</span><br><span class="line">2020-09-27 19:23:59:920 :          (see /Users/buildmachine/Library/Logs/Unreal Engine/LocalBuildLogs/BuildCookRun/Log.txt <span class="keyword">for</span> full exception trace)</span><br><span class="line">2020-09-27 19:23:59:922 :   AutomationTool exiting with ExitCode=32 (Error_FailedToCodeSign)</span><br><span class="line">2020-09-27 19:23:59:962 : Took 568.832115s to run mono, ExitCode=32</span><br><span class="line">2020-09-27 19:23:59:974 : AutomationTool exiting with ExitCode=1 (Error_Unknown)</span><br><span class="line">2020-09-27 19:24:00:010 : RunUAT ERROR: AutomationTool was unable to run successfully.</span><br></pre></td></tr></table></figure>
<p>可以看到是执行codesign的时候遇到了错误导致打包失败的。</p>
<p>这是因为打包时会访问钥匙串，需要输入密码授权，如果弹窗之后没有授权就会导致codesign执行失败。Stack overflow上有相同的问题：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/24023639/xcode-command-usr-bin-codesign-failed-with-exit-code-1-errsecinternalcomponen">Xcode Command /usr/bin/codesign failed with exit code 1 : errSecInternalComponent</a></p>
<p><img data-src="index/2020/20200927204452.webp"></p>
<p>解决方案有三种：</p>
<ol>
<li>在打包时的弹窗中输入密码解锁钥匙串</li>
<li>在打包之前的解锁钥匙串</li>
<li>在弹窗中输入密码后选择始终允许codesign访问钥匙串</li>
</ol>
<p>解锁钥匙串使用以下终端命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ security unlock-keychain login.keychain</span><br></pre></td></tr></table></figure>

<h2 id="VirtualCamera"><a href="#VirtualCamera" class="headerlink" title="VirtualCamera"></a>VirtualCamera</h2><p>可以使用UE4+支持ARKit的设备来实现通过获取iOS设备的设备位置信息来控制游戏中的相机，从而实现类似虚拟制片的相机追踪效果。官方文档：<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Plugins/VirtualCameraPlugin/index.html">VirtualCameraPlugin</a></p>
<p>首先，支持ARKit的设备在Apple的网站上有列出：<a target="_blank" rel="noopener" href="https://www.apple.com/augmented-reality/">Augmented Reality - Apple</a>，以下设备支持：</p>
<p><img data-src="index/2020/20200925185142.webp"></p>
<blockquote>
<p>ARKit 3.0 is only supported on devices with iOS 13, A12/A12X Bionic chips (or later), the Apple Neural Engine (ANE), and a TrueDepth Camera, such as the iPhone XS, iPhone XS Max, iPhone XR, and the 11-inch and 12.9-inch 2018 iPad Pros.</p>
</blockquote>
<p>刚好我的iPad Air3在支持之列。而且目前预览版的UE4.26，支持了ARKit3.5</p>
<p>需要在UE项目中启用三个插件：</p>
<ul>
<li>VirtualCamera</li>
<li>Apple ARKit</li>
<li>RemoteSession</li>
<li>iOS设备安装<a target="_blank" rel="noopener" href="https://itunes.apple.com/us/app/unreal-remote-2/id1374517532">Unreal Remote 2</a></li>
</ul>
<p>操作方法为：打开地图，编辑地图所使用的GameMode为<code>VirtualCameraGameMode</code>，在iPad上打开<a target="_blank" rel="noopener" href="https://itunes.apple.com/us/app/unreal-remote-2/id1374517532">Unreal Remote 2</a>输入PC的IP地址，连接成功后在UE编辑器内Play，游戏画面就会传递到iPad，iPad的设备位置和旋转就会回传到UE里控制编辑器内的相机。</p>
<p>这是UE默认提供的方案，但是我后面想要iPad可以与Oculus Quest结合起来，其实问题的关键点在于需要获取到ARKit的设备数据，然后通过网络与Oculus Quest通信。<br>目前的思路是：</p>
<ol>
<li>使用UE访问ARKit的设备位置数据在局域网内同步</li>
<li>获取Oculus的设备位置数据</li>
<li>想办法统一坐标系</li>
</ol>
<p>两边都拿到基于地面高度为基准的高度信息是没问题的，但是如何把ARKit设备的XY和Oculus的结合结合起来是个要思考的问题。</p>
<h2 id="升级至AndroidX资料"><a href="#升级至AndroidX资料" class="headerlink" title="升级至AndroidX资料"></a>升级至AndroidX资料</h2><p>看操作方式也是使用UPL来介入打包过程，先记录下。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/961161/androidx-support.html">AndroidX support</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/nineva/how-to-force-the-unreal-engine-android-project-to-use-androidx-f7060abd56ac">How to force the Unreal Engine Android project to use AndroidX?</a></li>
</ul>
<h2 id="远程构建在4-26的问题"><a href="#远程构建在4-26的问题" class="headerlink" title="远程构建在4.26的问题"></a>远程构建在4.26的问题</h2><p>之前的不少笔记中都写到了使用远程构建的方式出iOS的ipa（详见<a href="https://imzlp.com/posts/1948/#%E9%85%8D%E7%BD%AE%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA">UE4开发笔记：Mac/iOS篇#配置远程构建</a>），但是在4.26发现了一个问题，会导致代码的编译和Cook的不一致。<br>再来复习一遍远程构建的流程：</p>
<ol>
<li>把本机的引擎和工程代码上传至Mac</li>
<li>在Mac上执行编译</li>
<li>编译完毕之后在Mac上生成ipa包（但不包含Cook资源）</li>
<li>把生成的ipa包拉回本地，解包，Cook美术资源，再合并为ipa</li>
</ol>
<p>这其中有个关键的点是：代码的编译和Cook是分别在Mac和Win上执行的，这意味着执行这两个操作的引擎分别是Mac版引擎和Win版引擎。</p>
<p>这个问题就在于，目前4.26的一些代码中加入了<code>PLATFORM_IOS || PLATFORM_MAC</code>的宏判断，如果完整的打包过程都是在Mac上执行的，就不会出现问题，因为代码编译和Cook都是调用Mac版引擎的，但是在远程构建时就会出现问题了。会导致在Mac上编译工程代码时<code>PLATFORM_IOS || PLATFORM_MAC</code>这个检查会通过，而在Win上Cook去编译Shader时，因为使用的是Win版引擎，会导致这个宏检查是false，就会导致Cook和代码之间的版本差异，会有Crash。<br>具体错误如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Sep 19 16:48:01 lipengzha-iPhone FGame[1895] &lt;Notice&gt;: [UE4] [2020.09.19-08.48.01:821][  0]LogPakFile: New pak file ..&#x2F;..&#x2F;..&#x2F;FGame&#x2F;Content&#x2F;Paks&#x2F;fgame-ios.pak added to pak precacher.</span><br><span class="line">Sep 19 16:48:01 lipengzha-iPhone FGame[1895] &lt;Notice&gt;: [UE4] Assertion failed: Shader-&gt;Bindings.StructureLayoutHash &#x3D;&#x3D; ParameterStructMetadata-&gt;GetLayoutHash() [File:&#x2F;Users&#x2F;buildmachine&#x2F;UE4&#x2F;Builds&#x2F;lipengzha-PC1&#x2F;C&#x2F;BuildAgent&#x2F;workspace&#x2F;BuildEngine&#x2F;Engine&#x2F;Engine&#x2F;Source&#x2F;Runtime&#x2F;Engine&#x2F;Private&#x2F;ShaderCompiler&#x2F;ShaderCompiler.cpp] [Line: 4308] </span><br><span class="line">Seams shader FPixelProjectedReflectionMobile_ReflectionPassPS&#39;s parameter structure has changed without recompilation of the shader</span><br><span class="line">Sep 19 16:48:01 lipengzha-iPhone FGame[1895] &lt;Notice&gt;: [UE4] [2020.09.19-08.48.01:834][  0]Assertion failed: Shader-&gt;Bindings.StructureLayoutHash &#x3D;&#x3D; ParameterStructMetadata-&gt;GetLayoutHash() [File:&#x2F;Users&#x2F;buildmachine&#x2F;UE4&#x2F;Builds&#x2F;lipengzha-PC1&#x2F;C&#x2F;BuildAgent&#x2F;workspace&#x2F;BuildEngine&#x2F;Engine&#x2F;Engine&#x2F;Source&#x2F;Runtime&#x2F;Engine&#x2F;Private&#x2F;ShaderCompiler&#x2F;ShaderCompiler.cpp] [Line: 4308] </span><br><span class="line">Seams shader FPixelProjectedReflectionMobile_ReflectionPassPS&#39;s parameter structure has changed without recompilation of the shader</span><br></pre></td></tr></table></figure>
<p>导致这个问题的代码：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.26/Engine/Source/Runtime/Renderer/Private/PostProcess/PostProcessPixelProjectedReflectionMobile.h#L15">Renderer/Private/PostProcess/PostProcessPixelProjectedReflectionMobile.h#L15</a>，这个宏在Win和Mac两个引擎是不同的值。<br>不过目前4.26还没有出正式版本，观望正式版会不会修正。</p>
<h2 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h2><p>在UE中，经常需要在C++代码中打印日志，UE也提供了方法来创建出可以通过UE_LOG打印日志的宏。<br>首先，先来看一下UE_LOG是什么，它是个宏，使用的方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE_LOG(LogTemp,Log,TEXT(<span class="string">&quot;&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>它被定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Core/Public/Logging/LogMacros.h#L192">Core/Public/Logging/LogMacros.h</a>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A  macro that outputs a formatted message to log if a given logging category is active at a given verbosity level</span></span><br><span class="line"><span class="comment"> * @param CategoryName name of the logging category</span></span><br><span class="line"><span class="comment"> * @param Verbosity, verbosity level to test against</span></span><br><span class="line"><span class="comment"> * @param Format, format text</span></span><br><span class="line"><span class="comment"> ***/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UE_LOG(CategoryName, Verbosity, Format, ...) \</span></span><br><span class="line">&#123; \</span><br><span class="line">  <span class="keyword">static_assert</span>(TIsArrayOrRefOfType&lt;<span class="keyword">decltype</span>(Format), TCHAR&gt;::Value, <span class="string">&quot;Formatting string must be a TCHAR array.&quot;</span>); \</span><br><span class="line">  <span class="keyword">static_assert</span>((ELogVerbosity::Verbosity &amp; ELogVerbosity::VerbosityMask) &lt; ELogVerbosity::NumVerbosity &amp;&amp; ELogVerbosity::Verbosity &gt; <span class="number">0</span>, <span class="string">&quot;Verbosity must be constant and in range.&quot;</span>); \</span><br><span class="line">  CA_CONSTANT_IF((ELogVerbosity::Verbosity &amp; ELogVerbosity::VerbosityMask) &lt;= ELogVerbosity::COMPILED_IN_MINIMUM_VERBOSITY &amp;&amp; (ELogVerbosity::Warning &amp; ELogVerbosity::VerbosityMask) &lt;= FLogCategory##CategoryName::CompileTimeVerbosity) \</span><br><span class="line">  &#123; \</span><br><span class="line">    UE_LOG_EXPAND_IS_FATAL(Verbosity, PREPROCESSOR_NOTHING, <span class="keyword">if</span> (!CategoryName.IsSuppressed(ELogVerbosity::Verbosity))) \</span><br><span class="line">    &#123; \</span><br><span class="line">      <span class="keyword">auto</span> UE_LOG_noinline_lambda = [](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; LCategoryName, <span class="keyword">const</span> <span class="keyword">auto</span>&amp; LFormat, <span class="keyword">const</span> <span class="keyword">auto</span>&amp;... UE_LOG_Args) FORCENOINLINE \</span><br><span class="line">      &#123; \</span><br><span class="line">        TRACE_LOG_MESSAGE(LCategoryName, Verbosity, LFormat, UE_LOG_Args...) \</span><br><span class="line">        UE_LOG_EXPAND_IS_FATAL(Verbosity, \</span><br><span class="line">          &#123; \</span><br><span class="line">            FMsg::Logf_Internal(UE_LOG_SOURCE_FILE(__FILE__), __LINE__, LCategoryName.GetCategoryName(), ELogVerbosity::Verbosity, LFormat, UE_LOG_Args...); \</span><br><span class="line">            _DebugBreakAndPromptForRemote(); \</span><br><span class="line">            FDebug::ProcessFatalError(); \</span><br><span class="line">          &#125;, \</span><br><span class="line">          &#123; \</span><br><span class="line">            FMsg::Logf_Internal(<span class="literal">nullptr</span>, <span class="number">0</span>, LCategoryName.GetCategoryName(), ELogVerbosity::Verbosity, LFormat, UE_LOG_Args...); \</span><br><span class="line">          &#125; \</span><br><span class="line">        ) \</span><br><span class="line">      &#125;; \</span><br><span class="line">      UE_LOG_noinline_lambda(CategoryName, Format, ##__VA_ARGS__); \</span><br><span class="line">      UE_LOG_EXPAND_IS_FATAL(Verbosity, CA_ASSUME(<span class="literal">false</span>);, PREPROCESSOR_NOTHING) \</span><br><span class="line">    &#125; \</span><br><span class="line">  &#125; \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，使用UE_LOG时传入的第一个参数，是一个对象，后面的参数则是一个枚举值以及输出的Formater，以及更多的参数（用于匹配Formater中的占位符）。</p>
<p>UE提供了几种方法来创建Log的Category：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DECLARE_LOG_CATEGORY_EXTERN(LogCategoryName,All,All);</span><br><span class="line">DECLARE_LOG_CATEGORY_CLASS(LogCategoryName2,All,All);</span><br><span class="line">DECLARE_LOG_CATEGORY_EXTERN_HELPER(LogCategoryName3,All,All);</span><br></pre></td></tr></table></figure>

<p>挨个来看一下它们的定义，其实他们都是定义了一个类，并需要创建出一个对象，可以用来传递给<code>UE_LOG</code>的第一个参数，而后两个参数则都是<code>ELogVerbosity</code>的枚举值，用于给当前的LogCategory指定运行时和编译时的日志等级。<br>看一下这个枚举的定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Enum that defines the verbosity levels of the logging system.</span></span><br><span class="line"><span class="comment"> * Also defines some non-verbosity levels that are hacks that allow</span></span><br><span class="line"><span class="comment"> * breaking on a given log line or setting the color.</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">namespace</span> ELogVerbosity</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">enum</span> Type : uint8</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/** Not used */</span></span><br><span class="line">    NoLogging  = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Always prints a fatal error to console (and log file) and crashes (even if logging is disabled) */</span></span><br><span class="line">    Fatal,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints an error to console (and log file). </span></span><br><span class="line"><span class="comment">     * Commandlets and the editor collect and report errors. Error messages result in commandlet failure.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Error,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints a warning to console (and log file).</span></span><br><span class="line"><span class="comment">     * Commandlets and the editor collect and report warnings. Warnings can be treated as an error.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Warning,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Prints a message to console (and log file) */</span></span><br><span class="line">    Display,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Prints a message to a log file (does not print to console) */</span></span><br><span class="line">    Log,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints a verbose message to a log file (if Verbose logging is enabled for the given category, </span></span><br><span class="line"><span class="comment">     * usually used for detailed logging) </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Verbose,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Prints a verbose message to a log file (if VeryVerbose logging is enabled, </span></span><br><span class="line"><span class="comment">     * usually used for detailed logging that would otherwise spam output) </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    VeryVerbose,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Log masks and special Enum values</span></span><br><span class="line"></span><br><span class="line">    All    = VeryVerbose,</span><br><span class="line">    NumVerbosity,</span><br><span class="line">    VerbosityMask  = <span class="number">0xf</span>,</span><br><span class="line">    SetColor  = <span class="number">0x40</span>, <span class="comment">// not actually a verbosity, used to set the color of an output device </span></span><br><span class="line">    BreakOnLog  = <span class="number">0x80</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以根据自己的需求来指定不同的日志等级。</p>
<h3 id="DECLARE-LOG-CATEGORY-EXTERN"><a href="#DECLARE-LOG-CATEGORY-EXTERN" class="headerlink" title="DECLARE_LOG_CATEGORY_EXTERN"></a>DECLARE_LOG_CATEGORY_EXTERN</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to declare a logging category as a C++ &quot;extern&quot;, usually declared in the header and paired with DEFINE_LOG_CATEGORY in the source. Accessible by all files that include the header.</span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to declare</span></span><br><span class="line"><span class="comment"> * @param DefaultVerbosity, default run time verbosity</span></span><br><span class="line"><span class="comment"> * @param CompileTimeVerbosity, maximum verbosity to compile into the code</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_LOG_CATEGORY_EXTERN(CategoryName, DefaultVerbosity, CompileTimeVerbosity) \</span></span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">FLogCategory</span>##<span class="title">CategoryName</span> :</span> <span class="keyword">public</span> FLogCategory&lt;ELogVerbosity::DefaultVerbosity, ELogVerbosity::CompileTimeVerbosity&gt; \</span><br><span class="line">&#123; \</span><br><span class="line">  FORCEINLINE FLogCategory##CategoryName() : FLogCategory(TEXT(#CategoryName)) &#123;&#125; \</span><br><span class="line">&#125; CategoryName;</span><br></pre></td></tr></table></figure>
<p>如果有以下声明：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE_LOG_CATEGORY_EXTERN(LogCategoryName,All,All);</span><br></pre></td></tr></table></figure>
<p>宏展开之后就为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">FLogCategoryLogCategoryName</span> :</span> <span class="keyword">public</span> FLogCategory&lt;ELogVerbosity::All, ELogVerbosity::All&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">FORCEINLINE <span class="title">FLogCategoryLogCategoryName</span><span class="params">()</span> : <span class="title">FLogCategory</span><span class="params">(TEXT(<span class="string">&quot;LogCategoryName&quot;</span>))</span> </span>&#123;&#125;</span><br><span class="line">&#125; LogCategoryName;</span><br></pre></td></tr></table></figure>
<p>其实就是继承自<code>FLogCategory</code>的一个类定义，并且<strong>声明</strong>了一个<code>LogCategoryName</code>的对象。<br>注意，这里只是声明，还需要定义，不然在编译时会有未定义错误，所以就需要在cpp里写代码进行定义，UE也提供了一个宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEFINE_LOG_CATEGORY(LogCategoryName);</span><br></pre></td></tr></table></figure>
<p>它的定义就很简单了，只是定义一个对象而已：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to define a logging category, usually paired with DECLARE_LOG_CATEGORY_EXTERN from the header.</span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to define</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_LOG_CATEGORY(CategoryName) FLogCategory##CategoryName CategoryName;</span></span><br></pre></td></tr></table></figure>
<p>对象经过定义之后就可以在<code>UE_LOG</code>使用了。<br>这种分离声明和定义的方式可以用在暴露给外部使用的情况，别的文件或者模块只需要包含具有声明的头文件即可。</p>
<h3 id="DECLARE-LOG-CATEGORY-CLASS"><a href="#DECLARE-LOG-CATEGORY-CLASS" class="headerlink" title="DECLARE_LOG_CATEGORY_CLASS"></a>DECLARE_LOG_CATEGORY_CLASS</h3><p><code>DECLARE_LOG_CATEGORY_CLASS</code>宏的实现就比<code>DECLARE_LOG_CATEGORY_EXTERN</code>多做了一些操作，它定义了一个结构并<strong>创建出一个static对象</strong>，不需要自己再使用<code>DEFINE_LOG_CATEGRORY</code>进行定义。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to define a logging category as a C++ &quot;static&quot;. This should ONLY be declared in a source file. Only accessible in that single file.</span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to declare</span></span><br><span class="line"><span class="comment"> * @param DefaultVerbosity, default run time verbosity</span></span><br><span class="line"><span class="comment"> * @param CompileTimeVerbosity, maximum verbosity to compile into the code</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_LOG_CATEGORY_STATIC(CategoryName, DefaultVerbosity, CompileTimeVerbosity) \</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">FLogCategory</span>##<span class="title">CategoryName</span> :</span> <span class="keyword">public</span> FLogCategory&lt;ELogVerbosity::DefaultVerbosity, ELogVerbosity::CompileTimeVerbosity&gt; \</span><br><span class="line">&#123; \</span><br><span class="line">  FORCEINLINE FLogCategory##CategoryName() : FLogCategory(TEXT(#CategoryName)) &#123;&#125; \</span><br><span class="line">&#125; CategoryName;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * A macro to declare a logging category as a C++ &quot;class static&quot; </span></span><br><span class="line"><span class="comment"> * @param CategoryName, category to declare</span></span><br><span class="line"><span class="comment"> * @param DefaultVerbosity, default run time verbosity</span></span><br><span class="line"><span class="comment"> * @param CompileTimeVerbosity, maximum verbosity to compile into the code</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_LOG_CATEGORY_CLASS(CategoryName, DefaultVerbosity, CompileTimeVerbosity) \</span></span><br><span class="line">  DEFINE_LOG_CATEGORY_STATIC(CategoryName, DefaultVerbosity, CompileTimeVerbosity)</span><br></pre></td></tr></table></figure>
<p>它的声明会展开为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">FLogCategoryLogCategoryName</span> :</span> <span class="keyword">public</span> FLogCategory&lt;ELogVerbosity::All, ELogVerbosity::All&gt;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">FORCEINLINE <span class="title">FLogCategoryLogCategoryName</span><span class="params">()</span> : <span class="title">FLogCategory</span><span class="params">(TEXT(<span class="string">&quot;LogCategoryName&quot;</span>))</span> </span>&#123;&#125;</span><br><span class="line">&#125; LogCategoryName;</span><br></pre></td></tr></table></figure>
<p>可以看到，和<code>DECLARE_LOG_CATEGORY_EXTERN</code>的区别在于：</p>
<ol>
<li>去掉了<code>extern</code>修饰符</li>
<li>增加了static修饰符，定义对象</li>
</ol>
<p>使用这个宏的用途一般直接写在.cpp文件中，只供当前的翻译单元使用。</p>
<h3 id="DECLARE-LOG-CATEGORY-EXTERN-HELPER"><a href="#DECLARE-LOG-CATEGORY-EXTERN-HELPER" class="headerlink" title="DECLARE_LOG_CATEGORY_EXTERN_HELPER"></a>DECLARE_LOG_CATEGORY_EXTERN_HELPER</h3><p><code>DECLARE_LOG_CATEGORY_EXTERN_HELPER</code>这个宏只是<code>DECLARE_LOG_CATEGORY_EXTERN</code>的封装，并没有自己做什么特别的事情，和<code>DECLARE_LOG_CATEGORY_EXTERN</code>的用法完全一致。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Platform specific logs, set here to make it easier to use them from anywhere</span></span><br><span class="line"><span class="comment">// need another layer of macro to help using a define in a define</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_LOG_CATEGORY_EXTERN_HELPER(A,B,C) DECLARE_LOG_CATEGORY_EXTERN(A,B,C)</span></span><br></pre></td></tr></table></figure>

<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p><code>DECLARE_LOG_CATEGORY_EXTERN</code>也可以通过<code>XXXX_API</code>的方式修饰并导出符号，使其可以在外部模块中使用。</p>
<h2 id="JNI调用接收ActivityResult"><a href="#JNI调用接收ActivityResult" class="headerlink" title="JNI调用接收ActivityResult"></a>JNI调用接收ActivityResult</h2><p>有时需要通过<code>startActivityForResult</code>来创建<code>Intent</code>来执行一些操作，如打开摄像头、打开相册选择图片等。</p>
<p>但是Android做这些操作的时候不是阻塞在当前的函数中的，所以不能直接在调用的函数里接收这些数据。而通过<code>startActivityForResult</code>执行的Action的结果都会调用到Activity的<code>onActivityResult</code>中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GameActivity.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>UE在UPL中提供了往OnActivityResult追加Java代码的用法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- optional additions to GameActivity onActivityResult in GameActivity.java --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">gameActivityOnActivityResultAdditions</span>&gt;</span>	<span class="tag">&lt;/<span class="name">gameActivityOnActivityResultAdditions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用这种方式添加的Java代码会追加到<code>OnActivityResult</code>函数的末尾，但是这种方式有一个问题，那就是执行了自己追加到<code>OnActivityResult</code>的代码之后，还要处理接收到的结果，并且传递到UE端来，有点麻烦。</p>
<p>经过翻阅代码，发现UE提供了Java端的<code>OnActivityResult</code>的多播代理事件，这样就可以直接在UE里用C++来监听<code>OnActivityResult</code>的事件，自己做处理。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Launch/Puclic/Android/AndroidJNI.h</span></span><br><span class="line">DECLARE_MULTICAST_DELEGATE_SixParams(FOnActivityResult, JNIEnv *, jobject, jobject, jint, jint, jobject);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该代理是定义在`FJavaWrapper`里的</span></span><br><span class="line"><span class="comment">// Delegate that can be registered to that is called when an activity is finished</span></span><br><span class="line"><span class="keyword">static</span> FOnActivityResult OnActivityResultDelegate;</span><br></pre></td></tr></table></figure>
<p>在UE侧就可以通过绑定这个多播代理来监听Java端的<code>OnActivityResult</code>调用，可以在其中做分别的处理。</p>
<p>它由<code>AndroidJNI.cpp</code>中的<code>Java_com_epicgames_ue4_GameActivity_nativeOnActivityResult</code>函数从Java那边调用过来，调用机制在上个笔记中有记录。</p>
<h2 id="Java调C"><a href="#Java调C" class="headerlink" title="Java调C++"></a>Java调C++</h2><p>有些需求和实现需要从Java调到C++这边，可以通过下面这种方式：<br>首先，在GameActivity中新建一个<code>native</code>的java函数声明（不需要定义）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeOnActivityResult</span><span class="params">(GameActivity activity, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span></span>;</span><br></pre></td></tr></table></figure>
<p>然后在C++端按照下面的规则定义一个C++函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNI_METHOD <span class="keyword">void</span> <span class="title">Java_com_epicgames_ue4_GameActivity_nativeOnActivityResult</span><span class="params">(JNIEnv* jenv, jobject thiz, jobject activity, jint requestCode, jint resultCode, jobject data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FJavaWrapper::OnActivityResultDelegate.Broadcast(jenv, thiz, activity, requestCode, resultCode, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到函数名字的规则为：</p>
<ol>
<li>函数前需要加<code>JNI_METHOD</code>修饰，它是一个宏<code>__attribute__ ((visibility (&quot;default&quot;))) extern &quot;C&quot;</code></li>
<li>函数名需要以<code>Java_</code>开头，并且后面跟上<code>com_epicgames_ue4_GameActivity_</code>，标识是定义在<code>GameActivity</code>中的</li>
<li>然后再跟上java中的函数名</li>
</ol>
<p>接受参数的规则：</p>
<ol>
<li>第一个参数是Java的Env</li>
<li>第二个是java里的this</li>
<li>后面的参数以此是从java里传递参数</li>
</ol>
<h2 id="AndroidP的全面屏适配"><a href="#AndroidP的全面屏适配" class="headerlink" title="AndroidP的全面屏适配"></a>AndroidP的全面屏适配</h2><p>在UE4打包的时候，会给项目生成GameActivity.java文件，里面的OnCreate具有适配全面屏的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (UseDisplayCutout)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// will not be true if not Android Pie or later</span></span><br><span class="line">	    WindowManager.LayoutParams params = getWindow().getAttributes();</span><br><span class="line">		params.layoutInDisplayCutoutMode = WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES;</span><br><span class="line">	    getWindow().setAttributes(params);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Android P和之后的系统不支持，所以就要自己写Jni调用来强制让P和之后系统版本支持。<br>在UE4.23+以后的引擎版本，支持了通过UPL往OnCreate函数添加代码，就可以直接把代码插入到GameActivity.java了：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;gameActivityOnCreateFinalAdditions&gt;</span><br><span class="line">&lt;insert&gt;</span><br><span class="line">    <span class="comment">// P版本允许使用刘海</span></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;</span><br><span class="line">    WindowManager.LayoutParams lp = <span class="keyword">this</span>.getWindow().getAttributes();</span><br><span class="line">    lp.layoutInDisplayCutoutMode = WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES;</span><br><span class="line">    <span class="keyword">this</span>.getWindow().setAttributes(lp);</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/insert&gt;</span><br><span class="line">&lt;/gameActivityOnCreateFinalAdditions&gt;</span><br></pre></td></tr></table></figure>

<p>在UE4.23之前不可以给<code>OnCreate</code>添加代码，只能自己写个JNI调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AndroidThunkJava_SetFullScreenDisplayForP</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">final</span> GameActivity Activity = <span class="keyword">this</span>;</span><br><span class="line">	runOnUiThread(<span class="keyword">new</span> Runnable() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> GameActivity InActivity = Activity;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            WindowManager windowManager =  InActivity.getWindowManager();</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) </span><br><span class="line">            &#123;</span><br><span class="line">        </span><br><span class="line">                WindowManager.LayoutParams lp = InActivity.getWindow().getAttributes();</span><br><span class="line">                lp.layoutInDisplayCutoutMode = WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES;</span><br><span class="line">                InActivity.getWindow().setAttributes(lp);</span><br><span class="line">                Log.debug( <span class="string">&quot;call AndroidThunkJava_SetFullScreenDisplayForP&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将其在UPL中通过<code>&lt;gameActivityClassAdditions&gt;</code>添加到GameActivity.java中，在游戏启动时通过JNI调用即可。</p>
<p>注：</p>
<p><code>layoutInDisplayCutoutMode</code>的可选项为：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#LAYOUT_IN_DISPLAY_CUTOUT_MODE_ALWAYS">LAYOUT_IN_DISPLAY_CUTOUT_MODE_ALWAYS</a>(Added in <a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/uses-sdk-element#ApiLevels">API level 30</a>)：始终允许窗口扩展到<code>DisplayCutout</code>屏幕所有边缘上的区域。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT">LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT</a>(Added in <a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/uses-sdk-element#ApiLevels">API level 28</a>)：仅当窗口完全包含在系统栏中时<code>DisplayCutout</code>，才允许该窗口扩展到该区域 <code>DisplayCutout</code>。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#LAYOUT_IN_DISPLAY_CUTOUT_MODE_NEVER">LAYOUT_IN_DISPLAY_CUTOUT_MODE_NEVER</a>(Added in <a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/uses-sdk-element#ApiLevels">API level 28</a>)：永远不要让窗口与DisplayCutout区域重叠。</li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES">LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES</a>(Added in <a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/uses-sdk-element#ApiLevels">API level 28</a>)：始终允许窗口扩展到<code>DisplayCutout</code>屏幕短边的区域。</li>
</ul>
<h3 id="外部资料"><a href="#外部资料" class="headerlink" title="外部资料"></a>外部资料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/zh-CN/Support/Builds/ReleaseNotes/4_23/index.html">UE4.23的更新日志</a></li>
</ul>
<h2 id="远程编译Shader的Key查找bug"><a href="#远程编译Shader的Key查找bug" class="headerlink" title="远程编译Shader的Key查找bug"></a>远程编译Shader的Key查找bug</h2><p>在<code>Project Settings</code>-<code>Platforms</code>-<code>IOS</code>中开启<code>Enable Remote Shader Compile</code>后，如果填入的构建机地址具有指定端口，在查找SSHkey时会有问题：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Developer/Apple/MetalShaderFormat/Private/MetalShaderCompiler.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsRemoteBuildingConfigured</span><span class="params">(<span class="keyword">const</span> FShaderCompilerEnvironment* InEnvironment)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    GRemoteBuildServerSSHKey = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (InEnvironment != <span class="literal">nullptr</span> &amp;&amp; InEnvironment-&gt;RemoteServerData.Contains(TEXT(<span class="string">&quot;SSHPrivateKeyOverridePath&quot;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        GRemoteBuildServerSSHKey = InEnvironment-&gt;RemoteServerData[TEXT(<span class="string">&quot;SSHPrivateKeyOverridePath&quot;</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (GRemoteBuildServerSSHKey.Len() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        GConfig-&gt;GetString(TEXT(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>), TEXT(<span class="string">&quot;SSHPrivateKeyOverridePath&quot;</span>), GRemoteBuildServerSSHKey, GEngineIni);</span><br><span class="line"></span><br><span class="line">        GConfig-&gt;GetString(TEXT(<span class="string">&quot;/Script/IOSRuntimeSettings.IOSRuntimeSettings&quot;</span>), TEXT(<span class="string">&quot;SSHPrivateKeyOverridePath&quot;</span>), GRemoteBuildServerSSHKey, GEngineIni);</span><br><span class="line">        <span class="keyword">if</span> (GRemoteBuildServerSSHKey.Len() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!FParse::Value(FCommandLine::Get(), TEXT(<span class="string">&quot;serverkey&quot;</span>), GRemoteBuildServerSSHKey) &amp;&amp; GRemoteBuildServerSSHKey.Len() == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (GRemoteBuildServerSSHKey.Len() == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// RemoteToolChain.cs in UBT looks in a few more places but the code in FIOSTargetSettingsCustomization::OnGenerateSSHKey() only puts the key in this location so just going with that to keep things simple</span></span><br><span class="line">                    FString Path = FPlatformMisc::GetEnvironmentVariable(TEXT(<span class="string">&quot;APPDATA&quot;</span>));</span><br><span class="line">                    GRemoteBuildServerSSHKey = FString::Printf(TEXT(<span class="string">&quot;%s\\Unreal Engine\\UnrealBuildTool\\SSHKeys\\%s\\%s\\RemoteToolChainPrivate.key&quot;</span>), *Path, *GRemoteBuildServerHost, *GRemoteBuildServerUser);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...    </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里查找的Key路径时直接通过<code>GRemoteBuildServerHost</code>拼接的，但是如果在配置中指定了端口，那么<code>GRemoteBuildServerHost</code>的值为这种格式<code>xxx.xx.xx.xx:1234</code>，但是Win上目录名不能带<code>:</code>，就会导致Key查找失败。</p>
<p>还有在同文件的<code>ExecRemoteProcess</code>函数中，没有针对具有指定端口的情况做处理：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ExecRemoteProcess</span><span class="params">(<span class="keyword">const</span> TCHAR* Command, <span class="keyword">const</span> TCHAR* Params, int32* OutReturnCode, FString* OutStdOut, FString* OutStdErr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_MAC &amp;&amp; !UNIXLIKE_TO_MAC_REMOTE_BUILDING</span></span><br><span class="line">	<span class="keyword">return</span> FPlatformProcess::ExecProcess(Command, Params, OutReturnCode, OutStdOut, OutStdErr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span> (GRemoteBuildServerHost.IsEmpty())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	FString CmdLine = FString(TEXT(<span class="string">&quot;-i \&quot;&quot;</span>)) + GRemoteBuildServerSSHKey + TEXT(<span class="string">&quot;\&quot; \&quot;&quot;</span>) + GRemoteBuildServerUser + <span class="string">&#x27;@&#x27;</span> + GRemoteBuildServerHost + TEXT(<span class="string">&quot;\&quot; &quot;</span>) + Command + TEXT(<span class="string">&quot; &quot;</span>) + (Params != <span class="literal">nullptr</span> ? Params : TEXT(<span class="string">&quot;&quot;</span>));</span><br><span class="line">	<span class="keyword">return</span> ExecProcess(*GSSHPath, *CmdLine, OutReturnCode, OutStdOut, OutStdErr);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要做一些处理：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ExecRemoteProcess</span><span class="params">(<span class="keyword">const</span> TCHAR* Command, <span class="keyword">const</span> TCHAR* Params, int32* OutReturnCode, FString* OutStdOut, FString* OutStdErr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_MAC &amp;&amp; !UNIXLIKE_TO_MAC_REMOTE_BUILDING</span></span><br><span class="line">	<span class="keyword">return</span> FPlatformProcess::ExecProcess(Command, Params, OutReturnCode, OutStdOut, OutStdErr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span> (GRemoteBuildServerHost.IsEmpty())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FString RemoteBuildServerIP = GRemoteBuildServerHost;</span><br><span class="line">	FString RemoteBuildServerPort = TEXT(<span class="string">&quot;22&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(GRemoteBuildServerHost.Contains(TEXT(<span class="string">&quot;:&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		GRemoteBuildServerHost.Split(TEXT(<span class="string">&quot;:&quot;</span>),&amp;RemoteBuildServerIP,&amp;RemoteBuildServerPort);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FString CmdLine = FString(TEXT(<span class="string">&quot;-i \&quot;&quot;</span>)) + GRemoteBuildServerSSHKey + TEXT(<span class="string">&quot;\&quot; \&quot;&quot;</span>) + GRemoteBuildServerUser + <span class="string">&#x27;@&#x27;</span> + RemoteBuildServerIP + TEXT(<span class="string">&quot;\&quot; &quot;</span>) TEXT(<span class="string">&quot;-p &quot;</span>) + RemoteBuildServerPort +TEXT(<span class="string">&quot; &quot;</span>)+ Command + TEXT(<span class="string">&quot; &quot;</span>) + (Params != <span class="literal">nullptr</span> ? Params : TEXT(<span class="string">&quot;&quot;</span>));</span><br><span class="line">	<span class="keyword">return</span> ExecProcess(*GSSHPath, *CmdLine, OutReturnCode, OutStdOut, OutStdErr);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="平台相关Target"><a href="#平台相关Target" class="headerlink" title="平台相关Target"></a>平台相关Target</h2><p>在项目的Target.cs中定义着项目的TargetRules，但是也不是所有的平台都可以通用全部的参数，每个平台都有自己特定的属性，所以UE的TargetRules定义中中还包含各个平台的Target：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Android-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> AndroidTargetRules AndroidPlatform = <span class="keyword">new</span> AndroidTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> IOS-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> IOSTargetRules IOSPlatform = <span class="keyword">new</span> IOSTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Lumin-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> LuminTargetRules LuminPlatform = <span class="keyword">new</span> LuminTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Linux-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> LinuxTargetRules LinuxPlatform = <span class="keyword">new</span> LinuxTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Mac-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> MacTargetRules MacPlatform = <span class="keyword">new</span> MacTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> PS4-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> PS4TargetRules PS4Platform = <span class="keyword">new</span> PS4TargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Switch-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> SwitchTargetRules SwitchPlatform = <span class="keyword">new</span> SwitchTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Windows-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> WindowsTargetRules WindowsPlatform; <span class="comment">// Requires &#x27;this&#x27; parameter; initialized in constructor</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Xbox One-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> XboxOneTargetRules XboxOnePlatform = <span class="keyword">new</span> XboxOneTargetRules();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> HoloLens-specific target settings.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ConfigSubObject</span>]</span><br><span class="line"><span class="keyword">public</span> HoloLensTargetRules HoloLensPlatform;</span><br></pre></td></tr></table></figure>
<p>当需要对某个平台进行特殊控制时，可以在TargetRules中访问特定平台的对象。</p>
<p>如在IOS平台生成dSYM:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(Target.Platform == UnrealTargetPlatform.IOS)</span><br><span class="line">&#123;</span><br><span class="line">	IOSPlatform.bGeneratedSYM = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="TargetRule获取项目路径"><a href="#TargetRule获取项目路径" class="headerlink" title="TargetRule获取项目路径"></a>TargetRule获取项目路径</h2><p>使用<code>ProjectFile</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Console.WriteLine(&quot;ProjectDir:&quot; + ProjectFile.Directory);</span><br></pre></td></tr></table></figure>

<h2 id="UObject获取资源路径"><a href="#UObject获取资源路径" class="headerlink" title="UObject获取资源路径"></a>UObject获取资源路径</h2><p>可以使用<code>FStringAssetReference</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FStringAssetReference <span class="title">ObjectPath</span><span class="params">(Object)</span></span>;</span><br><span class="line">FString AssetPackagePath = ObjectPath.ToString();</span><br></pre></td></tr></table></figure>

<p>获取的路径格式为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Game/StarterContent/Materials/M_Basic_Floor.M_Basic_Floor</span><br></pre></td></tr></table></figure>

<p>如果想要获得类似编辑器<code>Copy Reference</code>的信息，则可以使用<code>FAssetData</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FAssetData <span class="title">AssetData</span><span class="params">(Object)</span></span>;</span><br><span class="line">FString ReferenceInfo = AssetData.GetExportTextName();</span><br></pre></td></tr></table></figure>

<p>获取的格式为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Material&#x27;/Game/StarterContent/Materials/M_Basic_Floor.M_Basic_Floor&#x27;</span><br></pre></td></tr></table></figure>

<p>也能够根据UObject获取到它的资源类型。</p>
<p>如果用<code>FAssetData</code>获取C++类会得到下面的这样的信息（在运行时动态创建的对象）：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Actor&#x27;/Game/StarterContent/Maps/UEDPIE_0_Minimal_Default.Minimal_Default:PersistentLevel.Actor_0&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="打包iOS导出dSYM"><a href="#打包iOS导出dSYM" class="headerlink" title="打包iOS导出dSYM"></a>打包iOS导出dSYM</h2><p>像Bugly之类的crash上报平台都需要上传符号表才能看到具体的堆栈信息，而iOS上的符号和调试信息都是在<code>dSYM</code>文件中的。<br>UE提供了dSYM的生成选项，在<code>Project Settings</code>-<code>Platforms</code>-<code>iOS</code>-<code>Build</code>：<br><img data-src="index/UE4/ue-project-settings-ios-gen-dSYM.webp"></p>
<ul>
<li>Generate dSYM file for code debugging and profiling：只开启这个会在<code>Binaries/IOS</code>下生成<code>PROJECT_NAME.dSYM</code>文件</li>
<li>Generate dSYM bundle for third party crash tools：依赖上面的选项，如果开启会在<code>Binaries/IOS</code>下生成<code>PROJECT_NAME.dSYM.zip</code>，并且不会再生成<code>PROJECT_NAME.dSYM</code>文件。</li>
</ul>
<p>但是，在使用源码版打包iOS项目的时候生成的<code>dSYM</code>特别大，超过2G，而同样的工程用Luncher引擎打包就只有100+M，而且bugly之类的上传还有大小限制。</p>
<p>经过对比之后发现，大小的差距主要是在<code>_DWARF_debug_*</code>这些上（左侧为Launcher版，右侧为DebugGame源码版）：<br><img data-src="index/UE4/IOS/diff-source-and-launch-engine-dSYM.webp"></p>
<p>本来以为是源码版会把所有参与编译的代码都导出到dSYM文件中，但是经过翻阅引擎代码发现，其实TargetRules中有控制调试信息的选项，就是来控制产生这些<code>_DWARF_debug_*</code>的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TargetRules.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to globally disable debug info generation; see DebugInfoHeuristics.cs for per-config and per-platform options.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CommandLine(<span class="meta-string">&quot;-NoDebugInfo&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">bool</span> bDisableDebugInfo = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to disable debug info generation for generated files. This improves link times for modules that have a lot of generated glue code.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">bool</span> bDisableDebugInfoForGeneratedCode = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether to disable debug info on PC in development builds (for faster developer iteration, as link times are extremely fast with debug info disabled).</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">XmlConfigFile(Category = <span class="meta-string">&quot;BuildConfiguration&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">bool</span> bOmitPCDebugInfoInDevelopment = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>在项目的<code>Target.cs</code>中控制这些变量即可，如<code>bDisableDebugInfo=true</code>，在源码版引擎中也不会生很大的<code>_DWARF_debug</code>文件了（左侧为Lunch版引擎，右侧为DebugGame源码版控制<code>bDisableDebugInfo=true</code>）：<br><img data-src="index/UE4/IOS/diff-source-and-launch-engine-disabledebugfile-dSYM.webp"></p>
<p>而且，还发现UE在打包IOS平台的时候处理有问题，本来以为打Shipping生成的dSYM会没有调试信息了，但是测试发现还是非常大。</p>
<p>经过分析后发现，在UE的构建系统中是通过两个值来控制是否创建调试信息的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UEBuildPlatforms.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create debug info based on the heuristics specified by the user.</span></span><br><span class="line">GlobalCompileEnvironment.bCreateDebugInfo =</span><br><span class="line">				!Target.bDisableDebugInfo &amp;&amp; ShouldCreateDebugInfo(Target);</span><br><span class="line">GlobalLinkEnvironment.bCreateDebugInfo = GlobalCompileEnvironment.bCreateDebugInfo;</span><br></pre></td></tr></table></figure>
<p>可以看到是通过<code>Target.bDisableDebugInfo</code>和<code>ShouldCreateDebugInfo(Target)</code>两个值来控制的，而<code>ShouldCreateDebugInfo</code>函数则是每个平台的有自己的重写实现。</p>
<p>如在Windows上：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Platform/Windows/UEBuildWindows.cs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether this platform should create debug information or not</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;Target&quot;&gt;</span>The target being built<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>bool    true if debug info should be generated, false if not<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">ShouldCreateDebugInfo</span>(<span class="params">ReadOnlyTargetRules Target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (Target.Configuration)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Development:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Shipping:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Test:</span><br><span class="line">        <span class="keyword">return</span> !Target.bOmitPCDebugInfoInDevelopment;</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.DebugGame:</span><br><span class="line">        <span class="keyword">case</span> UnrealTargetConfiguration.Debug:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，在IOS和Mac上完全没有判断！</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Platform/IOS/UEBuildIOS.cs</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">ShouldCreateDebugInfo</span>(<span class="params">ReadOnlyTargetRules Target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这导致只能自己用<code>bDisableDebugInfo=true</code>来控制，太坑爹了。翻了代码才发现<code>bOmitPCDebugInfoInDevelopment</code>这个选项只在PC上有效：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Documentation/Source/Programming/UnrealBuildSystem/Configuration/BuildConfigProperties/BuildConfigProperties.INT.udn#L85">BuildConfigProperties.INT.udn#L85</a>。</p>
<h3 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h3><p>根据上面的介绍，可以通过控制<code>bDisableDebugInfo=true</code>来生成体积较小的<code>dSYM</code>，但这样有牵扯出来一个坑的问题：使用远程构建时<code>dSYM</code>无法通过UE的构建系统传回本地。<br>查了下代码，没有什么比较方便的办法来控制从远程拷贝的文件，目前我使用<code>pscp</code>从远程拉取dSYM文件回本地。</p>
<h2 id="编译引擎支持Android和iOS"><a href="#编译引擎支持Android和iOS" class="headerlink" title="编译引擎支持Android和iOS"></a>编译引擎支持Android和iOS</h2><p>把源码版引擎导出为安装版引擎时可以使用BuildGraph（Win+Android+iOS）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine/Build/BatchFiles/RunUAT.bat BuildGraph -Script=InstalledEngineBuild.xml -Target=<span class="string">&quot;Make Installed Build Win64&quot;</span> -<span class="built_in">set</span>:WithDDC=<span class="literal">false</span> -<span class="built_in">set</span>:WithWin32=<span class="literal">false</span> -std:HostPlatformEditorOnly=<span class="literal">true</span> -std:HostPlatformOnly=<span class="literal">true</span> -<span class="built_in">set</span>:WithAndroid=<span class="literal">true</span> -<span class="built_in">set</span>:WithIOS=<span class="literal">true</span> -<span class="built_in">set</span>:WithLumin=<span class="literal">false</span> -<span class="built_in">set</span>:WithLuminMac=<span class="literal">false</span> -<span class="built_in">set</span>:WithTVOS=<span class="literal">false</span> -<span class="built_in">set</span>:WithLinux=<span class="literal">false</span> -<span class="built_in">set</span>:WithLinuxAArch64=<span class="literal">false</span> -<span class="built_in">set</span>:WithHoloLens=<span class="literal">false</span> -<span class="built_in">set</span>:EmbedSrcSrvInfo=<span class="literal">false</span> -<span class="built_in">set</span>:WithFullDebugInfo=<span class="literal">false</span> -<span class="built_in">set</span>:GameConfigurations=Development -<span class="built_in">set</span>:VS2019=<span class="literal">true</span> -<span class="built_in">set</span>:InstalledDir=D:\EngineBin -compile</span><br></pre></td></tr></table></figure>
<p>但是编译iOS需要一台Mac，类似项目的远程构建，引擎构建iOS支持时也需要。<br>在之前的笔记中写到，项目的远程构建iOS时可以在<code>DefaultEngine.ini</code>中加上远程机器的地址和SSHKey：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/IOSRuntimeSettings.IOSRuntimeSettings]</span></span><br><span class="line"><span class="attr">RemoteServerName</span>=xxx.xx.xx.xxx</span><br><span class="line"><span class="attr">RSyncUsername</span>=machinename</span><br><span class="line"><span class="attr">SSHPrivateKeyOverridePath</span>=D:\XXXX\RemoteToolChainPrivate.key</span><br></pre></td></tr></table></figure>
<p>在构建引擎时需要把它们写到<code>Engine\Config\BaseEngine.ini</code>中，然后再使用上面的命令构建即可。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Programs/UnrealBuildTool/ToolChain/RemoteMac.cs#L155">UnrealBuildTool/ToolChain/RemoteMac.cs#L155</a></li>
</ul>
<h2 id="Android设置宽高比"><a href="#Android设置宽高比" class="headerlink" title="Android设置宽高比"></a>Android设置宽高比</h2><p>在<code>Project Settings</code>-<code>Platforms</code>-<code>Android</code>-<code>Maximum support aspect ratio</code>的值，默认是2.1，但是在全面屏的情况下会有黑边。<br><img data-src="index/UE4/ue4-project-settings-android-maximum-support-aspect-ratio.webp"></p>
<p>它控制的值是<code>AndroidManifest.xml</code>中的值：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.max_aspect&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;2.1&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>我目前设置的值是2.5.</p>
<blockquote>
<p>注：<code>Enable FullScreen Immersive on KitKat and above devices</code>控制的是进入游戏时是否隐藏虚拟按键。</p>
</blockquote>
<h2 id="UPARAM"><a href="#UPARAM" class="headerlink" title="UPARAM"></a>UPARAM</h2><p>可以在UFUNCTION的函数中给指定的参数来指定它的UPARAM，可以用来控制函数的参数属性。之前是用来指定Ref(<code>UPARAM(Ref)</code>)，其实也可以使用<code>UPARAM(meta=())</code>来指定<code>meta</code>属性。</p>
<p>如在蓝图实现使用枚举bitmask：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">UFUNCTION(BlueprintCallable, BlueprintCosmetic, Category=<span class="string">&quot;Audiokinetic|Actor&quot;</span>, meta=(AdvancedDisplay=<span class="string">&quot;2&quot;</span>, AutoCreateRefTerm = <span class="string">&quot;PostEventCallback,ExternalSources&quot;</span>))</span><br><span class="line"><span class="function"><span class="keyword">static</span> int32 <span class="title">PostEvent</span><span class="params">(	class UAkAudioEvent* AkEvent, </span></span></span><br><span class="line"><span class="function"><span class="params">						class AActor* Actor, </span></span></span><br><span class="line"><span class="function"><span class="params">						UPARAM(meta = (Bitmask, BitmaskEnum = EAkCallbackType)) int32 CallbackMask,</span></span></span><br><span class="line"><span class="function"><span class="params">						<span class="keyword">const</span> FOnAkPostEventCallback&amp; PostEventCallback,</span></span></span><br><span class="line"><span class="function"><span class="params">						<span class="keyword">const</span> TArray&lt;FAkExternalSourceInfo&gt;&amp; ExternalSources,</span></span></span><br><span class="line"><span class="function"><span class="params">						<span class="keyword">bool</span> bStopWhenAttachedToDestroyed = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">						FString EventName = FString(<span class="string">&quot;&quot;</span>))</span></span>;</span><br></pre></td></tr></table></figure>

<p><img data-src="index/UE4/ue-uprarm-bitmask.webp"></p>
<p>指定返回值的名字什么的都不在话下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">UPARAM</span><span class="params">(DisplayName = <span class="string">&quot;Bundle&quot;</span>)</span> FOSCBundle&amp; <span class="title">AddMessageToBundle</span><span class="params">(<span class="keyword">const</span> FOSCMessage&amp; Message, UPARAM(ref) FOSCBundle&amp; Bundle)</span></span>;</span><br></pre></td></tr></table></figure>

<p>可以在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/search?p=1&q=UPARAM&unscoped_q=UPARAM">UPARAM</a>看到引擎代码中的各种用法。</p>
<h2 id="无边框模式"><a href="#无边框模式" class="headerlink" title="无边框模式"></a>无边框模式</h2><p>可以开启<code>Project Settings</code>-<code>Description</code>-<code>Settings</code>-<code>Use Boardless Window</code>:<br><img data-src="index/UE4/ue4-description-use-boardless-window.webp"></p>
<p>这个变量在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/1eb5d965b994b4bd59f31ec4158d42f13137ab1f/Engine/Source/Runtime/Engine/Private/GameEngine.cpp#L430">UGameEngine::CreateGameWindow</a>中用到，用来控制引擎启动创建窗口时，窗口的Style.</p>
<p>在不重新打包的情况下可以将下面配置写到<code>Saved/Config/WindowsNoEditor/Game.ini</code>中：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/EngineSettings.GeneralProjectSettings]</span></span><br><span class="line"><span class="attr">bUseBorderlessWindow</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>重启游戏就是无边框模式了。</p>
<h2 id="命令行导入iOS证书和Provision"><a href="#命令行导入iOS证书和Provision" class="headerlink" title="命令行导入iOS证书和Provision"></a>命令行导入iOS证书和Provision</h2><p>在部署构建机的时候，需要给每台构建机都导入iOS的<code>provision</code>和<code>p12</code>证书，如果每个都要打开一遍编辑器，纯粹是重复劳动，翻了下代码，UE编辑器中导入证书是通过调用<code>IPhonePackager.exe</code>来实现的，而且是以命令行的方式执行，这样就好办了，按照它的参数自己实现脚本即可。<br>具体看引擎中的相关代码：<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Developer/IOS/IOSPlatformEditor/Private/IOSTargetSettingsCustomization.cpp#L1312">IOSTargetSettingsCustomization.cpp#L1312</a></p>
<h3 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h3><p>导入证书的命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Binaries\DotNET\IOS\IPhonePackager.exe Install Engine -project <span class="string">&quot;D:\Client\FGame.uproject&quot;</span> -certificate <span class="string">&quot;D:\IOS_DEVELOPMENT.p12&quot;</span> -bundlename <span class="string">&quot;com.tencent.xxxx.xx&quot;</span></span><br></pre></td></tr></table></figure>

<p>证书是导入到系统中的，可以在<code>certmgr.msc</code>中查看导入的证书：</p>
<p><img data-src="index/UE4/IOS/import-ios-cer-in-windows-certmgr.webp"></p>
<p><strong>注意</strong>：因为iPhonePackager.exe在导入证书时会让弹框输入证书的密码：</p>
<p><img data-src="index/UE4/IOS/ue4-import-cer-for-ios.webp"></p>
<p>这导致不能用在自动化流程里，但是我怎么可能会老老实实每台电脑都输一次密码呢，看了一下iPhonePackager的代码，找到了弹窗让输入密码的地方<a target="_blank" rel="noopener" href="https://github.com/epicgames/unrealengine/blob/release/Engine/Source/Programs/IOS/iPhonePackager/ToolsHub.cs#L263">Programs/IOS/iPhonePackager/ToolsHub.cs#L263</a>，我给它加了个从命令行参数读取密码的选项，如果有该参数就不会弹框：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Load the certificate</span></span><br><span class="line"><span class="keyword">string</span> CertificatePassword = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">string</span>[] arguments = Environment.GetCommandLineArgs();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>;index&lt;arguments.Length;++index)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (arguments[index] == <span class="string">&quot;-cerpassword&quot;</span> &amp;&amp; index != (arguments.Length<span class="number">-1</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		CertificatePassword = arguments[index + <span class="number">1</span>];</span><br><span class="line">		Console.WriteLine(<span class="string">&quot;Usage -cerpasseord argument&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">X509Certificate2 Cert = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">	Cert = <span class="keyword">new</span> X509Certificate2(CertificateFilename, CertificatePassword, X509KeyStorageFlags.PersistKeySet | X509KeyStorageFlags.Exportable | X509KeyStorageFlags.MachineKeySet);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (System.Security.Cryptography.CryptographicException ex)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Try once with a password</span></span><br><span class="line">	<span class="keyword">if</span> (CertificatePassword.Length &gt; <span class="number">0</span> || PasswordDialog.RequestPassword(<span class="keyword">out</span> CertificatePassword))</span><br><span class="line">	&#123;</span><br><span class="line">		Cert = <span class="keyword">new</span> X509Certificate2(CertificateFilename, CertificatePassword, X509KeyStorageFlags.PersistKeySet | X509KeyStorageFlags.Exportable | X509KeyStorageFlags.MachineKeySet);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// User cancelled dialog, rethrow</span></span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把上面的代码替换掉<a target="_blank" rel="noopener" href="https://github.com/epicgames/unrealengine/blob/release/Engine/Source/Programs/IOS/iPhonePackager/ToolsHub.cs#L263">Programs/IOS/iPhonePackager/ToolsHub.cs#L263</a>这里的部分，重新编译iPhonePackager即可。</p>
<h3 id="Provision"><a href="#Provision" class="headerlink" title="Provision"></a>Provision</h3><p>导入<code>Provision</code>的命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Binaries\DotNET\IOS\IPhonePackager.exe Install Engine -project <span class="string">&quot;D:\Client\FGame.uproject&quot;</span> -provision <span class="string">&quot;D:\com.tencent.xxxx.xx_Development_SignProvision.mobileprovision&quot;</span> -bundlename <span class="string">&quot;com.tencent.xxxx.xx&quot;</span></span><br></pre></td></tr></table></figure>

<p>Provision文件导入后会放在用户目录下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The shared provision library directory (on PC)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ProvisionDirectory</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Environment.OSVersion.Platform == PlatformID.MacOSX || Environment.OSVersion.Platform == PlatformID.Unix) &#123;</span><br><span class="line">            <span class="keyword">return</span> Environment.GetEnvironmentVariable(<span class="string">&quot;HOME&quot;</span>) + <span class="string">&quot;/Library/MobileDevice/Provisioning Profiles/&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Environment.GetFolderPath (Environment.SpecialFolder.LocalApplicationData) + <span class="string">&quot;/Apple Computer/MobileDevice/Provisioning Profiles/&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Win上就为：<code>C:\Users\USER_NAME\AppData\Local\Apple Computer\MobileDevice\Provisioning Profiles</code>.</p>
<h2 id="C-获取命令行参数"><a href="#C-获取命令行参数" class="headerlink" title="C#获取命令行参数"></a>C#获取命令行参数</h2><p>需要<code>using system;</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span>[] arguments = Environment.GetCommandLineArgs();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>;index&lt;arguments.Length;++index)</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="打包时给不同的平台添加资源"><a href="#打包时给不同的平台添加资源" class="headerlink" title="打包时给不同的平台添加资源"></a>打包时给不同的平台添加资源</h2><p>有时我们需要在打包时给不同的平台添加不同目录下的外部资源（如WWise），UE提供了<code>Project Settings</code>-<code>Packaging</code>-<code>Additional Non-Asset Directories to Package</code>，找了一下，并没有发现单独给某个平台指定添加路径的地方。<br><strong>但是</strong>，<code>Additional Non-Asset Directories to Package</code>本身是支持给不同平台添加不同目录的，只要在<code>Additional Non-Asset Directories to Package</code>添加的目录下根据不同的平台创建不同的目录。<br>如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">D:\EmptyProject\Content\WwiseAudio&gt;tree &#x2F;a</span><br><span class="line">+---Android</span><br><span class="line">|   \---English(US)</span><br><span class="line">+---iOS</span><br><span class="line">|   \---English(US)</span><br><span class="line">\---Windows</span><br><span class="line">    \---English(US)</span><br></pre></td></tr></table></figure>
<p>在项目的<code>Content\WwiseAudio</code>下，有<code>Android</code>/<code>iOS</code>/<code>Windows</code>等目录，在<code>Additional Non-Asset Directories to Package</code>中添加的是<code>WwiseAudio</code>目录,打包时只会把对应平台的目录给打包进去，但是没有看到UE的文档里哪有写。</p>
<h2 id="监听资源保存的事件"><a href="#监听资源保存的事件" class="headerlink" title="监听资源保存的事件"></a>监听资源保存的事件</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PackageSaved</span><span class="params">(<span class="keyword">const</span> FString&amp; PacStr,UObject* PackageSaved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UE_LOG(LogTemp,Log,TEXT(<span class="string">&quot;Package %s Saved.&quot;</span>),*PacStr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FEmptyProjectModule::StartupModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UPackage::PackageSavedEvent.AddStatic(&amp;PackageSaved);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UStruct的json序列化"><a href="#UStruct的json序列化" class="headerlink" title="UStruct的json序列化"></a>UStruct的json序列化</h2><p>因为UStruct在UE内是具有反射的，所以不用自己去解析编码就可以实现序列化和反序列化，UE中提供了一个辅助模块：<code>JsonUtilities</code>，里面具有<code>FJsonObjectConverter</code>类，定义了一系列的操作。<br>我简单封装了一下，对Ustrut的序列化和反序列化：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TStructType&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">TSerializeStructAsJsonObject</span><span class="params">(<span class="keyword">const</span> TStructType&amp; InStruct,TSharedPtr&lt;FJsonObject&gt;&amp; OutJsonObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!OutJsonObject.IsValid())</span><br><span class="line">    &#123;</span><br><span class="line">        OutJsonObject = MakeShareable(<span class="keyword">new</span> FJsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> bStatus = FJsonObjectConverter::UStructToJsonObject(TStructType::StaticStruct(),&amp;InStruct,OutJsonObject.ToSharedRef(),<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> bStatus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TStructType&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">TDeserializeJsonObjectAsStruct</span><span class="params">(<span class="keyword">const</span> TSharedPtr&lt;FJsonObject&gt;&amp; OutJsonObject,TStructType&amp; InStruct)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> bStatus = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(OutJsonObject.IsValid())</span><br><span class="line">    &#123;</span><br><span class="line">        bStatus = FJsonObjectConverter::JsonObjectToUStruct(OutJsonObject.ToSharedRef(),TStructType::StaticStruct(),&amp;InStruct,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bStatus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TStructType&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">TSerializeStructAsJsonString</span><span class="params">(<span class="keyword">const</span> TStructType&amp; InStruct,FString&amp; OutJsonString)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> bRunStatus = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        TSharedPtr&lt;FJsonObject&gt; JsonObject;</span><br><span class="line">        <span class="keyword">if</span> (TSerializeStructAsJsonObject&lt;TStructType&gt;(InStruct,JsonObject) &amp;&amp; JsonObject.IsValid())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">auto</span> JsonWriter = TJsonWriterFactory&lt;&gt;::Create(&amp;OutJsonString);</span><br><span class="line">            FJsonSerializer::Serialize(JsonObject.ToSharedRef(), JsonWriter);</span><br><span class="line">            bRunStatus = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bRunStatus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TStructType&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">TDeserializeJsonStringAsStruct</span><span class="params">(<span class="keyword">const</span> FString&amp; InJsonString,TStructType&amp; OutStruct)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> bRunStatus = <span class="literal">false</span>;</span><br><span class="line">    TSharedRef&lt;TJsonReader&lt;TCHAR&gt;&gt; JsonReader = TJsonReaderFactory&lt;TCHAR&gt;::Create(InJsonString);</span><br><span class="line">    TSharedPtr&lt;FJsonObject&gt; DeserializeJsonObject;</span><br><span class="line">    <span class="keyword">if</span> (FJsonSerializer::Deserialize(JsonReader, DeserializeJsonObject))</span><br><span class="line">    &#123;</span><br><span class="line">        bRunStatus = TDeserializeJsonObjectAsStruct&lt;TStructType&gt;(DeserializeJsonObject,OutStruct);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bRunStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Redirector"><a href="#Redirector" class="headerlink" title="Redirector"></a>Redirector</h2><p><code>Redirector</code>是标记被移动资源的引用关系的，在移动具有引用的资源时会产生。<br>如<code>/Game/GameMap</code>引用到了一个UI资源<code>/Game/UMG_Main</code>，当移动<code>/Game/UMG_Main</code>到<code>/Game/TEST/UMG_Main</code>时，会在<code>/Game/UMG_Main</code>的磁盘路径下创建出一个Redirector，用与告诉引用到该UI的资源，它的真实路径已经发生变化了，所以叫Redirector。<br>在项目中需要尽量避免Redirector的存在。</p>
<h2 id="检查引擎是否运行在Commandlet"><a href="#检查引擎是否运行在Commandlet" class="headerlink" title="检查引擎是否运行在Commandlet"></a>检查引擎是否运行在Commandlet</h2><p>UE中有检测的方法，定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Core/Public/CoreGlobals.h#L201">CoreGlobals.h</a>的<code>IsRunningCommandlet</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Check to see if this executable is running a commandlet (custom command-line processing code in an editor-like environment)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">FORCEINLINE <span class="keyword">bool</span> <span class="title">IsRunningCommandlet</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_ENGINE</span></span><br><span class="line">	<span class="keyword">return</span> PRIVATE_GIsRunningCommandlet;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FSoftObjectPath限定类型"><a href="#FSoftObjectPath限定类型" class="headerlink" title="FSoftObjectPath限定类型"></a>FSoftObjectPath限定类型</h2><p>默认<code>FSoftObjectPath</code>可以指定任何继承自UObject的资源类型，但有时候只想要指定某些类型，UE提供了限定类型的功能，要使用UPROPERTY：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPROPERTY(config, EditAnywhere, Category=DefaultMaps, meta=(AllowedClasses=<span class="string">&quot;World&quot;</span>))</span><br><span class="line">FSoftObjectPath EditorStartupMap;</span><br></pre></td></tr></table></figure>

<p>在<code>meta</code>中使用<code>AllowedClasses</code>即可，<code>AllowedClassess</code>的值是实际类型去掉前缀<code>U</code>，如<code>USoundClass</code>要使用<code>SoundClass</code>。</p>
<p><code>AllowedClasses</code>可以指定多个，使用逗号分隔，使当前FSoftObjectPath可以指定多个限定类型的资源。而且还可以使用<code>ExactClass</code>来控制是否严格限定类型（是否允许继承层次中类型中的资源，如<code>UDataTable</code>和<code>UCompositeDataTable</code>），如果不指定，默认是严格限定类型的，如果<code>ExactClass=true</code>则可以使用继承层次中类型的资源。</p>
<h2 id="编辑器viewport显示文字"><a href="#编辑器viewport显示文字" class="headerlink" title="编辑器viewport显示文字"></a>编辑器viewport显示文字</h2><p><code>UKismetSystemLibrary::PrintString</code>是运行时可以输出到viewport，在编辑器下无效果，想要实现编辑器下的文本输出可以通过<code>FCanvas</code>的<code>DrawItem</code>来实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FCanvasTextItem <span class="title">TextItem</span><span class="params">(FVector2D(<span class="number">100</span>, <span class="number">200</span>), LOCTEXT(<span class="string">&quot;OutOfTextureMemory&quot;</span>, <span class="string">&quot;RAN OUT OF TEXTURE MEMORY, EXPECT CORRUPTION AND GPU HANGS!&quot;</span>), GEngine-&gt;GetMediumFont(), FLinearColor::Red)</span></span>;</span><br><span class="line">TextItem.EnableShadow(FLinearColor::Black);</span><br><span class="line">Canvas-&gt;DrawItem(TextItem);</span><br></pre></td></tr></table></figure>

<p>如<code>stat fps</code>等，都是通过<code>FCanvas</code>来实现的，如<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Engine/Private/UnrealEngine.cpp#L9824">DrawMapWarnings</a>:</p>
<p><img data-src="index/UE4/ue4-viveport-ligthing-need-rebuilt.webp"></p>
<p>以及<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Engine/Private/UnrealEngine.cpp#L14677">RenderStatFPS</a>:</p>
<p><img data-src="index/UE4/ue4-viveport-stat-fps.webp"></p>
<p><code>FCanvas</code>可以通过<code>FViewport::GetDebugCanvas()</code>来获得。</p>
<h2 id="开启多核心编译"><a href="#开启多核心编译" class="headerlink" title="开启多核心编译"></a>开启多核心编译</h2><p>UBT会从下面三个文件中读取配置：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* Engine/Saved/UnrealBuildTool/BuildConfiguration.xml</span><br><span class="line">* *User Folder/AppData*/Roaming/Unreal Engine/UnrealBuildTool/BuildConfiguration.xml</span><br><span class="line">* *My Documents*/Unreal Engine/UnrealBuildTool/BuildConfiguration.xml</span><br></pre></td></tr></table></figure>

<p>我们只需要修改其中的任意一个就可以。</p>
<p>默认具有以下内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>更多的BuildConfigutation的参数可以看引擎文档<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealBuildSystem/Configuration/index.html">Configuring Unreal Build System</a>。在文档中<code>ProcessorCountMultiplier</code>元素的数字就是允许使用的处理器数，<strong>但是</strong>，UE的文档和实际的代码有出入，按照上面的文档，设置<code>ProcessorCountMultiplier</code>是在<code>BuildConfigutation</code>下的，但是这么写会与错误：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>错误信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BuildConfiguration.xml(4): [] 元素 命名空间“https:&#x2F;&#x2F;www.unrealengine.com&#x2F;BuildConfiguration”中的“BuildConfiguration”。 的子元素 命名空间“https:&#x2F;&#x2F;www.unrealengine.com&#x2F;BuildConfiguration”中的“ProcessorCountMultiplier”。 无效。应为可能元素的列表: 命名空间“https:&#x2F;&#x2F;www.unrealengine.com&#x2F;BuildConfiguration”中的“bPGOProfile, bAllowHybridExecutor, DMUCSDistProp, bAllowXGE, bGeneratedSYMFile, bAllowSNDBS, bIgnoreOutdatedImportLibraries, bUseFastSemanticsRenderContexts, bDisableDebugInfo, bParseTimingInfoForTracing, CppStandard, bPrintDebugInfo, bUseSharedPCHs, bDisableDebugInfoForGeneratedCode, bForcePrecompiledHeaderForGameModules, bUseShippingPhysXLibraries, bUseAdaptiveUnityBuild, bXGENoWatchdogThread, MinGameModuleSourceFilesForUnityBuild, bAdaptiveUnityDisablesOptimizations, bCheckLicenseViolations, bAllowParallelExecutor, bOmitFramePointers, bUseCheckedPhysXLibraries, bSupportEditAndContinue, bAllowASLRInShipping, bStripSymbols, bAllowDistcc, bVerboseDistccOutput, bUseInlining, bAllowDistccLocalFallback, bAdaptiveUnityEnablesEditAndContinue, bEnableMemorySanitizer, bCheckSystemHeadersForModification, bUseFastPDBLinking, bAdaptiveUnityDisablesProjectPCHForProjectPrivate, BaseLogFileName, bUsePerFileIntellisense, bCreateMapFile, bUsePCHFiles, DMUCSCoordinat...。</span><br></pre></td></tr></table></figure>

<p>查阅代码之后发现，这些配置选项要去看<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Documentation/Source/Programming/UnrealBuildSystem/Configuration/BuildConfigProperties/BuildConfigProperties.INT.udn">BuildConfigProperties.INT.udn</a>里的参数，<code>ProcessorCountMultiplier </code>是在<code>ParallelExecutor</code>下的，所以改成以下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxProcessorCount</span>&gt;</span>7<span class="tag">&lt;/<span class="name">MaxProcessorCount</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bStopCompilationAfterErrors</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bStopCompilationAfterErrors</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>目前我使用的完整配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://www.unrealengine.com/BuildConfiguration&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxParallelActions</span>&gt;</span>7<span class="tag">&lt;/<span class="name">MaxParallelActions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bAllowParallelExecutor</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bAllowParallelExecutor</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">BuildConfiguration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">SNDBS</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>4<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxProcessorCount</span>&gt;</span>4<span class="tag">&lt;/<span class="name">MaxProcessorCount</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">SNDBS</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ProcessorCountMultiplier</span>&gt;</span>7<span class="tag">&lt;/<span class="name">ProcessorCountMultiplier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MaxProcessorCount</span>&gt;</span>7<span class="tag">&lt;/<span class="name">MaxProcessorCount</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bStopCompilationAfterErrors</span>&gt;</span>true<span class="tag">&lt;/<span class="name">bStopCompilationAfterErrors</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ParallelExecutor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>相关连接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/747044/view.html">How to use multiple processors for compiling?</a></li>
</ul>
<h2 id="URL-Encode-Decode"><a href="#URL-Encode-Decode" class="headerlink" title="URL Encode/Decode"></a>URL Encode/Decode</h2><p>UE提供了相关的API：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">FGenericPlatformHttp::UrlDecode</span><span class="params">(<span class="keyword">const</span> FString &amp; EncodedString)</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">FGenericPlatformHttp::UrlEncode</span><span class="params">(<span class="keyword">const</span> FString &amp; UnencodedString)</span></span></span><br></pre></td></tr></table></figure>
<p>执行结果：<br><img data-src="index/UE4/ue4-http-encode-url.webp"></p>
<h2 id="查看APK的签名信息"><a href="#查看APK的签名信息" class="headerlink" title="查看APK的签名信息"></a>查看APK的签名信息</h2><p>可以使用<code>keytool.exe</code>（在JDK的bin中），使用以下参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool.exe<span class="string">&quot; -list -printcert -jarfile FGame-armv7.apk</span></span><br></pre></td></tr></table></figure>
<p>会打印出apk的签名色所有者和发布者，以及证书的有效时间、证书指纹等等。</p>
<h2 id="ASTC设置压缩率"><a href="#ASTC设置压缩率" class="headerlink" title="ASTC设置压缩率"></a>ASTC设置压缩率</h2><p>在<code>Project Settings</code>-<code>Engine</code>-<code>Cooker</code>中有选项：<br><img data-src="index/UE4/ue4-project-settings-cooker-astc-compression.webp"></p>
<h2 id="Android重启App"><a href="#Android重启App" class="headerlink" title="Android重启App"></a>Android重启App</h2><p>当游戏更新完毕之后有时候需要重启App才可以生效，在UE中可以使用UPL写入以下java代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AndroidThunkJava_AndroidAPI_RestartApplication</span><span class="params">( )</span> </span>&#123;</span><br><span class="line">	Context context = getApplicationContext();</span><br><span class="line">    PackageManager pm = context.getPackageManager();</span><br><span class="line">    Intent intent = pm.getLaunchIntentForPackage(context.getPackageName());</span><br><span class="line">    <span class="keyword">int</span> delayTime = <span class="number">500</span>;</span><br><span class="line">    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);</span><br><span class="line">    PendingIntent restartIntent = PendingIntent.getActivity(context, <span class="number">0</span>, intent, PendingIntent.FLAG_CANCEL_CURRENT);</span><br><span class="line">    alarmManager.set(AlarmManager.RTC, System.currentTimeMillis() + delayTime, restartIntent);</span><br><span class="line">    System.exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在需要重启的时候通过jni调用来触发：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RestartApplication</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_ANDROID</span></span><br><span class="line">	<span class="keyword">if</span> (JNIEnv* Env = FAndroidApplication::GetJavaEnv(<span class="literal">true</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		FJavaWrapper::CallVoidMethod(Env, FJavaWrapper::GameActivityThis, AndroidThunkJava_AndroidAPI_RestartApplication);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="打包Windows以窗口模式启动"><a href="#打包Windows以窗口模式启动" class="headerlink" title="打包Windows以窗口模式启动"></a>打包Windows以窗口模式启动</h2><p>在项目的<code>Config</code>下新建<code>DefaultGameUserSettings.ini</code>文件，填入以下内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.GameUserSettings]</span></span><br><span class="line"><span class="attr">bUseVSync</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">ResolutionSizeX</span>=<span class="number">1920</span></span><br><span class="line"><span class="attr">ResolutionSizeY</span>=<span class="number">1080</span></span><br><span class="line"><span class="attr">LastUserConfirmedResolutionSizeX</span>=<span class="number">1920</span></span><br><span class="line"><span class="attr">LastUserConfirmedResolutionSizeY</span>=<span class="number">1080</span></span><br><span class="line"><span class="attr">WindowPosX</span>=-<span class="number">1</span></span><br><span class="line"><span class="attr">WindowPosY</span>=-<span class="number">1</span></span><br><span class="line"><span class="attr">FullscreenMode</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">LastConfirmedFullscreenMode</span>=<span class="number">2</span>  </span><br><span class="line"><span class="attr">Version</span>=<span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>打包之后就会以窗口模式启动了，分辨率可以自己修改。</p>
<h2 id="指定地图Cook及打包"><a href="#指定地图Cook及打包" class="headerlink" title="指定地图Cook及打包"></a>指定地图Cook及打包</h2><p>在<code>DefaultEditor.ini</code>中添加以下项：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[AllMaps]</span></span><br><span class="line">+Map=/Game/Assets/Scene/Map/Fb/v3/8r/xzzn/Fb_ThePoolOfTribute</span><br><span class="line">+Map=/Game/Assets/Scene/Map/LightSpeed/LightSpeed</span><br><span class="line"></span><br><span class="line"><span class="section">[AlwaysCookMaps]</span></span><br><span class="line">+Map=/Game/Assets/Scene/Map/Fb/v3/8r/xzzn/Fb_ThePoolOfTribute</span><br><span class="line">+Map=/Game/Assets/Scene/Map/LightSpeed/LightSpeed</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/11790/packaging-specific-maps-within-a-project.html">Packaging specific maps within a project</a></li>
</ul>
<h2 id="Windows通过bat存储环境变量"><a href="#Windows通过bat存储环境变量" class="headerlink" title="Windows通过bat存储环境变量"></a>Windows通过bat存储环境变量</h2><p>设置用户环境变量：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setx ENV_NAME env_value</span><br></pre></td></tr></table></figure>
<p>设置系统环境变量：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setx ENV_NAME env_value /m</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="http://www.hxstrive.com/article/608.htm">批处理教程：SET和SETX命令</a></li>
</ul>
<h2 id="C-访问Collision-Chanel"><a href="#C-访问Collision-Chanel" class="headerlink" title="C++访问Collision Chanel"></a>C++访问Collision Chanel</h2><p><code>ECollisionChanel</code>是定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/Engine/Classes/Engine/EngineTypes.h">EngineTypes.h</a>中的枚举类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">UENUM(BlueprintType)</span><br><span class="line"><span class="keyword">enum</span> ECollisionChannel</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	ECC_WorldStatic UMETA(DisplayName=&quot;WorldStatic&quot;),</span><br><span class="line">	ECC_WorldDynamic UMETA(DisplayName=&quot;WorldDynamic&quot;),</span><br><span class="line">	ECC_Pawn UMETA(DisplayName=&quot;Pawn&quot;),</span><br><span class="line">	ECC_Visibility UMETA(DisplayName=&quot;Visibility&quot; , TraceQuery=&quot;1&quot;),</span><br><span class="line">	ECC_Camera UMETA(DisplayName=&quot;Camera&quot; , TraceQuery=&quot;1&quot;),</span><br><span class="line">	ECC_PhysicsBody UMETA(DisplayName=&quot;PhysicsBody&quot;),</span><br><span class="line">	ECC_Vehicle UMETA(DisplayName=&quot;Vehicle&quot;),</span><br><span class="line">	ECC_Destructible UMETA(DisplayName=&quot;Destructible&quot;),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Reserved for gizmo collision */</span></span><br><span class="line">	ECC_EngineTraceChannel1 UMETA(Hidden),</span><br><span class="line"></span><br><span class="line">	ECC_EngineTraceChannel2 UMETA(Hidden),</span><br><span class="line">	ECC_EngineTraceChannel3 UMETA(Hidden),</span><br><span class="line">	ECC_EngineTraceChannel4 UMETA(Hidden), </span><br><span class="line">	ECC_EngineTraceChannel5 UMETA(Hidden),</span><br><span class="line">	ECC_EngineTraceChannel6 UMETA(Hidden),</span><br><span class="line"></span><br><span class="line">	ECC_GameTraceChannel1 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel2 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel3 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel4 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel5 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel6 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel7 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel8 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel9 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel10 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel11 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel12 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel13 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel14 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel15 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel16 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel17 UMETA(Hidden),</span><br><span class="line">	ECC_GameTraceChannel18 UMETA(Hidden),</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** Add new serializeable channels above here (i.e. entries that exist in FCollisionResponseContainer) */</span></span><br><span class="line">	<span class="comment">/** Add only nonserialized/transient flags below */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// NOTE!!!! THESE ARE BEING DEPRECATED BUT STILL THERE FOR BLUEPRINT. PLEASE DO NOT USE THEM IN CODE</span></span><br><span class="line"></span><br><span class="line">	ECC_OverlapAll_Deprecated UMETA(Hidden),</span><br><span class="line">	ECC_MAX,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但是我们在项目设置中添加是可以取任意的名字的，而且创建的Chanel的数量有上限（18个），这是因为<code>ECollisionChanel</code>是预先定义了18个供游戏创建的枚举值，假如我们创建了一个名字为<code>AAA</code>的Chanel，会在当前项目的<code>Config/DefaultEngine.ini</code>的<code>[/Script/Engine.CollisionProfile]</code>中创建以下项：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+DefaultChannelResponses=(Channel=ECC_GameTraceChannel1,DefaultResponse=ECR_Overlap,bTraceType=False,bStaticObject=False,Name=&quot;AAA&quot;)</span><br></pre></td></tr></table></figure>
<p>在这里跟枚举值做了绑定，在C++代码中进行设置的时候就需要指定<code>ECC_GameTraceChannel1</code>的枚举值。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/59507553">UE4C++自定义Object/Trace Channel</a></li>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/583529/how-to-get-collisiontrace-channel-by-name-in-c.html">How to get collision/trace channel by name in c++?</a></li>
</ul>
<p>Todo：可以写一个方便从名字获取ECollisionChanel枚举值的库。</p>
<h2 id="Actor的延迟Spawn"><a href="#Actor的延迟Spawn" class="headerlink" title="Actor的延迟Spawn"></a>Actor的延迟Spawn</h2><ul>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/284744/spawning-an-actor-with-parameters.html">Spawning an actor with parameters</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FTransform <span class="title">SpawnTransform</span><span class="params">(Rotation, Origin)</span></span>;</span><br><span class="line"><span class="keyword">auto</span> MyDeferredActor = Cast&lt;ADeferredActor&gt;(UGameplayStatics::BeginDeferredActorSpawnFromClass(<span class="keyword">this</span>, DeferredActorClass, SpawnTransform));</span><br><span class="line"><span class="keyword">if</span> (MyDeferredActor != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">    MyDeferredActor-&gt;Init(ShootDir);</span><br><span class="line"></span><br><span class="line">    UGameplayStatics::FinishSpawningActor(MyDeferredActor, SpawnTransform);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编译引擎的WindowsDebugTools错误"><a href="#编译引擎的WindowsDebugTools错误" class="headerlink" title="编译引擎的WindowsDebugTools错误"></a>编译引擎的WindowsDebugTools错误</h2><p>编译引擎出现以下错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Unable to find installation of PDBCOPY.EXE, which is required to strip symbols. This tool is included as part of the &#x27;Windows Debugging Tools&#x27; component of the Windows 10 SDK (https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk).</span><br><span class="line">       while executing task &lt;Strip Platform=&quot;Win64&quot; BaseDir=&quot;C:\BuildAgent\workspace\FGameEngine\FEngine&quot; Files=&quot;#UE4Editor Win64 Unstripped&quot; OutputDir=&quot;C:\BuildAgent\workspace\FGameEngine\FEngine\Engine\Saved&quot; Tag=&quot;#UE4Editor Win64 Stripped&quot; /&gt;</span><br><span class="line">       at Engine\Build\InstalledEngineBuild.xml(183)</span><br><span class="line">       (see C:\BuildAgent\workspace\FGameEngine\FEngine\Engine\Programs\AutomationTool\Saved\Logs\Log.txt for full exception trace)</span><br></pre></td></tr></table></figure>
<p>这是因为没有安装Windows Debugging Tools，在<a target="_blank" rel="noopener" href="https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk">这里</a>下载Win10SDK安装程序，在其中选择安装Windows Debug Tools安装即可。</p>
<h2 id="BuildGraph构建引擎"><a href="#BuildGraph构建引擎" class="headerlink" title="BuildGraph构建引擎"></a>BuildGraph构建引擎</h2><p>可以使用下列命令：<br>构建引擎的工具集：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine\Build\BatchFiles\RunUAT.bat BuildGraph -Script=Engine\Build\InstalledEngineBuild.xml -Target=<span class="string">&quot;Build Tools Win64&quot;</span> -<span class="built_in">set</span>:HostPlatformOnly=<span class="literal">true</span> -<span class="built_in">set</span>:WithWin64=<span class="literal">true</span> -<span class="built_in">set</span>:WithWin32=<span class="literal">false</span> -<span class="built_in">set</span>:WithDDC=<span class="literal">false</span> -clean</span><br></pre></td></tr></table></figure>
<p>构建引擎：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Engine/Build/BatchFiles/RunUAT.bat BuildGraph -Script=Engine\Build\InstalledEngineBuild.xml -target=\&quot;Make Installed Build Win64\&quot; -<span class="built_in">set</span>:WithDDC=<span class="literal">false</span> -<span class="built_in">set</span>:WithWin64=<span class="literal">true</span> -<span class="built_in">set</span>:WithWin32=<span class="literal">false</span> -<span class="built_in">set</span>:WithAndroid=<span class="literal">false</span> -<span class="built_in">set</span>:WithIOS=<span class="literal">false</span> -<span class="built_in">set</span>:WithTVOS=<span class="literal">false</span> -<span class="built_in">set</span>:WithLinux=<span class="literal">false</span> -<span class="built_in">set</span>:WithLinuxAArch64=<span class="literal">false</span> -<span class="built_in">set</span>:WithLumin=<span class="literal">false</span> -<span class="built_in">set</span>:WithHoloLens=<span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Game-module-could-not-be-loaded"><a href="#Game-module-could-not-be-loaded" class="headerlink" title="Game module could not be loaded"></a>Game module could not be loaded</h2><p>在引入其他模块的代码时，有时候会具有下面这样的情况：</p>
<p><img data-src="index/UE4/ModuleLoadFaild/ue4-game-module-could-not-be-loaded.webp"></p>
<p>Log中的提示：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[2020.07.18-01.58.50:729][  0]LogWindows: Failed to load &#x27;E:/UnrealProjects/Examples/HotPatcherExample/Binaries/Win64/UE4Editor-HotPatcherExample.dll&#x27; (GetLastError=1114)</span><br><span class="line">[2020.07.18-01.58.50:729][  0]LogModuleManager: Warning: ModuleManager: Unable to load module &#x27;E:/UnrealProjects/Examples/HotPatcherExample/Binaries/Win64/UE4Editor-HotPatcherExample.dll&#x27; because the file couldn&#x27;t be loaded by the OS.</span><br><span class="line">[2020.07.18-02.01.38:988][  0]LogWindowsTextInputMethodSystem: Display: IME system now activated using TSF (微软拼音).</span><br><span class="line">[2020.07.18-02.01.38:991][  0]Message dialog closed, result: Ok, title: Message, text: The game module &#x27;HotPatcherExample&#x27; could not be loaded. There may be an operating system error or the module may not be properly set up.</span><br><span class="line">[2020.07.18-02.01.38:991][  0]LogCore: Engine exit requested (reason: EngineExit() was called)</span><br></pre></td></tr></table></figure>

<p>这个问题应该是项目中（或者插件中）加载DLL失败的问题，一般情况下是DLL文件存在问题或者DLL中逻辑的错误造成。</p>
<p>经过排查后发现我触发这个问题的方式为在使用UnLua注册<code>lua_Reg</code>函数时漏掉了置空最后一个元素：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> luaL_Reg AMyActorLib[]=</span><br><span class="line">&#123;</span><br><span class="line">	&#123;<span class="string">&quot;ReceiveBytes&quot;</span>,ReceiveBytes&#125;,</span><br><span class="line">	<span class="comment">// &#123;nullptr,nullptr&#125;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">BEGIN_EXPORT_REFLECTED_CLASS(AMyActor)</span><br><span class="line">	ADD_LIB(AMyActorLib)</span><br><span class="line">END_EXPORT_CLASS(AMyActor)</span><br><span class="line">IMPLEMENT_EXPORTED_CLASS(AMyActor)</span><br></pre></td></tr></table></figure>

<p>因为<code>AMyActorLib</code>这个数组最后一个元素没有置空，在<code>UnLuaEx.inl</code>中的AddLib函数中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">bool</span> bIsReflected&gt;</span><br><span class="line"><span class="keyword">void</span> TExportedClassBase&lt;bIsReflected&gt;::AddLib(<span class="keyword">const</span> luaL_Reg *InLib)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (InLib)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (InLib-&gt;name &amp;&amp; InLib-&gt;func)</span><br><span class="line">        &#123;</span><br><span class="line">        	GlueFunctions.Add(<span class="keyword">new</span> FGlueFunction(ANSI_TO_TCHAR(InLib-&gt;name), InLib-&gt;func));</span><br><span class="line">        	++InLib;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>lua_Reg</code>数组的最后一个元素不为空就会导致这里出发UB行为（死循环），导致当前模块加载失败，也就触发了前面模块加载失败的问题。</p>
<h2 id="蓝图编辑器中节点属性的修改"><a href="#蓝图编辑器中节点属性的修改" class="headerlink" title="蓝图编辑器中节点属性的修改"></a>蓝图编辑器中节点属性的修改</h2><p>在编辑器模式下修改节点的值：</p>
<p>执行的函数是<code>UEdGraphSchema_K2::TrySetDefaultValue</code>(<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Editor/BlueprintGraph/Private/EdGraphSchema_K2.cpp#L4747">Editor/BlueprintGraph/Private/EdGraphSchema_K2.cpp</a>)，是通过<code>Schema</code>来调用的。简单来说就是通过当前的节点，去修改节点上的Pin的值，不管原始类型是什么，FString/int/float还是枚举，都可以通过这个方法设置。</p>
<p><img data-src="index/UE4/ue-set-node-value-in-editor.webp"></p>
<h3 id="UMG资料文档"><a href="#UMG资料文档" class="headerlink" title="UMG资料文档"></a>UMG资料文档</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/UMG/index.html">UMG UI Disigner</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/UMG/UserGuide/WidgetBlueprints/index.html">Widget Blueprints</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/UMG/UserGuide/WidgetTypeReference/index.html">Widget Type Reference</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/UMG/QuickStart/index.html">UMG UI Designer Quick Start Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/UMG/UserGuide/UMGRichTextBlock/index.html">UMG Rich Text Block</a></li>
</ul>
<p>文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.unrealengine.com/en-US/tech-blog/advanced-text-styling-with-rich-text-block">Advanced Text Styling with Rich Text Block</a></li>
</ul>
<h2 id="Enum反射"><a href="#Enum反射" class="headerlink" title="Enum反射"></a>Enum反射</h2><h3 id="UHT为Enum生成的代码"><a href="#UHT为Enum生成的代码" class="headerlink" title="UHT为Enum生成的代码"></a>UHT为Enum生成的代码</h3><p>在UE中，当我们声明一个枚举类型时可以像UClass一样地形式为其添加<code>UENUM</code>标记，指导UHT为其生成反射代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">UENUM(BlueprintType)</span><br><span class="line"><span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">ETypeName</span> :</span>uint8</span><br><span class="line">&#123;</span><br><span class="line">	None,</span><br><span class="line">	Int,</span><br><span class="line">	Float</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>经过UHT之后就变成了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FOREACH_ENUM_ETYPENAME(op) \</span></span><br><span class="line">	op(ETypeName::None) \</span><br><span class="line">	op(ETypeName::Int) \</span><br><span class="line">	op(ETypeName::Float) </span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">ETypeName</span> :</span> uint8;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; TOPDOWNEXAMPLE_API UEnum* StaticEnum&lt;ETypeName&gt;();</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .gen.cpp</span></span><br><span class="line"><span class="comment">// End Cross Module References</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> UEnum* <span class="title">ETypeName_StaticEnum</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">static</span> UEnum* Singleton = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">if</span> (!Singleton)</span><br><span class="line">		&#123;</span><br><span class="line">			Singleton = GetStaticEnum(Z_Construct_UEnum_TopdownExample_ETypeName, Z_Construct_UPackage__Script_TopdownExample(), TEXT(<span class="string">&quot;ETypeName&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Singleton;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span>&lt;&gt; TOPDOWNEXAMPLE_API UEnum* StaticEnum&lt;ETypeName&gt;()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> ETypeName_StaticEnum();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> FCompiledInDeferEnum <span class="title">Z_CompiledInDeferEnum_UEnum_ETypeName</span><span class="params">(ETypeName_StaticEnum, TEXT(<span class="string">&quot;/Script/TopdownExample&quot;</span>), TEXT(<span class="string">&quot;ETypeName&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line">	<span class="function">uint32 <span class="title">Get_Z_Construct_UEnum_TopdownExample_ETypeName_Hash</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2221805252U</span>; &#125;</span><br><span class="line">	<span class="function">UEnum* <span class="title">Z_Construct_UEnum_TopdownExample_ETypeName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		UPackage* Outer = Z_Construct_UPackage__Script_TopdownExample();</span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = FindExistingEnumIfHotReloadOrDynamic(Outer, TEXT(<span class="string">&quot;ETypeName&quot;</span>), <span class="number">0</span>, Get_Z_Construct_UEnum_TopdownExample_ETypeName_Hash(), <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// WITH_HOT_RELOAD</span></span></span><br><span class="line">		<span class="keyword">if</span> (!ReturnEnum)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumeratorParam Enumerators[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;ETypeName::None&quot;</span>, (int64)ETypeName::None &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETypeName::Int&quot;</span>, (int64)ETypeName::Int &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETypeName::Float&quot;</span>, (int64)ETypeName::Float &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">			<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Enum_MetaDataParams[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;BlueprintType&quot;</span>, <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;MyK2Node.h&quot;</span> &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumParams EnumParams = &#123;</span><br><span class="line">				(UObject*(*)())Z_Construct_UPackage__Script_TopdownExample,</span><br><span class="line">				<span class="literal">nullptr</span>,</span><br><span class="line">				<span class="string">&quot;ETypeName&quot;</span>,</span><br><span class="line">				<span class="string">&quot;ETypeName&quot;</span>,</span><br><span class="line">				Enumerators,</span><br><span class="line">				ARRAY_COUNT(Enumerators),</span><br><span class="line">				RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">				UE4CodeGen_Private::EDynamicType::NotDynamic,</span><br><span class="line">				(uint8)UEnum::ECppForm::EnumClass,</span><br><span class="line">				METADATA_PARAMS(Enum_MetaDataParams, ARRAY_COUNT(Enum_MetaDataParams))</span><br><span class="line">			&#125;;</span><br><span class="line">			UE4CodeGen_Private::ConstructUEnum(ReturnEnum, EnumParams);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ReturnEnum;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>UEnum的构造思路和UClass差不多，通过UHT生成Enum的反射代码，记录枚举类型的名字、枚举值的名字、元数据等等，通过<code>UE4CodeGen_Private::ConstructUEnum</code>把这些反射数据构造出UEnum。</p>
<p>同样也是通过<strong>延迟注册</strong>的方式把UEnum构造出来。</p>
<h3 id="运行时访问UEnum"><a href="#运行时访问UEnum" class="headerlink" title="运行时访问UEnum"></a>运行时访问UEnum</h3><p>如果要获取一个<code>UENMU</code>的UEnum*可以通过<code>StaticEnum&lt;ETypeName&gt;()</code>或者通过<code>UEnum* const MethodEnum = FindObjectChecked&lt;UEnum&gt;(ANY_PACKAGE, TEXT(&quot;ETypeName&quot;), true);</code>来拿。</p>
<p>在UE4.22+的版本中可以使用下列方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UEnum* TypeEnum = StaticEnum&lt;EnumType&gt;();</span><br></pre></td></tr></table></figure>
<p>在4.21及之前的版本就要麻烦一点：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UEnum* TypeEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, TEXT(<span class="string">&quot;EnumType&quot;</span>), <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>注意上面的<code>TEXT(&quot;EnumType&quot;)</code>其中要填想要获取的枚举类型名字。</p>
<h3 id="根据枚举名字获取枚举值"><a href="#根据枚举名字获取枚举值" class="headerlink" title="根据枚举名字获取枚举值"></a>根据枚举名字获取枚举值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; get enum value by name</span><br><span class="line">&#123;</span><br><span class="line">	FString EnumTypeName &#x3D; TEXT(&quot;ETargetPlatform&quot;);</span><br><span class="line">    FString EnumName &#x3D; FString::Printf(TEXT(&quot;%s::%s&quot;),*EnumTypeName,TEXT(&quot;Int&quot;))</span><br><span class="line"></span><br><span class="line">    UEnum* ETargetPlatformEnum &#x3D; FindObject&lt;UEnum&gt;(ANY_PACKAGE, *EnumTypeName, true);</span><br><span class="line"></span><br><span class="line">    int32 EnumIndex &#x3D; ETargetPlatformEnum-&gt;GetIndexByName(FName(*EnumName));</span><br><span class="line">    if (EnumIndex !&#x3D; INDEX_NONE)</span><br><span class="line">    &#123;</span><br><span class="line">      UE_LOG(LogTemp, Log, TEXT(&quot;FOUND ENUM INDEX SUCCESS&quot;));</span><br><span class="line">      int32 EnumValue &#x3D; ETargetPlatformEnum-&gt;GetValueByIndex(EnumIndex);</span><br><span class="line">      ETargetPlatform CurrentEnum &#x3D; (ETargetPlatform)EnumValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果也想再封装一层模板类，让枚举名字也可以自动获取，则需要用得到C++的RTTI特性：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">GetCPPTypeName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> result;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> type_name = <span class="keyword">typeid</span>(T).name();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::for_each(type_name.begin(),type_name.end(),[&amp;result](<span class="keyword">const</span> <span class="keyword">char</span>&amp; character)&#123;<span class="keyword">if</span>(!<span class="built_in">std</span>::<span class="built_in">isdigit</span>(character)) result.push_back(character);&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="枚举值与字符串的互相转换"><a href="#枚举值与字符串的互相转换" class="headerlink" title="枚举值与字符串的互相转换"></a>枚举值与字符串的互相转换</h3><p>有些需要序列化枚举值的需要，虽然我们可以通过<code>FindObject&lt;UEnum&gt;</code>传入枚举名字拿到<code>UEnum*</code>，再通过<code>GetNameByValue</code>拿到名字，但是这样需要针对每个枚举都要单独写，我写了模板函数来做这个事情：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同时支持4.21- 和4.21+版本引擎</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cctype&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">GetCPPTypeName</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> result;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> type_name = <span class="keyword">typeid</span>(T).name();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::for_each(type_name.begin(),type_name.end(),[&amp;result](<span class="keyword">const</span> <span class="keyword">char</span>&amp; character)&#123;<span class="keyword">if</span>(!<span class="built_in">std</span>::<span class="built_in">isdigit</span>(character)) result.push_back(character);&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ENUM_TYPE&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetEnumNameByValue</span><span class="params">(ENUM_TYPE InEnumValue, <span class="keyword">bool</span> bFullName = <span class="literal">false</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FString result;</span><br><span class="line">    &#123;</span><br><span class="line">      FString TypeName;</span><br><span class="line">      FString ValueName;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENGINE_MINOR_VERSION &gt; 21</span></span><br><span class="line">        UEnum* FoundEnum = StaticEnum&lt;ENUM_TYPE&gt;();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        FString EnumTypeName = ANSI_TO_TCHAR(GetCPPTypeName&lt;ENUM_TYPE&gt;().c_str());</span><br><span class="line">        UEnum* FoundEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, *EnumTypeName, <span class="literal">true</span>); </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      <span class="keyword">if</span> (FoundEnum)</span><br><span class="line">      &#123;</span><br><span class="line">        result = FoundEnum-&gt;GetNameByValue((int64)InEnumValue).ToString();</span><br><span class="line">        result.Split(TEXT(<span class="string">&quot;::&quot;</span>), &amp;TypeName, &amp;ValueName, ESearchCase::CaseSensitive, ESearchDir::FromEnd);</span><br><span class="line">        <span class="keyword">if</span> (!bFullName)</span><br><span class="line">        &#123;</span><br><span class="line">          result = ValueName;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及从字符串获取枚举值：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> ENUM_TYPE&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">GetEnumValueByName</span><span class="params">(<span class="keyword">const</span> FString&amp; InEnumValueName, ENUM_TYPE&amp; OutEnumValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> bStatus = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENGINE_MINOR_VERSION &gt;22</span></span><br><span class="line">        UEnum* FoundEnum = StaticEnum&lt;ENUM_TYPE&gt;();</span><br><span class="line">        FString EnumTypeName = FoundEnum-&gt;CppType;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        FString EnumTypeName = *GetCPPTypeName&lt;ENUM_TYPE&gt;();</span><br><span class="line">        UEnum* FoundEnum = FindObject&lt;UEnum&gt;(ANY_PACKAGE, *EnumTypeName, <span class="literal">true</span>); </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (FoundEnum)</span><br><span class="line">    &#123;</span><br><span class="line">      FString EnumValueFullName = EnumTypeName + TEXT(<span class="string">&quot;::&quot;</span>) + InEnumValueName;</span><br><span class="line">      int32 EnumIndex = FoundEnum-&gt;GetIndexByName(FName(*EnumValueFullName));</span><br><span class="line">      <span class="keyword">if</span> (EnumIndex != INDEX_NONE)</span><br><span class="line">      &#123;</span><br><span class="line">        int32 EnumValue = FoundEnum-&gt;GetValueByIndex(EnumIndex);</span><br><span class="line">        ENUM_TYPE ResultEnumValue = (ENUM_TYPE)EnumValue;</span><br><span class="line">        OutEnumValue = ResultEnumValue;</span><br><span class="line">        bStatus = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Struct反射"><a href="#Struct反射" class="headerlink" title="Struct反射"></a>Struct反射</h2><p>前面讲到了Class/function/property的反射，UE还支持结构体的反射，其实从C++的标准语义来说并没有区分“结构”和“类”，关键字<code>struct</code>和<code>class</code>的区别只在于默认的访问权限。</p>
<p>在UE里面，支持反射的结构提只能使用<code>struct</code>，并且不能包含任何UFUNCTION的函数，命名必须以F开头。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">USTRUCT(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FTestStruct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	GENERATED_USTRUCT_BODY()</span><br><span class="line"></span><br><span class="line">	UPROPERTY(EditAnywhere)</span><br><span class="line">	int32 ival;</span><br><span class="line">	UPROPERTY(EditAnywhere)</span><br><span class="line">	UTexture2D* Texture;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>UE的标记语法和Class的类似，不过UHT为Struct生成的代码要简单许多，因为没有UFUNCTION也没有继承UObject。</p>
<p><code>GENERATED_USTRUCT_BODY</code>这个标记UHT会展开生成一个真正的C++宏(在genreated.h中)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HotPatcherExample_Source_HotPatcherExample_TestStruct_h_11_GENERATED_BODY \</span></span><br><span class="line">	<span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UScriptStruct_FTestStruct_Statics</span>;</span> \</span><br><span class="line">	<span class="function">HOTPATCHEREXAMPLE_API <span class="keyword">static</span> class UScriptStruct* <span class="title">StaticStruct</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt; HOTPATCHEREXAMPLE_API UScriptStruct* StaticStruct&lt;<span class="class"><span class="keyword">struct</span> <span class="title">FTestStruct</span>&gt;();</span></span><br></pre></td></tr></table></figure>

<p>把UHT生成的用于记录当前struct反射数据的结构<code>Z_Construct_UScriptStruct_FTestStruct_Statis</code>声明为当前struct类的友元，可以让它访问到自己的私有成员。而且还声明了当前Struct的static成员函数<code>StaticStruct</code>和全局模板函数<code>StaticStruct&lt;FTestStruct&gt;</code>。</p>
<p>对Struct生成的反射数；</p>
<p>据的结构与class的类似，只有Property的反射信息。</p>
<p><code>gen.cpp</code>中有以下内容：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">class UScriptStruct* <span class="title">FTestStruct::StaticStruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UScriptStruct</span>* <span class="title">Singleton</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="keyword">if</span> (!Singleton)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function"><span class="keyword">extern</span> HOTPATCHEREXAMPLE_API uint32 <span class="title">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span><span class="params">()</span></span>;</span><br><span class="line">		Singleton = GetStaticStruct(Z_Construct_UScriptStruct_FTestStruct, Z_Construct_UPackage__Script_HotPatcherExample(), TEXT(<span class="string">&quot;TestStruct&quot;</span>), <span class="keyword">sizeof</span>(FTestStruct), Get_Z_Construct_UScriptStruct_FTestStruct_Hash());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Singleton;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; HOTPATCHEREXAMPLE_API UScriptStruct* StaticStruct&lt;FTestStruct&gt;()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> FTestStruct::StaticStruct();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> FCompiledInDeferStruct <span class="title">Z_CompiledInDeferStruct_UScriptStruct_FTestStruct</span><span class="params">(FTestStruct::StaticStruct, TEXT(<span class="string">&quot;/Script/HotPatcherExample&quot;</span>), TEXT(<span class="string">&quot;TestStruct&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">FScriptStruct_HotPatcherExample_StaticRegisterNativesFTestStruct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	FScriptStruct_HotPatcherExample_StaticRegisterNativesFTestStruct()</span><br><span class="line">	&#123;</span><br><span class="line">		UScriptStruct::DeferCppStructOps(FName(TEXT(<span class="string">&quot;TestStruct&quot;</span>)),<span class="keyword">new</span> UScriptStruct::TCppStructOps&lt;FTestStruct&gt;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; ScriptStruct_HotPatcherExample_StaticRegisterNativesFTestStruct;</span><br><span class="line"></span><br><span class="line"><span class="function">UScriptStruct* <span class="title">Z_Construct_UScriptStruct_FTestStruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	<span class="function"><span class="keyword">extern</span> uint32 <span class="title">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span><span class="params">()</span></span>;</span><br><span class="line">	UPackage* Outer = Z_Construct_UPackage__Script_HotPatcherExample();</span><br><span class="line">	<span class="keyword">static</span> UScriptStruct* ReturnStruct = FindExistingStructIfHotReloadOrDynamic(Outer, TEXT(<span class="string">&quot;TestStruct&quot;</span>), <span class="keyword">sizeof</span>(FTestStruct), Get_Z_Construct_UScriptStruct_FTestStruct_Hash(), <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">static</span> UScriptStruct* ReturnStruct = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">if</span> (!ReturnStruct)</span><br><span class="line">	&#123;</span><br><span class="line">		UE4CodeGen_Private::ConstructUScriptStruct(ReturnStruct, Z_Construct_UScriptStruct_FTestStruct_Statics::ReturnStructParams);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ReturnStruct;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">uint32 <span class="title">Get_Z_Construct_UScriptStruct_FTestStruct_Hash</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">4266809061U</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码包含了从UHT生成的反射信息中构造出<code>UStructSctruct</code>以及延迟注册的方法，和Class的方式类似。</p>
<p>还包含生成的结构<code>Z_Construct_UScriptStruct_STRUCTNAME_Statics</code>如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UScriptStruct_FTestStruct_Statics</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Struct_MetaDataParams[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">NewStructOps</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam NewProp_Texture_MetaData[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams NewProp_Texture;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam NewProp_ival_MetaData[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams NewProp_ival;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> PropPointers[];</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FStructParams ReturnStructParams;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UScriptStruct_FTestStruct_Statics::Struct_MetaDataParams[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;BlueprintType&quot;</span>, <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;TestStruct.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">Z_Construct_UScriptStruct_FTestStruct_Statics::NewStructOps</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (UScriptStruct::ICppStructOps*)<span class="keyword">new</span> UScriptStruct::TCppStructOps&lt;FTestStruct&gt;();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture_MetaData[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;TestStruct&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;TestStruct.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture = &#123; </span><br><span class="line">	<span class="string">&quot;Texture&quot;</span>, </span><br><span class="line">	<span class="literal">nullptr</span>, </span><br><span class="line">	(EPropertyFlags)<span class="number">0x0010000000000001</span>, </span><br><span class="line">	UE4CodeGen_Private::EPropertyGenFlags::Object, </span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative, </span><br><span class="line">	<span class="number">1</span>, </span><br><span class="line">	STRUCT_OFFSET(FTestStruct, Texture), </span><br><span class="line">	Z_Construct_UClass_UTexture2D_NoRegister, </span><br><span class="line">	METADATA_PARAMS(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture_MetaData, </span><br><span class="line">	UE_ARRAY_COUNT(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture_MetaData)) </span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival_MetaData[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;TestStruct&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;TestStruct.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival = &#123; </span><br><span class="line">	<span class="string">&quot;ival&quot;</span>, </span><br><span class="line">	<span class="literal">nullptr</span>, </span><br><span class="line">	(EPropertyFlags)<span class="number">0x0010000000000001</span>, </span><br><span class="line">	UE4CodeGen_Private::EPropertyGenFlags::Int, </span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative, </span><br><span class="line">	<span class="number">1</span>, </span><br><span class="line">	STRUCT_OFFSET(FTestStruct, ival), </span><br><span class="line">	METADATA_PARAMS(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival_MetaData, </span><br><span class="line">	UE_ARRAY_COUNT(Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival_MetaData)) </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> Z_Construct_UScriptStruct_FTestStruct_Statics::PropPointers[] = &#123;</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_Texture,</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UScriptStruct_FTestStruct_Statics::NewProp_ival,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FStructParams Z_Construct_UScriptStruct_FTestStruct_Statics::ReturnStructParams = &#123;</span><br><span class="line">	(UObject* (*)())Z_Construct_UPackage__Script_HotPatcherExample,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	&amp;NewStructOps,</span><br><span class="line">	<span class="string">&quot;TestStruct&quot;</span>,</span><br><span class="line">	<span class="keyword">sizeof</span>(FTestStruct),</span><br><span class="line">	<span class="keyword">alignof</span>(FTestStruct),</span><br><span class="line">	Z_Construct_UScriptStruct_FTestStruct_Statics::PropPointers,</span><br><span class="line">	UE_ARRAY_COUNT(Z_Construct_UScriptStruct_FTestStruct_Statics::PropPointers),</span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	EStructFlags(<span class="number">0x00000001</span>),</span><br><span class="line">	METADATA_PARAMS(Z_Construct_UScriptStruct_FTestStruct_Statics::Struct_MetaDataParams, UE_ARRAY_COUNT(Z_Construct_UScriptStruct_FTestStruct_Statics::Struct_MetaDataParams))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到Struct的每个属性也是通过<code>FPropertyParamsBase</code>来存储的，与Class一致。</p>
<p>区别在于，Struct使用<code>UE4CodeGen_Private::FStructParams</code>来存储当前结构的反射信息，其声明如下(<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h#L2603">CoreUObject/Public/UObject/UObjectGlobals.h</a>)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Public/UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FStructParams</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	UObject*                          (*OuterFunc)();	</span><br><span class="line">	UScriptStruct*                    (*SuperFunc)();</span><br><span class="line">	<span class="keyword">void</span>*                             (*StructOpsFunc)(); <span class="comment">// really returns UScriptStruct::ICppStructOps*</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         NameUTF8;</span><br><span class="line">	SIZE_T                              SizeOf;</span><br><span class="line">	SIZE_T                              AlignOf;</span><br><span class="line">	<span class="keyword">const</span> FPropertyParamsBase* <span class="keyword">const</span>*   PropertyArray;</span><br><span class="line">	int32                               NumProperties;</span><br><span class="line">	EObjectFlags                        ObjectFlags;</span><br><span class="line">	uint32                              StructFlags; <span class="comment">// EStructFlags</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam*           MetaDataArray;</span><br><span class="line">	int32                               NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个结构中比较特殊的一点是<code>StructOpsFunc</code>是一个函数指针，用来管理C++结构的构造和析构，使用的也是placement-new的方式，<code>TCppStructOps&lt;&gt;</code>模板定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/Class.h#L1122">CoreUObject/Public/UObject/Class.h</a>。</p>
<h2 id="类反射"><a href="#类反射" class="headerlink" title="类反射"></a>类反射</h2><h3 id="UHT为类产生的反射信息"><a href="#UHT为类产生的反射信息" class="headerlink" title="UHT为类产生的反射信息"></a>UHT为类产生的反射信息</h3><p>当在UE中新建一个类并继承自<code>UObject</code>时，可以在类声明的上一行添加<code>UCLASS</code>标记，当执行编译的时候UBT会调用UHT来根据标记来生成C++代码（不过非UCLASS的类也可以用宏来生成反射信息）。</p>
<p>UHT为类生成的代码为：</p>
<ol>
<li>为所有的UFUNCTION的函数创建FName，命名规则为<code>NAME_CLASSNAME_FUNCTIONNAME</code>，如<code>NAME_AMyActor_TestFunc</code></li>
<li>BlueprintNativeEvent和BlueprintImplementEvent创建同名函数实现，并通过<code>ProcessEvent</code>转发调用</li>
<li>为所有加了UFUNCTION的函数生成Thunk函数，为当前类的static函数，原型为<code>static void execFUNCNAME( UObject* Context, FFrame&amp; Stack, RESULT_DECL)</code>；</li>
<li>创建当前类的<code>StaticRegisterNatives*</code>函数，并把上一步提到的<code>exec</code>这样的thunk函数通过<code>Name-execFunc指针</code>的形式通过<code>FNativeFunctionRegistrar::RegisterFunctions</code>注册到UClass；</li>
<li>创建出<code>Z_Construct_UClass_CLASSNAME_NoRegister</code>函数，返回值是<code>CLASSNAME::StaticClass()</code></li>
<li>创建出<code>Z_Construct_UClass_CLASSNAME_Statics</code>类（GENERATED_BODY等宏会把该类添加为我们创建类的友元，使其可以访问私有成员，用于获取成员指针）</li>
</ol>
<p><code>Z_Construct_UClass_CLASSNAME_Statics</code>类的结构为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AMyActor.h</span></span><br><span class="line">UCLASS(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XXXX_API</span> <span class="title">AMyActor</span>:</span><span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">	GENERATED_BODY()</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	UPROPERTY()</span><br><span class="line">		int32 ival;</span><br><span class="line">	UFUNCTION()</span><br><span class="line">		<span class="function">int32 <span class="title">GetIval</span><span class="params">()</span></span>;</span><br><span class="line">	UFUNCTION()</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">TESTFUNC</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// generated code in AMyActor.gen.cpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UClass_AMyActor_Statics</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">static</span> UObject* (*<span class="keyword">const</span> DependentSingletons[])();</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FClassFunctionLinkInfo FuncInfo[];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam NewProp_ival_MetaData[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams NewProp_ival;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> PropPointers[];</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FImplementedInterfaceParams InterfaceParams[];</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FCppClassTypeInfoStatic StaticCppClassTypeInfo;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FClassParams ClassParams;</span><br><span class="line">	&#125;;</span><br><span class="line">	UObject* (*<span class="keyword">const</span> Z_Construct_UClass_AMyActor_Statics::DependentSingletons[])() = &#123;</span><br><span class="line">	(UObject* (*)())Z_Construct_UClass_AActor,</span><br><span class="line">	(UObject* (*)())Z_Construct_UPackage__Script_MicroEnd_423,</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> FClassFunctionLinkInfo Z_Construct_UClass_AMyActor_Statics::FuncInfo[] = &#123;</span><br><span class="line">	&#123; &amp;Z_Construct_UFunction_AMyActor_GetIval, <span class="string">&quot;GetIval&quot;</span> &#125;, <span class="comment">// 3480851337</span></span><br><span class="line">	&#123; &amp;Z_Construct_UFunction_AMyActor_TESTFUNC, <span class="string">&quot;TESTFUNC&quot;</span> &#125;, <span class="comment">// 2984899165</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>该类中的成员为：</p>
<ul>
<li><code>static UObject* (*const DependentSingletons[])();</code>记录当前类基类的<code>Z_Construct_UClass_BASECLASSNAME</code>函数指针，用它可以构造出基类的UClass，还记录了当前类属于哪个Package的函数指针<code>Z_Construct_UPackage__Script_MODULENAME</code>。</li>
</ul>
<blockquote>
<p><code>Z_Construct_UPackage__Script_MODULENAME</code>函数是定义在<code>MODULE_NAME.init.gen.cpp</code>里。</p>
</blockquote>
<ul>
<li><code>static const UE4CodeGen_Private::FMetaDataPairParam Class_MetaDataParams[];</code>用于记录UCLASS的元数据，如BlueprintType标记</li>
<li>反射属性的<code>F*PropertyParams</code>以及其Metadata，均为static成员</li>
<li><code>static const UE4CodeGen_Private::FPropertyParamsBase* const PropPointers[];</code>，数组，用于存储当前类所有的反射属性的信息（是个指针数组，用于存储5.3中的static成员的地址）</li>
<li><code>static const UE4CodeGen_Private::FImplementedInterfaceParams InterfaceParams[];</code>，数组，用于存储当前类所有的接口信息</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FImplementedInterfaceParams Z_Construct_UClass_AMyActor_Statics::InterfaceParams[] = &#123;</span><br><span class="line">	&#123; Z_Construct_UClass_UUnLuaInterface_NoRegister, (int32)VTABLE_OFFSET(AMyActor, IUnLuaInterface), <span class="literal">false</span> &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>static const FCppClassTypeInfoStatic StaticCppClassTypeInfo;</code>用于类型萃取，记录当前类是否是抽象类。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FCppClassTypeInfoStatic Z_Construct_UClass_AMyActor_Statics::StaticCppClassTypeInfo = &#123;</span><br><span class="line">		TCppClassTypeTraits&lt;AMyActor&gt;::IsAbstract,</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>static const UE4CodeGen_Private::FClassParams ClassParams;</code>构造出UClass需要的所有反射数据，统一记录上面所有生成的反射信息。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FClassParams Z_Construct_UClass_AMyActor_Statics::ClassParams = &#123;</span><br><span class="line">	&amp;AMyActor::StaticClass,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	&amp;StaticCppClassTypeInfo,</span><br><span class="line">	DependentSingletons,</span><br><span class="line">	FuncInfo,</span><br><span class="line">	Z_Construct_UClass_AMyActor_Statics::PropPointers,</span><br><span class="line">	InterfaceParams,</span><br><span class="line">	ARRAY_COUNT(DependentSingletons),</span><br><span class="line">	ARRAY_COUNT(FuncInfo),</span><br><span class="line">	ARRAY_COUNT(Z_Construct_UClass_AMyActor_Statics::PropPointers),</span><br><span class="line">	ARRAY_COUNT(InterfaceParams),</span><br><span class="line">	<span class="number">0x009000A0</span>u,</span><br><span class="line">	METADATA_PARAMS(Z_Construct_UClass_AMyActor_Statics::Class_MetaDataParams, ARRAY_COUNT(Z_Construct_UClass_AMyActor_Statics::Class_MetaDataParams))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>全局函数<code>Z_Construct_UClass_AMyActor</code>通过<code>ClassParams</code>构造出真正的UClass对象。</li>
<li>使用<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1673">IMPLEMENT_CLASS</a>注册当前类到<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L608">GetDeferredClassRegistration()</a>，如果在<code>WITH_HOT_RELOAD</code>为true的情况下也会注册到<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L616">GetDeferRegisterClassMap()</a>中。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Register a class at startup time.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_CLASS(TClass, TClassCrc) \</span></span><br><span class="line">	<span class="keyword">static</span> TClassCompiledInDefer&lt;TClass&gt; AutoInitialize##TClass(TEXT(#TClass), <span class="keyword">sizeof</span>(TClass), TClassCrc); \</span><br><span class="line">	UClass* TClass::GetPrivateStaticClass() \</span><br><span class="line">	&#123; \</span><br><span class="line">		<span class="keyword">static</span> UClass* PrivateStaticClass = <span class="literal">NULL</span>; \</span><br><span class="line">		<span class="keyword">if</span> (!PrivateStaticClass) \</span><br><span class="line">		&#123; \</span><br><span class="line">			<span class="comment">/* this could be handled with templates, but we want it external to avoid code bloat */</span> \</span><br><span class="line">			GetPrivateStaticClassBody( \</span><br><span class="line">				StaticPackage(), \</span><br><span class="line">				(TCHAR*)TEXT(#TClass) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>), \</span><br><span class="line">				PrivateStaticClass, \</span><br><span class="line">				StaticRegisterNatives##TClass, \</span><br><span class="line">				<span class="keyword">sizeof</span>(TClass), \</span><br><span class="line">				<span class="keyword">alignof</span>(TClass), \</span><br><span class="line">				(EClassFlags)TClass::StaticClassFlags, \</span><br><span class="line">				TClass::StaticClassCastFlags(), \</span><br><span class="line">				TClass::StaticConfigName(), \</span><br><span class="line">				(UClass::ClassConstructorType)InternalConstructor&lt;TClass&gt;, \</span><br><span class="line">				(UClass::ClassVTableHelperCtorCallerType)InternalVTableHelperCtorCaller&lt;TClass&gt;, \</span><br><span class="line">				&amp;TClass::AddReferencedObjects, \</span><br><span class="line">				&amp;TClass::Super::StaticClass, \</span><br><span class="line">				&amp;TClass::WithinClass::StaticClass \</span><br><span class="line">			); \</span><br><span class="line">		&#125; \</span><br><span class="line">		<span class="keyword">return</span> PrivateStaticClass; \</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>如<code>AMyActor</code>的<code>IMPLEMENT_CLASS(AMyActor,3240835608)</code>经过预处理之后为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> TClassCompiledInDefer&lt;AMyActor&gt; <span class="title">AutoInitializeAMyActor</span><span class="params">(TEXT(<span class="string">&quot;AMyActor&quot;</span>), <span class="keyword">sizeof</span>(AMyActor), <span class="number">3240835608</span>)</span></span>;</span><br><span class="line"><span class="function">UClass * <span class="title">AMyActor::GetPrivateStaticClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> UClass * PrivateStaticClass = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (!PrivateStaticClass) </span><br><span class="line">  &#123;</span><br><span class="line">    GetPrivateStaticClassBody(</span><br><span class="line">    	StaticPackage(), </span><br><span class="line">    	(TCHAR*)TEXT(<span class="string">&quot;AMyActor&quot;</span>) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>), </span><br><span class="line">    	PrivateStaticClass, </span><br><span class="line">    	StaticRegisterNativesAMyActor, </span><br><span class="line">    	<span class="keyword">sizeof</span>(AMyActor), </span><br><span class="line">    	<span class="keyword">alignof</span>(AMyActor), </span><br><span class="line">    	(EClassFlags)AMyActor::StaticClassFlags, </span><br><span class="line">    	AMyActor::StaticClassCastFlags(), </span><br><span class="line">    	AMyActor::StaticConfigName(), </span><br><span class="line">    	(UClass::ClassConstructorType)InternalConstructor&lt;AMyActor&gt;, </span><br><span class="line">    	(UClass::ClassVTableHelperCtorCallerType) InternalVTableHelperCtorCaller&lt;AMyActor&gt;, </span><br><span class="line">    	&amp;AMyActor::AddReferencedObjects, </span><br><span class="line">    	&amp;AMyActor::Super::StaticClass, </span><br><span class="line">    	&amp;AMyActor::WithinClass::StaticClass</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> PrivateStaticClass;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中<code>TClassCompiledInDefer&lt;TClass&gt;</code>这个模板类的构造函数中通过调用<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L643">UClassCompiledInDefer</a>将当前反射类的注册到<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L608">GetDeferredClassRegistration()</a>，它得到的是一个类型为<code>FFieldCompiledInInfo*</code>的数组，用于记录引擎中所有反射类的信息，用于在CoreUObjectModule启动时将UHT生成的这些反射信息在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L921">ProcessNewlyLoadedUObjects</a>函数中通过<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L745">UClassRegisterAllCompiledInClasses</a>将所有反射类的UClass构造出来。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Register all loaded classes */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UClassRegisterAllCompiledInClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	TArray&lt;UClass*&gt; AddedClasses;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	SCOPED_BOOT_TIMING(<span class="string">&quot;UClassRegisterAllCompiledInClasses&quot;</span>);</span><br><span class="line"></span><br><span class="line">	TArray&lt;FFieldCompiledInInfo*&gt;&amp; DeferredClassRegistration = GetDeferredClassRegistration();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> FFieldCompiledInInfo* Class : DeferredClassRegistration)</span><br><span class="line">	&#123;</span><br><span class="line">		UClass* RegisteredClass = Class-&gt;Register();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		<span class="keyword">if</span> (GIsHotReload &amp;&amp; Class-&gt;OldClass == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			AddedClasses.Add(RegisteredClass);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	DeferredClassRegistration.Empty();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	<span class="keyword">if</span> (AddedClasses.Num() &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		FCoreUObjectDelegates::RegisterHotReloadAddedClassesDelegate.Broadcast(AddedClasses);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而<code>TClassCompiledInDefer&lt;AMyActor&gt;</code>的<code>Register</code>函数就是调用<code>AMyActor::StaticClass</code>的，然后StaticClass中调用<code>GetPrivateStaticClass</code>，其中有一个static对象，就是当前类的UClass，所以它只会构造依次，使用<code>UXXXX::StaticClass</code>都是直接获得。</p>
<blockquote>
<p>注意：UClass的构造是跟着模块的启动创建的，所以之后当引擎启动到一个模块的时候它的UClass才被创建出来）。</p>
</blockquote>
<h3 id="非UCLASS的反射"><a href="#非UCLASS的反射" class="headerlink" title="非UCLASS的反射"></a>非UCLASS的反射</h3><p>有些继承自UObject的类是没有加UCLASS标记的，所以也不会包含<code>gen.cpp</code>和<code>generated.h</code>文件，但是UE也提供了非UCLASS的反射方法，类似于<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/Misc/TextBuffer.h#L14">UTextureBuffer</a>这个类。</p>
<p>在类内时添加<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1628">DECLARE_CASTED_CLASS_INTRINSIC_WITH_API</a>宏用于手动添加，实现类似UHT生成<code>GENERATED_BODY</code>宏的操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UTextBuffer</span></span></span><br><span class="line"><span class="class">	:</span> <span class="keyword">public</span> UObject</span><br><span class="line">	, <span class="keyword">public</span> FOutputDevice</span><br><span class="line">&#123;</span><br><span class="line">	DECLARE_CASTED_CLASS_INTRINSIC_WITH_API(UTextBuffer, UObject, <span class="number">0</span>, TEXT(<span class="string">&quot;/Script/CoreUObject&quot;</span>), CASTCLASS_None, COREUOBJECT_API)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1628">DECLARE_CASTED_CLASS_INTRINSIC_WITH_API</a>可以处理类似<code>generated.h</code>的行为，但是<code>gen.cpp</code>里创建出<code>static TClassCompiledInDefer&lt;CLASS_NAME&gt;</code>的代码还没有，UE提供了另一个宏:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IMPLEMENT_CORE_INTRINSIC_CLASS(UTextBuffer, UObject, &#123; &#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1731">IMPLEMENT_CORE_INTRINSIC_CLASS</a>，用来生成类似gen.cpp中的代码， 还可以通过宏的第三个参数来传入代码。</li>
</ul>
<p>虽然和<code>gen.cpp</code>里通过UHT生成的代码不同，但是统一使用<code>TClassCompiledInDefer&lt;TClass&gt;</code>和<code>FCompiledInDefer</code>来注册到引擎中。<br>这样就实现了可以不使用UCLASS标记也可以为继承自UObject的类生成反射信息。</p>
<h3 id="UClass的构造思路"><a href="#UClass的构造思路" class="headerlink" title="UClass的构造思路"></a>UClass的构造思路</h3><p>前面讲了这么多都是在分析UE创建UClass的代码，我想从UE的实现思路上分析一下设计过程。</p>
<ol>
<li>首先UHT通过分析代码创建出gen.cpp和generated.h中间记录着当前类的反射信息、类本身的反射信息、类中函数的反射信息、类数据成员的反射信息。</li>
<li>当前类的反射信息（类、成员函数、数据成员）等被统一存储在一个名为<code>Z_Construct_UClass_CLASSNAME_Statics</code>的结构中；</li>
<li>该结构通过<code>IMPLEMENT_CLASS</code>生成的代码将当前类添加到<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L608">GetDeferredClassRegistration()</a>中。因为<strong>全局作用域static对象的构造时机</strong>是先于主函数的第一条语句的，所以当进入引擎逻辑的时候，引擎内置的模块中类的<code>TClassCompiledInDefer&lt;&gt;</code>都已经被创建完毕，在编辑器模式下， 因为不同的模块都是编译为DLL的，所以在加载模块的时候它们的static对象才会被创建。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> TClassCompiledInDefer&lt;AMyActor&gt; <span class="title">AutoInitializeAMyActor</span><span class="params">(TEXT(<span class="string">&quot;AMyActor&quot;</span>), <span class="keyword">sizeof</span>(AMyActor), <span class="number">3240835608</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>与上一步同样的手法，把类生成的反射信息通过<code>FCompiledInDefer</code>收集到<code>GetDeferredCompiledInRegistration()</code></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> FCompiledInDefer <span class="title">Z_CompiledInDefer_UClass_AMyActor</span><span class="params">(Z_Construct_UClass_AMyActor, &amp;AMyActor::StaticClass, TEXT(<span class="string">&quot;/Script/MicroEnd_423&quot;</span>), TEXT(<span class="string">&quot;AMyActor&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br></pre></td></tr></table></figure>



<h4 id="引擎如何使用生成的反射信息"><a href="#引擎如何使用生成的反射信息" class="headerlink" title="引擎如何使用生成的反射信息"></a>引擎如何使用生成的反射信息</h4><p>在UHT生成反射的代码之后，引擎会根据这些代码生成UClass、UStruct、UEnum、UFunction和UProperty等。</p>
<p>它们都是在<code>ProcessNewlyLoadedUObjects</code>中被执行的，<strong>注意</strong>该函数会进来很多次，当每一个模块被加载的时候都会走一遍，因为在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Private/UObject/Obj.cpp#L4326">Obj.cpp</a>的<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Private/UObject/Obj.cpp#L4326">InitUObject</a>函数中，把函数<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectBase.cpp#L921">ProcessNewlyLoadedUObjects</a>添加到了<code>FModuleManager::Get().OnProcessLoadedObjectsCallback()</code>中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !USE_PER_MODULE_UOBJECT_BOOTSTRAP <span class="comment">// otherwise this is already done</span></span></span><br><span class="line">	FModuleManager::Get().OnProcessLoadedObjectsCallback().AddStatic(ProcessNewlyLoadedUObjects);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>之所以</strong>要这么做，是因为UE的Module中都会有很多的反射类，但引擎一启动并不是所有的类在同一时刻都被加载了，因为模块有不同的加载时机，所以引擎中对于UClass的构造也不是一个一次性过程。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Private/UObject/UObjectBase.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProcessNewlyLoadedUObjects</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LLM_SCOPE(ELLMTag::UObject);</span><br><span class="line">	DECLARE_SCOPE_CYCLE_COUNTER(TEXT(<span class="string">&quot;ProcessNewlyLoadedUObjects&quot;</span>), STAT_ProcessNewlyLoadedUObjects, STATGROUP_ObjectVerbose);</span><br><span class="line"></span><br><span class="line">	UClassRegisterAllCompiledInClasses();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> TArray&lt;UClass* (*)()&gt;&amp; DeferredCompiledInRegistration = GetDeferredCompiledInRegistration();</span><br><span class="line">	<span class="keyword">const</span> TArray&lt;FPendingStructRegistrant&gt;&amp; DeferredCompiledInStructRegistration = GetDeferredCompiledInStructRegistration();</span><br><span class="line">	<span class="keyword">const</span> TArray&lt;FPendingEnumRegistrant&gt;&amp; DeferredCompiledInEnumRegistration = GetDeferredCompiledInEnumRegistration();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> bNewUObjects = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">while</span>( GFirstPendingRegistrant || DeferredCompiledInRegistration.Num() || DeferredCompiledInStructRegistration.Num() || DeferredCompiledInEnumRegistration.Num() )</span><br><span class="line">	&#123;</span><br><span class="line">		bNewUObjects = <span class="literal">true</span>;</span><br><span class="line">		UObjectProcessRegistrants();</span><br><span class="line">		UObjectLoadAllCompiledInStructs();</span><br><span class="line">		UObjectLoadAllCompiledInDefaultProperties();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	UClassReplaceHotReloadClasses();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bNewUObjects &amp;&amp; !GIsInitialLoad)</span><br><span class="line">	&#123;</span><br><span class="line">		UClass::AssembleReferenceTokenStreams();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UClass构造的调用栈：</p>
<p><img data-src="index/UE4/ue4-reflex/ue4-uclass-register-all-compiled.webp"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Private/UObject/UObjectBase.cpp</span></span><br><span class="line"><span class="comment">/** Register all loaded classes */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UClassRegisterAllCompiledInClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	TArray&lt;UClass*&gt; AddedClasses;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	TArray&lt;FFieldCompiledInInfo*&gt;&amp; DeferredClassRegistration = GetDeferredClassRegistration();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> FFieldCompiledInInfo* Class : DeferredClassRegistration)</span><br><span class="line">	&#123;</span><br><span class="line">		UClass* RegisteredClass = Class-&gt;Register();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		<span class="keyword">if</span> (GIsHotReload &amp;&amp; Class-&gt;OldClass == <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			AddedClasses.Add(RegisteredClass);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	DeferredClassRegistration.Empty();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">	<span class="keyword">if</span> (AddedClasses.Num() &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		FCoreUObjectDelegates::RegisterHotReloadAddedClassesDelegate.Broadcast(AddedClasses);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，在<code>UClassRegisterAllCompiledInClasses</code>只是去调用了每个反射类的StaticClass函数（<code>Class-&gt;Register()</code>内部是对类型的<code>StaticClass</code>的转发调用），在开启<code>WITH_HOT_RELOAD</code>的情况下也会把新的UClass给代理调用传递出去，然后把当前的数组置空。</p>
<p>之所以要置空，就是因为前面说的，UE的UClass构造是一个模块一个模块来执行的，当一个模块执行完毕之后就把当前模块注册到<code>GetDeferredClassRegistration()</code>里的元素置空，等着下个模块启动的时候（加载DLL时它们的static成员会构造然后注册到里面），再执行<code>LoadModuleWithFailureReason</code>就是又一遍循环。</p>
<p>在模块启动的时候会执行<code>LoadModuleWithFailureReason</code>里面调用了这个Delegate，所以每一个模块启动的时候都会执行<code>ProcessNewlyLoadedUObjects</code>，把自己当前模块中的UClass/UStruct/UEnum都构造出来。</p>
<h2 id="函数反射"><a href="#函数反射" class="headerlink" title="函数反射"></a>函数反射</h2><h3 id="UHT生成的反射信息"><a href="#UHT生成的反射信息" class="headerlink" title="UHT生成的反射信息"></a>UHT生成的反射信息</h3><p>在UE的代码中加了<code>UFUNCTION()</code>修饰后UHT就会为该函数生成反射代码。</p>
<p>每一个支持反射的函数UHT都会给它生成一个类和一个函数：<br>如在<code>AMyActor</code>这个类下有一个<code>ReflexFunc</code>的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UFUNCTION()</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ReflexFunc</span><span class="params">(int32 InIval, UObject* InObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UHT会生成这样命名规则的一个类和函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UHT为ReflexFunc生成的反射代码</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc_Statics</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventReflexFunc_Parms</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		int32 InIval;</span><br><span class="line">		UObject* InObj;</span><br><span class="line">		<span class="keyword">bool</span> ReturnValue;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">NewProp_ReturnValue_SetBit</span><span class="params">(<span class="keyword">void</span>* Obj)</span></span>;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FBoolPropertyParams NewProp_ReturnValue;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams NewProp_InObj;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams NewProp_InIval;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> PropPointers[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Function_MetaDataParams[];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FFunctionParams FuncParams;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue_SetBit</span><span class="params">(<span class="keyword">void</span>* Obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	((MyActor_eventReflexFunc_Parms*)Obj)-&gt;ReturnValue = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FBoolPropertyParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue = &#123;</span><br><span class="line">	 <span class="string">&quot;ReturnValue&quot;</span>,</span><br><span class="line">	 <span class="literal">nullptr</span>,</span><br><span class="line">	 (EPropertyFlags)<span class="number">0x0010000000000580</span>,</span><br><span class="line">	 UE4CodeGen_Private::EPropertyGenFlags::Bool | UE4CodeGen_Private::EPropertyGenFlags::NativeBool,</span><br><span class="line">	 RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	 <span class="number">1</span>,</span><br><span class="line">	 <span class="keyword">sizeof</span>(<span class="keyword">bool</span>),</span><br><span class="line">	 <span class="keyword">sizeof</span>(MyActor_eventReflexFunc_Parms),</span><br><span class="line">	 &amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue_SetBit,</span><br><span class="line">	 METADATA_PARAMS(<span class="literal">nullptr</span>,</span><br><span class="line">	 <span class="number">0</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FObjectPropertyParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InObj = &#123;</span><br><span class="line">	 <span class="string">&quot;InObj&quot;</span>,</span><br><span class="line">	 <span class="literal">nullptr</span>,</span><br><span class="line">	 (EPropertyFlags)<span class="number">0x0010000000000080</span>,</span><br><span class="line">	 UE4CodeGen_Private::EPropertyGenFlags::Object,</span><br><span class="line">	 RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	 <span class="number">1</span>,</span><br><span class="line">	 STRUCT_OFFSET(MyActor_eventReflexFunc_Parms,</span><br><span class="line">	 InObj),</span><br><span class="line">	 Z_Construct_UClass_UObject_NoRegister,</span><br><span class="line">	 METADATA_PARAMS(<span class="literal">nullptr</span>,</span><br><span class="line">	 <span class="number">0</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InIval = &#123;</span><br><span class="line">	 <span class="string">&quot;InIval&quot;</span>,</span><br><span class="line">	 <span class="literal">nullptr</span>,</span><br><span class="line">	 (EPropertyFlags)<span class="number">0x0010000000000080</span>,</span><br><span class="line">	 UE4CodeGen_Private::EPropertyGenFlags::Int,</span><br><span class="line">	 RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	 <span class="number">1</span>,</span><br><span class="line">	 STRUCT_OFFSET(MyActor_eventReflexFunc_Parms,</span><br><span class="line">	 InIval),</span><br><span class="line">	 METADATA_PARAMS(<span class="literal">nullptr</span>,</span><br><span class="line">	 <span class="number">0</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::PropPointers[] = &#123;</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_ReturnValue,</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InObj,</span><br><span class="line">	(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::NewProp_InIval,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::Function_MetaDataParams[] = &#123;</span><br><span class="line">	&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>,</span><br><span class="line">	 <span class="string">&quot;MyActor.h&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FFunctionParams Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::FuncParams = &#123; (UObject*(*)())Z_Construct_UClass_AMyActor,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	<span class="string">&quot;ReflexFunc&quot;</span>,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	<span class="literal">nullptr</span>,</span><br><span class="line">	<span class="keyword">sizeof</span>(MyActor_eventReflexFunc_Parms),</span><br><span class="line">	Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::PropPointers,</span><br><span class="line">	UE_ARRAY_COUNT(Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::PropPointers),</span><br><span class="line">	RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">	(EFunctionFlags)<span class="number">0x00020401</span>,</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	METADATA_PARAMS(Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::Function_MetaDataParams,</span><br><span class="line">	UE_ARRAY_COUNT(Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::Function_MetaDataParams))</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过UHT生成的反射信息来构造出UFunction</span></span><br><span class="line"><span class="function">UFunction* <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> UFunction* ReturnFunction = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> (!ReturnFunction)</span><br><span class="line">	&#123;</span><br><span class="line">		UE4CodeGen_Private::ConstructUFunction(ReturnFunction, Z_Construct_UFunction_AMyActor_ReflexFunc_Statics::FuncParams);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ReturnFunction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义的<code>Z_Construct_UFunction_AMyActor_ReflexFunc_Statics</code>类中包含了以下信息：</p>
<ol>
<li>存储函数的参数、返回值的结构体(POD)，注意该结构的声明顺序是按照函数参数的顺序+最后一个成员是函数返回值的方式排列。</li>
<li>函数参数、返回值的<code>F*PropertyParams</code>，用来给函数的每个参数以及返回值生成反射信息，用于构造出UProperty，static成员；</li>
<li>成员<code>static const UE4CodeGen_Private::FPropertyParamsBase* const PropPointers[];</code>，数组，用于记录该函数的参数和返回值的类型为<code>FPropertyParamsBase</code>的static数据成员的地址。</li>
<li>成员<code>static const UE4CodeGen_Private::FMetaDataPairParam Function_MetaDataParams[];</code>，用于记录函数的元数据。如所属文件、Category、注释等等。</li>
<li>成员<code>static const UE4CodeGen_Private::FFunctionParams FuncParams;</code>用于记录当前函数的名字、Flag、参数的<code>F*PropertyParams</code>、参数数量，参数的结构大小等等，用于通过它来创建出<code>UFunction*</code>。</li>
<li>至于生成的<code>SetBit</code>d的函数的作用，在上面属性反射的部分已经讲到了。</li>
</ol>
<p><code>UE4CodeGen_Private::FFunctionParams</code>结构声明为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FFunctionParams</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	UObject*                          (*OuterFunc)();</span><br><span class="line">	UFunction*                        (*SuperFunc)();</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         NameUTF8;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         OwningClassName;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*                         DelegateName;</span><br><span class="line">	SIZE_T                              StructureSize;</span><br><span class="line">	<span class="keyword">const</span> FPropertyParamsBase* <span class="keyword">const</span>*   PropertyArray;</span><br><span class="line">	int32                               NumProperties;</span><br><span class="line">	EObjectFlags                        ObjectFlags;</span><br><span class="line">	EFunctionFlags                      FunctionFlags;</span><br><span class="line">	uint16                              RPCId;</span><br><span class="line">	uint16                              RPCResponseId;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam*           MetaDataArray;</span><br><span class="line">	int32                               NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>UHT生成的<code>Z_Construct_UFunction_AMyActor_ReflexFunc</code>函数做了以下事情：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UFunction* <span class="title">Z_Construct_UFunction_AMyActor_ReflexFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> UFunction* ReturnFunction = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> (!ReturnFunction)</span><br><span class="line">	&#123;</span><br><span class="line">		UE4CodeGen_Private::ConstructUFunction(ReturnFunction, Z_Construct_UFunction_AMyActor_Add_Statics::FuncParams);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ReturnFunction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据定义的<code>Z_Construct_UFunction_AMyActor_ReflexFunc_Statics</code>结构中的<code>FuncParams</code>成员来创建出真正的<code>UFunction</code>对象。</p>
<p>最后，<code>Z_Construct_UFunction_AMyActor_ReflexFunc</code>这个函数会被注册到当前类反射数据的<code>FuncInfo</code>中。</p>
<h3 id="Thunk函数"><a href="#Thunk函数" class="headerlink" title="Thunk函数"></a>Thunk函数</h3><p>UE会为标记为<code>UFUNCTION</code>的Native函数生成对应的Thunk函数(<code>BlueprintImplementableEvent</code>的函数不会)。如下列函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UFUNCTION()</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ReflexFunc</span><span class="params">(int32 InIval, UObject* InObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成的Thunk函数形式如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line">DECLARE_FUNCTION(execReflexFunc);</span><br><span class="line"></span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line">DEFINE_FUNCTION(AMyActor::execReflexFunc)</span><br><span class="line">&#123;</span><br><span class="line">	P_GET_PROPERTY(FIntProperty,Z_Param_InIval);</span><br><span class="line">	P_GET_OBJECT(UObject,Z_Param_InObj);</span><br><span class="line">	P_FINISH;</span><br><span class="line">	P_NATIVE_BEGIN;</span><br><span class="line">	*(<span class="keyword">bool</span>*)Z_Param__Result=P_THIS-&gt;ReflexFunc(Z_Param_InIval,Z_Param_InObj);</span><br><span class="line">	P_NATIVE_END;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DECLARE_FUNCTION</code>/<code>DEFINE_FUNCTION</code>这两个宏是定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L632">CoreUObject/Public/UObject/ObjectMacros.h</a>中的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This macro is used to declare a thunk function in autogenerated boilerplate code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_FUNCTION(func) static void func( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This macro is used to define a thunk function in autogenerated boilerplate code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_FUNCTION(func) void func( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span><br></pre></td></tr></table></figure>

<p>展开这两个宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AMyActor::execReflexFunc</span><span class="params">( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span>;</span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AMyActor::execReflexFunc</span><span class="params">( UObject* Context, FFrame&amp; Stack, RESULT_DECL )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	P_GET_PROPERTY(FIntProperty,Z_Param_InIval);</span><br><span class="line">	P_GET_OBJECT(UObject,Z_Param_InObj);</span><br><span class="line">	P_FINISH;</span><br><span class="line">	P_NATIVE_BEGIN;</span><br><span class="line">	*(<span class="keyword">bool</span>*)Z_Param__Result=P_THIS-&gt;ReflexFunc(Z_Param_InIval,Z_Param_InObj);</span><br><span class="line">	P_NATIVE_END;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，UHT为每个反射函数生成的都是一个参数一致的static成员函数，接收通用的参数，就可以用来处理所有的函数调用。</p>
<p>Thunk函数中用到的这些宏：</p>
<p>RESULT_DECL(<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/Script.h#L68">CoreUObject/Public/UObject/Script.h</a>)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Blueprint VM intrinsic return value declaration.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RESULT_PARAM Z_Param__Result</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RESULT_DECL void*const RESULT_PARAM</span></span><br></pre></td></tr></table></figure>

<p>其他的形如<code>P_GET_PROPERTY</code>之类的宏，都是定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/ScriptMacros.h">CoreUObject/Public/UObject/ScriptMacros.h</a>文件中的，作用就是从栈上操作参数（因为Thunk函数是通用的参数，所以要从通用的参数中获取到每个函数具体的参数，UE提供这些宏来做这些事情）。</p>
<p>这些Thunk函数通过UHT生成的<code>StaticRegisterNatives*</code>函数注册到UClass中（在<code>GetPrivateStaticClass</code>把该函数指针传递了进去）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AMyActor::StaticRegisterNativesAMyActor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UClass* Class = AMyActor::StaticClass();</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FNameNativePtrPair Funcs[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;BPNativeEvent&quot;</span>, &amp;AMyActor::execBPNativeEvent &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;ReflexFunc&quot;</span>, &amp;AMyActor::execReflexFunc &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line">	FNativeFunctionRegistrar::RegisterFunctions(Class, Funcs, UE_ARRAY_COUNT(Funcs));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UE不会为<code>BlueprintImplementableEvent</code>生成Thunk函数，但是会为它生成函数的反射信息，所以也可以通过反射的信息来调用<code>BlueprintImplementableEvent</code>的函数。</p>
<p>因为`BlueprintImplementatableEventd的函数是C++提供原型不提供实现，让蓝图来进行覆写的，所以它不使用Thunk的形式调用（应该执行字节码的方式，这个暂时还没看到，有时间再来分析）。</p>
<h3 id="Custom-Thunk"><a href="#Custom-Thunk" class="headerlink" title="Custom Thunk"></a>Custom Thunk</h3><p>前面讲到当给函数加了<code>UFUNCTION</code>标记时UHT会给我们生成对应的Thunk函数，但是有些情况下需要我们自己来写Thunk的函数，如<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/Engine/Classes/Kismet/KismetArrayLibrary.h">UKismetArrayLibrary</a>中的对Array进行操作的函数，或者<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/Engine/Classes/Kismet/DataTableFunctionLibrary.h#L51">UDataTableFunctionLibrary</a>中的<code>GetDataTableRowFromName</code>函数。</p>
<p>UE提供了让我们自己实现Thunk函数的方法，在<code>UFUNCTION</code>中添加<code>CustomThunk</code>标记：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UFUNCTION(CustomThunk)</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ReflexFunc</span><span class="params">(int32 InIval, UObject* InObj)</span></span></span><br></pre></td></tr></table></figure>

<p>这样UHT就不会为这个函数生成出它的Thunk函数，这种情况下就需要自己提供了。自己写的方式和UHT生成的代码一样，可以使用<code>DECLARE_FUNCTION</code>或者<code>DEFINE_FUNCTION</code>（手动写按照Thunk函数的签名规则也是没问题的）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DECLARE_FUNCTION(execReflexFunc)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// do something...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行时访问反射函数"><a href="#运行时访问反射函数" class="headerlink" title="运行时访问反射函数"></a>运行时访问反射函数</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UFunction&gt; It(InActor-&gt;GetClass()); It; ++It)</span><br><span class="line">&#123;</span><br><span class="line">	UFunction* FuncProperty = *It;</span><br><span class="line">	<span class="keyword">if</span> (FuncProperty-&gt;GetName() == TEXT(<span class="string">&quot;GetIval&quot;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">CallParam</span></span></span><br><span class="line"><span class="class">		&#123;</span></span><br><span class="line">			int32 ival;</span><br><span class="line">		&#125;CallParamIns;</span><br><span class="line">		InActor-&gt;ProcessEvent(FuncProperty, &amp;CallParamIns);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过ProcessEvent来调用，第二个参数传递进去参数和返回值的结构。</p>
<p>每个被反射的函数UHT都会给它生成一个<strong>参数的结构体</strong>，其排列的顺序为：函数参数依次排列，最后一个成员为返回值。如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UFUNCTION()</span><br><span class="line">	<span class="function">int32 <span class="title">Add</span><span class="params">(int32 R, int32 L)</span></span>;</span><br></pre></td></tr></table></figure>
<p>UHT为其生成的参数结构为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventAdd_Parms</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	int32 R;</span><br><span class="line">	int32 L;</span><br><span class="line">	int32 ReturnValue;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在通过UFunction*来调用函数时，需要把这个布局的结构传递作为传递给函数的参数以及接收返回值：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UFunction&gt; It(InActor-&gt;GetClass()); It; ++It)</span><br><span class="line">&#123;</span><br><span class="line">  UFunction* Property = *It;</span><br><span class="line">  <span class="keyword">if</span> (Property-&gt;GetName() == TEXT(<span class="string">&quot;Add&quot;</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AddFuncCallParam</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      int32 R;</span><br><span class="line">      int32 L;</span><br><span class="line">      int32 RetValue;</span><br><span class="line">    &#125;CallParamIns;</span><br><span class="line">    CallParamIns.R = <span class="number">123</span>;</span><br><span class="line">    CallParamIns.L = <span class="number">456</span>;</span><br><span class="line">    InActor-&gt;ProcessEvent(Property, &amp;CallParamIns);</span><br><span class="line">    UE_LOG(LogTemp, Log, TEXT(<span class="string">&quot;UFunction:%s value:%d&quot;</span>), *Property-&gt;GetName(), CallParamIns.RetValue);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="index/UE4/ue4-reflex/ue4-call-ufunction-receive-ret-value.webp"></p>
<p>可以通过<code>UFunction</code>拿到当前函数的参数的结构的大小<code>UFunction::ParmsSize</code>，在运行时动态访问的话可以通过这个结构大小分配出一块内存，然后用UProperty对这块内存进行访问，因为通过UProperty访问成员其实本质上也是通过该成员在类内的偏移来做的（对数据成员获取成员指针得到的是一个相对于对象基址的偏移值）。</p>
<h3 id="坑点-1"><a href="#坑点-1" class="headerlink" title="坑点"></a>坑点</h3><p>注意：通过UE的UFunction调用并不能正确地处理引用类型，如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UFUNCTION()</span><br><span class="line">	<span class="function">int32&amp; <span class="title">Add</span><span class="params">(int32 R, int32&amp; L)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这个函数生成的反射代码和非引用的一摸一样（对L参数生成的UProperty的Flag会多一个<code>CPF_OutParm</code>，返回值的UProperty还具有<code>CPF_ReturnParm</code>）。<br>这会造成通过<code>UFunction*</code>调用传递的参数和想要获取的返回值都只是一份拷贝（因为本来调用时的参数传递到ProcessEvent之前都会被赋值到UHT创建出来的参数结构），不能再后续的流程中对得到的结果进行赋值。</p>
<p><strong>而且</strong>，通过遍历UFunction得到的参数和返回值<code>UProperty</code>，其中的Offset值是相对于UHT生成的参数结构。</p>
<p>在获取蓝图或者C++中具有多个返回值UFunction的时候，因为UE的具有多个返回值的机制是通过传递进来引用实现的，所以不能够只是通过检测UProperty是否具有<code>CPF_ReturnValue</code>来检测，因为包含该flag的UProperty只有一个，还需要检测<code>CPF_OutParam</code>来判断是都是通过引用方式传递的“返回值”。</p>
<h2 id="属性反射"><a href="#属性反射" class="headerlink" title="属性反射"></a>属性反射</h2><p>当在UCLASS类中给一个属性添加<code>UPROPERTY</code>标记时：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">UCLASS()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MICROEND_423_API</span> <span class="title">AMyActor</span> :</span> <span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">	GENERATED_BODY()</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">// Called when the game starts or when spawned</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BeginPlay</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:	</span><br><span class="line">	<span class="comment">// Called every frame</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Tick</span><span class="params">(<span class="keyword">float</span> DeltaTime)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	UPROPERTY(EditAnywhere)</span><br><span class="line">			int32 ival;</span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure>
<p>会生成反射代码，生成反射代码的代码是在UHT中的<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealHeaderTool/Private/CodeGenerator.cpp#L1063">Programs/UnrealHeaderTool/Private/CodeGenerator.cpp</a>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;MyActor&quot;</span> &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/MyActor.h&quot;</span> &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_ival = &#123;</span><br><span class="line">  <span class="string">&quot;ival&quot;</span>,</span><br><span class="line">  <span class="literal">nullptr</span>,</span><br><span class="line">  (EPropertyFlags) <span class="number">0x0010000000000001</span>,</span><br><span class="line">  UE4CodeGen_Private::EPropertyGenFlags::Int,</span><br><span class="line">  RF_Public | RF_Transient | RF_MarkAsNative,</span><br><span class="line">  <span class="number">1</span>,</span><br><span class="line">  STRUCT_OFFSET(AMyActor, ival),</span><br><span class="line">  METADATA_PARAMS(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData, ARRAY_COUNT(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>首先<code>const UE4CodeGen_Private::FIntPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_ival</code>是创建出一个结构，用于记录当前属性的信息，比如变量名、相对于对象起始地址的偏移。</p>
<blockquote>
<p>注意<code>UE4CodeGen_Private::FIntPropertyParams</code>这样的类型都是定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.24.3-release/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h">UObject/UObjectGlobals.h</a>中的，对于基础类型的属性（如int8/int32/float/array/map）等使用的都是<code>FGenericPropertyParams</code>。</p>
</blockquote>
<h3 id="F-PropertyParams"><a href="#F-PropertyParams" class="headerlink" title="F*PropertyParams"></a>F*PropertyParams</h3><p>在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.24.3-release/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h">UObject/UObjectGlobals.h</a>文件中，引擎里定义了很多的<code>F*PropertyParams</code>，但是他们的数据结构基本相同（但是他们并没有继承关系），都是POD的类型，每个数据依次排列，而且不同类型的Params尽量都保持了一致的顺序。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGenericPropertyParams</span> // :</span> FPropertyParamsBaseWithOffset</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*       NameUTF8;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*       RepNotifyFuncUTF8;</span><br><span class="line">	EPropertyFlags    PropertyFlags;</span><br><span class="line">	EPropertyGenFlags Flags;</span><br><span class="line">	EObjectFlags      ObjectFlags;</span><br><span class="line">	int32             ArrayDim;</span><br><span class="line">	int32             Offset;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam* Z_Construct_UClass_;</span><br><span class="line">	int32                     NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>一个一个来分析它的参数。</p>
<h4 id="NameUTF8"><a href="#NameUTF8" class="headerlink" title="NameUTF8"></a>NameUTF8</h4><p>NameUTF8是属性的UTF8的名字，在运行时可以通过<code>UProperty</code>的<code>GetNameCPP</code>来获取。</p>
<h4 id="RepNotifyFuncUTF8"><a href="#RepNotifyFuncUTF8" class="headerlink" title="RepNotifyFuncUTF8"></a>RepNotifyFuncUTF8</h4><p>RepNotifyFuncUTF8是在当前属性绑定的修改之后的函数名字。</p>
<p>如果属性是这样声明：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UPROPERTY(EditAnywhere,ReplicatedUsing=OnRep_Replicatedival)</span><br><span class="line">	int32 ival;</span><br><span class="line">UFUNCTION()</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnRep_Replicatedival</span><span class="params">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这样生成的反射代码就为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FIntPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_ival = &#123; </span><br><span class="line">	<span class="string">&quot;ival&quot;</span>, </span><br><span class="line">	<span class="string">&quot;OnRep_Replicatedival&quot;</span>, </span><br><span class="line">	(EPropertyFlags)<span class="number">0x0010000100000021</span>,</span><br><span class="line">    UE4CodeGen_Private::EPropertyGenFlags::Int,</span><br><span class="line">    RF_Public|RF_Transient|RF_MarkAsNative, </span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    STRUCT_OFFSET(AMyActor, ival),</span><br><span class="line">  METADATA_PARAMS(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData,ARRAY_COUNT(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData))</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因为<code>OnRep_Replicatedival</code>也是UFUNCTION的函数，所以可以通过反射来访问。</p>
<h4 id="PropertyFlags"><a href="#PropertyFlags" class="headerlink" title="PropertyFlags"></a>PropertyFlags</h4><p><code>PropertyFlags</code>是一个类型为<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L361">EPropertyFlags</a>的枚举，枚举值按照位排列，根据在UPROPERTY中的标记来按照位或来记录当前属性包含的标记信息。<br>在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealHeaderTool/Private/CodeGenerator.cpp#L1063">UnrealHeaderTool/Private/CodeGenerator.cpp</a>中生成代码时会根据当前属性的flag和<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L442">CPF_ComputedFlags</a>做位运算：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">// All the properties that should never be loaded or saved</span></span><br><span class="line"><span class="comment">#define CPF_ComputedFlags			(CPF_IsPlainOldData | CPF_NoDestructor | CPF_ZeroConstructor | CPF_HasGetValueTypeHash)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">0x0000000040000000 CPF_IsPlainOldData </span></span><br><span class="line"><span class="comment">0x0000001000000000 CPF_NoDestructor </span></span><br><span class="line"><span class="comment">0x0000000000000200 CPF_ZeroConstructor </span></span><br><span class="line"><span class="comment">0x0008000000000000 CPF_HasGetValueTypeHash</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">EPropertyFlags PropFlags = Prop-&gt;PropertyFlags &amp; ~CPF_ComputedFlags;</span><br></pre></td></tr></table></figure>
<p>在运行时可以通过<code>UProperty</code>的<code>HasAnyPropertyFlags</code>函数来检测是否具有特定的flag。</p>
<p>一般情况下，可以通过<code>UProperty</code>来获取到该参数的标记属性，比如当通过<code>UFunction</code>获取函数的参数时，可以区分哪个UProperty是输入参数、哪个是返回值。</p>
<h4 id="Flags"><a href="#Flags" class="headerlink" title="Flags"></a>Flags</h4><p>第四个参数<code>Flags</code>是类型为<code>UE4CodeGen_Private::EPropertyGenFlags</code>是一个枚举，定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h#L2231">UObject/UObjectGlobals.h</a>中，标记了当前Property的类型。</p>
<h4 id="ObjectFlags"><a href="#ObjectFlags" class="headerlink" title="ObjectFlags"></a>ObjectFlags</h4><p>ObjectFlags是<code>EObjectFlags</code>类型的枚举，其枚举值也是按照位来划分的。定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L474">CoreUObject/Public/UObject/ObjectMacros.h</a></p>
<p>UHT生成这部分代码在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealHeaderTool/Private/CodeGenerator.cpp#L1063">Programs/UnrealHeaderTool/Private/CodeGenerator.cpp</a>中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> TCHAR*   FPropertyObjectFlags = FClass::IsOwnedByDynamicType(Prop) ? TEXT(<span class="string">&quot;RF_Public|RF_Transient&quot;</span>) : TEXT(<span class="string">&quot;RF_Public|RF_Transient|RF_MarkAsNative&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>通过<code>FClass::IsOwnedByDynamicType</code>函数来检测是否为PROPERTY添加<code>RF_MarkAsNative</code>的flag。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Programs/UnrealHeaderTool/Public/ParserClass.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Helper function that checks if the field is a dynamic type (can be constructed post-startup) */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsDynamic</span><span class="params">(<span class="keyword">const</span> T* Field)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Field-&gt;HasMetaData(NAME_ReplaceConverted);</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="comment">// Programs/UnrealHeaderTool/Private/ParserClass.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FClass::IsOwnedByDynamicType</span><span class="params">(<span class="keyword">const</span> UField* Field)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> UField* OuterField = Cast&lt;<span class="keyword">const</span> UField&gt;(Field-&gt;GetOuter()); OuterField; OuterField = Cast&lt;<span class="keyword">const</span> UField&gt;(OuterField-&gt;GetOuter()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (IsDynamic(OuterField))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FClass::IsOwnedByDynamicType</span><span class="params">(<span class="keyword">const</span> FField* Field)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (FFieldVariant Owner = Field-&gt;GetOwnerVariant(); Owner.IsValid(); Owner = Owner.GetOwnerVariant())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Owner.IsUObject())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> IsOwnedByDynamicType(Cast&lt;<span class="keyword">const</span> UField&gt;(Owner.ToUObject()));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (IsDynamic(Owner.ToField()))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过调用<code>UField</code>的<code>HasMetaData</code>检测是否具有<code>TEXT(&quot;ReplaceConverted&quot;)</code>的元数据（该元数据就是后面要讲到的Metadata）。</p>
<h4 id="ArrayDim"><a href="#ArrayDim" class="headerlink" title="ArrayDim"></a>ArrayDim</h4><p>ArrayDim用于记录当前属性的元素数量，当只是声明一个单个对象时，如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">UPROPERTY()</span><br><span class="line">	<span class="keyword">float</span> fval;</span><br><span class="line">UPROPERTY(EditAnywhere)</span><br><span class="line">	FString StrVal = TEXT(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">UPROPERTY(EditAnywhere)</span><br><span class="line">	TSubclassOf&lt;UObject&gt; ClassVal;</span><br><span class="line">UPROPERTY(EditAnywhere)</span><br><span class="line">	UTexture2D* Texture2D;</span><br><span class="line">UPROPERTY()</span><br><span class="line">	FResultDyDlg ResultDlg;</span><br><span class="line">UPROPERTY()</span><br><span class="line">	UMySceneComponent* SceneComp;</span><br></pre></td></tr></table></figure>
<p>这些属性所有的<code>ArrayDim</code>均为1.</p>
<p>但是当使用C++原生数组时：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPROPERTY()</span><br><span class="line">	int32 iArray[<span class="number">12</span>];</span><br></pre></td></tr></table></figure>
<p>它的ArrayDim就为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CPP_ARRAY_DIM(iArray, AMyActor)</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/UnrealType.h#L5967">CPP_ARRAY_DIM</a>这个宏定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/UnrealType.h#L5967">CoreUObject/Public/UObject/UnrealType.h</a>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** helper to calculate an array&#x27;s dimensions **/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPP_ARRAY_DIM(ArrayName, ClassName) \</span></span><br><span class="line">	(<span class="keyword">sizeof</span>(((ClassName*)<span class="number">0</span>)-&gt;ArrayName) / <span class="keyword">sizeof</span>(((ClassName*)<span class="number">0</span>)-&gt;ArrayName[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>
<p>就是用来计算数组内的元素数量的，普通的非数组属性其值为1，可以当作是元素数量为1的数组。</p>
<h4 id="Offset"><a href="#Offset" class="headerlink" title="Offset"></a>Offset</h4><p><code>STRUCT_OFFSET</code>宏的作用为得到数据成员相对于类起始地址的偏移，通过获取<strong>数据成员指针</strong>得到，类型为<code>size_t</code>。</p>
<p>然后当前类中的反射属性都会被添加到<code>PropPointers</code>中，也是UHT生成的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase* <span class="keyword">const</span> Z_Construct_UClass_AMyActor_Statics::PropPointers[] = &#123;</span><br><span class="line">		(<span class="keyword">const</span> UE4CodeGen_Private::FPropertyParamsBase*)&amp;Z_Construct_UClass_AMyActor_Statics::NewProp_ival,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在运行时可以通过<code>UProperty</code>得到指定的对象值：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UProperty&gt; It(InActor-&gt;GetClass()); It; ++It)</span><br><span class="line">	&#123;</span><br><span class="line">		UProperty* Property = *It;</span><br><span class="line">		<span class="keyword">if</span> (Property-&gt;GetNameCPP() == FString(<span class="string">&quot;ival&quot;</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			int32* i32 = Property-&gt;ContainerPtrToValuePtr&lt;int32&gt;(InActor);</span><br><span class="line">			UE_LOG(LogTemp, Log, TEXT(<span class="string">&quot;Property:%s value:%d&quot;</span>), *Property-&gt;GetNameCPP(),i32);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>UProperty</code>中的<code>ContainerPtrToValuePtr</code>系列函数都会转发到<code>ContainerVoidPtrToValuePtrInternal</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FORCEINLINE <span class="keyword">void</span>* <span class="title">ContainerVoidPtrToValuePtrInternal</span><span class="params">(<span class="keyword">void</span>* ContainerPtr, int32 ArrayIndex)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	check(ArrayIndex &lt; ArrayDim);</span><br><span class="line">	check(ContainerPtr);</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// in the future, these checks will be tested if the property is NOT relative to a UClass</span></span><br><span class="line">		check(!Cast&lt;UClass&gt;(GetOuter())); <span class="comment">// Check we are _not_ calling this on a direct child property of a UClass, you should pass in a UObject* in that case</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (uint8*)ContainerPtr + Offset_Internal + ElementSize * ArrayIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是拿到UObject的指针，然后偏移到指定位置（第二个参数用在对象是数组的情况，用来访问指定下标的元素，默认情况下访问下标为0）。</p>
<h4 id="Z-Construct-UClass-和NumMetaData"><a href="#Z-Construct-UClass-和NumMetaData" class="headerlink" title="Z_Construct_UClass_和NumMetaData"></a>Z_Construct_UClass_和NumMetaData</h4><p>它们的类型分别为<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Public/UObject/UObjectGlobals.h#L2285">FMetaDataPairParam</a>和<code>int32</code>，用来记录当前反射属性的元数据：比如属性的<code>Category</code>、注释、所属的文件、<code>ToolTip</code>信息等等，比如在C++函数上添加的注释能够在编辑器蓝图中看到注释的信息，都是靠解析这些元数据来实现的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CoreUObject/Public/UObject/UObjectGlobals.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">FMetaDataPairParam</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span>* NameUTF8;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span>* ValueUTF8;</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>这两个参数通过<code>METADATA_PARAMS</code>包裹，用于处理<code>WITH_MATEDATA</code>的不同情况：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// METADATA_PARAMS(x, y) expands to x, y, if WITH_METADATA is set, otherwise expands to nothing</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> METADATA_PARAMS(x, y) x, y,</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> METADATA_PARAMS(x, y)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>把UHT生成的代码宏展开为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;Category&quot;</span>, <span class="string">&quot;MyActor&quot;</span> &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/MyActor.h&quot;</span> &#125;</span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">METADATA_PARAMS(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData, ARRAY_COUNT(Z_Construct_UClass_AMyActor_Statics::NewProp_ival_MetaData))</span><br></pre></td></tr></table></figure>
<p>就是把<code>UE4CodeGen_Private::FMetaDataPairParam</code>这个类型的数组和数组元素个数传递给<code>F*PropertyParams</code>，实现在<code>WITH_METADATA</code>的情况下处理是否具有Metadata的情况。</p>
<h3 id="运行时的Property"><a href="#运行时的Property" class="headerlink" title="运行时的Property"></a>运行时的Property</h3><p>引擎中通过<code>UE4CodeGen_Private::ConstructFProperty</code>来创建出真正Runtime使用的<code>UProperty</code>(4.25之后是<code>FProperty</code>)，定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/CoreUObject/Private/UObject/UObjectGlobals.cpp#L3900">UObject/UObjectGlobals.cpp</a>。</p>
<h3 id="FBoolPropertyParams特例"><a href="#FBoolPropertyParams特例" class="headerlink" title="FBoolPropertyParams特例"></a>FBoolPropertyParams特例</h3><p>当一个反射的数据是bool类型时，引擎产生的反射信息中有一个比较有意思的特例，<code>FBoolPropertyParams</code>，可以看一下它的结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FBoolPropertyParams</span> // :</span> FPropertyParamsBase</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*      NameUTF8;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>*         RepNotifyFuncUTF8;</span><br><span class="line">	EPropertyFlags      PropertyFlags;</span><br><span class="line">	EPropertyGenFlags   Flags;</span><br><span class="line">	EObjectFlags     ObjectFlags;</span><br><span class="line">	int32            ArrayDim;</span><br><span class="line">	uint32           ElementSize;</span><br><span class="line">	SIZE_T           SizeOfOuter;</span><br><span class="line">	<span class="keyword">void</span>           (*SetBitFunc)(<span class="keyword">void</span>* Obj);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">	<span class="keyword">const</span> FMetaDataPairParam*           MetaDataArray;</span><br><span class="line">	int32                               NumMetaData;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>它具有一个<code>SetBitFunc</code>的函数指针。看一下生成的反射代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// source code </span></span><br><span class="line">UPROPERTY()</span><br><span class="line">	<span class="keyword">bool</span> bEnabled;</span><br><span class="line"></span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_SetBit</span><span class="params">(<span class="keyword">void</span>* Obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	((AMyActor*)Obj)-&gt;bEnabled = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> UE4CodeGen_Private::FBoolPropertyParams Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled = &#123; <span class="string">&quot;bEnabled&quot;</span>, <span class="literal">nullptr</span>, (EPropertyFlags)<span class="number">0x0010000000000000</span>, UE4CodeGen_Private::EPropertyGenFlags::Bool | UE4CodeGen_Private::EPropertyGenFlags::NativeBool, RF_Public|RF_Transient|RF_MarkAsNative, <span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">bool</span>), <span class="keyword">sizeof</span>(AMyActor), &amp;Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_SetBit, METADATA_PARAMS(Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_MetaData, ARRAY_COUNT(Z_Construct_UClass_AMyActor_Statics::NewProp_bEnabled_MetaData)) &#125;;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：其中的关键是，UHT给该属性生成了一个<code>SetBit</code>的函数，why？其他类型的属性都可以通过<code>STRUCT_OFFSET</code>来获取该成员的类内偏移，为什么bool就不行了呢？</p>
<p>这是因为C++有位域(<code>bit-field</code>)这个概念，一个bool可能只占1bit，而不是1byte，但这不是真正的原因。</p>
<p>真正的原因是，C++标准规定了不能对位域进行取地址操作！前面已经提到了<code>STRUCT_OFFSET</code>实际上是获取到数据成员的指针，得到的是类内偏移，但是因为C++的不能对位域取地址的规定，<code>STRUCT_OFFSET</code>无法用在位域的成员上的。</p>
<blockquote>
<p>[IOS/IEC 14882:2014 §9.6]The address-of operator &amp; shall not be applied to a bit-ﬁeld, so there are no pointers to bit-ﬁelds.</p>
</blockquote>
<p>那么这又是因为什么呢？因为系统编址的最小单位是字节而不是位，所以没办法取到1字节零几位的地址。也就决定了不能对位域的数据成员取地址。</p>
<p>UE内其实大量用到了bool使用位域的方式来声明（如果不使用位域，bool类型的空间浪费率达到87.5% :)），所以UE就生成了一个函数来为以位域方式声明的成员设置值。</p>
<p><strong>但是！</strong>UE不支持直接对加了UPROPERTY的bool使用位域：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPROPERTY()</span><br><span class="line">	<span class="keyword">bool</span> bEnabled:<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>编译时会有下列错误：</p>
<blockquote>
<p>LogCompile: Error: bool bitfields are not supported.</p>
</blockquote>
<p>要写成下列方式：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPROPERTY()</span><br><span class="line">	uint8 bEnabled:<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>使用这种方式和使用<code>bool bEnabled;</code>方式生成的反射代码一模一样，所以，UE之所以会生成一个函数来设置bool的值，是因为既要支持原生bool，也要支持位域。</p>
<h3 id="通过UProperty获取值"><a href="#通过UProperty获取值" class="headerlink" title="通过UProperty获取值"></a>通过UProperty获取值</h3><p>如果我知道某个类的对象内有一个属性名字，那么怎么能够得到它的值呢？这个可以基于UE的属性反射来实现：</p>
<p>首先通过<code>TFieldIterator</code>可以遍历该对象的UProperty：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UProperty&gt; It(InActor-&gt;GetClass()); It; ++It)</span><br><span class="line">&#123;</span><br><span class="line">	UProperty* Property = *It;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后可以根据得到的Property来判读名字：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Property-&gt;GetNameCPP() == FString(<span class="string">&quot;ival&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>检测是指定名字的Property后可以通过<code>UProperty</code>上的<code>ContainerPtrToValuePtr</code>函数来获取对象内该属性的指针：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int32* i32 = Property-&gt;ContainerPtrToValuePtr&lt;int32&gt;(InActor)</span><br></pre></td></tr></table></figure>
<p>前面讲到过，UPropery里存储Offdet值就是当前属性相对于对象起始地址的偏移。而ContainerPtrToValuePtr函数所做的就是得到当前对象偏移Offset的地址然后做了类型转换。</p>
<h3 id="Property的Flag"><a href="#Property的Flag" class="headerlink" title="Property的Flag"></a>Property的Flag</h3><p>通过上面的分析，可以看到<code>UPROPERTY</code>添加的标记，如<code>EditAnywhere</code>等，会给指定的Property生成FLAG存储在<code>F*PropertyParams</code>结构的第三个参数中，是位描述的。</p>
<p>可选值为<code>EPropertyFlags</code>枚举值：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/CoreUObject/Public/UObject/ObjectMacros.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Flags associated with each property in a class, overriding the</span></span><br><span class="line"><span class="comment"> * property&#x27;s default behavior.</span></span><br><span class="line"><span class="comment"> * @warning When adding one here, please update ParsePropertyFlags()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">enum</span> EPropertyFlags : uint64</span><br><span class="line">&#123;</span><br><span class="line">	CPF_None = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">	CPF_Edit							= <span class="number">0x0000000000000001</span>,	<span class="comment">///&lt; Property is user-settable in the editor.</span></span><br><span class="line">	CPF_ConstParm						= <span class="number">0x0000000000000002</span>,	<span class="comment">///&lt; This is a constant function parameter</span></span><br><span class="line">	CPF_BlueprintVisible				= <span class="number">0x0000000000000004</span>,	<span class="comment">///&lt; This property can be read by blueprint code</span></span><br><span class="line">	CPF_ExportObject					= <span class="number">0x0000000000000008</span>,	<span class="comment">///&lt; Object can be exported with actor.</span></span><br><span class="line">	CPF_BlueprintReadOnly				= <span class="number">0x0000000000000010</span>,	<span class="comment">///&lt; This property cannot be modified by blueprint code</span></span><br><span class="line">	CPF_Net								= <span class="number">0x0000000000000020</span>,	<span class="comment">///&lt; Property is relevant to network replication.</span></span><br><span class="line">	CPF_EditFixedSize					= <span class="number">0x0000000000000040</span>,	<span class="comment">///&lt; Indicates that elements of an array can be modified, but its size cannot be changed.</span></span><br><span class="line">	CPF_Parm							= <span class="number">0x0000000000000080</span>,	<span class="comment">///&lt; Function/When call parameter.</span></span><br><span class="line">	CPF_OutParm							= <span class="number">0x0000000000000100</span>,	<span class="comment">///&lt; Value is copied out after function call.</span></span><br><span class="line">	CPF_ZeroConstructor					= <span class="number">0x0000000000000200</span>,	<span class="comment">///&lt; memset is fine for construction</span></span><br><span class="line">	CPF_ReturnParm						= <span class="number">0x0000000000000400</span>,	<span class="comment">///&lt; Return value.</span></span><br><span class="line">	CPF_DisableEditOnTemplate			= <span class="number">0x0000000000000800</span>,	<span class="comment">///&lt; Disable editing of this property on an archetype/sub-blueprint</span></span><br><span class="line">	<span class="comment">//CPF_      						= 0x0000000000001000,	///&lt; </span></span><br><span class="line">	CPF_Transient   					= <span class="number">0x0000000000002000</span>,	<span class="comment">///&lt; Property is transient: shouldn&#x27;t be saved or loaded, except for Blueprint CDOs.</span></span><br><span class="line">	CPF_Config      					= <span class="number">0x0000000000004000</span>,	<span class="comment">///&lt; Property should be loaded/saved as permanent profile.</span></span><br><span class="line">	<span class="comment">//CPF_								= 0x0000000000008000,	///&lt; </span></span><br><span class="line">	CPF_DisableEditOnInstance			= <span class="number">0x0000000000010000</span>,	<span class="comment">///&lt; Disable editing on an instance of this class</span></span><br><span class="line">	CPF_EditConst   					= <span class="number">0x0000000000020000</span>,	<span class="comment">///&lt; Property is uneditable in the editor.</span></span><br><span class="line">	CPF_GlobalConfig					= <span class="number">0x0000000000040000</span>,	<span class="comment">///&lt; Load config from base class, not subclass.</span></span><br><span class="line">	CPF_InstancedReference				= <span class="number">0x0000000000080000</span>,	<span class="comment">///&lt; Property is a component references.</span></span><br><span class="line">	<span class="comment">//CPF_								= 0x0000000000100000,	///&lt;</span></span><br><span class="line">	CPF_DuplicateTransient				= <span class="number">0x0000000000200000</span>,	<span class="comment">///&lt; Property should always be reset to the default value during any type of duplication (copy/paste, binary duplication, etc.)</span></span><br><span class="line">	CPF_SubobjectReference				= <span class="number">0x0000000000400000</span>,	<span class="comment">///&lt; Property contains subobject references (TSubobjectPtr)</span></span><br><span class="line">	<span class="comment">//CPF_    							= 0x0000000000800000,	///&lt; </span></span><br><span class="line">	CPF_SaveGame						= <span class="number">0x0000000001000000</span>,	<span class="comment">///&lt; Property should be serialized for save games, this is only checked for game-specific archives with ArIsSaveGame</span></span><br><span class="line">	CPF_NoClear							= <span class="number">0x0000000002000000</span>,	<span class="comment">///&lt; Hide clear (and browse) button.</span></span><br><span class="line">	<span class="comment">//CPF_  							= 0x0000000004000000,	///&lt;</span></span><br><span class="line">	CPF_ReferenceParm					= <span class="number">0x0000000008000000</span>,	<span class="comment">///&lt; Value is passed by reference; CPF_OutParam and CPF_Param should also be set.</span></span><br><span class="line">	CPF_BlueprintAssignable				= <span class="number">0x0000000010000000</span>,	<span class="comment">///&lt; MC Delegates only.  Property should be exposed for assigning in blueprint code</span></span><br><span class="line">	CPF_Deprecated  					= <span class="number">0x0000000020000000</span>,	<span class="comment">///&lt; Property is deprecated.  Read it from an archive, but don&#x27;t save it.</span></span><br><span class="line">	CPF_IsPlainOldData					= <span class="number">0x0000000040000000</span>,	<span class="comment">///&lt; If this is set, then the property can be memcopied instead of CopyCompleteValue / CopySingleValue</span></span><br><span class="line">	CPF_RepSkip							= <span class="number">0x0000000080000000</span>,	<span class="comment">///&lt; Not replicated. For non replicated properties in replicated structs </span></span><br><span class="line">	CPF_RepNotify						= <span class="number">0x0000000100000000</span>,	<span class="comment">///&lt; Notify actors when a property is replicated</span></span><br><span class="line">	CPF_Interp							= <span class="number">0x0000000200000000</span>,	<span class="comment">///&lt; interpolatable property for use with matinee</span></span><br><span class="line">	CPF_NonTransactional				= <span class="number">0x0000000400000000</span>,	<span class="comment">///&lt; Property isn&#x27;t transacted</span></span><br><span class="line">	CPF_EditorOnly						= <span class="number">0x0000000800000000</span>,	<span class="comment">///&lt; Property should only be loaded in the editor</span></span><br><span class="line">	CPF_NoDestructor					= <span class="number">0x0000001000000000</span>,	<span class="comment">///&lt; No destructor</span></span><br><span class="line">	<span class="comment">//CPF_								= 0x0000002000000000,	///&lt;</span></span><br><span class="line">	CPF_AutoWeak						= <span class="number">0x0000004000000000</span>,	<span class="comment">///&lt; Only used for weak pointers, means the export type is autoweak</span></span><br><span class="line">	CPF_ContainsInstancedReference		= <span class="number">0x0000008000000000</span>,	<span class="comment">///&lt; Property contains component references.</span></span><br><span class="line">	CPF_AssetRegistrySearchable			= <span class="number">0x0000010000000000</span>,	<span class="comment">///&lt; asset instances will add properties with this flag to the asset registry automatically</span></span><br><span class="line">	CPF_SimpleDisplay					= <span class="number">0x0000020000000000</span>,	<span class="comment">///&lt; The property is visible by default in the editor details view</span></span><br><span class="line">	CPF_AdvancedDisplay					= <span class="number">0x0000040000000000</span>,	<span class="comment">///&lt; The property is advanced and not visible by default in the editor details view</span></span><br><span class="line">	CPF_Protected						= <span class="number">0x0000080000000000</span>,	<span class="comment">///&lt; property is protected from the perspective of script</span></span><br><span class="line">	CPF_BlueprintCallable				= <span class="number">0x0000100000000000</span>,	<span class="comment">///&lt; MC Delegates only.  Property should be exposed for calling in blueprint code</span></span><br><span class="line">	CPF_BlueprintAuthorityOnly			= <span class="number">0x0000200000000000</span>,	<span class="comment">///&lt; MC Delegates only.  This delegate accepts (only in blueprint) only events with BlueprintAuthorityOnly.</span></span><br><span class="line">	CPF_TextExportTransient				= <span class="number">0x0000400000000000</span>,	<span class="comment">///&lt; Property shouldn&#x27;t be exported to text format (e.g. copy/paste)</span></span><br><span class="line">	CPF_NonPIEDuplicateTransient		= <span class="number">0x0000800000000000</span>,	<span class="comment">///&lt; Property should only be copied in PIE</span></span><br><span class="line">	CPF_ExposeOnSpawn					= <span class="number">0x0001000000000000</span>,	<span class="comment">///&lt; Property is exposed on spawn</span></span><br><span class="line">	CPF_PersistentInstance				= <span class="number">0x0002000000000000</span>,	<span class="comment">///&lt; A object referenced by the property is duplicated like a component. (Each actor should have an own instance.)</span></span><br><span class="line">	CPF_UObjectWrapper					= <span class="number">0x0004000000000000</span>,	<span class="comment">///&lt; Property was parsed as a wrapper class like TSubclassOf&lt;T&gt;, FScriptInterface etc., rather than a USomething*</span></span><br><span class="line">	CPF_HasGetValueTypeHash				= <span class="number">0x0008000000000000</span>,	<span class="comment">///&lt; This property can generate a meaningful hash value.</span></span><br><span class="line">	CPF_NativeAccessSpecifierPublic		= <span class="number">0x0010000000000000</span>,	<span class="comment">///&lt; Public native access specifier</span></span><br><span class="line">	CPF_NativeAccessSpecifierProtected	= <span class="number">0x0020000000000000</span>,	<span class="comment">///&lt; Protected native access specifier</span></span><br><span class="line">	CPF_NativeAccessSpecifierPrivate	= <span class="number">0x0040000000000000</span>,	<span class="comment">///&lt; Private native access specifier</span></span><br><span class="line">	CPF_SkipSerialization				= <span class="number">0x0080000000000000</span>,	<span class="comment">///&lt; Property shouldn&#x27;t be serialized, can still be exported to text</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="StaticClass和GetClass的区别"><a href="#StaticClass和GetClass的区别" class="headerlink" title="StaticClass和GetClass的区别"></a>StaticClass和GetClass的区别</h2><p><code>StaticClass</code>是继承自UObject类的static函数，<code>GetClass</code>是<code>UObjectBase</code>的成员函数。</p>
<p><code>UObjectBase</code>的<code>GetClass</code>获取到的UClass就是在NewObject时传递进来的UClass.（代码在<code>UObject\UObjectGlobal.cpp</code>中）</p>
<p><img data-src="index/UE4/ue4-static-class-and-getclass-difference.webp"></p>
<p>用途不一样，<code>StaticClass</code>是在获取具体类型的UClass，而<code>GetClass</code>是获取到当前对象的真实UClass。</p>
<h2 id="UObject的FObjectInitializer构造函数的调用"><a href="#UObject的FObjectInitializer构造函数的调用" class="headerlink" title="UObject的FObjectInitializer构造函数的调用"></a>UObject的FObjectInitializer构造函数的调用</h2><blockquote>
<p>注意：只有GENERATER_UCLASS_BODY才可以实现<code>FObjectInitializer</code>的构造函数。</p>
</blockquote>
<p>在继承自UObject的类中，都可以自己写一个接收<code>const FObjectInitializer&amp;</code>参数的构造函数，在创建对象时会被调用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UMyObject::UMyObject(<span class="keyword">const</span> FObjectInitializer&amp; Initializer)&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在类中的<code>GENERATED_UCLASS_BODY</code>中默认声明这样一个构造函数。并且，在UHT生成的代码中通过宏还定义了一个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEFINE_DEFAULT_OBJECT_INITIALIZER_CONSTRUCTOR_CALL(UMyObject) </span><br></pre></td></tr></table></figure>

<p>这个宏经过展开之后就是这样的:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __DefaultConstructor(<span class="keyword">const</span> FObjectInitializer&amp; X) &#123; <span class="keyword">new</span>((EInternal*)X.GetObj())UMyObject(X); &#125;</span><br></pre></td></tr></table></figure>

<p>为当前的对象类型<code>UMyObject</code>定义了一个<code>__DefaultConstructor</code>函数，作用是在当前<code>FObjectInitializer</code>传入的参数的Object上调用<code>FObjectInitializer</code>的构造函数。</p>
<p><strong>注意</strong>：如果是<code>GENERATED_BODY</code>则不会声明这个构造函数，使用的就是另一个宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEFINE_DEFAULT_CONSTRUCTOR_CALL(UMyObject)</span><br></pre></td></tr></table></figure>

<p>展开之后是这样的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __DefaultConstructor(<span class="keyword">const</span> FObjectInitializer&amp; X) &#123; <span class="keyword">new</span>((EInternal*)X.GetObj())UMyObject; &#125;</span><br></pre></td></tr></table></figure>

<p>是通过<code>GANERATED_BODY</code>和<code>GENERATED_UCLASS_BODY</code>来定义了两种<code>__DefaultConstructor</code>的实现，一种是调用<code>FObjectInitializer</code>的构造函数，另一种是调用类的默认构造函数。</p>
<blockquote>
<p>所以，默认情况下FObjectInitializer的构造函数和UObject的默认构造函数在调用时只会走一个。</p>
</blockquote>
<p>那么它是如何被调用到的呢？</p>
<p>在<code>NewObject</code>中调用的<code>StaticConstructObject_Internal</code>中有以下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> bRecycledSubobject = <span class="literal">false</span>;	</span><br><span class="line">Result = StaticAllocateObject(InClass, InOuter, InName, InFlags, InternalSetFlags, bCanRecycleSubobjects, &amp;bRecycledSubobject);</span><br><span class="line">check(Result != <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">// Don&#x27;t call the constructor on recycled subobjects, they haven&#x27;t been destroyed.</span></span><br><span class="line"><span class="keyword">if</span> (!bRecycledSubobject)</span><br><span class="line">&#123;		</span><br><span class="line">	STAT(FScopeCycleCounterUObject ConstructorScope(InClass, GET_STATID(STAT_ConstructObject)));</span><br><span class="line">	(*InClass-&gt;ClassConstructor)( FObjectInitializer(Result, InTemplate, bCopyTransientsFromClassDefaults, <span class="literal">true</span>, InInstanceGraph) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过传入进来的UClass对象获取其中的<code>ClassConstructor</code>函数指针，并构造出一个<code>FObjectInitializer</code>作为参数传递。</p>
<p>在之前的笔记(<a href="https://imzlp.com/notes/ue/#StaticClass%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E7%9A%84">StaticClass是如何定义的</a>)中，写到了，通过<code>GetPrivateStaticClass</code>获取到当前UObject类的UClass实例会实例化出一个当前类的<code>InternalConstructor</code>函数（注意这个模板参数T是UObject的类）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper template to call the default constructor for a class</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">InternalConstructor</span>( <span class="title">const</span> <span class="title">FObjectInitializer</span>&amp; <span class="title">X</span> )</span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">	T::__DefaultConstructor(X);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就将其转发到了上面讲到的<code>__DefaultConstructor</code>函数上，然后它里面又转发到了所传入<code>FObjectInitializer</code>对象上的<code>const FObjectInitializer&amp;</code>构造函数上（或者默认构造函数上）。</p>
<p><img data-src="index/UE4/ue4-call-FObjectInitializer-ctor.webp"></p>
<p>创建对象并调用<code>const FObjectInitializer&amp;</code>构造函数的调用流程为：</p>
<ol>
<li>通过调用<code>StaticAllocateObject</code>根据传入的UClass创建出对象</li>
<li>通过传入的UClass对象内的ClassConstructor函数指针调用所创建UObject类的<code>InternalConstructor</code>函数</li>
<li><code>UMyObject::InternalConstructor</code>会转发到<code>UMyObject::__DefaultConstructor</code></li>
<li><code>UMyObject::__DefaultConstructor</code>会从接收到的<code>FObjectInitializer</code>对象上获取到通过<code>StaticAllocateObject</code>创建的对象，然后通过<code>placement-new</code>的方式，在这块内存上调用<code>UMyObject</code>类的<code>const FObjectInitializer&amp;</code>构造函数。</li>
</ol>
<p>通过以上的流程就实现了<code>NewObject</code>时会自动调用到它的<code>FObjectInitializer</code>构造函数。</p>
<blockquote>
<p>注意：在CDO的构造上有点区别，CDO的构造是通过<code>UClass::GetDefaultObject</code>中实现上述流程的。</p>
</blockquote>
<h2 id="StaticClass是如何定义的"><a href="#StaticClass是如何定义的" class="headerlink" title="StaticClass是如何定义的"></a>StaticClass是如何定义的</h2><p>在UE中可以对UObject的类执行<code>UXXX::StaticClass</code>方法来获取到它的UClass对象。</p>
<p>但是它是如何定义的？首先要看我们声明对象的<code>MyActor.generated.h</code>中（以AMyActor类为例）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;&gt; MICROEND_423_API UClass* StaticClass&lt;<span class="class"><span class="keyword">class</span> <span class="title">AMyActor</span>&gt;();</span></span><br></pre></td></tr></table></figure>

<p>为AMyActor类特化了<code>StaticClass</code>的版本。再去<code>MyActor.gen.cpp</code>中找以下它的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IMPLEMENT_CLASS(AMyActor, <span class="number">31943282</span>);</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; MICROEND_423_API UClass* StaticClass&lt;AMyActor&gt;()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> AMyActor::StaticClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这里看也就只是转发调用而已，但是关键点隐藏在其他地方。<br>首先<code>AMyActor::StaticClass</code>类的定义是在<code>AMyActor.generated.h</code>的<code>DECLARE_CLASS</code>宏中（该宏定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1524">ObjectMacros.h#L1524</a>），返回的是<code>GetPrivateStaticClass</code>的调用。</p>
<p>而<code>GetPrivateStaticClass</code>则在<code>AMyAcotr.gen.cpp</code>中的<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Public/UObject/ObjectMacros.h#L1673">IMPLEMENT_CLASS</a>实现。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/CoreUObject/Public/UObject/ObjectMacros.h</span></span><br><span class="line"><span class="comment">// Register a class at startup time.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPLEMENT_CLASS(TClass, TClassCrc) \</span></span><br><span class="line">	<span class="keyword">static</span> TClassCompiledInDefer&lt;TClass&gt; AutoInitialize##TClass(TEXT(#TClass), <span class="keyword">sizeof</span>(TClass), TClassCrc); \</span><br><span class="line">	UClass* TClass::GetPrivateStaticClass() \</span><br><span class="line">	&#123; \</span><br><span class="line">		<span class="keyword">static</span> UClass* PrivateStaticClass = <span class="literal">NULL</span>; \</span><br><span class="line">		<span class="keyword">if</span> (!PrivateStaticClass) \</span><br><span class="line">		&#123; \</span><br><span class="line">			<span class="comment">/* this could be handled with templates, but we want it external to avoid code bloat */</span> \</span><br><span class="line">			GetPrivateStaticClassBody( \</span><br><span class="line">				StaticPackage(), \</span><br><span class="line">				(TCHAR*)TEXT(#TClass) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>), \</span><br><span class="line">				PrivateStaticClass, \</span><br><span class="line">				StaticRegisterNatives##TClass, \</span><br><span class="line">				<span class="keyword">sizeof</span>(TClass), \</span><br><span class="line">				<span class="keyword">alignof</span>(TClass), \</span><br><span class="line">				(EClassFlags)TClass::StaticClassFlags, \</span><br><span class="line">				TClass::StaticClassCastFlags(), \</span><br><span class="line">				TClass::StaticConfigName(), \</span><br><span class="line">				(UClass::ClassConstructorType)InternalConstructor&lt;TClass&gt;, \</span><br><span class="line">				(UClass::ClassVTableHelperCtorCallerType)InternalVTableHelperCtorCaller&lt;TClass&gt;, \</span><br><span class="line">				&amp;TClass::AddReferencedObjects, \</span><br><span class="line">				&amp;TClass::Super::StaticClass, \</span><br><span class="line">				&amp;TClass::WithinClass::StaticClass \</span><br><span class="line">			); \</span><br><span class="line">		&#125; \</span><br><span class="line">		<span class="keyword">return</span> PrivateStaticClass; \</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>GetPrivateStaticClass</code>其实就是通过这些元数据构造出UClass的。</p>
<p>如下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">IMPLEMENT_CLASS(AMyActor, <span class="number">3240835608</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 宏展开之后</span></span><br><span class="line"><span class="keyword">static</span> TClassCompiledInDefer &lt; AMyActor &gt; AutoInitializeAMyActor(TEXT(<span class="string">&quot;AMyActor&quot;</span>), <span class="keyword">sizeof</span>(AMyActor), <span class="number">3240835608</span>);</span><br><span class="line"><span class="function">UClass * <span class="title">AMyActor::GetPrivateStaticClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> UClass * PrivateStaticClass = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (!PrivateStaticClass) &#123;</span><br><span class="line">    GetPrivateStaticClassBody(</span><br><span class="line">    	StaticPackage(), </span><br><span class="line">    	(TCHAR*)TEXT(<span class="string">&quot;AMyActor&quot;</span>) + <span class="number">1</span> + ((StaticClassFlags &amp; CLASS_Deprecated) ? <span class="number">11</span> : <span class="number">0</span>), </span><br><span class="line">    	PrivateStaticClass, </span><br><span class="line">    	StaticRegisterNativesAMyActor, </span><br><span class="line">    	<span class="keyword">sizeof</span>(AMyActor), </span><br><span class="line">    	<span class="keyword">alignof</span>(AMyActor), </span><br><span class="line">    	(EClassFlags) AMyActor::StaticClassFlags, </span><br><span class="line">    	AMyActor::StaticClassCastFlags(), </span><br><span class="line">    	AMyActor::StaticConfigName(), </span><br><span class="line">    	(UClass::ClassConstructorType) InternalConstructor&lt;AMyActor&gt;,</span><br><span class="line">    	(UClass::ClassVTableHelperCtorCallerType) InternalVTableHelperCtorCaller&lt;AMyActor&gt;,</span><br><span class="line">    	&amp;AMyActor::AddReferencedObjects,</span><br><span class="line">    	&amp;AMyActor::Super::StaticClass, </span><br><span class="line">    	&amp;AMyActor::WithinClass::StaticClass</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> PrivateStaticClass;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="UClass中的函数指针"><a href="#UClass中的函数指针" class="headerlink" title="UClass中的函数指针"></a>UClass中的函数指针</h3><p>上面代码中比较关键的点为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(UClass::ClassConstructorType)InternalConstructor&lt;TClass&gt;, \</span><br><span class="line">(UClass::ClassVTableHelperCtorCallerType)InternalVTableHelperCtorCaller&lt;TClass&gt;, \</span><br></pre></td></tr></table></figure>

<p>这两行是模板实例化出了两个函数并转换成函数指针传递给<code>GetPrivateStaticClassBody</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper template to call the default constructor for a class</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">InternalConstructor</span>( <span class="title">const</span> <span class="title">FObjectInitializer</span>&amp; <span class="title">X</span> )</span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">	T::__DefaultConstructor(X);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper template to call the vtable ctor caller for a class</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">UObject</span>* <span class="title">InternalVTableHelperCtorCaller</span>(<span class="title">FVTableHelper</span>&amp; <span class="title">Helper</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">return</span> T::__VTableCtorCaller(Helper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是对<code>__DefaultConstructor</code>这样函数的的转发调用。</p>
<p><code>UClass::ClassConstructorType</code>与<code>UClass::ClassVTableHelperCtorCallerType</code>这两个<code>typedef</code>为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span>		<span class="params">(*ClassConstructorType)</span>				<span class="params">(<span class="keyword">const</span> FObjectInitializer&amp;)</span></span>;</span><br><span class="line"><span class="keyword">typedef</span> UObject*	(*ClassVTableHelperCtorCallerType)	(FVTableHelper&amp; Helper);</span><br></pre></td></tr></table></figure>

<h3 id="GetPrivateStaticClassBody"><a href="#GetPrivateStaticClassBody" class="headerlink" title="GetPrivateStaticClassBody"></a>GetPrivateStaticClassBody</h3><p>其中的<code>GetPrivateStaticClassBody</code>函数是定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Runtime/CoreUObject/Private/UObject/Class.cpp">Runtime\CoreUObject\Private\UObject\Class.cpp</a>中的。</p>
<p>原型为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetPrivateStaticClassBody</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">const</span> TCHAR* PackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">const</span> TCHAR* Name,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass*&amp; ReturnClass,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">void</span>(*RegisterNativeFunc)(),</span></span></span><br><span class="line"><span class="function"><span class="params">	uint32 InSize,</span></span></span><br><span class="line"><span class="function"><span class="params">	uint32 InAlignment,</span></span></span><br><span class="line"><span class="function"><span class="params">	EClassFlags InClassFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">	EClassCastFlags InClassCastFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">const</span> TCHAR* InConfigName,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass::ClassConstructorType InClassConstructor,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass::ClassVTableHelperCtorCallerType InClassVTableHelperCtorCaller,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass::ClassAddReferencedObjectsType InClassAddReferencedObjects,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass::StaticClassFunctionType InSuperClassFn,</span></span></span><br><span class="line"><span class="function"><span class="params">	UClass::StaticClassFunctionType InWithinClassFn,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">bool</span> bIsDynamic <span class="comment">/*= false*/</span></span></span></span><br><span class="line"><span class="function"><span class="params">	)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中第四个参数是传入注册Native函数的函数指针，该函数在<code>MyActor.gen.cpp</code>中生成，也可以通过在UFUNCTION中添加<code>CustomThunk</code>函数来自己实现，UnLua的覆写C++函数就是基于替换thunk函数做的。</p>
<p><code>GetPrivateStaticClassBody</code>中通过<code>(UClass*)GUObjectAllocator.AllocateUObject</code>来分配出UClass的内存，因为所有的UClass结构都一致。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyActor.gen.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AMyActor::StaticRegisterNativesAMyActor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UClass* Class = AMyActor::StaticClass();</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> FNameNativePtrPair Funcs[] = &#123;</span><br><span class="line">		&#123; <span class="string">&quot;ReceiveBytes&quot;</span>, &amp;AMyActor::execReceiveBytes &#125;,</span><br><span class="line">		&#123; <span class="string">&quot;TESTFUNC&quot;</span>, &amp;AMyActor::execTESTFUNC &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line">	FNativeFunctionRegistrar::RegisterFunctions(Class, Funcs, ARRAY_COUNT(Funcs));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实就是把Native的函数通过<code>AddNativeFunction</code>添加到UClass中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\CoreUObject\Private\UObject\Class.cpp </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FNativeFunctionRegistrar::RegisterFunctions</span><span class="params">(class UClass* Class, <span class="keyword">const</span> FNameNativePtrPair* InArray, int32 NumFunctions)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (; NumFunctions; ++InArray, --NumFunctions)</span><br><span class="line">	&#123;</span><br><span class="line">		Class-&gt;AddNativeFunction(UTF8_TO_TCHAR(InArray-&gt;NameUTF8), InArray-&gt;Pointer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取UObject的资源路径"><a href="#获取UObject的资源路径" class="headerlink" title="获取UObject的资源路径"></a>获取UObject的资源路径</h2><p>可以通过<code>FSoftObjectPath</code>传入UObject来获得：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FString <span class="title">GetObjectResource</span><span class="params">(UObject* Obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">FSoftObjectPath <span class="title">SoftRef</span><span class="params">(Obj)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> SoftRef.ToString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：直接<code>ToString</code>获取到的路径是PackagePath的，形如<code>/Game/XXXX.XXXX</code>这种形式，可以通过<code>GetLongPackageName</code>得到去掉<code>.XXXX</code>的字符串。</p>
<h2 id="BP-to-CPP"><a href="#BP-to-CPP" class="headerlink" title="BP to CPP"></a>BP to CPP</h2><p>在<code>Project Settings</code>-<code>Packaging</code>-<code>Blueprint</code>下添加想要转换的蓝图资源：</p>
<p><img data-src="index/UE4/ue4-translation-bp-to-cpp.webp"></p>
<p>设置之后执行打包就会在项目的下列路径中产生对应的<code>.h/.cpp</code>以及生成<code>generated.h/gen.cpp</code>：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intermediate\Plugins\NativizedAssets\Windows\Game\Intermediate\Build\Win64\UE4\Inc\NativizedAssets</span><br></pre></td></tr></table></figure>

<h2 id="监听窗口关闭"><a href="#监听窗口关闭" class="headerlink" title="监听窗口关闭"></a>监听窗口关闭</h2><p>可以通过监听<code>FSlateFontServices</code>里的<code>OnSlateWindowDestroyed</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Called on the game thread right before the slate window handle is destroyed.  </span></span><br><span class="line"><span class="comment"> * This gives users a chance to release any viewport specific resources they may have active when the window is destroyed </span></span><br><span class="line"><span class="comment"> * @param Pointer to the API specific backbuffer type</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DECLARE_MULTICAST_DELEGATE_OneParam(FOnSlateWindowDestroyed, <span class="keyword">void</span>*);</span><br><span class="line"><span class="function">FOnSlateWindowDestroyed&amp; <span class="title">OnSlateWindowDestroyed</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> OnSlateWindowDestroyedDelegate; &#125;</span><br></pre></td></tr></table></figure>

<p>监听方法:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FSlateApplication::Get().GetRenderer()-&gt;OnSlateWindowDestroyed().AddRaw(<span class="keyword">this</span>, &amp;FSceneViewport::OnWindowBackBufferResourceDestroyed);</span><br></pre></td></tr></table></figure>

<h2 id="UnLua的EXPORT-PRIMITIVE-TYPE"><a href="#UnLua的EXPORT-PRIMITIVE-TYPE" class="headerlink" title="UnLua的EXPORT_PRIMITIVE_TYPE"></a>UnLua的EXPORT_PRIMITIVE_TYPE</h2><p>UnLua里使用<code>EXPORT_PRIMITIVE_TYPE</code>宏来导出内置类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPORT_PRIMITIVE_TYPE(uint64, TPrimitiveTypeWrapper&lt;uint64&gt;, uint64)</span><br></pre></td></tr></table></figure>
<p>宏展开之后为:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt; &gt; <span class="class"><span class="keyword">struct</span> <span class="title">UnLua</span>:</span>:TType &lt; TPrimitiveTypeWrapper &lt; uint64 &gt; , <span class="literal">false</span> &gt; &#123;</span><br><span class="line">  <span class="keyword">static</span></span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> * <span class="title">GetName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;uint64&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FExporteduint64Helper</span> &#123;</span></span><br><span class="line">  <span class="keyword">typedef</span> TPrimitiveTypeWrapper &lt; uint64 &gt; ClassType;</span><br><span class="line">  <span class="keyword">static</span> FExporteduint64Helper StaticInstance;</span><br><span class="line">  UnLua::TExportedClass &lt; <span class="literal">false</span>, TPrimitiveTypeWrapper &lt; uint64 &gt; , uint64 &gt; * ExportedClass;</span><br><span class="line">  ~FExporteduint64Helper() &#123;</span><br><span class="line">    <span class="keyword">delete</span> ExportedClass;</span><br><span class="line">  &#125;</span><br><span class="line">  FExporteduint64Helper(): ExportedClass(<span class="literal">nullptr</span>) &#123;</span><br><span class="line">    UnLua::TExportedClass &lt; <span class="literal">false</span>, TPrimitiveTypeWrapper &lt; uint64 &gt; , uint64 &gt; * Class = (UnLua::TExportedClass &lt; <span class="literal">false</span>, TPrimitiveTypeWrapper &lt; uint64 &gt; , uint64 &gt; * ) UnLua::FindExportedClass(<span class="string">&quot;uint64&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!Class) &#123;</span><br><span class="line">      ExportedClass = <span class="keyword">new</span> UnLua::TExportedClass &lt; <span class="literal">false</span>, TPrimitiveTypeWrapper &lt; uint64 &gt; , uint64 &gt; (<span class="string">&quot;uint64&quot;</span>, <span class="literal">nullptr</span>);</span><br><span class="line">      UnLua::ExportClass((UnLua::IExportedClass * ) ExportedClass);</span><br><span class="line">      Class = ExportedClass;</span><br><span class="line">    &#125;</span><br><span class="line">    Class - &gt; AddProperty(<span class="string">&quot;Value&quot;</span>, &amp; ClassType::Value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">FExporteduint64Helper FExporteduint64Helper::StaticInstance;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">FTypeInterfaceuint64</span> &#123;</span></span><br><span class="line">  FTypeInterfaceuint64() &#123;</span><br><span class="line">    UnLua::AddTypeInterface(<span class="string">&quot;uint64&quot;</span>, UnLua::GetTypeInterface &lt; uint64 &gt; ());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;TypeInterfaceuint64;</span><br></pre></td></tr></table></figure>



<h2 id="4-25-MountPak没有材质"><a href="#4-25-MountPak没有材质" class="headerlink" title="4.25 MountPak没有材质"></a>4.25 MountPak没有材质</h2><p>在项目打包时在<code>Project Settgins</code>-<code>Packaging</code>中开启了<code>Share Material shader code</code>时，后续的热更pak打包，如果没有同步把<code>ushaderbytecode</code>打包进去并自己加载，会产生下列材质丢失的问题：</p>
<p><img data-src="index/UE4/pak-shadercode-error-in-ue425.webp"></p>
<p>经过调试后发现，是因为4.25在mount pak之后不会加载新的Pak中的<code>shaderbytecode</code>，找到了问题，解决办法就手到擒来了，找到引擎中加载<code>shaderbytecode</code>的代码自己调用一遍即可。</p>
<p>在项目打包时默认会生成两个<code>shaderbytecode</code>文件：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ShaderArchive-Global-PCD3D_SM5.ushaderbytecode</span><br><span class="line">ShaderArchive-HotPatcherExample-PCD3D_SM5.ushaderbytecode</span><br></pre></td></tr></table></figure>

<p>并且它们存在于pak中Mount point的路径均为:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../../PROJECT_NAME/Content/</span><br></pre></td></tr></table></figure>

<p>而且根据<code>shaderbytecode</code>文件路径的组成规则：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> FString ShaderExtension = TEXT(<span class="string">&quot;.ushaderbytecode&quot;</span>);</span><br><span class="line"><span class="keyword">static</span> FString StableExtension = TEXT(<span class="string">&quot;.scl.csv&quot;</span>);</span><br><span class="line"><span class="keyword">static</span> FString PipelineExtension = TEXT(<span class="string">&quot;.ushaderpipelines&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetCodeArchiveFilename</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::Printf(TEXT(<span class="string">&quot;ShaderArchive-%s-&quot;</span>), *LibraryName) + Platform.ToString() + ShaderExtension;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，只需要传递基础路径和LibraryName即可（OpenLibrary中通过调用<code>GetCodeArchiveFilename</code>来获取要加载的文件）。</p>
<p>即要重新加载global和项目的shaderbytecode，在mount成功之后执行下面两行代码即可：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FShaderCodeLibrary::OpenLibrary(<span class="string">&quot;Global&quot;</span>, FPaths::ProjectContentDir());</span><br><span class="line">FShaderCodeLibrary::OpenLibrary(FApp::GetProjectName(), FPaths::ProjectContentDir());</span><br></pre></td></tr></table></figure>

<p>通过笔记最前面的一段话，可以总结出两个解决方案：</p>
<ol>
<li>开启了Share Material shader code的情况下，需要把shaderbytecode打包，并自己在Mount时加载；</li>
<li>打Pak时Cook资源不要开启<code>Share Material shader code</code>，这样会把资源的shader都打包在资源内部，从而避免需要单独加载shader的问题；</li>
</ol>
<h2 id="Android上Arrow组件的crash"><a href="#Android上Arrow组件的crash" class="headerlink" title="Android上Arrow组件的crash"></a>Android上Arrow组件的crash</h2><p>在游戏中把一个Actor上的<code>Arrow</code>组件设置为visible，打包Android上运行会Crash：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">06-17 15:23:51.976 26991 27112 F libc    : Fatal signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x0 in tid 27112 (RenderThread 2), pid 26991 (MainThread-UE4)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #00 pc 062fa090  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FArrowSceneProxy::GetDynamicMeshElements(TArray&lt;FSceneView const*, FDefaultAllocator&gt; const&amp;, FSceneViewFamily const&amp;, unsigned int, FMeshElementCollector&amp;) const+824)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #01 pc 058010f4  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (_ZN14FSceneRenderer25GatherDynamicMeshElementsER6TArrayI9FViewInfo17FDefaultAllocatorEPK6FSceneRK16FSceneViewFamilyR25FGlobalDynamicIndexBufferR26FGlobalDynamicVertexBufferR24FGlobalDynamicReadBufferRKS0_Ih18TMemStackAllocatorILj0EEESL_SL_R21FMeshElementCollector+2456)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #02 pc 0580f8a8  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (_ZN14FSceneRenderer21ComputeViewVisibilityER24FRHICommandListImmediateN22FExclusiveDepthStencil4TypeER6TArrayI13FViewCommands16TInlineAllocatorILj4E17FDefaultAllocatorEER25FGlobalDynamicIndexBufferR26FGlobalDynamicVertexBufferR24FGlobalDynamicReadBuffer+39716)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #03 pc 054ffb30  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FMobileSceneRenderer::InitViews(FRHICommandListImmediate&amp;)+1076)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #04 pc 05500a98  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FMobileSceneRenderer::Render(FRHICommandListImmediate&amp;)+1228)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #05 pc 057fa970  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (_ZZN15FRendererModule24BeginRenderingViewFamilyEP7FCanvasP16FSceneViewFamilyENK4$_85clER24FRHICommandListImmediate+2316)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #06 pc 057fc944  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (_ZN10TGraphTaskI31TEnqueueUniqueRenderCommandTypeIZN15FRendererModule24BeginRenderingViewFamilyEP7FCanvasP16FSceneViewFamilyE21FDrawSceneCommandNameZNS1_24BeginRenderingViewFamilyES3_S5_E4$_85EE11ExecuteTaskER6TArrayIP14FBaseGraphTask17FDefaultAllocatorEN13ENamedThreads4TypeE+712)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #07 pc 040bfa04  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FNamedTaskThread::ProcessTasksNamedThread(int, bool)+2876)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #08 pc 040be518  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FNamedTaskThread::ProcessTasksUntilQuit(int)+108)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #09 pc 0518eaec  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (RenderingThreadMain(FEvent*)+436)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #10 pc 051d93d8  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FRenderingThread::Run()+20)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #11 pc 04142c8c  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FRunnableThreadPThread::Run()+164)</span><br><span class="line">06-17 15:23:52.350 27129 27129 F DEBUG   :     #12 pc 040b9ef0  /data/app/com.imzlp.GWorld-tDCKTLEN7M7ZaRP1btpWdA==/lib/arm/libUE4.so (FRunnableThreadPThread::_ThreadProc(void*)+80)</span><br><span class="line">06-17 15:23:52.430 26991 27061 D UE4     : Used memory: 361838</span><br><span class="line">06-17 15:27:43.270 13042 13231 I MtpDatabase: Mediaprovider didn&#x27;t delete /storage/emulated/0/UE4Game/GWorld/GWorld/Saved/Paks/1.45_Android_ETC2_001_P.pak</span><br><span class="line">06-17 15:27:45.781 13042 13231 D MtpServer: path: /storage/emulated/0/UE4Game/GWorld/GWorld/Saved/Paks/1.45_Android_ETC2_001_P.pak parent: 68 storageID: 00010001</span><br></pre></td></tr></table></figure>

<p>有时间在来具体分析。</p>
<h2 id="target-build-cs输出Log"><a href="#target-build-cs输出Log" class="headerlink" title="target/build.cs输出Log"></a>target/build.cs输出Log</h2><p>可以使用C#里的以下代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line">System.Console.WriteLine(<span class="string">&quot;12346&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="TargetRules的BuildSettingsVersion"><a href="#TargetRules的BuildSettingsVersion" class="headerlink" title="TargetRules的BuildSettingsVersion"></a>TargetRules的BuildSettingsVersion</h2><blockquote>
<p>PS:UE4.24之后才有。</p>
</blockquote>
<p>可以在<code>Target.cs</code>中指定：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DefaultBuildSettings = BuildSettingsVersion.V2;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Programs/UnrealBuildTool/Configuration/TargetRules.cs#L88">BuildSettingsVersion</a>可以指定构建时使用的默认设置：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Determines which version of the engine to take default build settings from. This allows for backwards compatibility as new options are enabled by default.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> BuildSettingsVersion</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Legacy default build settings for 4.23 and earlier.</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	V1,</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> New defaults for 4.24: ModuleRules.PCHUsage = PCHUsageMode.UseExplicitOrSharedPCHs, ModuleRules.bLegacyPublicIncludePaths = false.</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	V2,</span><br><span class="line"></span><br><span class="line">	<span class="comment">// *** When adding new entries here, be sure to update GameProjectUtils::GetDefaultBuildSettingsVersion() to ensure that new projects are created correctly. ***</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Always use the defaults for the current engine version. Note that this may cause compatibility issues when upgrading.</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	Latest</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UE4.23及之前的引擎版本是<code>V1</code>，用来控制当项目升级引擎版本时使用之前引擎的构建设置，用于解决项目升级之后会有大量错误的问题。</p>
<blockquote>
<p>注意：因为4.25之后的是V2，默认<code>bLegacyPublicIncludePaths=false</code>，这个会导致如果模块中相对于<code>Public</code>的代码路径，如<code>Public/Core/CoreCode.h</code>，如果没有添加Core目录到<code>PublicIncludePaths</code>中，在工程的其他地方不指定相对路径，直接用<code>CoreCode.h</code>，在V1的版本里是可以编译过的，但是在V2中就会有编译错误。</p>
</blockquote>
<h2 id="从TargetRules获取引擎版本"><a href="#从TargetRules获取引擎版本" class="headerlink" title="从TargetRules获取引擎版本"></a>从TargetRules获取引擎版本</h2><p><code>TargetRules</code>中具有**Version (ReadOnlyBuildVersion)**成员，它是<code>BuildVersion</code>的类型，定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Programs/UnrealBuildTool/System/BuildVersion.cs">Programs\UnrealBuildTool\System\BuildVersion.cs</a>中。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BuildVersion</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The major engine version (4 for UE4)</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> MajorVersion;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The minor engine version</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> MinorVersion;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The hotfix/patch version</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> PatchVersion;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The changelist that the engine is being built from</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> Changelist;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The changelist that the engine maintains compatibility with</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> CompatibleChangelist;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Whether the changelist numbers are a licensee changelist</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">bool</span> IsLicenseeVersion;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Whether the current build is a promoted build, that is, built strictly from a clean sync of the given changelist</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">bool</span> IsPromotedBuild;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Name of the current branch, with &#x27;/&#x27; characters escaped as &#x27;+&#x27;</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">string</span> BranchName;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The current build id. This will be generated automatically whenever engine binaries change if not set in the default Engine/Build/Build.version.</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">string</span> BuildId;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> The build version string</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">string</span> BuildVersionString;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以在<code>Target.cs</code>或者<code>Build.cs</code>里通过<code>Target.Version</code>来访问引擎版本，可以根据不同的引擎版本来使用不同的库。</p>
<h2 id="从TargetRules获取Configuration"><a href="#从TargetRules获取Configuration" class="headerlink" title="从TargetRules获取Configuration"></a>从TargetRules获取Configuration</h2><p>从<code>ReadOnlyTargetRules</code>接收到的Target，可以从其中获取<code>Configuration</code>成员，用于检测打包的<code>BuildConfiguration</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Target.Configuration == UnrealTargetConfiguration.Shipping)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>枚举值为<code>Development</code>/<code>Debug</code>/<code>DebugGame</code>/<code>Shipping</code>/<code>Test</code>等。</p>
<h2 id="IOS-CrashLog分析"><a href="#IOS-CrashLog分析" class="headerlink" title="IOS CrashLog分析"></a>IOS CrashLog分析</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/technotes/tn2151/_index.html">Understanding and Analyzing Application Crash Reports</a></li>
</ul>
<h2 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h2><blockquote>
<p>UE4使用<strong>标记</strong>-<strong>清扫</strong>式的GC方式，它是一种经典的垃圾回收方式。一次垃圾回收分为两个阶段。第一阶段从一个根集合出发，遍历所有可达对象，遍历完成后就能标记出可达对象和不可达对象了，这个阶段会在一帧内完成。第二阶段会渐进式的清理这些不可达对象，因为不可达的对象将永远不能被访问到，所以可以分帧清理它们，避免一下子清理很多UObject，比如map卸载时，发生明显的卡顿。</p>
</blockquote>
<p>UObject之间的引用关系需要用强指针引用加UPROPERTY标记完成。</p>
<p>UPROPERTY标记通过UHT之后会生成UProperty对象，UProperty对象可以控制对属性的访问。也通过UProperty对象保存引用关系。</p>
<p>如果想要给没有添加UPROPERTY标记的对象添加引用可以通过重写<code>UObject</code>的虚函数<code>AddReferencedObjects</code>，比如AActor中的<code>OwnedComponents</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Actor.h</span></span><br><span class="line">TSet&lt;UActorComponent*&gt; OwnedComponents;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Actor.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AActor::AddReferencedObjects</span><span class="params">(UObject* InThis, FReferenceCollector&amp; Collector)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	AActor* This = CastChecked&lt;AActor&gt;(InThis);</span><br><span class="line">	Collector.AddReferencedObjects(This-&gt;OwnedComponents);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	<span class="keyword">if</span> (This-&gt;CurrentTransactionAnnotation.IsValid())</span><br><span class="line">	&#123;</span><br><span class="line">		This-&gt;CurrentTransactionAnnotation-&gt;AddReferencedObjects(Collector);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	Super::AddReferencedObjects(InThis, Collector);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SDetailsView监听属性变化"><a href="#SDetailsView监听属性变化" class="headerlink" title="SDetailsView监听属性变化"></a>SDetailsView监听属性变化</h2><p>可以通过监听基类<code>SDetailsViewBase</code>中的<code>OnFinishedChangingPropertiesDelegate</code>代理来实现。</p>
<p>接收参数是<code>FPropertyChangedEvent</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE_MULTICAST_DELEGATE_OneParam(FOnFinishedChangingProperties, <span class="keyword">const</span> FPropertyChangedEvent&amp;);</span><br></pre></td></tr></table></figure>

<h2 id="UObject-serializer的调用栈"><a href="#UObject-serializer的调用栈" class="headerlink" title="UObject serializer的调用栈"></a>UObject serializer的调用栈</h2><p><img data-src="index/UE4/uobject-data-serialize-callstack.webp"></p>
<p>有时间再来分析具体内容。</p>
<h2 id="FName-FString-FText的区别"><a href="#FName-FString-FText的区别" class="headerlink" title="FName/FString/FText的区别"></a>FName/FString/FText的区别</h2><h3 id="FName"><a href="#FName" class="headerlink" title="FName"></a>FName</h3><p>FName的字符串一般用在为资源命名或者访问资源时（比如命名的骨骼）需要使用。<br>它使用一个轻型系统使用字符串，特定字符串会被重复使用，在数据表中也就只存储一次。</p>
<ol>
<li>只在内存中存储一次</li>
<li>不区分大小写</li>
<li>不能被修改</li>
<li>查找和访问速度比较快</li>
<li>内部有一个HASH值<br>FName在Edior中占12个字节，打包8字节，FName的<code>XXXX_12</code>这样的字符串会被分成string part和number part，估计是为了想不为每个拼接的结果都在NamePool中创建一份吧。</li>
</ol>
<h3 id="FString"><a href="#FString" class="headerlink" title="FString"></a>FString</h3><p>FSting比较类似于标准库的<code>std::string</code>，区分大小写，可修改，每份实例都是单独的内存。</p>
<h3 id="FText"><a href="#FText" class="headerlink" title="FText"></a>FText</h3><p>FText是用于本地化的类，所有需要展示的文本都需要使用FText，它提供了以下功能：</p>
<ol>
<li>创建本地化文本</li>
<li>格式化文本</li>
<li>从数字生成文本</li>
<li>从日期或时间生成文本</li>
<li>转换文本（大小写转换等）</li>
</ol>
<h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/StringHandling/index.html">String Handling</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Gameplay/Localization/Formatting/index.html#textliterals">Text Localization</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/144850633">UE4 FName原理分析</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/139711646">UE4底层剖析之命名系统</a></li>
</ul>
<h2 id="Plugin添加其他Plugin的模块"><a href="#Plugin添加其他Plugin的模块" class="headerlink" title="Plugin添加其他Plugin的模块"></a>Plugin添加其他Plugin的模块</h2><p>如果插件A要引用插件B中的模块，那么就需要在插件A的uplugin文件中添加对插件B的依赖：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;Plugins&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;Name&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;Enabled&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>

<p>然后就可以在插件A中添加插件B中的模块了。</p>
<h2 id="Build-Configurations"><a href="#Build-Configurations" class="headerlink" title="Build Configurations"></a>Build Configurations</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/Development/BuildConfigurations/index.html">Build Configurations Reference</a></li>
</ul>
<table>
<thead>
<tr>
<th>Build Status</th>
<th>Describle</th>
</tr>
</thead>
<tbody><tr>
<td>Debug</td>
<td>引擎和游戏符号都以debug方式编译，需要源码版引擎</td>
</tr>
<tr>
<td>DebugGame</td>
<td>优化引擎代码，只可以调试Game符号</td>
</tr>
<tr>
<td>Development</td>
<td>默认的配置，在DebugGame的模式上进行优化，只可以调试游戏符号</td>
</tr>
<tr>
<td>Shipping</td>
<td>不包含调试符号、Console、stats、profiling工具，用于发行版本</td>
</tr>
<tr>
<td>Test</td>
<td>与Shipping相同，但是要会包含Console、stats、profiling等工具</td>
</tr>
</tbody></table>
<p>如果使用从<code>EpicLauncher</code>安装的引擎，打包Debug时会提示：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Targets cannot be built in the Debug configuration with this engine distribution.</span><br></pre></td></tr></table></figure>
<p>这个报错是在UBT中产生的，具体代码在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.25.1-release/Engine/Source/Programs/UnrealBuildTool/Configuration/UEBuildTarget.cs#L719">UnrealBuildTool\Configuration\UEBuildTarget.cs</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.reddit.com/r/unrealengine/comments/ejz4dg/targets_cannot_be_built_in_the_debug/">“Targets cannot be built in the Debug configuration with this engine distribution.”</a></li>
</ul>
<h2 id="GlobalShaderCache的加载"><a href="#GlobalShaderCache的加载" class="headerlink" title="GlobalShaderCache的加载"></a>GlobalShaderCache的加载</h2><p>在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/Engine/Private/ShaderCompiler/ShaderCompiler.cpp">Runtime/Engine/Private/ShaderCompiler/ShaderCompiler.cpp</a>中有获取<code>GlobalShaderCache*.bin</code>的方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetGlobalShaderCacheFilename</span><span class="params">(EShaderPlatform Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> FString(TEXT(<span class="string">&quot;Engine&quot;</span>)) / TEXT(<span class="string">&quot;GlobalShaderCache-&quot;</span>) + LegacyShaderPlatformToShaderFormat(Platform).ToString() + TEXT(<span class="string">&quot;.bin&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在同文件中定义的<code>CompileGlobalShaderMap</code>函数中被读取。<br>调用栈：</p>
<p><img data-src="index/UE4/Shader/ue-launch-game-CompileGlobalShaderMap-callstack.webp"></p>
<p>完整流程有时间再来分析。</p>
<h2 id="ushaderbytecode的加载"><a href="#ushaderbytecode的加载" class="headerlink" title="ushaderbytecode的加载"></a>ushaderbytecode的加载</h2><p>在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp">Runtime/RenderCore/Private/ShaderCodeLibrary.cpp</a>文件中，可以获取到shaderbytecode相关的文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> uint32 GShaderCodeArchiveVersion = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">static</span> uint32 GShaderPipelineArchiveVersion = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> FString ShaderExtension = TEXT(<span class="string">&quot;.ushaderbytecode&quot;</span>);</span><br><span class="line"><span class="keyword">static</span> FString StableExtension = TEXT(<span class="string">&quot;.scl.csv&quot;</span>);</span><br><span class="line"><span class="keyword">static</span> FString PipelineExtension = TEXT(<span class="string">&quot;.ushaderpipelines&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetCodeArchiveFilename</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::Printf(TEXT(<span class="string">&quot;ShaderArchive-%s-&quot;</span>), *LibraryName) + Platform.ToString() + ShaderExtension;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetStableInfoArchiveFilename</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::Printf(TEXT(<span class="string">&quot;ShaderStableInfo-%s-&quot;</span>), *LibraryName) + Platform.ToString() + StableExtension;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetPipelinesArchiveFilename</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::Printf(TEXT(<span class="string">&quot;ShaderArchive-%s-&quot;</span>), *LibraryName) + Platform.ToString() + PipelineExtension;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetShaderCodeFilename</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::Printf(TEXT(<span class="string">&quot;ShaderCode-%s-&quot;</span>), *LibraryName) + Platform.ToString() + ShaderExtension;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">GetShaderDebugFolder</span><span class="params">(<span class="keyword">const</span> FString&amp; BaseDir, <span class="keyword">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::Printf(TEXT(<span class="string">&quot;ShaderDebug-%s-&quot;</span>), *LibraryName) + Platform.ToString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在同文件的<code>FShaderLibraryInstance::Create</code>来加载。</p>
<p>完整流程有时间再来分析。</p>
<h2 id="默认打包到pak里的资源"><a href="#默认打包到pak里的资源" class="headerlink" title="默认打包到pak里的资源"></a>默认打包到pak里的资源</h2><p>UE在打包的时候会把工程下的<code>Content</code>中的资源进行依赖分析然后打包，但是经过对比之后发现，引擎中还会添加额外的没有引用到的资源，经过分析代码发现引擎的ini中有指定：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;Engine\Config\BaseEngine.ini</span></span><br><span class="line"><span class="section">[Engine.StartupPackages]</span></span><br><span class="line"><span class="attr">bSerializeStartupPackagesFromMemory</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">bFullyCompressStartupPackages</span>=<span class="literal">false</span></span><br><span class="line">+Package=/Engine/EngineMaterials/BlinkingCaret</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultBokeh</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultBloomKernel</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultDeferredDecalMaterial</span><br><span class="line"><span class="comment">;+Package=/Engine/EngineMaterials/DefaultPostProcessMaterial</span></span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultDiffuse</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultLightFunctionMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/WorldGridMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultNormal</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultPhysicalMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultVirtualTextureMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultWhiteGrid</span><br><span class="line">+Package=/Engine/EngineMaterials/EditorBrushMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/EmissiveMeshMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/Good64x64TilingNoiseHighFreq</span><br><span class="line">+Package=/Engine/EngineMaterials/Grid</span><br><span class="line">+Package=/Engine/EngineMaterials/Grid_N</span><br><span class="line">+Package=/Engine/EngineMaterials/LandscapeHolePhysicalMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/MiniFont</span><br><span class="line">+Package=/Engine/EngineMaterials/PaperDiffuse</span><br><span class="line">+Package=/Engine/EngineMaterials/PaperNormal</span><br><span class="line">+Package=/Engine/EngineMaterials/PhysMat_Rubber</span><br><span class="line">+Package=/Engine/EngineMaterials/PreintegratedSkinBRDF</span><br><span class="line">+Package=/Engine/EngineMaterials/RemoveSurfaceMaterial</span><br><span class="line">+Package=/Engine/EngineMaterials/WeightMapPlaceholderTexture</span><br><span class="line"></span><br><span class="line"><span class="comment">; Console platforms will remove EngineDebugMaterials from their StartupPackages</span></span><br><span class="line">+Package=/Engine/EngineDebugMaterials/BoneWeightMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/DebugMeshMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/GeomMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/HeatmapGradient</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/LevelColorationLitMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/LevelColorationUnlitMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/MAT_LevelColorationLitLightmapUV</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/ShadedLevelColorationLitMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/ShadedLevelColorationUnlitMateri</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/TangentColorMap</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorMaterial</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorViewMode_AlphaAsColor</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorViewMode_BlueOnly</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorViewMode_ColorOnly</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorViewMode_GreenOnly</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/VertexColorViewMode_RedOnly</span><br><span class="line">+Package=/Engine/EngineDebugMaterials/WireframeMaterial</span><br><span class="line"></span><br><span class="line">+Package=/Engine/EngineSounds/WhiteNoise</span><br><span class="line"></span><br><span class="line">+Package=/Engine/EngineFonts/SmallFont</span><br><span class="line">+Package=/Engine/EngineFonts/TinyFont</span><br><span class="line">+Package=/Engine/EngineFonts/Roboto</span><br><span class="line">+Package=/Engine/EngineFonts/RobotoTiny</span><br><span class="line"></span><br><span class="line"><span class="comment">; only needed for TextRender feature (3d Text in world)</span></span><br><span class="line">+Package=/Engine/EngineMaterials/DefaultTextMaterialTranslucent</span><br><span class="line">+Package=/Engine/EngineFonts/RobotoDistanceField</span><br></pre></td></tr></table></figure>

<p>就算是工程中没有任何资源，也会默认把这些资源给打包进来。</p>
<h2 id="创建Commandlet"><a href="#创建Commandlet" class="headerlink" title="创建Commandlet"></a>创建Commandlet</h2><p>在一个Editor的Module下创建下列文件和代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Commandlets/Commandlet.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HotPatcherPatcherCommandlet.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">UCLASS()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UHotPatcherPatcherCommandlet</span> :</span><span class="keyword">public</span> UCommandlet</span><br><span class="line">&#123;</span><br><span class="line">	GENERATED_BODY()</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">Main</span><span class="params">(<span class="keyword">const</span> FString&amp; Params)</span><span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// .cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HotPatcherCookerCommandlet.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">int32 <span class="title">UHotPatcherCookerCommandlet::Main</span><span class="params">(<span class="keyword">const</span> FString&amp; Params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UE_LOG(LogTemp, Log, TEXT(<span class="string">&quot;UHotPatcherCookerCommandlet::Main&quot;</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在启动的时候就可以使用下列参数来运行Commandlet，并且可以给它传递参数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor.exe PROJECT_NAME.uproject -run=HotPatcherCooker  -aaa=<span class="string">&quot;D:\\AAA.json&quot;</span> -test1</span><br></pre></td></tr></table></figure>
<p><img data-src="index/UE4/ue4-run-commandlet.webp"></p>
<h2 id="UnLua如何实现函数覆写"><a href="#UnLua如何实现函数覆写" class="headerlink" title="UnLua如何实现函数覆写"></a>UnLua如何实现函数覆写</h2><blockquote>
<p>概括来说：UnLua绑定了UE创建对象的事件，当创建CDO时会调用到UnLua的<code>NotifyUObjectCreated</code>，在其中拿到了该对象的UClass，对该对象的UClass中的UFUNCTION通过<code>SetNativeFunc</code>修改为<code>CallLua</code>函数，这样就实现了覆写UFUNCTION。</p>
</blockquote>
<p>下面来具体分析一下实现。UnLua实现覆写完整的调用栈：<br><img data-src="index/UE4/UnLua/analysis-overridden/ue4-notifyUObjectCreated-call-stack.webp"></p>
<h3 id="替换Thunk函数"><a href="#替换Thunk函数" class="headerlink" title="替换Thunk函数"></a>替换Thunk函数</h3><p>在UnLua的FLuaContext的initialize函数中，将GLuaCxt注册到了<code>GUObjectArray</code>中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaContext.cpp</span></span><br><span class="line"><span class="keyword">if</span> (!bAddUObjectNotify)</span><br><span class="line">&#123;</span><br><span class="line">    GUObjectArray.AddUObjectCreateListener(GLuaCxt);    <span class="comment">// add listener for creating UObject</span></span><br><span class="line">    GUObjectArray.AddUObjectDeleteListener(GLuaCxt);    <span class="comment">// add listener for deleting UObject</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<code>FLuaContext</code>继承自<code>FUObjectArray::FUObjectCreateListener</code>和<code>FUObjectArray::FUObjectDeleteListener</code>，所以当UE的对象系统创建对象的时候会把调用到FLuaContext的<code>NotifyUObjectCreated</code>与<code>NotifyUObjectDeleted</code>。</p>
<p>当创建一个UObject的时候会在<code>FObjectArray</code>的<code>AllocateUObjectIndex</code>中对多有注册过的<code>CreateListener</code>调用<code>NotifyUObjectDeleted</code>函数。</p>
<p>而UnLua实现覆写UFUNCTION的逻辑就是写在<code>NotifyUObjectCreated</code>中的<code>TryBindLua</code>调用中，栈如下：<br><img data-src="index/UE4/UnLua/analysis-overridden/unlua-trybindlua-call-stack.webp"><br>一个一个来说他们的作用：</p>
<h3 id="FLuaContext-TryBindUnlua"><a href="#FLuaContext-TryBindUnlua" class="headerlink" title="FLuaContext::TryBindUnlua"></a>FLuaContext::TryBindUnlua</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Try to bind Lua module for a UObject</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FLuaContext::TryToBindLua</span><span class="params">(UObjectBaseUtility *Object)</span></span>;</span><br></pre></td></tr></table></figure>
<p>主要作用是：如果创建的对象继承了<code>UUnLuaInterface</code>，具有<code>GetModuleName</code>函数，则通过传进来的UObject获取到它的UCclass，然后再通过UClass得到<code>GetModuleName</code>函数的<code>UFunction</code>，并通过CDO对象调用该UFunction，得到该CLass绑定的Lua模块名。</p>
<p>若没有静态绑定，则检查是否具有动态绑定。</p>
<h3 id="UUnLuaManager-Bind"><a href="#UUnLuaManager-Bind" class="headerlink" title="UUnLuaManager::Bind"></a>UUnLuaManager::Bind</h3><p>该函数定义在<code>UnLua/pRIVATE/UnLuaManager.cpp</code>文件中。</p>
<p>在<code>TryBindUnlua</code>中得到了当前创建对象的<code>UClass</code>和绑定的模块名，传递到了Bind函数中，它主要做了几件事情：</p>
<ol>
<li>注册Class到lua</li>
<li>require对应的lua模块</li>
<li>调用<code>UnLuaManager::BindInternal</code>函数</li>
<li>为当前对象创建一个lua端对象并push上一个<code>Initialize</code>函数并调用</li>
</ol>
<h3 id="BindInternal"><a href="#BindInternal" class="headerlink" title="BindInternal"></a>BindInternal</h3><p>其中的关键函数为<code>UnLuaManager::BindInternal</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bind a Lua module for a UObject</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UUnLuaManager::BindInternal</span><span class="params">(UObjectBaseUtility *Object, UClass *Class, <span class="keyword">const</span> FString &amp;InModuleName, <span class="keyword">bool</span> bNewCreated)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Object || !Class)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lua_State *L = *GLuaCxt;</span><br><span class="line">    TStringConversion&lt;TStringConvert&lt;TCHAR, ANSICHAR&gt;&gt; ModuleName(*InModuleName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!bNewCreated)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!BindSurvivalObject(L, Object, Class, ModuleName.Get()))    <span class="comment">// try to bind Lua module for survival UObject again...</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        FString *ModuleNamePtr = ModuleNames.Find(Class);</span><br><span class="line">        <span class="keyword">if</span> (ModuleNamePtr)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ModuleNames.Add(Class, InModuleName);</span><br><span class="line">    Classes.Add(InModuleName, Class);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_DEBUG</span></span><br><span class="line">    TSet&lt;FName&gt; *LuaFunctionsPtr = ModuleFunctions.Find(InModuleName);</span><br><span class="line">    check(!LuaFunctionsPtr);</span><br><span class="line">    TMap&lt;FName, UFunction*&gt; *UEFunctionsPtr = OverridableFunctions.Find(Class);</span><br><span class="line">    check(!UEFunctionsPtr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    TSet&lt;FName&gt; &amp;LuaFunctions = ModuleFunctions.Add(InModuleName);</span><br><span class="line">    GetFunctionList(L, ModuleName.Get(), LuaFunctions);                         <span class="comment">// get all functions defined in the Lua module</span></span><br><span class="line">    TMap&lt;FName, UFunction*&gt; &amp;UEFunctions = OverridableFunctions.Add(Class);</span><br><span class="line">    GetOverridableFunctions(Class, UEFunctions);                                <span class="comment">// get all overridable UFunctions</span></span><br><span class="line"></span><br><span class="line">    OverrideFunctions(LuaFunctions, UEFunctions, Class, bNewCreated);           <span class="comment">// try to override UFunctions</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ConditionalUpdateClass(Class, LuaFunctions, UEFunctions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数接受到的参数是创建出来的UObject，以及它的UClass，还有对应的Lua的模块名。</p>
<ol>
<li>把对象的UClass与Lua的模块名对应添加到<code>ModuleNames</code>和<code>Classes</code>中</li>
<li>从Lua端通过L获取所指定模块名中的所有函数</li>
<li>从UClass获取所有的BlueprintEvent、RepNotifyFunc函数</li>
<li>对两边获取的结果调用<code>UUnLuaManager::OverrideFunctions</code>执行替换</li>
</ol>
<p><img data-src="index/UE4/UnLua/analysis-overridden/unlua-get-lua-func-and-get-ue-ufuncion.webp"></p>
<h3 id="UUnLuaManager-OverrideFunctions"><a href="#UUnLuaManager-OverrideFunctions" class="headerlink" title="UUnLuaManager::OverrideFunctions"></a>UUnLuaManager::OverrideFunctions</h3><p>对从Lua端获取的函数使用名字在当前类的UFunction中查找，依次对其调用<code>UUnLuaManager::OverrideFunction</code>.</p>
<h3 id="UUnLuaManager-OverrideFunction"><a href="#UUnLuaManager-OverrideFunction" class="headerlink" title="UUnLuaManager::OverrideFunction"></a>UUnLuaManager::OverrideFunction</h3><ol>
<li>判断传入的UFunction是不是属于传入的Outer UClasss</li>
<li>判断是否允许调用被覆写的函数</li>
<li>调用<code>AddFunction</code>函数</li>
</ol>
<h3 id="UUnLuaManager-AddFunction"><a href="#UUnLuaManager-AddFunction" class="headerlink" title="UUnLuaManager::AddFunction"></a>UUnLuaManager::AddFunction</h3><ol>
<li>如果函数为<code>FUNC_Native</code>则将<code>FLuaInvoker::execCallLua</code>和所覆写的函数名通过<code>AddNativeFunction</code>添加至UClass</li>
<li>将<code>UFunction</code>内的函数指针替换为<code>(FNativeFuncPtr)&amp;FLuaInvoker::execCallLua</code></li>
<li>如果开启了允许调用被覆写的函数，则把替换NativeFunc之前的UFunction对象存到<code>GReflectionRegistry</code>中</li>
</ol>
<p><img data-src="index/UE4/UnLua/analysis-overridden/unlua-replace-ufunction-native-function-pointer.webp"></p>
<h3 id="Call-lua"><a href="#Call-lua" class="headerlink" title="Call lua"></a>Call lua</h3><p>首先，需要说的一点是，当使用UEC++写的带有<code>UFUNCTION</code>并具有<code>BlueprintNativeEvent</code>或者<code>BlueprintImplementableEvent</code>标记的函数，UHT会给生成对应名字的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">UFUNCTION(BlueprintNativeEvent,BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">TESTFUNC</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">TESTFUNC_Implementation</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">UFUNCTION(BlueprintImplementableEvent, meta = (DisplayName = <span class="string">&quot;BeginPlay&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">TESTImplEvent</span><span class="params">(AActor* InActor,int32 InIval)</span></span>;</span><br></pre></td></tr></table></figure>

<p>UHT生成的函数和传递的数据结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MicroEnd_423_Source_MicroEnd_423_Public_MyActor_h_13_EVENT_PARMS \</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventReceiveBytes_Parms</span> \</span></span><br><span class="line"><span class="class">	&#123;</span> \</span><br><span class="line">		TArray&lt;uint8&gt; InData; \</span><br><span class="line">	&#125;; \</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventTESTFUNC_Parms</span> \</span></span><br><span class="line"><span class="class">	&#123;</span> \</span><br><span class="line">		<span class="keyword">bool</span> ReturnValue; \</span><br><span class="line"> \</span><br><span class="line">		<span class="comment">/** Constructor, initializes return property only **/</span> \</span><br><span class="line">		MyActor_eventTESTFUNC_Parms() \</span><br><span class="line">			: ReturnValue(<span class="literal">false</span>) \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">	&#125;; \</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">MyActor_eventTESTImplEvent_Parms</span> \</span></span><br><span class="line"><span class="class">	&#123;</span> \</span><br><span class="line">		AActor* InActor; \</span><br><span class="line">		int32 InIval; \</span><br><span class="line">		<span class="keyword">bool</span> ReturnValue; \</span><br><span class="line"> \</span><br><span class="line">		<span class="comment">/** Constructor, initializes return property only **/</span> \</span><br><span class="line">		MyActor_eventTESTImplEvent_Parms() \</span><br><span class="line">			: ReturnValue(<span class="literal">false</span>) \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// gen.cpp</span></span><br><span class="line"><span class="keyword">static</span> FName NAME_AMyActor_TESTFUNC = FName(TEXT(<span class="string">&quot;TESTFUNC&quot;</span>));</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">AMyActor::TESTFUNC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MyActor_eventTESTFUNC_Parms Parms;</span><br><span class="line">	ProcessEvent(FindFunctionChecked(NAME_AMyActor_TESTFUNC),&amp;Parms);</span><br><span class="line">	<span class="keyword">return</span> !!Parms.ReturnValue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> FName NAME_AMyActor_TESTImplEvent = FName(TEXT(<span class="string">&quot;TESTImplEvent&quot;</span>));</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">AMyActor::TESTImplEvent</span><span class="params">(AActor* InActor, int32 InIval)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MyActor_eventTESTImplEvent_Parms Parms;</span><br><span class="line">	Parms.InActor=InActor;</span><br><span class="line">	Parms.InIval=InIval;</span><br><span class="line">	ProcessEvent(FindFunctionChecked(NAME_AMyActor_TESTImplEvent),&amp;Parms);</span><br><span class="line">	<span class="keyword">return</span> !!Parms.ReturnValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，UHT帮我们定义了同名函数，并将其转发给<code>ProcessEvent</code>。</p>
<p>注意：这里通过<code>FindFunctionChecked</code>方法是调用的<code>UObject::FindFunctionChecked</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UFunction* <span class="title">UObject::FindFunction</span><span class="params">( FName InName )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> GetClass()-&gt;FindFunctionByName(InName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UFunction* <span class="title">UObject::FindFunctionChecked</span><span class="params">( FName InName )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UFunction* Result = FindFunction(InName);</span><br><span class="line">	<span class="keyword">if</span> (Result == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		UE_LOG(LogScriptCore, Fatal, TEXT(<span class="string">&quot;Failed to find function %s in %s&quot;</span>), *InName.ToString(), *GetFullName());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里传递给<code>ProcessEvent</code>的<code>UFunction*</code>就是从当前对象的UClass中得到的。</p>
<p>经过前面分分析可以知道，UnLua实现的函数覆写，就是把UClass中的UFunction中的原生thunk函数指针替换为<code>FLuaInvoker::execCallLua</code>，而且当一个对象的<code>BlueprintNativeEvent</code>和<code>BlueprintImplementableEvent</code>函数被调用的时候会调用到<code>ProcessEvent</code>并传入对应的<code>UFunction*</code>，在<code>ProcessEvent</code>中又调<code>Invork</code>（调用其中的原生指针），也就是实现调用到了unlua中替换绑定的<code>FLuaInvoker::execCallLua</code>，在这个函数中再转发给调用lua端的函数，从而实现了覆写函数的目的。</p>
<p><img data-src="index/UE4/UnLua/analysis-overridden/unlua-process-event-call-stack.webp"></p>
<h2 id="引擎对Android版本的支持"><a href="#引擎对Android版本的支持" class="headerlink" title="引擎对Android版本的支持"></a>引擎对Android版本的支持</h2><p>在之前的笔记里：<a href="https://imzlp.com/notes/ue/#Android-SDK%E7%89%88%E6%9C%AC%E4%B8%8EAndroid%E7%9A%84%E7%89%88%E6%9C%AC">Android SDK版本与Android的版本</a>列出了Android系统版本和API Leve版本之间的对照表。</p>
<p>但是UE不同的引擎版本对Android的系统支持也是不一样的，在<code>Project Setting</code>-<code>Android</code>中的<code>Minimum SDK Version</code>中可以设置最小的SDK版本，也就是UE打包Android所支持的最低系统版本。</p>
<p>在UE4.25中，最低可以设置Level为19，即Android4.4，在4.25之前的引擎版本最低支持Level 9，也就是Android 2.3。</p>
<p>这部分的代码可以在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.24/Engine/Source/Runtime/Android/AndroidRuntimeSettings/Classes/AndroidRuntimeSettings.h">Runtime/Android/AndroidRuntimeSettings/Classes/AndroidRuntimeSettings.h</a>中查看，并对比不同引擎版本的区别。</p>
<h2 id="引擎对AndroidNDK的要求"><a href="#引擎对AndroidNDK的要求" class="headerlink" title="引擎对AndroidNDK的要求"></a>引擎对AndroidNDK的要求</h2><p>UE在打包Android的时候会要求系统中具有NDK环境，但是不同的引擎版本对NDK的版本要求也不一样。</p>
<p>当使用不支持的NDK版本时，打包会有如下错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UATHelper: Packaging (Android (ETC2)):   ERROR: Android toolchain NDK r14b not supported; please use NDK r21 to NDK r23 (NDK r21b recommended)</span><br><span class="line">PackagingResults: Error: Android toolchain NDK r14b not supported; please use NDK r21 to NDK r23 (NDK r21b recommended)</span><br></pre></td></tr></table></figure>

<p>提示当前系统中的NDK版本不支持，并会显示支持的版本。</p>
<p>UE打包时对NDK版本的检测是在UBT中执行的，具体文件为<code>UnrealBuildTool/Platform/Android/AndroidToolChain.cs</code>。</p>
<p>其中定义了当前引擎版本支持的NDK的最低和最高版本：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in ue 4.25</span></span><br><span class="line"><span class="keyword">readonly</span> <span class="keyword">int</span> MinimumNDKToolchain = <span class="number">210100</span>;</span><br><span class="line"><span class="keyword">readonly</span> <span class="keyword">int</span> MaximumNDKToolchain = <span class="number">230100</span>;</span><br><span class="line"><span class="keyword">readonly</span> <span class="keyword">int</span> RecommendedNDKToolchain = <span class="number">210200</span>;</span><br></pre></td></tr></table></figure>

<p>可以在Github上比较方便地查看不同引擎版本要求的NDK版本:<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.25/Engine/Source/Programs/UnrealBuildTool/Platform/Android/AndroidToolChain.cs">UE_425_AndroidToolChain.cs</a></p>
<h2 id="从TargetRules获取引擎版本-1"><a href="#从TargetRules获取引擎版本-1" class="headerlink" title="从TargetRules获取引擎版本"></a>从TargetRules获取引擎版本</h2><p>之前写到过在C++代码里，UE提供了几个宏可以获取引擎版本（<a href="https://imzlp.com/posts/25331/#UE%E7%89%88%E6%9C%AC%E5%8F%B7%E7%9A%84%E5%AE%8F%E5%AE%9A%E4%B9%89">UE版本号的宏定义</a>），那么怎么在build.cs里检测引擎版本？</p>
<p>在UE4.19版本之前从UBT获取引擎版本比较麻烦：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BuildVersion Version;</span><br><span class="line"><span class="keyword">if</span> (BuildVersion.TryRead(BuildVersion.GetDefaultFileName(), out Version))</span><br><span class="line">&#123;</span><br><span class="line">    System.Console.WriteLine(Version.MajorVersion);</span><br><span class="line">    System.Console.WriteLine(Version.MinorVersion);</span><br><span class="line">    System.Console.WriteLine(Version.PatchVersion);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在UE4.19及以后的引擎版本，可以通过<code>ReadOnlyTargetRules.Version</code>来获得，它是<code>ReadOnlyBuildVersion</code>类型，包裹了一个<code>BuildVersion</code>类：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTools/System/BuildVersion.cs</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">UnrealBuildTool</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> Holds information about the current engine version</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	[<span class="meta">Serializable</span>]</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BuildVersion</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The major engine version (4 for UE4)</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">int</span> MajorVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The minor engine version</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">int</span> MinorVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The hotfix/patch version</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">int</span> PatchVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The changelist that the engine is being built from</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">int</span> Changelist;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The changelist that the engine maintains compatibility with</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">int</span> CompatibleChangelist;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> Whether the changelist numbers are a licensee changelist</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">bool</span> IsLicenseeVersion;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> Whether the current build is a promoted build, that is, built strictly from a clean sync of the given changelist</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">bool</span> IsPromotedBuild;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> Name of the current branch, with &#x27;/&#x27; characters escaped as &#x27;+&#x27;</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">string</span> BranchName;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The current build id. This will be generated automatically whenever engine binaries change if not set in the default Engine/Build/Build.version.</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">string</span> BuildId;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> The build version string</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">string</span> BuildVersionString;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的<code>MajorVersion</code>/<code>MinorVersion</code>/<code>PatchVersion</code>分别对应X.XX.X。</p>
<h2 id="FPaths中Dir函数的对应路径"><a href="#FPaths中Dir函数的对应路径" class="headerlink" title="FPaths中Dir函数的对应路径"></a>FPaths中Dir函数的对应路径</h2><p>FPaths提供了很多<code>EngineDir</code>等之类的函数，我在unlua里导出了这些符号：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">print(fmt(<span class="string">&quot;EngineDir: &#123;&#125;&quot;</span>,UE4.FPaths.EngineDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;EngineUserDir: &#123;&#125;&quot;</span>,UE4.FPaths.EngineUserDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;EngineContentDir: &#123;&#125;&quot;</span>,UE4.FPaths.EngineContentDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;EngineConfigDir: &#123;&#125;&quot;</span>,UE4.FPaths.EngineConfigDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;EngineSavedDir: &#123;&#125;&quot;</span>,UE4.FPaths.EngineSavedDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;EnginePluginsDir: &#123;&#125;&quot;</span>,UE4.FPaths.EnginePluginsDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;RootDir: &#123;&#125;&quot;</span>,UE4.FPaths.RootDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;ProjectDir: &#123;&#125;&quot;</span>,UE4.FPaths.ProjectDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;ProjectUserDir: &#123;&#125;&quot;</span>,UE4.FPaths.ProjectUserDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;ProjectContentDir: &#123;&#125;&quot;</span>,UE4.FPaths.ProjectContentDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;ProjectConfigDir: &#123;&#125;&quot;</span>,UE4.FPaths.ProjectConfigDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;ProjectSavedDir: &#123;&#125;&quot;</span>,UE4.FPaths.ProjectSavedDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;ProjectIntermediateDir: &#123;&#125;&quot;</span>,UE4.FPaths.ProjectIntermediateDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;ProjectPluginsDir: &#123;&#125;&quot;</span>,UE4.FPaths.ProjectPluginsDir()))</span><br><span class="line">print(fmt(<span class="string">&quot;ProjectLogDir: &#123;&#125;&quot;</span>,UE4.FPaths.ProjectLogDir()))</span><br></pre></td></tr></table></figure>

<p>他们对应的具体路径为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">EngineDir: ../../../Engine/</span><br><span class="line">EngineUserDir: : /Users/imzlp/AppData/Local/UnrealEngine/4.22/</span><br><span class="line">EngineContentDir: ../../../Engine/Content/</span><br><span class="line">EngineConfigDir: ../../../Engine/Config/</span><br><span class="line">EngineSavedDir: : /Users/imzlp/AppData/Local/UnrealEngine/4.22/Saved/</span><br><span class="line">EnginePluginsDir: ../../../Engine/Plugins/</span><br><span class="line">RootDir: : /Program Files/Epic Games/UE_4.22/</span><br><span class="line">ProjectDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/</span><br><span class="line">ProjectUserDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/</span><br><span class="line">ProjectContentDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Content/</span><br><span class="line">ProjectConfigDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Config/</span><br><span class="line">ProjectSavedDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Saved/</span><br><span class="line">ProjectIntermediateDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Intermediate/</span><br><span class="line">ProjectPluginsDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Plugins/</span><br><span class="line">ProjectLogDir: ../../../../../../Users/imzlp/Documents/UnrealProjectSSD/GWorldClient/Saved/Logs/</span><br></pre></td></tr></table></figure>
<p>这些相对路径都是<strong>相对于引擎的exe</strong>的路径的：<br><img data-src="index/UE4/ue-fpath-relative-engine-binary.webp"></p>
<h2 id="通过Commandline替换加载的ini"><a href="#通过Commandline替换加载的ini" class="headerlink" title="通过Commandline替换加载的ini"></a>通过Commandline替换加载的ini</h2><p>如项目下的<code>DefaultEngine.ini</code>/<code>DefaultGame.ini</code>等。<br>去掉<code>Default</code>和<code>ini</code>后缀之后是它们的baseName，可以通过下列命令行来替换：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># engine</span></span><br><span class="line">-EngineINI=REPLACE_INI_FILE_PAT.ini</span><br><span class="line"><span class="comment"># game</span></span><br><span class="line">-GameINI=REPLACE_INI_FILE_PAT.ini</span><br></pre></td></tr></table></figure>
<p>具体实现是在<code>FConfigCacheIni::GetDestIniFilename</code>中做的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Core/Private/Misc/ConfigCacheIni.cpp</span></span><br><span class="line"><span class="function">FString <span class="title">FConfigCacheIni::GetDestIniFilename</span><span class="params">(<span class="keyword">const</span> TCHAR* BaseIniName, <span class="keyword">const</span> TCHAR* PlatformName, <span class="keyword">const</span> TCHAR* GeneratedConfigDir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// figure out what to look for on the commandline for an override</span></span><br><span class="line">	FString CommandLineSwitch = FString::Printf(TEXT(<span class="string">&quot;%sINI=&quot;</span>), BaseIniName);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// if it&#x27;s not found on the commandline, then generate it</span></span><br><span class="line">	FString IniFilename;</span><br><span class="line">	<span class="keyword">if</span> (FParse::Value(FCommandLine::Get(), *CommandLineSwitch, IniFilename) == <span class="literal">false</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">FString <span class="title">Name</span><span class="params">(PlatformName ? PlatformName : ANSI_TO_TCHAR(FPlatformProperties::PlatformName()))</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if the BaseIniName doens&#x27;t contain the config dir, put it all together</span></span><br><span class="line">		<span class="keyword">if</span> (FCString::Stristr(BaseIniName, GeneratedConfigDir) != <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			IniFilename = BaseIniName;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			IniFilename = FString::Printf(TEXT(<span class="string">&quot;%s%s/%s.ini&quot;</span>), GeneratedConfigDir, *Name, BaseIniName);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// standardize it!</span></span><br><span class="line">	FPaths::MakeStandardFilename(IniFilename);</span><br><span class="line">	<span class="keyword">return</span> IniFilename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取当前平台信息"><a href="#获取当前平台信息" class="headerlink" title="获取当前平台信息"></a>获取当前平台信息</h2><p>可以使用<code>FPlatformProperties</code>来获取当前程序的平台信息。<br>同样是使用UE的跨平台库写法，<code>FGenericPlatformProperties</code>是定义在<code>Core/Public/GenericPlatform/GenericPlatformProperties.h</code>中的。</p>
<p>例：可以使用<code>FPlatformProperties::PlatformName()</code>运行时来获取当前平台的名字。</p>
<p>而<code>FPlatformProperties</code>的<code>typedef</code>是定义在<code>Core/Public/HAL/PlatformProperties.h</code>中。</p>
<h2 id="COMPILED-PLATFORM-HEADER"><a href="#COMPILED-PLATFORM-HEADER" class="headerlink" title="COMPILED_PLATFORM_HEADER"></a>COMPILED_PLATFORM_HEADER</h2><p>在UE4.22之前，UE的跨平台库的实现方式都是创建一个泛型平台类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FGenericPlatformUtils</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenericMethod</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后每个平台实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Windows/WindowsPlatformUtils.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FWindowsPlatformUtils</span>:</span><span class="keyword">public</span> FGenericPlatformUtils</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GenericMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">//doSomething...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> FWindowsPlatformUtils FPlatformUtils;</span><br></pre></td></tr></table></figure>

<p>在UE4.22之前，需要使用下面这种方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PlatformUtils.h</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">if</span> PLATFORM_ANDROID</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Android/AndroidPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_IOS</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IOS/IOSPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_WINDOWS</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows/WindowsPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_MAC</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Mac/MacPlatformUtils.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>需要手动判断每个平台再进行包含，也是比较麻烦的，在4.23之后，UE引入了一个宏：<code>COMPILED_PLATFORM_HEADER</code>，可以把上面的包含简化为下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> COMPILED_PLATFORM_HEADER(PlatformUtils.h)</span></span><br></pre></td></tr></table></figure>

<p>它是定义在<code>Runtime/Core/Public/HAL/PreprocessorHelpers.h</code>下的宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_IS_EXTENSION</span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header in the platform extension form &quot;PlatformHeader.h&quot;, not like below form</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER(Suffix) PREPROCESSOR_TO_STRING(PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header in the form &quot;Platform/PlatformHeader.h&quot;, like &quot;Windows/WindowsPlatformFile.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER(Suffix) PREPROCESSOR_TO_STRING(PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME/PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>注释已经比较说明作用了。而且它还有兄弟宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_IS_EXTENSION</span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header with the platform in its name, like &quot;Pre/Fix/PlatformNameSuffix.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER_WITH_PREFIX(Prefix, Suffix) PREPROCESSOR_TO_STRING(Prefix/PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// Creates a string that can be used to include a header with the platform in its name, like &quot;Pre/Fix/PlatformName/PlatformNameSuffix.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILED_PLATFORM_HEADER_WITH_PREFIX(Prefix, Suffix) PREPROCESSOR_TO_STRING(Prefix/PLATFORM_HEADER_NAME/PREPROCESSOR_JOIN(PLATFORM_HEADER_NAME, Suffix))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>命名有规律是多么重要的一件事…</p>
<h2 id="遍历UCLASS或USTRUCT的反射成员"><a href="#遍历UCLASS或USTRUCT的反射成员" class="headerlink" title="遍历UCLASS或USTRUCT的反射成员"></a>遍历UCLASS或USTRUCT的反射成员</h2><p>可以通过<code>TFieldIterator</code>来遍历：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (TFieldIterator&lt;UProperty&gt; PropertyIt(ProxyClass); PropertyIt; ++PropertyIt)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：4.25之后没有UProperty，变成了FProperty.</p>
</blockquote>
<h2 id="Lua-Metatable"><a href="#Lua-Metatable" class="headerlink" title="Lua:Metatable"></a>Lua:Metatable</h2><ul>
<li><a target="_blank" rel="noopener" href="http://lua-users.org/cgi-bin/wiki.pl?action=search&string=MetatableEvents&body=1">Metatable Events</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jimobuwu/p/8980808.html">Lua中的元表，弱表，面向对象</a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/tdp100/a8494a2f922f7b6bbeaa">Lua 的metatable以及支持的metamethod</a></li>
</ul>
<h2 id="控制打包时ini的拷贝"><a href="#控制打包时ini的拷贝" class="headerlink" title="控制打包时ini的拷贝"></a>控制打包时ini的拷贝</h2><p>在<code>DeploymentContext.cs</code>中的<code>DeploymentContext</code>函数中，有以下两行代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Read the list of files which are whitelisted to be staged</span></span><br><span class="line">ReadConfigFileList(GameConfig, <span class="string">&quot;Staging&quot;</span>, <span class="string">&quot;WhitelistConfigFiles&quot;</span>, WhitelistConfigFiles);</span><br><span class="line">ReadConfigFileList(GameConfig, <span class="string">&quot;Staging&quot;</span>, <span class="string">&quot;BlacklistConfigFiles&quot;</span>, BlacklistConfigFiles);</span><br></pre></td></tr></table></figure>
<p>这两个数组会在<code>CopyBuildToStageingDirectory.Automation.cs</code>中使用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Determines if an individual config file should be staged</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;SC&quot;&gt;</span>The staging context<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ConfigDir&quot;&gt;</span>Directory containing the config files<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ConfigFile&quot;&gt;</span>The config file to check<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>True if the file should be staged, false otherwise<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Nullable&lt;<span class="keyword">bool</span>&gt; <span class="title">ShouldStageConfigFile</span>(<span class="params">DeploymentContext SC, DirectoryReference ConfigDir, FileReference ConfigFile</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  StagedFileReference StagedConfigFile = SC.GetStagedFileLocation(ConfigFile);</span><br><span class="line">  <span class="keyword">if</span> (SC.WhitelistConfigFiles.Contains(StagedConfigFile))</span><br><span class="line">  &#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (SC.BlacklistConfigFiles.Contains(StagedConfigFile))</span><br><span class="line">  &#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用途就是指定哪些config会添加到包体中。<br>用法如下(写到<code>DefaultGame.ini</code>中)：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Staging]</span></span><br><span class="line">+BlacklistConfigFiles=GWorldClient/Config/DefaultGameExtensionSettings.ini</span><br></pre></td></tr></table></figure>

<h2 id="CharCast的坑"><a href="#CharCast的坑" class="headerlink" title="CharCast的坑"></a>CharCast的坑</h2><p><code>CharCast</code>是定义在<code>StringConv.h</code>的模板函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Casts one fixed-width char type into another.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Ch The character to convert.</span></span><br><span class="line"><span class="comment"> * @return The converted character.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> To, <span class="keyword">typename</span> From&gt;</span><br><span class="line"><span class="function">FORCEINLINE To <span class="title">CharCast</span><span class="params">(From Ch)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	To Result;</span><br><span class="line">	FPlatformString::Convert(&amp;Result, <span class="number">1</span>, &amp;Ch, <span class="number">1</span>, (To)UNICODE_BOGUS_CHAR_CODEPOINT);</span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是对<code>FPlatformString::Convert</code>的转发调用。</p>
<blockquote>
<p>PS：<code>UNICODE_BOGUS_CHAR_CODEPOINT</code> 宏定义为<code>&#39;?&#39;</code>。</p>
</blockquote>
<p><code>FPlatformString::Convert</code>有两个版本：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Converts the [Src, Src+SrcSize) string range from SourceChar to DestChar and writes it to the [Dest, Dest+DestSize) range.</span></span><br><span class="line"><span class="comment"> * The Src range should contain a null terminator if a null terminator is required in the output.</span></span><br><span class="line"><span class="comment"> * If the Dest range is not big enough to hold the converted output, NULL is returned.  In this case, nothing should be assumed about the contents of Dest.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Dest      The start of the destination buffer.</span></span><br><span class="line"><span class="comment"> * @param DestSize  The size of the destination buffer.</span></span><br><span class="line"><span class="comment"> * @param Src       The start of the string to convert.</span></span><br><span class="line"><span class="comment"> * @param SrcSize   The number of Src elements to convert.</span></span><br><span class="line"><span class="comment"> * @param BogusChar The char to use when the conversion process encounters a character it cannot convert.</span></span><br><span class="line"><span class="comment"> * @return          A pointer to one past the last-written element.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> SourceEncoding, <span class="keyword">typename</span> DestEncoding&gt;</span><br><span class="line"><span class="keyword">static</span> FORCEINLINE <span class="keyword">typename</span> TEnableIf&lt;</span><br><span class="line">  <span class="comment">// This overload should be called when SourceEncoding and DestEncoding are &#x27;compatible&#x27;, i.e. they&#x27;re the same type or equivalent (e.g. like UCS2CHAR and WIDECHAR are on Windows).</span></span><br><span class="line">  TAreEncodingsCompatible&lt;SourceEncoding, DestEncoding&gt;::Value,</span><br><span class="line">  DestEncoding*</span><br><span class="line">&gt;::<span class="function">Type <span class="title">Convert</span><span class="params">(DestEncoding* Dest, int32 DestSize, <span class="keyword">const</span> SourceEncoding* Src, int32 SrcSize, DestEncoding BogusChar = (DestEncoding)<span class="string">&#x27;?&#x27;</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (DestSize &lt; SrcSize)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (DestEncoding*)Memcpy(Dest, Src, SrcSize * <span class="keyword">sizeof</span>(SourceEncoding)) + SrcSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> SourceEncoding, <span class="keyword">typename</span> DestEncoding&gt;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">typename</span> TEnableIf&lt;</span><br><span class="line">  <span class="comment">// This overload should be called when the types are not compatible but the source is fixed-width, e.g. ANSICHAR-&gt;WIDECHAR.</span></span><br><span class="line">  !TAreEncodingsCompatible&lt;SourceEncoding, DestEncoding&gt;::Value &amp;&amp; TIsFixedWidthEncoding&lt;SourceEncoding&gt;::Value,</span><br><span class="line">  DestEncoding*</span><br><span class="line">  &gt;::<span class="function">Type <span class="title">Convert</span><span class="params">(DestEncoding* Dest, int32 DestSize, <span class="keyword">const</span> SourceEncoding* Src, int32 SrcSize, DestEncoding BogusChar = (DestEncoding)<span class="string">&#x27;?&#x27;</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> int32 Size = DestSize &lt;= SrcSize ? DestSize : SrcSize;</span><br><span class="line">  <span class="keyword">bool</span> bInvalidChars = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> I = <span class="number">0</span>; I &lt; Size; ++I)</span><br><span class="line">  &#123;</span><br><span class="line">    SourceEncoding SrcCh = Src[I];</span><br><span class="line">    Dest[I] = (DestEncoding)SrcCh;</span><br><span class="line">    bInvalidChars |= !CanConvertChar&lt;DestEncoding&gt;(SrcCh);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bInvalidChars)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> I = <span class="number">0</span>; I &lt; Size; ++I)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">if</span> (!CanConvertChar&lt;DestEncoding&gt;(Src[I]))</span><br><span class="line">    &#123;</span><br><span class="line">      Dest[I] = BogusChar;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LogBogusChars&lt;DestEncoding&gt;(Src, Size);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> DestSize &lt; SrcSize ? <span class="literal">nullptr</span> : Dest + Size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中关键的是第二个实现， 通过判断<code>CanConvertChar</code>来检测是否能够转换字符，如果不能转换就把转换结果设置为<code>BogusChar</code>，默认也就是<code>?</code>，这也是把不同编码的数据转换为FString有些会显示一堆<code>?</code>的原因。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tests whether a particular character can be converted to the destination encoding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Ch The character to test.</span></span><br><span class="line"><span class="comment"> * @return True if Ch can be encoded as a DestEncoding.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> DestEncoding, <span class="keyword">typename</span> SourceEncoding&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">CanConvertChar</span><span class="params">(SourceEncoding Ch)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> IsValidChar(Ch) &amp;&amp; (SourceEncoding)(DestEncoding)Ch == Ch &amp;&amp; IsValidChar((DestEncoding)Ch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以：类似<code>LoadFileToString</code>去读文件如果编码不支持，那么读出来的数据和原始文件里是不一样的。</p>
<h2 id="bUsesSlate"><a href="#bUsesSlate" class="headerlink" title="bUsesSlate"></a>bUsesSlate</h2><p>在UE的<code>TargetRules</code>中有一项属性<code>bUsesSlate</code>，可以用来控制是否启用Slate，UE文档里的描述如下：</p>
<blockquote>
<p>Whether the project uses visual Slate UI (as opposed to the low level windowing/messaging, which is always available).</p>
</blockquote>
<p>但是我想知道是否启用对于项目打出的包有什么区别。经过测试发现，以移动端为例，<code>bUsesSlate</code>的值并不会影响<code>libUE4.so</code>的大小。</p>
<p>有影响的地方<strong>只在于</strong>打包时的pak大小，这一点可以从两次分别打包的<code>PakList*.txt</code>中得知，经过对比发现若<code>bUsesSlate=false</code>，则在打包时不会把<code>Engine\Content\Slate</code>下的图片资源打包。我把两个版本的<code>PakList*.txt</code>都放在<a href="index/UE4/Package/TargetRules_bUsesSlate_PackList.7z">这里</a>，有兴趣的可以看都是有哪些资源没有被打包。</p>
<p>下面这幅图是两个分别开启<code>bUsesSlate</code>的图（左侧<code>false</code>右侧<code>true</code>），可以看到只有<code>main.obb.webp</code>的大小不一样。</p>
<p><img data-src="index/UE4/Package/ue4-package-bUsesSlate-diff.webp"></p>
<p>可以看到默认情况下<code>main.obb.webp</code>减小了大概6-7M，APK的大小也减小的差不多。</p>
<h2 id="Unreal-Plugin-Language"><a href="#Unreal-Plugin-Language" class="headerlink" title="Unreal Plugin Language"></a>Unreal Plugin Language</h2><p>在UE中为移动端添加第三方模块或者修改配置文件时经常会用到<code>AdditionalPropertiesForReceipt</code>，里面创建<code>ReceiptProperty</code>传入的<code>xml</code>文件就是UE的<code>Unreal Plugin Language</code>脚本。</p>
<p><code>ReceiptProperty</code>的平台名称在IOS和Android上是固定的，分别是<code>IOSPlugin</code>和<code>AndroidPlugin</code>，不可以指定其他的名字（详见代码<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/283e412aa843210f2d6e9ed0236861cf749b3429/Engine/Source/Programs/UnrealBuildTool/Platform/IOS/UEDeployIOS.cs#L1153">UEDeployIOS.cs#L1153</a>和<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/1eb5d965b994b4bd59f31ec4158d42f13137ab1f/Engine/Source/Programs/UnrealBuildTool/Platform/Android/UEDeployAndroid.cs#L4303">UEDeployAndroid.cs#L4303</a>）。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdditionalPropertiesForReceipt.Add(<span class="keyword">new</span> ReceiptProperty(<span class="string">&quot;AndroidPlugin&quot;</span>, Path.Combine(ThirdPartyPath, <span class="string">&quot;Android/PlatformUtils_UPL_Android.xml&quot;</span>)));</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Platforms/Mobile/UnrealPluginLanguage/index.html">Unreal Plugin Language</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/34374244">虚幻插件语言参考(Android版)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/f8f4b403eb682ffc055613c7caf9d2ba5df7f319/Engine/Source/Programs/UnrealBuildTool/System/UnrealPluginLanguage.cs">Engine/Source/Programs/UnrealBuildTool/System/UnrealPluginLanguage.cs</a></li>
</ul>
<h2 id="打包时Paklist文件的生成"><a href="#打包时Paklist文件的生成" class="headerlink" title="打包时Paklist文件的生成"></a>打包时Paklist文件的生成</h2><p>UE打出Pak时，需要一个txt的参数传入，里面记录着要打到pak里的文件信息，直接使用UE的打包改文件会存储在：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\imzlp\AppData\Roaming\Unreal Engine\AutomationTool\Logs\D+UnrealEngine+Epic+UE_4.23\PakList_microend_423-ios.txt</span><br></pre></td></tr></table></figure>

<p>类似的路径下。</p>
<p>这个文件生成的地方为：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:\UnrealEngine\Epic\UE_4<span class="number">.24</span>\Engine\Source\Programs\AutomationTool\BuildGraph\Tasks\PakFileTask.cs</span><br></pre></td></tr></table></figure>

<p>在它的<code>Execute</code>函数里，有通过外部传入的<code>PakFileTaskParameters</code>的参数来把文件写入。</p>
<h2 id="ShaderStableInfo-scl-csv"><a href="#ShaderStableInfo-scl-csv" class="headerlink" title="ShaderStableInfo*.scl.csv"></a>ShaderStableInfo*.scl.csv</h2><p>在Cook的时候会在<code>Cooked/PLATFORM/PROJECT_NAME/Metadata/PipelineCaches</code>下生成类似下面这样的文件：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ShaderStableInfo-Global-PCD3D_SM4.scl.csv</span><br><span class="line">ShaderStableInfo-Global-PCD3D_SM5.scl.csv</span><br><span class="line">ShaderStableInfo-GWorld-PCD3D_SM4.scl.csv</span><br><span class="line">ShaderStableInfo-GWorld-PCD3D_SM5.scl.csv</span><br></pre></td></tr></table></figure>

<p>里面记录了<code>FStableShaderKeyAndValue</code>结构的数据：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RenderCore/Public/ShaderCodeLibrary.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RENDERCORE_API</span> <span class="title">FStableShaderKeyAndValue</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	FCompactFullName ClassNameAndObjectPath;</span><br><span class="line">	FName ShaderType;</span><br><span class="line">	FName ShaderClass;</span><br><span class="line">	FName MaterialDomain;</span><br><span class="line">	FName FeatureLevel;</span><br><span class="line">	FName QualityLevel;</span><br><span class="line">	FName TargetFrequency;</span><br><span class="line">	FName TargetPlatform;</span><br><span class="line">	FName VFType;</span><br><span class="line">	FName PermutationId;</span><br><span class="line">	FSHAHash PipelineHash;</span><br><span class="line"></span><br><span class="line">	uint32 KeyHash;</span><br><span class="line">	FSHAHash OutputHash;</span><br><span class="line"></span><br><span class="line">	FStableShaderKeyAndValue()</span><br><span class="line">		: KeyHash(<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>作用有时间再来分析。</p>
<h2 id="PE的DLL为什么需要导入库？"><a href="#PE的DLL为什么需要导入库？" class="headerlink" title="PE的DLL为什么需要导入库？"></a>PE的DLL为什么需要导入库？</h2><p>在ELF中，共享库所有的全局函数和变量在默认情况下都可以被其他模块使用，也就是说ELF默认导出所有的全局符号。但是在DLL中不同，PE环境下需要显式地告诉编译器我们需要导出的符号，否则编译器就默认所有符号都不导出。</p>
<p>在MSVC中可以使用<code>__declspec(dllexport)</code>以及<code>__declspec(dllimport)</code>来分别表示导出本DLL的符号以及从别的DLL中导入符号。除了上面两个属性关键字还可以定义<code>def</code>文件来声明导入导出符号，def文件时连接器的链接脚本文件，可以当作链接器的输入文件，用于控制链接过程。</p>
<p>在我之前的一篇文章（<a href="https://imzlp.com/posts/18949/">动态链接库的使用：加载和链接</a>）中写到过DLL导入库的创建和使用，但是为什么DLL需要导入库而so不需要呢？前面已经回答，因为ELF是默认全导出的，PE是默认不导出的，但是我想知道原因是什么。</p>
<p>其实在有了上面的两个属性关键字之后不使用导入库也可以实现符号的导入和导出。</p>
<ol>
<li>当某个PE文件被加载时。Windows加载器的其中一个任务就是把所有需要导入的函数地址确定并且将导入表中的元素调整到正确的地址，以实现动态链接的过程，导入表中有IAT，其中的每个元素对应一个被导入的符号。</li>
<li>编译器无法知道一个符号是从外部导入的还是本模块中定义的，所以编译器是直接产生调用指令</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL XXXXXXXXX</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在<code>__declspec</code>出现之前，微软提供的方法就是使用导入库，在这种情况下，对于导入函数的调用并不区分是导入函数还是导出函数，它统一地产生直接调用的指令，但是链接器在链接时会将导入函数的目标地址导向一小段桩代码(stub)，由这个桩代码再将控制权交给IAT中的真正目标。</li>
<li>所以导入库的作用就是将编译器产生的调用命令转发到导入表的IAT中目标地址。</li>
</ol>
<h2 id="UCLASS的config"><a href="#UCLASS的config" class="headerlink" title="UCLASS的config"></a>UCLASS的config</h2><p>如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Implements the settings for the Paper2D plugin.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">UCLASS(config=Engine, defaultconfig)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PAPER2D_API</span> <span class="title">UPaperRuntimeSettings</span> :</span> <span class="keyword">public</span> UObject</span><br><span class="line">&#123;</span><br><span class="line">	GENERATED_UCLASS_BODY()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Enables experimental *incomplete and unsupported* texture atlas groups that sprites can be assigned to</span></span><br><span class="line">	UPROPERTY(EditAnywhere, config, Category=Experimental)</span><br><span class="line">	<span class="keyword">bool</span> bEnableSpriteAtlasGroups;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Enables experimental *incomplete and unsupported* 2D terrain spline editing. Note: You need to restart the editor when enabling this setting for the change to fully take effect.</span></span><br><span class="line">	UPROPERTY(EditAnywhere, config, Category=Experimental, meta=(ConfigRestartRequired=<span class="literal">true</span>))</span><br><span class="line">	<span class="keyword">bool</span> bEnableTerrainSplineEditing;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Enables automatic resizing of various sprite data that is authored in texture space if the source texture gets resized (sockets, the pivot, render and collision geometry, etc...)</span></span><br><span class="line">	UPROPERTY(EditAnywhere, config, Category=Settings)</span><br><span class="line">	<span class="keyword">bool</span> bResizeSpriteDataToMatchTextures;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个类是个config的类，可以从ini中读取配置，关键的地方就是<code>UCLASS(Config=)</code>的东西，一般情况下是<code>Engine</code>/<code>Game</code>/<code>Editor</code>，它们的ini文件都是<code>Default*.ini</code>，如上面这个类，如果想要自己在ini中来指定它们这些参数的值，则需要写到项目的<code>Config/DefaultEngine.ini</code>中：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Paper2D.PaperRuntimeSettings]</span></span><br><span class="line"><span class="attr">bEnableSpriteAtlasGroups</span> = <span class="literal">true</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>其中ini的<code>Section</code>为该配置类的<code>PackagePath</code>。</p>
<h2 id="操作剪贴板Clipboard"><a href="#操作剪贴板Clipboard" class="headerlink" title="操作剪贴板Clipboard"></a>操作剪贴板Clipboard</h2><p>有些需求是要能够访问到用户的粘贴板，来进行复制、和粘贴的功能。</p>
<p>在UE中访问粘贴板的方法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FString PasteString;</span><br><span class="line"><span class="comment">// 从剪贴板读取内容</span></span><br><span class="line">FPlatformApplicationMisc::ClipboardPaste(PasteString);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把123456放入剪贴板</span></span><br><span class="line">FPlatformApplicationMisc::ClipboardCopy(TEXT(<span class="string">&quot;123465&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>注意：<code>FPlatformApplicationMisc</code>是定义在<code>ApplicationCore</code>下的，使用时要包含该模块。</p>
<h2 id="在场景中Copy-Paste的实现"><a href="#在场景中Copy-Paste的实现" class="headerlink" title="在场景中Copy/Paste的实现"></a>在场景中Copy/Paste的实现</h2><p>在UE的场景编辑器中对一个选中的Actor进行<code>Ctrl+C</code>时把拷贝的内容粘贴到一个文本编辑器里可以看到类似以下的内容：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Begin Map</span><br><span class="line">   Begin Level</span><br><span class="line">      Begin Actor Class=/Script/Engine.Pawn Name=Pawn_1 Archetype=/Script/Engine.Pawn&#x27;/Script/Engine.Default__Pawn&#x27;</span><br><span class="line">         Begin Object Class=/Script/Engine.SceneComponent Name=&quot;DefaultSceneRoot&quot;</span><br><span class="line">         End Object</span><br><span class="line">         Begin Object Name=&quot;DefaultSceneRoot&quot;</span><br><span class="line">            RelativeLocation=(X=600.000000,Y=280.000000,Z=150.000000)</span><br><span class="line">            bVisualizeComponent=True</span><br><span class="line">            CreationMethod=Instance</span><br><span class="line">         End Object</span><br><span class="line">         RootComponent=SceneComponent&#x27;&quot;DefaultSceneRoot&quot;&#x27;</span><br><span class="line">         ActorLabel=&quot;Pawn&quot;</span><br><span class="line">         InstanceComponents(0)=SceneComponent&#x27;&quot;DefaultSceneRoot&quot;&#x27;</span><br><span class="line">      End Actor</span><br><span class="line">   End Level</span><br><span class="line">Begin Surface</span><br><span class="line">End Surface</span><br><span class="line">End Map</span><br></pre></td></tr></table></figure>
<p>它记录了当前拷贝的<code>Actor</code>的类，位置、以及与默认对象(CDO)不一致的属性。<br>拷贝上面的文本，在UE的场景编辑器里粘贴，会在场景里创建出来一个一摸一样的对象。</p>
<h3 id="Copy"><a href="#Copy" class="headerlink" title="Copy"></a>Copy</h3><p>在场景编辑器中执行<code>Ctrl+C</code>会把文本拷贝到粘贴板的实现为<code>UEditorEngine::CopySelectedActorsToClipboard</code>函数，其定义在<code>EditorServer.cpp</code>中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copies selected actors to the clipboard.  Supports copying actors from multiple levels.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> Doesn&#x27;t support copying prefab instance actors!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param InWorld				World to get the selected actors from</span></span><br><span class="line"><span class="comment"> * @param bShouldCut			If true, deletes the selected actors after copying them to the clipboard</span></span><br><span class="line"><span class="comment"> * @param bIsMove				If true, this cut is part of a move and the actors will be immediately pasted</span></span><br><span class="line"><span class="comment"> * @param bWarnAboutReferences	Whether or not to show a modal warning about referenced actors that may no longer function after being moved</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CopySelectedActorsToClipboard</span><span class="params">( UWorld* InWorld, <span class="keyword">const</span> <span class="keyword">bool</span> bShouldCut, <span class="keyword">const</span> <span class="keyword">bool</span> bIsMove = <span class="literal">false</span>, <span class="keyword">bool</span> bWarnAboutReferences = <span class="literal">true</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>调用栈为：<br><img data-src="index/UE4/ue-editor-copy-selected-actor-impl-call-stack.webp"></p>
<p>之后又会调用<code>UUnrealEngine::edactCopySelected</code>函数（<code>EditorActor.cpp</code>）,在<code>edactCopySelected</code>中通过构造出一个<code>FExportObjectInnerContext</code>的对象收集到所选择的对象：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">   Actor adding/deleting functions.</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FSelectedActorExportObjectInnerContext</span> :</span> <span class="keyword">public</span> FExportObjectInnerContext</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	FSelectedActorExportObjectInnerContext()</span><br><span class="line">		<span class="comment">//call the empty version of the base class</span></span><br><span class="line">		: FExportObjectInnerContext(<span class="literal">false</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// For each object . . .</span></span><br><span class="line">		<span class="keyword">for</span> (UObject* InnerObj : TObjectRange&lt;UObject&gt;(RF_ClassDefaultObject, <span class="comment">/** bIncludeDerivedClasses */</span> <span class="literal">true</span>, <span class="comment">/** IternalExcludeFlags */</span> EInternalObjectFlags::PendingKill))</span><br><span class="line">		&#123;</span><br><span class="line">			UObject* OuterObj = InnerObj-&gt;GetOuter();</span><br><span class="line"></span><br><span class="line">			<span class="comment">//assume this is not part of a selected actor</span></span><br><span class="line">			<span class="keyword">bool</span> bIsChildOfSelectedActor = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">			UObject* TestParent = OuterObj;</span><br><span class="line">			<span class="keyword">while</span> (TestParent)</span><br><span class="line">			&#123;</span><br><span class="line">				AActor* TestParentAsActor = Cast&lt;AActor&gt;(TestParent);</span><br><span class="line">				<span class="keyword">if</span> (TestParentAsActor &amp;&amp; TestParentAsActor-&gt;IsSelected())</span><br><span class="line">				&#123;</span><br><span class="line">					bIsChildOfSelectedActor = <span class="literal">true</span>;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				TestParent = TestParent-&gt;GetOuter();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (bIsChildOfSelectedActor)</span><br><span class="line">			&#123;</span><br><span class="line">				InnerList* Inners = ObjectToInnerMap.Find(OuterObj);</span><br><span class="line">				<span class="keyword">if</span> (Inners)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// Add object to existing inner list.</span></span><br><span class="line">					Inners-&gt;Add( InnerObj );</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// Create a new inner list for the outer object.</span></span><br><span class="line">					InnerList&amp; InnersForOuterObject = ObjectToInnerMap.Add(OuterObj, InnerList());</span><br><span class="line">					InnersForOuterObject.Add(InnerObj);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>再通过<code>UExporter::ExportToOutputDevice</code>进行序列化操作，就得到了该对象序列化之后的字符串。</p>
<h3 id="Paste"><a href="#Paste" class="headerlink" title="Paste"></a>Paste</h3><p>把文本拷贝之后在场景中粘贴会创建出Actor的核心实现为<code>UEditorEngine::PasteSelectedActorFromClipboard</code>函数，其定义在<code>EditorServer.cpp</code>中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Pastes selected actors from the clipboard.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> Doesn&#x27;t support pasting prefab instance actors!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param InWorld		World to get the selected actors from</span></span><br><span class="line"><span class="comment"> * @param PasteTo		Where to paste the content too</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PasteSelectedActorsFromClipboard</span><span class="params">( UWorld* InWorld, <span class="keyword">const</span> FText&amp; TransDescription, <span class="keyword">const</span> EPasteTo PasteTo )</span></span>;</span><br></pre></td></tr></table></figure>
<p>调用栈为：<br><img data-src="index/UE4/ue-editor-paste-selected-actor-impl-call-stack.webp"></p>
<h2 id="检测字符数组是UTF8还是GBK编码"><a href="#检测字符数组是UTF8还是GBK编码" class="headerlink" title="检测字符数组是UTF8还是GBK编码"></a>检测字符数组是UTF8还是GBK编码</h2><p>基于上个笔记的需求，所以要能够区分一个字符数组是使用UTF8还是GBK编码的。</p>
<h3 id="GBK"><a href="#GBK" class="headerlink" title="GBK"></a>GBK</h3><p>gbk 的第一字节是高位为 1 的，第 2 字节可能高位为 0 。这种情况一定是 gbk ，因为 UTF8 对 &gt;127 的编码一定每个字节高位为 1 。</p>
<h3 id="UTF8"><a href="#UTF8" class="headerlink" title="UTF8"></a>UTF8</h3><p>UTF8 是兼容 ascii 的，所以 0~127 就和 ascii 完全一致了。</p>
<p>UTF8的中文文字一定编码成三个字节：</p>
<p>汉字以及汉字标点（包括日文汉字等），在 UTF8 中一定被编码成：<code>1110**** 10****** 10******</code>。</p>
<p>如上个笔记中的<code>鸡</code>字，其UTF8的编码为<code>11101001 1011100 10100001</code>，符合上面的规则。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>相关资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.codingnow.com/2010/06/detect_utf-8_gbk.html">区分一个包含汉字的字符串是 UTF-8 还是 GBK</a></li>
</ul>
<p>工具：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.mytju.com/classcode/tools/encode_utf8.asp">查看字符编码(UTF8)</a></li>
</ul>
<h2 id="UTF8编码的字符数组转FString"><a href="#UTF8编码的字符数组转FString" class="headerlink" title="UTF8编码的字符数组转FString"></a>UTF8编码的字符数组转FString</h2><p>从网络收过来的数据流是以字节形式接收的，但是对于不同使用<code>UTF8</code>或者<code>GBK</code>编码的字符来说，他们是由多个字节组成的，如<code>鸡</code>这个汉字的UTF8编码为<code>0xE9B8A1</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> Chicken[] = &#123; (<span class="keyword">char</span>)<span class="number">0xE9</span>,(<span class="keyword">char</span>)<span class="number">0xB8</span>,(<span class="keyword">char</span>)<span class="number">0xA1</span>,`\<span class="number">0</span>`&#125;;</span><br><span class="line"><span class="function">FString <span class="title">ChickenChnese</span><span class="params">(UTF8_TO_TCHAR(Name))</span></span>;</span><br></pre></td></tr></table></figure>

<p>因为<code>Chicken</code>这个数据有四个字节，前三个字节是<code>鸡</code>这个汉字的UTF8编码，最后一个字节是<code>\0</code>表示结束符。</p>
<p>之前想的是把这个数组再表示为UTF8的字符，但是这里混淆了一个概念：这个数组本身就是UTF8编码的信息了，所以应该是把它从UTF8转换为<code>TCHAR</code>表示的字符，要使用UE的<code>UTF8_TO_CHAR</code>。</p>
<p><img data-src="index/UE4/utf8-character-of-array-to-tchar.webp"></p>
<p>因为UTF8兼容ASCII编码，所以可以混用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ANSICHAR TestArray[] = &#123; <span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>, (<span class="keyword">char</span>)<span class="number">0xE9</span>,(<span class="keyword">char</span>)<span class="number">0xB8</span>,(<span class="keyword">char</span>)<span class="number">0xA1</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;\0&#x27;</span> &#125;;</span><br><span class="line"><span class="comment">// abc鸡de1</span></span><br><span class="line"><span class="function">FString <span class="title">TestStr</span><span class="params">(UTF8_TO_TCHAR(TestArray))</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="编辑器SpawnActor"><a href="#编辑器SpawnActor" class="headerlink" title="编辑器SpawnActor"></a>编辑器SpawnActor</h2><p>可以使用<code>UEditorEngine</code>中的<code>SpawnActor</code>函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Editor/Private/EditorEngine.cpp</span></span><br><span class="line"><span class="function">AActor* <span class="title">UEditorEngine::AddActor</span><span class="params">(ULevel* InLevel, UClass* Class, <span class="keyword">const</span> FTransform&amp; Transform, <span class="keyword">bool</span> bSilent, EObjectFlags InObjectFlags)</span></span></span><br></pre></td></tr></table></figure>

<p>使用这个方法Spawn出来的会自动选中。</p>
<h2 id="虚拟制片的流程"><a href="#虚拟制片的流程" class="headerlink" title="虚拟制片的流程"></a>虚拟制片的流程</h2><p>最近想业余研究一下虚拟制片的工作流程，准备研究一下弄个个人版的方案玩玩，收集一些资料。</p>
<p>硬件要求：</p>
<ul>
<li>Valve的定位基站（HTC Vive）</li>
<li>Vive Tracker一个</li>
<li>相机+视频采集卡/网络摄像头</li>
<li>绿幕</li>
</ul>
<p>软件要求：</p>
<ul>
<li>Unreal Engine- SteamVR</li>
<li>OBS</li>
</ul>
<p>额外注意事项：</p>
<ul>
<li>拍摄时应该要和引擎内的帧率同步（<del>高级点的相机</del>）</li>
<li>拍摄时人物不应离绿幕太近会有反光的问题</li>
</ul>
<p><img data-src="index/ue4-virtual-production-flowchart.webp"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=XWQZNw9iMNs">In depth Tutorial - Virtual Production with Unreal Engine and HTC Vive</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=QSVueDjI86g">Dual Follow Focus + Dual Vive Tracker</a></li>
<li><a target="_blank" rel="noopener" href="https://vvvv.org/blog/using-htc-vive-trackers-without-headset">Using HTC Vive Trackers without Headset</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@Adamcbrz/vive-tracker-with-out-hmd-part-1-572b7a09ce49">Vive Tracker without HMD in Unreal Engine: Part 1</a></li>
</ul>
<h2 id="EditCondition支持表达式"><a href="#EditCondition支持表达式" class="headerlink" title="EditCondition支持表达式"></a>EditCondition支持表达式</h2><p>在UPROPERTY里可以对一个属性被设置的条件，比如某个bool开启时才允许编辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URPOPERTY()</span><br><span class="line"><span class="keyword">bool</span> EnableInput;</span><br><span class="line">UPROPERTY(meta=(EditCondition=<span class="string">&quot;EnableInput&quot;</span>))</span><br><span class="line">EInputMode InputMode;</span><br></pre></td></tr></table></figure>
<p>也可以对其使用取反操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URPOPERTY()</span><br><span class="line"><span class="keyword">bool</span> EnableInput;</span><br><span class="line">UPROPERTY(meta=(EditCondition=<span class="string">&quot;!EnableInput&quot;</span>))</span><br><span class="line">EInputMode InputMode;</span><br></pre></td></tr></table></figure>

<p>UE的文档介绍里说<code>EditContion</code>是支持表达式的：</p>
<blockquote>
<p>The EditCondition meta tag is no longer limited to a single boolean property. It is now evaluated using a full-fledged expression parser, meaning you can include a full C++ expression.</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Reference/Properties/Specifiers/index.html">Property Specifiers</a></li>
</ul>
<h2 id="获取资源依赖关系"><a href="#获取资源依赖关系" class="headerlink" title="获取资源依赖关系"></a>获取资源依赖关系</h2><p>最近有个需求要获取UE里资源的引用关系，类似UE的<code>Reference Viewer</code>的操作，既然知道了Reference Viewer中有想要的那么就去它的模块里面翻代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Engine\Plugins\Editor\AssetManagerEditor\Source\AssetManagerEditor\Private\ReferenceViewer\EdGraph_ReferenceViewer.cpp</span></span><br><span class="line"><span class="function">UEdGraphNode_Reference* <span class="title">UEdGraph_ReferenceViewer::RecursivelyConstructNodes</span><span class="params">(<span class="keyword">bool</span> bReferencers, UEdGraphNode_Reference* RootNode, <span class="keyword">const</span> TArray&lt;FAssetIdentifier&gt;&amp; Identifiers, <span class="keyword">const</span> FIntPoint&amp; NodeLoc, <span class="keyword">const</span> TMap&lt;FAssetIdentifier, int32&gt;&amp; NodeSizes, <span class="keyword">const</span> TMap&lt;FName, FAssetData&gt;&amp; PackagesToAssetDataMap, <span class="keyword">const</span> TSet&lt;FName&gt;&amp; AllowedPackageNames, int32 CurrentDepth, TSet&lt;FAssetIdentifier&gt;&amp; VisitedNames)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  FAssetRegistryModule&amp; AssetRegistryModule = FModuleManager::LoadModuleChecked&lt;FAssetRegistryModule&gt;(<span class="string">&quot;AssetRegistry&quot;</span>);</span><br><span class="line">  TArray&lt;FAssetIdentifier&gt; ReferenceNames;</span><br><span class="line">  TArray&lt;FAssetIdentifier&gt; HardReferenceNames;</span><br><span class="line">  <span class="keyword">if</span> ( bReferencers )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> FAssetIdentifier&amp; AssetId : Identifiers)</span><br><span class="line">    &#123;</span><br><span class="line">      AssetRegistryModule.Get().GetReferencers(AssetId, HardReferenceNames, GetReferenceSearchFlags(<span class="literal">true</span>));</span><br><span class="line">      AssetRegistryModule.Get().GetReferencers(AssetId, ReferenceNames, GetReferenceSearchFlags(<span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> FAssetIdentifier&amp; AssetId : Identifiers)</span><br><span class="line">    &#123;</span><br><span class="line">      AssetRegistryModule.Get().GetDependencies(AssetId, HardReferenceNames, GetReferenceSearchFlags(<span class="literal">true</span>));</span><br><span class="line">      AssetRegistryModule.Get().GetDependencies(AssetId, ReferenceNames, GetReferenceSearchFlags(<span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>FAssetRegistryModule</code>模块去拿就可以了，<code>FAssetIdentifier</code>中只需要有<code>PackageName</code>即可，这个PackageName是<code>LongPackageName</code>，不是<code>PackagePath</code>。</p>
<h2 id="地图的存储和加载"><a href="#地图的存储和加载" class="headerlink" title="地图的存储和加载"></a>地图的存储和加载</h2><p>存储栈:</p>
<p><img data-src="index/UE4/Level/ue4-save-level-call-stack.webp"></p>
<p>加载栈:</p>
<p><img data-src="index/UE4/Level/ue4-load-level-call-stack.webp"></p>
<h2 id="DataTable"><a href="#DataTable" class="headerlink" title="DataTable"></a>DataTable</h2><p>要创建一个可以用于创建<code>DataTable</code>的结构需要继承于<code>FTableRowBase</code>，如果要在编辑器中可编辑，该结构中的UPROPERTY不要包含<code>Category</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Engine/DataTable.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;EnemyProperty.generated.h&quot;</span></span></span><br><span class="line">USTRUCT(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FRoleProperty</span> :</span> <span class="keyword">public</span> FTableRowBase</span><br><span class="line">&#123;</span><br><span class="line">	GENERATED_BODY()</span><br><span class="line">	UPROPERTY(EditAnywhere, BlueprintReadWrite)</span><br><span class="line">		int32 AttackValue;</span><br><span class="line">	UPROPERTY(EditAnywhere, BlueprintReadWrite)</span><br><span class="line">		int32 Defense;</span><br><span class="line">	UPROPERTY(EditAnywhere, BlueprintReadWrite)</span><br><span class="line">		int32 HP;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="FCommandLine过滤模式"><a href="#FCommandLine过滤模式" class="headerlink" title="FCommandLine过滤模式"></a>FCommandLine过滤模式</h2><p><code>FCommandLine</code>是UE封装的启动参数的管理类，在<code>Launch</code>模块下的<code>FEngineLoop::PreInit</code>中被初始化(<code>FCommandLine::Set</code>)为程序启动的<code>CmdLine</code>。<br><code>FCommandLine</code>支持<code>Append</code>和<code>Parser</code>这是比较常用的功能，但是今天要说的是另外一个：CommandLine的白名单和黑名单模式。<br>考虑这样的需求：在游戏开发阶段，有很多参数可以在启动时配置，方便测试，但是在发行时需要把启动时从命令行读取配置的功能给去掉，强制使用我们设置的默认参数。</p>
<h3 id="OVERRIDE-COMMANDLINE-WHITELIST"><a href="#OVERRIDE-COMMANDLINE-WHITELIST" class="headerlink" title="OVERRIDE_COMMANDLINE_WHITELIST"></a>OVERRIDE_COMMANDLINE_WHITELIST</h3><p>怎么才是最简单的办法？其实这一点根本不需要自己去处理这部分的内容，因为<code>FCommandLine</code>支持白名单模式。<br>开启的方法为在<code>target.cs</code>中增加<code>WANTS_COMMANDLINE_WHITELIST</code>宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GlobalDefinitions.Add(<span class="string">&quot;WANTS_COMMANDLINE_WHITELIST=1&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>如果只开启这个，则默认情况下不允许接收任何外部传入的参数，但具有默认的参数<code>-fullscreen /windowed</code>。<br>当然，我们可以自己指定这个<code>WHITLIST</code>，那么就是在<code>target.cs</code>中使用<code>OVERRIDE_COMMANDLINE_WHITELIST</code>宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GlobalDefinitions.Add(<span class="string">&quot;OVERRIDE_COMMANDLINE_WHITELIST=\&quot;-arg1 -arg2 -arg3 -arg4\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>这样就只有我们指定的这些参数才可以在运行时接收，防止玩家恶意传递参数导致游戏出错。<br>这部分的代码是写在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/release/Engine/Source/Runtime/Core/Private/Misc/CommandLine.cpp">Misc/CommandLine.cpp</a>中的。</p>
<p><strong>Example</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// target.cs</span></span><br><span class="line">GlobalDefinitions.Add(<span class="string">&quot;WANTS_COMMANDLINE_WHITELIST=1&quot;</span>);</span><br><span class="line">GlobalDefinitions.Add(<span class="string">&quot;OVERRIDE_COMMANDLINE_WHITELIST=\&quot;-e -c\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这里只指定了<code>-e</code>/<code>-c</code>两个参数，如果程序在启动时被指定了其他的参数，如：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:/UnrealEngine/EngineSource/UE_4.21_Source/Engine/Binaries/Win64/UE4Launcher.exe -e -c -d</span><br></pre></td></tr></table></figure>

<p>在<code>FCommandLine::Get()</code>只能得到<code>-e</code>和<code>-c</code>，<code>-d</code>和exe路径都被丢弃了，只能用在指定开关，不能用来传递值。</p>
<h3 id="FILTER-COMMANDLINE-LOGGING"><a href="#FILTER-COMMANDLINE-LOGGING" class="headerlink" title="FILTER_COMMANDLINE_LOGGING"></a>FILTER_COMMANDLINE_LOGGING</h3><p>还可以在<code>target.cs</code>中指定<code>FILTER_COMMANDLINE_LOGGING</code>来控制对<code>FCommandLine::LoggingCmdLine</code>的过滤：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GlobalDefinitions.Add(<span class="string">&quot;FILTER_COMMANDLINE_LOGGING=\&quot;-arg1 -arg2 -arg3 -arg4\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>它会在程序从命令行中接收的参数中过滤所指定的参数，类似于参数的黑名单。</p>
<p><strong>Example</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GlobalDefinitions.Add(<span class="string">&quot;WANTS_COMMANDLINE_WHITELIST=1&quot;</span>);</span><br><span class="line">GlobalDefinitions.Add(<span class="string">&quot;FILTER_COMMANDLINE_LOGGING=\&quot;-e -c\&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>在运行时传入参数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:/UnrealEngine/EngineSource/UE_4<span class="number">.21</span>_Source/Engine/Binaries/Win64/UE4Launcher.exe -e -c -d</span><br></pre></td></tr></table></figure>

<p>得到的是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-D:/UnrealEngine/EngineSource/UE_4<span class="number">.21</span>_Source/Engine/Binaries/Win64/UE4Launcher.exe -d</span><br></pre></td></tr></table></figure>

<p><code>-e</code>和<code>-c</code>被过滤掉了。</p>
<h2 id="PIE的坑"><a href="#PIE的坑" class="headerlink" title="PIE的坑"></a>PIE的坑</h2><p>UE在PIE中运行是和Standalone模式是不同的，在PIE运行时可以通过监听<code>FEditorDelegates</code>下的<code>PreBeginPIE</code>/<code>BeginPIE</code>以及<code>PrePIEEnded</code>/<code>EndPIE</code>等代理来检测PIE模式下的游戏运行和退出。<br><strong>但是</strong>，PIE的<code>PrePIEEnded</code>和<code>EndPIE</code>都是先于<code>GameInstance</code>的<code>Shutdown</code>函数的，在一些情况下，如果PIEEnd中做了一些清理操作而在GameInstance的Shutdown函数中有使用的话会有问题。<br>解决办法为绑定<code>FGameDelegates</code>的<code>EndPlayMapDelegate</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FGameDelegates::Get().GetEndPlayMapDelegate().AddRaw(GLuaCxt, &amp;FLuaContext::OnEndPlayMap);</span><br></pre></td></tr></table></figure>

<h2 id="UPARAM-ref"><a href="#UPARAM-ref" class="headerlink" title="UPARAM(ref)"></a>UPARAM(ref)</h2><p>UE中使用<code>TArray&lt;bool&gt;&amp;</code>是作为返回值的，在蓝图中就是在节点右侧。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UFUNCTION(BlueprintCallable)</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ModifySomeArray</span><span class="params">(TArray&lt;<span class="keyword">bool</span>&gt; &amp;BooleanArray)</span></span>;</span><br></pre></td></tr></table></figure>

<p>如果想要传入已有的对象，则需要<code>UPARAM(ref)</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UFUNCTION(BlueprintCallable)</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ModifySomeArray</span><span class="params">(UPARAM(ref) TArray&lt;<span class="keyword">bool</span>&gt; &amp;BooleanArray)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.unrealengine.com/UPARAM">UPARAM</a></li>
</ul>
<h2 id="the-file-couldn’t-be-loaded-by-the-OS"><a href="#the-file-couldn’t-be-loaded-by-the-OS" class="headerlink" title="the file couldn’t be loaded by the OS."></a>the file couldn’t be loaded by the OS.</h2><p>启动引擎时如果具有类似的Crash信息：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModuleManager: Unable to load module &#x27;G:/UE_4.22/Engine/Binaries/Win64/UE4Editor-MeshUtilities.dll&#x27; because the file couldn&#x27;t be loaded by the OS.</span><br></pre></td></tr></table></figure>
<p>把引擎的<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Basics/DerivedDataCache/index.html">DDC</a>删掉之后重启引擎即可。<a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Basics/DerivedDataCache/index.html">DDC</a>的目录：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\Epic Games\UE_4.22\Engine\DerivedDataCache</span><br><span class="line">C:\Users\imzlp\AppData\Local\UnrealEngine\4.22\DerivedDataCache</span><br></pre></td></tr></table></figure>
<p>把上面两个目录都删掉。<br>如果启动项目时提示的是工程中的模块，则把工程和插件下的<code>Binaries</code>和<code>Intermediate</code>都删了重新编译生成。</p>
<h2 id="PURE-VIRTUAL-macro"><a href="#PURE-VIRTUAL-macro" class="headerlink" title="PURE_VIRTUAL macro"></a>PURE_VIRTUAL macro</h2><p>在UE的代码中看到一些虚函数使用UE的<code>PURE_VIRTUAL</code>宏来指定，类似下面这种代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GameInitialize</span><span class="params">()</span> <span class="title">PURE_VIRTUAL</span><span class="params">(IINetGameInstance::GameInitialize,)</span></span>;</span><br></pre></td></tr></table></figure>
<p>看起来有点奇怪，看一下它的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CHECK_PUREVIRTUALS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PURE_VIRTUAL(func,extra) =0;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PURE_VIRTUAL(func,extra) &#123; LowLevelFatalError(TEXT(<span class="meta-string">&quot;Pure virtual not implemented (%s)&quot;</span>), TEXT(#func)); extra &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>相当于给了纯虚函数一个默认实现，在错误调用时能够看到信息。</p>
<h2 id="使用tcping检测端口是否开放"><a href="#使用tcping检测端口是否开放" class="headerlink" title="使用tcping检测端口是否开放"></a>使用tcping检测端口是否开放</h2><p>可以使用<a target="_blank" rel="noopener" href="https://www.elifulkerson.com/projects/tcping.php">tcping</a>这个工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ tcping 127.0.0.1 10086</span><br><span class="line"><span class="comment"># 端口联通的情况</span></span><br><span class="line">Probing 127.0.0.1:10086/tcp - Port is open - time=10.775ms</span><br><span class="line">Probing 127.0.0.1:10086/tcp - Port is open - time=0.428ms</span><br><span class="line">Probing 127.0.0.1:10086/tcp - Port is open - time=0.344ms</span><br><span class="line">Probing 127.0.0.1:10086/tcp - Port is open - time=0.317ms</span><br><span class="line"></span><br><span class="line">Ping statistics <span class="keyword">for</span> 127.0.0.1:10086</span><br><span class="line">     4 probes sent.</span><br><span class="line">     4 successful, 0 failed.  (0.00% fail)</span><br><span class="line">Approximate trip <span class="built_in">times</span> <span class="keyword">in</span> milli-seconds:</span><br><span class="line">     Minimum = 0.317ms, Maximum = 10.775ms, Average = 2.966ms</span><br><span class="line">     </span><br><span class="line"><span class="comment"># 未开放端口的情况</span></span><br><span class="line">Probing 127.0.0.1:10086/tcp - No response - time=2002.595ms</span><br><span class="line">Probing 127.0.0.1:10086/tcp - No response - time=2000.168ms</span><br><span class="line">Probing 127.0.0.1:10086/tcp - No response - time=2000.202ms</span><br><span class="line">Probing 127.0.0.1:10086/tcp - No response - time=2001.308ms</span><br><span class="line"></span><br><span class="line">Ping statistics <span class="keyword">for</span> 127.0.0.1:10086</span><br><span class="line">     4 probes sent.</span><br><span class="line">     0 successful, 4 failed.  (100.00% fail)</span><br><span class="line">Was unable to connect, cannot provide trip statistics</span><br></pre></td></tr></table></figure>
<h2 id="成员模板函数特化不要放在class-scope"><a href="#成员模板函数特化不要放在class-scope" class="headerlink" title="成员模板函数特化不要放在class scope"></a>成员模板函数特化不要放在class scope</h2><p>如下面代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">	Template&amp; <span class="keyword">operator</span>&gt;&gt;(T&amp; Value)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">template</span>&lt;&gt;</span><br><span class="line">	Template&amp; <span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">bool</span>&gt;(<span class="keyword">bool</span>&amp; Value)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// do something</span></span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>声明了模板函数<code>operator&gt;&gt;</code>，而且添加了一个bool的特化，这个代码在Windows下编译没有问题，但是在打包Android时会产生错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: explicit specialization of &#x27;operator&gt;&gt;&#x27; in class scope</span><br></pre></td></tr></table></figure>

<p>说时显式特化写在了类作用域内，解决办法是把特化的版本放到类之外：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">	Template&amp; <span class="keyword">operator</span>&gt;&gt;(T&amp; Value)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line">Template&amp; Template::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">bool</span>&gt;(<span class="keyword">bool</span>&amp; Value)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// do something</span></span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9487034/how-can-i-use-template-specialization-in-c-classes-and-why-this-doesnt-compi">How can I use template specialization in c++ classes, and why this doesn’t compile?</a></li>
</ul>
<h2 id="Runtime模块包含Editor模块的错误"><a href="#Runtime模块包含Editor模块的错误" class="headerlink" title="Runtime模块包含Editor模块的错误"></a>Runtime模块包含Editor模块的错误</h2><p>如果打包时有下列错误：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UnrealBuildTool.Main: ERROR: Missing precompiled manifest for &#x27;EditorWidgets&#x27;. This module was most likely not flagged for being included in a precompiled build - set &#x27;PrecompileForTargets = PrecompileTargetsType.Any;&#x27; in EditorWidgets.build.cs to override.</span><br><span class="line">UnrealBuildTool.Main: BuildException: Missing precompiled manifest for &#x27;EditorWidgets&#x27;. This module was most likely not flagged for being included in a precompiled build - set &#x27;PrecompileForTargets = PrecompileTargetsType.Any;&#x27; in EditorWidgets.build.cs to override.</span><br></pre></td></tr></table></figure>
<p>我这里的错误提示是<code>EditorWidgets</code>是个预编译模块。<br>这个错误的原因是在<code>Runtime</code>的模块中添加了<code>UnrealEd</code>模块，因为它是属于Editor的，打包时不会把Editor的模块打包进来，所以就会有现在错误。</p>
<blockquote>
<p>注意：一定不要在Runtime的模块中包含Editor或者Developer的模块，这个是Epic的EULA限制，如果需要用到Editor或者Developer的东西，则自己在插件或者工程下新建一个<code>Editor</code>或者<code>Developer</code>才行。</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.reddit.com/r/unrealengine/comments/d7grqb/build_error_missing_precompiled_manifest_for/">BUILD ERROR: Missing precompiled manifest for ‘EditorWidgets’.</a></li>
<li><a href="https://imzlp.com/posts/9050/">分析UBT中EULA的内容分发限制</a></li>
</ul>
<h2 id="获取蓝图添加的所有接口"><a href="#获取蓝图添加的所有接口" class="headerlink" title="获取蓝图添加的所有接口"></a>获取蓝图添加的所有接口</h2><p>拿到<code>UBlueprint</code>之后可以通过获取<code>ImplementedInterfaces</code>来访问：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; InterfaceItem : Blueprint-&gt;ImplementedInterfaces)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (InterfaceItem.Interface.Get()-&gt;IsChildOf(UUnLuaInterface::StaticClass()))</span><br><span class="line">	&#123;</span><br><span class="line">		bImplUnLuaInterface = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="UnrealFrontEnd-DeviceLog"><a href="#UnrealFrontEnd-DeviceLog" class="headerlink" title="UnrealFrontEnd DeviceLog"></a>UnrealFrontEnd DeviceLog</h2><p>之前在PC上看移动端的Log的方式是是用Logcat，但是发现UE其实提供了工具，就是UnrealFrontLog中的<code>DeviceLog</code>：<br><img data-src="index/UE4/unreal-front-end-device-log.webp"><br>最下面的那一行也可以执行控制台命令，很方便。</p>
<blockquote>
<p>PS：我测试了在PC上连接Android设备没有问题，但是连上IOS不显示，在Mac上连接IOS没有问题，不过不显示Log，但可以执行命令。</p>
</blockquote>
<h2 id="获取某个类的所有子类"><a href="#获取某个类的所有子类" class="headerlink" title="获取某个类的所有子类"></a>获取某个类的所有子类</h2><p>查找所有继承自某个UClass的类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/UObjectIterator.h&quot;</span></span></span><br><span class="line"><span class="function">TArray&lt;UClass*&gt; <span class="title">UNetGameInstance::GetAllSubsystem</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TArray&lt;UClass*&gt; result;</span><br><span class="line">	<span class="keyword">for</span> (TObjectIterator&lt;UClass&gt; It; It; ++It)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (It-&gt;IsChildOf(UNetSubsystemBase::StaticClass()) &amp;&amp; !It-&gt;HasAnyClassFlags(CLASS_Abstract))</span><br><span class="line">		&#123;</span><br><span class="line">			result.Add(*It);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-22-3打包IOS-Crash的问题"><a href="#4-22-3打包IOS-Crash的问题" class="headerlink" title="4.22.3打包IOS Crash的问题"></a>4.22.3打包IOS Crash的问题</h2><p>在下列环境下：</p>
<ol>
<li>macOS Mojave 10.14.5</li>
<li>XCode 11.2.1(11B500)</li>
<li>UE4.22.3</li>
<li>iPhone 7 IOS13.3.1</li>
</ol>
<p>在这个环境下打包出来的IOS在运行时会Crash，但是换到4.23.1就没有这个问题。<br>Crash的Log:<a href="index/UE4/IOS/GWorld_2020_3_12_6_58_PM.crash">GWorld 2020-3-12 6-58-PM.crash</a></p>
<h2 id="IOS贴图非2次幂的显示问题"><a href="#IOS贴图非2次幂的显示问题" class="headerlink" title="IOS贴图非2次幂的显示问题"></a>IOS贴图非2次幂的显示问题</h2><p>默认情况下在iOS里使用非2次幂大小的贴图会有下列问题：<br><img data-src="index/UE4/IOS/texture-not-power-of-two.webp"><br>提示的是<em>See Power of Two Settings in Texture Editor</em>。<br>这是因为使用到的贴图的大小不是2的次幂。</p>
<p>解决办法：<br>在编辑器中打开Texture，将<code>Texture</code>-<code>Power Of Two Mode</code>改成<code>Pad to power of two</code>，这样会填充贴图为2次幂大小。</p>
<p><img data-src="index/UE4/IOS/texture-set-as-power-of-two-mode.webp"></p>
<p>如果不想要使用<code>Power Of Two Mode</code>也可以修改<code>Compression</code>-<code>Compression Settings</code>为<code>USerInterface2D</code>，但是非2次幂的贴图大小会有性能问题（在iPhone6(A7处理器)中只能设置为填充才可以）。<br><img data-src="index/UE4/IOS/texture-set-compression-as-userinterface.webp"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Content/Types/Textures/TextureCompressionSettings/index.html">Texture Compression Settings</a></li>
</ul>
<h2 id="ES2-0最多75根骨骼的限制"><a href="#ES2-0最多75根骨骼的限制" class="headerlink" title="ES2.0最多75根骨骼的限制"></a>ES2.0最多75根骨骼的限制</h2><p>因为移动平台缺少32位的索引支持，所以最多支持65k个顶点和75根骨骼。<br>但是可以通过拆分骨骼模型的材质来实现，每个材质支持75根，这是单次drawcall的限制，分成不同的批次就可以了。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Platforms/Mobile/Meshes/index.html">Meshes for Mobile Platforms</a></li>
<li><a target="_blank" rel="noopener" href="https://forums.unrealengine.com/development-discussion/rendering/43185-character-s-skeletal-mesh-disappears-under-mobile-html-5-preview-rendering-level">Character’s skeletal mesh disappears under Mobile/HTML 5 Preview Rendering Level</a></li>
</ul>
<blockquote>
<p>PS:不能用uniform了，换其他方式，比如VTF，也可以实现超过75根骨骼。</p>
</blockquote>
<p>在UE中如果在ES2.0中（目前UE的ES3.0也是75）想要更高的骨骼数量，需要拆分模型使用的材质：</p>
<blockquote>
<p>Warning: SkeletalMesh SK_m0146b0003, is not supported for current feature level (ES3_1) and will not be rendered. NumBones 78 (supported 75), NumBoneInfluences: 4</p>
</blockquote>
<p>材质和模型插槽的关系：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blender.stackexchange.com/questions/75816/how-to-distinguish-material-and-material-slot">How to distinguish material and material slot</a></li>
</ul>
<h2 id="使用HTTP请求下载文件的坑和技巧"><a href="#使用HTTP请求下载文件的坑和技巧" class="headerlink" title="使用HTTP请求下载文件的坑和技巧"></a>使用HTTP请求下载文件的坑和技巧</h2><p>使用HTTP可以请求下载文件，response的结果就是文件的内容。<br>在下载一个文件之前可以先使用<code>HEAD</code>请求来只获取头，可以从<code>Content-Length</code>头获取到文件的大小。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// head request</span></span><br><span class="line">TSharedRef&lt;IHttpRequest&gt; HttpHeadRequest = FHttpModule::Get().CreateRequest();</span><br><span class="line">HttpHeadRequest-&gt;OnHeaderReceived().BindUObject(<span class="keyword">this</span>, &amp;UDownloadProxy::OnRequestHeadHeaderReceived);</span><br><span class="line">HttpHeadRequest-&gt;OnProcessRequestComplete().BindUObject(<span class="keyword">this</span>, &amp;UDownloadProxy::OnRequestHeadComplete);</span><br><span class="line">HttpHeadRequest-&gt;SetURL(InternalDownloadFileInfo.URL);</span><br><span class="line">HttpHeadRequest-&gt;SetVerb(TEXT(<span class="string">&quot;HEAD&quot;</span>));</span><br><span class="line">HttpHeadRequest-&gt;ProcessRequest();</span><br></pre></td></tr></table></figure>
<p>在UE中需要通过监听HTTP请求的<code>OnHeaderReceived</code>派发来获得想要的头数据：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UDownloadProxy::OnRequestHeadHeaderReceived</span><span class="params">(FHttpRequestPtr RequestPtr, <span class="keyword">const</span> FString&amp; InHeaderName, <span class="keyword">const</span> FString&amp; InNewHeaderValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (InHeaderName.Equals(TEXT(<span class="string">&quot;Content-Length&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		InternalDownloadFileInfo.Size = UKismetStringLibrary::Conv_StringToInt(InNewHeaderValue);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后就可以用<code>Get</code>方法来请求文件了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get request</span></span><br><span class="line">TSharedRef&lt;IHttpRequest&gt; HttpRequest = FHttpModule::Get().CreateRequest();</span><br><span class="line">HttpRequest-&gt;OnRequestProgress().BindUObject(<span class="keyword">this</span>, &amp;UDownloadProxy::OnDownloadProcess, bIsSlice?EDownloadType::Slice:EDownloadType::Start);</span><br><span class="line">HttpRequest-&gt;OnProcessRequestComplete().BindUObject(<span class="keyword">this</span>, &amp;UDownloadProxy::OnDownloadComplete);</span><br><span class="line">HttpRequest-&gt;SetURL(InternalDownloadFileInfo.URL);</span><br><span class="line">HttpRequest-&gt;SetVerb(TEXT(<span class="string">&quot;GET&quot;</span>));</span><br><span class="line">RangeArgs = TEXT(<span class="string">&quot;bytes=0-&quot;</span>)+FString::FromInt(FileTotalByte);</span><br><span class="line">HttpRequest-&gt;SetHeader(TEXT(<span class="string">&quot;Range&quot;</span>), RangeArgs);</span><br><span class="line">HttpRequest-&gt;ProcessRequest();</span><br></pre></td></tr></table></figure>
<p>其中Range头的格式为：<code>Byte=0-</code>指请求整个文件的大小，<code>Byte=0-99</code>则是请求前100byte，<strong>注意请求的范围不要超过文件大小</strong>，不然会有400错误。<br>通过控制HTTP请求的<code>Range</code>头，我们可以指定下载文件的任意部分，可以实现暂停继续/分片下载。</p>
<blockquote>
<p>在UE中使用HTTP请求一个大文件的时候，如果该请求没有结束就去拿response的结果一定要注意一个问题：那就是Response的Content数据<code>Payload</code>是一个<code>TArray</code>动态数组，当Content的内容不断地被写入，会导致容器的<code>Reserve</code>也就是内存重新分配，获取该数组的内存地址是非常危险的。</p>
</blockquote>
<p>所以建议在HTTP请求时先对response的Content的<code>Payload</code>进行<code>Reserve</code>使其能够容纳足够数量的数据，缺点就是会一次性占用整个文件的内存。<br>解决内存占用的办法就是通过<code>Http</code>请求的<code>Range</code>来实现分片下载（也就是把一个大文件分成数个小块，一块一块地下载），从而降低内存占用，</p>
<p>当下载文件后，通常还有进行文件校验的操作，等文件下载完之后再执行校验（如MD5计算）时间会很长，所以要解决校验的时间问题，想过开一个线程去计算，但是开线程只解决了不阻塞主线程，不会加速MD5的计算过程，后来想到<code>MD5</code>是摘要计算，进而联想到可不可以边下边进行MD5计算，根据<strong>没有全新的轮子定理</strong>（我瞎掰的），我查到了OpenSSL中的MD5实现支持使用<code>MD5_Update</code>来增量计算，所以这个问题就迎刃而解了，具体看我前面的笔记<a href="https://imzlp.com/notes/ue/#MD5%E7%9A%84%E5%88%86%E7%89%87%E6%A0%A1%E9%AA%8C">MD5的分片校验</a>。</p>
<p>基于上面这些内容，可以实现一个简陋的下载器功能了，可作为游戏中的下载组件，虽然看似简单，但是设计一个合理的结构和没有bug的版本还是要花点功夫的。<br>我把上面介绍的内容写成了一个插件：<br><img data-src="index/UE4/ue4-download-proxy-plugin-ui.webp"></p>
<p>HTTP的分片请求在服务端的Log:<br><img data-src="index/UE4/use-http-request-download-file-server-info.webp"></p>
<p>资料文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Range_requests">从服务器端请求特定的范围</a></li>
</ul>
<h2 id="MD5的分片校验"><a href="#MD5的分片校验" class="headerlink" title="MD5的分片校验"></a>MD5的分片校验</h2><p>有一个需求：对下载的文件执行MD5运算。但是当文件比较大的时候如果等文件下载完再执行校验耗时会很长。</p>
<p>所以我想有没有办法边下边进行MD5的计算，因为知道MD5是基于摘要的，所以觉得边下边校验的方法应该可行。我查了一下相关的实现，找到<code>OpenSSL</code>中有相关的操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// openssl/md5.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEADER_MD5_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEADER_MD5_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/e_os2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>  __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OPENSSL_NO_MD5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> MD5 is disabled.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line"><span class="comment"> * ! MD5_LONG has to be at least 32 bits wide. If it&#x27;s wider, then !</span></span><br><span class="line"><span class="comment"> * ! MD5_LONG_LOG2 has to be defined along.			   !</span></span><br><span class="line"><span class="comment"> * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LP32__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG unsigned long</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(OPENSSL_SYS_CRAY) || defined(__ILP64__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG unsigned long</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG_LOG2 3</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * _CRAY note. I could declare short, but I have no idea what impact</span></span><br><span class="line"><span class="comment"> * does it have on performance on none-T3E machines. I could declare</span></span><br><span class="line"><span class="comment"> * int, but at least on C90 sizeof(int) can be chosen at compile time.</span></span><br><span class="line"><span class="comment"> * So I&#x27;ve chosen long...</span></span><br><span class="line"><span class="comment"> *					&lt;appro@fy.chalmers.se&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LONG unsigned int</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_CBLOCK	64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_LBLOCK	(MD5_CBLOCK/4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_DIGEST_LENGTH 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">MD5state_st</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">	MD5_LONG A,B,C,D;</span><br><span class="line">	MD5_LONG Nl,Nh;</span><br><span class="line">	MD5_LONG data[MD5_LBLOCK];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num;</span><br><span class="line">	&#125; MD5_CTX;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OPENSSL_FIPS</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">private_MD5_Init</span><span class="params">(MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Init</span><span class="params">(MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Update</span><span class="params">(MD5_CTX *c, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Final</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *md, MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">MD5</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *d, <span class="keyword">size_t</span> n, <span class="keyword">unsigned</span> <span class="keyword">char</span> *md)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5_Transform</span><span class="params">(MD5_CTX *c, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *b)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>  __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>其中提供的MD5计算可以分开操作的有三个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Init</span><span class="params">(MD5_CTX *c)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Update</span><span class="params">(MD5_CTX *c, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Final</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *md, MD5_CTX *c)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中的<code>MD5_Update</code>就是我们需要的函数。</p>
<p>所以使用的伪代码为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MD5_CTX Md5CTX;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Request</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MD5_Init(&amp;Md5CTX);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TickRequestProgress</span><span class="params">(<span class="keyword">char</span>* InData,uint32 InLength)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MD5_Update(&amp;Md5CTX,InData,InLength);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RequestCompleted</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[<span class="number">16</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	MD5_Final(digest, &amp;Md5CTX);</span><br><span class="line">	<span class="keyword">char</span> md5string[<span class="number">33</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i)</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">sprintf</span>(&amp;md5string[i * <span class="number">2</span>], <span class="string">&quot;%02x&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)digest[i]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// result</span></span><br><span class="line">    pritf(<span class="string">&quot;MD5:%s&quot;</span>,md5string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样当文件下载完，MD5计算就完成了。</p>
<blockquote>
<p>注：在UE4中(~4.24)提供的OpenSSL在Win下只支持到VS2015，可以自己把这个限制给去掉(VS2015的链接库在VS2017中使用也没有问题)。</p>
</blockquote>
<h2 id="PlatformMisc的跨平台实现"><a href="#PlatformMisc的跨平台实现" class="headerlink" title="PlatformMisc的跨平台实现"></a>PlatformMisc的跨平台实现</h2><p>当我们使用<code>FPaths::ProjectDir()</code>的是否考虑过它是怎么实现在不同的平台上为不同的路径的呢？<br>首先看一下<code>FPaths::ProjectDir()</code>的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Private/Misc/Paths.cpp</span></span><br><span class="line"><span class="function">FString <span class="title">FPaths::ProjectDir</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> FString(FPlatformMisc::ProjectDir());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到它是<code>FPlatformMisc</code>的一层转发，继续深入代码去找<code>FPlatformMisc::ProjectDir</code>的实现，如果用VS的<code>Go to definition</code>可以看到一堆的文件里都有<code>FPlatformMisc</code>的定义：<br><img data-src="index/UE4/ue-FPlatformMisc-typedef.webp"></p>
<p><code>FPlatformMisc</code>只是一个类型定义(typedef)，通过平台宏来判断，当编译为不同的平台是会把<code>FPlatformMisc</code>通过<code>typedef</code>为目标平台的类。<br>进行平台判断的代码在<code>Runtime/Core/Public/HAL/PlatformMisc.h</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Public/HAL/PlatformMisc.h</span></span><br><span class="line"><span class="comment">// Copyright 1998-2019 Epic Games, Inc. All Rights Reserved.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreTypes.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;GenericPlatform/GenericPlatformMisc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Windows/WindowsPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_PS4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;PS4/PS4Misc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_XBOXONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;XboxOne/XboxOneMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_MAC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Mac/MacPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_IOS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IOS/IOSPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_LUMIN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Lumin/LuminPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_ANDROID</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Android/AndroidMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_HTML5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HTML5/HTML5PlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_QUAIL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Quail/QuailPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_LINUX</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Linux/LinuxPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> PLATFORM_SWITCH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Switch/SwitchPlatformMisc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>其中的每一个平台的<code>*PlatformMisc.h</code>文件中都有<code>FPlatformMisc</code>的类型定义（<code>typedef</code>），各个平台代码文件都是存放在<code>Runtime/Core/Public</code>下，每个平台有自己的目录。<br>而且，所有的<code>*PlatformMisc</code>类都继承自一个<code>FGenericPlatformMisc</code>的类，作为通用平台的接口，如<code>WindowsPlatformMisc</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Windows implementation of the misc OS functions</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CORE_API</span> <span class="title">FWindowsPlatformMisc</span></span></span><br><span class="line"><span class="class">	:</span> <span class="keyword">public</span> FGenericPlatformMisc&#123;<span class="comment">/*.....*/</span>&#125;</span><br></pre></td></tr></table></figure>
<p><code>FGenericPlatformMisc</code>中声明了我们常用的<code>ProjectDir</code>函数，供各个平台来独立实现，这样在通过<code>FPlatformMisc</code>来调用的时候就是所编译的目标平台的实现，这是UE实现跨平台代码的思路。</p>
<h2 id="为APK添加外部存储独写权限"><a href="#为APK添加外部存储独写权限" class="headerlink" title="为APK添加外部存储独写权限"></a>为APK添加外部存储独写权限</h2><p>在<code>Project Settings</code>-<code>Platform</code>-<code>Android</code>-<code>Advanced APK Packaging</code>-<code>Extra Permissions</code>下添加：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android.permission.WRITE EXTERNAL STORAGE</span><br><span class="line">android.permission.READ_EXTERNAL_STORAGE</span><br></pre></td></tr></table></figure>

<p><img data-src="index/UE4/ue4-android-add-extra-permissions.webp"></p>
<h2 id="Android写入文件"><a href="#Android写入文件" class="headerlink" title="Android写入文件"></a>Android写入文件</h2><p>当调用<code>FFileHelper::SaveArrayToFile</code>时：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FFileHelper::SaveArrayToFile(TArrayView&lt;<span class="keyword">const</span> uint8&gt;(data, delta), *path, &amp;IFileManager::Get(), EFileWrite::FILEWRITE_Append));</span><br></pre></td></tr></table></figure>

<p>在该函数内部会创建一个<code>FArchive</code>的对象来管理当前文件，其内部具有一个<code>IFileHandle</code>的对象<code>Handle</code>，在Android平台上是<code>FFileHandleAndroid</code>。</p>
<p>在<code>FArchive</code>中写入文件调用的是<code>Serialize</code>，它又会调用<code>Handle</code>的<code>Write</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FArchiveFileWriterGeneric::WriteLowLevel</span><span class="params">( <span class="keyword">const</span> uint8* Src, int64 CountToWrite )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Handle-&gt;Write( Src, CountToWrite );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Android的Write的实现为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Private/Android/AndroidFile.h</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Write</span><span class="params">(<span class="keyword">const</span> uint8* Source, int64 BytesToWrite)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CheckValid();</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">nullptr</span> != File-&gt;Asset)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Can&#x27;t write to assets.</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> bSuccess = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">while</span> (BytesToWrite)</span><br><span class="line">	&#123;</span><br><span class="line">		check(BytesToWrite &gt;= <span class="number">0</span>);</span><br><span class="line">		int64 ThisSize = FMath::Min&lt;int64&gt;(READWRITE_SIZE, BytesToWrite);</span><br><span class="line">		check(Source);</span><br><span class="line">		<span class="keyword">if</span> (__pwrite(File-&gt;Handle, Source, ThisSize, CurrentOffset) != ThisSize)</span><br><span class="line">		&#123;</span><br><span class="line">			bSuccess = <span class="literal">false</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		CurrentOffset += ThisSize;</span><br><span class="line">		Source += ThisSize;</span><br><span class="line">		BytesToWrite -= ThisSize;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update the cached file length</span></span><br><span class="line">	Length = FMath::Max(Length, CurrentOffset);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到是每次1M往文件里存的。</p>
<h2 id="Android写入文件错误码对照"><a href="#Android写入文件错误码对照" class="headerlink" title="Android写入文件错误码对照"></a>Android写入文件错误码对照</h2><ul>
<li><a target="_blank" rel="noopener" href="http://androidxref.com/8.0.0_r4/xref/bionic/libc/bionic/strerror.cpp#35">http://androidxref.com/8.0.0_r4/xref/bionic/libc/bionic/strerror.cpp#35</a></li>
</ul>
<p>根据 error code number 查找 error string.</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://androidxref.com/8.0.0_r4/xref/bionic/libc/bionic/strerror_r.cpp#_sys_error_strings">http://androidxref.com/8.0.0_r4/xref/bionic/libc/bionic/strerror_r.cpp#_sys_error_strings</a></li>
<li><a target="_blank" rel="noopener" href="http://androidxref.com/8.0.0_r4/xref/bionic/libc/private/bionic_errdefs.h">http://androidxref.com/8.0.0_r4/xref/bionic/libc/private/bionic_errdefs.h</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic_errdefs.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __BIONIC_ERRDEF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">&quot;__BIONIC_ERRDEF must be defined before including this file&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">__BIONIC_ERRDEF( <span class="number">0</span>              ,   <span class="number">0</span>, <span class="string">&quot;Success&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EPERM          ,   <span class="number">1</span>, <span class="string">&quot;Operation not permitted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOENT         ,   <span class="number">2</span>, <span class="string">&quot;No such file or directory&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ESRCH          ,   <span class="number">3</span>, <span class="string">&quot;No such process&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EINTR          ,   <span class="number">4</span>, <span class="string">&quot;Interrupted system call&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EIO            ,   <span class="number">5</span>, <span class="string">&quot;I/O error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENXIO          ,   <span class="number">6</span>, <span class="string">&quot;No such device or address&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( E2BIG          ,   <span class="number">7</span>, <span class="string">&quot;Argument list too long&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOEXEC        ,   <span class="number">8</span>, <span class="string">&quot;Exec format error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EBADF          ,   <span class="number">9</span>, <span class="string">&quot;Bad file descriptor&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ECHILD         ,  <span class="number">10</span>, <span class="string">&quot;No child processes&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EAGAIN         ,  <span class="number">11</span>, <span class="string">&quot;Try again&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOMEM         ,  <span class="number">12</span>, <span class="string">&quot;Out of memory&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EACCES         ,  <span class="number">13</span>, <span class="string">&quot;Permission denied&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EFAULT         ,  <span class="number">14</span>, <span class="string">&quot;Bad address&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOTBLK        ,  <span class="number">15</span>, <span class="string">&quot;Block device required&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EBUSY          ,  <span class="number">16</span>, <span class="string">&quot;Device or resource busy&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EEXIST         ,  <span class="number">17</span>, <span class="string">&quot;File exists&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EXDEV          ,  <span class="number">18</span>, <span class="string">&quot;Cross-device link&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENODEV         ,  <span class="number">19</span>, <span class="string">&quot;No such device&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOTDIR        ,  <span class="number">20</span>, <span class="string">&quot;Not a directory&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EISDIR         ,  <span class="number">21</span>, <span class="string">&quot;Is a directory&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EINVAL         ,  <span class="number">22</span>, <span class="string">&quot;Invalid argument&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENFILE         ,  <span class="number">23</span>, <span class="string">&quot;File table overflow&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EMFILE         ,  <span class="number">24</span>, <span class="string">&quot;Too many open files&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOTTY         ,  <span class="number">25</span>, <span class="string">&quot;Not a typewriter&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ETXTBSY        ,  <span class="number">26</span>, <span class="string">&quot;Text file busy&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EFBIG          ,  <span class="number">27</span>, <span class="string">&quot;File too large&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOSPC         ,  <span class="number">28</span>, <span class="string">&quot;No space left on device&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ESPIPE         ,  <span class="number">29</span>, <span class="string">&quot;Illegal seek&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EROFS          ,  <span class="number">30</span>, <span class="string">&quot;Read-only file system&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EMLINK         ,  <span class="number">31</span>, <span class="string">&quot;Too many links&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EPIPE          ,  <span class="number">32</span>, <span class="string">&quot;Broken pipe&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EDOM           ,  <span class="number">33</span>, <span class="string">&quot;Math argument out of domain of func&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ERANGE         ,  <span class="number">34</span>, <span class="string">&quot;Math result not representable&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EDEADLK        ,  <span class="number">35</span>, <span class="string">&quot;Resource deadlock would occur&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENAMETOOLONG   ,  <span class="number">36</span>, <span class="string">&quot;File name too long&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOLCK         ,  <span class="number">37</span>, <span class="string">&quot;No record locks available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOSYS         ,  <span class="number">38</span>, <span class="string">&quot;Function not implemented&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOTEMPTY      ,  <span class="number">39</span>, <span class="string">&quot;Directory not empty&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ELOOP          ,  <span class="number">40</span>, <span class="string">&quot;Too many symbolic links encountered&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOMSG         ,  <span class="number">42</span>, <span class="string">&quot;No message of desired type&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EIDRM          ,  <span class="number">43</span>, <span class="string">&quot;Identifier removed&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ECHRNG         ,  <span class="number">44</span>, <span class="string">&quot;Channel number out of range&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EL2NSYNC       ,  <span class="number">45</span>, <span class="string">&quot;Level 2 not synchronized&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EL3HLT         ,  <span class="number">46</span>, <span class="string">&quot;Level 3 halted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EL3RST         ,  <span class="number">47</span>, <span class="string">&quot;Level 3 reset&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ELNRNG         ,  <span class="number">48</span>, <span class="string">&quot;Link number out of range&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EUNATCH        ,  <span class="number">49</span>, <span class="string">&quot;Protocol driver not attached&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOCSI         ,  <span class="number">50</span>, <span class="string">&quot;No CSI structure available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EL2HLT         ,  <span class="number">51</span>, <span class="string">&quot;Level 2 halted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EBADE          ,  <span class="number">52</span>, <span class="string">&quot;Invalid exchange&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EBADR          ,  <span class="number">53</span>, <span class="string">&quot;Invalid request descriptor&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EXFULL         ,  <span class="number">54</span>, <span class="string">&quot;Exchange full&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOANO         ,  <span class="number">55</span>, <span class="string">&quot;No anode&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EBADRQC        ,  <span class="number">56</span>, <span class="string">&quot;Invalid request code&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EBADSLT        ,  <span class="number">57</span>, <span class="string">&quot;Invalid slot&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EBFONT         ,  <span class="number">59</span>, <span class="string">&quot;Bad font file format&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOSTR         ,  <span class="number">60</span>, <span class="string">&quot;Device not a stream&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENODATA        ,  <span class="number">61</span>, <span class="string">&quot;No data available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ETIME          ,  <span class="number">62</span>, <span class="string">&quot;Timer expired&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOSR          ,  <span class="number">63</span>, <span class="string">&quot;Out of streams resources&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENONET         ,  <span class="number">64</span>, <span class="string">&quot;Machine is not on the network&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOPKG         ,  <span class="number">65</span>, <span class="string">&quot;Package not installed&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EREMOTE        ,  <span class="number">66</span>, <span class="string">&quot;Object is remote&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOLINK        ,  <span class="number">67</span>, <span class="string">&quot;Link has been severed&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EADV           ,  <span class="number">68</span>, <span class="string">&quot;Advertise error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ESRMNT         ,  <span class="number">69</span>, <span class="string">&quot;Srmount error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ECOMM          ,  <span class="number">70</span>, <span class="string">&quot;Communication error on send&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EPROTO         ,  <span class="number">71</span>, <span class="string">&quot;Protocol error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EMULTIHOP      ,  <span class="number">72</span>, <span class="string">&quot;Multihop attempted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EDOTDOT        ,  <span class="number">73</span>, <span class="string">&quot;RFS specific error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EBADMSG        ,  <span class="number">74</span>, <span class="string">&quot;Not a data message&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EOVERFLOW      ,  <span class="number">75</span>, <span class="string">&quot;Value too large for defined data type&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOTUNIQ       ,  <span class="number">76</span>, <span class="string">&quot;Name not unique on network&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EBADFD         ,  <span class="number">77</span>, <span class="string">&quot;File descriptor in bad state&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EREMCHG        ,  <span class="number">78</span>, <span class="string">&quot;Remote address changed&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ELIBACC        ,  <span class="number">79</span>, <span class="string">&quot;Can not access a needed shared library&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ELIBBAD        ,  <span class="number">80</span>, <span class="string">&quot;Accessing a corrupted shared library&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ELIBSCN        ,  <span class="number">81</span>, <span class="string">&quot;.lib section in a.out corrupted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ELIBMAX        ,  <span class="number">82</span>, <span class="string">&quot;Attempting to link in too many shared libraries&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ELIBEXEC       ,  <span class="number">83</span>, <span class="string">&quot;Cannot exec a shared library directly&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EILSEQ         ,  <span class="number">84</span>, <span class="string">&quot;Illegal byte sequence&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ERESTART       ,  <span class="number">85</span>, <span class="string">&quot;Interrupted system call should be restarted&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ESTRPIPE       ,  <span class="number">86</span>, <span class="string">&quot;Streams pipe error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EUSERS         ,  <span class="number">87</span>, <span class="string">&quot;Too many users&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOTSOCK       ,  <span class="number">88</span>, <span class="string">&quot;Socket operation on non-socket&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EDESTADDRREQ   ,  <span class="number">89</span>, <span class="string">&quot;Destination address required&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EMSGSIZE       ,  <span class="number">90</span>, <span class="string">&quot;Message too long&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EPROTOTYPE     ,  <span class="number">91</span>, <span class="string">&quot;Protocol wrong type for socket&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOPROTOOPT    ,  <span class="number">92</span>, <span class="string">&quot;Protocol not available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EPROTONOSUPPORT,  <span class="number">93</span>, <span class="string">&quot;Protocol not supported&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ESOCKTNOSUPPORT,  <span class="number">94</span>, <span class="string">&quot;Socket type not supported&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EOPNOTSUPP     ,  <span class="number">95</span>, <span class="string">&quot;Operation not supported on transport endpoint&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EPFNOSUPPORT   ,  <span class="number">96</span>, <span class="string">&quot;Protocol family not supported&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EAFNOSUPPORT   ,  <span class="number">97</span>, <span class="string">&quot;Address family not supported by protocol&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EADDRINUSE     ,  <span class="number">98</span>, <span class="string">&quot;Address already in use&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EADDRNOTAVAIL  ,  <span class="number">99</span>, <span class="string">&quot;Cannot assign requested address&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENETDOWN       , <span class="number">100</span>, <span class="string">&quot;Network is down&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENETUNREACH    , <span class="number">101</span>, <span class="string">&quot;Network is unreachable&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENETRESET      , <span class="number">102</span>, <span class="string">&quot;Network dropped connection because of reset&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ECONNABORTED   , <span class="number">103</span>, <span class="string">&quot;Software caused connection abort&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ECONNRESET     , <span class="number">104</span>, <span class="string">&quot;Connection reset by peer&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOBUFS        , <span class="number">105</span>, <span class="string">&quot;No buffer space available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EISCONN        , <span class="number">106</span>, <span class="string">&quot;Transport endpoint is already connected&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOTCONN       , <span class="number">107</span>, <span class="string">&quot;Transport endpoint is not connected&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ESHUTDOWN      , <span class="number">108</span>, <span class="string">&quot;Cannot send after transport endpoint shutdown&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ETOOMANYREFS   , <span class="number">109</span>, <span class="string">&quot;Too many references: cannot splice&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ETIMEDOUT      , <span class="number">110</span>, <span class="string">&quot;Connection timed out&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ECONNREFUSED   , <span class="number">111</span>, <span class="string">&quot;Connection refused&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EHOSTDOWN      , <span class="number">112</span>, <span class="string">&quot;Host is down&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EHOSTUNREACH   , <span class="number">113</span>, <span class="string">&quot;No route to host&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EALREADY       , <span class="number">114</span>, <span class="string">&quot;Operation already in progress&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EINPROGRESS    , <span class="number">115</span>, <span class="string">&quot;Operation now in progress&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ESTALE         , <span class="number">116</span>, <span class="string">&quot;Stale NFS file handle&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EUCLEAN        , <span class="number">117</span>, <span class="string">&quot;Structure needs cleaning&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOTNAM        , <span class="number">118</span>, <span class="string">&quot;Not a XENIX named type file&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENAVAIL        , <span class="number">119</span>, <span class="string">&quot;No XENIX semaphores available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EISNAM         , <span class="number">120</span>, <span class="string">&quot;Is a named type file&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EREMOTEIO      , <span class="number">121</span>, <span class="string">&quot;Remote I/O error&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EDQUOT         , <span class="number">122</span>, <span class="string">&quot;Quota exceeded&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOMEDIUM      , <span class="number">123</span>, <span class="string">&quot;No medium found&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EMEDIUMTYPE    , <span class="number">124</span>, <span class="string">&quot;Wrong medium type&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ECANCELED      , <span class="number">125</span>, <span class="string">&quot;Operation Canceled&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOKEY         , <span class="number">126</span>, <span class="string">&quot;Required key not available&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EKEYEXPIRED    , <span class="number">127</span>, <span class="string">&quot;Key has expired&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EKEYREVOKED    , <span class="number">128</span>, <span class="string">&quot;Key has been revoked&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EKEYREJECTED   , <span class="number">129</span>, <span class="string">&quot;Key was rejected by service&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( EOWNERDEAD     , <span class="number">130</span>, <span class="string">&quot;Owner died&quot;</span> )</span><br><span class="line">__BIONIC_ERRDEF( ENOTRECOVERABLE, <span class="number">131</span>, <span class="string">&quot;State not recoverable&quot;</span> )</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> __BIONIC_ERRDEF</span></span><br></pre></td></tr></table></figure>


<h2 id="Lua-从内存加载module"><a href="#Lua-从内存加载module" class="headerlink" title="Lua:从内存加载module"></a>Lua:从内存加载module</h2><p>从内存执行：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FLuaPanda::OpenLuaPanda</span><span class="params">(lua_State* L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  luaL_dostring(L, (<span class="keyword">const</span> <span class="keyword">char</span>*)LuaPanda_lua_data);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>添加到PRELOAD中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">luaL_getsubtable(L, LUA_REGISTRYINDEX, LUA_PRELOAD_TABLE);</span><br><span class="line">lua_pushcfunction(L, &amp;FLuaPanda::OpenLuaPanda);</span><br><span class="line">lua_setfield(L, <span class="number">-2</span>, <span class="string">&quot;LuaPanda&quot;</span>);</span><br><span class="line">lua_pop(L, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>直接添加到LOADED中:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">luaL_requiref(L, <span class="string">&quot;LuaPanda&quot;</span>, &amp;FLuaPanda::OpenLuaPanda,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h2 id="gituhb快捷代码搜索"><a href="#gituhb快捷代码搜索" class="headerlink" title="gituhb快捷代码搜索"></a>gituhb快捷代码搜索</h2><p>可以把ue的官方仓库的搜索创建为Chrome的自定义搜索引擎：<br><img data-src="index/UE4/search-ue-source-in-github.webp"></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/EpicGames/UnrealEngine/search?q=%s&amp;unscoped_q=%s</span><br></pre></td></tr></table></figure>
<p>这样在chrome的地址栏就可以通过<code>uesource</code>来触发搜索。</p>
<h2 id="控制写入文件FLAG"><a href="#控制写入文件FLAG" class="headerlink" title="控制写入文件FLAG"></a>控制写入文件FLAG</h2><p><code>FFileHelper::SaveStringToFile</code>的最后一个参数可以传入一个Flag，用来控制文件的写入规则：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> SaveStringToFile</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">const</span> FString &amp; String,</span><br><span class="line">    <span class="keyword">const</span> TCHAR * Filename,</span><br><span class="line">    EEncodingOptions EncodingOptions,</span><br><span class="line">    IFileManager * FileManager,</span><br><span class="line">    uint32 WriteFlags</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>其<code>WriteFlags</code>可用值为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">enum EFileWrite</span><br><span class="line">&#123;</span><br><span class="line">	FILEWRITE_None				= 0x00,</span><br><span class="line">	FILEWRITE_NoFail            = 0x01,</span><br><span class="line">	FILEWRITE_NoReplaceExisting = 0x02,</span><br><span class="line">	FILEWRITE_EvenIfReadOnly    = 0x04,</span><br><span class="line">	FILEWRITE_Append			= 0x08,</span><br><span class="line">	FILEWRITE_AllowRead			= 0x10,</span><br><span class="line">	FILEWRITE_Silent			= 0x20</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>它们被定义在<a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/7d9919ac7bfd80b7483012eab342cb427d60e8c9/Engine/Source/Runtime/Core/Public/HAL/FileManager.h">Engine/Source/Runtime/Core/Public/HAL/FileManager.h</a>，因为它们的值是支持位运算的，所以它们的使用方法为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;FileHelper.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Paths.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">FString FilePath = FPaths::ConvertRelativePathToFull(FPaths::GameSavedDir()) + TEXT(<span class="string">&quot;/MessageLog.txt&quot;</span>);</span><br><span class="line">FString FileContent = TEXT(<span class="string">&quot;This is a line of text to put in the file.\n&quot;</span>);</span><br><span class="line">FFileHelper::SaveStringToFile(FileContent, *FilePath, FFileHelper::EEncodingOptions::AutoDetect, &amp;IFileManager::Get(), EFileWrite::FILEWRITE_Append | EFileWrite::FILEWRITE_AllowRead | EFileWrite::FILEWRITE_EvenIfReadOnly);</span><br></pre></td></tr></table></figure>

<h2 id="Assertion-failed-Class-gt-Children-0"><a href="#Assertion-failed-Class-gt-Children-0" class="headerlink" title="Assertion failed: Class-&gt;Children == 0"></a>Assertion failed: Class-&gt;Children == 0</h2><p>这是UBT里产生的错误，原因是项目内有两个同名的类。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1&gt;  Running UnrealHeaderTool &quot;C:\Users\Administrator\Documents\Unreal Projects\GWorldSlg\GWorld.uproject&quot; &quot;C:\Users\Administrator\Documents\Unreal Projects\GWorldSlg\Intermediate\Build\Win64\GWorldEditor\Development\GWorldEditor.uhtmanifest&quot; -LogCmds=&quot;loginit warning, logexit warning, logdatabase error&quot; -Unattended -WarningsAsErrors -installed</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error: === Critical error: ===</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error:</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error: Assertion failed: Class-&gt;Children == 0 [File:D:\Build\++UE4\Sync\Engine\Source\Programs\UnrealHeaderTool\Private\HeaderParser.cpp] [Line: 5758]</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error:</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error:</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error:</span><br><span class="line">1&gt;C:/Users/Administrator/Documents/Unreal Projects/GWorldSlg/Source/GWorld/Public/Modules/CoreEntity/Instance/TouchControlledPawnTrace.h(20) : LogWindows: Error:</span><br></pre></td></tr></table></figure>

<h2 id="打包时添加外部文件"><a href="#打包时添加外部文件" class="headerlink" title="打包时添加外部文件"></a>打包时添加外部文件</h2><p>在<code>Project Settings</code>-<code>Project</code>-<code>Packaging</code>-<code>Addtional Non-Asset Directories to Package</code>：<br><img data-src="index/UE4/project-settings-add-non-asset-to-package.webp"></p>
<blockquote>
<p>注意：添加的目录必须要位于项目的Content下。</p>
</blockquote>
<p>如<code>Mobile422/Content/Script/</code>目录下的文件，在pak中的mount point为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LogPakFile: Display: &quot;Mobile422/Content/Script/.vscode/launch.json&quot; offset: 80875520, size: 1173 bytes, sha1: 47DE6617E94EE86597148CCD53FC76E1E1A3EE22, compression: None.</span><br><span class="line">LogPakFile: Display: &quot;Mobile422/Content/Script/Cube_Blueprint_C.lua&quot; offset: 80877568, size: 888 bytes, sha1: 00F529AE4206E38D322E2983478AFBC2999A036E, compression: None.</span><br><span class="line">LogPakFile: Display: &quot;Mobile422/Content/Script/UnLua.lua&quot; offset: 80879616, size: 1977 bytes, sha1: 4015051A6663684CA3FBE1D60003CA62CD27A8AD, compression: None.</span><br><span class="line">LogPakFile: Display: &quot;Mobile422/Content/Script/UnLuaPerformanceTestProxy.lua&quot; offset: 80881664, size: 6087 bytes, sha1: 6662D86BEF54610414C00E43CF2C0F514DDF7434, compression: None.</span><br></pre></td></tr></table></figure>

<h2 id="C-关键字绝对不要作为变量名"><a href="#C-关键字绝对不要作为变量名" class="headerlink" title="C++关键字绝对不要作为变量名"></a>C++关键字绝对不要作为变量名</h2><p>集成了一个库，其中有下列代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLOCKSIZE 64</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span></span><br><span class="line">xor_key(<span class="keyword">uint8_t</span> key[BLOCKSIZE], <span class="keyword">uint32_t</span> <span class="keyword">xor</span>) &#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;BLOCKSIZE;i+=<span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>)) &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> * k = (<span class="keyword">uint32_t</span> *)&amp;key[i];</span><br><span class="line">		*k ^= <span class="keyword">xor</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译时候发现有这样的报错：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">inlineblock.cpp:<span class="number">9</span>:<span class="number">42</span>: error: blocks support disabled - compile with -fblocks <span class="keyword">or</span> pick a deployment target that supports them</span><br><span class="line">xor_key(<span class="keyword">uint8_t</span> key[BLOCKSIZE], <span class="keyword">uint32_t</span> <span class="keyword">xor</span>) &#123;</span><br><span class="line">                                         ^</span><br><span class="line">inlineblock.cpp:<span class="number">9</span>:<span class="number">45</span>: error: block pointer to non-function type is invalid</span><br><span class="line">xor_key(<span class="keyword">uint8_t</span> key[BLOCKSIZE], <span class="keyword">uint32_t</span> <span class="keyword">xor</span>) &#123;</span><br><span class="line">                                            ^</span><br><span class="line">inlineblock.cpp:<span class="number">13</span>:<span class="number">12</span>: error: type name <span class="keyword">requires</span> a specifier <span class="keyword">or</span> qualifier</span><br><span class="line">                *k ^= <span class="keyword">xor</span>;</span><br><span class="line">                         ^</span><br><span class="line">inlineblock.cpp:<span class="number">13</span>:<span class="number">12</span>: error: expected expression</span><br><span class="line"><span class="number">4</span> errors generated.</span><br></pre></td></tr></table></figure>
<p>这个错误的原因就是函数参数<code>xor</code>是<code>^</code>的<strong>关键字</strong>。</p>
<h2 id="Android-NDK"><a href="#Android-NDK" class="headerlink" title="Android NDK"></a>Android NDK</h2><p>UE4支持<code>r14b</code>-<code>r18b</code>的Android NDK，但是我在UE4.22.3中设置<code>r18b</code>被引擎识别为<code>r18c</code>:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">UATHelper: Packaging (Android (ETC2)):   Using &#x27;git status&#x27; to determine working set for adaptive non-unity build (C:\Users\imzlp\Documents\Unreal Projects\GWorldClient).</span><br><span class="line">UATHelper: Packaging (Android (ETC2)):   ERROR: Android toolchain NDK r18c not supported; please use NDK r14b to NDK r18b (NDK r14b recommended)</span><br><span class="line">PackagingResults: Error: Android toolchain NDK r18c not supported; please use NDK r14b to NDK r18b (NDK r14b recommended)</span><br><span class="line">UATHelper: Packaging (Android (ETC2)): Took 7.4575476s to run UnrealBuildTool.exe, ExitCode=5</span><br><span class="line">UATHelper: Packaging (Android (ETC2)): ERROR: UnrealBuildTool failed. See log for more details. (C:\Users\imzlp\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.22\UBT-GWorld-Android-Development.txt)</span><br><span class="line">UATHelper: Packaging (Android (ETC2)):        (see C:\Users\imzlp\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.22\Log.txt for full exception trace)</span><br><span class="line">PackagingResults: Error: UnrealBuildTool failed. See log for more details. (C:\Users\imzlp\AppData\Roaming\Unreal Engine\AutomationTool\Logs\C+Program+Files+Epic+Games+UE_4.22\UBT-GWorld-Android-Development.txt)</span><br><span class="line">UATHelper: Packaging (Android (ETC2)): AutomationTool exiting with ExitCode=5 (5)</span><br><span class="line">UATHelper: Packaging (Android (ETC2)): BUILD FAILED</span><br><span class="line">PackagingResults: Error: Unknown Error</span><br></pre></td></tr></table></figure>
<p>之所以要换NDK的版本是因为不同的NDK版本所包含的编译器对C++11标准支持度不同。</p>
<table>
<thead>
<tr>
<th>NDK</th>
<th>clang version</th>
</tr>
</thead>
<tbody><tr>
<td>r14b</td>
<td>clang 3.8.275480  (based on LLVM 3.8.275480)</td>
</tr>
<tr>
<td>r17c</td>
<td>clang version 6.0.2</td>
</tr>
<tr>
<td>r18b</td>
<td>clang version 7.0.2</td>
</tr>
<tr>
<td>r20b</td>
<td>clang version 8.0.7</td>
</tr>
</tbody></table>
<h2 id="将BindAction暴露给蓝图"><a href="#将BindAction暴露给蓝图" class="headerlink" title="将BindAction暴露给蓝图"></a>将BindAction暴露给蓝图</h2><p><code>UInputComponent</code>函数中的<code>BindAction</code>是个模板函数，可以在代码中使用，但是在蓝图中就很不方便了。</p>
<p>本来想着直接裹一个函数库的实现将BindAction暴露给蓝图，但是在BindAction需要传入的函数代理那里在蓝图里传递很不方便，看了一下BindAction的代码，写了下面这个函数，可以通过传递函数名来绑定：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line">UCLASS()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWORLD_API</span> <span class="title">UFlibInputEventHelper</span> :</span> <span class="keyword">public</span> UBlueprintFunctionLibrary</span><br><span class="line">&#123;</span><br><span class="line">	GENERATED_BODY()</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	UFUNCTION(BlueprintCallable,Category = <span class="string">&quot;GWorld|FLib|InputHelper&quot;</span>,meta=(AutoCreateRefTerm=<span class="string">&quot;InActionName,InFuncName&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BindInputAction</span><span class="params">(UInputComponent* InInputComp, <span class="keyword">const</span> FName&amp; InActionName, EInputEvent InKeyEvent, UObject* InCallObject, <span class="keyword">const</span> FName&amp; InFuncName)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// .cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibInputEventHelper::BindInputAction</span><span class="params">(UInputComponent* InInputComp, <span class="keyword">const</span> FName&amp; InActionName, EInputEvent InKeyEvent, UObject* InCallObject, <span class="keyword">const</span> FName&amp; InFuncName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">FInputActionBinding <span class="title">AB</span><span class="params">(InActionName, InKeyEvent)</span></span>;</span><br><span class="line">	AB.ActionDelegate.BindDelegate(InCallObject, InFuncName);</span><br><span class="line">	InInputComp-&gt;AddActionBinding(MoveTemp(AB));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="APK包中OBB文件"><a href="#APK包中OBB文件" class="headerlink" title="APK包中OBB文件"></a>APK包中OBB文件</h2><p>在选择把data文件打包APK之后，把打包出的APK解包，是可以看到obb文件的，在<code>assets</code>文件夹下有<code>main.obb.webp</code>，其就是<code>Saved/StagedBuilds/</code>目录下的<code>PROJECT_NAME.obb</code>文件，HASH值都是一样的。</p>
<p><img data-src="index/UE4/obb-file-hash-diff.webp"></p>
<p>其实OBB文件中存储的就是我们的pak文件以及在项目设置中添加的启动视频的mp4文件，使用7z之类的压缩软件可以打开未加密的obb查看，可以看到它的目录结构就是<code>PROJECT_NAME/Content/Paks/PROJECTNAME-Android_ETC2.pak</code>这样的形式。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">\---FGame</span><br><span class="line">    \---Content</span><br><span class="line">        +---Movies</span><br><span class="line">        |       logo.mp4</span><br><span class="line">        |       SparkMore.mp4</span><br><span class="line">        |</span><br><span class="line">        \---Paks</span><br><span class="line">                pakchunk0-Android_ASTC.pak</span><br><span class="line">                pakchunk1-Android_ASTC.pak</span><br><span class="line">                pakchunk2-Android_ASTC.pak</span><br></pre></td></tr></table></figure>

<h2 id="移动端的启动参数"><a href="#移动端的启动参数" class="headerlink" title="移动端的启动参数"></a>移动端的启动参数</h2><p>UE4打出来的包可以使用<code>XXXX.exe -Params</code>等方式来传递给游戏参数，但是移动平台(IOS/Android)打包出来的怎么传递参数呢？</p>
<h3 id="Android启动参数"><a href="#Android启动参数" class="headerlink" title="Android启动参数"></a>Android启动参数</h3><p>看了一下引擎里的代码，在<code>Launch</code>模块下<code>Launch\Private\Android\LaunchAndroid.cpp</code>中有<code>InitCommandLine</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Launch\Private\Android\LaunchAndroid.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitCommandLine</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> uint32 CMD_LINE_MAX = <span class="number">16384u</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initialize the command line to an empty string</span></span><br><span class="line">  FCommandLine::Set(TEXT(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">  AAssetManager* AssetMgr = AndroidThunkCpp_GetAssetManager();</span><br><span class="line">  AAsset* asset = AAssetManager_open(AssetMgr, TCHAR_TO_UTF8(TEXT(<span class="string">&quot;UE4CommandLine.txt&quot;</span>)), AASSET_MODE_BUFFER);</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nullptr</span> != asset)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span>* FileContents = AAsset_getBuffer(asset);</span><br><span class="line">    int32 FileLength = AAsset_getLength(asset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> CommandLine[CMD_LINE_MAX];</span><br><span class="line">    FileLength = (FileLength &lt; CMD_LINE_MAX - <span class="number">1</span>) ? FileLength : CMD_LINE_MAX - <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(CommandLine, FileContents, FileLength);</span><br><span class="line">    CommandLine[FileLength] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    AAsset_close(asset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// chop off trailing spaces</span></span><br><span class="line">    <span class="keyword">while</span> (*CommandLine &amp;&amp; <span class="built_in">isspace</span>(CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">      CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FCommandLine::Append(UTF8_TO_TCHAR(CommandLine));</span><br><span class="line">    FPlatformMisc::LowLevelOutputDebugStringf(TEXT(<span class="string">&quot;APK Commandline: %s&quot;</span>), FCommandLine::Get());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// read in the command line text file from the sdcard if it exists</span></span><br><span class="line">  FString CommandLineFilePath = GFilePathBase + FString(<span class="string">&quot;/UE4Game/&quot;</span>) + (!FApp::IsProjectNameEmpty() ? FApp::GetProjectName() : FPlatformProcess::ExecutableName()) + FString(<span class="string">&quot;/UE4CommandLine.txt&quot;</span>);</span><br><span class="line">  FILE* CommandLineFile = fopen(TCHAR_TO_UTF8(*CommandLineFilePath), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(CommandLineFile == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// if that failed, try the lowercase version</span></span><br><span class="line">    CommandLineFilePath = CommandLineFilePath.Replace(TEXT(<span class="string">&quot;UE4CommandLine.txt&quot;</span>), TEXT(<span class="string">&quot;ue4commandline.txt&quot;</span>));</span><br><span class="line">    CommandLineFile = fopen(TCHAR_TO_UTF8(*CommandLineFilePath), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(CommandLineFile)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">char</span> CommandLine[CMD_LINE_MAX];</span><br><span class="line">    fgets(CommandLine, ARRAY_COUNT(CommandLine) - <span class="number">1</span>, CommandLineFile);</span><br><span class="line"></span><br><span class="line">    fclose(CommandLineFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// chop off trailing spaces</span></span><br><span class="line">    <span class="keyword">while</span> (*CommandLine &amp;&amp; <span class="built_in">isspace</span>(CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">      CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize the command line to an empty string</span></span><br><span class="line">    FCommandLine::Set(TEXT(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    FCommandLine::Append(UTF8_TO_TCHAR(CommandLine));</span><br><span class="line">    FPlatformMisc::LowLevelOutputDebugStringf(TEXT(<span class="string">&quot;Override Commandline: %s&quot;</span>), FCommandLine::Get());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  <span class="keyword">if</span> (FString* ConfigRulesCmdLineAppend = FAndroidMisc::GetConfigRulesVariable(TEXT(<span class="string">&quot;cmdline&quot;</span>)))</span><br><span class="line">  &#123;</span><br><span class="line">    FCommandLine::Append(**ConfigRulesCmdLineAppend);</span><br><span class="line">    FPlatformMisc::LowLevelOutputDebugStringf(TEXT(<span class="string">&quot;ConfigRules appended: %s&quot;</span>), **ConfigRulesCmdLineAppend);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说就是在<code>UE4Game/ProjectName/ue4commandline.txt</code>中把启动参数写到里面，引擎启动的时候会从这个文件去读，然后添加到FCommandLine中。</p>
<h3 id="IOS启动参数"><a href="#IOS启动参数" class="headerlink" title="IOS启动参数"></a>IOS启动参数</h3><p>与Android的做法相同，IOS的参数传递是在<code>main</code>函数中调用<code>FIOSCommandLineHelper::InitCommandArgs(FString());</code>，不过路径和Android不一样：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitCommandArgs</span><span class="params">(FString AdditionalCommandArgs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// initialize the commandline</span></span><br><span class="line">	FCommandLine::Set(TEXT(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">	FString CommandLineFilePath = FString([[NSBundle mainBundle] bundlePath]) + TEXT(<span class="string">&quot;/ue4commandline.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// read in the command line text file (coming from UnrealFrontend) if it exists</span></span><br><span class="line">	FILE* CommandLineFile = fopen(TCHAR_TO_UTF8(*CommandLineFilePath), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(CommandLineFile)</span><br><span class="line">	&#123;</span><br><span class="line">		FPlatformMisc::LowLevelOutputDebugStringf(TEXT(<span class="string">&quot;Found ue4commandline.txt file&quot;</span>) LINE_TERMINATOR);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">char</span> CommandLine[CMD_LINE_MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">		<span class="keyword">char</span>* DataExists = fgets(CommandLine, ARRAY_COUNT(CommandLine) - <span class="number">1</span>, CommandLineFile);</span><br><span class="line">		<span class="keyword">if</span> (DataExists)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// chop off trailing spaces</span></span><br><span class="line">			<span class="keyword">while</span> (*CommandLine &amp;&amp; <span class="built_in">isspace</span>(CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>]))</span><br><span class="line">			&#123;</span><br><span class="line">				CommandLine[<span class="built_in">strlen</span>(CommandLine) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			FCommandLine::Append(UTF8_TO_TCHAR(CommandLine));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		FPlatformMisc::LowLevelOutputDebugStringf(TEXT(<span class="string">&quot;No ue4commandline.txt [%s] found&quot;</span>) LINE_TERMINATOR, *CommandLineFilePath);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!AdditionalCommandArgs.IsEmpty() &amp;&amp; !FChar::IsWhitespace(AdditionalCommandArgs[<span class="number">0</span>]))</span><br><span class="line">	&#123;</span><br><span class="line">		FCommandLine::Append(TEXT(<span class="string">&quot; &quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	FCommandLine::Append(*AdditionalCommandArgs);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// now merge the GSavedCommandLine with the rest</span></span><br><span class="line">	FCommandLine::Append(*GSavedCommandLine);</span><br><span class="line"></span><br><span class="line">	FPlatformMisc::LowLevelOutputDebugStringf(TEXT(<span class="string">&quot;Combined iOS Commandline: %s&quot;</span>) LINE_TERMINATOR, FCommandLine::Get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键就是<code>[[NSBundle mainBundle] bundlePath]</code>这一句，它获取的是App的包路径，所以把UE4CommandLine.txt放到包路径下就可以了。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaodao/archive/2012/07/03/2574703.html">NSBundle</a></li>
</ul>
<h2 id="UE编译环境的VS安装配置"><a href="#UE编译环境的VS安装配置" class="headerlink" title="UE编译环境的VS安装配置"></a>UE编译环境的VS安装配置</h2><p>保存为<code>.vsconfig</code>然后使用Visual Studio Installer导入配置安装即可：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;components&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;Microsoft.VisualStudio.Workload.NativeDesktop&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Microsoft.VisualStudio.Workload.Python&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Microsoft.VisualStudio.Workload.Node&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Microsoft.VisualStudio.Workload.NativeGame&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Microsoft.VisualStudio.Workload.NativeCrossPlat&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.debugger.justintime&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.6.2.sdk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.6.2.targetingpack&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.sdk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.targetingpack&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.1.sdk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.1.targetingpack&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.2.sdk&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.4.7.2.targetingpack&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.diagnostictools&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.cmake.project&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.atl&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.testadapterforboosttest&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.testadapterforgoogletest&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.winxp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.cli.support&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.modules.x86.x64&quot;</span>,</span><br><span class="line">    <span class="string">&quot;component.incredibuild&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.component.netfx.core.runtime&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.component.cookiecuttertools&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.component.pythontools.web&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.classdesigner&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.net.component.3.5.developertools&quot;</span>,</span><br><span class="line">    <span class="string">&quot;component.unreal.android&quot;</span>,</span><br><span class="line">    <span class="string">&quot;component.linux.cmake&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.component.helpviewer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.clangc2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.visualstudio.component.vc.tools.14.14&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下载地址：<a href="index/UE4/vs_installer.vsconfig">vs_installer.vsconfig</a></p>
<h2 id="扫描资源引用时需注意Redirector"><a href="#扫描资源引用时需注意Redirector" class="headerlink" title="扫描资源引用时需注意Redirector"></a>扫描资源引用时需注意Redirector</h2><p>当我们在UE的资源管理器中进行<code>rename</code>/<code>move</code>等操作时，会产生一个与更名之前名字一样的<code>Redirector</code>：</p>
<p><img data-src="index/UE4/ue4-scanf-asset-ref-redirector.webp"></p>
<p>在使用<code>UAssetManager::GetAssets</code>进行资源的扫描时也会查询到这些<code>redirector</code>，但是他们不是真正的资源，在处理时需要过滤掉它们。<br><code>FAssetData</code>中有一个成员函数<code>IsRedirector</code>可以用来判断扫描到的<code>FAssetData</code>是不是重定向器。</p>
<p>但是良好的项目规范是每进行<code>delete</code>/<code>rename</code>/<code>move</code>之后都手动在编辑器中执行<code>Fix up Redirector In Folder</code>，就会清理掉这些Redirector了，保持项目的干净。<br><img data-src="index/UE4/ue4-fix-up-redirectors-in-folder.webp"></p>
<h2 id="Cook执行代码"><a href="#Cook执行代码" class="headerlink" title="Cook执行代码"></a>Cook执行代码</h2><p>UE中执行Cook 的代码位于<code>UnrealEd</code>模块下，源码位于：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Editor/UnrealEd/Private/Commandlets/CookCommandlet.cpp</span><br></pre></td></tr></table></figure>

<p>其中有<code>int32 UCookCommandlet::Main(const FString&amp; CmdLineParams)</code>是起始逻辑。</p>
<h2 id="No-world-was-found-for-object"><a href="#No-world-was-found-for-object" class="headerlink" title="No world was found for object"></a>No world was found for object</h2><p>在写代码的时候在UObject里调用了一些需要传递<code>WorldContentObject</code>的函数，但是却把UObject的<code>this</code>传递了进去，因为这个东西不在场景中，无法通过它获取的World，所以会产生下列警告：</p>
<blockquote>
<p>LogScript: Warning: Script Msg: No world was found for object (/Engine/Transient.SubsysTouchControllerTrace_1) passed in to UEngine::GetWorldFromContextObject().</p>
</blockquote>
<p>解决办法就是传递一个能够获取到<code>World</code>的对象进去。</p>
<h2 id="移动设备的渲染预览"><a href="#移动设备的渲染预览" class="headerlink" title="移动设备的渲染预览"></a>移动设备的渲染预览</h2><p><code>ToolBar</code>-<code>Settings</code>-<code>PreviewRenderingLevel</code>-<code>Android ES3.1</code>/<code>Android ES2</code>/<code>IOS</code>：</p>
<p><img data-src="index/UE4/PreviewRenderingLevel.webp"></p>
<h2 id="Android-SDK版本与Android的版本"><a href="#Android-SDK版本与Android的版本" class="headerlink" title="Android SDK版本与Android的版本"></a>Android SDK版本与Android的版本</h2><p>可以在Google的开发者站点看到：<a target="_blank" rel="noopener" href="https://developer.android.com/studio/releases/platforms">Android SDK Platform</a><br>Build.VERSION_CODES的含义：<a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/os/Build.VERSION_CODES">Build.VERSION_CODES</a></p>
<table>
<thead>
<tr>
<th align="center">AndroidVersion</th>
<th align="center">SDK Version</th>
<th align="center">Build.VERSION_CODES</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Android 11</td>
<td align="center">(API level 30)</td>
<td align="center">R</td>
</tr>
<tr>
<td align="center">Android 10</td>
<td align="center">(API level 29)</td>
<td align="center">Q</td>
</tr>
<tr>
<td align="center">Android 9</td>
<td align="center">(API level 28)</td>
<td align="center">P</td>
</tr>
<tr>
<td align="center">Android 8.1</td>
<td align="center">(API level27)</td>
<td align="center">O_MR1</td>
</tr>
<tr>
<td align="center">Android 8.0</td>
<td align="center">(API level 26)</td>
<td align="center">O</td>
</tr>
<tr>
<td align="center">Android 7.1</td>
<td align="center">(API level 25)</td>
<td align="center">N_MR1</td>
</tr>
<tr>
<td align="center">Android 7.0</td>
<td align="center">(API level 24)</td>
<td align="center">N</td>
</tr>
<tr>
<td align="center">Android 6.0</td>
<td align="center">(API level 23)</td>
<td align="center">M</td>
</tr>
<tr>
<td align="center">Android 5.1</td>
<td align="center">(API level 22)</td>
<td align="center">LOLLIPOP_MR1</td>
</tr>
<tr>
<td align="center">Android 5.0</td>
<td align="center">(API level 21)</td>
<td align="center">LOLLIPOP</td>
</tr>
<tr>
<td align="center">Android 4.4W</td>
<td align="center">(API level 20)</td>
<td align="center">KITKAT_WATCH</td>
</tr>
<tr>
<td align="center">Android 4.4</td>
<td align="center">(API level 19)</td>
<td align="center">KITKAT</td>
</tr>
<tr>
<td align="center">Android 4.3</td>
<td align="center">(API level 18)</td>
<td align="center">JELLY_BEAN_MR2</td>
</tr>
<tr>
<td align="center">Android 4.2</td>
<td align="center">(API level 17)</td>
<td align="center">JELLY_BEAN_MR1</td>
</tr>
<tr>
<td align="center">Android 4.1</td>
<td align="center">(API level 16)</td>
<td align="center">JELLY_BEAN</td>
</tr>
<tr>
<td align="center">Android 4.0.3</td>
<td align="center">(API level15)</td>
<td align="center">ICE_CREAM_SANDWICH_MR1</td>
</tr>
<tr>
<td align="center">Android 4.0</td>
<td align="center">(API level 14)</td>
<td align="center">ICE_CREAM_SANDWICH</td>
</tr>
<tr>
<td align="center">Android 3.2</td>
<td align="center">(API level 13)</td>
<td align="center">HONEYCOMB_MR2</td>
</tr>
<tr>
<td align="center">Android 3.1</td>
<td align="center">(API level 12)</td>
<td align="center">HONEYCOMB_MR1</td>
</tr>
<tr>
<td align="center">Android 3.0</td>
<td align="center">(API level 11)</td>
<td align="center">HONEYCOMB</td>
</tr>
<tr>
<td align="center">Android 2.3.3</td>
<td align="center">(API level 10)</td>
<td align="center">GINGERBREAD_MR1</td>
</tr>
<tr>
<td align="center">Android 2.3</td>
<td align="center">(API level 9)</td>
<td align="center">GINGERBREAD</td>
</tr>
</tbody></table>
<p>UE4对Android的最低支持是SDK9，也就是Android2.3。</p>
<h2 id="Android项目设置"><a href="#Android项目设置" class="headerlink" title="Android项目设置"></a>Android项目设置</h2><ul>
<li><code>EnableGradleInsteadOfAnt</code>：使用Gradle替代Ant用来编译和生成APK。</li>
<li><code>EnableFullScreenImmersiveOnKitKatAndAboveDevices</code>：全屏模式下隐藏虚拟按键；</li>
<li><code>EnableImprovedVirtualKeyboard</code>：启用虚拟键盘；</li>
</ul>
<h2 id="在构造函数中用SetupAttachmen替代AttachToComponent"><a href="#在构造函数中用SetupAttachmen替代AttachToComponent" class="headerlink" title="在构造函数中用SetupAttachmen替代AttachToComponent"></a>在构造函数中用SetupAttachmen替代AttachToComponent</h2><p>在构造函数中使用<code>AttachToComponent</code>在打包时会有这样的错误：</p>
<blockquote>
<p>Error: AttachToComponent when called from a constructor is only setting up attachment and will always be treated as KeepRelative. Consider calling SetupAttachment directly instead.</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: begin: <span class="built_in">stack</span> <span class="keyword">for</span> UAT</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: === Handled ensure: ===</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error:</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: Ensure condition failed: AttachmentRules.LocationRule == EAttachmentRule::KeepRelative &amp;&amp; AttachmentRules.RotationRule == EAttachmentRule::KeepRelative &amp;&amp; AttachmentRules.ScaleRule == EAttachmentRule::KeepRelative [File:D:\Build\++UE4\Sync\Engine\Source\Runtime\Engine\Privat</span><br><span class="line">e\Components\SceneComponent.cpp] [Line: <span class="number">1786</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: AttachToComponent when called from a constructor is only setting up attachment <span class="keyword">and</span> will always be treated as KeepRelative. Consider calling SetupAttachment directly instead.</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: Stack:</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe36fccd89</span> UE4Editor-Engine.dll!DispatchCheckVerify&lt;<span class="keyword">bool</span>,&lt;lambda_2fa4c8014e6e2d59bee8e8ac7e5934f3&gt; &gt;() [d:\build\++ue4\sync\engine\source\runtime\core\<span class="keyword">public</span>\misc\assertionmacros.h:<span class="number">161</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe35e04fa1</span> UE4Editor-Engine.dll!USceneComponent::AttachToComponent() [d:\build\++ue4\sync\engine\source\runtime\engine\<span class="keyword">private</span>\components\scenecomponent.cpp:<span class="number">1786</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe215db1b3</span> UE4Editor-GWorld<span class="number">-0001.</span>dll!ABasePlayerPawn::ABasePlayerPawn() [c:\users\imzlp\documents\unreal projects\gworldclient\source\gworld\<span class="keyword">private</span>\modules\coreentity\instance\baseplayerpawn.cpp:<span class="number">21</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe215fdf57</span> UE4Editor-GWorld<span class="number">-0001.</span>dll!InternalConstructor&lt;ABasePlayerPawn&gt;() [c:\program files\epic games\ue_4<span class="number">.22</span>\engine\source\runtime\coreuobject\<span class="keyword">public</span>\uobject\class.h:<span class="number">2841</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe382a610f</span> UE4Editor-CoreUObject.dll!UClass::CreateDefaultObject() [d:\build\++ue4\sync\engine\source\runtime\coreuobject\<span class="keyword">private</span>\uobject\class.cpp:<span class="number">3076</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe384e1056</span> UE4Editor-CoreUObject.dll!UObjectLoadAllCompiledInDefaultProperties() [d:\build\++ue4\sync\engine\source\runtime\coreuobject\<span class="keyword">private</span>\uobject\uobjectbase.cpp:<span class="number">793</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe384cedef</span> UE4Editor-CoreUObject.dll!ProcessNewlyLoadedUObjects() [d:\build\++ue4\sync\engine\source\runtime\coreuobject\<span class="keyword">private</span>\uobject\uobjectbase.cpp:<span class="number">869</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe382aa727</span> UE4Editor-CoreUObject.dll!TBaseStaticDelegateInstance&lt;<span class="keyword">void</span> __cdecl(<span class="keyword">void</span>)&gt;::ExecuteIfSafe() [d:\build\++ue4\sync\engine\source\runtime\core\<span class="keyword">public</span>\delegates\delegateinstancesimpl.h:<span class="number">813</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe38874a2b</span> UE4Editor-Core.dll!TBaseMulticastDelegate&lt;<span class="keyword">void</span>&gt;::Broadcast() [d:\build\++ue4\sync\engine\source\runtime\core\<span class="keyword">public</span>\delegates\delegatesignatureimpl.inl:<span class="number">977</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe38a45cb5</span> UE4Editor-Core.dll!FModuleManager::LoadModuleWithFailureReason() [d:\build\++ue4\sync\engine\source\runtime\core\<span class="keyword">private</span>\modules\modulemanager.cpp:<span class="number">530</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe5fb58d67</span> UE4Editor-Projects.dll!FModuleDescriptor::LoadModulesForPhase() [d:\build\++ue4\sync\engine\source\runtime\projects\<span class="keyword">private</span>\moduledescriptor.cpp:<span class="number">596</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe5fb58ff7</span> UE4Editor-Projects.dll!FProjectManager::LoadModulesForProject() [d:\build\++ue4\sync\engine\source\runtime\projects\<span class="keyword">private</span>\projectmanager.cpp:<span class="number">63</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ff65dabd260</span> UE4Editor-Cmd.exe!FEngineLoop::PreInit() [d:\build\++ue4\sync\engine\source\runtime\launch\<span class="keyword">private</span>\launchengineloop.cpp:<span class="number">2425</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ff65dab5377</span> UE4Editor-Cmd.exe!GuardedMain() [d:\build\++ue4\sync\engine\source\runtime\launch\<span class="keyword">private</span>\launch.cpp:<span class="number">129</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ff65dab55ca</span> UE4Editor-Cmd.exe!GuardedMainWrapper() [d:\build\++ue4\sync\engine\source\runtime\launch\<span class="keyword">private</span>\windows\launchwindows.cpp:<span class="number">145</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ff65dac316c</span> UE4Editor-Cmd.exe!WinMain() [d:\build\++ue4\sync\engine\source\runtime\launch\<span class="keyword">private</span>\windows\launchwindows.cpp:<span class="number">275</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ff65dac4cb6</span> UE4Editor-Cmd.exe!__scrt_common_main_seh() [d:\agent\_work\<span class="number">3</span>\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:<span class="number">288</span>]</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe7b247974</span> KERNEL32.DLL!UnknownFunction []</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: [Callstack] <span class="number">0x00007ffe7c62a271</span> ntdll.dll!UnknownFunction []</span><br><span class="line">UATHelper: Packaging (Windows (<span class="number">64</span>-bit)):   LogInit: Display: LogOutputDevice: Error: end: <span class="built_in">stack</span> <span class="keyword">for</span> UAT</span><br></pre></td></tr></table></figure>

<p>解决的办法就是提示中的那样，用<code>SetupAttachment</code>替换<code>AttachToComponent</code>。</p>
<h2 id="在其他的线程运行程序并获取程序输出"><a href="#在其他的线程运行程序并获取程序输出" class="headerlink" title="在其他的线程运行程序并获取程序输出"></a>在其他的线程运行程序并获取程序输出</h2><p>在写避编辑器功能的时候经常会启动外部的程序来执行任务，如果要求程序执行完成才走其他逻辑则会阻塞，这样的体验很不好，所以一般是开一个额外的线程来执行程序启动。废话不多说直接看代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span>  once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;FThreadUtils.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;GenericPlatform/GenericPlatformProcess.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">DECLARE_MULTICAST_DELEGATE_OneParam(FOutputMsgDelegate, <span class="keyword">const</span> FString&amp;);</span><br><span class="line">DECLARE_MULTICAST_DELEGATE(FProcStatusDelegate);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FProcWorkerThread</span> :</span> <span class="keyword">public</span> FThread</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">FProcWorkerThread</span><span class="params">(<span class="keyword">const</span> TCHAR *InThreadName,<span class="keyword">const</span> FString&amp; InProgramPath,<span class="keyword">const</span> FString&amp; InParams)</span></span></span><br><span class="line">    : FThread(InThreadName, []() &#123;&#125;), mProgramPath(InProgramPath), mPragramParams(InParams)</span><br><span class="line">  &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> uint32 <span class="title">Run</span><span class="params">()</span><span class="keyword">override</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (FPaths::FileExists(mProgramPath))</span><br><span class="line">    &#123;</span><br><span class="line">      FPlatformProcess::CreatePipe(mReadPipe, mWritePipe);</span><br><span class="line">      <span class="comment">// std::cout &lt;&lt; TCHAR_TO_ANSI(*mProgramPath) &lt;&lt; &quot; &quot; &lt;&lt; TCHAR_TO_ANSI(*mPragramParams) &lt;&lt; std::endl;</span></span><br><span class="line"></span><br><span class="line">      mProcessHandle = FPlatformProcess::CreateProc(*mProgramPath, *mPragramParams, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">true</span>, &amp;mProcessID, <span class="number">0</span>, <span class="literal">NULL</span>, mWritePipe,mReadPipe);</span><br><span class="line">      <span class="keyword">if</span> (mProcessHandle.IsValid() &amp;&amp; FPlatformProcess::IsApplicationRunning(mProcessID))</span><br><span class="line">      &#123;</span><br><span class="line">        ProcBeginDelegate.Broadcast();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      FString Line;</span><br><span class="line">      <span class="keyword">while</span> (mProcessHandle.IsValid() &amp;&amp; FPlatformProcess::IsApplicationRunning(mProcessID))</span><br><span class="line">      &#123;</span><br><span class="line">        FPlatformProcess::Sleep(<span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">        FString NewLine = FPlatformProcess::ReadPipe(mReadPipe);</span><br><span class="line">        <span class="keyword">if</span> (NewLine.Len() &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// process the string to break it up in to lines</span></span><br><span class="line">          Line += NewLine;</span><br><span class="line">          TArray&lt;FString&gt; StringArray;</span><br><span class="line">          int32 count = Line.ParseIntoArray(StringArray, TEXT(<span class="string">&quot;\n&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">          <span class="keyword">if</span> (count &gt; <span class="number">1</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; count - <span class="number">1</span>; ++Index)</span><br><span class="line">            &#123;</span><br><span class="line">              StringArray[Index].TrimEndInline();</span><br><span class="line">              ProcOutputMsgDelegate.Broadcast(StringArray[Index]);</span><br><span class="line">            &#125;</span><br><span class="line">            Line = StringArray[count - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (NewLine.EndsWith(TEXT(<span class="string">&quot;\n&quot;</span>)))</span><br><span class="line">            &#123;</span><br><span class="line">              Line += TEXT(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      int32 ProcReturnCode;</span><br><span class="line">      <span class="keyword">if</span> (FPlatformProcess::GetProcReturnCode(mProcessHandle,&amp;ProcReturnCode))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (ProcReturnCode == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          ProcSuccessedDelegate.Broadcast();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          ProcFaildDelegate.Broadcast();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    mThreadStatus = EThreadStatus::Completed;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Exit</span><span class="params">()</span><span class="keyword">override</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mProcessHandle.IsValid())</span><br><span class="line">    &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Cancel</span><span class="params">()</span><span class="keyword">override</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (GetThreadStatus() != EThreadStatus::Busy)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    mThreadStatus = EThreadStatus::Canceling;</span><br><span class="line">    <span class="keyword">if</span> (mProcessHandle.IsValid() &amp;&amp; FPlatformProcess::IsApplicationRunning(mProcessID))</span><br><span class="line">    &#123;</span><br><span class="line">      FPlatformProcess::TerminateProc(mProcessHandle, <span class="literal">true</span>);</span><br><span class="line">      ProcFaildDelegate.Broadcast();</span><br><span class="line">      mProcessHandle.Reset();</span><br><span class="line">      mProcessID = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mThreadStatus = EThreadStatus::Canceled;</span><br><span class="line">    CancelDelegate.Broadcast();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> uint32 <span class="title">GetProcesId</span><span class="params">()</span><span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> mProcessID; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> FProcHandle <span class="title">GetProcessHandle</span><span class="params">()</span><span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> mProcessHandle; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  FProcStatusDelegate ProcBeginDelegate;</span><br><span class="line">  FProcStatusDelegate ProcSuccessedDelegate;</span><br><span class="line">  FProcStatusDelegate ProcFaildDelegate;</span><br><span class="line">  FOutputMsgDelegate ProcOutputMsgDelegate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  FRunnableThread* mThread;</span><br><span class="line">  FString mProgramPath;</span><br><span class="line">  FString mPragramParams;</span><br><span class="line">  <span class="keyword">void</span>* mReadPipe;</span><br><span class="line">  <span class="keyword">void</span>* mWritePipe;</span><br><span class="line">  uint32 mProcessID;</span><br><span class="line">  FProcHandle mProcessHandle;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以通过监听<code>ProcOutputMsgDelegate</code>来接收程序的打印输出。</p>
<h2 id="绑定FTicker"><a href="#绑定FTicker" class="headerlink" title="绑定FTicker"></a>绑定FTicker</h2><p>在非Actor的对象上如果想要使用Tick，可以使用下列代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FDelegateHandle TickHandle = FTicker::GetCoreTicker().AddTicker(FTickerDelegate::CreateRaw(<span class="keyword">this</span>,&amp;UGameExtensionSettings::Tick);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS:<code>FCoreDelegates</code>和<code>FCoreUObjectDelegates</code>中有很多有用的代理。</p>
</blockquote>
<h2 id="地图加载的Delegate"><a href="#地图加载的Delegate" class="headerlink" title="地图加载的Delegate"></a>地图加载的Delegate</h2><p><code>FCoreUObjectDelegates</code>中的这两个代理在地图加载时和地图加载完成时会调用，可以用来显示加载地图时的过场：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FCoreUObjectDelegates::PreLoadMap.AddUObject(<span class="keyword">this</span>, &amp;UMarinGameInstance::BeginLoadingScreen);</span><br><span class="line">FCoreUObjectDelegates::PostLoadMapWithWorld.AddUObject(<span class="keyword">this</span>, &amp;UMarinGameInstance::EndL</span><br></pre></td></tr></table></figure>

<h2 id="StaticLoadClass"><a href="#StaticLoadClass" class="headerlink" title="StaticLoadClass"></a>StaticLoadClass</h2><p>可以从通过一个字符串来加载UClass:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UClass* UserWidgetClass = StaticLoadClass(UUserWidget::StaticClass(), <span class="literal">NULL</span>, TEXT(<span class="string">&quot;WidgetBlueprintGeneratedClass&#x27;/Game/TEST/BP_UserWidget.BP_UserWidget_C&#x27;&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>同理也有<code>StaticLoadObject</code>。</p>
<h2 id="ConstructorHelpers-FClassFinder"><a href="#ConstructorHelpers-FClassFinder" class="headerlink" title="ConstructorHelpers::FClassFinder"></a>ConstructorHelpers::FClassFinder</h2><p>只能在构造函数中调用，否则引擎会崩溃，在外部使用可以使用<code>StaticLoadClass</code>。</p>
<h2 id="CMD的sudo"><a href="#CMD的sudo" class="headerlink" title="CMD的sudo"></a>CMD的sudo</h2><p>在Windows上时长会遇到要使用管理员权限执行的命令，而Win的cmd又不如Linux那样可以直接sudo来获取管理员权限，还要手动敲<code>cmd</code>然后右键管理员权限运行 十分麻烦，下面这个脚本可以实现类似bash的<code>sudo</code>操作：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">powershell -Command &quot;(($arg=&#x27;/k <span class="built_in">cd</span> /d &#x27;+$pwd+&#x27; &amp;&amp; %*&#x27;) -and (<span class="built_in">Start</span>-Process <span class="built_in">cmd</span> -Verb RunAs -ArgumentList $arg))| Out-Null&quot;</span><br><span class="line">@<span class="built_in">echo</span> on</span><br></pre></td></tr></table></figure>
<p>将其保存为<code>sudo.bat</code>然后放入<code>C:\Windows</code>下即可，随便打开一个cmd可以输入sudo来执行命令了。</p>
<h2 id="在游戏项目中添加编辑器模块"><a href="#在游戏项目中添加编辑器模块" class="headerlink" title="在游戏项目中添加编辑器模块"></a>在游戏项目中添加编辑器模块</h2><p>首先创建一个空的C++项目，其目录结构为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:\GWorld\Source&gt;&gt;tree /a /f</span><br><span class="line">|   GWorld.Target.cs</span><br><span class="line">|   GWorldEditor.Target.cs</span><br><span class="line">|</span><br><span class="line">\---GWorld</span><br><span class="line">      GWorld.Build.cs</span><br><span class="line">      GWorld.cpp</span><br><span class="line">      GWorld.h</span><br><span class="line">      GWorldGameModeBase.cpp</span><br><span class="line">      GWorldGameModeBase.h</span><br></pre></td></tr></table></figure>

<ol>
<li><p>我们在Source目录下添加一个<code>GWorldEditor</code>的文件夹，在其中新建<code>GWorldEditor.Build.cs</code>/<code>GWorldEditor.cpp</code>/<code>GWorldEditor.h</code>三个文件，并仿照<code>GWorld</code>模块下的文件内容修改；</p>
</li>
<li><p>在<code>GWorldEditor.Build.cs</code>中添加<code>GWorld</code>的模块依赖；</p>
</li>
<li><p>修改<code>GWorldEditor.Target.cs</code>文件将<code>ExtraModuleNames.AddRange( new string[] &#123; &quot;GWorld&quot; &#125; );</code>其中的<code>GWorld</code>修改为<code>GWorldEditor</code>；</p>
</li>
<li><p>修改项目的<code>uproject</code>文件，在<code>Modules</code>下添加<code>GWorldEditor</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;FileVersion&quot;</span>: <span class="number">3</span>,</span><br><span class="line">	<span class="string">&quot;EngineAssociation&quot;</span>: <span class="string">&quot;4.22&quot;</span>,</span><br><span class="line">	<span class="string">&quot;Category&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="string">&quot;Description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="string">&quot;Modules&quot;</span>: [</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="string">&quot;Name&quot;</span>: <span class="string">&quot;GWorld&quot;</span>,</span><br><span class="line">			<span class="string">&quot;Type&quot;</span>: <span class="string">&quot;Runtime&quot;</span>,</span><br><span class="line">			<span class="string">&quot;LoadingPhase&quot;</span>: <span class="string">&quot;Default&quot;</span>,</span><br><span class="line">			<span class="string">&quot;AdditionalDependencies&quot;</span>: [</span><br><span class="line">				<span class="string">&quot;Engine&quot;</span>,</span><br><span class="line">				<span class="string">&quot;CoreUObject&quot;</span></span><br><span class="line">			]</span><br><span class="line">		&#125;,</span><br><span class="line">    	&#123;</span><br><span class="line">    	  <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;GWorldEditor&quot;</span>,</span><br><span class="line">    	  <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;Editor&quot;</span>,</span><br><span class="line">    	  <span class="string">&quot;LoadingPhase&quot;</span>: <span class="string">&quot;PostEngineInit&quot;</span></span><br><span class="line">    	&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后重新生成VS的解决方案，编译即可。</p>
</li>
</ol>
<p><strong>可能遇到的错误</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LogInit: Warning: Still incompatible or missing module: GWorld</span><br></pre></td></tr></table></figure>
<p>如果遇到上面的错误是因为没在<code>GWorldEditor.Build.cs</code>中添加<code>GWorld</code>的模块依赖。</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://wiki.unrealengine.com/Creating_an_Editor_Module">Creating an Editor Module</a></p>
<h2 id="does-not-match-the-necessary-signature"><a href="#does-not-match-the-necessary-signature" class="headerlink" title="does not match the necessary signature"></a>does not match the necessary signature</h2><p>在蓝图事件绑定C++的Dispatcher时会有这样的提示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XXXXEvent Signature Error: The <span class="keyword">function</span>/event `XXXXEvent` does not match the necessary signature - the delegate or <span class="keyword">function</span>/event changed?</span><br></pre></td></tr></table></figure>

<p><img data-src="index/UE4/dispatcher-bind-error-not-match-signature.webp"></p>
<p>这是因为C++里的Dispather的传入参数不是<code>const&amp;</code>的（上面图里是<code>TArray&lt;Type&gt;</code>），在代码里把Delegate的声明参数改为<code>const TArray&lt;Type&gt;&amp;</code>然后重新编译即可。</p>
<h2 id="数据成员初始化顺序必须要与声明顺序一致"><a href="#数据成员初始化顺序必须要与声明顺序一致" class="headerlink" title="数据成员初始化顺序必须要与声明顺序一致"></a>数据成员初始化顺序必须要与声明顺序一致</h2><p>如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// error in UE4,ill in c++</span></span><br><span class="line">    A():dval(<span class="number">0.0f</span>),ival(<span class="number">0</span>)&#123;&#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> ival;</span><br><span class="line">    <span class="keyword">double</span> dval;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>会有下列错误：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error C5038: data member &#x27;UTcpNetPeer::RecvMessageDataRemaining&#x27; will be initialized after data member &#x27;UTcpNetPeer::ConnectionRetryTimes&#x27;</span><br></pre></td></tr></table></figure>


<h2 id="Delegate"><a href="#Delegate" class="headerlink" title="Delegate"></a>Delegate</h2><p>UE的<code>Delegate</code>分了几个不同的种类，普通的代理是模板类，<code>Dynamic Delegate</code>是通过宏展开生成类，<code>Dynamic Mulitcast Delegate</code>需要UHT参与生成代码，所以动态多播代理只能写到包含<code>generated.h</code>的文件中。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Delegates/index.html#DeclaringDelegates">Delegates</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Delegates/Multicast/index.html">Multi-cast Delegates</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Programming/UnrealArchitecture/Delegates/Dynamic/index.html">Dynamic Delegates</a></li>
</ul>
<h3 id="Delegate-1"><a href="#Delegate-1" class="headerlink" title="Delegate"></a>Delegate</h3><ul>
<li><code>DECLARE_DELEGATE</code>：普通代理，可以被值传递，本质实现是<code>TBaseDelegare&lt;__VA_ARGS__&gt;</code>的对象，可以使用<code>BindUObject</code>等函数。</li>
</ul>
<p><code>TBaseDelegate</code>里定义了很多的辅助函数，如<code>BindSP</code>/<code>BindRaw</code>/<code>BindStatic</code>/<code>CreateSP</code>等。</p>
<h3 id="Dynamic-Delegate"><a href="#Dynamic-Delegate" class="headerlink" title="Dynamic Delegate"></a>Dynamic Delegate</h3><ul>
<li><code>DECLARE_DYNAMIC_DELEGATE</code>：动态代理可以序列化，其函数可按命名查找，执行速度比常规代理慢。</li>
</ul>
<p>动态代理本质上是继承自<code>TBaseDynamicDelegate</code>的类，<code>TBaseDynamicDelegate</code>又继承自<code>TScriptDelegate</code>，所以动态代理可以绑定UObject和绑定UFUNCTION。</p>
<p>其中<code>BindUFunction</code>是<code>TScriptInterface</code>的函数，而<code>BindUbject</code>是个宏，定义在<code>Delegate.h</code>中。</p>
<p>代码分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE_DYNAMIC_DELEGATE_OneParam(FOnTestDynamicDelegate, <span class="keyword">const</span> FString&amp;, InStr);</span><br></pre></td></tr></table></figure>

<p><code>DECLARE_DYNAMIC_DELEGATE_OneParam</code>的宏定义为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_DYNAMIC_DELEGATE_OneParam( DelegateName, Param1Type, Param1Name ) BODY_MACRO_COMBINE(CURRENT_FILE_ID,_,__LINE__,_DELEGATE) FUNC_DECLARE_DYNAMIC_DELEGATE( FWeakObjectPtr, DelegateName, DelegateName##_DelegateWrapper, FUNC_CONCAT( Param1Type InParam1 ), FUNC_CONCAT( *this, InParam1 ), void, Param1Type )</span></span><br></pre></td></tr></table></figure>

<p><code>BODY_MACRO_COMBINE</code>宏其经过UHT之后生成的代码为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GWorldClient_Plugins_HotPackage_HotPatcher_Source_HotPatcherEditor_Private_CreatePatch_ExportPatchSettings_h_22_DELEGATE \</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms</span> \</span></span><br><span class="line"><span class="class">&#123;</span> \</span><br><span class="line">	FString InStr; \</span><br><span class="line">&#125;; \</span><br><span class="line">static inline void FOnTestDynamicDelegate_DelegateWrapper(const FScriptDelegate&amp; OnTestDynamicDelegate, const FString&amp; InStr) \</span><br><span class="line">&#123; \</span><br><span class="line">	_Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms Parms; \</span><br><span class="line">	Parms.InStr=InStr; \</span><br><span class="line">	OnTestDynamicDelegate.ProcessDelegate&lt;UObject&gt;(&amp;Parms); \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行展开之后，可以看到使用<code>DECLARE_DYNAMIC_DELEGATE_OneParam</code>声明的代理实际上是就被定义了一个static函数。</p>
<p><code>FUNC_DECLARE_DYNAMIC_DELEGATE</code>宏是裹了一个<code>TBaseDynamicDelegate</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Declare user&#x27;s dynamic delegate, with wrapper proxy method for executing the delegate */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNC_DECLARE_DYNAMIC_DELEGATE( TWeakPtr, DynamicDelegateName, ExecFunction, FuncParamList, FuncParamPassThru, ... ) \</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">DynamicDelegateName</span> :</span> <span class="keyword">public</span> TBaseDynamicDelegate&lt;TWeakPtr, __VA_ARGS__&gt; \</span><br><span class="line">	&#123; \</span><br><span class="line">	<span class="keyword">public</span>: \</span><br><span class="line">		<span class="comment">/** Default constructor */</span> \</span><br><span class="line">		DynamicDelegateName() \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">		\</span><br><span class="line">		<span class="comment">/** Construction from an FScriptDelegate must be explicit.  This is really only used by UObject system internals. */</span> \</span><br><span class="line">		explicit DynamicDelegateName( const TScriptDelegate&lt;&gt;&amp; InScriptDelegate ) \</span><br><span class="line">			: TBaseDynamicDelegate&lt;TWeakPtr, __VA_ARGS__&gt;( InScriptDelegate ) \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">		\</span><br><span class="line">		<span class="comment">/** Execute the delegate.  If the function pointer is not valid, an error will occur. */</span> \</span><br><span class="line">		inline void Execute( FuncParamList ) const \</span><br><span class="line">		&#123; \</span><br><span class="line">			<span class="comment">/* Verify that the user object is still valid.  We only have a weak reference to it. */</span> \</span><br><span class="line">			checkSlow( IsBound() ); \</span><br><span class="line">			ExecFunction( FuncParamPassThru ); \</span><br><span class="line">		&#125; \</span><br><span class="line">		<span class="comment">/** Execute the delegate, but only if the function pointer is still valid */</span> \</span><br><span class="line">		inline bool ExecuteIfBound( FuncParamList ) const \</span><br><span class="line">		&#123; \</span><br><span class="line">			<span class="keyword">if</span>( IsBound() ) \</span><br><span class="line">			&#123; \</span><br><span class="line">				ExecFunction( FuncParamPassThru ); \</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>; \</span><br><span class="line">			&#125; \</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>; \</span><br><span class="line">		&#125; \</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<p>所有的宏都被展开之后：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	FString InStr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">FOnTestDynamicDelegate_DelegateWrapper</span><span class="params">(<span class="keyword">const</span> FScriptDelegate&amp; OnTestDynamicDelegate, <span class="keyword">const</span> FString&amp; InStr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	_Script_HotPatcherEditor_eventOnTestDynamicDelegate_Parms Parms;</span><br><span class="line">	Parms.InStr=InStr;</span><br><span class="line">	OnTestDynamicDelegate.ProcessDelegate&lt;UObject&gt;(&amp;Parms);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FOnTestDynamicDelegate</span> :</span> <span class="keyword">public</span> TBaseDynamicDelegate&lt;FWeakObjectPtr, <span class="keyword">void</span>, <span class="keyword">const</span> FString&amp;&gt;</span><br><span class="line">&#123; </span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">	FOnTestDynamicDelegate() &#123; &#125; </span><br><span class="line">	explicit FOnTestDynamicDelegate( const TScriptDelegate&lt;&gt;&amp; InScriptDelegate ) : TBaseDynamicDelegate&lt;FWeakObjectPtr, void, const FString&amp;&gt;( InScriptDelegate ) &#123; &#125; </span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">Execute</span><span class="params">( <span class="keyword">const</span> FString&amp; InStr )</span> <span class="keyword">const</span> </span>&#123; checkSlow( IsBound() ); FOnTestDynamicDelegate_DelegateWrapper( *<span class="keyword">this</span>, InStr ); &#125; </span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">ExecuteIfBound</span><span class="params">( <span class="keyword">const</span> FString&amp; InStr )</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function">	</span>&#123; </span><br><span class="line">		<span class="keyword">if</span>( IsBound() ) </span><br><span class="line">		&#123; </span><br><span class="line">			FOnTestDynamicDelegate_DelegateWrapper( *<span class="keyword">this</span>, InStr ); </span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在使用的时候可以通过<code>BindUFunction</code>来绑定函数，通过<code>Execute</code>或者<code>ExecuteIfBound</code>来调用。</p>
<p>在当作回调函数传递的时候比较方便，因为它继承自<code>FScriptDelegate</code>，可以当作通用的方式传递。</p>
<h3 id="Multicast-Delegate"><a href="#Multicast-Delegate" class="headerlink" title="Multicast Delegate"></a>Multicast Delegate</h3><ul>
<li><strong>多播代理</strong>：与普通代理的大部分功能相同，它们只拥有对象的弱引用，可以和结构体一起使用，可以复制。其本质是<code>TMulticastDelegate&lt;__VA_ARGS__&gt;</code>的对象。多播代理可以被加载/保存和远程触发，但多播代理不能使用返回值。</li>
</ul>
<p>多播代理可以具有多个绑定，当<code>Broadcast</code>触发时，所有的绑定都会被调用。</p>
<p>多播代理可以使用<code>Add</code>/<code>AddStatic</code>/<code>AddRaw</code>/<code>AddSP</code>/<code>AddUObject</code>/<code>Remove</code>/<code>RemoveAll</code>等函数。</p>
<blockquote>
<p>注意：RemoveAll会删除所有绑定时提供指针的代理，未绑定到对象的<code>Raw</code>代理不会被该函数删除。</p>
</blockquote>
<h3 id="Dynamic-Multicast-Delegate"><a href="#Dynamic-Multicast-Delegate" class="headerlink" title="Dynamic Multicast Delegate"></a>Dynamic Multicast Delegate</h3><ul>
<li><code>DECLARE_DYNAMIC_MULITCAST_DELEGATE</code>：动态多播代理。</li>
</ul>
<p>动态多播代理必须要绑定到UFUNCTION的函数，使用宏<code>AddDynamic</code>或者<code>AddUnique</code>来添加绑定。</p>
<p>代码分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FOnTestDynamicMultiDelegate, <span class="keyword">const</span> FString&amp;, InStr);</span><br></pre></td></tr></table></figure>
<p><code>DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</code>其宏定义为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam( DelegateName, Param1Type, Param1Name )\</span></span><br><span class="line"> BODY_MACRO_COMBINE(CURRENT_FILE_ID,_,__LINE__,_DELEGATE)\</span><br><span class="line"> FUNC_DECLARE_DYNAMIC_MULTICAST_DELEGATE( FWeakObjectPtr, DelegateName, DelegateName##_DelegateWrapper, FUNC_CONCAT( Param1Type InParam1 ), FUNC_CONCAT( *<span class="keyword">this</span>, InParam1 ), <span class="keyword">void</span>, Param1Type )</span><br></pre></td></tr></table></figure>
<p>其中<code>BODY_MACRO_COMBINE</code>经过UHT之后生成下列代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GWorldClient_Plugins_HotPackage_HotPatcher_Source_HotPatcherEditor_Private_CreatePatch_ExportPatchSettings_h_22_DELEGATE \</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms</span> \</span></span><br><span class="line"><span class="class">&#123;</span> \</span><br><span class="line">	FString InStr; \</span><br><span class="line">&#125;; \</span><br><span class="line">static inline void FOnTestDynamicMultiDelegate_DelegateWrapper(const FMulticastScriptDelegate&amp; OnTestDynamicMultiDelegate, const FString&amp; InStr) \</span><br><span class="line">&#123; \</span><br><span class="line">	_Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms Parms; \</span><br><span class="line">	Parms.InStr=InStr; \</span><br><span class="line">	OnTestDynamicMultiDelegate.ProcessMulticastDelegate&lt;UObject&gt;(&amp;Parms); \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FUNC_DECLARE_DYNAMIC_MULTICAST_DELEGATE</code>则创建了一个继承自<code>TBaseDynamicMulticastDelegate</code>类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Declare user&#x27;s dynamic multi-cast delegate, with wrapper proxy method for executing the delegate */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNC_DECLARE_DYNAMIC_MULTICAST_DELEGATE(TWeakPtr, DynamicMulticastDelegateName, ExecFunction, FuncParamList, FuncParamPassThru, ...) \</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynamicMulticastDelegateName</span> :</span> <span class="keyword">public</span> TBaseDynamicMulticastDelegate&lt;TWeakPtr, __VA_ARGS__&gt; \</span><br><span class="line">	&#123; \</span><br><span class="line">	<span class="keyword">public</span>: \</span><br><span class="line">		<span class="comment">/** Default constructor */</span> \</span><br><span class="line">		DynamicMulticastDelegateName() \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">		\</span><br><span class="line">		<span class="comment">/** Construction from an FMulticastScriptDelegate must be explicit.  This is really only used by UObject system internals. */</span> \</span><br><span class="line">		explicit DynamicMulticastDelegateName( const TMulticastScriptDelegate&lt;&gt;&amp; InMulticastScriptDelegate ) \</span><br><span class="line">			: TBaseDynamicMulticastDelegate&lt;TWeakPtr, __VA_ARGS__&gt;( InMulticastScriptDelegate ) \</span><br><span class="line">		&#123; \</span><br><span class="line">		&#125; \</span><br><span class="line">		\</span><br><span class="line">		<span class="comment">/** Broadcasts this delegate to all bound objects, except to those that may have expired */</span> \</span><br><span class="line">		void Broadcast( FuncParamList ) const \</span><br><span class="line">		&#123; \</span><br><span class="line">			ExecFunction( FuncParamPassThru ); \</span><br><span class="line">		&#125; \</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>
<p><code>FUNC_CONCT</code>宏只是简单的拼接：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Helper macro that enables passing comma-separated arguments as a single macro parameter */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUNC_CONCAT( ... ) __VA_ARGS__</span></span><br></pre></td></tr></table></figure>
<p>展开所有宏之后的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	FString InStr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">FOnTestDynamicMultiDelegate_DelegateWrapper</span><span class="params">(<span class="keyword">const</span> FMulticastScriptDelegate&amp; OnTestDynamicMultiDelegate, <span class="keyword">const</span> FString&amp; InStr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	_Script_HotPatcherEditor_eventOnTestDynamicMultiDelegate_Parms Parms;</span><br><span class="line">	Parms.InStr=InStr;</span><br><span class="line">	OnTestDynamicMultiDelegate.ProcessMulticastDelegate&lt;UObject&gt;(&amp;Parms);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FOnTestDynamicMultiDelegate</span> :</span> <span class="keyword">public</span> TBaseDynamicMulticastDelegate&lt;FWeakObjectPtr, <span class="keyword">void</span>, <span class="keyword">const</span> FString&amp;&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>: </span><br><span class="line">	FOnTestDynamicMultiDelegate() &#123; &#125; </span><br><span class="line">	explicit FOnTestDynamicMultiDelegate( const TMulticastScriptDelegate&lt;&gt;&amp; InMulticastScriptDelegate ) : TBaseDynamicMulticastDelegate&lt;FWeakObjectPtr, void, const FString&amp;&gt;( InMulticastScriptDelegate ) &#123; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Broadcast</span><span class="params">( <span class="keyword">const</span> FString&amp; InStr )</span> <span class="keyword">const</span> </span>&#123; FOnTestDynamicMultiDelegate_DelegateWrapper( *<span class="keyword">this</span>, InStr ); &#125; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注，由上面的代码可知，只有普通代理（<code>DECLARE_DELEGATE</code>）声明的代理才可以使用<code>TBaseDelegate</code>的<code>BindUObject</code>等函数，动态代理和多播代理都不可以。</p>
</blockquote>
<h2 id="Pak所包含的文件"><a href="#Pak所包含的文件" class="headerlink" title="Pak所包含的文件"></a>Pak所包含的文件</h2><p>默认情况下（未设置忽略文件）UE4的Package时会把游戏的资源打包到一个Pak文件中，具体有以下内容：</p>
<p>以下描述中有几个关键字：<code>PROJECT_NAME</code>项目名，<code>PLATFORN_NAME</code>打包的平台名。</p>
<ul>
<li>Package时不会检测资源是否有引用，工程内的所有资源都会被Cook然后打包到Pak里；</li>
<li>引擎Slate的资源文件<code>Engine\Content\Slate\</code>，字体/图片等等</li>
<li>引擎的<code>Content\Internationalization</code>下相关语言的文件</li>
<li>引擎和启用插件目录下的<code>Content\Localization</code>的<code>locmeta</code>/<code>locres</code>文件</li>
<li>项目的<code>uproject</code>文件，挂载点为<code>../../../PROJECT_NAME/PROJECT_NAME.uproject</code>；</li>
<li>项目启用的所有插件的<code>uplugin</code>文件，挂载点为插件的相对与<code>../../../Engine/</code>或者<code>../../../PROJECT_NAME/Plugins/</code>的路径；</li>
<li>项目目录下<code>Intermediate\Staging\PROJECT_NAME.upluginmanifest</code>文件，挂载点为<code>../../../PROJECT_NAME/Plugins/PROJECT_NAME.upluginmanifest</code></li>
<li>引擎的ini文件，在引擎的<code>Engine/Config</code>下除了<code>Editor</code>的ini和<code>BaseLightmass.ini</code>/<code>BasePakFileRules.ini</code>之外都包含；</li>
<li>引擎下平台的ini，在<code>Engine/Config/PLATFORM_NAME</code>内的所有ini文件；</li>
<li>项目启用的插件的ini，在插件的目录的config下；</li>
<li>Cook出来的<code>AssetRegistry.bin</code>；</li>
<li>Cook出的<code>PLATFORN_NAME\Engine\GlobalShaderCache*.bin</code>；</li>
<li>Cook出来的<code>PLATFORM_NAME\PROJECT_NAME\Content\ShaderArchive-*.ushaderbytecode</code>文件</li>
</ul>
<h2 id="Mount-Pak时的一个问题"><a href="#Mount-Pak时的一个问题" class="headerlink" title="Mount Pak时的一个问题"></a>Mount Pak时的一个问题</h2><p>UE在Mount时调用的是<code>FPakPlatformFile::Mount</code>，对于要Mount的Pak创建了一个<code>FPakFile</code>的对象，该对象会存储到<code>FPakPlatformFile::PakFiles</code>中。</p>
<p>问题就出在这个<code>PakFiles</code>上，其声明为<code>TArray&lt;FPakListEntry&gt;</code>，而<code>FPakListEntry</code>这个struct是定义在类<code>FPakPlatformFile</code>中的类，而且还是个私有的类定义，在外部无法访问，虽然<code>FPakPlatformFile</code>中有<code>GetMountedPaks</code>这个函数，但是传入的参数外部无法定义（因为是私有的）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Public/IPlatformPak.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PAKFILE_API</span> <span class="title">FPakPlatformFile</span> :</span> <span class="keyword">public</span> IPlatformFile</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">FPakListEntry</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		FPakListEntry()</span><br><span class="line">			: ReadOrder(<span class="number">0</span>)</span><br><span class="line">			, PakFile(<span class="literal">nullptr</span>)</span><br><span class="line">		&#123;&#125;</span><br><span class="line"></span><br><span class="line">		uint32		ReadOrder;</span><br><span class="line">		FPakFile*	PakFile;</span><br><span class="line"></span><br><span class="line">		FORCEINLINE <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> FPakListEntry&amp; RHS) <span class="keyword">const</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> ReadOrder &gt; RHS.ReadOrder;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Gets mounted pak files</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">GetMountedPaks</span><span class="params">(TArray&lt;FPakListEntry&gt;&amp; Paks)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="function">FScopeLock <span class="title">ScopedLock</span><span class="params">(&amp;PakListCritical)</span></span>;</span><br><span class="line">		Paks.Append(PakFiles);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>所以在不改动引擎源码的情况下无法直接得到已经Mount的Pak列表，有点坑。</p>
<p>绕一圈可以使用的方法为<code>FPakPlatformFile::GetMountedPakFilenames</code>用来获取当前已经Mount的Pak列表：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Get a list of all pak files which have been successfully mounted</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">GetMountedPakFilenames</span><span class="params">(TArray&lt;FString&gt;&amp; PakFilenames)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">FScopeLock <span class="title">ScopedLock</span><span class="params">(&amp;PakListCritical)</span></span>;</span><br><span class="line">	PakFilenames.Empty(PakFiles.Num());</span><br><span class="line">	<span class="keyword">for</span> (FPakListEntry&amp; Entry : PakFiles)</span><br><span class="line">	&#123;</span><br><span class="line">		PakFilenames.Add(Entry.PakFile-&gt;GetFilename());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再通过<code>IPlatformFilePak::FindFileInPakFiles</code>可以获取到已经Mount的某个Pak的<code>FPakFile</code>实例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Finds a file in all available pak files.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param Filename File to find in pak files.</span></span><br><span class="line"><span class="comment"> * @param OutPakFile Optional pointer to a pak file where the filename was found.</span></span><br><span class="line"><span class="comment"> * @return Pointer to pak entry if the file was found, NULL otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FindFileInPakFiles</span><span class="params">(<span class="keyword">const</span> TCHAR* Filename, FPakFile** OutPakFile = <span class="literal">nullptr</span>, FPakEntry* OutEntry = <span class="literal">nullptr</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TArray&lt;FPakListEntry&gt; Paks;</span><br><span class="line">	GetMountedPaks(Paks);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> FindFileInPakFiles(Paks, Filename, OutPakFile, OutEntry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以通过传入Pak的路径信息来得到FPakFile。</p>
<h2 id="FScopeSlowTask"><a href="#FScopeSlowTask" class="headerlink" title="FScopeSlowTask"></a>FScopeSlowTask</h2><p>执行一些任务的时候可以显示进度。<br><img data-src="index/UE4/Editor-SlowTask-progress.webp"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> AmountOfWorkProgress = <span class="number">2.0f</span>;</span><br><span class="line"><span class="function">FScopeSlowTask <span class="title">SlowTask</span><span class="params">(AmountOfWorkProgress)</span></span>;</span><br><span class="line">SlowTask.MakeDialog();</span><br><span class="line"></span><br><span class="line"><span class="comment">// something</span></span><br><span class="line"><span class="comment">// Update SlowTask Progress</span></span><br><span class="line">&#123;</span><br><span class="line">	FText Dialog = FText::Format(NSLOCTEXT(<span class="string">&quot;ExportPatch&quot;</span>, <span class="string">&quot;GeneratedPak&quot;</span>, <span class="string">&quot;Generating Pak list of &#123;0&#125; Platform.&quot;</span>), FText::FromString(PlatformName));</span><br><span class="line">	SlowTask.EnterProgressFrame(<span class="number">1.0</span>, Dialog);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// something</span></span><br></pre></td></tr></table></figure>
<p>需要注意两点：</p>
<ol>
<li><code>EnterProgressFrame</code>传入的参数每次为<code>1.0f</code>即可，里面是累增的。</li>
<li>不要在一个函数里创建多个<code>FScopeSlowTask</code>的<code>Dialog</code>，会有窗口消不掉的问题（UE_4.22.3）。</li>
</ol>
<h2 id="MD5Hash"><a href="#MD5Hash" class="headerlink" title="MD5Hash"></a>MD5Hash</h2><p>在UE中计算文件的MD5Hash值：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FMD5Hash FileHash = FMD5Hash::HashFile(*InFile);</span><br><span class="line">FString HashValue = LexToString(FileHash);</span><br></pre></td></tr></table></figure>

<h2 id="运行时在Pak中访问非资源文件"><a href="#运行时在Pak中访问非资源文件" class="headerlink" title="运行时在Pak中访问非资源文件"></a>运行时在Pak中访问非资源文件</h2><p>可以把一些非UE资源文件（比如txt，视频）等文件打包到Pak中，在游戏运行中访问，可以使用我上面写的HotPatcher工具来打包，这里写一下在运行时访问的方法。</p>
<p>首先将文件打包到Pak：</p>
<p><img data-src="index/UE4/Paks/package-outside-file-to-pak.webp"></p>
<p>这里我是将文件<code>AAAAA.json</code>打包到了Pak中，其挂载路径为<code>../../../PROJECT_NAME/AAAAA.json</code>.</p>
<p>在游戏中访问一定要使用挂载路径，可以使用<code>FPaths::ProjectDir</code>在打包后获取到的是相对路径，在PIE下是项目的相对路径。</p>
<p>使用方法：</p>
<p><img data-src="index/UE4/Paks/load-extern-file-form-pak-in-runtime.webp"></p>
<p>其中的<code>PeojectDir</code>是<code>FPaths::ProjectDir</code>，<code>LoadFileToString</code>则是<code>IFileManager::LoadFileToString</code>的封装。</p>
<p>运行结果：</p>
<p><img data-src="index/UE4/Paks/visitor-pak-not-asset-file-in-package-game.webp"></p>
<p>如果想要访问打包出的项目文件和挂载的Pak中的文件，可以使用下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UPakVisitorHelper::VisitorProjectDir</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IPlatformFile&amp; PlatformFile = FPlatformFileManager::Get().GetPlatformFile();</span><br><span class="line"></span><br><span class="line">	FFillArrayDirectoryVisitor Visitor;</span><br><span class="line">	PlatformFile.IterateDirectory(*FPaths::ProjectDir(), Visitor);</span><br><span class="line"></span><br><span class="line">	UE_LOG(LogTemp,Log,TEXT(<span class="string">&quot;Found Files:&quot;</span>));</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; File : Visitor.Files)</span><br><span class="line">	&#123;</span><br><span class="line">		UE_LOG(LogTemp, Log, TEXT(<span class="string">&quot;%s&quot;</span>), *File);</span><br><span class="line">	&#125;</span><br><span class="line">	UE_LOG(LogTemp, Log, TEXT(<span class="string">&quot;Found Directorys:&quot;</span>));</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; Dir : Visitor.Directories)</span><br><span class="line">	&#123;</span><br><span class="line">		UE_LOG(LogTemp, Log, TEXT(<span class="string">&quot;%s&quot;</span>), *Dir);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>IPlatformFile::IterateDirectory</code>这个函数有两个原型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IterateDirectory</span><span class="params">(<span class="keyword">const</span> TCHAR * Directory, FDirectoryVisitor Visitor)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IterateDirectory</span><span class="params">(<span class="keyword">const</span> TCHAR * Directory,FDirectoryVisitorFunc Visitor)</span></span>;</span><br></pre></td></tr></table></figure>

<p>可以传入一个继承自<code>FDirectoryVisitor</code>的对象，或者传入一个下列签名的函数对象：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> TFunctionRef &lt; <span class="keyword">bool</span>(<span class="keyword">const</span> TCHAR *, <span class="keyword">bool</span>)&gt; FDirectoryVisitorFunc</span><br></pre></td></tr></table></figure>

<p>支持传入一个Lambda也是可以的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">TArray&lt;FString&gt; Files;</span><br><span class="line">TArray&lt;FString&gt; Dirs;</span><br><span class="line"></span><br><span class="line">IPlatformFile&amp; PlatformFile = FPlatformFileManager::Get().GetPlatformFile();</span><br><span class="line"><span class="keyword">auto</span> FallArrayDirVisitor = [&amp;Files,&amp;Dirs](<span class="keyword">const</span> TCHAR* InItem,<span class="keyword">bool</span> bInDir)-&gt;<span class="keyword">bool</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (bInDir)</span><br><span class="line">	&#123;</span><br><span class="line">		Dirs.AddUnique(InItem);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Files.AddUnique(InItem);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line">PlatformFile.IterateDirectory(*InRelativePath, FallArrayDirVisitor);</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img data-src="index/UE4/Paks/visitor-projectdir.webp"></p>
<p><code>AssetRegistry.bin</code>/<code>*.uproject</code>等文件都是在打包的时候打包进pak里的，<code>AAAAA.json</code>则是上面手动打到Patch的Pak里的。</p>
<h2 id="枚举的反射信息"><a href="#枚举的反射信息" class="headerlink" title="枚举的反射信息"></a>枚举的反射信息</h2><p>下列枚举类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ETargetPlatform.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ETargetPlatform.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">UENUM(BlueprintType)</span><br><span class="line"><span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">ETargetPlatform</span> :</span> uint8</span><br><span class="line">&#123;</span><br><span class="line">	AllDesktop,</span><br><span class="line">	MacClient,</span><br><span class="line">	MacNoEditor,</span><br><span class="line">	MacServer,</span><br><span class="line">	Mac,</span><br><span class="line">	WindowsClient,</span><br><span class="line">	WindowsNoEditor,</span><br><span class="line">	WindowsServer,</span><br><span class="line">	Windows,</span><br><span class="line">	Android,</span><br><span class="line">	Android_ASTC,</span><br><span class="line">	Android_ATC,</span><br><span class="line">	Android_DXT,</span><br><span class="line">	Android_ETC1,</span><br><span class="line">	Android_ETC1a,</span><br><span class="line">	Android_ETC2,</span><br><span class="line">	Android_PVRTC,</span><br><span class="line">	AndroidClient,</span><br><span class="line">	Android_ASTCClient,</span><br><span class="line">	Android_ATCClient,</span><br><span class="line">	Android_DXTClient,</span><br><span class="line">	Android_ETC1Client,</span><br><span class="line">	Android_ETC1aClient,</span><br><span class="line">	Android_ETC2Client,</span><br><span class="line">	Android_PVRTCClient,</span><br><span class="line">	Android_Multi,</span><br><span class="line">	Android_MultiClient,</span><br><span class="line">	HTML5,</span><br><span class="line">	IOSClient,</span><br><span class="line">	IOS,</span><br><span class="line">	TVOSClient,</span><br><span class="line">	TVOS,</span><br><span class="line">	LinuxClient,</span><br><span class="line">	LinuxNoEditor,</span><br><span class="line">	LinuxServer,</span><br><span class="line">	Linux,</span><br><span class="line">	Lumin,</span><br><span class="line">	LuminClient</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>经过UHT之后的反射代码为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ETargetPlatform.generated.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/ObjectMacros.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/ScriptMacros.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">PRAGMA_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HOTPATCHERRUNTIME_ETargetPlatform_generated_h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">&quot;ETargetPlatform.generated.h already included, missing &#x27;#pragma once&#x27; in ETargetPlatform.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HOTPATCHERRUNTIME_ETargetPlatform_generated_h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> CURRENT_FILE_ID</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CURRENT_FILE_ID HotThirdPerson_Plugins_ue4_HotPackage_HotPatcher_Source_HotPatcherRuntime_Public_ETargetPlatform_h</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FOREACH_ENUM_ETARGETPLATFORM(op) \</span></span><br><span class="line">	op(ETargetPlatform::AllDesktop) \</span><br><span class="line">	op(ETargetPlatform::MacClient) \</span><br><span class="line">	op(ETargetPlatform::MacNoEditor) \</span><br><span class="line">	op(ETargetPlatform::MacServer) \</span><br><span class="line">	op(ETargetPlatform::Mac) \</span><br><span class="line">	op(ETargetPlatform::WindowsClient) \</span><br><span class="line">	op(ETargetPlatform::WindowsNoEditor) \</span><br><span class="line">	op(ETargetPlatform::WindowsServer) \</span><br><span class="line">	op(ETargetPlatform::Windows) \</span><br><span class="line">	op(ETargetPlatform::Android) \</span><br><span class="line">	op(ETargetPlatform::Android_ASTC) \</span><br><span class="line">	op(ETargetPlatform::Android_ATC) \</span><br><span class="line">	op(ETargetPlatform::Android_DXT) \</span><br><span class="line">	op(ETargetPlatform::Android_ETC1) \</span><br><span class="line">	op(ETargetPlatform::Android_ETC1a) \</span><br><span class="line">	op(ETargetPlatform::Android_ETC2) \</span><br><span class="line">	op(ETargetPlatform::Android_PVRTC) \</span><br><span class="line">	op(ETargetPlatform::AndroidClient) \</span><br><span class="line">	op(ETargetPlatform::Android_ASTCClient) \</span><br><span class="line">	op(ETargetPlatform::Android_ATCClient) \</span><br><span class="line">	op(ETargetPlatform::Android_DXTClient) \</span><br><span class="line">	op(ETargetPlatform::Android_ETC1Client) \</span><br><span class="line">	op(ETargetPlatform::Android_ETC1aClient) \</span><br><span class="line">	op(ETargetPlatform::Android_ETC2Client) \</span><br><span class="line">	op(ETargetPlatform::Android_PVRTCClient) \</span><br><span class="line">	op(ETargetPlatform::Android_Multi) \</span><br><span class="line">	op(ETargetPlatform::Android_MultiClient) \</span><br><span class="line">	op(ETargetPlatform::HTML5) \</span><br><span class="line">	op(ETargetPlatform::IOSClient) \</span><br><span class="line">	op(ETargetPlatform::IOS) \</span><br><span class="line">	op(ETargetPlatform::TVOSClient) \</span><br><span class="line">	op(ETargetPlatform::TVOS) \</span><br><span class="line">	op(ETargetPlatform::LinuxClient) \</span><br><span class="line">	op(ETargetPlatform::LinuxNoEditor) \</span><br><span class="line">	op(ETargetPlatform::LinuxServer) \</span><br><span class="line">	op(ETargetPlatform::Linux) \</span><br><span class="line">	op(ETargetPlatform::Lumin) \</span><br><span class="line">	op(ETargetPlatform::LuminClient) </span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">ETargetPlatform</span> :</span> uint8;</span><br><span class="line"><span class="keyword">template</span>&lt;&gt; HOTPATCHERRUNTIME_API UEnum* StaticEnum&lt;ETargetPlatform&gt;();</span><br><span class="line"></span><br><span class="line">PRAGMA_ENABLE_DEPRECATION_WARNINGS</span><br></pre></td></tr></table></figure>

<p>产生的<code>gen.cpp</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;UObject/GeneratedCppIncludes.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HotPatcherRuntime/Public/ETargetPlatform.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _MSC_VER</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> (push)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> (disable : 4883)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">PRAGMA_DISABLE_DEPRECATION_WARNINGS</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EmptyLinkFunctionForGeneratedCodeETargetPlatform</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="comment">// Cross Module References</span></span><br><span class="line">	<span class="function">HOTPATCHERRUNTIME_API UEnum* <span class="title">Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">UPackage* <span class="title">Z_Construct_UPackage__Script_HotPatcherRuntime</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// End Cross Module References</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> UEnum* <span class="title">ETargetPlatform_StaticEnum</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">static</span> UEnum* Singleton = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">if</span> (!Singleton)</span><br><span class="line">		&#123;</span><br><span class="line">			Singleton = GetStaticEnum(Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform, Z_Construct_UPackage__Script_HotPatcherRuntime(), TEXT(<span class="string">&quot;ETargetPlatform&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Singleton;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">template</span>&lt;&gt; HOTPATCHERRUNTIME_API UEnum* StaticEnum&lt;ETargetPlatform&gt;()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> ETargetPlatform_StaticEnum();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> FCompiledInDeferEnum <span class="title">Z_CompiledInDeferEnum_UEnum_ETargetPlatform</span><span class="params">(ETargetPlatform_StaticEnum, TEXT(<span class="string">&quot;/Script/HotPatcherRuntime&quot;</span>), TEXT(<span class="string">&quot;ETargetPlatform&quot;</span>), <span class="literal">false</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line">	<span class="function">uint32 <span class="title">Get_Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform_Hash</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2902485356U</span>; &#125;</span><br><span class="line">	<span class="function">UEnum* <span class="title">Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_HOT_RELOAD</span></span><br><span class="line">		UPackage* Outer = Z_Construct_UPackage__Script_HotPatcherRuntime();</span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = FindExistingEnumIfHotReloadOrDynamic(Outer, TEXT(<span class="string">&quot;ETargetPlatform&quot;</span>), <span class="number">0</span>, Get_Z_Construct_UEnum_HotPatcherRuntime_ETargetPlatform_Hash(), <span class="literal">false</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="keyword">static</span> UEnum* ReturnEnum = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// WITH_HOT_RELOAD</span></span></span><br><span class="line">		<span class="keyword">if</span> (!ReturnEnum)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumeratorParam Enumerators[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::AllDesktop&quot;</span>, (int64)ETargetPlatform::AllDesktop &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::MacClient&quot;</span>, (int64)ETargetPlatform::MacClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::MacNoEditor&quot;</span>, (int64)ETargetPlatform::MacNoEditor &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::MacServer&quot;</span>, (int64)ETargetPlatform::MacServer &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Mac&quot;</span>, (int64)ETargetPlatform::Mac &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::WindowsClient&quot;</span>, (int64)ETargetPlatform::WindowsClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::WindowsNoEditor&quot;</span>, (int64)ETargetPlatform::WindowsNoEditor &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::WindowsServer&quot;</span>, (int64)ETargetPlatform::WindowsServer &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Windows&quot;</span>, (int64)ETargetPlatform::Windows &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android&quot;</span>, (int64)ETargetPlatform::Android &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ASTC&quot;</span>, (int64)ETargetPlatform::Android_ASTC &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ATC&quot;</span>, (int64)ETargetPlatform::Android_ATC &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_DXT&quot;</span>, (int64)ETargetPlatform::Android_DXT &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1&quot;</span>, (int64)ETargetPlatform::Android_ETC1 &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1a&quot;</span>, (int64)ETargetPlatform::Android_ETC1a &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC2&quot;</span>, (int64)ETargetPlatform::Android_ETC2 &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_PVRTC&quot;</span>, (int64)ETargetPlatform::Android_PVRTC &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::AndroidClient&quot;</span>, (int64)ETargetPlatform::AndroidClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ASTCClient&quot;</span>, (int64)ETargetPlatform::Android_ASTCClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ATCClient&quot;</span>, (int64)ETargetPlatform::Android_ATCClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_DXTClient&quot;</span>, (int64)ETargetPlatform::Android_DXTClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1Client&quot;</span>, (int64)ETargetPlatform::Android_ETC1Client &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC1aClient&quot;</span>, (int64)ETargetPlatform::Android_ETC1aClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_ETC2Client&quot;</span>, (int64)ETargetPlatform::Android_ETC2Client &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_PVRTCClient&quot;</span>, (int64)ETargetPlatform::Android_PVRTCClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_Multi&quot;</span>, (int64)ETargetPlatform::Android_Multi &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Android_MultiClient&quot;</span>, (int64)ETargetPlatform::Android_MultiClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::HTML5&quot;</span>, (int64)ETargetPlatform::HTML5 &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::IOSClient&quot;</span>, (int64)ETargetPlatform::IOSClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::IOS&quot;</span>, (int64)ETargetPlatform::IOS &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::TVOSClient&quot;</span>, (int64)ETargetPlatform::TVOSClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::TVOS&quot;</span>, (int64)ETargetPlatform::TVOS &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LinuxClient&quot;</span>, (int64)ETargetPlatform::LinuxClient &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LinuxNoEditor&quot;</span>, (int64)ETargetPlatform::LinuxNoEditor &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LinuxServer&quot;</span>, (int64)ETargetPlatform::LinuxServer &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Linux&quot;</span>, (int64)ETargetPlatform::Linux &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::Lumin&quot;</span>, (int64)ETargetPlatform::Lumin &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ETargetPlatform::LuminClient&quot;</span>, (int64)ETargetPlatform::LuminClient &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_METADATA</span></span><br><span class="line">			<span class="keyword">const</span> UE4CodeGen_Private::FMetaDataPairParam Enum_MetaDataParams[] = &#123;</span><br><span class="line">				&#123; <span class="string">&quot;BlueprintType&quot;</span>, <span class="string">&quot;true&quot;</span> &#125;,</span><br><span class="line">				&#123; <span class="string">&quot;ModuleRelativePath&quot;</span>, <span class="string">&quot;Public/ETargetPlatform.h&quot;</span> &#125;,</span><br><span class="line">			&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="keyword">static</span> <span class="keyword">const</span> UE4CodeGen_Private::FEnumParams EnumParams = &#123;</span><br><span class="line">				(UObject*(*)())Z_Construct_UPackage__Script_HotPatcherRuntime,</span><br><span class="line">				<span class="literal">nullptr</span>,</span><br><span class="line">				<span class="string">&quot;ETargetPlatform&quot;</span>,</span><br><span class="line">				<span class="string">&quot;ETargetPlatform&quot;</span>,</span><br><span class="line">				Enumerators,</span><br><span class="line">				ARRAY_COUNT(Enumerators),</span><br><span class="line">				RF_Public|RF_Transient|RF_MarkAsNative,</span><br><span class="line">				UE4CodeGen_Private::EDynamicType::NotDynamic,</span><br><span class="line">				(uint8)UEnum::ECppForm::EnumClass,</span><br><span class="line">				METADATA_PARAMS(Enum_MetaDataParams, ARRAY_COUNT(Enum_MetaDataParams))</span><br><span class="line">			&#125;;</span><br><span class="line">			UE4CodeGen_Private::ConstructUEnum(ReturnEnum, EnumParams);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ReturnEnum;</span><br><span class="line">	&#125;</span><br><span class="line">PRAGMA_ENABLE_DEPRECATION_WARNINGS</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _MSC_VER</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span> (pop)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>枚举值的名字可以通过下列方法获得：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FString PlatformName = StaticEnum&lt;ETargetPlatform&gt;()-&gt;GetNameByValue((int64)Platform).ToString();</span><br></pre></td></tr></table></figure>
<p>其得到的值是具有namespace的，如<code>ETargetPlatform::WindowsNoEditor</code>.</p>
<p>如果不想要namespace可以使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FString PlatformName;</span><br><span class="line">&#123;</span><br><span class="line">	FString EnumName;</span><br><span class="line">	StaticEnum&lt;ETargetPlatform&gt;()-&gt;GetNameByValue((int64)Platform).ToString().Split(TEXT(<span class="string">&quot;::&quot;</span>), &amp;EnumName, &amp;PlatformName,ESearchCase::CaseSensitive,ESearchDir::FromEnd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建存储文件的提示"><a href="#创建存储文件的提示" class="headerlink" title="创建存储文件的提示"></a>创建存储文件的提示</h2><p>如下图这种效果：</p>
<p><img data-src="index/UE4/UE4_SaveFile_Notifications.webp"></p>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">FString SaveToFile = FPaths::Combine(ExportReleaseSettings-&gt;GetSavePath(), ExportReleaseSettings-&gt;GetVersionId() + TEXT(<span class="string">&quot;.json&quot;</span>));</span><br><span class="line"><span class="keyword">bool</span> runState = UFLibAssetManageHelperEx::SaveStringToFile(SaveToFile,SaveToJson);</span><br><span class="line"><span class="keyword">if</span> (runState)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">auto</span> Message = LOCTEXT(<span class="string">&quot;ExportReleaseSuccessNotification&quot;</span>, <span class="string">&quot;Succeed to export HotPatcher Release Version.&quot;</span>);</span><br><span class="line">	<span class="function">FNotificationInfo <span class="title">Info</span><span class="params">(Message)</span></span>;</span><br><span class="line">	Info.bFireAndForget = <span class="literal">true</span>;</span><br><span class="line">	Info.ExpireDuration = <span class="number">5.0f</span>;</span><br><span class="line">	Info.bUseSuccessFailIcons = <span class="literal">false</span>;</span><br><span class="line">	Info.bUseLargeFont = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> FString HyperLinkText = SaveToFile;</span><br><span class="line">	Info.Hyperlink = FSimpleDelegate::CreateStatic(</span><br><span class="line">		[](FString SourceFilePath)</span><br><span class="line">		&#123;</span><br><span class="line">			FPlatformProcess::ExploreFolder(*SourceFilePath);</span><br><span class="line">		&#125;,</span><br><span class="line">		HyperLinkText</span><br><span class="line">	);</span><br><span class="line">	Info.HyperlinkText = FText::FromString(HyperLinkText);</span><br><span class="line"></span><br><span class="line">	FSlateNotificationManager::Get().AddNotification(Info)-&gt;SetCompletionState(SNotificationItem::CS_Success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="获取工程所有的Map"><a href="#获取工程所有的Map" class="headerlink" title="获取工程所有的Map"></a>获取工程所有的Map</h2><p>从<code>Developer/LauncherService/GameProjectHelper.h</code>中抽出来的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TArray&lt;FString&gt; <span class="title">UFlibPatchParserHelper::GetAvailableMaps</span><span class="params">(FString GameName, <span class="keyword">bool</span> IncludeEngineMaps, <span class="keyword">bool</span> Sorted)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TArray&lt;FString&gt; Result;</span><br><span class="line">	TArray&lt;FString&gt; EnginemapNames;</span><br><span class="line">	TArray&lt;FString&gt; ProjectMapNames;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> FString WildCard = FString::Printf(TEXT(<span class="string">&quot;*%s&quot;</span>), *FPackageName::GetMapPackageExtension());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Scan all Content folder, because not all projects follow Content/Maps convention</span></span><br><span class="line">	IFileManager::Get().FindFilesRecursive(ProjectMapNames, *FPaths::Combine(*FPaths::RootDir(), *GameName, TEXT(<span class="string">&quot;Content&quot;</span>)), *WildCard, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// didn&#x27;t find any, let&#x27;s check the base GameName just in case it is a full path</span></span><br><span class="line">	<span class="keyword">if</span> (ProjectMapNames.Num() == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		IFileManager::Get().FindFilesRecursive(ProjectMapNames, *FPaths::Combine(*GameName, TEXT(<span class="string">&quot;Content&quot;</span>)), *WildCard, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; ProjectMapNames.Num(); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		Result.Add(FPaths::GetBaseFilename(ProjectMapNames[i]));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IncludeEngineMaps)</span><br><span class="line">	&#123;</span><br><span class="line">		IFileManager::Get().FindFilesRecursive(EnginemapNames, *FPaths::Combine(*FPaths::RootDir(), TEXT(<span class="string">&quot;Engine&quot;</span>), TEXT(<span class="string">&quot;Content&quot;</span>), TEXT(<span class="string">&quot;Maps&quot;</span>)), *WildCard, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; EnginemapNames.Num(); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			Result.Add(FPaths::GetBaseFilename(EnginemapNames[i]));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Sorted)</span><br><span class="line">	&#123;</span><br><span class="line">		Result.Sort();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="AssetRegistry的Asset概念"><a href="#AssetRegistry的Asset概念" class="headerlink" title="AssetRegistry的Asset概念"></a>AssetRegistry的Asset概念</h2><p>UE中的Asset在使用时有以下三个概念：</p>
<ul>
<li>PackagePath：<code>/Game/TEST/BP_Actor.BP_Actor</code></li>
<li>LongPackageName：<code>/Game/TEST/BP_Actor</code></li>
<li>AssetName： <code>BP_Actor</code></li>
</ul>
<h2 id="获取所有支持的平台"><a href="#获取所有支持的平台" class="headerlink" title="获取所有支持的平台"></a>获取所有支持的平台</h2><p>在Module<code>TargetPlatform</code>中可以获取：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TArray&lt;ITargetPlatform*&gt; Platforms = GetTargetPlatformManager()-&gt;GetTargetPlatforms();</span><br></pre></td></tr></table></figure>

<p>但是注意，<code>TargetPlatform</code>是属于<code>Developer</code>的模块，不要在<code>Runtime</code>的模块中使用，否则会打包失败。</p>
<p>所以用宏简单裹了一下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TArray&lt;FString&gt; <span class="title">UFlibAssetManageHelper::GetAllTargetPlatform</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __DEVELOPER_MODE__</span></span><br><span class="line">	TArray&lt;ITargetPlatform*&gt; Platforms = GetTargetPlatformManager()-&gt;GetTargetPlatforms();</span><br><span class="line">	TArray&lt;FString&gt; result;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; PlatformItem : Platforms)</span><br><span class="line">	&#123;</span><br><span class="line">		result.Add(PlatformItem-&gt;PlatformName());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	TArray&lt;FString&gt; result = &#123;</span><br><span class="line">		<span class="string">&quot;AllDesktop&quot;</span>,</span><br><span class="line">		<span class="string">&quot;MacClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;MacNoEditor&quot;</span>,</span><br><span class="line">		<span class="string">&quot;MacServer&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Mac&quot;</span>,</span><br><span class="line">		<span class="string">&quot;WindowsClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;WindowsNoEditor&quot;</span>,</span><br><span class="line">		<span class="string">&quot;WindowsServer&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Windows&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ASTC&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ATC&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_DXT&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC1&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC1a&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC2&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_PVRTC&quot;</span>,</span><br><span class="line">		<span class="string">&quot;AndroidClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ASTCClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ATCClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_DXTClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC1Client&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC1aClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_ETC2Client&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_PVRTCClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_Multi&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Android_MultiClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;HTML5&quot;</span>,</span><br><span class="line">		<span class="string">&quot;IOSClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;IOS&quot;</span>,</span><br><span class="line">		<span class="string">&quot;TVOSClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;TVOS&quot;</span>,</span><br><span class="line">		<span class="string">&quot;LinuxClient&quot;</span>,</span><br><span class="line">		<span class="string">&quot;LinuxNoEditor&quot;</span>,</span><br><span class="line">		<span class="string">&quot;LinuxServer&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Linux&quot;</span>,</span><br><span class="line">		<span class="string">&quot;Lumin&quot;</span>,</span><br><span class="line">		<span class="string">&quot;LuminClient&quot;</span> </span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="递归扫描目录"><a href="#递归扫描目录" class="headerlink" title="递归扫描目录"></a>递归扫描目录</h2><p>与直接使用<code>IFileManager::Get().FindFiles</code>不同，<code>IFileManager::Get().FindFiles</code>只能由获取指定目录下的所有文件而无法递归扫描，可以使用<code>IFileManager::Get().IterateDirectoryRecursively</code>来解决。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FFillArrayDirectoryVisitor</span> :</span> <span class="keyword">public</span> IPlatformFile::FDirectoryVisitor</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Visit</span><span class="params">(<span class="keyword">const</span> TCHAR* FilenameOrDirectory, <span class="keyword">bool</span> bIsDirectory)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (bIsDirectory)</span><br><span class="line">		&#123;</span><br><span class="line">			Directories.Add(FilenameOrDirectory);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Files.Add(FilenameOrDirectory);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TArray&lt;FString&gt; Directories;</span><br><span class="line">	TArray&lt;FString&gt; Files;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// usage</span></span><br><span class="line">FFillArrayDirectoryVisitor FileVisitor;</span><br><span class="line">IFileManager::Get().IterateDirectoryRecursively(*InStartDir, FileVisitor);</span><br></pre></td></tr></table></figure>

<p>其实就是要创建一个继承自<code>IPlatformFile::FDirectoryVisitor</code>的筛选类。</p>
<h2 id="获取系统环境变量"><a href="#获取系统环境变量" class="headerlink" title="获取系统环境变量"></a>获取系统环境变量</h2><p>可以使用<code>FPlatformMisc::GetEnvironmentVariable</code>来拿：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FString FindEnvGitPath = FPlatformMisc::GetEnvironmentVariable(TEXT(<span class="string">&quot;GIT_PATH&quot;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="运行时获取git-diff的内容"><a href="#运行时获取git-diff的内容" class="headerlink" title="运行时获取git diff的内容"></a>运行时获取git diff的内容</h2><p>做热更新有用到：</p>
<p><img data-src="index/UE4/git-diff-in-ue4-no-runtime.webp"></p>
<h2 id="获取Asset的依赖关系"><a href="#获取Asset的依赖关系" class="headerlink" title="获取Asset的依赖关系"></a>获取Asset的依赖关系</h2><p>在UE中想要获取一个资源对其他资源的依赖关系可以通过<code>AsserRegistryModule</code>来拿:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FAssetRegistryModule&amp; AssetRegistryModule = FModuleManager::LoadModuleChecked&lt;FAssetRegistryModule&gt;(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>));</span><br><span class="line">FStringAssetReference InAssetRef = TEXT(<span class="string">&quot;/Game/Pak/Cube.Cube&quot;</span>);</span><br><span class="line">FString InTargetLongPackageName = InAssetRef.GetLongPackageName();</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> bSuccessed = AssetRegistryModule.Get().GetDependencies(FName(*InTargetLongPackageName), local_Dependencies, EAssetRegistryDependencyType::Packages);</span><br></pre></td></tr></table></figure>
<p>完整的函数如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibAssetManageHelper::GetAssetDependencies</span><span class="params">(<span class="keyword">const</span> FString&amp; InAsset, FAssetDependenciesInfo&amp; OutDependInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (InAsset.IsEmpty())</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  FStringAssetReference AssetRef = FStringAssetReference(InAsset);</span><br><span class="line">  <span class="keyword">if</span> (!AssetRef.IsValid())</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  FAssetRegistryModule&amp; AssetRegistryModule = FModuleManager::LoadModuleChecked&lt;FAssetRegistryModule&gt;(TEXT(<span class="string">&quot;AssetRegistry&quot;</span>));</span><br><span class="line"></span><br><span class="line">  FStringAssetReference InAssetRef = InAsset;</span><br><span class="line">  FString TargetLongPackageName = InAssetRef.GetLongPackageName();</span><br><span class="line">  UE_LOG(LogTemp, Log, TEXT(<span class="string">&quot;TargetLongPackageName is %s.&quot;</span>), *TargetLongPackageName);</span><br><span class="line">  <span class="keyword">if</span> (FPackageName::DoesPackageExist(TargetLongPackageName))</span><br><span class="line">  &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      TArray&lt;FAssetData&gt; AssetDataList;</span><br><span class="line">      <span class="keyword">bool</span> bResault = AssetRegistryModule.Get().GetAssetsByPackageName(FName(*TargetLongPackageName), AssetDataList);</span><br><span class="line">      <span class="keyword">if</span> (!bResault || !AssetDataList.Num())</span><br><span class="line">      &#123;</span><br><span class="line">        UE_LOG(LogTemp, Error, TEXT(<span class="string">&quot;Faild to Parser AssetData of %s, please check.&quot;</span>), *TargetLongPackageName);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (AssetDataList.Num() &gt; <span class="number">1</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        UE_LOG(LogTemp, Warning, TEXT(<span class="string">&quot;Got mulitple AssetData of %s,please check.&quot;</span>), *TargetLongPackageName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    UFlibAssetManageHelper::GatherAssetDependicesInfoRecursively(AssetRegistryModule, TargetLongPackageName, OutDependInfo.InContent, OutDependInfo.InOther);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以写个递归获取的函数:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibAssetManageHelper::GatherAssetDependicesInfoRecursively</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  FAssetRegistryModule&amp; InAssetRegistryModule,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> FString&amp; InTargetLongPackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">  TArray&lt;FString&gt;&amp; OutDependInContent,</span></span></span><br><span class="line"><span class="function"><span class="params">  TArray&lt;FString&gt;&amp; OutDependInOther</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  TArray&lt;FName&gt; local_Dependencies;</span><br><span class="line">  <span class="keyword">bool</span> bGetDependenciesSuccess = InAssetRegistryModule.Get().GetDependencies(FName(*InTargetLongPackageName), local_Dependencies, EAssetRegistryDependencyType::Packages);</span><br><span class="line">  <span class="keyword">if</span> (bGetDependenciesSuccess)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;DependItem : local_Dependencies)</span><br><span class="line">    &#123;</span><br><span class="line">      FString LongDependentPackageName = DependItem.ToString();</span><br><span class="line">      <span class="keyword">if</span> (LongDependentPackageName.StartsWith(TEXT(<span class="string">&quot;/Game&quot;</span>)))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (OutDependInContent.Find(LongDependentPackageName) == INDEX_NONE)</span><br><span class="line">        &#123;</span><br><span class="line">          OutDependInContent.Add(LongDependentPackageName);</span><br><span class="line">          GatherAssetDependicesInfoRecursively(InAssetRegistryModule, LongDependentPackageName, OutDependInContent, OutDependInOther);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (OutDependInOther.Find(LongDependentPackageName) == INDEX_NONE)</span><br><span class="line">        &#123;</span><br><span class="line">          OutDependInOther.Add(LongDependentPackageName);</span><br><span class="line">          GatherAssetDependicesInfoRecursively(InAssetRegistryModule, LongDependentPackageName, OutDependInContent, OutDependInOther);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用方法:<br><img data-src="index/UE4/ue-get-asset-dependencies-in-bp.webp"></p>
<p>运行结果:</p>
<p><img data-src="index/UE4/ue-get-asset-dependencies-in-bp-print.webp"></p>
<h2 id="Android屏幕方向"><a href="#Android屏幕方向" class="headerlink" title="Android屏幕方向"></a>Android屏幕方向</h2><p>在<code>Project Setting</code>-<code>Platforms</code>-<code>Android</code>-<code>APK Packageing</code>-<code>Orientation</code>：<br><img data-src="index/UE4/ue4-android-screen-rotate.webp"></p>
<h2 id="SoftClassReference"><a href="#SoftClassReference" class="headerlink" title="SoftClassReference"></a>SoftClassReference</h2><p>在UE中可以使用<code>SoftClassReference</code>保持资源的相对引用，其存储的是资源的<strong>路径</strong>而不是直接对类的引用，如果直接使用<code>UClass</code>是硬引用，如果需要动态加载某些资源，如果之前使用的是硬引用则会Crash。</p>
<ul>
<li><code>/Game</code>代表工程文件夹的Content目录</li>
<li><code>/Engine</code>代表引擎目录下的<code>Content</code>目录</li>
<li>C++类的资源路径是<code>/Script/MODULE_NAME.CLASS_NAME</code></li>
</ul>
<p>如</p>
<ol>
<li><code>AActor</code>的SoftrClassReference的路径是:<code>/Script/Engine.Actor</code></li>
<li><code>AActorController</code>的SoftClassReference的路径是<code>/Script/AIModule.AIController</code></li>
</ol>
<ul>
<li>BP类的资源路径和C++不同，是资源相对于Content的路径+<code>BP_CLASS_NAME_C</code></li>
</ul>
<p>如：有一个蓝图<code>Content/Pak/Cube.uasset</code>，其的SoftClassReference路径为<code>/Game/Pak/Cube.Cube_C</code>。</p>
<h2 id="Http下载文件"><a href="#Http下载文件" class="headerlink" title="Http下载文件"></a>Http下载文件</h2><p>可以使用UE4的HTTP模块使用GET方法来从网络获取文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlibHttpHeler.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IHttpRequest.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Kismet/BlueprintFunctionLibrary.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;FlibHttpHelper.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">DECLARE_DYNAMIC_DELEGATE_OneParam(FOnRequestSuccessed,<span class="keyword">const</span> TArray&lt;uint8&gt;&amp;,ResponseContent);</span><br><span class="line">DECLARE_DYNAMIC_DELEGATE_TwoParams(FOnRequestFailed, FString, ErrorText, int32, ErrorCode);</span><br><span class="line"></span><br><span class="line">UCLASS()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWORLD_API</span> <span class="title">UFlibHttpHelper</span> :</span> <span class="keyword">public</span> UBlueprintFunctionLibrary</span><br><span class="line">&#123;</span><br><span class="line">	GENERATED_BODY()</span><br><span class="line"></span><br><span class="line">	UFUNCTION(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">HttpDownloadRequest</span><span class="params">(<span class="keyword">const</span> FString&amp; URL, FOnRequestSuccessed OnSuccessed, FOnRequestFailed OnFaild)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnRequestContentReady</span><span class="params">(FHttpRequestPtr Request,FHttpResponsePtr Response,<span class="keyword">bool</span> Successed,FOnRequestSuccessed OnSuccessed, FOnRequestFailed OnFaild)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FlibHttpHelper.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;FlibHttpHelper.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;HttpModule.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IHttpRequest.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;IHttpResponse.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibHttpHelper::HttpDownloadRequest</span><span class="params">(<span class="keyword">const</span> FString&amp; URL, FOnRequestSuccessed OnSuccessed, FOnRequestFailed OnFaild)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TSharedRef&lt;<span class="class"><span class="keyword">class</span> <span class="title">IHttpRequest</span>&gt; <span class="title">HttpRequest</span> = <span class="title">FHttpModule</span>:</span>:Get().CreateRequest();</span><br><span class="line">	HttpRequest-&gt;OnProcessRequestComplete().BindStatic(UFlibHttpHelper::OnRequestContentReady, OnSuccessed, OnFaild);</span><br><span class="line">	HttpRequest-&gt;SetURL(*URL);</span><br><span class="line">	HttpRequest-&gt;SetVerb(TEXT(<span class="string">&quot;Get&quot;</span>));</span><br><span class="line">	HttpRequest-&gt;ProcessRequest();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UFlibHttpHelper::OnRequestContentReady</span><span class="params">(FHttpRequestPtr Request, FHttpResponsePtr Response, <span class="keyword">bool</span> Successed, FOnRequestSuccessed OnSuccessed, FOnRequestFailed OnFaild)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!Successed || !Response.IsValid())</span><br><span class="line">	&#123;</span><br><span class="line">		OnFaild.ExecuteIfBound(TEXT(<span class="string">&quot;Faild&quot;</span>), <span class="number">-1</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	int32 ResponseCode = Response-&gt;GetResponseCode();</span><br><span class="line">	<span class="keyword">if</span> (!EHttpResponseCodes::IsOk(ResponseCode))</span><br><span class="line">	&#123;</span><br><span class="line">		OnFaild.ExecuteIfBound(FString::Printf(TEXT(<span class="string">&quot;HttpDownloadRequest faild, Respose Code is %d.&quot;</span>),ResponseCode), ResponseCode);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	TArray&lt;uint8&gt; ResponseContent = Response-&gt;GetContent();</span><br><span class="line">	OnSuccessed.ExecuteIfBound(ResponseContent);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Mount-pak-in-Runtime"><a href="#Mount-pak-in-Runtime" class="headerlink" title="Mount pak in Runtime"></a>Mount pak in Runtime</h2><p>前面的笔记中提到，UE的项目打包后会自动加载三个路径下的<code>Paks/</code>下的所有Pak文件，为了热更新的需求，需要在运行时自己指定加载Pak，翻了一下代码，可以写了个挂载的函数。</p>
<blockquote>
<p>注意！注意！注意！在编辑器模式下运行无作用，没有任何逻辑，因为编辑器模式也不需要加载Pak，引擎里部分逻辑在编辑器模式下不执行，如果非要在编辑器下Mount引擎会Crash，以Standalone模式运行也一样，都属于编辑器模式。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MountPak</span><span class="params">(<span class="keyword">const</span> FString&amp; PakPath, int32 PakOrder, <span class="keyword">const</span> FString&amp; InMountPoint)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> bMounted = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !WITH_EDITOR</span></span><br><span class="line">	FPakPlatformFile* PakFileMgr=(FPakPlatformFile*)FPlatformFileManager::Get().GetPlatformFile(FPakPlatformFile::GetTypeName());</span><br><span class="line">	<span class="keyword">if</span> (!PakFileMgr)</span><br><span class="line">	&#123;</span><br><span class="line">		UE_LOG(LogTemp, Log, TEXT(<span class="string">&quot;GetPlatformFile(TEXT(\&quot;PakFile\&quot;) is NULL&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	PakOrder = FMath::Max(<span class="number">0</span>, PakOrder);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (FPaths::FileExists(PakPath) &amp;&amp; FPaths::GetExtension(PakPath) == TEXT(<span class="string">&quot;pak&quot;</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">const</span> TCHAR* MountPount = InMountPoint.GetCharArray().GetData();</span><br><span class="line">		<span class="keyword">if</span> (PakFileMgr-&gt;Mount(*PakPath, PakOrder,MountPount))</span><br><span class="line">		&#123;</span><br><span class="line">			UE_LOG(LogTemp, Log, TEXT(<span class="string">&quot;Mounted = %s, Order = %d, MountPoint = %s&quot;</span>), *PakPath, PakOrder, !MountPount ? TEXT(<span class="string">&quot;(NULL)&quot;</span>) : MountPount);</span><br><span class="line">			bMounted = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			UE_LOG(LogTemp, Error, TEXT(<span class="string">&quot;Faild to mount pak = %s&quot;</span>), *PakPath);</span><br><span class="line">			bMounted = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> bMounted;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Patch的挂载和资源加载"><a href="#Patch的挂载和资源加载" class="headerlink" title="Patch的挂载和资源加载"></a>Patch的挂载和资源加载</h2><p>这两天在看UE打包Patch作为热更的方案，UE打包Patch的逻辑是这样的：</p>
<ol>
<li>如果在版本1.0中，场景<code>Scene01</code>中对资源A有直接引用（放在场景中），在修改了A资源之后，打包Patch0.1，想要让场景<code>Scene01</code>中资源A的改动也生效，则需要把<code>Scene01</code>也需要打到Patch中，因为是直接放置在场景中的，场景记录了该资源A的引用信息，这个不会随着资源A的更新而更新，加载时会产生<code>AsyncLoading.cpp</code>中的报错。</li>
</ol>
<p><img data-src="index/UE4/Patch/unreal-load-patch-asset.webp"></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[2019.11.13-06.03.27:766][ 68]LogLinker: Warning: The file &#x27;../../../GWorld/Content/PAK/Cube.uasset&#x27; contains unrecognizable data, check that it is of the expected type.</span><br><span class="line">[2019.11.13-06.03.27:770][ 68]LogStreaming: Error: ****DumpDependencies [Dependencies]:</span><br><span class="line">[2019.11.13-06.03.27:771][ 68]LogStreaming: Error:     Export 8 /Game/Map2.Map2:PersistentLevel.Cube_2</span><br><span class="line">[2019.11.13-06.03.27:772][ 68]LogStreaming: Error:     Linker is ../../../GWorld/Content/Map2.umap</span><br><span class="line">[2019.11.13-06.03.27:774][ 68]LogStreaming: Error:         Dep C_BEFORE_S Export    38    /Game/Map2.Map2:PersistentLevel.Cube_2.Cube     (class StaticMeshComponent)</span><br><span class="line">[2019.11.13-06.03.27:774][ 68]LogStreaming: Error:         Dep C_BEFORE_S Export    29    /Game/Map2.Map2:PersistentLevel.Cube_2.DefaultSceneRoot     (class SceneComponent)</span><br><span class="line">[2019.11.13-06.03.27:775][ 68]LogStreaming: Error:         Dep S_BEFORE_C Import     3   /Game/PAK/Cube.Cube_C</span><br><span class="line">[2019.11.13-06.03.27:776][ 68]LogStreaming: Error:         Dep S_BEFORE_C Import    42   /Game/PAK/Cube.Default__Cube_C</span><br><span class="line">[2019.11.13-06.03.27:776][ 68]LogStreaming: Error:         Dep C_BEFORE_C Export    23    /Game/Map2.Map2:PersistentLevel     (class Level)</span><br><span class="line">[2019.11.13-06.03.27:777][ 68]LogStreaming: Error: Missing Dependency, request for /Game/PAK/Cube.Cube_C but it hasn&#x27;t been created yet.</span><br><span class="line">[2019.11.13-06.03.27:778][ 68]LogStreaming: Error: Could not find class Cube_C to create Cube_2</span><br><span class="line">[2019.11.13-06.03.27:778][ 68]LogStreaming: Error: Could not find outer Cube_2 to create DefaultSceneRoot</span><br><span class="line">[2019.11.13-06.03.27:779][ 68]LogStreaming: Error: Could not find outer Cube_2 to create Cube</span><br></pre></td></tr></table></figure>

<p>解决这个问题的办法是通过<code>SoftClassReference</code>动态加载资源，比如直接<code>SpawnActorFromClass</code>直接指定Class为具体的类也是会产生上面的错误，但是用<code>SoftClassReference</code>可以避免这个错误（因为<code>SoftClassReference</code>本质就是存了个路径）：<br><img data-src="index/UE4/Patch/ue4-dynamic-load-asset.webp"></p>
<ol start="2">
<li>如果在版本1.0中，资源A引用了其他资源B，在Patch1.0中将资源A中引用的B换为了资源C，则该Patch的pak中会有资源A/B/C三个，因为资源的引用关系变了，但是如果不改动引用关系只是改动B中的信息，然后只Patch资源B是可以的。</li>
</ol>
<p>直接使用<code>Unreal.pak</code>将<code>Cooked</code>的资源打包为<code>pak</code>文件需要注意一点：修改Mount的路径。<br>如果说直接使用下列命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ UnrealPak.exe New_0_P.pak -create=D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK</span><br></pre></td></tr></table></figure>
<p>则打出来的pak的Mount路径为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK</span><br></pre></td></tr></table></figure>
<p>而查看使用引擎打包的Pak和patch的pak都是相对路径的，这个性格对路径就是UE的工程里资源的路径：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">D:\GWorldPackage\WindowsNoEditor\GWorld\Content\Paks&gt;UnrealPak.exe GWorld-WindowsNoEditor.pak -<span class="built_in">list</span></span><br><span class="line">LogPaths: Warning: No paths <span class="keyword">for</span> game localization data were specifed in the game configuration.</span><br><span class="line">LogPakFile: Display: Using command line <span class="keyword">for</span> crypto configuration</span><br><span class="line">LogPakFile: Display: Added <span class="number">0</span> entries to add to pak file.</span><br><span class="line">LogPakFile: Display: Mount point ../../../</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;Engine/Content/BasicShapes/BasicShapeMaterial.uasset&quot;</span> offset: <span class="number">0</span>, size: <span class="number">749</span> bytes, sha1: E028879C8856192DC648EA4C422C145E38951DA9, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;Engine/Content/EditorMaterials/PreviewShadowIndicator.uasset&quot;</span> offset: <span class="number">819</span>, size: <span class="number">496</span> bytes, sha1: <span class="number">80B</span>CDD2FF2674FED35763CD6A8C93C5A0EC27442, compression: Zlib.</span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/AssetRegistry.bin&quot;</span> offset: <span class="number">16928768</span>, size: <span class="number">2759</span> bytes, sha1: <span class="number">35E6</span>A5C7667C23FDDFD1F3BDC5535FA4E3BFF24F, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Config/DefaultEngine.ini&quot;</span> offset: <span class="number">16932864</span>, size: <span class="number">2378</span> bytes, sha1: <span class="number">7E33</span>CA6CC805CC1A6E2FF84EF3010CEACBF99E04, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Config/DefaultGame.ini&quot;</span> offset: <span class="number">16935312</span>, size: <span class="number">523</span> bytes, sha1: DDD788C5E2C9446AB11E2C8BC7D83EA24CB85AA9, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Config/DefaultInput.ini&quot;</span> offset: <span class="number">16935905</span>, size: <span class="number">753</span> bytes, sha1: <span class="number">6</span>C03DCDAE9605BEB9CB2EB250631D6AA2C2A4336, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2.uexp&quot;</span> offset: <span class="number">16936960</span>, size: <span class="number">339962</span> bytes, sha1: <span class="number">6605</span>D83E8355CC2B4D20DE31C3D6182324BA556C, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2.umap&quot;</span> offset: <span class="number">17278976</span>, size: <span class="number">5541</span> bytes, sha1: A400A39FD85529E832750CB481D9F845E4C4A74B, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2_BuiltData.uasset&quot;</span> offset: <span class="number">17285120</span>, size: <span class="number">795</span> bytes, sha1: <span class="number">1388</span>AE2CCFA55587DD0A3120CA9679AAF8FC9336, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2_BuiltData.ubulk&quot;</span> offset: <span class="number">17287168</span>, size: <span class="number">8637</span> bytes, sha1: <span class="number">7</span>D8E7AE0D100415553DF6F222B9C35EBACF4BE28, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/Map2_BuiltData.uexp&quot;</span> offset: <span class="number">17297408</span>, size: <span class="number">586603</span> bytes, sha1: <span class="number">3B</span>776E46005F6A4BEECA505674ED7FB0B8C432D6, compression: Zlib.</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Content/ShaderArchive-GWorld-PCD3D_SM5.ushaderbytecode&quot;</span> offset: <span class="number">23377920</span>, size: <span class="number">1207165</span> bytes, sha1: <span class="number">44474138</span>CD033FEF89EDFA86A480E569615A8850, compression: None.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/GWorld.uproject&quot;</span> offset: <span class="number">24585135</span>, size: <span class="number">323</span> bytes, sha1: D2E183A541A10DEEC5C87533400FFC0E89CA3B83, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/GWorld.upluginmanifest&quot;</span> offset: <span class="number">24586240</span>, size: <span class="number">5022</span> bytes, sha1: CFDB721323DABBA1C7C7ABE6CB967852EA2AC23B, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/LowEntryExtStdLib/LowEntryExtStdLib.uplugin&quot;</span> offset: <span class="number">24591332</span>, size: <span class="number">434</span> bytes, sha1: <span class="number">5</span>CD75BB5212731BEA8E0A552C99B69B259FA489C, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/UIFramework/UIFramework.uplugin&quot;</span> offset: <span class="number">24591836</span>, size: <span class="number">236</span> bytes, sha1: C9426AD575AA6ADECEF5C1AE79CF4A49304C3350, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;GWorld/Plugins/VaRestPlugin/VaRestPlugin.uplugin&quot;</span> offset: <span class="number">24592384</span>, size: <span class="number">393</span> bytes, sha1: <span class="number">28B</span>9C2F3CEB767F4A8D5D466CB8C6EEF772CDA43, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="number">1257</span> files (<span class="number">24050765</span> bytes), (<span class="number">0</span> filtered bytes).</span><br><span class="line">LogPakFile: Display: Unreal pak executed in <span class="number">1.746391</span> seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>是可以通过<code>UnrealPak.exe</code>的<code>-create</code>来指定一个txt文件来指定某个资源的绝对路径换算为相对路径：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK\BasicShapeMaterial_3.uasset&quot; &quot;../../../GWorld/Content/PAK/BasicShapeMaterial_3.uasset&quot; -compress</span><br><span class="line">&quot;D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\PAK\BasicShapeMaterial_3.uexp&quot; &quot;../../../GWorld/Content/PAK/BasicShapeMaterial_3.uexp&quot; -compress</span><br></pre></td></tr></table></figure>

<p>可以看作有数列的表，第一列是资源的<strong>绝对路径</strong>，第二列是<strong>该绝对路径资源对应的相对路径</strong>，后面是<strong>参数</strong>（可以是<code>-compress</code>/<code>-encrypt</code>），生成的代码在<code>Source/Programs/AutomationTool/Script/CopyBuildToStagingDirectory.Automation.cs</code>中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">D:\&gt;UnrealPak.exe D:\NEW_6_P.pak -create=<span class="string">&quot;D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\New.txt&quot;</span></span><br><span class="line">LogPaths: Warning: No paths <span class="keyword">for</span> game localization data were specifed <span class="keyword">in</span> the game configuration.</span><br><span class="line">LogPakFile: Display: Using <span class="built_in">command</span> line <span class="keyword">for</span> crypto configuration</span><br><span class="line">LogPakFile: Display: Loading response file D:\GWorldClient\Saved\Cooked\WindowsNoEditor\GWorld\Content\New.txt</span><br><span class="line">LogPakFile: Display: Added 2 entries to add to pak file.</span><br><span class="line">LogPakFile: Display: Collecting files to add to pak file...</span><br><span class="line">LogPakFile: Display: Collected 2 files <span class="keyword">in</span> 0.00s.</span><br><span class="line">LogPakFile: Display: Encrypting using embedded key</span><br><span class="line">LogPakFile: Display: Added 2 files, 8549 bytes total, time 0.00s.</span><br><span class="line">LogPakFile: Display: Compression summary: 13.27% of original size. Compressed Size 7981 bytes, Original Size 60159 bytes.</span><br><span class="line">LogPakFile: Display: Encryption - DISABLED</span><br><span class="line">LogPakFile: Display: Unreal pak executed <span class="keyword">in</span> 0.010672 seconds</span><br></pre></td></tr></table></figure>

<p>检查打包出来的<code>New_6_P.pak</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">D:\&gt;UnrealPak.exe NEW_6_P.pak -list</span><br><span class="line">LogPaths: Warning: No paths <span class="keyword">for</span> game localization data were specifed <span class="keyword">in</span> the game configuration.</span><br><span class="line">LogPakFile: Display: Using <span class="built_in">command</span> line <span class="keyword">for</span> crypto configuration</span><br><span class="line">LogPakFile: Display: Added 0 entries to add to pak file.</span><br><span class="line">LogPakFile: Display: Mount point ../../../GWorld/Content/PAK/</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;BasicShapeMaterial_3.uasset&quot;</span> offset: 0, size: 753 bytes, sha1: 63E00757694E91070403390CFB808829E13D01FF, compression: Zlib.</span><br><span class="line">LogPakFile: Display: <span class="string">&quot;BasicShapeMaterial_3.uexp&quot;</span> offset: 823, size: 7228 bytes, sha1: BD3C0B302FC49790327CF804F2B644F01A14EFCD, compression: Zlib.</span><br><span class="line">LogPakFile: Display: 2 files (7981 bytes), (0 filtered bytes).</span><br><span class="line">LogPakFile: Display: Unreal pak executed <span class="keyword">in</span> 0.001987 seconds</span><br></pre></td></tr></table></figure>

<p>可以看到变成了相对路径了。</p>
<h2 id="引擎启动时Pak的加载"><a href="#引擎启动时Pak的加载" class="headerlink" title="引擎启动时Pak的加载"></a>引擎启动时Pak的加载</h2><p>当在UE的<code>Project Setting</code>里<code>Project</code>-<code>Packaging</code>-<code>UsePakFile</code>启用时，会打包出来<code>pak</code>文件，以<code>Windows</code>平台为例，打包出来的<code>pak</code>路径为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WindowsNoEditor/PROJECT_NAME/Content/Paks</span><br></pre></td></tr></table></figure>
<p>该目录下的<code>pak</code>文件在游戏启动时会自动加载，在引擎的<code>FEngineLoop::PreInit</code>中调用<code>LaunchCheckForFileOverride</code>(<code>LaunchEngineLoop.cpp</code>)又调用<code>ConditionallyCreateFileWrapper</code>来加载<code>PakFile</code>的<code>PlatformFile</code>，但是在<code>ConditionallyCreateFileWrapper</code>的代码中做了一层<code>WrapperFile-&gt;ShouldBeUsed</code>判断：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Launch/Private/LaunchEngineLoop.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> IPlatformFile* <span class="title">ConditionallyCreateFileWrapper</span><span class="params">(<span class="keyword">const</span> TCHAR* Name, IPlatformFile* CurrentPlatformFile, <span class="keyword">const</span> TCHAR* CommandLine, <span class="keyword">bool</span>* OutFailedToInitialize = <span class="literal">nullptr</span>, <span class="keyword">bool</span>* bOutShouldBeUsed = <span class="literal">nullptr</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (OutFailedToInitialize)</span><br><span class="line">	&#123;</span><br><span class="line">		*OutFailedToInitialize = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( bOutShouldBeUsed )</span><br><span class="line">	&#123;</span><br><span class="line">		*bOutShouldBeUsed = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	IPlatformFile* WrapperFile = FPlatformFileManager::Get().GetPlatformFile(Name);</span><br><span class="line">	<span class="keyword">if</span> (WrapperFile != <span class="literal">nullptr</span> &amp;&amp; WrapperFile-&gt;ShouldBeUsed(CurrentPlatformFile, CommandLine))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ( bOutShouldBeUsed )</span><br><span class="line">		&#123;</span><br><span class="line">			*bOutShouldBeUsed = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (WrapperFile-&gt;Initialize(CurrentPlatformFile, CommandLine) == <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (OutFailedToInitialize)</span><br><span class="line">			&#123;</span><br><span class="line">				*OutFailedToInitialize = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Don&#x27;t delete the platform file. It will be automatically deleted by its module.</span></span><br><span class="line">			WrapperFile = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Make sure it won&#x27;t be used.</span></span><br><span class="line">		WrapperFile = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> WrapperFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果为<code>false</code>不会对该<code>PlatformFile</code>调用<code>Initialize</code>，而<code>FPakPlatformFile</code>的一些成员就是在这里被设置的。<code>FPakPlatformFile::ShoubleBeUsed</code>的定义如下(UE_4.22.3)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/PakFile/Private/IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPakPlatformFile::ShouldBeUsed</span><span class="params">(IPlatformFile* Inner, <span class="keyword">const</span> TCHAR* CmdLine)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> Result = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !WITH_EDITOR</span></span><br><span class="line">	<span class="keyword">if</span> (!FParse::Param(CmdLine, TEXT(<span class="string">&quot;NoPak&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		TArray&lt;FString&gt; PakFolders;</span><br><span class="line">		GetPakFolders(CmdLine, PakFolders);</span><br><span class="line">		Result = CheckIfPakFilesExist(Inner, PakFolders);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编辑器模式下直接就是false，即编辑器模式下不可以使用pak的<code>mount</code>操作，因为<code>mount</code>中需要用到<code>LowerLevel</code>成员，而该成员在<code>FPakPlatformFile::Initialize</code>中被设置，所以不可以调用mount，否则必Crash。</p>
<p>Mount所有pak的相关代码在：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPakPlatformFile::Initialize</span><span class="params">(IPlatformFile* Inner, <span class="keyword">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  LLM_SCOPE(ELLMTag::FileSystem);</span><br><span class="line">  SCOPED_BOOT_TIMING(<span class="string">&quot;FPakPlatformFile::Initialize&quot;</span>);</span><br><span class="line">  <span class="comment">// Inner is required.</span></span><br><span class="line">  check(Inner != <span class="literal">NULL</span>);</span><br><span class="line">  LowerLevel = Inner;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> EXCLUDE_NONPAK_UE_EXTENSIONS</span></span><br><span class="line">  <span class="comment">// Extensions for file types that should only ever be in a pak file. Used to stop unnecessary access to the lower level platform file</span></span><br><span class="line">  ExcludedNonPakExtensions.Add(TEXT(<span class="string">&quot;uasset&quot;</span>));</span><br><span class="line">  ExcludedNonPakExtensions.Add(TEXT(<span class="string">&quot;umap&quot;</span>));</span><br><span class="line">  ExcludedNonPakExtensions.Add(TEXT(<span class="string">&quot;ubulk&quot;</span>));</span><br><span class="line">  ExcludedNonPakExtensions.Add(TEXT(<span class="string">&quot;uexp&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISABLE_NONUFS_INI_WHEN_COOKED</span></span><br><span class="line">  IniFileExtension = TEXT(<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line">  GameUserSettingsIniFilename = TEXT(<span class="string">&quot;GameUserSettings.ini&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// signed if we have keys, and are not running with fileopenlog (currently results in a deadlock).</span></span><br><span class="line">  bSigned = GetPakSigningKey().IsValid() &amp;&amp; !FParse::Param(FCommandLine::Get(), TEXT(<span class="string">&quot;fileopenlog&quot;</span>));;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Find and mount pak files from the specified directories.</span></span><br><span class="line">  TArray&lt;FString&gt; PakFolders;</span><br><span class="line">  GetPakFolders(FCommandLine::Get(), PakFolders);</span><br><span class="line">  MountAllPakFiles(PakFolders);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  GPakExec = MakeUnique&lt;FPakExec&gt;(*<span class="keyword">this</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !UE_BUILD_SHIPPING</span></span></span><br><span class="line"></span><br><span class="line">  FCoreDelegates::OnMountAllPakFiles.BindRaw(<span class="keyword">this</span>, &amp;FPakPlatformFile::MountAllPakFiles);</span><br><span class="line">  FCoreDelegates::OnMountPak.BindRaw(<span class="keyword">this</span>, &amp;FPakPlatformFile::HandleMountPakDelegate);</span><br><span class="line">  FCoreDelegates::OnUnmountPak.BindRaw(<span class="keyword">this</span>, &amp;FPakPlatformFile::HandleUnmountPakDelegate);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(IS_PROGRAM || WITH_EDITOR)</span></span><br><span class="line">  FCoreDelegates::OnFEngineLoopInitComplete.AddLambda([<span class="keyword">this</span>] &#123;</span><br><span class="line">      FPlatformMisc::LowLevelOutputDebugStringf(TEXT(<span class="string">&quot;Checking Pak Config&quot;</span>));</span><br><span class="line">      <span class="keyword">bool</span> bUnloadPakEntryFilenamesIfPossible = <span class="literal">false</span>;</span><br><span class="line">      GConfig-&gt;GetBool(TEXT(<span class="string">&quot;Pak&quot;</span>), TEXT(<span class="string">&quot;UnloadPakEntryFilenamesIfPossible&quot;</span>), bUnloadPakEntryFilenamesIfPossible, GEngineIni);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (bUnloadPakEntryFilenamesIfPossible)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// With [Pak] UnloadPakEntryFilenamesIfPossible enabled, [Pak] DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames</span></span><br><span class="line">        <span class="comment">// can contain pak entry directory wildcards of which the entire recursive directory structure of filenames underneath a</span></span><br><span class="line">        <span class="comment">// matching wildcard will be kept.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Example:</span></span><br><span class="line">        <span class="comment">//   [Pak]</span></span><br><span class="line">        <span class="comment">//   DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames=&quot;*/Config/Tags/&quot;</span></span><br><span class="line">        <span class="comment">//   +DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames=&quot;*/Content/Localization/*&quot;</span></span><br><span class="line">        TArray&lt;FString&gt; DirectoryRootsToKeep;</span><br><span class="line">        GConfig-&gt;GetArray(TEXT(<span class="string">&quot;Pak&quot;</span>), TEXT(<span class="string">&quot;DirectoryRootsToKeepInMemoryWhenUnloadingPakEntryFilenames&quot;</span>), DirectoryRootsToKeep, GEngineIni);</span><br><span class="line"></span><br><span class="line">        FPakPlatformFile* PakPlatformFile = (FPakPlatformFile*)(FPlatformFileManager::Get().FindPlatformFile(FPakPlatformFile::GetTypeName()));</span><br><span class="line">        PakPlatformFile-&gt;UnloadPakEntryFilenames(&amp;DirectoryRootsToKeep);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">bool</span> bShrinkPakEntriesMemoryUsage = <span class="literal">false</span>;</span><br><span class="line">      GConfig-&gt;GetBool(TEXT(<span class="string">&quot;Pak&quot;</span>), TEXT(<span class="string">&quot;ShrinkPakEntriesMemoryUsage&quot;</span>), bShrinkPakEntriesMemoryUsage, GEngineIni);</span><br><span class="line">      <span class="keyword">if</span> (bShrinkPakEntriesMemoryUsage)</span><br><span class="line">      &#123;</span><br><span class="line">        FPakPlatformFile* PakPlatformFile = (FPakPlatformFile*)(FPlatformFileManager::Get().FindPlatformFile(FPakPlatformFile::GetTypeName()));</span><br><span class="line">        PakPlatformFile-&gt;ShrinkPakEntriesMemoryUsage();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> !!LowerLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UE自动加载的pak路径：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FPakPlatformFile::GetPakFolders</span><span class="params">(<span class="keyword">const</span> TCHAR* CmdLine, TArray&lt;FString&gt;&amp; OutPakFolders)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !UE_BUILD_SHIPPING</span></span><br><span class="line">  <span class="comment">// Command line folders</span></span><br><span class="line">  FString PakDirs;</span><br><span class="line">  <span class="keyword">if</span> (FParse::Value(CmdLine, TEXT(<span class="string">&quot;-pakdir=&quot;</span>), PakDirs))</span><br><span class="line">  &#123;</span><br><span class="line">    TArray&lt;FString&gt; CmdLineFolders;</span><br><span class="line">    PakDirs.ParseIntoArray(CmdLineFolders, TEXT(<span class="string">&quot;*&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">    OutPakFolders.Append(CmdLineFolders);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// @todo plugin urgent: Needs to handle plugin Pak directories, too</span></span><br><span class="line">  <span class="comment">// Hardcoded locations</span></span><br><span class="line">  OutPakFolders.Add(FString::Printf(TEXT(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::ProjectContentDir()));</span><br><span class="line">  OutPakFolders.Add(FString::Printf(TEXT(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::ProjectSavedDir()));</span><br><span class="line">  OutPakFolders.Add(FString::Printf(TEXT(<span class="string">&quot;%sPaks/&quot;</span>), *FPaths::EngineContentDir()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在非<code>Shipping</code>打包的时候可以通过才命令行加启动参数<code>-pakdir</code>来添加额外的pak路径。</p>
<p>引擎默认添加的路径为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># relative to Project Path</span><br><span class="line">Content/Paks/</span><br><span class="line">Saved/Paks/</span><br><span class="line"># relative to Engine Path</span><br><span class="line">Content/Paks</span><br></pre></td></tr></table></figure>
<p>之后又调用了<code>FPakPlatformFile::MountAllPakFiles</code>来把挂载所有pak（默认对pak的名字进行了个降序排序，但是这里的排序没用），在该函数中<code>mount</code>的时候会给不同的路径加载的<code>pak</code>设置不同的<code>Order</code>，其函数在：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function">int32 <span class="title">FPakPlatformFile::GetPakOrderFromPakFilePath</span><span class="params">(<span class="keyword">const</span> FString&amp; PakFilePath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (PakFilePath.StartsWith(FString::Printf(TEXT(<span class="string">&quot;%sPaks/%s-&quot;</span>), *FPaths::ProjectContentDir(), FApp::GetProjectName())))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.StartsWith(FPaths::ProjectContentDir()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.StartsWith(FPaths::EngineContentDir()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (PakFilePath.StartsWith(FPaths::ProjectSavedDir()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>概括来说：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># relative to project path</span><br><span class="line">4 Content/Paks/PROJECT_NAME-*.pak</span><br><span class="line">3 Content/Paks/</span><br><span class="line">1 Saved/Paks</span><br><span class="line"></span><br><span class="line"># relative to engine path</span><br><span class="line">2 Content/Paks/</span><br></pre></td></tr></table></figure>
<p>可以看到<code>Saved/Paks</code>下的<code>pak</code>文件加载的优先级是最低的。</p>
<p>在<code>Mount</code>的时候如果上述路径中有打出来Patch包，以<code>_Num_P.pak</code>结尾的文件，其中<code>Num</code>是数字，Patch包的优先级高于普通的pak，在<code>IPlatformFilePak.cpp</code>中默认给<code>_P.pak</code>的<code>PakOrder</code>加了100，<code>_P.pak</code>前面的数字越大，其加载的优先级就越高。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\PakFile\Private\IPlatformFilePak.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FPakPlatformFile::Mount</span><span class="params">(<span class="keyword">const</span> TCHAR* InPakFilename, uint32 PakOrder, <span class="keyword">const</span> TCHAR* InPath <span class="comment">/*= NULL*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bSuccess = <span class="literal">false</span>;</span><br><span class="line">  TSharedPtr&lt;IFileHandle&gt; PakHandle = MakeShareable(LowerLevel-&gt;OpenRead(InPakFilename));</span><br><span class="line">  <span class="keyword">if</span> (PakHandle.IsValid())</span><br><span class="line">  &#123;</span><br><span class="line">    FPakFile* Pak = <span class="keyword">new</span> FPakFile(LowerLevel, InPakFilename, bSigned);</span><br><span class="line">    <span class="keyword">if</span> (Pak-&gt;IsValid())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (InPath != <span class="literal">NULL</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        Pak-&gt;SetMountPoint(InPath);</span><br><span class="line">      &#125;</span><br><span class="line">      FString PakFilename = InPakFilename;</span><br><span class="line">      <span class="keyword">if</span> (PakFilename.EndsWith(TEXT(<span class="string">&quot;_P.pak&quot;</span>)))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Prioritize based on the chunk version number</span></span><br><span class="line">        <span class="comment">// Default to version 1 for single patch system</span></span><br><span class="line">        uint32 ChunkVersionNumber = <span class="number">1</span>;</span><br><span class="line">        FString StrippedPakFilename = PakFilename.LeftChop(<span class="number">6</span>);</span><br><span class="line">        int32 VersionEndIndex = PakFilename.Find(<span class="string">&quot;_&quot;</span>, ESearchCase::CaseSensitive, ESearchDir::FromEnd);</span><br><span class="line">        <span class="keyword">if</span> (VersionEndIndex != INDEX_NONE &amp;&amp; VersionEndIndex &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          int32 VersionStartIndex = PakFilename.Find(<span class="string">&quot;_&quot;</span>, ESearchCase::CaseSensitive, ESearchDir::FromEnd, VersionEndIndex - <span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> (VersionStartIndex != INDEX_NONE)</span><br><span class="line">          &#123;</span><br><span class="line">            VersionStartIndex++;</span><br><span class="line">            FString VersionString = PakFilename.Mid(VersionStartIndex, VersionEndIndex - VersionStartIndex);</span><br><span class="line">            <span class="keyword">if</span> (VersionString.IsNumeric())</span><br><span class="line">            &#123;</span><br><span class="line">              int32 ChunkVersionSigned = FCString::Atoi(*VersionString);</span><br><span class="line">              <span class="keyword">if</span> (ChunkVersionSigned &gt;= <span class="number">1</span>)</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="comment">// Increment by one so that the first patch file still gets more priority than the base pak file</span></span><br><span class="line">                ChunkVersionNumber = (uint32)ChunkVersionSigned + <span class="number">1</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        PakOrder += <span class="number">100</span> * ChunkVersionNumber;</span><br><span class="line">      &#125;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// Add new pak file</span></span><br><span class="line">        <span class="function">FScopeLock <span class="title">ScopedLock</span><span class="params">(&amp;PakListCritical)</span></span>;</span><br><span class="line">        FPakListEntry Entry;</span><br><span class="line">        Entry.ReadOrder = PakOrder;</span><br><span class="line">        Entry.PakFile = Pak;</span><br><span class="line">        PakFiles.Add(Entry);</span><br><span class="line">        PakFiles.StableSort();</span><br><span class="line">      &#125;</span><br><span class="line">      bSuccess = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (Pak-&gt;GetInfo().EncryptionKeyGuid.IsValid())</span><br><span class="line">      &#123;</span><br><span class="line">        UE_LOG(LogPakFile, Log, TEXT(<span class="string">&quot;Deferring mount of pak \&quot;%s\&quot; until encryption key &#x27;%s&#x27; becomes available&quot;</span>), InPakFilename, *Pak-&gt;GetInfo().EncryptionKeyGuid.ToString());</span><br><span class="line"></span><br><span class="line">        check(!GetRegisteredEncryptionKeys().HasKey(Pak-&gt;GetInfo().EncryptionKeyGuid));</span><br><span class="line">        FPakListDeferredEntry&amp; Entry = PendingEncryptedPakFiles[PendingEncryptedPakFiles.Add(FPakListDeferredEntry())];</span><br><span class="line">        Entry.Filename = InPakFilename;</span><br><span class="line">        Entry.Path = InPath;</span><br><span class="line">        Entry.ReadOrder = PakOrder;</span><br><span class="line">        Entry.EncryptionKeyGuid = Pak-&gt;GetInfo().EncryptionKeyGuid;</span><br><span class="line">        Entry.ChunkID = Pak-&gt;ChunkID;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">delete</span> Pak;</span><br><span class="line">        PakHandle.Reset();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        UE_LOG(LogPakFile, Warning, TEXT(<span class="string">&quot;Failed to mount pak \&quot;%s\&quot;, pak is invalid.&quot;</span>), InPakFilename);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    UE_LOG(LogPakFile, Warning, TEXT(<span class="string">&quot;Pak \&quot;%s\&quot; does not exist!&quot;</span>), InPakFilename);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外，腾讯的和平精英的热更新的pak就是放在<code>Saved/Paks</code>里面。<br><img data-src="index/UE4/ue-game-shadowtrackerextra-pak.webp"></p>
<p>而且，和平精英的apk的大小是1.6G，我下载完之后又热更新了1.2G左右的内容，总共占了3个多G…这样的apk里面obb的数据估计和外部的<code>pak</code>中的内容都是覆盖的，但是apk内容又没办法改，只能越更新越多了（但是可以在用户更新APK之后删除多余的pak）。</p>
<p>注：腾讯的吃鸡用sluaunreal，脚本的热更也是通过pak方式来加载的，这点在sluaunreal中有写：<a target="_blank" rel="noopener" href="https://github.com/Tencent/sluaunreal/issues/238">sluaunreal增量打包问题</a></p>
<p>如果从省空间的角度考虑，最好的方式就是基础apk+更新的方式修改游戏内容，但是玩家下载完apk之后还需要再更新可能会造成用户流失，这是个要考虑的问题。</p>
<h2 id="自定义蓝图节点"><a href="#自定义蓝图节点" class="headerlink" title="自定义蓝图节点"></a>自定义蓝图节点</h2><p>在蓝图中类似于<code>SpawnActor</code>或者<code>GetClassDefaults</code>之类的函数，可以根据参数的变化来改变节点的信息(如增加引脚，修改返回值类型等等)。</p>
<p>其实在蓝图中这样的节点都是继承自<code>UK2Node</code>的类，每一个节点是一个类，如<code>SpawnActor</code>它就是定义在<code>Editor/BlueprintEditor</code>下的<code>K2Node_SpawnActor</code>类。<br><code>UK2Node</code>提供了很多的方法供继承类重写，如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 鼠标指到节点上的提示信息</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FText <span class="title">GetTooltipText</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 节点在蓝图中显示的名字</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FText <span class="title">GetNodeTitle</span><span class="params">(ENodeTitleType::Type TitleType)</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 将节点添加至上下文菜单</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetMenuActions</span><span class="params">(FBlueprintActionDatabaseRegistrar&amp; ActionRegister)</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 设置节点在编辑器中右键菜单的分类</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> FText <span class="title">GetMenuCategory</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"><span class="comment">// 在编译时扩展节点，可以添加或移除节点的Pin</span></span><br><span class="line"><span class="comment">// 在这个函数中需要绑定真正需要执行的函数，注意绑定的函数要是BlueprintCallable的</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ExpandNode</span><span class="params">(FKismetCompilerContext &amp; CompilerContext, UEdGraph * SourceGraph)</span></span>;</span><br><span class="line"><span class="comment">// 当节点中的Pin信息被改变</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PinDefaultValueChanged</span><span class="params">(UEdGraphPin* ChangedPin)</span></span>;</span><br><span class="line"><span class="comment">// 给节点分配默认的Pin，如初始添加InExec和OutExec，声明在UEdGraphNode中</span></span><br><span class="line"><span class="comment">// 默认在ReallocatePinsDuringReconstruction中调用，也可以自己在ExpandNode中调用</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AllocateDefaultPins</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>上面列出的就是创建一个自定义的蓝图节点需要实现的最重要的几个函数。</p>
<p>当在蓝图中点击节点右键刷新的时候会调用到<code>ExpandNode</code>函数，如果在其中调用了<code>AllocateDefaultPins</code>要考虑从序列化中读取已有配置的问题。</p>
<p>一个例子，实现的效果为根据枚举值修改节点的参数类型：<br><img data-src="index/Show_CustomK2Node.gif"></p>
<p>代码放在了Gist：<a target="_blank" rel="noopener" href="https://gist.github.com/hxhb/d431c18592b1385574aac50eb00f8209">CustomK2Node.cpp</a></p>
<h2 id="Plugin加载时机太晚在蓝图中的错误"><a href="#Plugin加载时机太晚在蓝图中的错误" class="headerlink" title="Plugin加载时机太晚在蓝图中的错误"></a>Plugin加载时机太晚在蓝图中的错误</h2><p>如果一个<code>Runtime</code>的模块具有在蓝图中可用的函数，加载时机一定要先于<code>Default</code>，可以是<code>PreDefault</code>，不然每次打开是都会有该模块的蓝图节点找不到的错误。</p>
<h2 id="NavigationSystem获取NavData"><a href="#NavigationSystem获取NavData" class="headerlink" title="NavigationSystem获取NavData"></a>NavigationSystem获取NavData</h2><p>前面笔记中写到，UE4的寻路也是使用Recast来创建寻路网格的。所以如果要从<code>ANavigationSystemV1</code>获取到<code>Recast</code>的<code>dtNavMesh</code>可以通过下列方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先获取NavigationSystem</span></span><br><span class="line">UNavigationSystemV1 NavSys=FNavigationSystem::GetCurrent&lt;UNavigationSystemV1&gt;(GetWorld());</span><br><span class="line"><span class="comment">// 通过NavigationSytstemV1可以获取到UE封装的管理NavData的类对象ANavigationData</span></span><br><span class="line">ANavigationData NavData=NavSys-&gt;GetDefaultNavDataInstance(FNavigationSystem::DontCreate);</span><br><span class="line">ARecastNavMesh* NavMesh=Cast&lt;ARecastNavMesh&gt;(NavData);</span><br><span class="line">dtNavMesh* RecastNavMesh = NavMesh-&gt;GetRecastMesh();</span><br></pre></td></tr></table></figure>

<p>注意：在<code>UNavigationSystemV1</code>中，通过<code>GetMainNavData</code>获取的对象与<code>GetDefaultNavDataInstance</code>是同一个。</p>
<p>然后<code>ARecastNavMesh</code>是继承自<code>ANavigationData</code>的，最后可以通过<code>ARecastNavMesh::GetRecastMesh()</code>获取到引擎中真正使用的<code>dtNavMesh</code>对象。</p>
<h2 id="编译RecastNavigation"><a href="#编译RecastNavigation" class="headerlink" title="编译RecastNavigation"></a>编译RecastNavigation</h2><p>UE使用的是Recast创建的导航网格实现AI的寻路，相关的模块为<code>Navmesh</code>(修改之后的recastnavigation，RecaseDemo等也在此模块下)/<code>NavigationSystem</code>。<br>如果想要在非UE的服务端使用，也可以自己编译recastnavigation，Github上的源码地址为：<a target="_blank" rel="noopener" href="https://github.com/recastnavigation/recastnavigation">recastnavigation</a>.</p>
<p>里面写了各个平台的编译流程，我在这里简单概述一下Windows下编译流程。</p>
<ol>
<li>首先下载<a target="_blank" rel="noopener" href="https://premake.github.io/download.html">premake5</a>，并将其添加到系统PATH路径</li>
<li>clone RecastNavigation的代码</li>
<li>下载<a target="_blank" rel="noopener" href="https://www.libsdl.org/download-2.0.php">SDL2</a>（选择Development Libraries），并将其解压到<code>recastnavigation\RecastDemo\Contrib</code>目录下，将文件夹改名为<code>SDL</code>，目录结构为：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\recastnavigation\RecastDemo\Contrib\SDL&gt;tree /a</span><br><span class="line">+---docs</span><br><span class="line">+---include</span><br><span class="line">\---lib</span><br><span class="line">    +---x64</span><br><span class="line">    \---x86</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>在<code>recastnavigation\RecastDemo</code>目录下执行命令<code>premake5 vs2017</code>(vs201x取决于你当前系统中安装的版本)，它会在<code>RecastDemo</code>目录下创建<code>build/vs2017</code>目录，里面是VS项目的解决方案。<br> <img data-src="https://imzlp.com/posts/20203/recast-premake-generate-vs-solution.webp"></p>
</li>
<li><p>打开<code>RecastDemo\Build\vs2017\recastnavigation.sln</code>，编译即可。<br><img data-src="https://imzlp.com/posts/20203/build-recastnavigation.webp"></p>
</li>
<li><p>编译出来<code>RecastDemo.exe</code>位置在<code>RecastDemo\Bin</code>。</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\imzlp\<span class="built_in">source</span>\repos\recastnavigation\RecastDemo\Bin&gt;tree /a /f</span><br><span class="line">文件夹 PATH 列表</span><br><span class="line">卷序列号为 000002D0 ECDB:6872</span><br><span class="line">C:.</span><br><span class="line">|   .gitignore</span><br><span class="line">|   DroidSans.ttf</span><br><span class="line">|   RecastDemo.exe</span><br><span class="line">|   RecastDemo.pdb</span><br><span class="line">|   SDL2.dll</span><br><span class="line">|   Tests.exe</span><br><span class="line">|   Tests.pdb</span><br><span class="line">|</span><br><span class="line">+---Meshes</span><br><span class="line">|       dungeon.obj</span><br><span class="line">|       nav_test.obj</span><br><span class="line">|       undulating.obj</span><br><span class="line">|</span><br><span class="line">\---TestCases</span><br><span class="line">        movement_test.txt</span><br><span class="line">        nav_mesh_test.txt</span><br><span class="line">        raycast_test.txt</span><br></pre></td></tr></table></figure>

<p>其中关键的几个文件：<code>DroidSans.ttf</code>/<code>RecastDemo.exe</code>/<code>SDL2.dll</code>/<code>Meshs/</code>。</p>
<blockquote>
<p>注意：必须把obj文件放到<code>Meshs/</code>目录下才可以被<code>RecastDemo</code>识别。</p>
</blockquote>
<p> 之后就可以打开<code>RecastDemo.exe</code>在默认提供的三个<code>obj</code>的模型上进行导航数据生成的测试了，通过<code>Build</code>生成，然后Save保存会在<code>RecastDemo.exe</code>所在的目录产生一个<code>.bin</code>文件，即使用recast生成的导航数据。 </p>
<p><img data-src="https://imzlp.com/posts/20203/recast-navigation-RecastDemo.webp"></p>
<h2 id="UE4-Plugin-ExportNav"><a href="#UE4-Plugin-ExportNav" class="headerlink" title="UE4 Plugin:ExportNav"></a>UE4 Plugin:ExportNav</h2><p>最近有个需求需要导出UE里的寻路数据，研究了一下代码，写了一个插件:<a target="_blank" rel="noopener" href="https://github.com/hxhb/ue4-export-nav-data">ue4-export-nav-data</a></p>
<p>UE4使用的是<a target="_blank" rel="noopener" href="https://github.com/recastnavigation/recastnavigation">Recast</a>游戏寻路引擎，所以UE的寻路数据数据是<code>RecastNavMesh</code>的数据格式。</p>
<p>可以使用<a target="_blank" rel="noopener" href="https://github.com/recastnavigation/recastnavigation">Recast Navigation</a>提供的RecastDemo来打开本插件导出的Obj文件(需要clone Recast的仓库自己编译)，并构建出寻路的导航网格(使用<a target="_blank" rel="noopener" href="https://github.com/recastnavigation/recastnavigation/tree/master/Recast">Recast</a>)，之后可以使用<a target="_blank" rel="noopener" href="https://github.com/recastnavigation/recastnavigation/tree/master/Detour">Detour</a>利用前面生成的导航网格做寻路操作。</p>
<p>附上我编译好的<a href="index/UE4/Plugins/export-nav-data/RecastDemo.7z">RecastDemo</a>。</p>
<h3 id="What-is-this"><a href="#What-is-this" class="headerlink" title="What is this?"></a>What is this?</h3><p>This is a Unreal Engine 4 Plugin that export ue4 navigation mesh data(recast mesh) to outside.</p>
<h3 id="How-do-use"><a href="#How-do-use" class="headerlink" title="How do use?"></a>How do use?</h3><ol>
<li>add the plugin to the project and enable it. </li>
<li>Launch the Project in Editor, Click the <code>ExportNav</code> button. </li>
</ol>
<p><img data-src="index/UE4/Plugins/export-nav-data/ue4-export-nav-data-usage-0.webp"></p>
<p><img data-src="index/UE4/Plugins/export-nav-data/ue4-export-nav-data-usage-1.webp"></p>
<ol start="3">
<li>Open The Plugin <code>Source/ExportNav/ThirdParty/RecastDemoBin</code></li>
<li>copy <code>.obj</code> to <code>RecastDemoBin/Meshes</code></li>
<li>run <code>RecastDemo.exe</code></li>
</ol>
<p><img data-src="index/UE4/Plugins/export-nav-data/Recast-Demo-bin.webp"></p>
<h2 id="解决模块间的名字冲突"><a href="#解决模块间的名字冲突" class="headerlink" title="解决模块间的名字冲突"></a>解决模块间的名字冲突</h2><p>在写<a target="_blank" rel="noopener" href="https://github.com/hxhb/ue4-jwt">hxhb/ue4-jwt</a>插件的时候发现，在包含<code>ThridParty/OpenSSL</code>模块时，会有与<code>Core</code>模块下的名字冲突错误。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CompilerResultsLog:Error: Error \Engine\Source\ThirdParty\OpenSSL\1.0.2g\include\Win64\VS2015\openssl/ossl_typ.h(172) : error C2365: <span class="string">&#x27;UI&#x27;</span>: redefinition; previous definition was <span class="string">&#x27;namespace&#x27;</span> CompilerResultsLog:Error: Error \engine\<span class="built_in">source</span>\runtime\coreuobject\public\UObject/ObjectMacros.h(752) : note: see declaration of <span class="string">&#x27;UI&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这是因为其他的模块定义了<code>UI</code>这个标识符，而在<code>OpenSSL</code>中也定义了一个同名的描述符的不同定于，这里一个是<code>namespace</code>一个是<code>typedef</code>，在加载外部的库的时候经常会有这样的问题。可以通过下列办法解决：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UI UI_ST</span></span><br><span class="line">THIRD_PARTY_INCLUDES_START</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/evp.h&gt;</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/hmac.h&gt;</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/pem.h&gt;</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/ec.h&gt;</span></span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/err.h&gt;</span></span></span><br><span class="line">THIRD_PARTY_INCLUDES_END</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> UI</span></span><br></pre></td></tr></table></figure>
<p>将具有标识符冲突的使用宏定义为其他的，然后将第三方库包含，最后在把宏给<code>undef</code>掉，确保不被其他的代码造成影响。</p>
<h2 id="CreateProc阻塞执行"><a href="#CreateProc阻塞执行" class="headerlink" title="CreateProc阻塞执行"></a>CreateProc阻塞执行</h2><p>在使用<code>FPlatformProcess::CreateProc</code>创建进程时是异步的，创建出来的进程和当前进程执行时没有顺序关系，有时我们需要等待进程执行完毕之后再执行后续逻辑，也就是阻塞行为。</p>
<p>因为<code>FPlatformProcess::CreateProc</code>本质也是使用<code>Windows API</code>中的<code>CreateProcess</code>创建的，所以使用<code>WaitForSingleObject</code>也可以在UE中使用，需要包含<code>synchapi.h</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FProcHandle ProtocProcIns=FPlatformProcess::CreateProc(*pProtocExe, *CommandParams, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">WaitForSingleObject(ProtocProcIns.Get(), INFINITE);</span><br><span class="line">CloseHandle(ProtocProcIns.Get());</span><br></pre></td></tr></table></figure>

<p><code>WaitForSingleObject</code>第一个参数需要接收<code>PROCESS_INFORMATION </code>中的<code>hProcess</code>参数，在UE中<code>FProcHandle</code>对<code>ProcInfo.hProcess </code>做了一层封装，通过<code>FProcHandle</code>对象上调用<code>Get()</code>即可获得。<br><code>WaitForSingleObject</code>第二个参数是一个时间，为等待的时间，单位为毫秒，如果参数为0，则函数立即返回，如果为<code>INFINITE</code>则为无限等待下去直到程序退出。<br>如果等待超时，该函数返回<code>WAIT_TIMEOUT</code>。如果该函数失败，返回<code>WAIT_FAILED</code>。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2554447/how-to-use-waitforsingleobject">How to use WaitForSingleObject</a></li>
<li><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/247091/">WaitForMultipleObject与MsgWaitForMultipleObjects用法</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/laoyang360/article/details/18508131">解决CreateProcess()的等待时间问题</a></li>
</ul>
<h2 id="网络质量测试"><a href="#网络质量测试" class="headerlink" title="网络质量测试"></a>网络质量测试</h2><p>可以使用几个命令参数模拟比较差的网络环境，从而测试UE联机的网络质量和bug检测。</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><strong>PktLag</strong></td>
<td>Delays the sending of a packet by the amount of time specified in milliseconds</td>
</tr>
<tr>
<td><strong>PktLagVariance</strong></td>
<td>Provides some randomness to the amount of time a packet is delayed, +/- the amount specified in milliseconds</td>
</tr>
<tr>
<td><strong>PktLoss</strong></td>
<td>Specifies a percentage chance of an outbound packet being discarded to simulate packet loss</td>
</tr>
<tr>
<td><strong>PktDup</strong></td>
<td>Specifies a percentage chance to send a duplicate packet</td>
</tr>
<tr>
<td><strong>PktOrder</strong></td>
<td>Sends packets out of order when enabled (1 = enabled, 0 = disabled)</td>
</tr>
</tbody></table>
<p>可以通过三种不同的方式来控制：命令行参数、控制台命令以及引擎ini配置。</p>
<p>在命令行启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SettingName=Value</span><br></pre></td></tr></table></figure>

<p>在控制台设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Net SettingName=Value</span><br></pre></td></tr></table></figure>

<p>以及在引擎配置(<code>DefaultEngine.ini</code>)中：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[PacketSimulationSettings]</span></span><br><span class="line"><span class="attr">PktLag</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktLagVariance</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktLoss</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktOrder</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">PktDup</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://www.unrealengine.com/en-US/blog/finding-network-based-exploits?sessionInvalidated=true">Finding Network-based Exploits</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Gameplay/Tools/NetworkProfiler/index.html">Network Profiler</a></li>
</ul>
<h2 id="UE4集成Protobuf"><a href="#UE4集成Protobuf" class="headerlink" title="UE4集成Protobuf"></a>UE4集成Protobuf</h2><p>我之前的文章<a href="https://imzlp.com/posts/9903/">Build protobuf with MSVC on Windows</a>中介绍了在Windows上使用MSVC编译Protobuf，最近的项目中有用到Protobuf，就把Protobuf集成UE4做了一个插件，无需在系统和项目设置中添加任何环境变量以及文件包含，也不需要考虑<code>protobuf</code>的<code>lib</code>的链接，方便在项目中使用，并且对UE不兼容cc格式写了编辑器插件，<code>.pb.cc</code>都会被转换为<code>pb.cpp</code>。</p>
<p><img data-src="index/UE4/protobuf-protoc-toolbar.webp"></p>
<p>代码我放在了github上：<a target="_blank" rel="noopener" href="https://github.com/hxhb/ue4-protobuf">hxhb/ue4-protobuf</a></p>
<p>下面是简单的使用介绍：</p>
<h3 id="What-is-this-1"><a href="#What-is-this-1" class="headerlink" title="What is this?"></a>What is this?</h3><p>This is an Unreal Engine 4 plugin that integrates <a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf">Protobuf</a> into the project without requiring you to add system PATH or anything else.</p>
<h3 id="How-do-use-1"><a href="#How-do-use-1" class="headerlink" title="How do use?"></a>How do use?</h3><ol>
<li>add the plugin to the project and enable it.</li>
<li>add the following property to <code>build.cs</code> of the project :</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PublicDependencyModuleNames.Add(<span class="string">&quot;Protobuf&quot;</span>);</span><br><span class="line">bEnableUndefinedIdentifierWarnings = <span class="literal">false</span>;</span><br><span class="line">bUseRTTI = <span class="literal">true</span>;</span><br><span class="line">bEnableExceptions = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Create <code>.proto</code> file into project source code folder </li>
<li>Launch the Project in Editor, Click the <code>Protoc</code> button.</li>
</ol>
<h3 id="Protobuf-Version"><a href="#Protobuf-Version" class="headerlink" title="Protobuf Version"></a>Protobuf Version</h3><ul>
<li>Protobuf v3.9.1 build with MSVC 15 64bit (Visual Studio 2017).</li>
</ul>
<h2 id="protoc处理目录中的-proto文件"><a href="#protoc处理目录中的-proto文件" class="headerlink" title="protoc处理目录中的.proto文件"></a>protoc处理目录中的.proto文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ protoc --proto_path=PROTO_FILE_PATH PROTO_FILE --cpp_out=OUT_FILE_PATH PROTO_FILE_PATH\*.proto</span><br></pre></td></tr></table></figure>
<p>如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ protoc --proto_path=<span class="string">&quot;d:\protoc&quot;</span> MyName.proto --cpp_out=<span class="string">&quot;d:\&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Was-only-expecting-C-files-to-have-CachedCPPEnvironments"><a href="#Was-only-expecting-C-files-to-have-CachedCPPEnvironments" class="headerlink" title="Was only expecting C++ files to have CachedCPPEnvironments!"></a>Was only expecting C++ files to have CachedCPPEnvironments!</h2><p>写了个插件在UE中使用protobuf，在从<code>proto</code>文件生成<code>.cc</code>/<code>.h</code>之后编译报这个错误，分析了一下是UBT的代码文件类型不支持<code>.cc</code>。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1&gt;------ Build started: Project: GWorld, Configuration: Development x64 ------</span><br><span class="line">1&gt;Using &#x27;git status&#x27; to determine working set for adaptive non-unity build (C:\Users\imzlp\Documents\Unreal Projects\GWorld).</span><br><span class="line">1&gt;UnrealBuildTool : error : Was only expecting C++ files to have CachedCPPEnvironments!</span><br><span class="line">1&gt;(see ../Programs/UnrealBuildTool/Log.txt for full exception trace)</span><br></pre></td></tr></table></figure>

<p>在引擎中搜索代码，发现这个错误是在<code>UnrealBuildTools\System\ActionGraph.cs</code>中<code>IsActionOutdated</code>里的：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">IsActionOutdated</span>(<span class="params">BuildConfiguration BuildConfiguration, UEBuildTarget Target, CPPHeaders Headers, Action RootAction, <span class="keyword">bool</span> bIsAssemblingBuild, <span class="keyword">bool</span> bNeedsFullCPPIncludeRescan, Dictionary&lt;Action, <span class="keyword">bool</span>&gt; OutdatedActionDictionary, ActionHistory ActionHistory, Dictionary&lt;UEBuildTarget, List&lt;FileItem&gt;&gt; TargetToOutdatedPrerequisitesMap</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// @todo ubtmake: we may be scanning more files than we need to here -- indirectly outdated files are bIsOutdated=true by this point (for example basemost includes when deeper includes are dirty)</span></span><br><span class="line">	<span class="keyword">if</span> (bIsOutdated &amp;&amp; RootAction.ActionType == ActionType.Compile)<span class="comment">// @todo ubtmake: Does this work with RC files?  See above too.</span></span><br><span class="line">	&#123;</span><br><span class="line">	  Log.TraceVerbose(<span class="string">&quot;Outdated action: &#123;0&#125;&quot;</span>, RootAction.StatusDescription);</span><br><span class="line">	  <span class="keyword">foreach</span> (FileItem PrerequisiteItem <span class="keyword">in</span> RootAction.PrerequisiteItems)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="keyword">if</span> (PrerequisiteItem.CachedIncludePaths != <span class="literal">null</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">if</span> (!IsCPPFile(PrerequisiteItem))</span><br><span class="line">	      &#123;</span><br><span class="line">	        <span class="keyword">throw</span> <span class="keyword">new</span> BuildException(<span class="string">&quot;Was only expecting C++ files to have CachedCPPEnvironments!&quot;</span>);</span><br><span class="line">	      &#125;</span><br><span class="line">	      Log.TraceVerbose(<span class="string">&quot;  -&gt; DEEP include scan: &#123;0&#125;&quot;</span>, PrerequisiteItem.AbsolutePath);</span><br><span class="line"></span><br><span class="line">	      List&lt;FileItem&gt; OutdatedPrerequisites;</span><br><span class="line">	      <span class="keyword">if</span> (!TargetToOutdatedPrerequisitesMap.TryGetValue(Target, <span class="keyword">out</span> OutdatedPrerequisites))</span><br><span class="line">	      &#123;</span><br><span class="line">	        OutdatedPrerequisites = <span class="keyword">new</span> List&lt;FileItem&gt;();</span><br><span class="line">	        TargetToOutdatedPrerequisitesMap.Add(Target, OutdatedPrerequisites);</span><br><span class="line">	      &#125;</span><br><span class="line"></span><br><span class="line">	      OutdatedPrerequisites.Add(PrerequisiteItem);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">else</span> <span class="keyword">if</span> (IsCPPImplementationFile(PrerequisiteItem) || IsCPPResourceFile(PrerequisiteItem))</span><br><span class="line">	    &#123;</span><br><span class="line">	      Log.TraceVerbose(<span class="string">&quot;  -&gt; WARNING: No CachedCPPEnvironment: &#123;0&#125;&quot;</span>, PrerequisiteItem.AbsolutePath);</span><br><span class="line">	    &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;    </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点就是<code>IsCPPFile</code>这个函数，报这个错误是因为UBT检测到了项目中不能识别的文件。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ source file</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> IsCPPImplementationFile(FileItem) || IsCPPIncludeFile(FileItem) || IsCPPResourceFile(FileItem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ source implementation file (e.g., .cpp)</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPImplementationFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (FileItem.AbsolutePath.EndsWith(<span class="string">&quot;.cpp&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">			FileItem.AbsolutePath.EndsWith(<span class="string">&quot;.c&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">			FileItem.AbsolutePath.EndsWith(<span class="string">&quot;.mm&quot;</span>, StringComparison.InvariantCultureIgnoreCase));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ source header file (e.g., .h or .inl)</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPIncludeFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (FileItem.AbsolutePath.EndsWith(<span class="string">&quot;.h&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">	FileItem.AbsolutePath.EndsWith(<span class="string">&quot;.hpp&quot;</span>, StringComparison.InvariantCultureIgnoreCase) ||</span><br><span class="line">	FileItem.AbsolutePath.EndsWith(<span class="string">&quot;.inl&quot;</span>, StringComparison.InvariantCultureIgnoreCase));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// &lt;summary&gt;</span></span><br><span class="line"><span class="comment">/// Checks if the specified file is a C++ resource file (e.g., .rc)</span></span><br><span class="line"><span class="comment">/// &lt;/summary&gt;</span></span><br><span class="line"><span class="comment">/// &lt;param name=&quot;FileItem&quot;&gt;The file to check&lt;/param&gt;</span></span><br><span class="line"><span class="comment">/// &lt;returns&gt;True if this is a C++ source file&lt;/returns&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCPPResourceFile</span><span class="params">(FileItem FileItem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (FileItem.AbsolutePath.EndsWith(<span class="string">&quot;.rc&quot;</span>, StringComparison.InvariantCultureIgnoreCase));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，UBT只认下列几种文件：</p>
<ul>
<li><strong>IsCPPImplementationFile</strong>：<code>.cpp</code>/<code>.c</code>/<code>.m</code></li>
<li><strong>IsCPPIncludeFile</strong>：<code>.h</code>/<code>.hpp</code>/<code>.inl</code></li>
<li><strong>IsCPPResourceFile</strong>：<code>.rc</code></li>
</ul>
<p>因为Protobuf产生的是<code>.cc</code>文件，所以就会报开头的错误。</p>
<p>既然问题找到了。那么解决办法有两个：</p>
<ol>
<li>改UBT的代码，让其支持<code>.cc</code></li>
<li>改protobuf产生的<code>.cc</code>为<code>.cpp</code></li>
</ol>
<h2 id="在蓝图中使用参数确定返回类型"><a href="#在蓝图中使用参数确定返回类型" class="headerlink" title="在蓝图中使用参数确定返回类型"></a>在蓝图中使用参数确定返回类型</h2><p>在使用诸如<code>SpawnActor</code>的时候，传进来的UClass是什么就会直接返回具体的类型，避免<code>Cast</code>的操作。</p>
<p>使用代码实现的话需要在<code>UFUNCTION</code>的<code>meta</code>参数中添加<code>DeterminesOutputType</code>，根据传入的参数确定返回的类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UFUNCTION(BlueprintCallable, meta = (DeterminesOutputType = <span class="string">&quot;ObjectClass&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">static</span> class UObject* <span class="title">CreateObject</span><span class="params">(class TSubclassOf&lt;class UObject&gt; ObjectClass)</span></span>;</span><br></pre></td></tr></table></figure>
<p><img data-src="index/UE4/use-different-return-type.webp"></p>
<h2 id="SetMasterPoseComponent"><a href="#SetMasterPoseComponent" class="headerlink" title="SetMasterPoseComponent"></a>SetMasterPoseComponent</h2><p>当创建模块化角色的时候，需要将拆开的身体的各个部分跟随着一个主Pose运动。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Animation/WorkingwithModularCharacters/index.html">Working with Modular Characters</a></li>
</ul>
<p>但是当对一个<code>USkeletonMeshComponent</code>调用该方法时会关闭掉当前Mesh的物理资产（与物理相关的都会关闭）<br>可以看<code>Runtime/Engine/Private/Components/SkinnedMeshComponent.cpp</code>中的<code>SetMasterPoseComponent</code>实现，其中调用了<code>RecreatePhysicsState();</code></p>
<p>这个问题再4.1x时代就有人给<a target="_blank" rel="noopener" href="https://unreal-engine-issues.herokuapp.com/">Unreal Engine Issus</a>提过bug，但是官方表示不是bug不会修复。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://unreal-engine-issues.herokuapp.com/issue/UE-27081">Collision is not updated on Slave Meshes when using “Set Master Pose Component”</a></li>
</ul>
<h2 id="打包Android报错-app-assembleDebug"><a href="#打包Android报错-app-assembleDebug" class="headerlink" title="打包Android报错:app:assembleDebug"></a>打包Android报错:app:assembleDebug</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UATHelper: Packaging (Android…) ERROR: cmd.exe failed with args /c “[ProjectPath]\Intermediate/Android/APK/gradle/rungradle.bat” :app:assembleDebug</span><br></pre></td></tr></table></figure>
<p>将下面选项取消勾选即可：<br><img data-src="index/UE4/ue4-package-android-error-assdebug.webp"></p>
<p>在4.24+中没有了<code>Enable Gradle instead of Ant</code>选项，仔细看了下log发现是因为UE要从网络上下载<code>Grade</code>下载失败导致的，可以在打包时开启全局代理。</p>
<p>还有一些相关的文章，可以更新Android Tools，操作方法为：</p>
<ol>
<li>run NVPACK/android-sdk-windows/tools/android.bat</li>
<li>click on “Deselect All”</li>
<li>update Extras/Android Support Repository</li>
</ol>
<p>文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://programmersought.com/article/48741179455/">UE4-packaged Android error /Android/APK\gradle\rungradle.bat” :app:assembleDebug</a></li>
<li><a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/720605/android-packaging-build-fail-ue-418.html">Android packaging build fail - UE 4.18</a></li>
</ul>
<h2 id="UE4：变量已被优化，因而不可用"><a href="#UE4：变量已被优化，因而不可用" class="headerlink" title="UE4：变量已被优化，因而不可用"></a>UE4：变量已被优化，因而不可用</h2><p>上面写到了在VS中遇到这样的情况怎么在VS中设置解决，但是在UE的项目里不能在VS里设置优化选项，有两种解决办法，一种是直接使用宏的，在普通的项目中也可以用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> optimize(<span class="meta-string">&quot;&quot;</span>,off) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>或者直接使用UE封装的宏(本质上面的方法)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Public/Misc/CoreMiscDefines.h</span></span><br><span class="line">PRAGMA_DISABLE_OPTIMIZATION</span><br></pre></td></tr></table></figure>
<p>还有一种方法是使用UE的Module来控制：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// build.cs</span></span><br><span class="line">OptimizeCode = CodeOptimization.Never;</span><br></pre></td></tr></table></figure>
<p><code>CodeOptimization</code>支持几种值，默认是<code>Default</code>，开启优化：</p>
<ul>
<li>Never</li>
<li>Default</li>
<li>InNonDebugBuilds</li>
<li>InShippingBuildsOnly</li>
</ul>
<p>相关的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnrealBuildTool/Configutation/UEBuildModuleCPP.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">ShouldEnableOptimization</span><span class="params">(ModuleRules.CodeOptimization Setting, UnrealTargetConfiguration Configuration, <span class="keyword">bool</span> bIsEngineModule)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(Setting)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.Never:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.Default:</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.InNonDebugBuilds:</span><br><span class="line">      <span class="keyword">return</span> (Configuration == UnrealTargetConfiguration.Debug)? <span class="literal">false</span> : (Configuration != UnrealTargetConfiguration.DebugGame || bIsEngineModule);</span><br><span class="line">    <span class="keyword">case</span> ModuleRules.CodeOptimization.InNonDebugBuilds:</span><br><span class="line">      <span class="keyword">return</span> (Configuration == UnrealTargetConfiguration.Shipping);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数在<code>UEBuildModuleCPP.cs</code>的<code>CreateModuleCompileEnvironment</code>中调用，将结果赋值给了<code>CppCompileEnvironment.bOptimizeCode</code>，进而又在<code>VCToolChain.cs</code>中被使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">UnrealBuildTool\Platform\Windows\VCToolChain.cs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AppendCLArguments_Global</span><span class="params">(CppCompileEnvironment CompileEnvironment, List&lt;<span class="built_in">string</span>&gt; Arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// other code ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  Debug</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">if</span> (CompileEnvironment.Configuration == CppConfiguration.Debug)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">// Disable compiler optimization.</span></span><br><span class="line">	  Arguments.Add(<span class="string">&quot;/Od&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Favor code size (especially useful for embedded platforms).</span></span><br><span class="line">	  Arguments.Add(<span class="string">&quot;/Os&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Allow inline method expansion unless E&amp;C support is requested</span></span><br><span class="line">	  <span class="keyword">if</span> (!CompileEnvironment.bSupportEditAndContinue &amp;&amp; CompileEnvironment.bUseInlining)</span><br><span class="line">	  &#123;</span><br><span class="line">	    Arguments.Add(<span class="string">&quot;/Ob2&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> ((CompileEnvironment.Platform == CppPlatform.Win32) ||</span><br><span class="line">	    (CompileEnvironment.Platform == CppPlatform.Win64))</span><br><span class="line">	  &#123;</span><br><span class="line">	    Arguments.Add(<span class="string">&quot;/RTCs&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  Development and LTCG</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span>(!CompileEnvironment.bOptimizeCode)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Disable compiler optimization.</span></span><br><span class="line">	    Arguments.Add(<span class="string">&quot;/Od&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	  <span class="keyword">else</span></span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Maximum optimizations.</span></span><br><span class="line">	    Arguments.Add(<span class="string">&quot;/Ox&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Favor code speed.</span></span><br><span class="line">	    Arguments.Add(<span class="string">&quot;/Ot&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Coalesce duplicate strings</span></span><br><span class="line">	    Arguments.Add(<span class="string">&quot;/GF&quot;</span>);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// Only omit frame pointers on the PC (which is implied by /Ox) if wanted.</span></span><br><span class="line">	    <span class="keyword">if</span> (CompileEnvironment.bOmitFramePointers == <span class="literal">false</span></span><br><span class="line">	    &amp;&amp; ((CompileEnvironment.Platform == CppPlatform.Win32) ||</span><br><span class="line">	      (CompileEnvironment.Platform == CppPlatform.Win64)))</span><br><span class="line">	    &#123;</span><br><span class="line">	      Arguments.Add(<span class="string">&quot;/Oy-&quot;</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">// Allow inline method expansion</span></span><br><span class="line">	  Arguments.Add(<span class="string">&quot;/Ob2&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">//</span></span><br><span class="line">	  <span class="comment">// LTCG</span></span><br><span class="line">	  <span class="comment">//</span></span><br><span class="line">	  <span class="keyword">if</span> (CompileEnvironment.bAllowLTCG)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">// Enable link-time code generation.</span></span><br><span class="line">	    Arguments.Add(<span class="string">&quot;/GL&quot;</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// other code...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，在<code>Debug</code>的环境下，是默认关闭优化的。在非<code>Debug</code>时根据<code>CompileEnvironment.bOptimizeCode</code>的值来决定是否开启优化。</p>
<p>调试效果：<br>当使用默认时（<code>OptimizeCode = CodeOptimization.Default;</code>）:<br><img data-src="https://imzlp.com/posts/16643/UE-codeoptimize-default.webp"></p>
<p>当关闭代码优化时(OptimizeCode = CodeOptimization.Never;)：<br><img data-src="https://imzlp.com/posts/16643/UE-codeoptimize-never.webp"></p>
<p>建议使用<code>OptimizeCode = CodeOptimization.InShippingBuildsOnly;</code>。</p>
<blockquote>
<p>注意：这个选项和普通的C++项目在VS中的<code>Properties</code>-<code>Configuration</code>-<code>C/C++</code>-<code>Optimization</code>-<code>Optimization</code>的设置时一样的。</p>
</blockquote>
<p><img data-src="https://imzlp.com/posts/16643/vs-disable-optimization.webp"></p>
<h2 id="二元操作符的AddPin"><a href="#二元操作符的AddPin" class="headerlink" title="二元操作符的AddPin"></a>二元操作符的AddPin</h2><p>在UE中有很多这样的节点：<br><img data-src="index/UE4/ue-bp-pure-node-binary-operator.webp"></p>
<p>这个AddPin，可以在蓝图中很方便地进行拼接，其本质就从前往后的项依次两两结合，组成新的项，再与后续的项两两结合。</p>
<p>其在代码里的写法为(以<code>Append</code>为例)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Concatenates two strings together to make a new string</span></span><br><span class="line"><span class="comment"> * @param A - The original string</span></span><br><span class="line"><span class="comment"> * @param B - The string to append to A</span></span><br><span class="line"><span class="comment"> * @returns A new string which is the concatenation of A+B</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">UFUNCTION(BlueprintPure, meta=(DisplayName = <span class="string">&quot;Append&quot;</span>, CommutativeAssociativeBinaryOperator = <span class="string">&quot;true&quot;</span>), Category=<span class="string">&quot;Utilities|String&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">static</span> FString <span class="title">Concat_StrStr</span><span class="params">(<span class="keyword">const</span> FString&amp; A, <span class="keyword">const</span> FString&amp; B)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其重点就是<code>static</code>函数+<code>BlueprintPure</code>标记+<code>CommutativeAssociativeBinaryOperator = &quot;true&quot;</code>元标记。</p>
<h2 id="图像质量级别"><a href="#图像质量级别" class="headerlink" title="图像质量级别"></a>图像质量级别</h2><p>大多数游戏都提供了游戏画面参数的自定义设置，UE自己内置了五个不同的渲染级别：</p>
<ul>
<li>Low（0）</li>
<li>Medium（1）</li>
<li>Hight（1）</li>
<li>Epic（3）</li>
<li>Cinematic（4）</li>
</ul>
<p>这个五个级别可以通过在<code>UGameUserSettings</code>中调用<code>FQualityLevels::SetFromSingleQualityLevel</code>来设置：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ScalabilityQuality.SetFromSingleQualityLevel(GraphicsLevel);</span><br></pre></td></tr></table></figure>
<p>因为在<code>UGameUserSettings</code>中，它也可以被定义为<code>UPROPERTY(config)</code>，实现存储设置的目的。</p>
<h2 id="使用物理资产优化动态阴影消耗"><a href="#使用物理资产优化动态阴影消耗" class="headerlink" title="使用物理资产优化动态阴影消耗"></a>使用物理资产优化动态阴影消耗</h2><p>在UE中打开<code>SkeletalMesh</code>，在<code>AssetDetails</code>中找到<code>Lighting</code>-<code>Shadow Physics Asset</code>，将其指定为物理资产<code>PhysicsAsset</code>：</p>
<p><img data-src="index/UE4/optimize-dynamic-shadow-use-phy-asset.webp"></p>
<p>然后打开使用这个<code>SkeletalMesh</code>的<code>SkeletalMesh Component</code>，将其<code>Lithing</code>-<code>Capsule Direct Shadow</code>选项打勾，这个<code>Skeletal Mesh</code>就会被使用<code>Physics Asset</code>的框来计算阴影了，会降低消耗。</p>
<p><img data-src="index/UE4/optimize-dynamic-shadow-use-capsule-direct-shadow.webp"></p>
<h2 id="GameUserSettings"><a href="#GameUserSettings" class="headerlink" title="GameUserSettings"></a>GameUserSettings</h2><p>在UE中，当我们需要保存玩家的一些数据时，比如玩家的游戏设置：分辨率、画面质量、按键等等。这些与游戏无关的数据可以使用<code>GameUserSettings</code>来存储，游戏的数据还是使用<code>SaveGame</code>来存储。</p>
<p>UE默认使用的<code>GameUserSettings</code>类是<code>UGameUserSettings</code>，我们可以在<code>Config/DefaultEngine.ini</code>中的<code>/Script/Engine.Engine</code>这个<code>Section</code>下通过<code>GameUserSettingsClassName</code>指定：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.Engine]</span></span><br><span class="line"><span class="attr">GameUserSettingsClassName</span>=/Script/MODULE_NAME.GAME_USER_SETTING_CLASS</span><br></pre></td></tr></table></figure>

<ul>
<li><code>MODULE_NAME</code>指的是所要指定的类是定义在什么<code>Module</code>下的。</li>
<li><code>GAME_USER_SETTING_CLASS</code>：指所指定的类的名字，忽略<code>U</code></li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.Engine]</span></span><br><span class="line"><span class="attr">GameUserSettingsClassName</span>=/Script/GWorld.SGGameUserSettings</span><br></pre></td></tr></table></figure>

<p><code>GameUserSettingsClassName</code>在<code>UGameUserSettings::PreloadResolutionSettings</code>这个<code>static</code>成员函数中中被加载和读取，而它又在<code>FEngineLoop::PreInit</code>中被调用。真正的类对象是在<code>UEngine::InitializeObjectReferences</code>(UnrealEngine.cpp)中被加载。</p>
<p>我们指定的类必须是继承自<code>UGameUserSettings</code>的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">UCLASS(BlueprintType,Blueprintable)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWORLD_API</span> <span class="title">USGGameUserSettings</span> :</span> <span class="keyword">public</span> UGameUserSettings</span><br><span class="line">&#123;</span><br><span class="line">  GENERATED_UCLASS_BODY()</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要重写其中的几个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ApplySettings</span><span class="params">(<span class="keyword">bool</span> bCheckForCommandLineOverrides)</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetToDefaults</span><span class="params">()</span><span class="keyword">override</span></span>;</span><br></pre></td></tr></table></figure>

<p>在这两个函数中，根据所有的用户可配置信息做事情。</p>
<p>在我们自己的<code>GameUserSetting</code>类中，可以使用<code>UPROPERTY(config)</code>声明变量，标识其可以被存储到配置文件中。</p>
<p>当在游戏中选项设置完毕，调用<code>ApplySettings</code>应用设置之后，可以调用<code>SaveSettings</code>将我们的<code>GameUserSetting</code>中所有的标记为<code>UPROPERTY(Config)</code>的成员都存储到<code>GameUserSettings.ini</code>中。</p>
<p>注意：在项目和非shipping模式打包的项目，<code>GameUserSettings.ini</code>文件的路径为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PROJECT_DIR/Saved/Config/Windows/GameUserSettings.ini</span><br></pre></td></tr></table></figure>

<p>而<code>Shipping</code>模式打包的项目，<code>Saved</code>文件夹不在打包的目录下，而是在：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\USER_NAME\AppData\Local\PROJECT_NAME</span><br></pre></td></tr></table></figure>

<h2 id="TAutoConsoleVariable"><a href="#TAutoConsoleVariable" class="headerlink" title="TAutoConsoleVariable"></a>TAutoConsoleVariable</h2><p><code>TAutoConsoleVariable</code>可以让我们往UE的项目中添加<code>Console</code>命令：</p>
<p><img data-src="index/UE4/ue-addtional-console-command.webp"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Core/Pulic/HAL/IConsoleManager.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">TAutoConsoleVariable</span> :</span> <span class="keyword">public</span> FAutoConsoleObject</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a float, int or string console variable</span></span><br><span class="line"><span class="comment">	 * @param Name must not be 0</span></span><br><span class="line"><span class="comment">	 * @param Help must not be 0</span></span><br><span class="line"><span class="comment">	 * @param Flags bitmask combined from EConsoleVariableFlags</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	TAutoConsoleVariable(<span class="keyword">const</span> TCHAR* Name, <span class="keyword">const</span> T&amp; DefaultValue, <span class="keyword">const</span> TCHAR* Help, uint32 Flags = ECVF_Default);</span><br><span class="line"></span><br><span class="line">	<span class="function">T <span class="title">GetValueOnGameThread</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Ref-&gt;GetValueOnGameThread();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">T <span class="title">GetValueOnRenderThread</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Ref-&gt;GetValueOnRenderThread();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">T <span class="title">GetValueOnAnyThread</span><span class="params">(<span class="keyword">bool</span> bForceGameThread = <span class="literal">false</span>)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Ref-&gt;GetValueOnAnyThread(bForceGameThread);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** Dereference back to a variable**/</span></span><br><span class="line">	FORCEINLINE IConsoleVariable&amp; <span class="keyword">operator</span>*()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *AsVariable();</span><br><span class="line">	&#125;</span><br><span class="line">	FORCEINLINE <span class="keyword">const</span> IConsoleVariable&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *AsVariable();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/** Dereference back to a variable**/</span></span><br><span class="line">	FORCEINLINE IConsoleVariable* <span class="keyword">operator</span>-&gt;()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> AsVariable();</span><br><span class="line">	&#125;</span><br><span class="line">	FORCEINLINE <span class="keyword">const</span> IConsoleVariable* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> AsVariable();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	TConsoleVariableData&lt;T&gt;* Ref;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">inline</span> TAutoConsoleVariable&lt;int32&gt;::TAutoConsoleVariable(<span class="keyword">const</span> TCHAR* Name, <span class="keyword">const</span> int32&amp; DefaultValue, <span class="keyword">const</span> TCHAR* Help, uint32 Flags)</span><br><span class="line">	: FAutoConsoleObject(IConsoleManager::Get().RegisterConsoleVariable(Name, DefaultValue, Help, Flags))</span><br><span class="line">&#123;</span><br><span class="line">	Ref = AsVariable()-&gt;AsVariableInt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">inline</span> TAutoConsoleVariable&lt;<span class="keyword">float</span>&gt;::TAutoConsoleVariable(<span class="keyword">const</span> TCHAR* Name, <span class="keyword">const</span> <span class="keyword">float</span>&amp; DefaultValue, <span class="keyword">const</span> TCHAR* Help, uint32 Flags)</span><br><span class="line">	: FAutoConsoleObject(IConsoleManager::Get().RegisterConsoleVariable(Name, DefaultValue, Help, Flags))</span><br><span class="line">&#123;</span><br><span class="line">	Ref = AsVariable()-&gt;AsVariableFloat();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">inline</span> TAutoConsoleVariable&lt;FString&gt;::TAutoConsoleVariable(<span class="keyword">const</span> TCHAR* Name, <span class="keyword">const</span> FString&amp; DefaultValue, <span class="keyword">const</span> TCHAR* Help, uint32 Flags)</span><br><span class="line">	: FAutoConsoleObject(IConsoleManager::Get().RegisterConsoleVariable(Name, DefaultValue, Help, Flags))</span><br><span class="line">&#123;</span><br><span class="line">	Ref = AsVariable()-&gt;AsVariableString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TAutoConsoleVariable</code>是一个模板类，特化了三个类型：</p>
<ul>
<li>int32</li>
<li>float</li>
<li>FString</li>
</ul>
<p>如果你在使用<code>TAutoConsoleVariable</code>的时候遇到<code>TAutoConsoleVariable</code>的构造函数的链接错误，那么一定是用了未特化的类型，使用<code>FString</code>的特化裹一下吧。</p>
<h2 id="cmake-could-not-find-any-instance-of-Visual-Studio"><a href="#cmake-could-not-find-any-instance-of-Visual-Studio" class="headerlink" title="cmake:could not find any instance of Visual Studio."></a>cmake:could not find any instance of Visual Studio.</h2><p>在使用cmske生成时如果产生下列错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CMake Error at CMakeLists.txt:51 (project):</span><br><span class="line">Generator</span><br><span class="line">Visual Studio 15 2017 Win64</span><br><span class="line">could not find any instance of Visual Studio.</span><br><span class="line"></span><br><span class="line">Configuring incomplete, errors occurred!</span><br><span class="line">See also <span class="string">&quot;E:/protobuf/cmake/CMakeFiles/CMakeOutput.log“</span></span><br></pre></td></tr></table></figure>
<p>检查VS安装的时候有没有安装<strong>编译器、生成工具和运行时</strong>分类下的<strong>适用于桌面的VC++2015.3 v14.00(v140)工具集</strong>。</p>
<h2 id="编译目标的RuntimeLibrary类型"><a href="#编译目标的RuntimeLibrary类型" class="headerlink" title="编译目标的RuntimeLibrary类型"></a>编译目标的RuntimeLibrary类型</h2><p>与普通的c++项目不一样，UE的Game工程是不能在项目属性中设置<code>RuntimeLibrary</code>的，这部分有UBT代劳替我们处理。<br>其相关的代码在<code>UnrealBuildTool\Windows\VCToolchain.cs</code>(UE_4.22)中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AppendCLArguments_Global</span><span class="params">(CppCompileEnvironment CompileEnvironment, List&lt;<span class="built_in">string</span>&gt; Arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// Specify the appropriate runtime library based on the platform and config.</span></span><br><span class="line"><span class="keyword">if</span> (CompileEnvironment.bUseStaticCRT)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (CompileEnvironment.bUseDebugCRT)</span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.Add(<span class="string">&quot;/MTd&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.Add(<span class="string">&quot;/MT&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (CompileEnvironment.bUseDebugCRT)</span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.Add(<span class="string">&quot;/MDd&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Arguments.Add(<span class="string">&quot;/MD&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>*.target.cs</code>中使用了<code>bUseStaticCRT=true</code>后（默认为false），编译Debug版本是<code>/MTd</code>，其他版本是<code>MT</code>。<br>在<code>*.target.cs</code>中不能直接控制<code>bUseDebugCRT</code>,但是可以控制<code>bDebugBuildsActuallyUseDebugCRT</code>（默认为false）,它由我们在<code>VS</code>选的<code>Configuration</code>和<code>bDebugBuildsActuallyUseDebugCRT</code>的值来控制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; UEBuildTarget.cs</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; GetCppConfiguration</span><br><span class="line">static CppConfiguration GetCppConfiguration(UnrealTargetConfiguration Configuration)</span><br><span class="line">&#123;</span><br><span class="line">  switch (Configuration)</span><br><span class="line">  &#123;</span><br><span class="line">    case UnrealTargetConfiguration.Debug:</span><br><span class="line">      return CppConfiguration.Debug;</span><br><span class="line">    case UnrealTargetConfiguration.DebugGame:</span><br><span class="line">    case UnrealTargetConfiguration.Development:</span><br><span class="line">      return CppConfiguration.Development;</span><br><span class="line">    case UnrealTargetConfiguration.Shipping:</span><br><span class="line">      return CppConfiguration.Shipping;</span><br><span class="line">    case UnrealTargetConfiguration.Test:</span><br><span class="line">      return CppConfiguration.Shipping;</span><br><span class="line">    default:</span><br><span class="line">      throw new BuildException(&quot;Unhandled target configuration&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; CreateCompileEnvironmentForProjectFiles</span><br><span class="line">public CppCompileEnvironment CreateCompileEnvironmentForProjectFiles()</span><br><span class="line">&#123;</span><br><span class="line">  CppPlatform CppPlatform &#x3D; UEBuildPlatform.GetBuildPlatform(Platform).DefaultCppPlatform;</span><br><span class="line">  CppConfiguration CppConfiguration &#x3D; GetCppConfiguration(Configuration);</span><br><span class="line"></span><br><span class="line">  SourceFileMetadataCache MetadataCache &#x3D; SourceFileMetadataCache.CreateHierarchy(ProjectFile);</span><br><span class="line"></span><br><span class="line">  CppCompileEnvironment GlobalCompileEnvironment &#x3D; new CppCompileEnvironment(CppPlatform, CppConfiguration, Architecture, MetadataCache);</span><br><span class="line">  LinkEnvironment GlobalLinkEnvironment &#x3D; new LinkEnvironment(GlobalCompileEnvironment.Platform, GlobalCompileEnvironment.Configuration, GlobalCompileEnvironment.Architecture);</span><br><span class="line"></span><br><span class="line">  UEToolChain TargetToolChain &#x3D; CreateToolchain(CppPlatform);</span><br><span class="line">  SetupGlobalEnvironment(TargetToolChain, GlobalCompileEnvironment, GlobalLinkEnvironment);</span><br><span class="line"></span><br><span class="line">  return GlobalCompileEnvironment;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; SetupGlobalEnvironment</span><br><span class="line">private void SetupGlobalEnvironment(UEToolChain ToolChain, CppCompileEnvironment GlobalCompileEnvironment, LinkEnvironment GlobalLinkEnvironment)</span><br><span class="line">&#123;</span><br><span class="line">	&#x2F;&#x2F; ...</span><br><span class="line">	GlobalCompileEnvironment.bUseDebugCRT &#x3D; GlobalCompileEnvironment.Configuration &#x3D;&#x3D; CppConfiguration.Debug &amp;&amp; Rules.bDebugBuildsActuallyUseDebugCRT;</span><br><span class="line">	&#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，总结上面的代码，只有当VS的编译选项选的是<code>Debug</code>，并且在<code>*.Target.cs</code>中<code>bDebugBuildsActuallyUseDebugCRT=true</code>的时候，<code>bUseDebugCRT</code>才为<code>true</code>。</p>
<h3 id="情况一"><a href="#情况一" class="headerlink" title="情况一"></a>情况一</h3><ul>
<li>当<code>bUseStaticCRT=true;</code></li>
<li>以及<code>bDebugBuildsActuallyUseDebugCRT=true;</code></li>
<li>以及VS中的Configuration为<code>Debug</code></li>
</ul>
<p>以上三个条件全部满足的时候，编译的Runtime Library为<code>/MTd</code>。</p>
<h3 id="情况二"><a href="#情况二" class="headerlink" title="情况二"></a>情况二</h3><ul>
<li>当<code>bUseStaticCRT=false;</code>(默认)</li>
<li>以及<code>bDebugBuildsActuallyUseDebugCRT=true;</code></li>
<li>以及VS中的Configuration为<code>Debug</code></li>
</ul>
<p>这三个条件，编译的Runtime Library为<code>/MDd</code>。</p>
<h3 id="情况三"><a href="#情况三" class="headerlink" title="情况三"></a>情况三</h3><p>在<strong>情况二</strong>基础上把下列条件改为：</p>
<ul>
<li>以及<code>bDebugBuildsActuallyUseDebugCRT=false;</code>(默认)</li>
</ul>
<p>或者：</p>
<ul>
<li>以及VS中的Configuration不是<code>Debug</code></li>
</ul>
<p>则这种情况下，编译的Runtime Library都是<code>/MD</code>.</p>
<h2 id="What-is-Cook"><a href="#What-is-Cook" class="headerlink" title="What is Cook?"></a>What is Cook?</h2><p>虚幻引擎内部使用特定的格式存储游戏内的资产(uasset)，但是在游戏发行的时候需要将这个虚幻的资产转换为各种平台的不同格式，因为各个平台使用自己的专有格式或者各个平台上具有性能更好的存储格式。<strong>将虚幻内部格式转换为平台特定格式的过程被称作Cook。</strong><br>对于Windows而言，可以在编辑器中执行<code>Cook Content for Windows </code>，或者使用<code>UnrealFrontEnd</code>进行Cook或者Package。<br>也可以使用下列命令进行cook：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor.exe &lt;GameName or uproject&gt; -run&#x3D;cook -targetplatform&#x3D;&lt;Plat1&gt;+&lt;Plat2&gt; [-cookonthefly] [-iterate] [-map&#x3D;&lt;Map1&gt;+&lt;Map2&gt;]</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/en-US/Engine/Deployment/Cooking/index.html">Content Cooking</a></li>
</ul>
<h2 id="添加宏定义"><a href="#添加宏定义" class="headerlink" title="添加宏定义"></a>添加宏定义</h2><p>不同于普通的C++项目，可以在VS项目(<code>Project</code>-<code>Properties</code>-<code>Configuration</code>-<code>C/C++</code>-<code>Preprocessor</code>-<code>Preprocessor Definitions</code>)中或者直接在文件中使用<code>#define</code>(这样的方法在UE的项目中也可以用)，但是UE的项目有自己的在项目中添加宏的方法。</p>
<p>方法就是在<code>*.build.cs</code>中添加：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Definitions.Add(<span class="string">&quot;GW_WITH_DEBUG=1&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>然后在代码中就可以使用这个宏了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for example</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AVRPlayer::BeginPlay</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::BeginPlay();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> GW_WITH_DEBUG</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> GW_WITH_DEBUG</span></span><br><span class="line">		UKismetSystemLibrary::PrintString(<span class="keyword">this</span>, TEXT(<span class="string">&quot;GW_WITH_DEBUG is defined&quot;</span>), <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		UKismetSystemLibrary::PrintString(<span class="keyword">this</span>, TEXT(<span class="string">&quot;GW_WITH_DEBUG is not defined&quot;</span>), <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="index/UE4/ue4-add-code-macro-in-build-cs.webp"></p>
<h2 id="编译DLL时报错LNK1561-entry-point-must-be-defined"><a href="#编译DLL时报错LNK1561-entry-point-must-be-defined" class="headerlink" title="编译DLL时报错LNK1561: entry point must be defined"></a>编译DLL时报错LNK1561: entry point must be defined</h2><p>编译DLL时报下列错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LINK : fatal error LNK1561: entry point must be defined</span><br></pre></td></tr></table></figure>

<p>在VS中项目右键<code>Properties</code>，在当前的编译配置下检查，配置类型是不是DLL：</p>
<p><img data-src="index/UE4/DLL-Compile-Error-Link1561-ConfigurationType.webp"></p>
<p>以及<code>Configuration Porperties</code>-<code>Linker</code>-<code>System</code>-<code>SubSystem</code>项：</p>
<p><img data-src="index/UE4/DLL-Compile-Error-Link1561-Linker-System.webp"></p>
<p>改完之后重新编译即可。</p>
<h2 id="cpp中包含的第一个-h必须是自身类的"><a href="#cpp中包含的第一个-h必须是自身类的" class="headerlink" title="cpp中包含的第一个.h必须是自身类的"></a>cpp中包含的第一个.h必须是自身类的</h2><p>不然会有下列的错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\imzlp\Documents\Unreal Projects\GWorld\Source\GWorld\Private\GWorldGameEngine.cpp(1): error : Expected GWorldGameEngine.h to be first header included.</span><br></pre></td></tr></table></figure>


<h2 id="修改游戏打包的进程名和Icon"><a href="#修改游戏打包的进程名和Icon" class="headerlink" title="修改游戏打包的进程名和Icon"></a>修改游戏打包的进程名和Icon</h2><p>打开项目设置(Project Settings)找到<code>Project</code>-<code>Description</code>下的<code>ProjectName</code>，修改这个参数为你想要的运行时创建的进程名(默认为<code>UEGame</code>)。</p>
<p>修改各个平台的Icon则在项目设置中找到<code>Platforms</code>下的各个平台，以<code>Windows</code>为例：</p>
<p><img data-src="index/UE4/UE4-Change-Project-Package-Icon.webp"></p>
<p>设置完之后会在项目目录下创建一个<code>Build/Windows/Application.ico</code>的文件。</p>
<h2 id="SetActorHiddenInGame与SetVisibility的同步"><a href="#SetActorHiddenInGame与SetVisibility的同步" class="headerlink" title="SetActorHiddenInGame与SetVisibility的同步"></a>SetActorHiddenInGame与SetVisibility的同步</h2><p>对于所有逻辑都在服务器上跑的内容（不考虑本地先做效果以及延迟补偿）的情况下，使用UE的网络架构很方便，但是如果考虑到这些情况再直接用UE的同步(尤其是显示效果的同步)时会出现一些问题。</p>
<h3 id="AActor-SetActorHiddenInGame"><a href="#AActor-SetActorHiddenInGame" class="headerlink" title="AActor::SetActorHiddenInGame"></a>AActor::SetActorHiddenInGame</h3><p>当对一个同步的Actor在服务器上调用<code>SetActorHiddenInGame</code>的时，该操作会同步到客户端。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AActor::SetActorHiddenInGame</span><span class="params">( <span class="keyword">bool</span> bNewHidden )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (bHidden != bNewHidden)</span><br><span class="line">  &#123;</span><br><span class="line">    bHidden = bNewHidden;</span><br><span class="line">    MarkComponentsRenderStateDirty();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Actor::bHidden</code>的这个状态是同步的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPROPERTY(Interp, EditAnywhere, Category=Rendering, BlueprintReadOnly, replicated, meta=(DisplayName = <span class="string">&quot;Actor Hidden In Game&quot;</span>, SequencerTrackClass = <span class="string">&quot;MovieSceneVisibilityTrack&quot;</span>))</span><br><span class="line">  uint8 bHidden:<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>其他的非服务器客户端在接收到变量同步的事件后会调用<code>AActor::PostNetReceive</code>函数：</p>
<blockquote>
<p>Always called immediately after properties are received from the remote.</p>
</blockquote>
<p>可以看到，在客户端接收<code>bHidden</code>更改的变量之后，会调用本地的<code>AActor::SetActorHiddenInGame</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AActor::PostNetReceive</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!bNetCheckedInitialPhysicsState)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Initially we need to sync the state regardless of whether bRepPhysics has &quot;changed&quot; since it may not currently match IsSimulatingPhysics().</span></span><br><span class="line">    SyncReplicatedPhysicsSimulation();</span><br><span class="line">    ActorReplication::SavedbRepPhysics = ReplicatedMovement.bRepPhysics;</span><br><span class="line">    bNetCheckedInitialPhysicsState = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ExchangeB( bHidden, ActorReplication::SavedbHidden );</span><br><span class="line">  Exchange ( Owner, ActorReplication::SavedOwner );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bHidden != ActorReplication::SavedbHidden)</span><br><span class="line">  &#123;</span><br><span class="line">    SetActorHiddenInGame(ActorReplication::SavedbHidden);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Owner != ActorReplication::SavedOwner)</span><br><span class="line">  &#123;</span><br><span class="line">    SetOwner(ActorReplication::SavedOwner);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Role != ActorReplication::SavedRole)</span><br><span class="line">  &#123;</span><br><span class="line">    PostNetReceiveRole();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而<code>AActor::SetActorHiddenInGame</code>中做了<code>MarkComponentsRenderStateDirty()</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AActor::MarkComponentsRenderStateDirty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (UActorComponent* ActorComp : GetComponents())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (ActorComp &amp;&amp; ActorComp-&gt;IsRegistered())</span><br><span class="line">    &#123;</span><br><span class="line">      ActorComp-&gt;MarkRenderStateDirty();</span><br><span class="line">      <span class="keyword">if</span> (UChildActorComponent* ChildActorComponent = Cast&lt;UChildActorComponent&gt;(ActorComp))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (ChildActorComponent-&gt;GetChildActor())</span><br><span class="line">        &#123;</span><br><span class="line">          ChildActorComponent-&gt;GetChildActor()-&gt;MarkComponentsRenderStateDirty();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会把Actor上所有注册过的组件标记为不渲染，从而实现了服务器调用<code>SetActorHiddenInGame</code>会同步到其他客户端的目的。</p>
<h3 id="USceneComponent-SetVisibility"><a href="#USceneComponent-SetVisibility" class="headerlink" title="USceneComponent::SetVisibility"></a>USceneComponent::SetVisibility</h3><p>当UE的<code>USceneComponent</code>被设置为<code>Component Replications</code>时，在服务器上调用<code>SetVisibility</code>会同步到客户端，内部的机制也是变量同步(相同的状态不会传递给其他的客户端)。</p>
<p><code>USceneComponent::SetVisibility</code>的代码如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USceneComponent::SetVisibility</span><span class="params">(<span class="keyword">const</span> <span class="keyword">bool</span> bNewVisibility, <span class="keyword">const</span> USceneComponent::EVisibilityPropagation PropagateToChildren)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bRecurseChildren = (PropagateToChildren == EVisibilityPropagation::Propagate);</span><br><span class="line">  <span class="keyword">if</span> ( bNewVisibility != bVisible )</span><br><span class="line">  &#123;</span><br><span class="line">    bRecurseChildren = bRecurseChildren || (PropagateToChildren == EVisibilityPropagation::DirtyOnly);</span><br><span class="line">    bVisible = bNewVisibility;</span><br><span class="line">    OnVisibilityChanged();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> TArray&lt;USceneComponent*&gt;&amp; AttachedChildren = GetAttachChildren();</span><br><span class="line">  <span class="keyword">if</span> (bRecurseChildren &amp;&amp; AttachedChildren.Num() &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// fully traverse down the attachment tree</span></span><br><span class="line">    <span class="comment">// we do it entirely inline here instead of recursing in case a primitivecomponent is a child of a non-primitivecomponent</span></span><br><span class="line">    TInlineComponentArray&lt;USceneComponent*, NumInlinedActorComponents&gt; ComponentStack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prime the pump</span></span><br><span class="line">    ComponentStack.Append(AttachedChildren);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ComponentStack.Num() &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      USceneComponent* <span class="keyword">const</span> CurrentComp = ComponentStack.Pop(<span class="comment">/*bAllowShrinking=*/</span> <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (CurrentComp)</span><br><span class="line">      &#123;</span><br><span class="line">        ComponentStack.Append(CurrentComp-&gt;GetAttachChildren());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PropagateToChildren == EVisibilityPropagation::Propagate)</span><br><span class="line">        &#123;</span><br><span class="line">          CurrentComp-&gt;SetVisibility(bNewVisibility, EVisibilityPropagation::NoPropagation);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Render state must be dirtied if any parent component&#x27;s visibility has changed. Since we can&#x27;t easily track whether </span></span><br><span class="line">        <span class="comment">// any parent in the hierarchy was dirtied, we have to mark dirty always.</span></span><br><span class="line">        CurrentComp-&gt;MarkRenderStateDirty();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过检测之后它会将变量<code>bVisible</code>设置为新的状态，这个变量是设置为同步的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Whether to completely draw the primitive; if false, the primitive is not drawn, does not cast a shadow. */</span></span><br><span class="line">UPROPERTY(EditAnywhere, BlueprintReadOnly, ReplicatedUsing=OnRep_Visibility,  Category = Rendering)</span><br><span class="line">  uint8 bVisible:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USceneComponent::OnRep_Visibility</span><span class="params">(<span class="keyword">bool</span> OldValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> ReppedValue = bVisible;</span><br><span class="line">  bVisible = OldValue;</span><br><span class="line">  SetVisibility(ReppedValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以对于标记为<code>Component Replications</code>的组件在服务器上调用<code>SetVisibility</code>时会同步让客户端的也显示。<br>因为这一点性质在做网络同步时，同步状态的组件和显示效果的组件一定要分割开。</p>
<h3 id="USceneComponent-SetHiddenInGame"><a href="#USceneComponent-SetHiddenInGame" class="headerlink" title="USceneComponent::SetHiddenInGame"></a>USceneComponent::SetHiddenInGame</h3><p><code>USceneComponent::SetHiddenInGame</code>是不同步的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/Engine/Private/Components/SceneComponent.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USceneComponent::SetHiddenInGame</span><span class="params">(<span class="keyword">const</span> <span class="keyword">bool</span> bNewHiddenGame, <span class="keyword">const</span> USceneComponent::EVisibilityPropagation PropagateToChildren)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> bRecurseChildren = (PropagateToChildren == EVisibilityPropagation::Propagate);</span><br><span class="line">  <span class="keyword">if</span> ( bNewHiddenGame != bHiddenInGame )</span><br><span class="line">  &#123;</span><br><span class="line">    bRecurseChildren = bRecurseChildren || (PropagateToChildren == EVisibilityPropagation::DirtyOnly);</span><br><span class="line">    bHiddenInGame = bNewHiddenGame;</span><br><span class="line">    OnHiddenInGameChanged();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> TArray&lt;USceneComponent*&gt;&amp; AttachedChildren = GetAttachChildren();</span><br><span class="line">  <span class="keyword">if</span> (bRecurseChildren &amp;&amp; AttachedChildren.Num() &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// fully traverse down the attachment tree</span></span><br><span class="line">    <span class="comment">// we do it entirely inline here instead of recursing in case a primitivecomponent is a child of a non-primitivecomponent</span></span><br><span class="line">    TInlineComponentArray&lt;USceneComponent*, NumInlinedActorComponents&gt; ComponentStack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prime the pump</span></span><br><span class="line">    ComponentStack.Append(AttachedChildren);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (ComponentStack.Num() &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      USceneComponent* <span class="keyword">const</span> CurrentComp = ComponentStack.Pop(<span class="comment">/*bAllowShrinking=*/</span> <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (CurrentComp)</span><br><span class="line">      &#123;</span><br><span class="line">        ComponentStack.Append(CurrentComp-&gt;GetAttachChildren());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PropagateToChildren == EVisibilityPropagation::Propagate)</span><br><span class="line">        &#123;</span><br><span class="line">          CurrentComp-&gt;SetHiddenInGame(bNewHiddenGame, EVisibilityPropagation::NoPropagation);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Render state must be dirtied if any parent component&#x27;s visibility has changed. Since we can&#x27;t easily track whether </span></span><br><span class="line">        <span class="comment">// any parent in the hierarchy was dirtied, we have to mark dirty always.</span></span><br><span class="line">        CurrentComp-&gt;MarkRenderStateDirty();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与<code>AActoe::SetHiddenInGame</code>类似的写法，不过区别在于<code>USceneComponent::SetHiddenInGame</code>设置的变量<code>bHiddenInGame</code>是不同步的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPROPERTY(Interp, EditAnywhere, BlueprintReadOnly, Category=Rendering, meta=(SequencerTrackClass = <span class="string">&quot;MovieSceneVisibilityTrack&quot;</span>))</span><br><span class="line">  uint8 bHiddenInGame:<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id="行为树Task的ReceiveTickAI与ReceiveTick的区别"><a href="#行为树Task的ReceiveTickAI与ReceiveTick的区别" class="headerlink" title="行为树Task的ReceiveTickAI与ReceiveTick的区别"></a>行为树Task的ReceiveTickAI与ReceiveTick的区别</h2><p>调用代码在<code>UBTTask_BlueprintBase::ExecuteTask</code>里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">EBTNodeResult::Type UBTTask_BlueprintBase::ExecuteTask(UBehaviorTreeComponent&amp; OwnerComp, uint8* NodeMemory)</span><br><span class="line">&#123;</span><br><span class="line">  &#x2F;&#x2F; fail when task doesn&#39;t react to execution (start or tick)</span><br><span class="line">  CurrentCallResult &#x3D; (ReceiveExecuteImplementations !&#x3D; 0 || ReceiveTickImplementations !&#x3D; 0) ? EBTNodeResult::InProgress : EBTNodeResult::Failed;</span><br><span class="line">  bIsAborting &#x3D; false;</span><br><span class="line"></span><br><span class="line">  if (ReceiveExecuteImplementations !&#x3D; FBTNodeBPImplementationHelper::NoImplementation)</span><br><span class="line">  &#123;</span><br><span class="line">    bStoreFinishResult &#x3D; true;</span><br><span class="line"></span><br><span class="line">    if (AIOwner !&#x3D; nullptr &amp;&amp; (ReceiveExecuteImplementations &amp; FBTNodeBPImplementationHelper::AISpecific))</span><br><span class="line">    &#123;</span><br><span class="line">      ReceiveExecuteAI(AIOwner, AIOwner-&gt;GetPawn());</span><br><span class="line">    &#125;</span><br><span class="line">    else if (ReceiveExecuteImplementations &amp; FBTNodeBPImplementationHelper::Generic)</span><br><span class="line">    &#123;</span><br><span class="line">      ReceiveExecute(ActorOwner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bStoreFinishResult &#x3D; false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return CurrentCallResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到<code>ReceiveTickAI</code>与<code>ReceiveTick</code>的区别是判断了<code>AIOwner</code>(<code>AAIController*</code>)是否存在，正常来说，运行了行为树<code>AAIController::RunBehaviorTask</code>，其Controller是肯定会存在的，可能只是为了区分参数吧。</p>
<h2 id="Actor的Connection"><a href="#Actor的Connection" class="headerlink" title="Actor的Connection"></a>Actor的Connection</h2><p><code>AActor::GetNetConnection</code>获取的是当前Actor的Owner的Connection(递归获取)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UNetConnection* <span class="title">AActor::GetNetConnection</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Owner ? Owner-&gt;GetNetConnection() : <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>APawn::GetNetConnection</code>重写了这个函数，获取的是当前Pawn的Controller的Connection：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">class UNetConnection* <span class="title">APawn::GetNetConnection</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// if have a controller, it has the net connection</span></span><br><span class="line">  <span class="keyword">if</span> ( Controller )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> Controller-&gt;GetNetConnection();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Super::GetNetConnection();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<code>AController</code>也是继承于Actor的，<code>APlayerController</code>中重写了这个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UNetConnection* <span class="title">APlayerController::GetNetConnection</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// A controller without a player has no &quot;owner&quot;</span></span><br><span class="line">  <span class="keyword">return</span> (Player != <span class="literal">NULL</span>) ? NetConnection : <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取的是<code>APlayerController</code>的<code>NetConnection</code>成员，该成员是在<code>APlayerController::SetPlayer</code>中被赋值为参数<code>InPlayer</code>的，<code>UNetConnection</code>继承自<code>UPlayer</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">APlayerController::SetPlayer</span><span class="params">( UPlayer* InPlayer )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  check(InPlayer!=<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> bIsSameLevel = InPlayer-&gt;PlayerController &amp;&amp; (InPlayer-&gt;PlayerController-&gt;GetLevel() == GetLevel());</span><br><span class="line">  <span class="comment">// Detach old player if it&#x27;s in the same level.</span></span><br><span class="line">  <span class="keyword">if</span> (bIsSameLevel)</span><br><span class="line">  &#123;</span><br><span class="line">    InPlayer-&gt;PlayerController-&gt;Player = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the viewport.</span></span><br><span class="line">  Player = InPlayer;</span><br><span class="line">  InPlayer-&gt;PlayerController = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cap outgoing rate to max set by server</span></span><br><span class="line">  UNetDriver* Driver = GetWorld()-&gt;GetNetDriver();</span><br><span class="line">  <span class="keyword">if</span>( (ClientCap&gt;=<span class="number">2600</span>) &amp;&amp; Driver &amp;&amp; Driver-&gt;ServerConnection )</span><br><span class="line">  &#123;</span><br><span class="line">    Player-&gt;CurrentNetSpeed = Driver-&gt;ServerConnection-&gt;CurrentNetSpeed = FMath::Clamp( ClientCap, <span class="number">1800</span>, Driver-&gt;MaxClientRate );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initializations only for local players</span></span><br><span class="line">  ULocalPlayer *LP = Cast&lt;ULocalPlayer&gt;(InPlayer);</span><br><span class="line">  <span class="keyword">if</span> (LP != <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Clients need this marked as local (server already knew at construction time)</span></span><br><span class="line">    SetAsLocalPlayerController();</span><br><span class="line">    LP-&gt;InitOnlineSession();</span><br><span class="line">    InitInputSystem();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    NetConnection = Cast&lt;UNetConnection&gt;(InPlayer);</span><br><span class="line">    <span class="keyword">if</span> (NetConnection)</span><br><span class="line">    &#123;</span><br><span class="line">      NetConnection-&gt;OwningActor = <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  UpdateStateInputComponents();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENABLE_VISUAL_LOG</span></span><br><span class="line">  <span class="keyword">if</span> (Role == ROLE_Authority &amp;&amp; FVisualLogger::Get().IsRecordingOnServer())</span><br><span class="line">  &#123;</span><br><span class="line">    OnServerStartedVisualLogger(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// notify script that we&#x27;ve been assigned a valid player</span></span><br><span class="line">  ReceivedPlayer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="uasset-format"><a href="#uasset-format" class="headerlink" title="uasset format"></a>uasset format</h2><h3 id="FPackageFileSummary"><a href="#FPackageFileSummary" class="headerlink" title="FPackageFileSummary"></a>FPackageFileSummary</h3><p><strong>Tag</strong></p>
<ul>
<li><code>PACKAGE_FILE_TAG</code>/<code>PACKAGE_FILE_TAG_SWAPPED</code>:定义在<code>Runtime/Core/Public/UObject/ObjectVersion.h</code>中</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKAGE_FILE_TAG      0x9E2A83C1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKAGE_FILE_TAG_SWAPPED  0xC1832A9E</span></span><br></pre></td></tr></table></figure>
<p>这个MigicNumber可以打开<code>uasset</code>文件，文件头的前四个字节即是。</p>
<p><strong>FileVersionUE4</strong>与<strong>FileVersionLicenseeUE4</strong><br><code>Engine/Source/Runtime/Core/Private/UObject/ObjectVersion.cpp</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @see ObjectVersion.h for the list of changes/defines</span></span><br><span class="line"><span class="keyword">const</span> int32 GPackageFileUE4Version = VER_LATEST_ENGINE_UE4;</span><br><span class="line"><span class="keyword">const</span> int32 GPackageFileLicenseeUE4Version = VER_LATEST_ENGINE_LICENSEEUE4;</span><br></pre></td></tr></table></figure>

<p>uasset的存储是写在<code>FLinkerSave</code>的构造函数中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/CoreUObject/Private/LinkerSave.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** A mapping of package name to generated script SHA keys */</span></span><br><span class="line">TMap&lt;FString, TArray&lt;uint8&gt; &gt; FLinkerSave::PackagesToScriptSHAMap;</span><br><span class="line"></span><br><span class="line">FLinkerSave::FLinkerSave(UPackage* InParent, <span class="keyword">const</span> TCHAR* InFilename, <span class="keyword">bool</span> bForceByteSwapping, <span class="keyword">bool</span> bInSaveUnversioned)</span><br><span class="line">:  FLinker(ELinkerType::Save, InParent, InFilename )</span><br><span class="line">,  Saver(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (FPlatformProperties::HasEditorOnlyData())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Create file saver.</span></span><br><span class="line">    Saver = IFileManager::Get().CreateFileWriter( InFilename, <span class="number">0</span> );</span><br><span class="line">    <span class="keyword">if</span>( !Saver )</span><br><span class="line">    &#123;</span><br><span class="line">      UE_LOG(LogLinker, Fatal, TEXT(<span class="string">&quot;%s&quot;</span>), *FString::Printf( TEXT(<span class="string">&quot;Error opening file &#x27;%s&#x27;.&quot;</span>), InFilename ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UPackage* Package = <span class="keyword">dynamic_cast</span>&lt;UPackage*&gt;(LinkerRoot);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set main summary info.</span></span><br><span class="line">    Summary.Tag           = PACKAGE_FILE_TAG;</span><br><span class="line">    Summary.SetFileVersions( GPackageFileUE4Version, GPackageFileLicenseeUE4Version, bInSaveUnversioned );</span><br><span class="line">    Summary.SavedByEngineVersion = FEngineVersion::Current();</span><br><span class="line">    Summary.CompatibleWithEngineVersion = FEngineVersion::CompatibleWith();</span><br><span class="line">    Summary.PackageFlags = Package ? (Package-&gt;GetPackageFlags() &amp; ~PKG_NewlyCreated) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_STABLE_LOCALIZATION_KEYS</span></span><br><span class="line">    <span class="keyword">if</span> (GIsEditor)</span><br><span class="line">    &#123;</span><br><span class="line">      Summary.LocalizationId = TextNamespaceUtil::GetPackageNamespace(LinkerRoot);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// USE_STABLE_LOCALIZATION_KEYS</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Package)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITORONLY_DATA</span></span><br><span class="line">      Summary.FolderName = Package-&gt;GetFolderName().ToString();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      Summary.ChunkIDs = Package-&gt;GetChunkIDs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set status info.</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;SetIsSaving(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">this</span>-&gt;SetIsPersistent(<span class="literal">true</span>);</span><br><span class="line">    ArForceByteSwapping    = bForceByteSwapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_STABLE_LOCALIZATION_KEYS</span></span><br><span class="line">    <span class="keyword">if</span> (GIsEditor)</span><br><span class="line">    &#123;</span><br><span class="line">      SetLocalizationNamespace(Summary.LocalizationId);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// USE_STABLE_LOCALIZATION_KEYS</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9fea500aaa4d">UE4对象序列化和uaset格式</a></li>
</ul>
<h2 id="DECLARE-CLASS与Super"><a href="#DECLARE-CLASS与Super" class="headerlink" title="DECLARE_CLASS与Super"></a>DECLARE_CLASS与Super</h2><p>UE中的实现中使用了大量的宏，比如<code>UObject::StaticClass</code>的定义并没有直接写在<code>Object.h</code>中，而是使用<code>DECLARE_CLASS</code>宏来实现的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime/CoreUObject/Public/UObject/ObjectMacros.h</span></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">  Class declaration macros.</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_CLASS( TClass, TSuperClass, TStaticFlags, TStaticCastFlags, TPackage, TRequiredAPI  ) \</span></span><br><span class="line"><span class="keyword">private</span>: \</span><br><span class="line">    TClass&amp; <span class="keyword">operator</span>=(TClass&amp;&amp;);   \</span><br><span class="line">    TClass&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> TClass&amp;);   \</span><br><span class="line">  <span class="function">TRequiredAPI <span class="keyword">static</span> UClass* <span class="title">GetPrivateStaticClass</span><span class="params">()</span></span>; \</span><br><span class="line"><span class="keyword">public</span>: \</span><br><span class="line">  <span class="comment">/** Bitwise union of #EClassFlags pertaining to this class.*/</span> \</span><br><span class="line">  <span class="keyword">enum</span> &#123;StaticClassFlags=TStaticFlags&#125;; \</span><br><span class="line">  <span class="comment">/** Typedef for the base class (&#123;&#123; typedef-type &#125;&#125;) */</span> \</span><br><span class="line">  <span class="keyword">typedef</span> TSuperClass Super;\</span><br><span class="line">  <span class="comment">/** Typedef for &#123;&#123; typedef-type &#125;&#125;. */</span> \</span><br><span class="line">  <span class="keyword">typedef</span> TClass ThisClass;\</span><br><span class="line">  <span class="comment">/** Returns a UClass object representing this class at runtime */</span> \</span><br><span class="line">  inline static UClass* StaticClass() \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="keyword">return</span> GetPrivateStaticClass(); \</span><br><span class="line">  &#125; \</span><br><span class="line">  <span class="comment">/** Returns the package this class belongs in */</span> \</span><br><span class="line">  inline static const TCHAR* StaticPackage() \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="keyword">return</span> TPackage; \</span><br><span class="line">  &#125; \</span><br><span class="line">  <span class="comment">/** Returns the static cast flags for this class */</span> \</span><br><span class="line">  inline static EClassCastFlags StaticClassCastFlags() \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="keyword">return</span> TStaticCastFlags; \</span><br><span class="line">  &#125; \</span><br><span class="line">  <span class="comment">/** For internal use only; use StaticConstructObject() to create new objects. */</span> \</span><br><span class="line">  inline void* operator new(const size_t InSize, EInternal InInternalOnly, UObject* InOuter = (UObject*)GetTransientPackage(), FName InName = NAME_None, EObjectFlags InSetFlags = RF_NoFlags) \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="keyword">return</span> StaticAllocateObject(StaticClass(), InOuter, InName, InSetFlags); \</span><br><span class="line">  &#125; \</span><br><span class="line">  <span class="comment">/** For internal use only; use StaticConstructObject() to create new objects. */</span> \</span><br><span class="line">  inline void* operator new( const size_t InSize, EInternal* InMem ) \</span><br><span class="line">  &#123; \</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span>*)InMem; \</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>该宏在UObject的声明中使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">COREUOBJECT_API</span> <span class="title">UObject</span> :</span> <span class="keyword">public</span> UObjectBaseUtility</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Declarations, normally created by UnrealHeaderTool boilerplate code</span></span><br><span class="line">  DECLARE_CLASS(UObject,UObject,CLASS_Abstract|CLASS_NoExport|CLASS_Intrinsic|CLASS_MatchedSerializers,CASTCLASS_None,TEXT(<span class="string">&quot;/Script/CoreUObject&quot;</span>),NO_API)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>注意：这个宏在UHT生成的<code>xxxx.generated.h</code>中被使用，本质就是在继承后的类中也使用了<code>DECLARE_CLass</code>宏，并且把其中所有的<code>typedef</code>和函数都定义了一遍，由于name hidden，在当前类的namespace下使用typedef或者调用其中的函数，都是当前类定义的。<br>比如，<code>ABaseActor</code>继承自<code>AActor</code>，那么我在<code>ABaseActor</code>中使用<code>Super</code>，使用的是<code>AAcotr::Super</code>，而不是更深的继承层次的<code>Super</code>。</p>
<h2 id="GenerateProjectFiles-bat运行错误2"><a href="#GenerateProjectFiles-bat运行错误2" class="headerlink" title="GenerateProjectFiles.bat运行错误2"></a>GenerateProjectFiles.bat运行错误2</h2><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Setting up Unreal Engine <span class="number">4</span> project files...</span><br><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">Studio</span>\2017\<span class="title">Enterprise</span>\<span class="title">MSBuild</span>\15.0\<span class="title">Bin</span></span></span><br><span class="line"><span class="function">\<span class="title">Microsoft.Common.CurrentVersion.targets</span>(1179,5): <span class="title">error</span> <span class="title">MSB3644</span>: 未找到框架“.<span class="title">NETFram</span></span></span><br><span class="line"><span class="function"><span class="title">ework</span>,<span class="title">Version</span>=<span class="title">v4</span>.6.2”的引用程序集。若要解决此问题，请安装此框架版本的 <span class="title">SDK</span> 或 <span class="title">Targeting</span> <span class="title">Pack</span>，或将应用程序的目标重新指</span></span><br><span class="line"><span class="function">向已装有 <span class="title">SDK</span> 或 <span class="title">Targeting</span> <span class="title">Pack</span> 的框架版本。请注意，将从全局程序集缓存(<span class="title">GAC</span>)解析程序集，并将使用这些程序集替换引用程序集。因此，程序集</span></span><br><span class="line"><span class="function">的目标可能未正确指向您所预期的框架。 [<span class="title">D</span>:\<span class="title">UnrealEngine</span>\<span class="title">Offical_Source</span>\4.22\<span class="title">Engine</span>\<span class="title">Source</span>\<span class="title">Programs</span>\</span></span><br><span class="line"><span class="function"><span class="title">UnrealBuildTool</span>\<span class="title">UnrealBuildTool.csproj</span>]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">GenerateProjectFiles</span> <span class="title">ERROR</span>: <span class="title">UnrealBuildTool</span> <span class="title">failed</span> <span class="title">to</span> <span class="title">compile</span>.</span></span><br></pre></td></tr></table></figure>
<p>这是因为<code>Engine\Source\Programs\ UnrealBuildTool\UnrealBuildTool.csproj</code>中指定的.NetFramework版本与本地已经安装的不匹配。</p>
<p>首先，先查看本机安装的.NetFramework版本，可以打开注册表：<br><img data-src="index/dotNetFrameWorkVersionNumberInRegister.webp"></p>
<p>我的是<code>528040</code>，可以通过微软的网站查到不同的数字对应的版本号：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed">如何：确定已安装的 .NET Framework 版本</a>.</p>
<p>可以看到.NetFramework的版本号对照：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full</span><br></pre></td></tr></table></figure>
<p>找到<code>Release</code>项，其是一个<code>REG_DWORD</code>值。</p>
<table>
<thead>
<tr>
<th align="center">.NET Framework 版本</th>
<th align="left">Release DWORD 的值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">.NET Framework 4.5</td>
<td align="left">所有 Windows 操作系统：378389</td>
</tr>
<tr>
<td align="center">.NET Framework 4.5.1</td>
<td align="left">在 Windows 8.1 和 Windows Server 2012 R2 上：378675<br/>在所有其他 Windows 操作系统上：378758</td>
</tr>
<tr>
<td align="center">.NET Framework 4.5.2</td>
<td align="left">所有 Windows 操作系统：379893</td>
</tr>
<tr>
<td align="center">.NET Framework 4.6</td>
<td align="left">在 Windows 10 上：393295<br/>在所有其他 Windows 操作系统上：393297</td>
</tr>
<tr>
<td align="center">.NET Framework 4.6.1</td>
<td align="left">在 Windows 10 11 月更新系统上：394254<br/>在所有其他 Windows 操作系统（包括 Windows 10）上：394271</td>
</tr>
<tr>
<td align="center">.NET Framework 4.6.2</td>
<td align="left">在 Windows 10 周年更新和 Windows Server 2016 上：394802<br/>在所有其他 Windows 操作系统（包括其他 Windows 10 操作系统）上：394806</td>
</tr>
<tr>
<td align="center">.NET Framework 4.7</td>
<td align="left">在 Windows 10 创意者更新上：460798<br/>在所有其他 Windows 操作系统（包括其他 Windows 10 操作系统）上：460805</td>
</tr>
<tr>
<td align="center">.NET Framework 4.7.1</td>
<td align="left">在 Windows 10 Fall Creators Update 和 Windows Server 版本 1709 上：461308<br/>在所有其他 Windows 操作系统（包括其他 Windows 10 操作系统）上：461310</td>
</tr>
<tr>
<td align="center">.NET Framework 4.7.2</td>
<td align="left">在 Windows 10 2018 年 4 月更新和 Windows Server 版本 1803 上：461808<br/>在除 Windows 10 2018 年 4 月更新和 Windows Server 版本 1803 之外的所有 Windows 操作系统上：461814</td>
</tr>
<tr>
<td align="center">.NET Framework 4.8</td>
<td align="left">在 Windows 10 2019 年 5 月更新上：528040<br/>在所有其他 Windows 操作系统（包括其他 Windows 10 操作系统）上：528049</td>
</tr>
</tbody></table>
<p>通过这个对照表可以看到，我电脑上装的是.NET Framework 4.8，但是UBT的<code>csproj</code>文件里指定的是4.6.2，找不到对应的版本就产生了错误。<br>一个最简单的解决办法是打开visual studio install勾选上想要安装的.NetFramework版本安装即可。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/44548780/the-reference-assemblies-for-framework-netframework-version-v4-6-2-were-not-f">The reference assemblies for framework “.NETFramework,Version=v4.6.2” were not found</a></li>
</ul>
<h2 id="GenerateProjectFiles-bat运行错误1"><a href="#GenerateProjectFiles-bat运行错误1" class="headerlink" title="GenerateProjectFiles.bat运行错误1"></a>GenerateProjectFiles.bat运行错误1</h2><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Setting up Unreal Engine <span class="number">4</span> project files...</span><br><span class="line">While compiling E:\UnrealEngine\EngineSource\UE_4.<span class="number">21</span>_Source\Engine\Intermediate\Build\BuildRules\UE4Rules.dll:</span><br><span class="line"><span class="function">e:\<span class="title">UnrealEngine</span>\<span class="title">EngineSource</span>\<span class="title">UE_4</span>.21<span class="title">_Source</span>\<span class="title">Engine</span>\<span class="title">Plugins</span>\<span class="title">Experimental</span>\<span class="title">GeometryCache</span>\<span class="title">Source</span>\<span class="title">GeometryCache</span>\<span class="title">GeometryCache.Build.cs</span>(5,14) : <span class="title">error</span> <span class="title">CS0101</span>: 命名空间“&lt;全局命名空间&gt;”已经包含了“<span class="title">GeometryCache</span>”的定义</span></span><br><span class="line"><span class="function"><span class="title">e</span>:\<span class="title">UnrealEngine</span>\<span class="title">EngineSource</span>\<span class="title">UE_4</span>.21<span class="title">_Source</span>\<span class="title">Engine</span>\<span class="title">Plugins</span>\<span class="title">Experimental</span>\<span class="title">GeometryCache</span>\<span class="title">Source</span>\<span class="title">GeometryCacheEd</span>\<span class="title">GeometryCacheEd.Build.cs</span>(5,14) : <span class="title">error</span> <span class="title">CS0101</span>: 命名空间“&lt;全局命名空间&gt;”已经包含了“<span class="title">GeometryCacheEd</span>”的定义</span></span><br><span class="line"><span class="function"><span class="title">e</span>:\<span class="title">UnrealEngine</span>\<span class="title">EngineSource</span>\<span class="title">UE_4</span>.21<span class="title">_Source</span>\<span class="title">Engine</span>\<span class="title">Plugins</span>\<span class="title">Runtime</span>\<span class="title">HTNPlanner</span>\<span class="title">Source</span>\<span class="title">HTNPlanner</span>\<span class="title">HTNPlanner.Build.cs</span>(5,18) : <span class="title">error</span> <span class="title">CS0101</span>: 命名空间“<span class="title">UnrealBuildTool.Rules</span>”已经包含了“<span class="title">HTNPlanner</span>”的定义</span></span><br><span class="line"><span class="function"><span class="title">e</span>:\<span class="title">UnrealEngine</span>\<span class="title">EngineSource</span>\<span class="title">UE_4</span>.21<span class="title">_Source</span>\<span class="title">Engine</span>\<span class="title">Plugins</span>\<span class="title">Runtime</span>\<span class="title">HTNPlanner</span>\<span class="title">Source</span>\<span class="title">HTNTestSuite</span>\<span class="title">HTNTestSuite.Build.cs</span>(7,18) : <span class="title">error</span> <span class="title">CS0101</span>: 命名空间“<span class="title">UnrealBuildTool.Rules</span>”已经包含了“<span class="title">HTNTestSuite</span>”的定义</span></span><br><span class="line"><span class="function"><span class="title">e</span>:\<span class="title">UnrealEngine</span>\<span class="title">EngineSource</span>\<span class="title">UE_4</span>.21<span class="title">_Source</span>\<span class="title">Engine</span>\<span class="title">Plugins</span>\<span class="title">Runtime</span>\<span class="title">MixedRealityFramework</span>\<span class="title">Source</span>\<span class="title">ThirdParty</span>\<span class="title">OpenCV</span>\<span class="title">OpenCV.Build.cs</span>(6,14) : <span class="title">error</span> <span class="title">CS0101</span>: 命名空间“&lt;全局命名空间&gt;”已经包含了“<span class="title">OpenCV</span>”的定义</span></span><br><span class="line"><span class="function"><span class="title">ERROR</span>: <span class="title">UnrealBuildTool</span> <span class="title">Exception</span>: <span class="title">Unable</span> <span class="title">to</span> <span class="title">compile</span> <span class="title">source</span> <span class="title">files</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">GenerateProjectFiles</span> <span class="title">ERROR</span>: <span class="title">UnrealBuildTool</span> <span class="title">was</span> <span class="title">unable</span> <span class="title">to</span> <span class="title">generate</span> <span class="title">project</span> <span class="title">files</span>.</span></span><br></pre></td></tr></table></figure>
<p>这是因为所提示的文件已经存在，将报错提示的文件删除之后再重新运行<code>GenerateProjectFiles.bat</code>即可。</p>
<p>相关问题：<a target="_blank" rel="noopener" href="https://answers.unrealengine.com/questions/414620/build-error-on-generateprojectfiles.html">Build Error on GenerateProjectFiles</a></p>
<h2 id="UE添加Profiling统计信息：代码块的CPU计数周期"><a href="#UE添加Profiling统计信息：代码块的CPU计数周期" class="headerlink" title="UE添加Profiling统计信息：代码块的CPU计数周期"></a>UE添加Profiling统计信息：代码块的CPU计数周期</h2><p>在使用UnrealForntEnd来来抓取Profiling数据的时候，可以看到函数调用的开销信息，如果自己创建一个新的函数，则需要自己添加标记。可以使用<code>DECLARE_CYCLE_STAT</code>宏来声明(写在.cpp中)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE_CYCLE_STAT(TEXT(<span class="string">&quot;ProfilingDeclare&quot;</span>), STAT_ProfilingDeclare, STATGROUP_Profiling)</span><br></pre></td></tr></table></figure>
<p>使用的方法为用<code>SCOPE_CYCLE_COUNTER</code>宏，并传入前面声明中的第二个参数<code>ProfilingDeclare</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AExample::Func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    SOCPE_CYCLE_COUNTER(STAT_ProfilingDeclare);</span><br><span class="line">    <span class="comment">// Something</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.unrealengine.com/Profiling,_How_To_Count_CPU_Cycles_Of_Specific_Blocks_Of_Your_Game_Code">Profiling, How To Count CPU Cycles Of Specific Blocks Of Your Game Code</a></li>
</ul>
<h2 id="ON-SCOPE-EXIT"><a href="#ON-SCOPE-EXIT" class="headerlink" title="ON_SCOPE_EXIT"></a>ON_SCOPE_EXIT</h2><p>UE中有一个宏<code>ON_SCOPE_EXIT</code>，它的用法为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Make sure module info is added to known modules and proper delegates are fired on exit.</span></span><br><span class="line">ON_SCOPE_EXIT</span><br><span class="line">&#123;</span><br><span class="line">  FModuleManager::Get().AddModuleToModulesList(InModuleName, ModuleInfo);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在<a href="https://imzlp.com/posts/31203/">UE4 Modules:Find the DLL and load it</a>里曾提到过这种用法：</p>
<blockquote>
<p>这段代码的意思是在退出当前的作用域(Scope)时执行<code>&#123;&#125;</code>中的逻辑，简单地来说，它定义了一个当前作用域的对象并托管了一个Lambda，在离开当前作用域的时候通过C++的RAII机制来调用托管的Lambda.</p>
</blockquote>
<p>今天来简单分析一下它的实现。</p>
<p>首先，<code>ON_SCOPE_EXIT</code>的宏定义为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ON_SCOPE_EXIT const auto ANONYMOUS_VARIABLE(ScopeGuard_) = ::ScopeExitSupport::FScopeGuardSyntaxSupport() + [&amp;]()</span></span><br></pre></td></tr></table></figure>

<p>由此展开，最开始的那个使用的宏就等价替换为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">auto</span> <span class="title">ANONYMOUS_VARIABLE</span><span class="params">(ScopeGuard_)</span> </span>= ::ScopeExitSupport::FScopeGuardSyntaxSupport() + [&amp;]()&#123;</span><br><span class="line">    FModuleManager::Get().AddModuleToModulesList(InModuleName, ModuleInfo);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>通常lambda用在谓词和调用的时候还好理解，但是这个搞了个<code>+</code>有点不走寻常路，由此可以推断类型<code>::ScopeExitSupport::FScopeGuardSyntaxSupport</code>必然重载了<code>operator+</code>操作符，并且是个模板函数。</p>
<p>查看<code>::ScopeExitSupport::FScopeGuardSyntaxSupport</code>的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Misc\ScopeExit.h</span></span><br><span class="line"><span class="keyword">namespace</span> ScopeExitSupport</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Not meant for direct consumption : use ON_SCOPE_EXIT instead.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * RAII class that calls a lambda when it is destroyed.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> FuncType&gt;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">TScopeGuard</span> :</span> <span class="keyword">public</span> FNoncopyable</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Given a lambda, constructs an RAII scope guard.</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">TScopeGuard</span><span class="params">(FuncType&amp;&amp; InFunc)</span></span></span><br><span class="line"><span class="function">      : <span class="title">Func</span><span class="params">(MoveTemp(InFunc))</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This constructor needs to be available for the code to compile.</span></span><br><span class="line">    <span class="comment">// It will be almost definitely be RVOed out (even in DEBUG).</span></span><br><span class="line">    TScopeGuard(TScopeGuard&amp;&amp; Other)</span><br><span class="line">      : Func(MoveTemp(Other.Func))</span><br><span class="line">    &#123;</span><br><span class="line">      Other.Func.Reset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Causes</span></span><br><span class="line">    ~TScopeGuard()</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (Func.IsSet())</span><br><span class="line">      &#123;</span><br><span class="line">        Func.GetValue()();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// The lambda to be executed when this guard goes out of scope.</span></span><br><span class="line">    TOptional&lt;FuncType&gt; Func;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">FScopeGuardSyntaxSupport</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> FuncType&gt;</span><br><span class="line">    TScopeGuard&lt;FuncType&gt; <span class="keyword">operator</span>+(FuncType&amp;&amp; InFunc)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> TScopeGuard&lt;FuncType&gt;(Forward&lt;FuncType&gt;(InFunc));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>果然！类型<code>FScopeGuardSyntaxSupport</code>通过模板重载了<code>operator+</code>，它要求接收一个重载了<code>operator()</code>的泛型**函数对象(functional object)**类型，据此产生一个<code>TScopeGuard</code>的类型，并将传递进来的函数对象托管，在这个<code>TScopeGuard</code>的对象的析构函数中(destructor)调用了托管的函数对象。</p>
<p>其中隐藏的关键是通过<code>::ScopeExitSupport::FScopeGuardSyntaxSupport() + [&amp;]()&#123;&#125;</code>得到的<code>TScopeGuard</code>的对象是个**局部对象(automattic storage duration)**，只存在于当前的作用域(Scope)中，在离开当前作用域时会自动销毁(调用析构函数)，离开作用域时局部变量的销毁顺序为按定义的逆序执行。</p>
<blockquote>
<p>[ISO/IEC 14882:2014 § 6.6]On exit from a scope (however accomplished), objects with automatic storage duration (3.7.3) that have been constructed in that scope are destroyed in the reverse order of their construction.</p>
</blockquote>
<h2 id="Spawn特效被遮挡时在摄像机中不显示"><a href="#Spawn特效被遮挡时在摄像机中不显示" class="headerlink" title="Spawn特效被遮挡时在摄像机中不显示"></a>Spawn特效被遮挡时在摄像机中不显示</h2><p>遇到一个问题，当<code>SpawnEmitterAttached</code>一个特效时，如果该特效有被其他东西遮挡(但不是完全遮挡)，在摄像机中会看不到，转到另一面就能看到，这个问题需要检查一下特效的<code>Bounds</code>的大小，应该是Bounds太小了被其他的东西完全挡着了，有时间再来详细分析一下这个问题。</p>
<p><img data-src="index/UE4/ue4-spawn-emitter-isnt-visibility-in-camera.webp"></p>
<h2 id="MODULE-NAME-API"><a href="#MODULE-NAME-API" class="headerlink" title="MODULE_NAME_API"></a>MODULE_NAME_API</h2><p>UE中的模块，如果定义的符号允许被外部模块访问，则需要在class前加<code>MODULE_NAME_API</code>，这个宏是什么意思呢？<br>打开<code>Definitions.MODULE_NAME.h</code>这个文件可以知道，<code>MODULE_NAME_API</code>这个宏的定义是<code>DLLEXPORT</code>，看名字就知道是导出符号的，但是针对不同的平台是不一样的，<code>DLLEXPORT</code>和<code>DLLIMPORT</code>的宏是定义在<code>Runtime\Core\Public\$&#123;PLATFROM&#125;\$&#123;PLATFROM&#125;Platfrom.h</code>下的(Android与Linux 的相同)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Android\AndroidPlatform.h</span></span><br><span class="line"><span class="comment">// Runtime\Core\Public\Linux\LinuxPlatform.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL export and import definitions</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLEXPORT      __attribute__((visibility(<span class="meta-string">&quot;default&quot;</span>)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLIMPORT      __attribute__((visibility(<span class="meta-string">&quot;default&quot;</span>)))</span></span><br></pre></td></tr></table></figure>
<p>MacOS则是一个空的宏定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Mac\MacPlatform.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL export and import definitions</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLEXPORT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLIMPORT</span></span><br></pre></td></tr></table></figure>

<p>Windows的为<code>__declspec</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime\Core\Public\Windows\WIndowsPlatform.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DLL export and import definitions</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLEXPORT __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLLIMPORT __declspec(dllimport)</span></span><br></pre></td></tr></table></figure>

<h2 id="模块的宏定义"><a href="#模块的宏定义" class="headerlink" title="模块的宏定义"></a>模块的宏定义</h2><p>UE中模块的宏定义会汇总在这个文件下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intermediate\Build\Win64\UE4Editor\Development\NetExampleDemo\Definitions.MODULE_NAME.h</span><br></pre></td></tr></table></figure>
<p>其中定义了<code>MODULE_NAME_API</code>为<code>DLLEXPORT</code>，导出自己模块内的符号，还有引用的其他模块的<code>MODULE_NAME_API</code>为<code>DLLIMPORT</code>，导入引用模块内的符号，在编译时链接可用，还有一些宏开关。<br>类似于这样：<a href="index/UE4/Macro/Definitions.MODULENAME.h">Definations.WebBrowserEx.h</a></p>
<h2 id="Windows与MacOS双系统时间不一致的解决方案"><a href="#Windows与MacOS双系统时间不一致的解决方案" class="headerlink" title="Windows与MacOS双系统时间不一致的解决方案"></a>Windows与MacOS双系统时间不一致的解决方案</h2><p>因为MacOS读取时间为UTC时间，Windows直接读取BIOS时间为本地时间，所以在双系统时时间上会有8个小时的误差。<br>解决办法为，管理员权限打开CMD，执行下列命令：</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Reg add HKLM\SYSTEM\CurrentControlSet\Control\TimeZoneInformation /v RealTimeIsUniversal /t REG_DWORD /d <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="Listen-Server模式下的SkipOwner"><a href="#Listen-Server模式下的SkipOwner" class="headerlink" title="Listen Server模式下的SkipOwner"></a>Listen Server模式下的SkipOwner</h2><p>如果在监听服务器(<code>Listen Server</code>)的模式下，作为服务端的玩家设置同步的变量，如果该变量的<code>Replication Conditional</code>为<code>SkipOwner</code>（此时监听服务器为该Actor的Owner），则该监听客户端的<code>Rep_</code>方法也会执行(因为它既是服务器也是客户端)。<br>即如果在使用<code>SkipOwner</code>用来处理类似本地模拟的事件时，<code>LocallyControlled</code>Player触发的事件先看到效果，其他客户端走变量同步触发<code>Rep_</code>的逻辑，但在这种机制下作为监听服务器的处理逻辑会走两遍。</p>
<h2 id="SpawnSoundAtLocation失败的情况"><a href="#SpawnSoundAtLocation失败的情况" class="headerlink" title="SpawnSoundAtLocation失败的情况"></a>SpawnSoundAtLocation失败的情况</h2><p>UE中创建一个声音使用的是<code>UGameplatStatic::SpawnSoundAtLocation</code>，但是在项目中发现有时候它会被创建失败，看了一下代码，发现确实会存在创建失败的情况。<br>其调用栈如下：<br><img data-src="index/UE4/spawn-sound-at-location-call-stack.webp"><br>在<code>FAudioDevice::LocationIsAudible</code>中做了检测：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FAudioDevice::LocationIsAudible</span><span class="params">(<span class="keyword">const</span> FVector&amp; Location, <span class="keyword">const</span> <span class="keyword">float</span> MaxDistance)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (MaxDistance &gt;= WORLD_MAX)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> bInAudioThread = IsInAudioThread();</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> bInGameThread = IsInGameThread();</span><br><span class="line"></span><br><span class="line">  check(bInAudioThread || bInGameThread);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bInAudioThread)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> FListener&amp; Listener : Listeners)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (LocationIsAudible(Location, Listener.Transform, MaxDistance))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="comment">//if (bInGameThread)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> FTransform&amp; ListenerTransform : ListenerTransforms)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (LocationIsAudible(Location, ListenerTransform, MaxDistance))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FAudioDevice::LocationIsAudible</span><span class="params">(<span class="keyword">const</span> FVector&amp; Location, <span class="keyword">const</span> FTransform&amp; ListenerTransform, <span class="keyword">float</span> MaxDistance)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (MaxDistance &gt;= WORLD_MAX)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">float</span> MaxDistanceSquared = MaxDistance * MaxDistance;</span><br><span class="line">  <span class="keyword">return</span> (ListenerTransform.GetTranslation() - Location).SizeSquared() &lt; MaxDistanceSquared;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过检测Spawn的位置和声音的距离来判断这个创建的声音能不能被任何Listener听到，如果不能则不会创建。<br><code>Listener</code>在<code>UGameViewportClient::Draw</code>中被设置：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Update the listener.</span></span><br><span class="line"><span class="keyword">if</span> (AudioDevice != <span class="literal">NULL</span> &amp;&amp; PlayerController != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">bool</span> bUpdateListenerPosition = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the main audio device is used for multiple PIE viewport clients, we only</span></span><br><span class="line">  <span class="comment">// want to update the main audio device listener position if it is in focus</span></span><br><span class="line">  <span class="keyword">if</span> (GEngine)</span><br><span class="line">  &#123;</span><br><span class="line">    FAudioDeviceManager* AudioDeviceManager = GEngine-&gt;GetAudioDeviceManager();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there is more than one world referencing the main audio device</span></span><br><span class="line">    <span class="keyword">if</span> (AudioDeviceManager-&gt;GetNumMainAudioDeviceWorlds() &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      uint32 MainAudioDeviceHandle = GEngine-&gt;GetAudioDeviceHandle();</span><br><span class="line">      <span class="keyword">if</span> (AudioDevice-&gt;DeviceHandle == MainAudioDeviceHandle &amp;&amp; !bHasAudioFocus)</span><br><span class="line">      &#123;</span><br><span class="line">        bUpdateListenerPosition = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bUpdateListenerPosition)</span><br><span class="line">  &#123;</span><br><span class="line">    FVector Location;</span><br><span class="line">    FVector ProjFront;</span><br><span class="line">    FVector ProjRight;</span><br><span class="line">    PlayerController-&gt;GetAudioListenerPosition(<span class="comment">/*out*/</span> Location, <span class="comment">/*out*/</span> ProjFront, <span class="comment">/*out*/</span> ProjRight);</span><br><span class="line"></span><br><span class="line">    <span class="function">FTransform <span class="title">ListenerTransform</span><span class="params">(FRotationMatrix::MakeFromXY(ProjFront, ProjRight))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow the HMD to adjust based on the head position of the player, as opposed to the view location</span></span><br><span class="line">    <span class="keyword">if</span> (GEngine-&gt;XRSystem.IsValid() &amp;&amp; GEngine-&gt;StereoRenderingDevice.IsValid() &amp;&amp; GEngine-&gt;StereoRenderingDevice-&gt;IsStereoEnabled())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> FVector Offset = GEngine-&gt;XRSystem-&gt;GetAudioListenerOffset();</span><br><span class="line">      Location += ListenerTransform.TransformPositionNoScale(Offset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ListenerTransform.SetTranslation(Location);</span><br><span class="line">    ListenerTransform.NormalizeRotation();</span><br><span class="line"></span><br><span class="line">    uint32 ViewportIndex = PlayerViewMap.Num() - <span class="number">1</span>;</span><br><span class="line">    AudioDevice-&gt;SetListener(MyWorld, ViewportIndex, ListenerTransform, (View-&gt;bCameraCut ? <span class="number">0.f</span> : MyWorld-&gt;GetDeltaSeconds()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Listener的位置是通过<code>PlayerController::GetAudioListenerPosition</code>来获取的，而该函数获取的是<code>AudioListenerComponent</code>的位置和旋转，可以通过<code>PlayerController::SetAudioListenerOverride</code>来设置使用的组件。</p>
<p>PS:只有在当前的<code>AudioDevice</code>为<code>MainAudioDevice</code>并且不在焦点的时候才不会更新Listener的位置。</p>
<p>或许这个限制是由于性能优化的考虑，但是也十分坑爹，因为如果在最开始的时候(组件的BeginPlay)创建一个声音，可能挂载的Actor的位置是在原点的，不在任何Listener的范围内，则就会创建失败。</p>
<h2 id="注意RPC的调用不是严格顺序的"><a href="#注意RPC的调用不是严格顺序的" class="headerlink" title="注意RPC的调用不是严格顺序的"></a>注意RPC的调用不是严格顺序的</h2><p>在UE中如果有两个连续调用的RPC事件A和B，其调用顺序到对端之后也不是完全保证就是一致的。<br>哪怕使用了<code>Reliable</code>来标记，只是标记其一定会到达，如果A先调用，然后调用B，但是A丢失了，重新发送A之后，顺序就是B先到达然后重新发送的A再到达。</p>
<h2 id="项目跨大版本升级"><a href="#项目跨大版本升级" class="headerlink" title="项目跨大版本升级"></a>项目跨大版本升级</h2><p>尽量不要直接跨数个大版本升级项目，可能会存在资源的兼容性问题，最安全的做法是挨个大版本升级。</p>
<h2 id="GC-Config-of-BaseEngine-ini"><a href="#GC-Config-of-BaseEngine-ini" class="headerlink" title="GC Config of BaseEngine.ini"></a>GC Config of BaseEngine.ini</h2><p>可以打开<code>ProjectSettings</code>-<code>Engine</code>-<code>GarbageCollection</code>查看设置:<br><img data-src="index/UE4/UE4-Engine-Garbage-Collection-GlobalSetting.webp"><br>它们是在配置文件<code>Engine\Config\BaseEngine.ini</code>中的。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; Engine\Config\BaseEngine.ini</span></span><br><span class="line"><span class="section">[/Script/Engine.GarbageCollectionSettings]</span></span><br><span class="line"><span class="attr">gc.MaxObjectsNotConsideredByGC</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.SizeOfPermanentObjectPool</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.FlushStreamingOnGC</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.NumRetriesBeforeForcingGC</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">gc.AllowParallelGC</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">gc.TimeBetweenPurgingPendingKillObjects</span>=<span class="number">60</span></span><br><span class="line"><span class="attr">gc.MaxObjectsInEditor</span>=<span class="number">8388607</span></span><br><span class="line"><span class="attr">gc.CreateGCClusters</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">gc.MergeGCClusters</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">gc.ActorClusteringEnabled</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">gc.BlueprintClusteringEnabled</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">gc.UseDisregardForGCOnDedicatedServers</span>=<span class="literal">False</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>AllowParallelGC</code>：允许多线程执行GC</p>
</li>
<li><p><code>TimeBetweenPurgingPendingKillObjects</code>：GC的清理周期默认为60s，可以通过调用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetWorld()-&gt;ForceGarbageCollection(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>来强制GC。但是如果不想然一个UObject被GC回收，可以使用<code>AddToRoot</code>。</p>
</li>
<li><p><code>CreateGCClusters</code>：开启可以防止对很多子物体进行GC遍历。</p>
</li>
</ul>

      </div>
      
      
      
    </div>
    
  <ul class="breadcrumb">
          
            <li><a href="/notes/">NOTES</a></li>
          <li>UE</li>
        
  </ul>

    
    
    


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#GIST-NOTES"><span class="nav-number">1.</span> <span class="nav-text">GIST NOTES</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows-h%E9%80%A0%E6%88%90%E7%9A%84%E5%90%8D%E5%AD%97%E5%86%B2%E7%AA%81"><span class="nav-number">2.</span> <span class="nav-text">Windows.h造成的名字冲突</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Core-Redirects"><span class="nav-number">3.</span> <span class="nav-text">Core Redirects</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E6%97%B6Shader%E7%9A%84%E7%BC%96%E8%AF%91"><span class="nav-number">4.</span> <span class="nav-text">打包时Shader的编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DDC%E5%85%B1%E4%BA%AB"><span class="nav-number">5.</span> <span class="nav-text">DDC共享</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#target%E6%96%87%E4%BB%B6"><span class="nav-number">6.</span> <span class="nav-text">.target文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS-Crash%E5%88%86%E6%9E%90%E6%96%87%E6%A1%A3"><span class="nav-number">7.</span> <span class="nav-text">IOS Crash分析文档</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6AssetRegistry%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">8.</span> <span class="nav-text">控制AssetRegistry的序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%90%E8%B4%A8Sampler%E8%B6%85%E9%99%90%E5%88%B6Crash"><span class="nav-number">9.</span> <span class="nav-text">材质Sampler超限制Crash</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DoesPackageExists%E5%88%86%E6%9E%90"><span class="nav-number">10.</span> <span class="nav-text">DoesPackageExists分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LoadObject%E5%8A%A0%E8%BD%BD%E7%A3%81%E7%9B%98%E6%96%87%E4%BB%B6%E6%A0%88"><span class="nav-number">11.</span> <span class="nav-text">LoadObject加载磁盘文件栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rebuild-metadata"><span class="nav-number">12.</span> <span class="nav-text">rebuild metadata</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPA%E5%8C%85%E6%9C%80%E5%A4%A7%E4%B8%BA4GB"><span class="nav-number">13.</span> <span class="nav-text">IPA包最大为4GB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96Editor%E7%9A%84Crash%E4%B8%8A%E6%8A%A5"><span class="nav-number">14.</span> <span class="nav-text">自动化Editor的Crash上报</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%AC%E8%B5%84%E6%BA%90%E5%88%9B%E5%BB%BA"><span class="nav-number">15.</span> <span class="nav-text">监听资源创建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Build-lighting-from-commandlet"><span class="nav-number">16.</span> <span class="nav-text">Build lighting from commandlet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AutomationTool%E7%9A%84ErrorCode"><span class="nav-number">17.</span> <span class="nav-text">AutomationTool的ErrorCode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8AssetRegistry%E6%A3%80%E6%B5%8B%E8%B5%84%E6%BA%90%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-number">18.</span> <span class="nav-text">使用AssetRegistry检测资源是否存在</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E6%89%93%E5%8C%85%E7%9A%84%E8%B5%84%E6%BA%90"><span class="nav-number">19.</span> <span class="nav-text">分析打包的资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%E4%B8%ADES3-1%E7%9A%8475%E6%A0%B9%E9%AA%A8%E9%AA%BC%E9%99%90%E5%88%B6"><span class="nav-number">20.</span> <span class="nav-text">UE4中ES3.1的75根骨骼限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%E7%83%AD%E6%9B%B4%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">21.</span> <span class="nav-text">UE4热更注意事项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#upluginmanifest"><span class="nav-number">22.</span> <span class="nav-text">upluginmanifest</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E9%9D%9EContent%E8%B7%AF%E5%BE%84%E7%9A%84Non-Asset%E7%9B%AE%E5%BD%95%E5%88%B0%E5%9F%BA%E7%A1%80%E5%8C%85"><span class="nav-number">23.</span> <span class="nav-text">添加非Content路径的Non-Asset目录到基础包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FDataTime-UtcNow"><span class="nav-number">24.</span> <span class="nav-text">FDataTime::UtcNow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uexp%E5%92%8Cubulk%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">25.</span> <span class="nav-text">uexp和ubulk的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4"><span class="nav-number">26.</span> <span class="nav-text">资源调试命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E5%9F%BA%E7%A1%80%E5%8C%85%E6%8B%86%E5%88%86"><span class="nav-number">27.</span> <span class="nav-text">IOS基础包拆分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E5%9F%BA%E7%A1%80%E5%8C%85%E6%8B%86%E5%88%86"><span class="nav-number">28.</span> <span class="nav-text">Android基础包拆分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UMG-OnTouchStarted%E4%B8%8D%E8%A7%A6%E5%8F%91"><span class="nav-number">29.</span> <span class="nav-text">UMG OnTouchStarted不触发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%AC%E8%B5%84%E6%BA%90%E6%93%8D%E4%BD%9C%E4%BA%8B%E4%BB%B6"><span class="nav-number">30.</span> <span class="nav-text">监听资源操作事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-not-found-uproject"><span class="nav-number">31.</span> <span class="nav-text">Android not found uproject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%90%E5%8F%96chunk%E7%9A%84paklist%E6%96%87%E4%BB%B6"><span class="nav-number">32.</span> <span class="nav-text">提取chunk的paklist文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA%E6%9C%80%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8D%E8%83%BD%E8%B6%85%E8%BF%872G"><span class="nav-number">33.</span> <span class="nav-text">IOS远程构建最大文件不能超过2G</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E8%BF%90%E8%A1%8C%E6%97%B6%E8%AF%B7%E6%B1%82%E6%9D%83%E9%99%90"><span class="nav-number">34.</span> <span class="nav-text">Android运行时请求权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DS%E4%BA%A7%E7%94%9Fcorefile"><span class="nav-number">35.</span> <span class="nav-text">DS产生corefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E5%AE%9ASkeletalMesh%E7%9A%84LOD%E7%BA%A7%E5%88%AB"><span class="nav-number">36.</span> <span class="nav-text">指定SkeletalMesh的LOD级别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HotPatcher%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AF%BC%E5%87%BARelease%E8%84%9A%E6%9C%AC"><span class="nav-number">37.</span> <span class="nav-text">HotPatcher的自动化导出Release脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Texture%E7%9A%84%E5%8E%8B%E7%BC%A9"><span class="nav-number">38.</span> <span class="nav-text">Texture的压缩</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#listtextures"><span class="nav-number">39.</span> <span class="nav-text">listtextures</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unreal-Insights%E5%AE%9E%E6%97%B6%E5%88%86%E6%9E%90Android"><span class="nav-number">40.</span> <span class="nav-text">Unreal Insights实时分析Android</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SessionFrontEnd%E5%AE%9E%E6%97%B6Profile-Android"><span class="nav-number">41.</span> <span class="nav-text">SessionFrontEnd实时Profile Android</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%BC%95%E6%93%8E%E7%9A%84%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-number">42.</span> <span class="nav-text">C++中获取引擎的版本信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%90%A6%E6%9C%89%E6%95%88%E7%9A%84%E6%96%B9%E5%BC%8F%E4%B8%8E%E5%8C%BA%E5%88%AB"><span class="nav-number">43.</span> <span class="nav-text">判断对象是否有效的方式与区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#M1-Mac%E7%9A%84UE4-26%E5%85%BC%E5%AE%B9%E6%80%A7%E6%8A%A5%E5%91%8A"><span class="nav-number">44.</span> <span class="nav-text">M1 Mac的UE4.26兼容性报告</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UMG-CanvasPanel%E5%90%88%E6%89%B9"><span class="nav-number">45.</span> <span class="nav-text">UMG CanvasPanel合批</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%93%9D%E5%9B%BE%E8%8A%82%E7%82%B9%E5%8F%B3%E4%B8%8A%E8%A7%92%E6%A0%87%E8%AF%86%E7%9A%84%E5%90%AB%E4%B9%89"><span class="nav-number">46.</span> <span class="nav-text">蓝图节点右上角标识的含义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OptimizeCode%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96"><span class="nav-number">47.</span> <span class="nav-text">OptimizeCode代码优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ASTC-Compression-Quality-By-Size"><span class="nav-number">48.</span> <span class="nav-text">ASTC Compression Quality By Size</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E4%BF%AE%E6%94%B9%E8%AF%AD%E8%A8%80%E7%9A%84%E9%85%8D%E7%BD%AE%E5%AD%98%E5%82%A8"><span class="nav-number">49.</span> <span class="nav-text">引擎修改语言的配置存储</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E6%96%87%E8%B5%8B%E5%80%BC%E7%BB%99FString"><span class="nav-number">50.</span> <span class="nav-text">中文赋值给FString</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E7%9B%B8%E5%AF%B9%E5%88%B0%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84%E8%BD%AC%E6%8D%A2"><span class="nav-number">51.</span> <span class="nav-text">IOS相对到绝对路径转换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E8%8E%B7%E5%8F%96%E5%8C%85%E5%90%8D"><span class="nav-number">52.</span> <span class="nav-text">Android获取包名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E8%8E%B7%E5%8F%96%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8%E8%B7%AF%E5%BE%84"><span class="nav-number">53.</span> <span class="nav-text">Android获取外部存储路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E7%9B%B8%E5%AF%B9%E8%B7%AF%E5%BE%84%E8%BD%AC%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84"><span class="nav-number">54.</span> <span class="nav-text">Android相对路径转绝对路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4AndroidManifest-xml%E4%B8%AD%E7%9A%84%E9%A1%B9"><span class="nav-number">55.</span> <span class="nav-text">删除AndroidManifest.xml中的项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%BA%E5%BC%95%E7%94%A8UClass"><span class="nav-number">56.</span> <span class="nav-text">强引用UClass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81%E7%9A%84%E7%9C%9F%E6%AD%A3%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0"><span class="nav-number">57.</span> <span class="nav-text">UE4编译代码的真正命令参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#build-cs%E6%B7%BB%E5%8A%A0%E5%AE%8F%E5%AE%9A%E4%B9%89%E7%9A%84%E5%80%BC"><span class="nav-number">58.</span> <span class="nav-text">build.cs添加宏定义的值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%BC%95%E6%93%8E%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="nav-number">59.</span> <span class="nav-text">编译引擎的命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%BE%91%E5%99%A8%E6%A3%80%E6%B5%8BActor%E7%A7%BB%E5%8A%A8"><span class="nav-number">60.</span> <span class="nav-text">编辑器检测Actor移动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Actor-Tick-in-Editor"><span class="nav-number">61.</span> <span class="nav-text">Actor Tick in Editor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4-ERROR-Missing-object-file"><span class="nav-number">62.</span> <span class="nav-text">UE4 ERROR: Missing object file</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E9%9A%94String%E4%B8%BA%E6%95%B0%E7%BB%84"><span class="nav-number">63.</span> <span class="nav-text">分隔String为数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4-25%E4%B8%ADShaderPatch%E9%97%AE%E9%A2%98"><span class="nav-number">64.</span> <span class="nav-text">UE4.25中ShaderPatch问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E9%A1%B9%E7%9B%AE%E4%B8%AD%E6%89%80%E6%9C%89%E7%9A%84UPL"><span class="nav-number">65.</span> <span class="nav-text">Android项目中所有的UPL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Win%E5%92%8CMac%E5%87%BAIOS%E5%8C%85%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">66.</span> <span class="nav-text">Win和Mac出IOS包的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%E6%96%B0%E5%9C%B0%E5%9B%BE%E7%9A%84Package%E9%97%AE%E9%A2%98"><span class="nav-number">67.</span> <span class="nav-text">UE4新地图的Package问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E5%8A%A0%E8%BD%BDBP%E7%9A%84Enum"><span class="nav-number">68.</span> <span class="nav-text">C++加载BP的Enum</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DS%E8%AE%BE%E7%BD%AE%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="nav-number">69.</span> <span class="nav-text">DS设置超时时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DDC%E7%9A%84%E8%B5%84%E6%96%99"><span class="nav-number">70.</span> <span class="nav-text">DDC的资料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E8%BF%87%E9%95%BF%E5%AF%BC%E8%87%B4%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA%E5%A4%B1%E8%B4%A5"><span class="nav-number">71.</span> <span class="nav-text">路径过长导致远程构建失败</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mount-Point%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">72.</span> <span class="nav-text">Mount Point的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E7%9A%84Splash%E8%BF%87%E7%A8%8B"><span class="nav-number">73.</span> <span class="nav-text">引擎的Splash过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4-25-1%E7%9A%84Assembly%E8%B7%AF%E5%BE%84%E9%94%99%E8%AF%AF"><span class="nav-number">74.</span> <span class="nav-text">UE4.25.1的Assembly路径错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%A8Level%E9%80%89%E6%8B%A9Actor"><span class="nav-number">75.</span> <span class="nav-text">跨Level选择Actor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%A4%96%E9%83%A8%E5%BA%93%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">76.</span> <span class="nav-text">添加外部库的注意事项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Outer"><span class="nav-number">77.</span> <span class="nav-text">Outer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ShareMaterialShaderCode"><span class="nav-number">78.</span> <span class="nav-text">ShareMaterialShaderCode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96ContentBrowser%E4%B8%AD%E9%80%89%E6%8B%A9%E7%9A%84%E8%B5%84%E6%BA%90"><span class="nav-number">79.</span> <span class="nav-text">获取ContentBrowser中选择的资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%A4%AA%E9%95%BF%E6%97%A0%E6%B3%95%E9%80%82%E5%BA%94%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95"><span class="nav-number">80.</span> <span class="nav-text">命令行太长无法适应调试记录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E8%B5%84%E6%BA%90%E5%8F%B3%E9%94%AE%E8%8F%9C%E5%8D%95%E6%8C%89%E9%92%AE"><span class="nav-number">81.</span> <span class="nav-text">添加资源右键菜单按钮</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GenerateProjectFiles%E6%8C%87%E5%AE%9AVS%E7%89%88%E6%9C%AC"><span class="nav-number">82.</span> <span class="nav-text">GenerateProjectFiles指定VS版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Module%E7%9A%84WhitelistPlatforms"><span class="nav-number">83.</span> <span class="nav-text">Module的WhitelistPlatforms</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IDetailCustomization"><span class="nav-number">84.</span> <span class="nav-text">IDetailCustomization</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%90%E5%8F%96PakList%E6%96%87%E4%BB%B6"><span class="nav-number">85.</span> <span class="nav-text">提取PakList文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%91%E5%AE%9ADetailsView%E7%9A%84%E5%B1%9E%E6%80%A7%E5%8F%98%E5%8C%96%E4%BA%8B%E4%BB%B6"><span class="nav-number">86.</span> <span class="nav-text">绑定DetailsView的属性变化事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E%E6%8C%87%E5%AE%9APak%E5%8A%A0%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="nav-number">87.</span> <span class="nav-text">从指定Pak加载文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WITH-EDITOR%E5%8C%85%E8%A3%B9%E5%8F%8D%E5%B0%84%E5%B1%9E%E6%80%A7%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">88.</span> <span class="nav-text">WITH_EDITOR包裹反射属性的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E8%8E%B7%E5%8F%96%E5%B7%B2%E5%AE%89%E8%A3%85App%E7%9A%84Apk%E8%B7%AF%E5%BE%84"><span class="nav-number">89.</span> <span class="nav-text">Android获取已安装App的Apk路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cook%E8%B5%84%E6%BA%90"><span class="nav-number">90.</span> <span class="nav-text">Cook资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Compile%E5%AF%B9Instanced%E7%9A%84%E6%9B%BF%E6%8D%A2%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-number">91.</span> <span class="nav-text">Compile对Instanced的替换调用栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B5%84%E6%BA%90%E7%82%B9%E5%87%BBCompile%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-number">92.</span> <span class="nav-text">对资源点击Compile的调用栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UMG%E7%9A%84%E5%AD%90%E6%8E%A7%E4%BB%B6%E5%BC%95%E7%94%A8%E7%83%AD%E6%9B%B4%E9%97%AE%E9%A2%98"><span class="nav-number">93.</span> <span class="nav-text">UMG的子控件引用热更问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E7%8E%AF%E5%BD%A2%E5%BC%95%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84%E5%AE%8F%E6%9C%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF"><span class="nav-number">94.</span> <span class="nav-text">注意环形引用导致的宏未定义错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%ACSlate%E7%9A%84%E8%BE%93%E5%85%A5%E4%BA%8B%E4%BB%B6"><span class="nav-number">95.</span> <span class="nav-text">监听Slate的输入事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9LaunchScreen%E8%A7%86%E9%A2%91%E6%AF%94%E4%BE%8B"><span class="nav-number">96.</span> <span class="nav-text">修改LaunchScreen视频比例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rider%E4%BC%A0%E9%80%92%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0"><span class="nav-number">97.</span> <span class="nav-text">Rider传递命令行参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AF%BC%E5%85%A5Certificate%E5%92%8CProvision"><span class="nav-number">98.</span> <span class="nav-text">IOS自动化导入Certificate和Provision</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mac%E6%89%93%E5%8C%85iOS%E7%9A%84codesign%E9%94%99%E8%AF%AF"><span class="nav-number">99.</span> <span class="nav-text">Mac打包iOS的codesign错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VirtualCamera"><span class="nav-number">100.</span> <span class="nav-text">VirtualCamera</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7%E8%87%B3AndroidX%E8%B5%84%E6%96%99"><span class="nav-number">101.</span> <span class="nav-text">升级至AndroidX资料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA%E5%9C%A84-26%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">102.</span> <span class="nav-text">远程构建在4.26的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Log"><span class="nav-number">103.</span> <span class="nav-text">Log</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DECLARE-LOG-CATEGORY-EXTERN"><span class="nav-number">103.1.</span> <span class="nav-text">DECLARE_LOG_CATEGORY_EXTERN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DECLARE-LOG-CATEGORY-CLASS"><span class="nav-number">103.2.</span> <span class="nav-text">DECLARE_LOG_CATEGORY_CLASS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DECLARE-LOG-CATEGORY-EXTERN-HELPER"><span class="nav-number">103.3.</span> <span class="nav-text">DECLARE_LOG_CATEGORY_EXTERN_HELPER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-number">103.4.</span> <span class="nav-text">后记</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI%E8%B0%83%E7%94%A8%E6%8E%A5%E6%94%B6ActivityResult"><span class="nav-number">104.</span> <span class="nav-text">JNI调用接收ActivityResult</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java%E8%B0%83C"><span class="nav-number">105.</span> <span class="nav-text">Java调C++</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AndroidP%E7%9A%84%E5%85%A8%E9%9D%A2%E5%B1%8F%E9%80%82%E9%85%8D"><span class="nav-number">106.</span> <span class="nav-text">AndroidP的全面屏适配</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%96%E9%83%A8%E8%B5%84%E6%96%99"><span class="nav-number">106.1.</span> <span class="nav-text">外部资料</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E7%BC%96%E8%AF%91Shader%E7%9A%84Key%E6%9F%A5%E6%89%BEbug"><span class="nav-number">107.</span> <span class="nav-text">远程编译Shader的Key查找bug</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B9%B3%E5%8F%B0%E7%9B%B8%E5%85%B3Target"><span class="nav-number">108.</span> <span class="nav-text">平台相关Target</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TargetRule%E8%8E%B7%E5%8F%96%E9%A1%B9%E7%9B%AE%E8%B7%AF%E5%BE%84"><span class="nav-number">109.</span> <span class="nav-text">TargetRule获取项目路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UObject%E8%8E%B7%E5%8F%96%E8%B5%84%E6%BA%90%E8%B7%AF%E5%BE%84"><span class="nav-number">110.</span> <span class="nav-text">UObject获取资源路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85iOS%E5%AF%BC%E5%87%BAdSYM"><span class="nav-number">111.</span> <span class="nav-text">打包iOS导出dSYM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%91%E7%82%B9"><span class="nav-number">111.1.</span> <span class="nav-text">坑点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%BC%95%E6%93%8E%E6%94%AF%E6%8C%81Android%E5%92%8CiOS"><span class="nav-number">112.</span> <span class="nav-text">编译引擎支持Android和iOS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E8%AE%BE%E7%BD%AE%E5%AE%BD%E9%AB%98%E6%AF%94"><span class="nav-number">113.</span> <span class="nav-text">Android设置宽高比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UPARAM"><span class="nav-number">114.</span> <span class="nav-text">UPARAM</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A0%E8%BE%B9%E6%A1%86%E6%A8%A1%E5%BC%8F"><span class="nav-number">115.</span> <span class="nav-text">无边框模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%AF%BC%E5%85%A5iOS%E8%AF%81%E4%B9%A6%E5%92%8CProvision"><span class="nav-number">116.</span> <span class="nav-text">命令行导入iOS证书和Provision</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Certificate"><span class="nav-number">116.1.</span> <span class="nav-text">Certificate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Provision"><span class="nav-number">116.2.</span> <span class="nav-text">Provision</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E8%8E%B7%E5%8F%96%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0"><span class="nav-number">117.</span> <span class="nav-text">C#获取命令行参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E6%97%B6%E7%BB%99%E4%B8%8D%E5%90%8C%E7%9A%84%E5%B9%B3%E5%8F%B0%E6%B7%BB%E5%8A%A0%E8%B5%84%E6%BA%90"><span class="nav-number">118.</span> <span class="nav-text">打包时给不同的平台添加资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%AC%E8%B5%84%E6%BA%90%E4%BF%9D%E5%AD%98%E7%9A%84%E4%BA%8B%E4%BB%B6"><span class="nav-number">119.</span> <span class="nav-text">监听资源保存的事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UStruct%E7%9A%84json%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">120.</span> <span class="nav-text">UStruct的json序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redirector"><span class="nav-number">121.</span> <span class="nav-text">Redirector</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E5%BC%95%E6%93%8E%E6%98%AF%E5%90%A6%E8%BF%90%E8%A1%8C%E5%9C%A8Commandlet"><span class="nav-number">122.</span> <span class="nav-text">检查引擎是否运行在Commandlet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FSoftObjectPath%E9%99%90%E5%AE%9A%E7%B1%BB%E5%9E%8B"><span class="nav-number">123.</span> <span class="nav-text">FSoftObjectPath限定类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%BE%91%E5%99%A8viewport%E6%98%BE%E7%A4%BA%E6%96%87%E5%AD%97"><span class="nav-number">124.</span> <span class="nav-text">编辑器viewport显示文字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E5%A4%9A%E6%A0%B8%E5%BF%83%E7%BC%96%E8%AF%91"><span class="nav-number">125.</span> <span class="nav-text">开启多核心编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#URL-Encode-Decode"><span class="nav-number">126.</span> <span class="nav-text">URL Encode&#x2F;Decode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8BAPK%E7%9A%84%E7%AD%BE%E5%90%8D%E4%BF%A1%E6%81%AF"><span class="nav-number">127.</span> <span class="nav-text">查看APK的签名信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ASTC%E8%AE%BE%E7%BD%AE%E5%8E%8B%E7%BC%A9%E7%8E%87"><span class="nav-number">128.</span> <span class="nav-text">ASTC设置压缩率</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E9%87%8D%E5%90%AFApp"><span class="nav-number">129.</span> <span class="nav-text">Android重启App</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85Windows%E4%BB%A5%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="nav-number">130.</span> <span class="nav-text">打包Windows以窗口模式启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9B%BECook%E5%8F%8A%E6%89%93%E5%8C%85"><span class="nav-number">131.</span> <span class="nav-text">指定地图Cook及打包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows%E9%80%9A%E8%BF%87bat%E5%AD%98%E5%82%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">132.</span> <span class="nav-text">Windows通过bat存储环境变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E8%AE%BF%E9%97%AECollision-Chanel"><span class="nav-number">133.</span> <span class="nav-text">C++访问Collision Chanel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Actor%E7%9A%84%E5%BB%B6%E8%BF%9FSpawn"><span class="nav-number">134.</span> <span class="nav-text">Actor的延迟Spawn</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%BC%95%E6%93%8E%E7%9A%84WindowsDebugTools%E9%94%99%E8%AF%AF"><span class="nav-number">135.</span> <span class="nav-text">编译引擎的WindowsDebugTools错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BuildGraph%E6%9E%84%E5%BB%BA%E5%BC%95%E6%93%8E"><span class="nav-number">136.</span> <span class="nav-text">BuildGraph构建引擎</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Game-module-could-not-be-loaded"><span class="nav-number">137.</span> <span class="nav-text">Game module could not be loaded</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%93%9D%E5%9B%BE%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%AD%E8%8A%82%E7%82%B9%E5%B1%9E%E6%80%A7%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="nav-number">138.</span> <span class="nav-text">蓝图编辑器中节点属性的修改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UMG%E8%B5%84%E6%96%99%E6%96%87%E6%A1%A3"><span class="nav-number">138.1.</span> <span class="nav-text">UMG资料文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Enum%E5%8F%8D%E5%B0%84"><span class="nav-number">139.</span> <span class="nav-text">Enum反射</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UHT%E4%B8%BAEnum%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="nav-number">139.1.</span> <span class="nav-text">UHT为Enum生成的代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E8%AE%BF%E9%97%AEUEnum"><span class="nav-number">139.2.</span> <span class="nav-text">运行时访问UEnum</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E6%9E%9A%E4%B8%BE%E5%90%8D%E5%AD%97%E8%8E%B7%E5%8F%96%E6%9E%9A%E4%B8%BE%E5%80%BC"><span class="nav-number">139.3.</span> <span class="nav-text">根据枚举名字获取枚举值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E5%80%BC%E4%B8%8E%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E4%BA%92%E7%9B%B8%E8%BD%AC%E6%8D%A2"><span class="nav-number">139.4.</span> <span class="nav-text">枚举值与字符串的互相转换</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Struct%E5%8F%8D%E5%B0%84"><span class="nav-number">140.</span> <span class="nav-text">Struct反射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E5%8F%8D%E5%B0%84"><span class="nav-number">141.</span> <span class="nav-text">类反射</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UHT%E4%B8%BA%E7%B1%BB%E4%BA%A7%E7%94%9F%E7%9A%84%E5%8F%8D%E5%B0%84%E4%BF%A1%E6%81%AF"><span class="nav-number">141.1.</span> <span class="nav-text">UHT为类产生的反射信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%9EUCLASS%E7%9A%84%E5%8F%8D%E5%B0%84"><span class="nav-number">141.2.</span> <span class="nav-text">非UCLASS的反射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UClass%E7%9A%84%E6%9E%84%E9%80%A0%E6%80%9D%E8%B7%AF"><span class="nav-number">141.3.</span> <span class="nav-text">UClass的构造思路</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E7%94%9F%E6%88%90%E7%9A%84%E5%8F%8D%E5%B0%84%E4%BF%A1%E6%81%AF"><span class="nav-number">141.3.1.</span> <span class="nav-text">引擎如何使用生成的反射信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%8F%8D%E5%B0%84"><span class="nav-number">142.</span> <span class="nav-text">函数反射</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UHT%E7%94%9F%E6%88%90%E7%9A%84%E5%8F%8D%E5%B0%84%E4%BF%A1%E6%81%AF"><span class="nav-number">142.1.</span> <span class="nav-text">UHT生成的反射信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Thunk%E5%87%BD%E6%95%B0"><span class="nav-number">142.2.</span> <span class="nav-text">Thunk函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-Thunk"><span class="nav-number">142.3.</span> <span class="nav-text">Custom Thunk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E8%AE%BF%E9%97%AE%E5%8F%8D%E5%B0%84%E5%87%BD%E6%95%B0"><span class="nav-number">142.4.</span> <span class="nav-text">运行时访问反射函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%91%E7%82%B9-1"><span class="nav-number">142.5.</span> <span class="nav-text">坑点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E5%8F%8D%E5%B0%84"><span class="nav-number">143.</span> <span class="nav-text">属性反射</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#F-PropertyParams"><span class="nav-number">143.1.</span> <span class="nav-text">F*PropertyParams</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NameUTF8"><span class="nav-number">143.1.1.</span> <span class="nav-text">NameUTF8</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RepNotifyFuncUTF8"><span class="nav-number">143.1.2.</span> <span class="nav-text">RepNotifyFuncUTF8</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PropertyFlags"><span class="nav-number">143.1.3.</span> <span class="nav-text">PropertyFlags</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Flags"><span class="nav-number">143.1.4.</span> <span class="nav-text">Flags</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ObjectFlags"><span class="nav-number">143.1.5.</span> <span class="nav-text">ObjectFlags</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ArrayDim"><span class="nav-number">143.1.6.</span> <span class="nav-text">ArrayDim</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Offset"><span class="nav-number">143.1.7.</span> <span class="nav-text">Offset</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Z-Construct-UClass-%E5%92%8CNumMetaData"><span class="nav-number">143.1.8.</span> <span class="nav-text">Z_Construct_UClass_和NumMetaData</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84Property"><span class="nav-number">143.2.</span> <span class="nav-text">运行时的Property</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FBoolPropertyParams%E7%89%B9%E4%BE%8B"><span class="nav-number">143.3.</span> <span class="nav-text">FBoolPropertyParams特例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87UProperty%E8%8E%B7%E5%8F%96%E5%80%BC"><span class="nav-number">143.4.</span> <span class="nav-text">通过UProperty获取值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Property%E7%9A%84Flag"><span class="nav-number">143.5.</span> <span class="nav-text">Property的Flag</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StaticClass%E5%92%8CGetClass%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">144.</span> <span class="nav-text">StaticClass和GetClass的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UObject%E7%9A%84FObjectInitializer%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8"><span class="nav-number">145.</span> <span class="nav-text">UObject的FObjectInitializer构造函数的调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StaticClass%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E7%9A%84"><span class="nav-number">146.</span> <span class="nav-text">StaticClass是如何定义的</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UClass%E4%B8%AD%E7%9A%84%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88"><span class="nav-number">146.1.</span> <span class="nav-text">UClass中的函数指针</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetPrivateStaticClassBody"><span class="nav-number">146.2.</span> <span class="nav-text">GetPrivateStaticClassBody</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96UObject%E7%9A%84%E8%B5%84%E6%BA%90%E8%B7%AF%E5%BE%84"><span class="nav-number">147.</span> <span class="nav-text">获取UObject的资源路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BP-to-CPP"><span class="nav-number">148.</span> <span class="nav-text">BP to CPP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E5%90%AC%E7%AA%97%E5%8F%A3%E5%85%B3%E9%97%AD"><span class="nav-number">149.</span> <span class="nav-text">监听窗口关闭</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UnLua%E7%9A%84EXPORT-PRIMITIVE-TYPE"><span class="nav-number">150.</span> <span class="nav-text">UnLua的EXPORT_PRIMITIVE_TYPE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-25-MountPak%E6%B2%A1%E6%9C%89%E6%9D%90%E8%B4%A8"><span class="nav-number">151.</span> <span class="nav-text">4.25 MountPak没有材质</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E4%B8%8AArrow%E7%BB%84%E4%BB%B6%E7%9A%84crash"><span class="nav-number">152.</span> <span class="nav-text">Android上Arrow组件的crash</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#target-build-cs%E8%BE%93%E5%87%BALog"><span class="nav-number">153.</span> <span class="nav-text">target&#x2F;build.cs输出Log</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TargetRules%E7%9A%84BuildSettingsVersion"><span class="nav-number">154.</span> <span class="nav-text">TargetRules的BuildSettingsVersion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8ETargetRules%E8%8E%B7%E5%8F%96%E5%BC%95%E6%93%8E%E7%89%88%E6%9C%AC"><span class="nav-number">155.</span> <span class="nav-text">从TargetRules获取引擎版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8ETargetRules%E8%8E%B7%E5%8F%96Configuration"><span class="nav-number">156.</span> <span class="nav-text">从TargetRules获取Configuration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS-CrashLog%E5%88%86%E6%9E%90"><span class="nav-number">157.</span> <span class="nav-text">IOS CrashLog分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC"><span class="nav-number">158.</span> <span class="nav-text">GC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SDetailsView%E7%9B%91%E5%90%AC%E5%B1%9E%E6%80%A7%E5%8F%98%E5%8C%96"><span class="nav-number">159.</span> <span class="nav-text">SDetailsView监听属性变化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UObject-serializer%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-number">160.</span> <span class="nav-text">UObject serializer的调用栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FName-FString-FText%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">161.</span> <span class="nav-text">FName&#x2F;FString&#x2F;FText的区别</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FName"><span class="nav-number">161.1.</span> <span class="nav-text">FName</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FString"><span class="nav-number">161.2.</span> <span class="nav-text">FString</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FText"><span class="nav-number">161.3.</span> <span class="nav-text">FText</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3"><span class="nav-number">161.4.</span> <span class="nav-text">文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Plugin%E6%B7%BB%E5%8A%A0%E5%85%B6%E4%BB%96Plugin%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="nav-number">162.</span> <span class="nav-text">Plugin添加其他Plugin的模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Build-Configurations"><span class="nav-number">163.</span> <span class="nav-text">Build Configurations</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GlobalShaderCache%E7%9A%84%E5%8A%A0%E8%BD%BD"><span class="nav-number">164.</span> <span class="nav-text">GlobalShaderCache的加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ushaderbytecode%E7%9A%84%E5%8A%A0%E8%BD%BD"><span class="nav-number">165.</span> <span class="nav-text">ushaderbytecode的加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E6%89%93%E5%8C%85%E5%88%B0pak%E9%87%8C%E7%9A%84%E8%B5%84%E6%BA%90"><span class="nav-number">166.</span> <span class="nav-text">默认打包到pak里的资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BACommandlet"><span class="nav-number">167.</span> <span class="nav-text">创建Commandlet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UnLua%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0%E8%A6%86%E5%86%99"><span class="nav-number">168.</span> <span class="nav-text">UnLua如何实现函数覆写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%BF%E6%8D%A2Thunk%E5%87%BD%E6%95%B0"><span class="nav-number">168.1.</span> <span class="nav-text">替换Thunk函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FLuaContext-TryBindUnlua"><span class="nav-number">168.2.</span> <span class="nav-text">FLuaContext::TryBindUnlua</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UUnLuaManager-Bind"><span class="nav-number">168.3.</span> <span class="nav-text">UUnLuaManager::Bind</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BindInternal"><span class="nav-number">168.4.</span> <span class="nav-text">BindInternal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UUnLuaManager-OverrideFunctions"><span class="nav-number">168.5.</span> <span class="nav-text">UUnLuaManager::OverrideFunctions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UUnLuaManager-OverrideFunction"><span class="nav-number">168.6.</span> <span class="nav-text">UUnLuaManager::OverrideFunction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UUnLuaManager-AddFunction"><span class="nav-number">168.7.</span> <span class="nav-text">UUnLuaManager::AddFunction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Call-lua"><span class="nav-number">168.8.</span> <span class="nav-text">Call lua</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E5%AF%B9Android%E7%89%88%E6%9C%AC%E7%9A%84%E6%94%AF%E6%8C%81"><span class="nav-number">169.</span> <span class="nav-text">引擎对Android版本的支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E5%AF%B9AndroidNDK%E7%9A%84%E8%A6%81%E6%B1%82"><span class="nav-number">170.</span> <span class="nav-text">引擎对AndroidNDK的要求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8ETargetRules%E8%8E%B7%E5%8F%96%E5%BC%95%E6%93%8E%E7%89%88%E6%9C%AC-1"><span class="nav-number">171.</span> <span class="nav-text">从TargetRules获取引擎版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FPaths%E4%B8%ADDir%E5%87%BD%E6%95%B0%E7%9A%84%E5%AF%B9%E5%BA%94%E8%B7%AF%E5%BE%84"><span class="nav-number">172.</span> <span class="nav-text">FPaths中Dir函数的对应路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87Commandline%E6%9B%BF%E6%8D%A2%E5%8A%A0%E8%BD%BD%E7%9A%84ini"><span class="nav-number">173.</span> <span class="nav-text">通过Commandline替换加载的ini</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%B9%B3%E5%8F%B0%E4%BF%A1%E6%81%AF"><span class="nav-number">174.</span> <span class="nav-text">获取当前平台信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#COMPILED-PLATFORM-HEADER"><span class="nav-number">175.</span> <span class="nav-text">COMPILED_PLATFORM_HEADER</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%81%8D%E5%8E%86UCLASS%E6%88%96USTRUCT%E7%9A%84%E5%8F%8D%E5%B0%84%E6%88%90%E5%91%98"><span class="nav-number">176.</span> <span class="nav-text">遍历UCLASS或USTRUCT的反射成员</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lua-Metatable"><span class="nav-number">177.</span> <span class="nav-text">Lua:Metatable</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E6%89%93%E5%8C%85%E6%97%B6ini%E7%9A%84%E6%8B%B7%E8%B4%9D"><span class="nav-number">178.</span> <span class="nav-text">控制打包时ini的拷贝</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CharCast%E7%9A%84%E5%9D%91"><span class="nav-number">179.</span> <span class="nav-text">CharCast的坑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bUsesSlate"><span class="nav-number">180.</span> <span class="nav-text">bUsesSlate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unreal-Plugin-Language"><span class="nav-number">181.</span> <span class="nav-text">Unreal Plugin Language</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E6%97%B6Paklist%E6%96%87%E4%BB%B6%E7%9A%84%E7%94%9F%E6%88%90"><span class="nav-number">182.</span> <span class="nav-text">打包时Paklist文件的生成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ShaderStableInfo-scl-csv"><span class="nav-number">183.</span> <span class="nav-text">ShaderStableInfo*.scl.csv</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PE%E7%9A%84DLL%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%AF%BC%E5%85%A5%E5%BA%93%EF%BC%9F"><span class="nav-number">184.</span> <span class="nav-text">PE的DLL为什么需要导入库？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UCLASS%E7%9A%84config"><span class="nav-number">185.</span> <span class="nav-text">UCLASS的config</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E5%89%AA%E8%B4%B4%E6%9D%BFClipboard"><span class="nav-number">186.</span> <span class="nav-text">操作剪贴板Clipboard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E5%9C%BA%E6%99%AF%E4%B8%ADCopy-Paste%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">187.</span> <span class="nav-text">在场景中Copy&#x2F;Paste的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Copy"><span class="nav-number">187.1.</span> <span class="nav-text">Copy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Paste"><span class="nav-number">187.2.</span> <span class="nav-text">Paste</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A3%80%E6%B5%8B%E5%AD%97%E7%AC%A6%E6%95%B0%E7%BB%84%E6%98%AFUTF8%E8%BF%98%E6%98%AFGBK%E7%BC%96%E7%A0%81"><span class="nav-number">188.</span> <span class="nav-text">检测字符数组是UTF8还是GBK编码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GBK"><span class="nav-number">188.1.</span> <span class="nav-text">GBK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UTF8"><span class="nav-number">188.2.</span> <span class="nav-text">UTF8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">188.3.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UTF8%E7%BC%96%E7%A0%81%E7%9A%84%E5%AD%97%E7%AC%A6%E6%95%B0%E7%BB%84%E8%BD%ACFString"><span class="nav-number">189.</span> <span class="nav-text">UTF8编码的字符数组转FString</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%BE%91%E5%99%A8SpawnActor"><span class="nav-number">190.</span> <span class="nav-text">编辑器SpawnActor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E5%88%B6%E7%89%87%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-number">191.</span> <span class="nav-text">虚拟制片的流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EditCondition%E6%94%AF%E6%8C%81%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">192.</span> <span class="nav-text">EditCondition支持表达式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%B5%84%E6%BA%90%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB"><span class="nav-number">193.</span> <span class="nav-text">获取资源依赖关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%B0%E5%9B%BE%E7%9A%84%E5%AD%98%E5%82%A8%E5%92%8C%E5%8A%A0%E8%BD%BD"><span class="nav-number">194.</span> <span class="nav-text">地图的存储和加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DataTable"><span class="nav-number">195.</span> <span class="nav-text">DataTable</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FCommandLine%E8%BF%87%E6%BB%A4%E6%A8%A1%E5%BC%8F"><span class="nav-number">196.</span> <span class="nav-text">FCommandLine过滤模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OVERRIDE-COMMANDLINE-WHITELIST"><span class="nav-number">196.1.</span> <span class="nav-text">OVERRIDE_COMMANDLINE_WHITELIST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FILTER-COMMANDLINE-LOGGING"><span class="nav-number">196.2.</span> <span class="nav-text">FILTER_COMMANDLINE_LOGGING</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PIE%E7%9A%84%E5%9D%91"><span class="nav-number">197.</span> <span class="nav-text">PIE的坑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UPARAM-ref"><span class="nav-number">198.</span> <span class="nav-text">UPARAM(ref)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#the-file-couldn%E2%80%99t-be-loaded-by-the-OS"><span class="nav-number">199.</span> <span class="nav-text">the file couldn’t be loaded by the OS.</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PURE-VIRTUAL-macro"><span class="nav-number">200.</span> <span class="nav-text">PURE_VIRTUAL macro</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8tcping%E6%A3%80%E6%B5%8B%E7%AB%AF%E5%8F%A3%E6%98%AF%E5%90%A6%E5%BC%80%E6%94%BE"><span class="nav-number">201.</span> <span class="nav-text">使用tcping检测端口是否开放</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%88%90%E5%91%98%E6%A8%A1%E6%9D%BF%E5%87%BD%E6%95%B0%E7%89%B9%E5%8C%96%E4%B8%8D%E8%A6%81%E6%94%BE%E5%9C%A8class-scope"><span class="nav-number">202.</span> <span class="nav-text">成员模板函数特化不要放在class scope</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Runtime%E6%A8%A1%E5%9D%97%E5%8C%85%E5%90%ABEditor%E6%A8%A1%E5%9D%97%E7%9A%84%E9%94%99%E8%AF%AF"><span class="nav-number">203.</span> <span class="nav-text">Runtime模块包含Editor模块的错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%93%9D%E5%9B%BE%E6%B7%BB%E5%8A%A0%E7%9A%84%E6%89%80%E6%9C%89%E6%8E%A5%E5%8F%A3"><span class="nav-number">204.</span> <span class="nav-text">获取蓝图添加的所有接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UnrealFrontEnd-DeviceLog"><span class="nav-number">205.</span> <span class="nav-text">UnrealFrontEnd DeviceLog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E7%B1%BB%E7%9A%84%E6%89%80%E6%9C%89%E5%AD%90%E7%B1%BB"><span class="nav-number">206.</span> <span class="nav-text">获取某个类的所有子类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-22-3%E6%89%93%E5%8C%85IOS-Crash%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">207.</span> <span class="nav-text">4.22.3打包IOS Crash的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IOS%E8%B4%B4%E5%9B%BE%E9%9D%9E2%E6%AC%A1%E5%B9%82%E7%9A%84%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98"><span class="nav-number">208.</span> <span class="nav-text">IOS贴图非2次幂的显示问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES2-0%E6%9C%80%E5%A4%9A75%E6%A0%B9%E9%AA%A8%E9%AA%BC%E7%9A%84%E9%99%90%E5%88%B6"><span class="nav-number">209.</span> <span class="nav-text">ES2.0最多75根骨骼的限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8HTTP%E8%AF%B7%E6%B1%82%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6%E7%9A%84%E5%9D%91%E5%92%8C%E6%8A%80%E5%B7%A7"><span class="nav-number">210.</span> <span class="nav-text">使用HTTP请求下载文件的坑和技巧</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MD5%E7%9A%84%E5%88%86%E7%89%87%E6%A0%A1%E9%AA%8C"><span class="nav-number">211.</span> <span class="nav-text">MD5的分片校验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PlatformMisc%E7%9A%84%E8%B7%A8%E5%B9%B3%E5%8F%B0%E5%AE%9E%E7%8E%B0"><span class="nav-number">212.</span> <span class="nav-text">PlatformMisc的跨平台实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BAAPK%E6%B7%BB%E5%8A%A0%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8%E7%8B%AC%E5%86%99%E6%9D%83%E9%99%90"><span class="nav-number">213.</span> <span class="nav-text">为APK添加外部存储独写权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6"><span class="nav-number">214.</span> <span class="nav-text">Android写入文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6%E9%94%99%E8%AF%AF%E7%A0%81%E5%AF%B9%E7%85%A7"><span class="nav-number">215.</span> <span class="nav-text">Android写入文件错误码对照</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lua-%E4%BB%8E%E5%86%85%E5%AD%98%E5%8A%A0%E8%BD%BDmodule"><span class="nav-number">216.</span> <span class="nav-text">Lua:从内存加载module</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gituhb%E5%BF%AB%E6%8D%B7%E4%BB%A3%E7%A0%81%E6%90%9C%E7%B4%A2"><span class="nav-number">217.</span> <span class="nav-text">gituhb快捷代码搜索</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6FLAG"><span class="nav-number">218.</span> <span class="nav-text">控制写入文件FLAG</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Assertion-failed-Class-gt-Children-0"><span class="nav-number">219.</span> <span class="nav-text">Assertion failed: Class-&gt;Children &#x3D;&#x3D; 0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E6%97%B6%E6%B7%BB%E5%8A%A0%E5%A4%96%E9%83%A8%E6%96%87%E4%BB%B6"><span class="nav-number">220.</span> <span class="nav-text">打包时添加外部文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E5%85%B3%E9%94%AE%E5%AD%97%E7%BB%9D%E5%AF%B9%E4%B8%8D%E8%A6%81%E4%BD%9C%E4%B8%BA%E5%8F%98%E9%87%8F%E5%90%8D"><span class="nav-number">221.</span> <span class="nav-text">C++关键字绝对不要作为变量名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-NDK"><span class="nav-number">222.</span> <span class="nav-text">Android NDK</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%86BindAction%E6%9A%B4%E9%9C%B2%E7%BB%99%E8%93%9D%E5%9B%BE"><span class="nav-number">223.</span> <span class="nav-text">将BindAction暴露给蓝图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#APK%E5%8C%85%E4%B8%ADOBB%E6%96%87%E4%BB%B6"><span class="nav-number">224.</span> <span class="nav-text">APK包中OBB文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E7%9A%84%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0"><span class="nav-number">225.</span> <span class="nav-text">移动端的启动参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Android%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0"><span class="nav-number">225.1.</span> <span class="nav-text">Android启动参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IOS%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0"><span class="nav-number">225.2.</span> <span class="nav-text">IOS启动参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E7%9A%84VS%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="nav-number">226.</span> <span class="nav-text">UE编译环境的VS安装配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%AB%E6%8F%8F%E8%B5%84%E6%BA%90%E5%BC%95%E7%94%A8%E6%97%B6%E9%9C%80%E6%B3%A8%E6%84%8FRedirector"><span class="nav-number">227.</span> <span class="nav-text">扫描资源引用时需注意Redirector</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cook%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81"><span class="nav-number">228.</span> <span class="nav-text">Cook执行代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#No-world-was-found-for-object"><span class="nav-number">229.</span> <span class="nav-text">No world was found for object</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E5%8A%A8%E8%AE%BE%E5%A4%87%E7%9A%84%E6%B8%B2%E6%9F%93%E9%A2%84%E8%A7%88"><span class="nav-number">230.</span> <span class="nav-text">移动设备的渲染预览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-SDK%E7%89%88%E6%9C%AC%E4%B8%8EAndroid%E7%9A%84%E7%89%88%E6%9C%AC"><span class="nav-number">231.</span> <span class="nav-text">Android SDK版本与Android的版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E9%A1%B9%E7%9B%AE%E8%AE%BE%E7%BD%AE"><span class="nav-number">232.</span> <span class="nav-text">Android项目设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E4%B8%AD%E7%94%A8SetupAttachmen%E6%9B%BF%E4%BB%A3AttachToComponent"><span class="nav-number">233.</span> <span class="nav-text">在构造函数中用SetupAttachmen替代AttachToComponent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E5%85%B6%E4%BB%96%E7%9A%84%E7%BA%BF%E7%A8%8B%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F%E5%B9%B6%E8%8E%B7%E5%8F%96%E7%A8%8B%E5%BA%8F%E8%BE%93%E5%87%BA"><span class="nav-number">234.</span> <span class="nav-text">在其他的线程运行程序并获取程序输出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%91%E5%AE%9AFTicker"><span class="nav-number">235.</span> <span class="nav-text">绑定FTicker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%B0%E5%9B%BE%E5%8A%A0%E8%BD%BD%E7%9A%84Delegate"><span class="nav-number">236.</span> <span class="nav-text">地图加载的Delegate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StaticLoadClass"><span class="nav-number">237.</span> <span class="nav-text">StaticLoadClass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ConstructorHelpers-FClassFinder"><span class="nav-number">238.</span> <span class="nav-text">ConstructorHelpers::FClassFinder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CMD%E7%9A%84sudo"><span class="nav-number">239.</span> <span class="nav-text">CMD的sudo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E6%B8%B8%E6%88%8F%E9%A1%B9%E7%9B%AE%E4%B8%AD%E6%B7%BB%E5%8A%A0%E7%BC%96%E8%BE%91%E5%99%A8%E6%A8%A1%E5%9D%97"><span class="nav-number">240.</span> <span class="nav-text">在游戏项目中添加编辑器模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#does-not-match-the-necessary-signature"><span class="nav-number">241.</span> <span class="nav-text">does not match the necessary signature</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%88%90%E5%91%98%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%BA%E5%BA%8F%E5%BF%85%E9%A1%BB%E8%A6%81%E4%B8%8E%E5%A3%B0%E6%98%8E%E9%A1%BA%E5%BA%8F%E4%B8%80%E8%87%B4"><span class="nav-number">242.</span> <span class="nav-text">数据成员初始化顺序必须要与声明顺序一致</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Delegate"><span class="nav-number">243.</span> <span class="nav-text">Delegate</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Delegate-1"><span class="nav-number">243.1.</span> <span class="nav-text">Delegate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-Delegate"><span class="nav-number">243.2.</span> <span class="nav-text">Dynamic Delegate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multicast-Delegate"><span class="nav-number">243.3.</span> <span class="nav-text">Multicast Delegate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-Multicast-Delegate"><span class="nav-number">243.4.</span> <span class="nav-text">Dynamic Multicast Delegate</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pak%E6%89%80%E5%8C%85%E5%90%AB%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">244.</span> <span class="nav-text">Pak所包含的文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mount-Pak%E6%97%B6%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="nav-number">245.</span> <span class="nav-text">Mount Pak时的一个问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FScopeSlowTask"><span class="nav-number">246.</span> <span class="nav-text">FScopeSlowTask</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MD5Hash"><span class="nav-number">247.</span> <span class="nav-text">MD5Hash</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%9C%A8Pak%E4%B8%AD%E8%AE%BF%E9%97%AE%E9%9D%9E%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6"><span class="nav-number">248.</span> <span class="nav-text">运行时在Pak中访问非资源文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E7%9A%84%E5%8F%8D%E5%B0%84%E4%BF%A1%E6%81%AF"><span class="nav-number">249.</span> <span class="nav-text">枚举的反射信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E6%96%87%E4%BB%B6%E7%9A%84%E6%8F%90%E7%A4%BA"><span class="nav-number">250.</span> <span class="nav-text">创建存储文件的提示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%B7%A5%E7%A8%8B%E6%89%80%E6%9C%89%E7%9A%84Map"><span class="nav-number">251.</span> <span class="nav-text">获取工程所有的Map</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AssetRegistry%E7%9A%84Asset%E6%A6%82%E5%BF%B5"><span class="nav-number">252.</span> <span class="nav-text">AssetRegistry的Asset概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E6%94%AF%E6%8C%81%E7%9A%84%E5%B9%B3%E5%8F%B0"><span class="nav-number">253.</span> <span class="nav-text">获取所有支持的平台</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%92%E5%BD%92%E6%89%AB%E6%8F%8F%E7%9B%AE%E5%BD%95"><span class="nav-number">254.</span> <span class="nav-text">递归扫描目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">255.</span> <span class="nav-text">获取系统环境变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E8%8E%B7%E5%8F%96git-diff%E7%9A%84%E5%86%85%E5%AE%B9"><span class="nav-number">256.</span> <span class="nav-text">运行时获取git diff的内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96Asset%E7%9A%84%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB"><span class="nav-number">257.</span> <span class="nav-text">获取Asset的依赖关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E5%B1%8F%E5%B9%95%E6%96%B9%E5%90%91"><span class="nav-number">258.</span> <span class="nav-text">Android屏幕方向</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SoftClassReference"><span class="nav-number">259.</span> <span class="nav-text">SoftClassReference</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Http%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="nav-number">260.</span> <span class="nav-text">Http下载文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mount-pak-in-Runtime"><span class="nav-number">261.</span> <span class="nav-text">Mount pak in Runtime</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Patch%E7%9A%84%E6%8C%82%E8%BD%BD%E5%92%8C%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD"><span class="nav-number">262.</span> <span class="nav-text">Patch的挂载和资源加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%97%B6Pak%E7%9A%84%E5%8A%A0%E8%BD%BD"><span class="nav-number">263.</span> <span class="nav-text">引擎启动时Pak的加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%93%9D%E5%9B%BE%E8%8A%82%E7%82%B9"><span class="nav-number">264.</span> <span class="nav-text">自定义蓝图节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Plugin%E5%8A%A0%E8%BD%BD%E6%97%B6%E6%9C%BA%E5%A4%AA%E6%99%9A%E5%9C%A8%E8%93%9D%E5%9B%BE%E4%B8%AD%E7%9A%84%E9%94%99%E8%AF%AF"><span class="nav-number">265.</span> <span class="nav-text">Plugin加载时机太晚在蓝图中的错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NavigationSystem%E8%8E%B7%E5%8F%96NavData"><span class="nav-number">266.</span> <span class="nav-text">NavigationSystem获取NavData</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91RecastNavigation"><span class="nav-number">267.</span> <span class="nav-text">编译RecastNavigation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4-Plugin-ExportNav"><span class="nav-number">268.</span> <span class="nav-text">UE4 Plugin:ExportNav</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#What-is-this"><span class="nav-number">268.1.</span> <span class="nav-text">What is this?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-do-use"><span class="nav-number">268.2.</span> <span class="nav-text">How do use?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%A8%A1%E5%9D%97%E9%97%B4%E7%9A%84%E5%90%8D%E5%AD%97%E5%86%B2%E7%AA%81"><span class="nav-number">269.</span> <span class="nav-text">解决模块间的名字冲突</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CreateProc%E9%98%BB%E5%A1%9E%E6%89%A7%E8%A1%8C"><span class="nav-number">270.</span> <span class="nav-text">CreateProc阻塞执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E8%B4%A8%E9%87%8F%E6%B5%8B%E8%AF%95"><span class="nav-number">271.</span> <span class="nav-text">网络质量测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%E9%9B%86%E6%88%90Protobuf"><span class="nav-number">272.</span> <span class="nav-text">UE4集成Protobuf</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#What-is-this-1"><span class="nav-number">272.1.</span> <span class="nav-text">What is this?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-do-use-1"><span class="nav-number">272.2.</span> <span class="nav-text">How do use?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Protobuf-Version"><span class="nav-number">272.3.</span> <span class="nav-text">Protobuf Version</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#protoc%E5%A4%84%E7%90%86%E7%9B%AE%E5%BD%95%E4%B8%AD%E7%9A%84-proto%E6%96%87%E4%BB%B6"><span class="nav-number">273.</span> <span class="nav-text">protoc处理目录中的.proto文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Was-only-expecting-C-files-to-have-CachedCPPEnvironments"><span class="nav-number">274.</span> <span class="nav-text">Was only expecting C++ files to have CachedCPPEnvironments!</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E8%93%9D%E5%9B%BE%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%82%E6%95%B0%E7%A1%AE%E5%AE%9A%E8%BF%94%E5%9B%9E%E7%B1%BB%E5%9E%8B"><span class="nav-number">275.</span> <span class="nav-text">在蓝图中使用参数确定返回类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SetMasterPoseComponent"><span class="nav-number">276.</span> <span class="nav-text">SetMasterPoseComponent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%8C%85Android%E6%8A%A5%E9%94%99-app-assembleDebug"><span class="nav-number">277.</span> <span class="nav-text">打包Android报错:app:assembleDebug</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE4%EF%BC%9A%E5%8F%98%E9%87%8F%E5%B7%B2%E8%A2%AB%E4%BC%98%E5%8C%96%EF%BC%8C%E5%9B%A0%E8%80%8C%E4%B8%8D%E5%8F%AF%E7%94%A8"><span class="nav-number">278.</span> <span class="nav-text">UE4：变量已被优化，因而不可用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E5%85%83%E6%93%8D%E4%BD%9C%E7%AC%A6%E7%9A%84AddPin"><span class="nav-number">279.</span> <span class="nav-text">二元操作符的AddPin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%BE%E5%83%8F%E8%B4%A8%E9%87%8F%E7%BA%A7%E5%88%AB"><span class="nav-number">280.</span> <span class="nav-text">图像质量级别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%89%A9%E7%90%86%E8%B5%84%E4%BA%A7%E4%BC%98%E5%8C%96%E5%8A%A8%E6%80%81%E9%98%B4%E5%BD%B1%E6%B6%88%E8%80%97"><span class="nav-number">281.</span> <span class="nav-text">使用物理资产优化动态阴影消耗</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GameUserSettings"><span class="nav-number">282.</span> <span class="nav-text">GameUserSettings</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TAutoConsoleVariable"><span class="nav-number">283.</span> <span class="nav-text">TAutoConsoleVariable</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cmake-could-not-find-any-instance-of-Visual-Studio"><span class="nav-number">284.</span> <span class="nav-text">cmake:could not find any instance of Visual Studio.</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E7%9B%AE%E6%A0%87%E7%9A%84RuntimeLibrary%E7%B1%BB%E5%9E%8B"><span class="nav-number">285.</span> <span class="nav-text">编译目标的RuntimeLibrary类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5%E4%B8%80"><span class="nav-number">285.1.</span> <span class="nav-text">情况一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5%E4%BA%8C"><span class="nav-number">285.2.</span> <span class="nav-text">情况二</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5%E4%B8%89"><span class="nav-number">285.3.</span> <span class="nav-text">情况三</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-Cook"><span class="nav-number">286.</span> <span class="nav-text">What is Cook?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%AE%8F%E5%AE%9A%E4%B9%89"><span class="nav-number">287.</span> <span class="nav-text">添加宏定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91DLL%E6%97%B6%E6%8A%A5%E9%94%99LNK1561-entry-point-must-be-defined"><span class="nav-number">288.</span> <span class="nav-text">编译DLL时报错LNK1561: entry point must be defined</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cpp%E4%B8%AD%E5%8C%85%E5%90%AB%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-h%E5%BF%85%E9%A1%BB%E6%98%AF%E8%87%AA%E8%BA%AB%E7%B1%BB%E7%9A%84"><span class="nav-number">289.</span> <span class="nav-text">cpp中包含的第一个.h必须是自身类的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E6%B8%B8%E6%88%8F%E6%89%93%E5%8C%85%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%90%8D%E5%92%8CIcon"><span class="nav-number">290.</span> <span class="nav-text">修改游戏打包的进程名和Icon</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SetActorHiddenInGame%E4%B8%8ESetVisibility%E7%9A%84%E5%90%8C%E6%AD%A5"><span class="nav-number">291.</span> <span class="nav-text">SetActorHiddenInGame与SetVisibility的同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AActor-SetActorHiddenInGame"><span class="nav-number">291.1.</span> <span class="nav-text">AActor::SetActorHiddenInGame</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#USceneComponent-SetVisibility"><span class="nav-number">291.2.</span> <span class="nav-text">USceneComponent::SetVisibility</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#USceneComponent-SetHiddenInGame"><span class="nav-number">291.3.</span> <span class="nav-text">USceneComponent::SetHiddenInGame</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%8C%E4%B8%BA%E6%A0%91Task%E7%9A%84ReceiveTickAI%E4%B8%8EReceiveTick%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">292.</span> <span class="nav-text">行为树Task的ReceiveTickAI与ReceiveTick的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Actor%E7%9A%84Connection"><span class="nav-number">293.</span> <span class="nav-text">Actor的Connection</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uasset-format"><span class="nav-number">294.</span> <span class="nav-text">uasset format</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FPackageFileSummary"><span class="nav-number">294.1.</span> <span class="nav-text">FPackageFileSummary</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DECLARE-CLASS%E4%B8%8ESuper"><span class="nav-number">295.</span> <span class="nav-text">DECLARE_CLASS与Super</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GenerateProjectFiles-bat%E8%BF%90%E8%A1%8C%E9%94%99%E8%AF%AF2"><span class="nav-number">296.</span> <span class="nav-text">GenerateProjectFiles.bat运行错误2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GenerateProjectFiles-bat%E8%BF%90%E8%A1%8C%E9%94%99%E8%AF%AF1"><span class="nav-number">297.</span> <span class="nav-text">GenerateProjectFiles.bat运行错误1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UE%E6%B7%BB%E5%8A%A0Profiling%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF%EF%BC%9A%E4%BB%A3%E7%A0%81%E5%9D%97%E7%9A%84CPU%E8%AE%A1%E6%95%B0%E5%91%A8%E6%9C%9F"><span class="nav-number">298.</span> <span class="nav-text">UE添加Profiling统计信息：代码块的CPU计数周期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ON-SCOPE-EXIT"><span class="nav-number">299.</span> <span class="nav-text">ON_SCOPE_EXIT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spawn%E7%89%B9%E6%95%88%E8%A2%AB%E9%81%AE%E6%8C%A1%E6%97%B6%E5%9C%A8%E6%91%84%E5%83%8F%E6%9C%BA%E4%B8%AD%E4%B8%8D%E6%98%BE%E7%A4%BA"><span class="nav-number">300.</span> <span class="nav-text">Spawn特效被遮挡时在摄像机中不显示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MODULE-NAME-API"><span class="nav-number">301.</span> <span class="nav-text">MODULE_NAME_API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E7%9A%84%E5%AE%8F%E5%AE%9A%E4%B9%89"><span class="nav-number">302.</span> <span class="nav-text">模块的宏定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows%E4%B8%8EMacOS%E5%8F%8C%E7%B3%BB%E7%BB%9F%E6%97%B6%E9%97%B4%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">303.</span> <span class="nav-text">Windows与MacOS双系统时间不一致的解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Listen-Server%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84SkipOwner"><span class="nav-number">304.</span> <span class="nav-text">Listen Server模式下的SkipOwner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpawnSoundAtLocation%E5%A4%B1%E8%B4%A5%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">305.</span> <span class="nav-text">SpawnSoundAtLocation失败的情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E6%84%8FRPC%E7%9A%84%E8%B0%83%E7%94%A8%E4%B8%8D%E6%98%AF%E4%B8%A5%E6%A0%BC%E9%A1%BA%E5%BA%8F%E7%9A%84"><span class="nav-number">306.</span> <span class="nav-text">注意RPC的调用不是严格顺序的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E8%B7%A8%E5%A4%A7%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7"><span class="nav-number">307.</span> <span class="nav-text">项目跨大版本升级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC-Config-of-BaseEngine-ini"><span class="nav-number">308.</span> <span class="nav-text">GC Config of BaseEngine.ini</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="查利鹏"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">查利鹏</p>
  <div class="site-description" itemprop="description">每一篇文章都是一个成长的过程。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">141</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">130</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:visionsmile@gmail.com" title="E-Mail → mailto:visionsmile@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://docs.imzlp.com/" title="https:&#x2F;&#x2F;docs.imzlp.com&#x2F;" rel="noopener" target="_blank">TechDocuments</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://linux.imzlp.com/" title="https:&#x2F;&#x2F;linux.imzlp.com&#x2F;" rel="noopener" target="_blank">LinuxCommands</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://books.imzlp.com/" title="https:&#x2F;&#x2F;books.imzlp.com&#x2F;" rel="noopener" target="_blank">IT Books Search</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://soft.imzlp.com/" title="https:&#x2F;&#x2F;soft.imzlp.com&#x2F;" rel="noopener" target="_blank">Software Search</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue4coderules.imzlp.com/" title="https:&#x2F;&#x2F;ue4coderules.imzlp.com&#x2F;" rel="noopener" target="_blank">UE4 Code Rules</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE4 Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue4wiki.imzlp.com/" title="https:&#x2F;&#x2F;ue4wiki.imzlp.com&#x2F;" rel="noopener" target="_blank">UE4 Wiki</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5lab.com/#/" title="https:&#x2F;&#x2F;ue5lab.com&#x2F;#&#x2F;" rel="noopener" target="_blank">UE5 Lab</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021027036号 </a>
  </div>

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">查利鹏</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">543k</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://imzlp.com/notes/ue/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "留下点什么吧~",
      avatar     : 'retro',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
